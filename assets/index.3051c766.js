var ff=Object.defineProperty,pf=Object.defineProperties;var mf=Object.getOwnPropertyDescriptors;var gl=Object.getOwnPropertySymbols;var gf=Object.prototype.hasOwnProperty,_f=Object.prototype.propertyIsEnumerable;var Ir=(i,e,t)=>e in i?ff(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,bt=(i,e)=>{for(var t in e||(e={}))gf.call(e,t)&&Ir(i,t,e[t]);if(gl)for(var t of gl(e))_f.call(e,t)&&Ir(i,t,e[t]);return i},jr=(i,e)=>pf(i,mf(e));var r=(i,e,t)=>(Ir(i,typeof e!="symbol"?e+"":e,t),t);import{Q as P,V as y,E as Oe,v as bf,O as S,a as z,b as I,S as yf,M as Ce,I as wf,R as Fr,L as Ws,c as vf,B as ii,W as xf,d as Pf,e as he,f as It,g as Of,h as Cf,i as _l,C as Sf,P as Br,l as Rf,j as Ef,k as bl,m as f,n as yl,o as Af,s as si,p as Ur,A as Nr,q as wl,r as Ni,t as kf,u as Lf,w as zr,x as Tf,y as vl,D as Df,K as Mf,z as If,G as $r,F as xl,H as jf,J as Ff,N as Bf,T as Wr,U as Hs,X as Pl,Y as Uf,Z as Nf,_ as Gs,$ as Ol,a0 as Cl,a1 as zi,a2 as ni,a3 as zf,a4 as $f,a5 as Sl,a6 as Wf,a7 as Hf,a8 as Gf,a9 as Vf,aa as Rl,ab as qf,ac as El,ad as $i,ae as Xf,af as Qf,ag as Yf,ah as Jf,ai as Zf,aj as Kf,ak as ep,al as tp,am as Al,an as ip,ao as sp,ap as np,aq as rp,ar as Hr,as as op,at as kl,au as ap,av as lp,aw as Ll,ax as cp,ay as hp,az as dp,aA as up,aB as fp,aC as Gr,aD as Tl,aE as Dl,aF as Ml,aG as pp,aH as mp,aI as Il,aJ as gp,aK as _p,aL as bp,aM as yp,aN as wp,aO as Wi,aP as vp,aQ as xp,aR as Pp,aS as Op,aT as Cp,aU as Sp,aV as Rp}from"./vendor.79264100.js";const Ep=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}};Ep();const Hi="__isActiveInHierarchy",ri="builtin_components";function jt(i,e){try{e?i(e):i()}catch(t){return console.error(t),!1}return!0}var Ap=Object.defineProperty,$=(i,e)=>Ap(i,"name",{value:e,configurable:!0});const Vr=$(()=>i=>i,"nameofFactory");function kp(i){return Vr()(i)}$(kp,"nameof");function Lp(){return!!v("debug")}$(Lp,"isDebugMode");let qr=!1;const Xr=[];setTimeout(()=>{qr&&console.log(Xr)},100);function Gi(){return new URLSearchParams(window.location.search)}$(Gi,"getUrlParams");function v(i){qr&&!Xr.includes(i)&&Xr.push(i);const e=Gi();if(e.has(i)){const t=e.get(i);return t||!0}return!1}$(v,"getParam");qr=v("help")===!0;function Tp(i,e){const t=Gi();t.has(i)?t.set(i,e):t.append(i,e),document.location.search=t.toString()}$(Tp,"setParam");function Dp(i,e,t=!0){const s=Gi();s.has(i)?s.set(i,e):s.append(i,e),t?jl(i,s):Qr(i,s)}$(Dp,"setParamWithoutReload");function Vi(i,e,t){i.has(e)?i.set(e,t.toString()):i.append(e,t.toString())}$(Vi,"setOrAddParamsToUrl");function jl(i,e){window.history.pushState(null,i,"?"+e.toString())}$(jl,"pushState");function Qr(i,e){window.history.replaceState(null,i,"?"+e.toString())}$(Qr,"setState");function Mp(i){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=t.length,n=0;n<i;n++)e+=t.charAt(Math.floor(Math.random()*s));return e}$(Mp,"makeId");function Fl(i,e){return Math.floor(Math.random()*(e-i+1))+i}$(Fl,"randomNumber");const Bl=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],Ul=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function Nl(){const i=Bl[Math.floor(Math.random()*Bl.length)],e=Ul[Math.floor(Math.random()*Ul.length)];return i+"_"+e}$(Nl,"makeIdFromRandomWords");function zl(i){return i=i.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,""),i.trim()}$(zl,"sanitizeString");function Ft(i,e,t=!0,s=!1){var n;if(e==null)return null;if(e.userData&&e.userData.guid===i)return e;if(e.guid==i)return e;if(s&&((n=e.userData)==null?void 0:n.components)){for(const o of e.userData.components)if(o.guid===i)return o}if(t){if(e.scenes)for(const o in e.scenes){const a=e.scenes[o],l=Ft(i,a,t,s);if(l)return l}if(e.children)for(const o in e.children){const a=e.children[o],l=Ft(i,a,t,s);if(l)return l}}}$(Ft,"tryFindObject");function Vs(i,e){if(i!=null&&typeof i=="object"){let t;Array.isArray(i)?t=[]:(t=Object.create(i),Object.assign(t,i));for(const s of Object.keys(i)){const n=i[s];e&&!e(i,s,n)?t[s]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?t[s]=n.clone():t[s]=Vs(n,e)}return t}return i}$(Vs,"deepClone");function $l(i){return new Promise((e,t)=>{setTimeout(e,i)})}$($l,"delay");function Wl(i,e){if(e&&i&&!e.includes("/")){const t=i.lastIndexOf("/");if(t>=0)return i.substring(0,t+1)+e}return e}$(Wl,"getPath");var Ip=Object.defineProperty,Ie=(i,e)=>Ip(i,"name",{value:e,configurable:!0});const jp=v("debugnewscripts"),T=[];function oi(i){if(!(i.new_scripts.length<=0)){if(jp&&console.log("Register new components",i.new_scripts.length,i.alias?"element: "+i.alias:""),i.new_scripts_pre_setup_callbacks.length>0){for(const e of i.new_scripts_pre_setup_callbacks)!e||e();i.new_scripts_pre_setup_callbacks.length=0}T.length=0,i.new_scripts.length>0&&T.push(...i.new_scripts),i.new_scripts.length=0;for(let e=0;e<T.length;e++)try{const t=T[e];if(t.destroyed)continue;if(!t.gameObject){console.error("MISSING GAMEOBJECT - will ignore",t),T.splice(e,1),e--;continue}t.context=i,ai(t.gameObject),Yr(t,i)}catch(t){console.error(t),Ye(T[e],i),T.splice(e,1),e--}for(let e=0;e<T.length;e++)try{const t=T[e];if(t.destroyed){Ye(T[e],i),T.splice(e,1),e--;continue}t.__internalAwake!==void 0&&(t.gameObject||console.error("MISSING GAMEOBJECT",t,t.gameObject),ai(t.gameObject),t.activeAndEnabled&&jt(t.__internalAwake.bind(t)))}catch(t){console.error(t),Ye(T[e],i),T.splice(e,1),e--}for(let e=0;e<T.length;e++)try{const t=T[e];if(t.destroyed||t.enabled===!1||(ai(t.gameObject),t.activeAndEnabled===!1))continue;t.__internalEnable!==void 0&&(t.enabled=!0,jt(t.__internalEnable.bind(t)))}catch(t){console.error(t),Ye(T[e],i),T.splice(e,1),e--}for(let e=0;e<T.length;e++)try{const t=T[e];if(t.destroyed||!t.gameObject)continue;i.new_script_start.push(t)}catch(t){console.error(t),Ye(T[e],i),T.splice(e,1),e--}T.length=0;for(const e of i.new_scripts_post_setup_callbacks)e&&e();i.new_scripts_post_setup_callbacks.length=0}}Ie(oi,"processNewScripts");function Hl(i){!i||(i.__internalDisable(),Ye(i,i.context))}Ie(Hl,"processRemoveFromScene");function Gl(i){for(let e=0;e<i.new_script_start.length;e++)try{const t=i.new_script_start[e];if(t.destroyed||t.activeAndEnabled===!1)continue;jt(t.__internalAwake.bind(t)),jt(t.__internalEnable.bind(t)),jt(t.__internalStart.bind(t)),i.new_script_start.splice(e,1),e--}catch(t){console.error(t),Ye(i.new_script_start[e],i),i.new_script_start.splice(e,1),e--}}Ie(Gl,"processStart");function Yr(i,e){e.scripts.indexOf(i)===-1&&(e.scripts.push(i),i.earlyUpdate&&e.scripts_earlyUpdate.push(i),i.update&&e.scripts_update.push(i),i.lateUpdate&&e.scripts_lateUpdate.push(i),i.onBeforeRender&&e.scripts_onBeforeRender.push(i),i.onAfterRender&&e.scripts_onAfterRender.push(i))}Ie(Yr,"addScriptToArrays");function Ye(i,e){Je(i,e.new_scripts),Je(i,e.new_script_start),Je(i,e.scripts),Je(i,e.scripts_earlyUpdate),Je(i,e.scripts_update),Je(i,e.scripts_lateUpdate),Je(i,e.scripts_onBeforeRender),Je(i,e.scripts_onAfterRender),e.stopAllCoroutinesFrom(i)}Ie(Ye,"removeScriptFromContext");function Je(i,e){const t=e.indexOf(i);t>=0&&e.splice(t,1)}Ie(Je,"removeFromArray");const Fp={},Vl={};function ql(){if(!A.Current){console.trace("Invalid call - no current context.");return}Jr(A.Current.scene,A.Current.scene.visible,!0)}Ie(ql,"updateIsActive");function Jr(i,e,t){const s=p.isActiveSelf(i);Fp[i.uuid]=s,e&&(e=p.isActiveSelf(i)),i[Hi]=e;{const n=Vl[i.uuid];n!==void 0&&n!==e&&t&&Xl(i,o=>{e?(jt(o.__internalAwake.bind(o)),o.onEnable()):o.onDisable()})}if(Vl[i.uuid]=e,i.children)for(const n of i.children)Jr(n,e,t)}Ie(Jr,"updateIsActiveInHierarchyRecursiveRuntime");function ai(i){let e=!0,t=i,s=!1;for(;t&&t;){if(t.type==="Scene"&&(s=!0),!p.isActiveSelf(t)){e=!1;break}t=t.parent}if(!i){console.error("GO is null");return}i[Hi]=e&&s}Ie(ai,"updateActiveInHierarchyWithoutEventCall");function Xl(i,e){var t;if((t=i.userData)==null?void 0:t.components)for(const s of i.userData.components)e(s)}Ie(Xl,"perComponent");function Ql(i,e){var s;if(!i)return;const t=(s=e==null?void 0:e.new_scripts)!=null?s:A.Current.new_scripts;t.includes(i)||t.push(i)}const Bp=function(i,e){if(!i||!i.userData.components)return;const t=i.userData.components.indexOf(e);t<0||(e.gameObject=null,i.userData.components.splice(t,1))},Yl=function(i,e,t=!0){e.userData||(e.userData={}),e.userData.components||(e.userData.components=[]),e.userData.components.push(i),i.gameObject=e,Ql(i);try{i.__internalAwake&&t&&(ai(e),i.__internalAwake())}catch(s){console.error(s)}},Up=function(i,e){if(i.gameObject!==e){if(i.gameObject&&i.gameObject.userData.components){const t=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(t,1)}e.userData.components.includes(i)||(e.userData.components.push(i),i.gameObject=e)}},Np=function(i){var e;if(i.gameObject&&i.gameObject.userData.components){const t=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(t,1)}i.__internalDisable&&i.__internalDisable(),i.onDestroy&&i.onDestroy(),Ye(i,(e=i.context)!=null?e:A.Current),i.__destroyed=!0,i.gameObject=null},Jl=function(i,e,t){var s;if(!((s=e==null?void 0:e.userData)==null?void 0:s.components))return null;for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];if(i===null||o.constructor.name===i.name||o.constructor.name===i)if(t)t.push(o);else return o}for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];let a=Object.getPrototypeOf(o.constructor);do{if(a===i)if(t)t.push(o);else return o;a=Object.getPrototypeOf(a)}while(a)}return t},Zr=function(i,e){return Jl(i,e,null)},Kr=function(i,e,t){return t||(t=[]),Jl(i,e,t)},eo=function(i,e,t){var n;const s=Zr(i,e);if(t===!1&&s.enabled===!1)return null;if(s)return s;for(let o=0;o<((n=e==null?void 0:e.children)==null?void 0:n.length);o++){const a=eo(i,e.children[o]);if(a)return a}return null},to=function(i,e,t){var s;t||(t=[]),Kr(i,e,t);for(let n=0;n<((s=e==null?void 0:e.children)==null?void 0:s.length);n++)to(i,e.children[n],t);return t},Zl=function(i,e){if(!e)return null;const t=Zr(i,e);return t||Zl(i,e.parent)},Kl=function(i,e,t){return t||(t=[]),e?(Kr(i,e,t),Kl(i,e.parent,t)):t},zp=function(i,e,t){if(!i)return null;if(!e&&(e=A.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),null;const s=e.isScene===!0||e.isObject3D===!0?e:e==null?void 0:e.scene;for(const n in s.children){const o=s.children[n];if(t===!1&&o[Hi]===!1)continue;if(o.constructor==i)return o;const a=eo(i,o);if(a)return a}return null},$p=function(i,e,t){if(!i)return e;if(!t&&(t=A.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),e;const s=t.isScene===!0||t.isObject3D===!0?t:t==null?void 0:t.scene;if(!s)return e;for(const n in s.children){const o=s.children[n];if(o.constructor==i)return o;to(i,o,e)}return e};var Wp=Object.defineProperty,Hp=(i,e)=>Wp(i,"name",{value:e,configurable:!0});class ec{random(){return Math.random()}clamp(e,t,s){return e<t?t:e>s?s:e}clamp01(e){return this.clamp(e,0,1)}lerp(e,t,s){return s=s<0?0:s,s=s>1?1:s,e+(t-e)*s}moveTowards(e,t,s){return e+=s,(s<0&&e<t||s>0&&e>t)&&(e=t),e}toDegrees(e){return e*180/Math.PI}toRadians(e){return e*Math.PI/180}}Hp(ec,"MathHelper");const k=new ec;var Gp=Object.defineProperty,W=(i,e)=>Gp(i,"name",{value:e,configurable:!0});class tc{constructor(e,t){r(this,"_factory");r(this,"_cache",[]);r(this,"_maxSize");r(this,"_index",0);this._factory=e,this._maxSize=t}get(){let e=this._index++;return e>=this._cache.length&&(e>=this._maxSize?e=this._index=0:this._cache.push(this._factory())),this._cache[e]}}W(tc,"CircularBuffer");const Vp=new P().setFromAxisAngle(new y(0,1,0),Math.PI);function qp(i,e){i.lookAt(e),i.quaternion.multiply(Vp)}W(qp,"lookAtInverse");const io=new tc(()=>new y,30);function C(i,e=null,t=!0){const s=io.get();return i?i.parent?(t&&i.updateWorldMatrix(!0,!1),i.matrixWorldNeedsUpdate&&i.updateMatrixWorld(),s.setFromMatrixPosition(i.matrixWorld),e&&e.copy(s),e!=null?e:s):s.copy(i.position):s.set(0,0,0)}W(C,"getWorldPosition");function D(i,e){var n;if(!i)return;const t=io.get();e!==t&&t.copy(e),((n=i==null?void 0:i.parent)!=null?n:i).worldToLocal(t),i.position.set(t.x,t.y,t.z)}W(D,"setWorldPosition");function qs(i,e,t,s){const n=io.get();n.set(e,t,s),D(i,n)}W(qs,"setWorldPositionXYZ");const Bt=new P,qi=new P,so=new P;function K(i,e=null){if(!i)return qi.set(0,0,0,1);const t=e!=null?e:qi;return i.parent?(i.getWorldQuaternion(t),t):t.copy(i.quaternion)}W(K,"getWorldQuaternion");function ee(i,e){if(!i)return;e!==Bt&&Bt.copy(e);const t=Bt,s=i==null?void 0:i.parent;s==null||s.getWorldQuaternion(so),so.invert();const n=so.multiply(t);i.quaternion.set(n.x,n.y,n.z,n.w)}W(ee,"setWorldQuaternion");function ic(i,e,t,s,n){Bt.set(e,t,s,n),ee(i,Bt)}W(ic,"setWorldQuaternionXYZW");const Xs=new y,Xp=new y;function sc(i,e=null){return i?i.parent?(i.getWorldScale(e!=null?e:Xs),e!=null?e:Xs):Xs.copy(i.position):Xs.set(0,0,0)}W(sc,"getWorldScale");function Qp(i,e){if(!i)return;if(!i.parent){i.scale.copy(e);return}const t=Xp;i.parent.getWorldScale(t),t.divide(e),i.scale.copy(t)}W(Qp,"setWorldScale");const Yp=new y,nc=new P;function Jp(i){return K(i,nc),Yp.set(0,0,1).applyQuaternion(nc)}W(Jp,"forward");const rc=new Oe,oc=new Oe,Zp=new y;function ac(i){return i.getWorldQuaternion(qi),oc.setFromQuaternion(qi),oc}W(ac,"getWorldEuler");function lc(i,e){ee(i,qi.setFromEuler(e))}W(lc,"setWorldEuler");function no(i){const e=ac(i),t=Zp;return t.set(e.x,e.y,e.z),t.x=k.toDegrees(t.x),t.y=k.toDegrees(t.y),t.z=k.toDegrees(t.z),t}W(no,"getWorldRotation");function Kp(i,e){Qs(i,e.x,e.y,e.z,!0)}W(Kp,"setWorldRotation");function Qs(i,e,t,s,n=!0){n&&(e=k.toRadians(e),t=k.toRadians(t),s=k.toRadians(s)),rc.set(e,t,s),Bt.setFromEuler(rc),ee(i,Bt)}W(Qs,"setWorldRotationXYZ");function Ys(i,e=!0){!i||(e?W(function t(s){console.groupCollapsed((s.name?s.name:"(no name : "+s.type+")")+" %o",s),s.children.forEach(t),console.groupEnd()},"printGraph")(i):i.traverse(function(t){for(var s="|___",n=t;n.parent!==null;)s="	"+s,n=n.parent;console.log(s+t.name+" <"+t.type+">")}))}W(Ys,"logHierarchy");var em=Object.defineProperty,ne=(i,e)=>em(i,"name",{value:e,configurable:!0});const Js=v("debugcomponents"),tm="eff8ba80-635d-11ec-90d6-0242ac120003";class ye{constructor(e){r(this,"_originalSeed");r(this,"_seed");this._originalSeed=e,this._seed=e}get seed(){return this._seed}generateUUID(){const e=this._seed;return this._seed-=1,bf(e.toString(),tm)}static createFromString(e){return new ye(this.hash(e))}static hash(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}ne(ye,"InstantiateIdProvider");var Ut;(function(i){i.NewInstanceCreated="new-instance-created",i.InstanceDestroyed="instance-destroyed"})(Ut||(Ut={}));class ro{constructor(e){r(this,"guid");this.guid=e}}ne(ro,"DestroyInstanceModel");function Zs(i,e,t=!0){if(!i)return;const s=i;if(p.destroy(i,t),!e){console.warn("Can not send destroy: No networking connection provided",i.guid);return}if(!e.isConnected){console.warn("Can not send destroy: not connected",i.guid);return}let n=i.guid;if(!n&&s.uuid&&(n=s.uuid),!n){console.warn("Can not send destroy: failed to find guid",i);return}const o=new ro(n);e.send(Ut.InstanceDestroyed,o)}ne(Zs,"syncDestroy");function cc(i,e){const t=new ro(i);e.send(Ut.InstanceDestroyed,t)}ne(cc,"sendDestroyed");function hc(i){i.connection.beginListen(Ut.InstanceDestroyed,e=>{Js&&console.log("[Remote] Destroyed",i.scene,e);const t=p.findByGuid(e.guid,i.scene);t&&p.destroy(t)})}ne(hc,"beginListenDestroy");class im{constructor(e,t,s){r(this,"filename");r(this,"hash");r(this,"size");this.filename=e,this.hash=t,this.size=s}}ne(im,"HostData");class dc{constructor(e,t){r(this,"guid");r(this,"originalGuid");r(this,"seed");r(this,"visible");r(this,"hostData");r(this,"dontSave");r(this,"parent");r(this,"position");r(this,"rotation");r(this,"scale");this.originalGuid=e,this.guid=t}}ne(dc,"NewInstanceModel");function oo(i,e,t,s){var c;const n=i;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(e.context||(e.context=A.Current),!e.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=e?bt({},e):null,{instance:a,seed:l}=fc(n,e);if(a){const h=a;if(h.guid){Js&&console.log("[Local] new instance","gameobject:",a==null?void 0:a.guid);const d=new dc(n.guid,h.guid);d.seed=l,o&&(o.position&&(d.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(d.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(d.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),d.position||(d.position={x:h.position.x,y:h.position.y,z:h.position.z}),d.rotation||(d.rotation={x:h.quaternion.x,y:h.quaternion.y,z:h.quaternion.z,w:h.quaternion.w}),d.scale||(d.scale={x:h.scale.x,y:h.scale.y,z:h.scale.z}),d.visible=n.visible,(o==null?void 0:o.parent)&&(typeof o.parent=="string"?d.parent=o.parent:d.parent=o.parent.guid),d.hostData=t,s===!1&&(d.dontSave=!0),(c=e==null?void 0:e.context)==null||c.connection.send(Ut.NewInstanceCreated,d)}else console.warn("Missing guid, can not send new instance event",h)}return a}ne(oo,"syncInstantiate");function Ks(){return Math.random()*9999999}ne(Ks,"generateSeed");function uc(i){i.connection.beginListen(Ut.NewInstanceCreated,async e=>{const t=await gc(e.originalGuid,i.scene);if(!t){console.warn("could not find object that was instantiated: "+e.guid);return}const s=new we;e.position&&(s.position=new y(e.position.x,e.position.y,e.position.z)),e.rotation&&(s.rotation=new P(e.rotation.x,e.rotation.y,e.rotation.z,e.rotation.w)),e.scale&&(s.scale=new y(e.scale.x,e.scale.y,e.scale.z)),s.parent=e.parent,e.seed&&(s.idProvider=new ye(e.seed)),s.visible=e.visible,s.context=i,Js&&i.alias&&console.log("[Remote] instantiate in: "+i.alias);const n=p.instantiate(t,s);n&&(e.parent==="scene"&&i.scene.add(n),Js&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,t))})}ne(uc,"beginListenInstantiate");function fc(i,e){const t=Ks(),s=e!=null?e:new we;s.idProvider=new ye(t);const n=p.instantiate(i,s);return{seed:t,instance:n}}ne(fc,"instantiateSeeded");const pc={};function mc(i,e){pc[i]=e}ne(mc,"registerPrefabProvider");async function gc(i,e){const t=pc[i];if(t!=null){const s=await t(i);if(s)return s}return ao(i,e)}ne(gc,"tryResolvePrefab");function ao(i,e){if(e===null||!i)return null;if(e.guid===i)return e;if(e.children)for(const t of e.children){const s=ao(i,t);if(s)return s}return null}ne(ao,"tryFindObjectByGuid");var sm=Object.defineProperty,en=(i,e)=>sm(i,"name",{value:e,configurable:!0});const yt=v("debugcomponents");var _c;(function(i){i[i.None=0]="None",i[i.HideInHierarchy=1]="HideInHierarchy",i[i.HideInInspector=2]="HideInInspector",i[i.DontSaveInEditor=4]="DontSaveInEditor",i[i.NotEditable=8]="NotEditable",i[i.DontSaveInBuild=16]="DontSaveInBuild",i[i.DontUnloadUnusedAsset=32]="DontUnloadUnusedAsset",i[i.DontSave=52]="DontSave",i[i.HideAndDontSave=61]="HideAndDontSave"})(_c||(_c={}));class we{constructor(){r(this,"idProvider");r(this,"parent");r(this,"keepWorldPosition");r(this,"position");r(this,"rotation");r(this,"scale");r(this,"visible");r(this,"context")}}en(we,"InstantiateOptions");S.prototype.SetActive=function(i){console.log(i,this),this.visible=i};class p extends S{constructor(){super(...arguments);r(this,"guid")}static setActive(e,t){!e||(e.visible=t)}static isActiveSelf(e){return e.visible||p.isUsingInstancing(e)}static isActiveInHierarchy(e){return e[Hi]||p.isUsingInstancing(e)}static markAsInstancedRendered(e,t){e.__isUsingInstancing=t}static isUsingInstancing(e){return e.__isUsingInstancing===!0}static foreachComponent(e,t,s=!0){if(!!e){if(e.userData.components)for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];if(o instanceof w){const a=t(o);if(a!==void 0)return a}}if(s&&e.children)for(let n=0;n<e.children.length;n++){const o=e.children[n];if(!o)continue;const a=p.foreachComponent(o,t,s);if(a!==void 0)return a}}}static instantiateSynced(e,t){return e?oo(e,t):null}static instantiate(e,t=null){if(e===null)return null;let s=null;t!==null&&(t.x!==void 0?(s=new we,s.position=t):s=t);let n=A.Current;(s==null?void 0:s.context)&&(n=s.context),yt&&n.alias&&console.log("context",n.alias),s&&!s.idProvider&&(s.idProvider=new ye(Date.now()));const o=[],a={},l={},c=this.internalInstantiate(n,e,s,o,a,l);c&&(this.resolveReferences(a),this.resolveAndBindSkinnedMeshBones(l,a)),yt&&(Ys(e,!0),Ys(c,!0));const h={};for(const d in o){const u=o[d],_=u.guid;s&&s.idProvider&&(u.guid=s.idProvider.generateUUID(),h[_]=u.guid,yt&&console.log(u.name,u.guid)),Ql(u,n),u.__internalNewInstanceCreated&&u.__internalNewInstanceCreated()}for(const d in o){const u=o[d];u.resolveGuids&&u.resolveGuids(h),u.enabled!==!1&&(u.enabled=!0)}return oi(n),c}static internalInstantiate(e,t,s,n,o,a){var u;if(!t)return null;const l=t.userData;t.userData={};const c=t.children;t.children=[];let h;if(h=t.clone(!1),t.userData=l,t.children=c,o[t.uuid]={original:t,clone:h},t.type==="SkinnedMesh"&&(a[t.uuid]={original:t,clone:h}),(s==null?void 0:s.visible)!==void 0&&(h.visible=s.visible),s==null?void 0:s.idProvider){h.uuid=s.idProvider.generateUUID();const _=h;_&&(_.guid=h.uuid)}t.animations&&t.animations.length>0&&(h.animations=[...t.animations]);const d=t.parent;if(d&&d.add(h),(s==null?void 0:s.position)?D(h,s.position):h.position.copy(t.position),(s==null?void 0:s.rotation)?ee(h,s.rotation):h.quaternion.copy(t.quaternion),(s==null?void 0:s.scale)?h.scale.copy(s.scale):h.scale.copy(t.scale),(s==null?void 0:s.parent)&&s.parent!=="scene"){let _=null;if(typeof s.parent=="string"?_=Ft(s.parent,e.scene,!0):_=s.parent,_){const b=s.keepWorldPosition===!0?_.attach:_.add;b?b.call(_,h):console.error("Invalid parent object",_,"received when instantiating:",t)}else console.warn("could not find parent:",s.parent)}for(const[_,b]of Object.entries(t.userData))_!=="components"&&(h.userData[_]=b);if((u=t.userData)==null?void 0:u.components){const _=t.userData.components,b=[];h.userData.components=b;for(let x=0;x<_.length;x++){const O=_[x],R=Object.create(O);Object.assign(R,O),b.push(R),R.gameObject=h,n.push(R)}}s&&(s.position=void 0,s.rotation=void 0,s.scale=void 0,s.parent=void 0);for(const _ in t.children){const b=t.children[_],x=p.internalInstantiate(e,b,s,n,o,a);x&&h.add(x)}return h}static resolveAndBindSkinnedMeshBones(e,t){for(const s in e){const n=e[s],o=n.original,a=o.skeleton,l=n.clone;if(!a){console.warn("Skinned mesh has no skeleton?",n);continue}const c=a.bones,h=l.skeleton.clone();l.skeleton=h,l.bindMatrix.clone().copy(o.bindMatrix),l.bindMatrixInverse.copy(o.bindMatrixInverse);const d=[];h.bones=d;for(let u=0;u<c.length;u++){const _=c[u],x=t[_.uuid].clone;d.push(x)}}for(const s in e){const n=e[s].clone;n.skeleton.update(),n.bind(n.skeleton,n.bindMatrix),n.updateMatrixWorld(!0)}}static resolveReferences(e){var t;for(const s in e){const o=e[s].clone;if((t=o.userData)==null?void 0:t.components)for(let a=0;a<o.userData.components.length;a++){const l=o.userData.components[a],c=Object.entries(l);for(const[h,d]of c)if(Array.isArray(d)){const u=[];l[h]=u;for(let _=0;_<d.length;_++){const b=d[_];if(typeof b!="object"){u.push(b);continue}const x=this.postProcessNewInstance(l,h,b,e);x!==void 0?u.push(x):u.push(b)}}else if(typeof d=="object"){const u=this.postProcessNewInstance(l,h,d,e);u!==void 0&&(l[h]=u)}}}}static postProcessNewInstance(e,t,s,n){var o,a;if(s instanceof Se||s instanceof w){const l=s.gameObject;if(l){const c=l.uuid,h=(o=n[c])==null?void 0:o.clone;if(!h){yt&&console.log("reference did not change",t,e,s);return}const d=l.userData.components.indexOf(s);if(d>=0)return yt&&console.log(t,c),h.userData.components[d];console.warn("could not find component",t,s)}}else if(s instanceof S){if(t==="gameObject")return;const l=s;if(l){const c=l.uuid,h=(a=n[c])==null?void 0:a.clone;if(h)return yt&&console.log(t,"old",s,"new",h),h}}}static destroySynced(e,t,s=!0){if(!e)return;const n=e;t=t!=null?t:A.Current,Zs(n,t.connection,s)}static destroy(e,t=!0,s=!0){const n=e;if(n.isComponent){n.destroy();return}const o=e;if(yt&&console.log(o),t&&o.children)for(const l of o.children)p.destroy(l,t,!1);const a=o.userData.components;if(a){let l=a.length;for(let c=0;c<a.length;c++){const h=a[c];h.destroy&&(yt&&console.log("destroying",h),h.destroy()),a.length<l&&(l=a.length,c--)}}s&&o.removeFromParent()}static add(e,t,s){if(!(!e||!t)){if(e===t){console.warn("Can not add object to self",e);return}s||(s=A.Current),t.add(e),ai(e),s?p.foreachComponent(e,n=>{Yr(n,s),s.new_script_start.includes(n)===!1&&s.new_script_start.push(n)},!0):console.warn("Missing context")}}static remove(e){var t;!e||((t=e.parent)==null||t.remove(e),p.foreachComponent(e,s=>{Hl(s)},!0))}static invokeOnChildren(e,t,...s){this.invoke(e,t,!0,s)}static invoke(e,t,s=!1,...n){!e||this.foreachComponent(e,o=>{const a=o[t];a&&typeof a=="function"&&a.bind(o)(...n)},s)}static addNewComponent(e,t,s=!0){const n=new t;return Yl(n,e,s),n}static addComponent(e,t){if(t.gameObject==null)throw new Error("Did you mean to create a new component? Use addNewComponent");Up(t,e)}static removeComponent(e){return Bp(e.gameObject,e),e}static getOrAddComponent(e,t){const s=this.getComponent(e,t);return s||this.addNewComponent(e,t)}static getComponent(e,t){return e===null?null:Zr(t,e)}static getComponents(e,t,s=null){return e===null?s!=null?s:[]:Kr(t,e,s)}static findByGuid(e,t){return Ft(e,t,!0,!0)}static findObjectOfType(e,t,s=!0){return zp(e,t,s)}static findObjectsOfType(e,t){const s=[];return $p(e,s,t),s}static getComponentInChildren(e,t){return eo(t,e)}static getComponentsInChildren(e,t,s=null){return to(t,e,s)}static getComponentInParent(e,t){return Zl(t,e)}static getComponentsInParent(e,t,s=null){return Kl(t,e,s)}static getAllComponents(e){var n;return[...(n=e.userData)==null?void 0:n.components]}static*iterateComponents(e){var s;const t=(s=e==null?void 0:e.userData)==null?void 0:s.components;if(t&&Array.isArray(t))for(let n=0;n<t.length;n++)yield t[n]}}en(p,"GameObject");S.prototype.addNewComponent=function(i){return p.addNewComponent(this,i)};S.prototype.removeComponent=function(i){return p.removeComponent(i)};S.prototype.getOrAddComponent=function(i){return p.getOrAddComponent(this,i)};S.prototype.getComponent=function(i){return p.getComponent(this,i)};S.prototype.getComponents=function(i,e){return p.getComponents(this,i,e)};S.prototype.getComponentInChildren=function(i){return p.getComponentInChildren(this,i)};S.prototype.getComponentsInChildren=function(i,e){return p.getComponentsInChildren(this,i,e)};S.prototype.getComponentInParent=function(i){return p.getComponentInParent(this,i)};S.prototype.getComponentInParent=function(i,e){return p.getComponentsInParent(this,i,e)};const Me=class{constructor(){r(this,"__context");r(this,"__name");r(this,"gameObject");r(this,"guid","invalid");r(this,"sourceId");r(this,"__didAwake",!1);r(this,"__didStart",!1);r(this,"__didEnable",!1);r(this,"__isEnabled");r(this,"__destroyed",!1);r(this,"_worldPosition");r(this,"_worldQuaternion");r(this,"_worldEuler");r(this,"_worldRotation");this.__internalNewInstanceCreated()}get isComponent(){return!0}get context(){var e;return(e=this.__context)!=null?e:A.Current}set context(e){this.__context=e}get scene(){return this.context.scene}get layer(){var e;return(e=this.gameObject)==null?void 0:e.userData.layer}get name(){var e;return(e=this.gameObject)==null?void 0:e.userData.name}set name(e){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=e,this.__name=e):this.__name=e}get tag(){var e;return(e=this.gameObject)==null?void 0:e.userData.tag}set tag(e){this.gameObject&&(this.gameObject.userData.tag=e)}get static(){var e;return(e=this.gameObject)==null?void 0:e.userData.static}get hideFlags(){var e;return(e=this.gameObject)==null?void 0:e.userData.hideFlags}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const e=this.gameObject[Hi];return e===void 0?!0:e}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(e,t=Pe.Update){return this.context.registerCoroutineUpdate(this,e,t)}stopCoroutine(e,t=Pe.Update){this.context.unregisterCoroutineUpdate(e,t)}get destroyed(){return this.__destroyed}destroy(){this.destroyed||Np(this)}__internalNewInstanceCreated(){this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(){this.__didEnable||(this.__didEnable=!0,this.onEnable())}__internalDisable(){!this.__didEnable||(this.__didEnable=!1,this.onDisable())}get worldPosition(){return this._worldPosition||(this._worldPosition=new y),C(this.gameObject,this._worldPosition),this._worldPosition}set worldPosition(e){D(this.gameObject,e)}setWorldPosition(e,t,s){Me._worldPositionBuffer.set(e,t,s),this.worldPosition=Me._worldPositionBuffer}get worldQuaternion(){return this._worldQuaternion||(this._worldQuaternion=new P),K(this.gameObject,this._worldQuaternion)}set worldQuaternion(e){ee(this.gameObject,e)}setWorldQuaternion(e,t,s,n){Me._worldQuaternionBuffer.set(e,t,s,n),this.worldQuaternion=Me._worldQuaternionBuffer}get worldEuler(){return this._worldEuler||(this._worldEuler=new Oe),this._worldEuler.setFromQuaternion(this.worldQuaternion),this._worldEuler}set worldEuler(e){var t;this._worldQuaternion||(this._worldQuaternion=new P),(t=this._worldQuaternion)==null||t.setFromEuler(e),this.worldQuaternion=this._worldQuaternion}get worldRotation(){const e=this.worldEuler;this._worldRotation||(this._worldRotation=new y);const t=this._worldRotation;return t.set(e.x,e.y,e.z),t.x=k.toDegrees(t.x),t.y=k.toDegrees(t.y),t.z=k.toDegrees(t.z),t}set worldRotation(e){this.setWorldRotation(e.x,e.y,e.z,!0)}setWorldRotation(e,t,s,n=!0){n&&(e=k.toRadians(e),t=k.toRadians(t),s=k.toRadians(s)),Me._worldEulerBuffer.set(e,t,s),Me._worldQuaternionBuffer.setFromEuler(Me._worldEulerBuffer),this.worldQuaternion=Me._worldQuaternionBuffer}get forward(){return Me._forward.set(0,0,1).applyQuaternion(this.worldQuaternion)}};let Se=Me;r(Se,"_worldPositionBuffer",new y),r(Se,"_worldQuaternionBuffer",new P),r(Se,"_worldEulerBuffer",new Oe),r(Se,"_tempQuaternionBuffer2",new P),r(Se,"_forward",new y(0,0,1));en(Se,"Component");class w extends Se{get enabled(){var e;return(e=this.__isEnabled)!=null?e:!0}set enabled(e){e!==this.__isEnabled&&(this.__isEnabled=e,!!this.__didAwake&&(e?this.__internalEnable():this.__internalDisable()))}}en(w,"Behaviour");var nm=Object.defineProperty,rm=(i,e)=>nm(i,"name",{value:e,configurable:!0}),tn;(function(i){i.PointerDown="pointerDown"})(tn||(tn={}));class bc extends EventTarget{constructor(e){super();r(this,"_doubleClickTimeThreshold",.5);r(this,"_longPressTimeThreshold",1);r(this,"_specialCursorTrigger",0);r(this,"context");r(this,"_pointerDown",[!1]);r(this,"_pointerUp",[!1]);r(this,"_pointerClick",[!1]);r(this,"_pointerDoubleClick",[!1]);r(this,"_pointerPressed",[!1]);r(this,"_pointerPositions",[new z]);r(this,"_pointerPositionsLastFrame",[new z]);r(this,"_pointerPositionsDelta",[new z]);r(this,"_pointerPositionsRC",[new z]);r(this,"_pointerPositionDown",[new z]);r(this,"_pointerDownTime",[]);r(this,"_pointerUpTime",[]);r(this,"_pointerIds",[]);r(this,"_pointerTypes",[""]);r(this,"_mouseWheelChanged",[!1]);r(this,"_pointerEvent",[]);r(this,"keysPressed",{});this.context=e,this.context.post_render_callbacks.push(this.onEndOfFrame.bind(this));const t=this.context.renderer.domElement;t.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!0}),t.addEventListener("touchend",this.onTouchUp.bind(this),!1),t.addEventListener("pointerdown",this.onPointerDown.bind(this),!1),t.addEventListener("pointermove",this.onPointerMove.bind(this),!1),t.addEventListener("pointerup",this.onPointerUp.bind(this),!1),t.addEventListener("wheel",this.onMouseWheel.bind(this),{passive:!0}),window.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("keypress",this.onKeyPressed.bind(this),!1),window.addEventListener("keyup",this.onKeyUp.bind(this),!1),window.addEventListener("blur",this.onLostFocus.bind(this))}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}setCursorPointer(){this._specialCursorTrigger+=1,this.context.domElement.style.cursor="pointer"}setCursorNormal(){this._specialCursorTrigger-=1,this._specialCursorTrigger=Math.max(0,this._specialCursorTrigger),this._specialCursorTrigger===0&&(this.context.domElement.style.cursor="default")}getPointerPressedCount(){let e=0;for(let t=0;t<this._pointerPressed.length;t++)this._pointerPressed[t]&&e++;return e}getPointerPosition(e){return e>=this._pointerPositions.length?null:this._pointerPositions[e]}getPointerPositionLastFrame(e){return e>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[e]}getPointerPositionDelta(e){return e>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[e]}getPointerPositionRC(e){return e>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[e]}getPointerDown(e){return e>=this._pointerDown.length?!1:this._pointerDown[e]}getPointerUp(e){return e>=this._pointerUp.length?!1:this._pointerUp[e]}getPointerPressed(e){return e>=this._pointerPressed.length?!1:this._pointerPressed[e]}getPointerClicked(e){return e>=this._pointerClick.length?!1:this._pointerClick[e]}getPointerDoubleClicked(e){return e>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[e]}getPointerDownTime(e){return e>=this._pointerDownTime.length?-1:this._pointerDownTime[e]}getPointerUpTime(e){return e>=this._pointerUpTime.length?-1:this._pointerUpTime[e]}getPointerLongPress(e){return e>=this._pointerDownTime.length?!1:this.getPointerPressed(e)&&this.context.time.time-this._pointerDownTime[e]>this._longPressTimeThreshold}getIsMouse(e){return e>=this._pointerTypes.length?!1:this._pointerTypes[e]==="mouse"}getIsTouch(e){return e>=this._pointerTypes.length?!1:this._pointerTypes[e]==="touch"}getTouchesPressedCount(){let e=0;for(let t=0;t<this._pointerPressed.length;t++)this._pointerPressed[t]&&this.getIsTouch(t)&&e++;return e}getMouseWheelChanged(e=0){return e>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[e]}getPointerEvent(e){var t;if(!(e>=this._pointerEvent.length))return(t=this._pointerEvent[e])!=null?t:void 0}getKeyDown(){for(const e in this.keysPressed){const t=this.keysPressed[e];if(t.startFrame===this.context.time.frameCount)return t.key}return null}getKeyPressed(){for(const e in this.keysPressed){const t=this.keysPressed[e];if(t.pressed)return t.key}return null}isKeyDown(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.startFrame)===this.context.time.frameCount&&this.keysPressed[e].pressed}isKeyUp(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.frame)===this.context.time.frameCount&&!this.keysPressed[e].pressed}isKeyPressed(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.pressed)}createPointerDown(e){this.onDown(e)}createPointerMove(e){this.onMove(e)}createPointerUp(e){this.onUp(e)}onLostFocus(){for(const e in this.keysPressed)this.keysPressed[e].pressed=!1}onEndOfFrame(){for(let e=0;e<this._pointerUp.length;e++)this._pointerUp[e]=!1;for(let e=0;e<this._pointerDown.length;e++)this._pointerDown[e]=!1;for(let e=0;e<this._pointerClick.length;e++)this._pointerClick[e]=!1;for(let e=0;e<this._pointerDoubleClick.length;e++)this._pointerDoubleClick[e]=!1;for(const e of this._pointerPositionsDelta)e.set(0,0);for(let e=0;e<this._mouseWheelChanged.length;e++)this._mouseWheelChanged[e]=!1}onKeyDown(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];t&&t.pressed||(this.keysPressed[e.keyCode]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:e.key})}onKeyPressed(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];!t||(t.pressed=!0,t.frame=this.context.time.frameCount+1)}onKeyUp(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];!t||(t.pressed=!1,t.frame=this.context.time.frameCount+1)}onMouseWheel(e){this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0}onTouchMove(e){}onTouchUp(e){}onPointerDown(e){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;e.preventDefault&&e.preventDefault();let t=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(t=e.button),this.onDown({button:t,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e})}onPointerMove(e,t=void 0){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;t!==!0&&e.preventDefault();let s=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(s=e.button),s<0&&(s=0);const n={button:s,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e};this.onMove(n)}onPointerUp(e,t=void 0){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;t!==!0&&e.preventDefault();let s=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(s=e.button),this._pointerIds[s]=-1,this.onUp({button:s,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e})}isInRect(e){return!0}onDown(e){if(!!this.isInRect(e)){for(this.setPointerState(e.button,this._pointerPressed,!0),this.setPointerState(e.button,this._pointerDown,!0),this.setPointerStateT(e.button,this._pointerEvent,e.source);e.button>=this._pointerTypes.length;)this._pointerTypes.push(e.pointerType);for(this._pointerTypes[e.button]=e.pointerType===void 0?"mouse":e.pointerType;e.button>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new z);this._pointerPositionDown[e.button].set(e.clientX,e.clientY),e.button>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[e.button]=this.context.time.time,this.updatePointerPosition(e),A.Current=this.context,this.dispatchEvent(new Event(tn.PointerDown))}}onMove(e){!this.isInRect(e)||(this.updatePointerPosition(e),this.setPointerStateT(e.button,this._pointerEvent,e.source))}onUp(e){if(this.setPointerState(e.button,this._pointerPressed,!1),this.setPointerStateT(e.button,this._pointerEvent,e.source),!this.isInRect(e))return;if(this.setPointerState(e.button,this._pointerUp,!0),this.updatePointerPosition(e),!this._pointerPositionDown[e.button]){console.warn("Received pointer up event without matching down event for button: "+e.button);return}const t=e.clientX-this._pointerPositionDown[e.button].x,s=e.clientY-this._pointerPositionDown[e.button].y;if(e.button>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),Math.abs(t)<5&&Math.abs(s)<5){this.setPointerState(e.button,this._pointerClick,!0);const n=this._pointerUpTime[e.button],o=this.context.time.time-n;o<this._doubleClickTimeThreshold&&o>0&&this.setPointerState(e.button,this._pointerDoubleClick,!0)}this._pointerUpTime[e.button]=this.context.time.time}updatePointerPosition(e){for(;e.button>=this._pointerPositions.length;)this._pointerPositions.push(new z);for(;e.button>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new z);for(;e.button>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new z);const t=this._pointerPositionsLastFrame[e.button];t.copy(this._pointerPositions[e.button]),this._pointerPositionsDelta[e.button].set(e.clientX-t.x,e.clientY-t.y),this._pointerPositions[e.button].x=e.clientX,this._pointerPositions[e.button].y=e.clientY;const s=e.clientX+window.scrollX,n=e.clientY+window.scrollY;for(;e.button>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new z);this._pointerPositionsRC[e.button].x=(s-this.context.domX)/this.context.domWidth*2-1,this._pointerPositionsRC[e.button].y=-((n-this.context.domY)/this.context.domHeight)*2+1}getPointerIndex(e){for(let t=0;t<this._pointerIds.length;t++)if(this._pointerIds[t]===e)return t;for(let t=0;t<this._pointerIds.length;t++)if(this._pointerIds[t]===-1&&(this._pointerIds[t]=e),this._pointerIds[t]===e)return t;return this._pointerIds.push(e),this._pointerIds.length-1}setPointerState(e,t,s){for(;t.length<=e;)t.push(!1);t[e]=s}setPointerStateT(e,t,s){for(;t.length<=e;)t.push(null);t[e]=s}}rm(bc,"Input");var Ze;(function(i){i[i.BACKSPACE=8]="BACKSPACE",i[i.TAB=9]="TAB",i[i.ENTER=13]="ENTER",i[i.SHIFT=16]="SHIFT",i[i.CTRL=17]="CTRL",i[i.ALT=18]="ALT",i[i.PAUSE=19]="PAUSE",i[i.CAPS_LOCK=20]="CAPS_LOCK",i[i.ESCAPE=27]="ESCAPE",i[i.SPACE=32]="SPACE",i[i.PAGE_UP=33]="PAGE_UP",i[i.PAGE_DOWN=34]="PAGE_DOWN",i[i.END=35]="END",i[i.HOME=36]="HOME",i[i.LEFT_ARROW=37]="LEFT_ARROW",i[i.UP_ARROW=38]="UP_ARROW",i[i.RIGHT_ARROW=39]="RIGHT_ARROW",i[i.DOWN_ARROW=40]="DOWN_ARROW",i[i.INSERT=45]="INSERT",i[i.DELETE=46]="DELETE",i[i.KEY_0=48]="KEY_0",i[i.KEY_1=49]="KEY_1",i[i.KEY_2=50]="KEY_2",i[i.KEY_3=51]="KEY_3",i[i.KEY_4=52]="KEY_4",i[i.KEY_5=53]="KEY_5",i[i.KEY_6=54]="KEY_6",i[i.KEY_7=55]="KEY_7",i[i.KEY_8=56]="KEY_8",i[i.KEY_9=57]="KEY_9",i[i.KEY_A=65]="KEY_A",i[i.KEY_B=66]="KEY_B",i[i.KEY_C=67]="KEY_C",i[i.KEY_D=68]="KEY_D",i[i.KEY_E=69]="KEY_E",i[i.KEY_F=70]="KEY_F",i[i.KEY_G=71]="KEY_G",i[i.KEY_H=72]="KEY_H",i[i.KEY_I=73]="KEY_I",i[i.KEY_J=74]="KEY_J",i[i.KEY_K=75]="KEY_K",i[i.KEY_L=76]="KEY_L",i[i.KEY_M=77]="KEY_M",i[i.KEY_N=78]="KEY_N",i[i.KEY_O=79]="KEY_O",i[i.KEY_P=80]="KEY_P",i[i.KEY_Q=81]="KEY_Q",i[i.KEY_R=82]="KEY_R",i[i.KEY_S=83]="KEY_S",i[i.KEY_T=84]="KEY_T",i[i.KEY_U=85]="KEY_U",i[i.KEY_V=86]="KEY_V",i[i.KEY_W=87]="KEY_W",i[i.KEY_X=88]="KEY_X",i[i.KEY_Y=89]="KEY_Y",i[i.KEY_Z=90]="KEY_Z",i[i.LEFT_META=91]="LEFT_META",i[i.RIGHT_META=92]="RIGHT_META",i[i.SELECT=93]="SELECT",i[i.NUMPAD_0=96]="NUMPAD_0",i[i.NUMPAD_1=97]="NUMPAD_1",i[i.NUMPAD_2=98]="NUMPAD_2",i[i.NUMPAD_3=99]="NUMPAD_3",i[i.NUMPAD_4=100]="NUMPAD_4",i[i.NUMPAD_5=101]="NUMPAD_5",i[i.NUMPAD_6=102]="NUMPAD_6",i[i.NUMPAD_7=103]="NUMPAD_7",i[i.NUMPAD_8=104]="NUMPAD_8",i[i.NUMPAD_9=105]="NUMPAD_9",i[i.MULTIPLY=106]="MULTIPLY",i[i.ADD=107]="ADD",i[i.SUBTRACT=109]="SUBTRACT",i[i.DECIMAL=110]="DECIMAL",i[i.DIVIDE=111]="DIVIDE",i[i.F1=112]="F1",i[i.F2=113]="F2",i[i.F3=114]="F3",i[i.F4=115]="F4",i[i.F5=116]="F5",i[i.F6=117]="F6",i[i.F7=118]="F7",i[i.F8=119]="F8",i[i.F9=120]="F9",i[i.F10=121]="F10",i[i.F11=122]="F11",i[i.F12=123]="F12",i[i.NUM_LOCK=144]="NUM_LOCK",i[i.SCROLL_LOCK=145]="SCROLL_LOCK",i[i.SEMICOLON=186]="SEMICOLON",i[i.EQUALS=187]="EQUALS",i[i.COMMA=188]="COMMA",i[i.DASH=189]="DASH",i[i.PERIOD=190]="PERIOD",i[i.FORWARD_SLASH=191]="FORWARD_SLASH",i[i.GRAVE_ACCENT=192]="GRAVE_ACCENT",i[i.OPEN_BRACKET=219]="OPEN_BRACKET",i[i.BACK_SLASH=220]="BACK_SLASH",i[i.CLOSE_BRACKET=221]="CLOSE_BRACKET",i[i.SINGLE_QUOTE=222]="SINGLE_QUOTE"})(Ze||(Ze={}));var om=Object.defineProperty,am=(i,e)=>om(i,"name",{value:e,configurable:!0});class Xi{constructor(e){r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new I(1,1,0,0));r(this,"gameObject");r(this,"lightmapTexture",null);r(this,"lightmapScaleOffsetUniform",{value:new I(1,1,0,0)});r(this,"lightmapUniform",{value:null});this.gameObject=e}get lightmap(){return this.lightmapTexture}set lightmap(e){e!==this.lightmapTexture&&(this.lightmapTexture=e,this.setupLightmap())}init(e,t,s,n=!1){if(console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=e,this.lightmapIndex<0)return;this.lightmapScaleOffset=t,this.lightmapTexture=s,n&&this.setLightmapDebugMaterial(),this.setupLightmap()}bindOnBeforeRender(){this.gameObject.onBeforeRender=this.onBeforeRenderThreeComplete.bind(this)}onBeforeRenderThreeComplete(e,t,s,n,o,a){this.onBeforeRenderThree(o)}setupLightmap(){if(this.gameObject.type==="Object3D")return;if(this.gameObject.type==="Group"){console.warn("Lightmap on multimaterial object is not supported yet... please ask kindly for implementation.");return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const e=this.gameObject;e.geometry.getAttribute("uv2")||e.geometry.setAttribute("uv2",e.geometry.getAttribute("uv"));const t=this.gameObject.material.clone();if(this.gameObject.material=t,this.gameObject.material.onBeforeCompile=(s,n)=>{s.uniforms.lightmap=this.lightmapUniform,s.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform},this.lightmapIndex>=0){const s=this.lightmapTexture,n=this.gameObject.material;n&&s&&(n.uniforms||(n.uniforms={}),n.lightMap=s,n.uniforms.lightmap={value:s})}}onBeforeRenderThree(e){const t=e.uniforms;t&&t.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,t.lightmap=this.lightmapUniform,t.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}setLightmapDebugMaterial(){this.gameObject.material=new yf({vertexShader:`
                attribute vec2 uv2;
                varying vec2 vUv2;
                void main()
                {
                    vUv2 = uv2;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightmap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv2;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightmap, lUv);
                    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
                    //lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
                    //lightMapTexel.a = 1.;
                    //lightMapTexel = conv_sRGBToLinear(lightMapTexel);
                    // lightMapTexel.rgb = vec3(1.);

                    // gl_FragColor = vec4(vUv2.xy, 0, 1);
                    gl_FragColor = lightMapTexel;
                }
                `,defines:{USE_LIGHTMAP:""}})}}am(Xi,"RendererLightmap");var lm=Object.defineProperty,sn=(i,e)=>lm(i,"name",{value:e,configurable:!0});const g=sn(function(i){if(i===void 0&&(i=null),!Array.isArray(i))i=lo(i);else for(let e=0;e<i.length;e++){const t=i[e];i[e]=lo(t)}return function(e,t){Object.getOwnPropertyDescriptor(e,"$serializedTypes")||(e.$serializedTypes={});const s=e.$serializedTypes=e.$serializedTypes||{};s[t]=i}},"serializeable");function lo(i){switch(i==null?void 0:i.prototype.constructor.name){case"Number":case"String":case"Boolean":return null}return i}sn(lo,"setNullForPrimitiveTypes");const cm="__NEEDLE__ALL_PROPERTIES";function hm(i){i[cm]=!0}sn(hm,"allProperties");const dm="__NEEDLE__STRICT";function um(i){i[dm]=!0}sn(um,"strict");var yc=Object.defineProperty,fm=Object.getOwnPropertyDescriptor,Ke=(i,e)=>yc(i,"name",{value:e,configurable:!0}),Nt=(i,e,t,s)=>{for(var n=s>1?void 0:s?fm(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&yc(e,t,n),n};const wc=v("noInstancing"),vc=!!v("debuglightmaps");class co{constructor(){r(this,"path",null);r(this,"asset",null);r(this,"default")}}Ke(co,"FieldWithDefault");var xc;(function(i){i[i.Both=0]="Both",i[i.Back=1]="Back",i[i.Front=2]="Front"})(xc||(xc={}));class Pc{constructor(e){r(this,"_renderer");r(this,"_targets",[]);this._renderer=e;const t=this.setMaterial.bind(this),s=this.getMaterial.bind(this),n=e.gameObject;if(this._targets=[],n)switch(n.type){case"Group":this._targets=[...n.children];break;case"Mesh":this._targets.push(n);break}return new Proxy(this,{get(o,a){if(typeof a=="string"){const l=parseInt(a);if(!isNaN(l))return s(l)}return o[a]},set(o,a,l){return typeof a=="string"&&t(l,Number.parseInt(a)),Reflect.set(o,a,l)}})}is(e){return this._renderer===e}get length(){return this._targets.length}setMaterial(e,t){if(t<0||t>=this._targets.length)return;const s=this._renderer.gameObject;if(!s)return;const n=s.children[t];!n||(n.material=e)}getMaterial(e){if(e<0)return null;const t=this._targets;if(e>=t.length)return null;const s=t[e];return s?s.material:null}}Ke(Pc,"SharedMaterialArray");const Oc=class extends w{constructor(){super(...arguments);r(this,"receiveShadows",!1);r(this,"shadowCastingMode",rn.Off);r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new I(1,1,0,0));r(this,"enableInstancing");r(this,"renderOrder");r(this,"allowOcclusionWhenDynamic",!0);r(this,"_lightmaps");r(this,"_sharedMaterials");r(this,"_lightmapTextureOverride");r(this,"_isInstancingEnabled",!1);r(this,"handles");r(this,"prevLayers")}get material(){return this.gameObject.material}set material(i){this.gameObject.material=i}get sharedMaterials(){return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._sharedMaterials=new Pc(this)),this._sharedMaterials}static get shouldSuppressInstancing(){return wc}get lightmap(){var i;return((i=this._lightmaps)==null?void 0:i.length)?this._lightmaps[0].lightmap:null}set lightmap(i){var e;if(this._lightmapTextureOverride=i,i===void 0&&(i=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(e=this._lightmaps)==null?void 0:e.length)for(const t of this._lightmaps)t.lightmap=i}awake(){var e,t;const i=this.gameObject.type;if(i==="Group"){for(const s of this.gameObject.children)s.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let s=0;for(let n=0;n<this.gameObject.children.length;n++){const o=this.gameObject.children[n];if(!(o.type!=="Mesh"||p.getComponent(o,Oc))){if(this.renderOrder.length<=s){console.error("Incorrect element count",this);break}o.renderOrder=this.renderOrder[s],s+=1}}}}if(this.lightmapIndex>=0){const s=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(s){if(this._lightmaps=[],i==="Mesh"){if(!((e=this.gameObject.material)==null?void 0:e.isMeshBasicMaterial)){const n=new Xi(this.gameObject);this._lightmaps.push(n),n.init(this.lightmapIndex,this.lightmapScaleOffset,s,vc)}}else if(i==="Group"){for(const n of this.gameObject.children)if(!((t=n.material)==null?void 0:t.isMeshBasicMaterial)){const o=new Xi(n);this._lightmaps.push(o),o.init(this.lightmapIndex,this.lightmapScaleOffset,s,vc),o.bindOnBeforeRender()}}}}(i==="Mesh"||i==="SkinnedMesh")&&(this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0]),this.gameObject.onBeforeRender=this.onBeforeRenderThree.bind(this))}setInstancingEnabled(i){if(this._isInstancingEnabled===i)return i&&(this.handles===void 0||this.handles!=null&&this.handles.length>0);if(this._isInstancingEnabled=i,i){if(this.handles===void 0){if(this.handles=pm.setup(this.gameObject,this.context,null,{rend:this,foundMeshes:0}),this.handles)return p.markAsInstancedRendered(this.gameObject,!0),!0}else if(this.handles!==null){for(const e of this.handles)e.updateInstanceMatrix(!0),e.add();return p.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this.handles)for(const e of this.handles)e.remove();return!0}return!1}start(){if(this.enableInstancing&&!wc&&this.setInstancingEnabled(!0),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.gameObject.type==="Group")for(let i=0;i<this.gameObject.children.length;i++){const e=this.gameObject.children[i];e.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this._isInstancingEnabled?this.setInstancingEnabled(!0):this.enabled&&(this.gameObject.visible=!0)}onDisable(){this.handles&&this.handles.length>0?this.setInstancingEnabled(!1):this.enabled||(this.gameObject.visible=!1)}onDestroy(){this.handles=null}onBeforeRenderThree(i,e,t,s,n,o){var a;if(!t&&this.context.isInXR){const l=this.context.renderer.xr.getCamera();((a=l.cameras)==null?void 0:a.length)>0&&(t=l)}if(this._lightmaps)for(const l of this._lightmaps)l.onBeforeRenderThree(n)}onBeforeRender(){var e;if(!this.gameObject)return;const i=this.gameObject[uo]===!0||this.gameObject.matrixWorldNeedsUpdate;if(this.gameObject.type==="Group"&&((e=this.gameObject.children)==null?void 0:e.length)>0)for(const t of this.gameObject.children)this.applySettings(t);else this.applySettings(this.gameObject);if(i&&(delete this.gameObject[uo],this.handles)){for(let t=this.handles.length-1;t>=0;t--)this.handles[t].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this.handles&&this.handles.length<=0&&p.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this.handles)for(let t=0;t<this.handles.length;t++){const s=this.handles[t];this.prevLayers||(this.prevLayers=[]);const n=s.object.layers.mask;t>=this.prevLayers.length?this.prevLayers.push(n):this.prevLayers[t]=n,s.object.layers.disableAll()}}onAfterRender(){if(this._isInstancingEnabled&&this.handles&&this.prevLayers&&this.prevLayers.length>=this.handles.length)for(let i=0;i<this.handles.length;i++){const e=this.handles[i];e.object.layers.mask=this.prevLayers[i]}}applySettings(i){i.receiveShadow=this.receiveShadows,this.shadowCastingMode==rn.On?i.castShadow=!0:i.castShadow=!1}};let de=Oc;Ke(de,"Renderer");Nt([g()],de.prototype,"receiveShadows",2);Nt([g()],de.prototype,"shadowCastingMode",2);Nt([g()],de.prototype,"lightmapIndex",2);Nt([g(I)],de.prototype,"lightmapScaleOffset",2);Nt([g()],de.prototype,"enableInstancing",2);Nt([g()],de.prototype,"renderOrder",2);Nt([g()],de.prototype,"allowOcclusionWhenDynamic",2);class nn extends de{}Ke(nn,"MeshRenderer");class ho extends nn{awake(){super.awake(),this.allowOcclusionWhenDynamic=!1}}Ke(ho,"SkinnedMeshRenderer");var rn;(function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.TwoSided=2]="TwoSided",i[i.ShadowsOnly=3]="ShadowsOnly"})(rn||(rn={}));const uo="NEEDLE_NEED_UPDATE_INSTANCE";class re{static markDirty(e,t=!0){if(!!e&&(p.isUsingInstancing(e)&&(e[uo]=!0,e.matrixWorldNeedsUpdate=!0),t))for(const s of e.children)re.markDirty(s,!0)}}Ke(re,"InstancingUtil");class Cc{constructor(){r(this,"objs",[])}setup(e,t,s,n,o=0){const a=this.tryCreateOrAddInstance(e,t,n);if(a)return s===null&&(s=[]),s.push(a),s;if(o<=0&&e.type!=="Mesh"){const l=o+1;for(const c of e.children)s=this.setup(c,t,s,n,l)}return s}tryCreateOrAddInstance(e,t,s){if(e.type==="Mesh"){const n=s.foundMeshes;if(s.foundMeshes+=1,!s.rend.enableInstancing||n>=s.rend.enableInstancing.length||!s.rend.enableInstancing[n])return null;const o=e,a=o.geometry,l=o.material;for(const h of this.objs)if(!h.isFull()&&h.geo===a&&h.material===l)return h.addInstance(o);const c=new on(e.name,a,l,200,t);return this.objs.push(c),c.addInstance(o)}return null}}Ke(Cc,"InstancingHandler");const pm=new Cc;class Sc{constructor(e,t,s){r(this,"instanceIndex",-1);r(this,"object");r(this,"instancer");this.instanceIndex=e,this.object=t,this.instancer=s,p.markAsInstancedRendered(t,!0)}get name(){return this.object.name}updateInstanceMatrix(e=!1){this.instanceIndex<0||(this.object.updateWorldMatrix(!0,e),this.instancer.updateInstance(this.object.matrixWorld,this.instanceIndex))}add(){this.instanceIndex>=0||this.instancer.add(this)}remove(){this.instanceIndex<0||this.instancer.remove(this)}}Ke(Sc,"InstanceHandle");const ll=class{constructor(e,t,s,n,o){r(this,"name","");r(this,"geo");r(this,"material");r(this,"context");r(this,"inst");r(this,"handles",[]);r(this,"maxCount");this.name=e,this.geo=t,this.material=s,this.context=o,this.maxCount=n,this.inst=new wf(t,s,n),this.inst.count=0,this.inst.layers.set(2),this.inst.visible=!0,this.context.scene.add(this.inst)}get currentCount(){return this.inst.count}isFull(){return this.currentCount>=this.maxCount}addInstance(e){if(this.currentCount>=this.maxCount)return console.error("TOO MANY INSTANCES - resize is not yet implemented!",this.inst.count),null;const t=new Sc(-1,e,this);return this.add(t),t}add(e){e.instanceIndex<0&&(e.instanceIndex=this.currentCount,e.instanceIndex>=this.handles.length?this.handles.push(e):this.handles[e.instanceIndex]=e),e.object.updateWorldMatrix(!0,!0),this.inst.setMatrixAt(e.instanceIndex,e.object.matrixWorld),this.inst.instanceMatrix.needsUpdate=!0,this.inst.count+=1,this.inst.count>0&&(this.inst.visible=!0)}remove(e){if(!e||e.instanceIndex<0||e.instanceIndex>=this.handles.length||this.inst.count<=0)return;if(this.handles[e.instanceIndex]!==e){console.error("instance handle is not part of renderer, was it removed before?",e.instanceIndex,this.name);const s=this.handles.indexOf(e);if(s<0)return;e.instanceIndex=s}if(this.handles[e.instanceIndex]=null,this.inst.setMatrixAt(e.instanceIndex,ll.nullMatrix),!(e.instanceIndex>=this.currentCount-1)&&this.currentCount>0){const s=this.handles[this.currentCount-1];s&&(s.instanceIndex=e.instanceIndex,s.updateInstanceMatrix(),this.handles[e.instanceIndex]=s,this.handles[this.currentCount-1]=null)}this.inst.count>0&&(this.inst.count-=1),e.instanceIndex=-1,this.inst.count<=0&&(this.inst.visible=!1),this.inst.instanceMatrix.needsUpdate=!0}updateInstance(e,t){this.inst.setMatrixAt(t,e),this.inst.instanceMatrix.needsUpdate=!0}};let on=ll;r(on,"nullMatrix",new Ce);Ke(on,"InstancedMeshRenderer");var mm=Object.defineProperty,et=(i,e)=>mm(i,"name",{value:e,configurable:!0});const Qi=v("debugphysics");class fo{constructor(){r(this,"mass",1);r(this,"kinematic",!1);r(this,"physicsEvents",!1);r(this,"drag",0);r(this,"angularDrag",.05);r(this,"sleepThreshold",.01)}}et(fo,"BodyOptions");class an{constructor(e,t){r(this,"obj");r(this,"parent");r(this,"body");r(this,"shapes",[]);r(this,"collisonCallback",null);r(this,"_hasRigidbody",!1);r(this,"_didSleepLastStep",!1);this.obj=e,this.parent=e.parent,this.body=t}}et(an,"PhysicsObject");class Rc{constructor(e,t){r(this,"obj");r(this,"contact");r(this,"target");r(this,"type");this.contact=e,this.type=t,this.obj=null,this.target=null}}et(Rc,"CollisionData");class gm{constructor(e,t,s,n){r(this,"body");r(this,"contact");r(this,"target");r(this,"type");this.body=e,this.contact=t,this.target=s,this.type=n}}et(gm,"CannonCollision");class je{constructor(){r(this,"ray");r(this,"screenPoint");r(this,"raycaster");r(this,"results");r(this,"targets");r(this,"recursive",!0);r(this,"minDistance");r(this,"maxDistance");r(this,"lineThreshold");r(this,"layerMask");r(this,"ignore")}screenPointFromOffset(e,t){this.screenPoint===void 0&&(this.screenPoint=new z),this.screenPoint.x=e/window.innerWidth*2-1,this.screenPoint.y=-(t/window.innerHeight)*2+1}setMask(e){this.layerMask||(this.layerMask=new Ws);const t=this.layerMask;t?t.mask=e:this.layerMask=e}}r(je,"AllLayers",4294967295);et(je,"RaycastOptions");class Ec{constructor(e,t,s){r(this,"distance");r(this,"point");r(this,"object");this.object=e,this.distance=t,this.point=s}}et(Ec,"SphereIntersection");class Ac{constructor(e){r(this,"raycaster",new Fr);r(this,"defaultRaycastOptions",new je);r(this,"targetBuffer",new Array(1));r(this,"defaultThresholds",{Mesh:{},Line:{threshold:0},LOD:{},Points:{threshold:0},Sprite:{}});r(this,"sphereResults",new Array);r(this,"sphereMask",new Ws);r(this,"tempBoundingBox",new ii);r(this,"context");r(this,"world",new xf);r(this,"objects",[]);r(this,"tempPosition",new y);r(this,"tempQuaternion",new P);if(this.context=e,this.world.gravity.set(0,-9.82,0),Qi){const t={};t.onInit=(s,n,o)=>{n.layers.set(-1)},Pf(e.scene,this.world.bodies,t)}}sphereOverlap(e,t){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const s=new vf(e,t),n=this.sphereMask;n.enableAll(),n.disable(2);for(const o of this.context.scene.children){const a=this.onSphereOverlap(o,s,n);a&&this.sphereResults.push(a)}return this.sphereResults.sort((o,a)=>o.distance-a.distance)}onSphereOverlap(e,t,s){if(e.type==="Mesh"){if(!e.layers.test(s))return null;const n=e,o=n.geometry;if(o.boundingBox||o.computeBoundingBox(),!o.boundingBox)return null;n.matrixWorldNeedsUpdate&&n.updateMatrixWorld();const a=this.tempBoundingBox.copy(o.boundingBox).applyMatrix4(n.matrixWorld);if(t.intersectsBox(a)){const c=C(e).distanceTo(t.center);return new Ec(e,c,t.center.clone())}}else if(e.children)for(const n of e.children){const o=this.onSphereOverlap(n,t,s);if(o)return o}return null}raycastFromRay(e,t=null){const s=t!=null?t:this.defaultRaycastOptions;return s.ray=e,this.raycast(s)}raycast(e=null){var l,c,h,d,u;e||(e=this.defaultRaycastOptions);const t=(l=e.screenPoint)!=null?l:this.context.input.mousePositionRC,s=(c=e.raycaster)!=null?c:this.raycaster;if(s.near=(h=e.minDistance)!=null?h:0,s.far=(d=e.maxDistance)!=null?d:1/0,s.params=this.defaultThresholds,e.lineThreshold?s.params.Line={threshold:e.lineThreshold}:s.params.Line={threshold:0},e.ray)s.ray.copy(e.ray);else{const _=this.context.mainCamera;if(!_)return console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),(u=this.defaultRaycastOptions.results)!=null?u:[];s.setFromCamera(t,_)}let n=e.targets;n||(n=this.targetBuffer,n[0]=this.context.scene);let o=e.results;o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),e.layerMask!==void 0?e.layerMask instanceof Ws?s.layers.mask=e.layerMask.mask:s.layers.mask=e.layerMask:(s.layers.enableAll(),s.layers.disable(2)),o.length=0,s.intersectObjects(n,e.recursive,o);const a=e.ignore;return a!==void 0&&a.length>0&&(o=o.filter(_=>!a.includes(_.object))),o}addPreStepListener(e){this.world.addEventListener("preStep",e)}addPostStepListener(e){this.world.addEventListener("postStep",e)}addConstraint(e){this.world.addConstraint(e)}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}multiplyGravity(e){this.world.gravity.x*=e.x,this.world.gravity.y*=e.y,this.world.gravity.z*=e.z}addBody(e,t){for(let s=0;s<this.objects.length;s++){const n=this.objects[s];if(n.obj===e){n._hasRigidbody=!0;break}}this.world.addBody(t)}removeBody(e,t,s=!0){this.world.removeBody(t);for(let n=0;n<this.objects.length;n++){const o=this.objects[n];if(o.obj===e){o._hasRigidbody=!1,s&&this.objects.splice(n,1);break}}}removeShape(e,t){for(const s of this.objects)if(s.obj===e){s.body&&(s.body.removeShape(t),s.body.updateMassProperties());return}}createBody(e,t){const s=this.internalCreateBody(e,null);t.mass&&(s.mass=t.mass),t.kinematic?s.type=he.KINEMATIC:s.type=he.DYNAMIC,t.drag&&(s.linearDamping=t.drag),t.angularDrag&&(s.angularDamping=t.angularDrag),t.sleepThreshold&&(s.sleepSpeedLimit=t.sleepThreshold),s.name=e.name,this.world.addBody(s);const n=new an(e,s);return n._hasRigidbody=!0,this.objects.push(n),Qi&&console.log("created new body",s),t.physicsEvents&&this.registerCollisionEvents(n),s}addBoxCollider(e,t,s,n,o){const a=this.tempPosition;e.getWorldScale(a);const l=new It(.5*a.x*n.x,.5*a.y*n.y,.5*a.z*n.z),c=new Of(l);c.collisionResponse=!t,s=s.clone(),s.multiply(a);const h=this.addShape(e,c,s,o);if(h!==null){if(this.isAlreadyRegistered(h))return c;const d=new an(e,h);this.objects.push(d)}return c}addSphereCollider(e,t,s,n){const o=this.tempPosition;e.getWorldScale(o);const a=Math.max(o.x,o.y,o.z),l=new Cf(s*a);t=t.clone(),t.multiply(o);const c=this.addShape(e,l,t,n);if(c!==null){if(this.isAlreadyRegistered(c))return l;const h=new an(e,c);this.objects.push(h)}return l}addMeshCollider(e){Qi&&console.warn("TODO mesh collider not yet supported")}isAlreadyRegistered(e){for(const t of this.objects)if(t.body===e)return!0;return!1}addShape(e,t,s,n){let o=null;if(n?(n.initialize(),console.assert(!!n.body,"rigidbody didn't initialize / produce a physics body",n),o=n.body):(o=this.internalCreateBody(e,null),o.type=he.KINEMATIC,this.world.addBody(o)),o){s.x*=-1;const a=K(e),l=C(e);l.add(s);const c=new P(o.quaternion.x,o.quaternion.y,o.quaternion.z,o.quaternion.w);a.multiply(c.invert());const h=o.position,d=new It(l.x-h.x,l.y-h.y,l.z-h.z),u=new _l(a.x,a.y,a.z,a.w);o.addShape(t,d,u),o.updateMassProperties()}return o}step(e){e=Math.min(e,1/30),this.world.step(e)}postStep(){for(let e=0;e<this.objects.length;e++){const t=this.objects[e],s=t.body;if(!s||!s.world)continue;s.sleepTick(this.context.time.time),Qi&&(!t._didSleepLastStep&&s.sleepState===he.SLEEPING?console.log("BODY SLEEPING",s):t._didSleepLastStep&&s.sleepState!==he.SLEEPING&&console.log("BODY WOKE UP",s)),t._didSleepLastStep=s.sleepState===he.SLEEPING;const n=t.obj;if(s.type===he.KINEMATIC){const o=C(n,null);s.position.set(o.x,o.y,o.z);const a=K(n);s.quaternion.set(a.x,a.y,a.z,a.w);continue}if(t.parent&&n.parent===t.parent){ic(n,s.quaternion.x,s.quaternion.y,s.quaternion.z,s.quaternion.w);const o=s.position;qs(n,o.x,o.y,o.z),s.velocity.length()>s.sleepSpeedLimit&&re.markDirty(n)}}}internalCreateBody(e,t){const s=new he;e.getWorldPosition(this.tempPosition);const n=this.tempPosition;s.position=new It(n.x,n.y,n.z);const o=this.tempQuaternion;return e.getWorldQuaternion(o),s.quaternion=new _l(o.x,o.y,o.z,o.w),s.type=he.KINEMATIC,t&&(s.addShape(t),s.updateMassProperties()),s}registerCollisionEvents(e){if(e.collisonCallback&&this.unregisterCollisionEvents(e),!e.body)return;const t=et(s=>this.raiseCollisionEvents(e.obj,s),"evt");e.collisonCallback=t.bind(this),e.body.addEventListener("collide",e.collisonCallback)}unregisterCollisionEvents(e){!e.collisonCallback||!e.body||e.body.removeEventListener("collide",e.collisonCallback)}raiseCollisionEvents(e,t){var l,c;const s=new Rc(t.contact,t.type);let n=0;const o=this.objects;function a(){if(!(n>0))for(let h=0;h<o.length;h++){if(n==2)return;const d=o[h];d.body==t.body?(s.obj=d.obj,++n):d.body==t.target&&(s.target=d.obj,++n)}}et(a,"requestData"),Qi&&console.log("collision between",t.contact.bi,t.contact.bj,e,t);for(let h=0;h<((c=(l=e.userData)==null?void 0:l.components)==null?void 0:c.length);h++){const d=e.userData.components[h];d.onCollision&&(a(),d.onCollision(s))}}}et(Ac,"Physics");var _m=Object.defineProperty,bm=(i,e)=>_m(i,"name",{value:e,configurable:!0});class kc{constructor(){r(this,"deltaTime",0);r(this,"time",0);r(this,"frame",0);r(this,"clock",new Sf);r(this,"_smoothedFps",0);r(this,"_fpsSamples",[]);r(this,"_fpsSampleIndex",0)}get realtimeSinceStartup(){return this.clock.elapsedTime}get frameCount(){return this.frame}get smoothedFps(){return this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<30?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%30]=this.deltaTime;let e=0;for(let t=0;t<this._fpsSamples.length;t++)e+=this._fpsSamples[t];this._smoothedFps=1/(e/this._fpsSamples.length)}}bm(kc,"Time");var ym=Object.defineProperty,wm=(i,e)=>ym(i,"name",{value:e,configurable:!0});class wt extends w{constructor(){super(...arguments);r(this,"url",null);r(this,"urlParameterName",null);r(this,"localhost",null)}getWebsocketUrl(){let e=this.url?wt.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const o=v(this.urlParameterName);o&&typeof o=="string"&&(e=o)}if(!e)return null;const s=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(e);return(s==null?void 0:s.groups)?(s==null?void 0:s.groups.socket_prefix)?e:"wss://"+(s==null?void 0:s.groups.url):null}static GetUrl(e,t){let s=e;const n=wt.IsLocalNetwork()&&t;return n&&(s=t),(e==null?void 0:e.startsWith("/"))&&(s=(n?s:window.location.origin)+e),s}static IsLocalNetwork(e=window.location.hostname){return new RegExp(".{3}..{2,3}..{2,3}..{2,3}|localhost","gm").test(e)===!0?!0:["localhost","127.0.0.1","","::1","marcel-pfc-domain.de"].includes(e)||e.startsWith("192.168.")||e.startsWith("10.0.")||e.endsWith(".local")}}wm(wt,"Networking");var vm=Object.defineProperty,po=(i,e)=>vm(i,"name",{value:e,configurable:!0});const Lc={};function ln(i,e){Lc[i]=e}po(ln,"registerType");function Tc(i){const e=i.getBufferIdentifier();return Lc[e](i)}po(Tc,"tryCast");function Dc(i){return typeof i.guid=="function"?i.guid():null}po(Dc,"tryGetGuid");var xm=Object.defineProperty,cn=(i,e)=>xm(i,"name",{value:e,configurable:!0}),mo;(function(i){i.ConnectionList="connection-list"})(mo||(mo={}));class Mc{constructor(){r(this,"_host");r(this,"_client");r(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const e="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(e)}trySetupHost(e){let t=new Br(e);t.on("error",s=>{console.error(s),this._host=void 0,this.trySetupClient(e)}),t.on("open",s=>{this._host=new Ic(t)})}trySetupClient(e){this._client=new Br,this._client.on("error",t=>{console.error("Client error",t)}),this._client.on("open",t=>{console.log("client connected",t),this._clientData=this._client.connect(e,{metadata:{id:t}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",s=>{console.log("<<",s)})})}}cn(Mc,"PeerNetworking");class go{constructor(e){r(this,"_peer");this._peer=e}}cn(go,"AbstractPeerHandler");class Pm extends go{get isHost(){return!1}onConnection(e){}}cn(Pm,"PeerClient");class Ic extends go{constructor(e){super(e);r(this,"_connections",[]);var t;console.log("I AM THE HOST"),(t=this._peer)==null||t.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(e){console.log("host connection",e),e.on("open",()=>{this._connections.push(e),this.broadcastConnection(e)})}broadcastConnection(e){const t=this._connections.map(s=>{var n;return(n=s.metadata)==null?void 0:n.id}).filter(s=>s!==void 0);this.broadcast({type:mo.ConnectionList,connections:t})}broadcast(e){if(e!=null){console.log(">>",e);for(const t in this._peer.connections){const s=this._peer.connections[t];if(!!s)if(Array.isArray(s))for(const n of s)!n||n.send(e);else console.warn(s)}}}}cn(Ic,"PeerHost");var Om=Object.defineProperty,li=(i,e)=>Om(i,"name",{value:e,configurable:!0});let _o="wss://needle-tiny-starter.glitch.me/socket";const ue=!!v("debugnet"),hn=!!(ue||v("debugowner"));var bo;(function(i){i.ConnectionInfo="connection-start-info"})(bo||(bo={}));var H;(function(i){i.Join="join-room",i.Leave="leave-room",i.JoinedRoom="joined-room",i.LeftRoom="left-room",i.UserJoinedRoom="user-joined-room",i.UserLeftRoom="user-left-room"})(H||(H={}));class Cm{constructor(){r(this,"room");r(this,"viewId");r(this,"allowEditing");r(this,"inRoom")}}li(Cm,"JoinedRoomResponse");class Sm{constructor(){r(this,"room")}}li(Sm,"LeftRoomResponse");class Rm{constructor(){r(this,"userId")}}li(Rm,"UserJoinedOrLeftRoomModel");var Q;(function(i){i.RequestHasOwner="request-has-owner",i.ResponseHasOwner="response-has-owner",i.RequestIsOwner="request-is-owner",i.ResponseIsOwner="response-is-owner",i.RequestOwnership="request-ownership",i.GainedOwnership="gained-ownership",i.RemoveOwnership="remove-ownership",i.LostOwnership="lost-ownership",i.GainedOwnershipBroadcast="gained-ownership-broadcast",i.LostOwnershipBroadcast="lost-ownership-broadcast"})(Q||(Q={}));class dn{constructor(e,t){r(this,"guid");r(this,"connection");r(this,"_hasOwnership",!1);r(this,"_isOwned");r(this,"_gainSubscription");r(this,"_lostSubscription");r(this,"_hasOwnerResponse");r(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=e,this.guid=t,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),e.beginListen(Q.LostOwnership,this._lostSubscription),e.beginListen(Q.GainedOwnershipBroadcast,this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),e.beginListen(Q.ResponseHasOwner,this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send(Q.RequestHasOwner,{guid:this.guid})}onHasOwnerResponse(e){e.guid===this.guid&&(this._isOwned=e.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this.connection.send(Q.RequestHasOwner,{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(e){e.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=e.value,e.value||(hn&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((e,t)=>{this.requestOwnership();let s=0;const n=li(()=>{if(s++>10)return t("Timeout");setTimeout(()=>{this.hasOwnership?e(this):n()},100)},"waitForOwnership");n()})}requestOwnership(){return hn&&console.log("Request ownership",this.guid),this.connection.send(Q.RequestOwnership,{guid:this.guid}),this}freeOwnership(){return this.connection.send(Q.RemoveOwnership,{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListening(Q.GainedOwnership,this._gainSubscription),this.connection.stopListening(Q.LostOwnership,this._lostSubscription),this.connection.stopListening(Q.ResponseHasOwner,this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(e){e.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===e.owner?(hn&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(e){e===this.guid&&(hn&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}li(dn,"OwnershipModel");var Yi;(function(i){i[i.OnConnection=0]="OnConnection",i[i.OnRoomJoin=1]="OnRoomJoin",i[i.Queued=2]="Queued",i[i.Immediate=3]="Immediate"})(Yi||(Yi={}));class jc{constructor(e){r(this,"context");r(this,"_peer",null);r(this,"_usersInRoomCopy",[]);r(this,"_defaultMessagesBuffer",[]);r(this,"_defaultMessagesBufferArray",[]);r(this,"_listeners",{});r(this,"_listenersBinary",{});r(this,"connected",!1);r(this,"channelId");r(this,"_connectionId",null);r(this,"_isConnectingToWebsocket",!1);r(this,"_ws");r(this,"_waitingForSocket",{});r(this,"_isInRoom",!1);r(this,"_currentRoomName",null);r(this,"_currentRoomViewId",null);r(this,"_currentRoomAllowEditing",!0);r(this,"_currentInRoom",[]);r(this,"_state",{});r(this,"_currentDelay",-1);this.context=e}get peer(){return this._peer||(this._peer=new Mc),this._peer}tryGetState(e){return e==="invalid"?null:this._state[e]}get connectionId(){return this._connectionId}get isDebugEnabled(){return ue}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}userIsInRoom(e){return this._currentInRoom.indexOf(e)!==-1}usersInRoom(e=null){e||(e=this._usersInRoomCopy),e.length=0;for(const t of this._currentInRoom)e.push(t);return e}joinRoom(e,t=!1){this.connect(),ue&&console.log("join: "+e),this.send(H.Join,{room:e,viewOnly:t},0)}leaveRoom(e=null){if(e||(e=this.currentRoomName),!e){console.error("Can not leave unknown room");return}this.send(H.Leave,{room:e})}send(e,t=null,s=2){if(t===null&&(t={}),s===2){this._defaultMessagesBuffer.push({key:e,value:t});return}return this.sendWithWebsocket(e,t,s)}sendDeleteRemoteState(e){this.send("delete-state",{guid:e,dontSave:!0}),delete this._state[e]}sendBinary(e){var t;ue&&console.log("<< bin",e.length),(t=this._ws)==null||t.send(e)}sendBufferedMessagesNow(){var s;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const e=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(e<=1){this.sendWithWebsocket(o.key,o.value,3);break}const a=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(a)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&ue&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const t=JSON.stringify(this._defaultMessagesBufferArray);(s=this._ws)==null||s.send(t)}beginListen(e,t){return this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t),t}stopListening(e,t){if(!t||!this._listeners[e])return;const s=this._listeners[e].indexOf(t);s>=0&&this._listeners[e].splice(s,1)}beginListenBinrary(e,t){return this._listenersBinary[e]||(this._listenersBinary[e]=[]),this._listenersBinary[e].push(t),t}stopListenBinary(e,t){if(!this._listenersBinary[e])return;const s=this._listenersBinary[e].indexOf(t);s>=0&&this._listenersBinary[e].splice(s,1)}connect(){if(this.connected)return;ue&&console.log("connecting");const e=p.findObjectOfType(wt,this.context,!1),t=e==null?void 0:e.getWebsocketUrl();t&&(_o=t),this.connectWebsocket()}connectWebsocket(){if(this._isConnectingToWebsocket)return;this._isConnectingToWebsocket=!0,console.log("Connecting to "+_o);const e=new Rf.WebsocketBuilder(_o).onOpen(()=>{this._ws=e,this._isConnectingToWebsocket=!1,this.connected=!0,console.log("Connected to websocket"),this.onSendQueued(0)}).onClose(t=>{this.connected=!1,this._isInRoom=!1}).onError((t,s)=>{console.error(t,s)}).onMessage(this.onMessage.bind(this)).onRetry(()=>{console.log("websocket connection retry")}).build()}onMessage(e,t){const s=t.data;try{if(typeof s!="string"){s.size&&this.handleIncomingBinaryMessage(s);return}const n=JSON.parse(s);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch{ue&&s==="pong"&&console.log("<<",s)}}async handleIncomingBinaryMessage(e){const t=await e.arrayBuffer();var s=new Uint8Array(t);const n=new Ef(s),o=n.getBufferIdentifier(),a=this._listenersBinary[o],l=Tc(n),c=Dc(l);if(c&&typeof c=="string"&&(this._state[c]=l),!a)return;const h=l!=null?l:n;for(const d of a)d(h)}handleIncomingStringMessage(e){var n,o,a,l,c,h,d;if(ue&&console.log("<<",(n=e.key)!=null?n:e),e.key)switch(e.key){case bo.ConnectionInfo:if(e.data){const b=e.data;b&&(console.assert(b.id!==void 0&&b.id!==null&&b.id.length>0,"server did not send connection id",b.id),console.log("Your id is: "+b.id,(o=this.context.alias)!=null?o:""),this._connectionId=b.id)}else console.warn("Expected connection id in "+e.key);break;case H.JoinedRoom:if(ue&&console.log(e),e){this._isInRoom=!0;const b=e;this._currentRoomName=b.room,this._currentRoomViewId=b.viewId,this._currentRoomAllowEditing=(a=b.allowEditing)!=null?a:!0,console.log("Room view id",this._currentRoomViewId),this._currentInRoom.length=0,this._currentInRoom.push(...b.inRoom),ue&&console.log("joined room with",this._currentInRoom,(l=this.context.alias)!=null?l:"")}this.onSendQueued(1);break;case H.LeftRoom:e.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentInRoom.length=0);break;case H.UserJoinedRoom:if(e.data){const b=e.data;this._currentInRoom.push(b.userId),ue&&console.log(b.userId+" joined","now in room:",this._currentInRoom)}break;case H.UserLeftRoom:if(e.data){const b=e.data,x=this._currentInRoom.indexOf(b.userId);x>=0&&(console.log(b.userId+" left",(c=this.context.alias)!=null?c:""),this._currentInRoom.splice(x,1)),b.userId===this.connectionId&&console.log("you left the room")}break;case"ping":case"pong":const _=(h=e.data)==null?void 0:h.time;_&&(this._currentDelay=this.context.time.time-_),ue&&console.log("Current latency: "+this._currentDelay.toFixed(1)+" sec","Clients in room: "+((d=this._currentInRoom)==null?void 0:d.length));break}const t=this._listeners[e.key];if(t)for(const u of t)u(e.data);const s=e.data;s&&(this._state[s.guid]=s)}toMessage(e,t){return{key:e,data:t}}sendWithWebsocket(e,t,s=1){if(!this._ws){const o=this._waitingForSocket[s]||[];o.push(()=>this.sendWithWebsocket(e,t,s)),this._waitingForSocket[s]=o;return}const n=JSON.stringify(this.toMessage(e,t));ue&&console.log(">>",e),this._ws.send(n)}onSendQueued(e){const t=this._waitingForSocket[e];if(t){for(const s of t)s();t.length=0}}}li(jc,"NetworkConnection");var Fc=Object.defineProperty,Em=Object.getOwnPropertyDescriptor,Am=(i,e)=>Fc(i,"name",{value:e,configurable:!0}),km=(i,e,t,s)=>{for(var n=s>1?void 0:s?Em(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Fc(e,t,n),n};class Ji extends w{constructor(){super(...arguments);r(this,"constraintActive",!0);r(this,"locked",!1);r(this,"sources",[])}}Am(Ji,"LookAtConstraint");km([g(S)],Ji.prototype,"sources",2);var Bc=Object.defineProperty,Lm=Object.getOwnPropertyDescriptor,Tm=(i,e)=>Bc(i,"name",{value:e,configurable:!0}),Dm=(i,e,t,s)=>{for(var n=s>1?void 0:s?Lm(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Bc(e,t,n),n};class zt extends w{constructor(){super(...arguments);r(this,"autoRotate",!1);r(this,"autoRotateSpeed",1);r(this,"enableKeys",!0);r(this,"enableDamping",!0);r(this,"dampingFactor",.1);r(this,"enableZoom",!0);r(this,"minZoom",0);r(this,"maxZoom",1/0);r(this,"enablePan",!0);r(this,"lookAtConstraint",null);r(this,"lookAtConstraint01",1);r(this,"middleClickToFocus",!0);r(this,"doubleClickToFocus",!0);r(this,"debugLog",!1);r(this,"targetLerpSpeed",5);r(this,"targetPosition");r(this,"_controls",null);r(this,"_targetObject",null);r(this,"_lerpToTargetPosition",!1);r(this,"_lerpCameraToTarget",!1);r(this,"_cameraTargetPosition",null);r(this,"_inputs",0);r(this,"_enableTime",0)}get controls(){return this._controls}get controllerObject(){return this._targetObject}onStartInteraction(e){var t;(t=this.controls)==null||t.addEventListener("start",e)}awake(){this.targetPosition=new y}onEnable(){this._enableTime=this.context.time.time;const e=p.getComponent(this.gameObject,F),t=e==null?void 0:e.cam;this._controls||(console.assert(t!=null,"Missing camera",this),t&&(this._targetObject=t),this._controls=new bl(t,this.context.renderer.domElement)),this._controls&&(this._controls.enableDamping=this.enableDamping,this._controls.enableKeys=this.enableKeys,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,(t==null?void 0:t.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom):(this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom),this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan)}onDisable(){this._controls&&(this._controls.enabled=!1,this._controls.autoRotate=!1)}start(){if(this._controls){const e=p.getComponent(this.gameObject,F);if(e&&!this.setFromTargetPosition()){console.log("NO TARGET");const t=new y(0,0,-1).applyMatrix4(e.cam.matrixWorld);this.setTarget(t)}}this.startCoroutine(this.startRaycastDelayed())}*startRaycastDelayed(){if(yield,!this.setFromTargetPosition()){const e=new je;e.screenPoint=new z(0,0),e.lineThreshold=.1;const t=this.context.physics.raycast(e);t.length>0&&this.setTarget(t[0].point)}}onBeforeRender(){var t,s;if(!this._controls)return;(this.context.input.getPointerDown(0)||this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2))&&(this._inputs+=1),this._inputs>0&&(this._controls.autoRotate=!1,this._lerpCameraToTarget=!1,this._lerpToTargetPosition=!1),this._inputs=0;let e=this.middleClickToFocus&&this.context.input.getPointerClicked(1);if(e||(e=this.doubleClickToFocus&&this.context.input.getPointerDoubleClicked(0)&&this.context.time.time-this._enableTime>.3),e?this.setTargetFromRaycast():(this.context.input.getPointerDown(0)||this.context.input.mouseWheelChanged)&&(this._lerpToTargetPosition=!1,this._lerpCameraToTarget=!1),this._lerpToTargetPosition||this._lerpCameraToTarget){const n=this.context.time.deltaTime*this.targetLerpSpeed;this._lerpCameraToTarget&&this._cameraTargetPosition&&this._targetObject&&((t=this._targetObject)==null||t.position.lerp(this._cameraTargetPosition,n),this._targetObject.position.distanceTo(this._cameraTargetPosition)<.01&&(this._lerpCameraToTarget=!1)),this._lerpToTargetPosition&&(this.lerpTarget(this.targetPosition,n),this.targetPosition.distanceTo(this._controls.target)<.005&&(this._lerpToTargetPosition=!1))}((s=this.lookAtConstraint)==null?void 0:s.locked)&&this.setFromTargetPosition(0,this.lookAtConstraint01),this._controls&&(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!0,this._controls.update())}setCameraTarget(e){this._lerpCameraToTarget=!0,this._cameraTargetPosition=e==null?void 0:e.clone()}setFromTargetPosition(e=0,t=1){var n;if(!this._controls)return!1;const s=(n=this.lookAtConstraint)==null?void 0:n.sources;if(s&&s.length>0){const o=s[e];if(o)return o.getWorldPosition(this.targetPosition),this.lerpTarget(this.targetPosition,t),!0}return!1}setTarget(e=null){!this._controls||(e!==null&&this.targetPosition.copy(e),this._controls.target.copy(this.targetPosition))}lerpTarget(e,t){!this._controls||this._controls.target.lerp(e,t)}distanceToTarget(e){return this._controls?this._controls.target.distanceTo(e):-1}setTargetFromRaycast(){if(!this.controls)return;const e=this.context.physics.raycast();for(const t of e)if(t.distance>0&&p.isActiveInHierarchy(t.object)){if(this.targetPosition.copy(t.point),this._lerpToTargetPosition=!0,this._cameraTargetPosition=null,this.context.mainCamera){this._lerpCameraToTarget=!0;const s=C(this.context.mainCamera);this._cameraTargetPosition=s.clone().sub(this.controls.target).add(this.targetPosition)}break}}}Tm(zt,"OrbitControls");Dm([g(Ji)],zt.prototype,"lookAtConstraint",2);var Mm=Object.defineProperty,Im=(i,e)=>Mm(i,"name",{value:e,configurable:!0});class Fe extends f{constructor(e,t,s,n){super(e,t,s);r(this,"alpha",1);this.alpha=n}clone(){const e=super.clone();return e.alpha=this.alpha,e}lerp(e,t){const s=e;return s.alpha&&(this.alpha=k.lerp(this.alpha,s.alpha,t)),super.lerp(e,t)}multiply(e){const t=e;return t.alpha&&(this.alpha=this.alpha*t.alpha),super.multiply(e)}}Im(Fe,"RGBAColor");var Uc=Object.defineProperty,jm=Object.getOwnPropertyDescriptor,yo=(i,e)=>Uc(i,"name",{value:e,configurable:!0}),vt=(i,e,t,s)=>{for(var n=s>1?void 0:s?jm(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Uc(e,t,n),n},Nc;(function(i){i[i.Skybox=1]="Skybox",i[i.SolidColor=2]="SolidColor",i[i.Uninitialized=4]="Uninitialized"})(Nc||(Nc={}));const zc=v("debugcam");class F extends w{constructor(){super(...arguments);r(this,"orthographic",!1);r(this,"orthographicSize",5);r(this,"ARBackgroundAlpha",0);r(this,"_nearClipPlane",.1);r(this,"_farClipPlane",1e3);r(this,"_backgroundColor");r(this,"_fov",60);r(this,"_cam",null);r(this,"_clearFlags",2);r(this,"_skybox")}get fieldOfView(){return this._fov}set fieldOfView(e){const t=this._fov!=e;this._fov=e,t&&this._cam&&this._cam instanceof yl&&(this._cam.fov=this._fov,this._cam.updateProjectionMatrix())}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(e){const t=this._nearClipPlane!=e;this._nearClipPlane=e,this._cam&&t&&(this._cam.near=e,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(e){const t=this._farClipPlane!=e;this._farClipPlane=e,this._cam&&t&&(this._cam.far=e,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(e){this._clearFlags=e,this.applyClearFlagsIfIsActiveCamera()}get backgroundColor(){var e;return(e=this._backgroundColor)!=null?e:null}set backgroundColor(e){if(!!e){if(this._backgroundColor)this._backgroundColor.copy(e);else{if(!e.clone)return;this._backgroundColor=e.clone()}this.applyClearFlagsIfIsActiveCamera()}}get cam(){return this.activeAndEnabled&&this.buildCamera(),this._cam}awake(){this.sourceId||console.warn("Camera has no source - the camera should be exported inside a gltf",this.name)}onEnable(){zc&&console.log(this),this.buildCamera(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this),this.applyClearFlagsIfIsActiveCamera()}buildCamera(){if(this._cam)return;const e=this.gameObject.isCamera;let t=null;if(e?t=this.gameObject:t=this.gameObject.children[0],t&&t.isCamera)t.type==="PerspectiveCamera"&&(t.fov=this._fov,t.near=this._nearClipPlane,t.far=this._farClipPlane,t.updateProjectionMatrix());else if(!this.orthographic)t=new yl(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),t.fov=this.fieldOfView;else{const s=this.orthographicSize*100;t=new Af(window.innerWidth/-s,window.innerWidth/s,window.innerHeight/s,window.innerHeight/-s,this._nearClipPlane,this._farClipPlane)}this._cam=t,this.layer===0&&this._cam.layers.enableAll(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(){var e;if(this._cam&&this.context.mainCameraComponent===this)switch(this._clearFlags){case 1:if(this.context.isInXR&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}this.enableSkybox();break;case 2:if(this.backgroundColor){let t=this.backgroundColor.alpha;this.context.isInXR&&(t=(e=this.ARBackgroundAlpha)!=null?e:0),this.context.scene.background=null,this.context.renderer.setClearColor(this.backgroundColor,t)}break;case 4:this.context.scene.background=null,this.context.renderer.setClearColor(0,0);break}}enableSkybox(){this._skybox||(this._skybox=new $c(this)),this._skybox.enable()}}yo(F,"Camera");vt([g()],F.prototype,"fieldOfView",1);vt([g()],F.prototype,"nearClipPlane",1);vt([g()],F.prototype,"farClipPlane",1);vt([g()],F.prototype,"clearFlags",1);vt([g()],F.prototype,"orthographic",2);vt([g()],F.prototype,"orthographicSize",2);vt([g()],F.prototype,"ARBackgroundAlpha",2);vt([g(Fe)],F.prototype,"backgroundColor",1);class $c{constructor(e){r(this,"_camera");r(this,"_skybox");this._camera=e}get context(){var e;return(e=this._camera)==null?void 0:e.context}enable(){this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),this._skybox?(zc&&console.log("Set skybox",this._camera),this._skybox.encoding=si,this._skybox.mapping=Ur,this.context.scene.background=this._skybox):console.warn("Failed to load/find skybox texture",this)}}yo($c,"CameraSkybox");function Wc(i){const e="created/implictly",t=new S;i.add(t);const s=p.addNewComponent(t,F,!1);s.sourceId=e;const n=p.addNewComponent(t,zt,!1);return n.sourceId=e,s}yo(Wc,"createCameraWithOrbitControl");var Fm=Object.defineProperty,Bm=(i,e)=>Fm(i,"name",{value:e,configurable:!0});async function wo(i){}Bm(wo,"post_awake");var Um=Object.defineProperty,Hc=(i,e)=>Um(i,"name",{value:e,configurable:!0});class Nm{get isStateMachineBehaviour(){return!0}}Hc(Nm,"StateMachineBehaviour");class un{constructor(e,t,s,n){r(this,"_name");r(this,"_nameHash");r(this,"_normalizedTime");r(this,"_length");r(this,"_speed");this._name=e.name,this._nameHash=e.hash,this._normalizedTime=t,this._length=s,this._speed=n}get name(){return this._name}get nameHash(){return this._nameHash}get normalizedTime(){return this._normalizedTime}get length(){return this._length}get speed(){return this._speed}}Hc(un,"AnimatorStateInfo");var xt;(function(i){i[i.If=1]="If",i[i.IfNot=2]="IfNot",i[i.Greater=3]="Greater",i[i.Less=4]="Less",i[i.Equals=6]="Equals",i[i.NotEqual=7]="NotEqual"})(xt||(xt={}));var vo;(function(i){i[i.Float=1]="Float",i[i.Int=3]="Int",i[i.Bool=4]="Bool",i[i.Trigger=9]="Trigger"})(vo||(vo={}));var zm=Object.defineProperty,$m=(i,e)=>zm(i,"name",{value:e,configurable:!0});class Gc{constructor(){r(this,"_types",{})}add(e,t){const s=this._types[e];s===void 0?this._types[e]=t:s!==t&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",e)}get(e){return this._types[e]}}$m(Gc,"_TypeStore");const m=new Gc,Zi=v("gizmos"),ve=v("debugextension");var Wm=Object.defineProperty,Ki=(i,e)=>Wm(i,"name",{value:e,configurable:!0});const fn=v("debugresolvedependencies"),Hm=[{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function pn(i,e){fn&&console.log(i,e);const t=[];mn(Hm,i,e,t);const s=await Promise.all(t);return typeof e=="string"&&s.length===1?s[0]:s}Ki(pn,"resolveReferences");function mn(i,e,t,s){if(typeof t=="object"&&t!==void 0&&t!==null)for(const n of Object.keys(t)){const o=t[n];if(typeof o=="string"){const a=Po(e,o);if(a!==null)typeof a.then=="function"?s.push(a.then(l=>t[n]=l)):t[n]=a;else for(const l of i){const c=gn(l.prefix,o);if(c>=0){fn&&console.log(l,c,l.dependencyName),s.push(e==null?void 0:e.getDependency(l.dependencyName,c).then(h=>(t[n]=h,h)));break}}}else if(Array.isArray(o))for(let a=0;a<o.length;a++){const l=o[a],c=Po(e,l);if(c!==null){typeof c.then=="function"?s.push(c.then(h=>o[a]=h)):o[a]=c;continue}for(const h of i){const d=gn(h.prefix,l);if(d>=0){fn&&console.log(h,d,h.dependencyName),s.push(e==null?void 0:e.getDependency(h.dependencyName,d).then(u=>o[a]=u));break}}typeof l=="object"&&mn(i,e,l,s)}else typeof o=="object"&&mn(i,e,o,s)}else typeof t=="string"&&Vc(i,e,t,s)}Ki(mn,"internalResolve");const xo="extensions/";function Po(i,e){if(i&&i.plugins&&typeof e=="string"&&e.startsWith(xo)){let t=e.substring(xo.length);const s=t.indexOf("/");s>=0&&(t=t.substring(0,s));const n=i.plugins[t];if(ve&&console.log(t,n),typeof(n==null?void 0:n.resolve)=="function"){const o=e.substring(xo.length+t.length+1);return n.resolve(i,o)}}return null}Ki(Po,"resolveExtension");function Vc(i,e,t,s){for(const n of i){const o=gn(n.prefix,t);if(o>=0)return fn&&console.log(n,o,n.dependencyName),s.push(e==null?void 0:e.getDependency(n.dependencyName,o).then(a=>a)),!0}return!1}Ki(Vc,"tryResolveDependency");function gn(i,e){if(typeof e=="string"&&e.startsWith(i)){const t=e.substring(i.length),s=Number.parseInt(t);if(s>=0)return s}return-1}Ki(gn,"tryGetIndex");var Gm=Object.defineProperty,qc=(i,e)=>Gm(i,"name",{value:e,configurable:!0});const Oo="NEEDLE_persistent_assets";function Xc(i){return(i==null?void 0:i.___persistentAsset)===!0}qc(Xc,"isPersistentAsset");class Qc{constructor(e){r(this,"parser");this.parser=e}get name(){return Oo}async afterRoot(e){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)==null?void 0:o.extensions))return;const t=this.parser.json.extensions[Oo];if(!t)return;ve&&console.log(t);const s=new Array;for(const a of t==null?void 0:t.assets){const l=pn(this.parser,a);l&&s.push(l)}await Promise.all(s)}resolve(e,t){const s=Number.parseInt(t);if(s>=0){ve&&console.log(t);const n=e.json.extensions[Oo];if(n){const o=n==null?void 0:n.assets[s];return typeof o=="object"&&o&&(o.___persistentAsset=!0),o}}return null}}qc(Qc,"NEEDLE_persistent_assets");var Vm=Object.defineProperty,fe=(i,e)=>Vm(i,"name",{value:e,configurable:!0});const $t=v("debugserializer");class Yc{constructor(){r(this,"typeMap",{})}register(e,t){if(this.typeMap[e]!==void 0){if(this.typeMap[e]===t)return;console.warn("Type "+e+" is already registered",t,this.typeMap[e])}$t&&console.log("Register type serializer for "+e,t),this.typeMap[e]=t}getSerializer(e){if(!!e)return this.typeMap[e]}getSerializerForConstructor(e,t=0){var c,h,d,u;if(t>20)return;if(!e||!e.constructor){$t&&console.log("invalid type");return}const s=(h=e.name)!=null?h:(c=e.constructor)==null?void 0:c.name;if(!s){$t&&console.log("invalid name",s);return}const n=this.getSerializer(s);if(n!==void 0)return $t&&console.log("FOUND "+s,e.name,e.constructor.name,n,this.typeMap),n;let o=Object.getPrototypeOf(e);if(!(o.prototype||o.constructor)){$t&&console.warn("No prototype for "+s,e,e.name,e.prototype,e.constructor.name);return}const l=(d=o.prototype)!=null?d:o.constructor;if(l!==e){const _=this.getSerializerForConstructor(l,++t);if(_){$t&&console.log("FOUND "+l.constructor.name,l.name,l,_);const b=(u=l.name)!=null?u:l.constructor.name;b==="Function"?console.error("Registering Function is not allowed, something went wrong",e,l,_):this.register(b,_)}return _}}}fe(Yc,"SerializationHelper");const _n=new Yc;class ci{constructor(e){if(Array.isArray(e))for(const t of e)_n.register(t.name,this);else _n.register(e.name,this)}}fe(ci,"TypeSerializer");class Co{constructor(e){r(this,"root");r(this,"gltf");r(this,"gltfId");r(this,"object");r(this,"target");r(this,"nodeId");r(this,"nodeToObject");r(this,"objectToNode");r(this,"context");r(this,"path");this.root=e}}fe(Co,"SerializationContext");function Jc(i,e){const t=i.$serializedTypes;if(t===void 0)return null;const s={};for(const n in t){let o=i[n];if(o!=null&&typeof o=="object"){const a=_n.getSerializerForConstructor(o);if(a){s[n]=a.onSerialize(o,e);continue}}s[n]=o}return s.name=i.constructor.name,typeof i.guid=="string"&&(s.guid=i.guid),s}fe(Jc,"serializeObject");const bn=[];function So(i,e){if(!i)return e;typeof i.$serializedTypes=="object"&&(e||(e={}),Object.assign(e,i.$serializedTypes));const t=Object.getPrototypeOf(i);return So(t,e)}fe(So,"collectSerializedTypesInBaseTypes");function yn(i,e,t){if(!i)return!1;if(t.target=i,i.onBeforeDeserialize!==void 0){const n=i.onBeforeDeserialize(e,t);if(typeof n=="boolean")return n}const s=So(i);if(e){if(typeof e.guid=="string"&&(i.guid=e.guid),s)for(const n in s){const o=s[n],a=e[n];if(t.path=n,o===null)i[n]=a;else{let l=function(c){const d=c.type;return d?wn(a,d,t,void 0,i[n]):wn(a,c,t,void 0,i[n])};if(fe(l,"tryResolve"),i.onBeforeDeserializeMember!==void 0&&i.onBeforeDeserializeMember(n,a,t)===!0)continue;if(Array.isArray(o))for(let c=0;c<o.length;c++){const h=o[c],d=l(h);if(d!==void 0||c===o.length-1){i[n]=d;break}}else i[n]=l(o);bn.length=0,i.onAfterDeserializeMember!==void 0&&i.onAfterDeserializeMember(n,a,t)}}Zc(i,e)}return i.onAfterDeserialize!==void 0&&i.onAfterDeserialize(e,t),t.path=void 0,!0}fe(yn,"deserializeObject");function Zc(i,e){for(const s of Object.keys(e)){const n=e[s];if(typeof n=="object"&&n!==null&&n!==void 0){const o=i[s];if(!o){$t&&console.log(s,"is undefined on",i);continue}for(const a of Object.keys(n))o[a]===void 0&&t(n[a])&&!t(o)&&(o[a]=n[a])}}function t(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}fe(t,"isPrimitiveType")}fe(Zc,"implictlyAssignPrimitiveTypes");function wn(i,e,t,s,n){if(n instanceof e)return n;if(n&&typeof n=="object"&&Xc(n)){const c=n;return!c.$serializedTypes&&e.prototype.$serializedTypes&&(c.$serializedTypes=e.prototype.$serializedTypes),c.$serializedTypes&&yn(c,i,t),n}if(s||(s={serializer:_n.getSerializerForConstructor(e)}),Array.isArray(i)){const c=[];for(let h=0;h<i.length;h++){const d=wn(i[h],e,t,s,i[h]);c.push(d)}return c}const o=s.serializer;if(o)return o.onDeserialize(i,t);const a=new e(...Kc(i)),l=a;return l.$serializedTypes&&yn(l,i,t),a}fe(wn,"deserializeObjectWithType");function Kc(i){if(bn.length=0,typeof i=="object"&&i!==null&&i!==void 0)for(const e of Object.keys(i))bn.push(i[e]);return bn}fe(Kc,"setBuffer");function Ro(i,e){if(e!=null&&i!=null)for(const t of Object.keys(e)){const s=eh(i,t);(!s||s.writable===!0||(s==null?void 0:s.set)!==void 0)&&(i[t]=e[t])}}fe(Ro,"assign");function eh(i,e){let t;do t=Object.getOwnPropertyDescriptor(i,e);while(!t&&(i=Object.getPrototypeOf(i)));return t}fe(eh,"getPropertyDescriptor");var qm=Object.defineProperty,Xm=(i,e)=>qm(i,"name",{value:e,configurable:!0});const Wt=v("debuganimatorcontroller");class Ht{constructor(e){r(this,"normalizedStartOffset",0);r(this,"_speed",1);r(this,"animator");r(this,"model");r(this,"_mixer");r(this,"_activeState");r(this,"_activeStates",[]);r(this,"animationRoot",null);r(this,"lastPosition");r(this,"lastRotation");r(this,"startPosition",null);r(this,"startRotation",null);r(this,"lastTime",0);r(this,"tempRot",new P);r(this,"tempRot2",new P);r(this,"tempPos",new y);r(this,"tempPos2",new y);r(this,"rootMotionBone",new S);this.model=e,Wt&&console.log(this)}Play(e,t=-1,s=Number.NEGATIVE_INFINITY,n=0){if(t<0)t=0;else if(t>=this.model.layers.length){console.warn("invalid layer");return}const a=this.model.layers[t].stateMachine;for(const l of a.states)if(l.name===e||l.hash===e){Wt&&console.log("transition to ",l),this.transitionTo(l,n,s);return}console.warn("Could not find "+e+" to play")}Reset(){this.setStartTransition()}SetBool(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetBool(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:!1}SetFloat(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetFloat(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:0}SetInteger(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetInteger(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:0}SetTrigger(e){var s;Wt&&console.log("SET TRIGGER",e);const t=typeof e=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[t]===e).forEach(n=>n.value=!0)}ResetTrigger(e){var s;const t=typeof e=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[t]===e).forEach(n=>n.value=!1)}IsInTransition(){return this._activeStates.length>1}SetSpeed(e){this._speed=e}FindState(e){if(!e)return null;for(const t of this.model.layers)for(const s of t.stateMachine.states)if(s.name===e)return s;return null}get context(){var e;return(e=this.animator)==null?void 0:e.context}applyRootMotion(e){this.internalApplyRootMotion(e)}bind(e){this.animator=e,this._mixer=new Nr(this.animator.gameObject),this.createActions()}clone(){const e=Vs(this.model,(s,n,o)=>{var a;return o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||((a=o==null?void 0:o.constructor)==null?void 0:a.name)==="AnimationAction"||o.tracks!==void 0)});return console.assert(e!==this.model),new Ht(e)}update(){if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates();const e=this.animator.context.time.deltaTime;this._mixer.update(e)}updateActiveStates(){for(let e=0;e<this._activeStates.length;e++){const t=this._activeStates[e],s=t.motion;if(!s.action)this._activeStates.splice(e,1),e--;else{const n=s.action;n.getEffectiveWeight()<=0&&!n.isRunning()&&(Wt&&console.debug("REMOVE",t.name,n.getEffectiveWeight(),n.isRunning(),n.isScheduled()),this._activeStates.splice(e,1),e--)}}}setStartTransition(){for(const e of this.model.layers){const t=e.stateMachine,s=t.states[t.defaultState];this.transitionTo(s,0,this.normalizedStartOffset)}}evaluateTransitions(){var o;let e=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;e=!0}const t=this._activeState,s=t.motion.action;for(const a of t.transitions){if(!a.hasExitTime&&a.conditions.length<=0)continue;let l=!0;for(const c of a.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(!!l){Wt&&l&&console.log("All conditions are met",a.conditions);for(const c of a.conditions){const h=this.model.parameters.find(d=>d.name===c.parameter);(h==null?void 0:h.type)===vo.Trigger&&(h.value=!1)}if(s){const c=t.motion.clip.duration,h=c<=0?1:s.time/c;if(!a.hasExitTime||h>=a.exitTime&&s.time>=s.getClip().duration){s.clampWhenFinished=!0,Wt&&(console.log("transition to "+a.destinationState,a),console.log(s.time,a.exitTime)),this.transitionTo(a.destinationState,a.duration,a.offset);return}}}}let n=!1;if(t.motion.isLooping&&s&&s.time>=s.getClip().duration&&(n=!0,s.reset(),s.time=0,s.play()),!n&&t&&!e&&s&&this.animator&&t.behaviours){const a=s==null?void 0:s.getClip().duration,l=s.time/a,c=new un(this._activeState,l,a,this._speed);for(const h of t.behaviours)h.instance&&((o=h.instance.onStateUpdate)==null||o.call(h,this.animator,c,0))}}transitionTo(e,t,s){var h,d,u,_,b,x,O,R;if(!this.animator)return;const n=0;if(typeof e=="number"&&(e==-1&&(e=this.model.layers[n].stateMachine.defaultState),e=this.model.layers[n].stateMachine.states[e]),!(e==null?void 0:e.motion)||!e.motion.clip)return;const o=this._activeState===e;if(o){const M=e.motion;!M.action_loopback&&M.clip&&(this._mixer.uncacheAction(M.clip,this.animator.gameObject),M.action_loopback=this._mixer.clipAction(M.clip))}if(((h=this._activeState)==null?void 0:h.behaviours)&&this._activeState.motion.action){const M=(d=this._activeState)==null?void 0:d.motion.clip.duration,ce=this._activeState.motion.action.time/M,B=new un(this._activeState,ce,M,this._speed);for(const L of this._activeState.behaviours)(_=(u=L.instance)==null?void 0:u.onStateExit)==null||_.call(L,this.animator,B,n)}const a=(b=this._activeState)==null?void 0:b.motion.action;a&&a.fadeOut(t),o&&(e.motion.action=e.motion.action_loopback,e.motion.action_loopback=a);const l=this._activeState;this._activeState=e;const c=(x=e.motion)==null?void 0:x.action;if(c){s=Math.max(0,Math.min(1,s)),c.isRunning()&&c.stop(),c.reset(),c.timeScale=this._speed,c.enabled=!0;const M=e.motion.clip.duration;if(c.time=s*M,c.clampWhenFinished=!0,c.setLoop(wl,0),t>0?c.fadeIn(t):c.setEffectiveWeight(1),c.play(),this._activeStates.includes(e)||this._activeStates.push(e),this._activeState.behaviours){const ce=new un(e,s,M,this._speed);for(const B of this._activeState.behaviours)(R=(O=B.instance)==null?void 0:O.onStateEnter)==null||R.call(B,this.animator,ce,n)}}else console.warn("No action",e.motion,this);Wt&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+e.name,a,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}evaluateCondition(e){const t=this.model.parameters.find(s=>s.name===e.parameter);if(!t)return!1;switch(e.mode){case xt.If:return t.value===!0;case xt.IfNot:return t.value===!1;case xt.Greater:return t.value>e.threshold;case xt.Less:return t.value<e.threshold;case xt.Equals:return t.value===e.threshold;case xt.NotEqual:return t.value!==e.threshold}return!1}createActions(){var e,t;for(const s of this.model.layers){const n=s.stateMachine;for(let o=0;o<n.states.length;o++){const a=n.states[o];if(!!a.motion){if(this.animator&&a.motion.clips){const l=(e=a.motion.clips)==null?void 0:e.find(c=>{var h,d;return c.node.name===((d=(h=this.animator)==null?void 0:h.gameObject)==null?void 0:d.name)});a.motion.clip=l==null?void 0:l.clip}if((t=a.motion)==null?void 0:t.clip){const l=this._mixer.clipAction(a.motion.clip);a.motion.action=l}if(a.behaviours&&Array.isArray(a.behaviours))for(const l of a.behaviours){if(!(l==null?void 0:l.typeName))continue;const c=m.get(l.typeName),h=new c;h.isStateMachineBehaviour&&(Ro(h,l.properties),l.instance=h)}}}}}*enumerateActions(){for(const e of this.model.layers){const t=e.stateMachine;for(let s=0;s<t.states.length;s++){const n=t.states[s];(n==null?void 0:n.motion)&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}internalApplyRootMotion(e){if(!this.animationRoot)if(this.animationRoot=this.findRootBone(e),!this.animationRoot&&e.children.length>0&&(this.animationRoot=e.children[0]),this.animationRoot){console.log(this.animationRoot),this.startPosition=this.animationRoot.position.clone(),this.lastPosition=this.startPosition.clone(),this.startRotation=this.animationRoot.quaternion.clone(),this.lastRotation=this.startRotation.clone(),this.animationRoot.add(new Ni);const n=this.animationRoot.parent;this.rootMotionBone.position.copy(this.animationRoot.position),this.rootMotionBone.add(this.animationRoot),n==null||n.add(this.rootMotionBone),this.rootMotionBone.add(new Ni)}else return;const t=this.animationRoot.quaternion,s=this.tempPos.copy(this.animationRoot.position);e=this.rootMotionBone;for(const n of this._activeStates){const o=n.motion.action;if(!o)continue;if(o.time<this.lastTime){this.lastTime=o.time,this.lastPosition.copy(this.animationRoot.position),this.lastRotation.copy(this.animationRoot.quaternion);break}this.lastTime=o.time;const a=this.tempRot2.multiplyQuaternions(this.tempRot.copy(t),this.lastRotation.invert()),l=this.tempPos2.copy(s).sub(this.lastPosition);l.applyQuaternion(e.quaternion),l.multiplyScalar(o.getEffectiveWeight()),e.position.add(l),e.quaternion.multiplyQuaternions(e.quaternion,a);break}this.lastPosition.copy(s),this.lastRotation.copy(t),this.animationRoot.position.set(0,0,0),this.animationRoot.quaternion.identity()}findRootBone(e){if(this.animationRoot)return this.animationRoot;if(e.type==="Bone")return this.animationRoot=e,this.animationRoot;if(e.children)for(const t of e.children){const s=this.findRootBone(t);if(s)return s}return null}}Xm(Ht,"AnimatorController");var th=Object.defineProperty,Qm=Object.getOwnPropertyDescriptor,Ym=(i,e)=>th(i,"name",{value:e,configurable:!0}),vn=(i,e,t,s)=>{for(var n=s>1?void 0:s?Qm(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&th(e,t,n),n};const Jm=v("debuganimator");class tt extends w{constructor(){super(...arguments);r(this,"applyRootMotion",!1);r(this,"hasRootMotion",!1);r(this,"keepAnimatorControllerStateOnDisable",!1);r(this,"speed",1);r(this,"normalizedStartOffset",0);r(this,"_animatorController",null)}set runtimeAnimatorController(e){this._animatorController&&this._animatorController.model===e||(e?e instanceof Ht?this._animatorController=e:this._animatorController=new Ht(e):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}Play(e,t=-1,s=Number.NEGATIVE_INFINITY,n=0){var o;(o=this.runtimeAnimatorController)==null||o.Play(e,t,s,n)}Reset(){var e;(e=this._animatorController)==null||e.Reset()}SetBool(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetBool(e,t)}GetBool(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetBool(e))!=null?s:!1}SetFloat(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetFloat(e,t)}GetFloat(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetFloat(e))!=null?s:-1}SetInteger(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetInteger(e,t)}GetInteger(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetInteger(e))!=null?s:-1}SetTrigger(e){var t;(t=this.runtimeAnimatorController)==null||t.SetTrigger(e)}ResetTrigger(e){var t;(t=this.runtimeAnimatorController)==null||t.ResetTrigger(e)}IsInTransition(){var e,t;return(t=(e=this.runtimeAnimatorController)==null?void 0:e.IsInTransition())!=null?t:!1}SetSpeed(e){var t;e!==this.speed&&(this.speed=e,(t=this._animatorController)==null||t.SetSpeed(e))}set minMaxSpeed(e){this.speed=k.lerp(e.x,e.y,Math.random())}set minMaxOffsetNormalized(e){this.normalizedStartOffset=k.lerp(e.x,e.y,Math.random()),this.runtimeAnimatorController&&(this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset)}awake(){if(!!this.gameObject){if(this.runtimeAnimatorController){const e=this.runtimeAnimatorController.clone();console.assert(this.runtimeAnimatorController!==e),this.runtimeAnimatorController=e,console.assert(this.runtimeAnimatorController===e),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.SetSpeed(this.speed),this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset}Jm&&console.log(this.name,this)}}onDisable(){var e;this.keepAnimatorControllerStateOnDisable||(e=this._animatorController)==null||e.Reset()}onBeforeRender(){var e;this._animatorController&&(this._animatorController.update(),this.applyRootMotion&&((e=this._animatorController)==null||e.applyRootMotion(this.gameObject)))}}Ym(tt,"Animator");vn([g()],tt.prototype,"applyRootMotion",2);vn([g()],tt.prototype,"hasRootMotion",2);vn([g()],tt.prototype,"keepAnimatorControllerStateOnDisable",2);vn([g()],tt.prototype,"runtimeAnimatorController",1);var ih=Object.defineProperty,Zm=Object.getOwnPropertyDescriptor,sh=(i,e)=>ih(i,"name",{value:e,configurable:!0}),nh=(i,e,t,s)=>{for(var n=s>1?void 0:s?Zm(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&ih(e,t,n),n};class Pt extends w{constructor(){super(...arguments);r(this,"playAutomatically",!0);r(this,"randomStartTime",!0);r(this,"_tempAnimationClipBeforeGameObjectExisted",null);r(this,"mixer");r(this,"_actions",[]);r(this,"_currentActions",[]);r(this,"_handles",[]);r(this,"_didInit",!1)}get clip(){var e;return((e=this.animations)==null?void 0:e.length)?this.animations[0]:null}set clip(e){if(!this.gameObject){this._tempAnimationClipBeforeGameObjectExisted=e;return}!e||(this.gameObject.animations||(this.gameObject.animations=[]),this.gameObject.animations.push(e))}set animations(e){this.gameObject.animations=e}get animations(){return this.gameObject.animations}get currentAction(){return this._currentActions[0]}get currentActions(){return this._currentActions}get actions(){return this._actions}set actions(e){this._actions=e}awake(){this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.playAutomatically&&this.init()}onEnable(){if(this.playAutomatically&&this.actions.length>0&&this.currentActions.length<=0){const e=Math.floor(Math.random()*this.actions.length);this.play(e)}}start(){this.randomStartTime&&this.currentAction&&(this.currentAction.time=Math.random()*this.currentAction.getClip().duration)}update(){var e;if(!!this.mixer){this.mixer.update(this.context.time.deltaTime);for(const t of this._handles)t._update();((e=this._handles)==null?void 0:e.length)>0&&re.markDirty(this.gameObject)}}getAction(e){var t;return(t=this.actions)==null?void 0:t.find(s=>s.getClip().name===e)}play(e,t){if(this.init(),!this.mixer)return;let s=e;if(typeof e=="number"){if(e>=this.animations.length)return;s=this.animations[e]}else typeof e=="string"&&(s=this.animations.find(o=>o.name===e));if(!s){console.error("Could not find clip",e);return}for(const o of this.actions)if(o.getClip()===s)return this.internalOnPlay(o,t);const n=this.mixer.clipAction(s);return this.actions.push(n),this.internalOnPlay(n,t)}internalOnPlay(e,t){var a;var s=this.currentAction;if(s===e&&s.isRunning()&&s.time<s.getClip().duration){const l=this.tryFindHandle(e);if(l)return l.getPromise()}const n=(a=t==null?void 0:t.exclusive)!=null?a:!0;(t==null?void 0:t.fadeDuration)?(n&&(s==null||s.fadeOut(t.fadeDuration)),e.fadeIn(t.fadeDuration)):n&&(s==null||s.stop()),e.reset(),e.enabled=!0,e.time=0,e.timeScale=1,(t==null?void 0:t.clampWhenFinished)&&(e.clampWhenFinished=!0),(t==null?void 0:t.startTime)!==void 0&&(e.time=t.startTime),(t==null?void 0:t.loop)!==void 0&&(e.loop=t.loop?kf:wl),e.play();const o=new rh(e,this.mixer,t,l=>{this._handles.splice(this._handles.indexOf(o),1)});return this._handles.push(o),o.getPromise()}tryFindHandle(e){for(const t of this._handles)if(t.action===e)return t}init(){if(!this._didInit&&(this._didInit=!0,!!this.gameObject)){this.actions=[],this.mixer=new Nr(this.gameObject);for(let e=0;e<this.animations.length;e++){const t=this.mixer.clipAction(this.animations[e]);this.actions.push(t)}}}}sh(Pt,"Animation");nh([g()],Pt.prototype,"playAutomatically",2);nh([g()],Pt.prototype,"randomStartTime",2);class rh{constructor(e,t,s,n){r(this,"mixer");r(this,"action");r(this,"promise",null);r(this,"resolve",null);r(this,"reject",null);r(this,"_options");r(this,"_resolveCallback",null);r(this,"_rejectCallback",null);r(this,"_loopCallback");r(this,"_finishedCallback");r(this,"_resolvedOrRejectedCallback");this.action=e,this.mixer=t,this._resolvedOrRejectedCallback=n,this._options=s}getPromise(){return this.promise?this.promise:(this.promise=new Promise((e,t)=>{this._resolveCallback=e,this._rejectCallback=t,this.resolve=this.onResolve.bind(this),this.reject=this.onReject.bind(this)}),this._loopCallback=this.onLoop.bind(this),this._finishedCallback=this.onFinished.bind(this),this.mixer.addEventListener("loop",this._loopCallback),this.mixer.addEventListener("finished",this._finishedCallback),this.promise)}_update(){var e;!this._options||this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=(e=this._options.startTime)!=null?e:0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var e,t;this.dispose(),(e=this._resolvedOrRejectedCallback)==null||e.call(this,this),(t=this._resolveCallback)==null||t.call(this,this.action)}onReject(e){var t,s;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(s=this._rejectCallback)==null||s.call(this,e)}onLoop(e){}onFinished(e){e.action===this.action&&this.onResolve()}dispose(){this._loopCallback&&this.mixer.removeEventListener("loop",this._loopCallback),this._finishedCallback&&this.mixer.removeEventListener("finished",this._finishedCallback),this._loopCallback=void 0,this._finishedCallback=void 0}}sh(rh,"AnimationHandle");var Km=Object.defineProperty,eg=(i,e)=>Km(i,"name",{value:e,configurable:!0});class Eo extends w{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"width",0);r(this,"centered",!0);r(this,"_centerPos")}awake(){this._centerPos=new y}update(){if(!this.from||!this.to)return;const e=C(this.from).clone(),t=C(this.to).clone(),s=e.distanceTo(t);this._centerPos.copy(e),this._centerPos.add(t),this._centerPos.multiplyScalar(.5),D(this.gameObject,this.centered?this._centerPos:e),this.gameObject.lookAt(C(this.to).clone()),this.gameObject.scale.set(this.width,this.width,s)}}eg(Eo,"AlignmentConstraint");var oh=Object.defineProperty,tg=Object.getOwnPropertyDescriptor,ah=(i,e)=>oh(i,"name",{value:e,configurable:!0}),Ot=(i,e,t,s)=>{for(var n=s>1?void 0:s?tg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&oh(e,t,n),n};class it{constructor(){r(this,"time");r(this,"value");r(this,"inTangent");r(this,"inWeight");r(this,"outTangent");r(this,"outWeight");r(this,"weightedMode")}}ah(it,"Keyframe");Ot([g()],it.prototype,"time",2);Ot([g()],it.prototype,"value",2);Ot([g()],it.prototype,"inTangent",2);Ot([g()],it.prototype,"inWeight",2);Ot([g()],it.prototype,"outTangent",2);Ot([g()],it.prototype,"outWeight",2);Ot([g()],it.prototype,"weightedMode",2);class xn{constructor(){r(this,"keys")}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(e){if(!this.keys||this.keys.length==0)return 0;let t=null;for(const s of this.keys){if(t&&s.time>e&&e>t.time)return k.lerp(t.value,s.value,(e-t.time)/(s.time-t.time));t=s}return this.keys[this.keys.length-1].value}}ah(xn,"AnimationCurve");Ot([g(it)],xn.prototype,"keys",2);var lh=Object.defineProperty,ig=Object.getOwnPropertyDescriptor,ch=(i,e)=>lh(i,"name",{value:e,configurable:!0}),Ct=(i,e,t,s)=>{for(var n=s>1?void 0:s?ig(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&lh(e,t,n),n};const Be=v("debugaudio");var hh;(function(i){i[i.Logarithmic=0]="Logarithmic",i[i.Linear=1]="Linear",i[i.Custom=2]="Custom"})(hh||(hh={}));var Fs;const oe=(Fs=class extends w{constructor(){super(...arguments);r(this,"clip","");r(this,"playOnAwake",!1);r(this,"spatialBlend",0);r(this,"minDistance",1);r(this,"maxDistance",100);r(this,"volume",1);r(this,"rollOffMode",0);r(this,"_loop",!1);r(this,"sound",null);r(this,"helper",null);r(this,"wasPlaying",!1);r(this,"audioLoader",null);r(this,"shouldPlay",!1);r(this,"_lastClipStartedLoading",null);r(this,"lerp",(i,e,t)=>i*(1-t)+e*t);r(this,"_lastContextTime",0);r(this,"_hasEnded",!0)}static get userInteractionRegistered(){return oe._didCallBeginWaitForUserInteraction||(oe._didCallBeginWaitForUserInteraction=!0,oe._beginWaitForUserInteraction()),oe._userInteractionRegistered}static registerWaitForAllowAudio(i){if(i!==null){if(this._userInteractionRegistered){i();return}this.callbacks.indexOf(i)===-1&&this.callbacks.push(i),oe._didCallBeginWaitForUserInteraction||(oe._didCallBeginWaitForUserInteraction=!0,oe._beginWaitForUserInteraction())}}static _beginWaitForUserInteraction(i=null){i!==null&&this.registerWaitForAllowAudio(i);let t=ch(()=>{if(t!=null&&!oe._userInteractionRegistered){oe._userInteractionRegistered=!0,console.log("registered interaction, can play audio now"),document.removeEventListener("pointerdown",t),document.removeEventListener("click",t),document.removeEventListener("dragstart",t),document.removeEventListener("touchstart",t);for(const s of this.callbacks)s();this.callbacks.length=0}},"callback").bind(this);document.addEventListener("pointerdown",t),document.addEventListener("click",t),document.addEventListener("dragstart",t),document.addEventListener("touchstart",t)}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(i){this._loop=i,this.sound&&this.sound.setLoop(i)}get Sound(){var i;if(!this.sound&&oe._userInteractionRegistered){const e=(i=p.getComponent(this.context.mainCamera,hi))!=null?i:p.findObjectOfType(hi,this.context);(e==null?void 0:e.listener)&&(this.sound=new Lf(e.listener),this.gameObject.add(this.sound))}return this.sound}get ShouldPlay(){return this.shouldPlay}awake(){this.audioLoader=new zr,this.playOnAwake&&(this.shouldPlay=!0),window.addEventListener("visibilitychange",i=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this.isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}})}onEnable(){oe._beginWaitForUserInteraction(()=>{this.enabled&&!this.destroyed&&this.loadAndPlay(this.clip)})}onLoaded(i){Be&&console.log("audio buffer loaded"),oe.registerWaitForAllowAudio(()=>{Be&&console.log("finished loading",i);const e=this.Sound;if(!e){console.warn("Failed getting sound",this.name);return}e.isPlaying&&e.stop(),e.setBuffer(i),e.loop=this.loop,e.setVolume(this.volume),e.autoplay=this.shouldPlay;const t=this.lerp(1e3,this.minDistance,this.spatialBlend);switch(Be&&console.log("Ref distance= "+t),e.setRefDistance(t),e.setMaxDistance(this.maxDistance),this.rollOffMode){case 0:e.setDistanceModel("linear");break;case 1:e.setDistanceModel("exponential");break}e.isPlaying&&e.stop(),this.spatialBlend>0&&Be&&!this.helper&&(console.log(this),this.helper=new Tf(e,e.getRefDistance()),e.add(this.helper)),this.shouldPlay&&oe._userInteractionRegistered&&this.play()})}loadAndPlay(i){if(this.clip=i,this.clip&&(Be&&console.log(this.clip),this.clip.endsWith(".mp3")||this.clip.endsWith(".wav"))){if(this.audioLoader||(this.audioLoader=new zr),this.shouldPlay=!0,this._lastClipStartedLoading===this.clip)return;this._lastClipStartedLoading=this.clip,Be&&console.log("load audio",this.clip),this.audioLoader.load(this.clip,this.onLoaded.bind(this),()=>{},console.error)}}play(i=void 0){if(i&&i!==this.clip){this.loadAndPlay(i);return}this.shouldPlay=!0,this._hasEnded=!1,Be&&console.log("play",this),this.sound&&!this.sound.isPlaying&&(Be&&console.log("start playing",this.sound.getVolume(),this.sound),this.sound.play())}pause(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,this.sound.pause())}stop(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,Be&&console.log(this._lastContextTime),this.sound.stop())}get isPlaying(){var i,e;return(e=(i=this.sound)==null?void 0:i.isPlaying)!=null?e:!1}set isPlaying(i){}get time(){var i,e;return((i=this.sound)==null?void 0:i.source)?((e=this.sound.source)==null?void 0:e.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(i){if(this.sound){if(i===this.sound.offset)return;const e=this.isPlaying;this.stop(),this.sound.offset=i,e&&this.play()}}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,Be&&console.log("Audio clip ended",this.clip),this.sound.dispatchEvent({type:"ended",target:this}))}},r(Fs,"_didCallBeginWaitForUserInteraction",!1),r(Fs,"callbacks",[]),r(Fs,"_userInteractionRegistered",!1),Fs);let te=oe;ch(te,"AudioSource");Ct([g()],te.prototype,"clip",2);Ct([g()],te.prototype,"playOnAwake",2);Ct([g()],te.prototype,"loop",1);Ct([g()],te.prototype,"spatialBlend",2);Ct([g()],te.prototype,"minDistance",2);Ct([g()],te.prototype,"maxDistance",2);Ct([g()],te.prototype,"volume",2);Ct([g()],te.prototype,"rollOffMode",2);var sg=Object.defineProperty,ng=(i,e)=>sg(i,"name",{value:e,configurable:!0});class hi extends w{constructor(){super(...arguments);r(this,"_listener",null)}get listener(){return this._listener==null&&(this._listener=new vl),this._listener}awake(){te.registerWaitForAllowAudio(()=>{const e=this.listener;if(e==null||e.parent)return;const t=p.getComponentInParent(this.gameObject,F);t?t.cam.add(e):this.gameObject.add(e)})}}ng(hi,"AudioListener");var rg=Object.defineProperty,og=(i,e)=>rg(i,"name",{value:e,configurable:!0});let es,ts;function Pn(i,e){es||(es=new Df,es.setDecoderPath("./include/draco/"),es.setDecoderConfig({type:"js"})),ts||(ts=new Mf,ts.setTranscoderPath("./include/ktx2/"),e.renderer&&ts.detectSupport(e.renderer)),i.setDRACOLoader(es),i.setKTX2Loader(ts)}og(Pn,"addDracoAndKTX2Loaders");var ag=Object.defineProperty,is=(i,e)=>ag(i,"name",{value:e,configurable:!0});class Ao{constructor(e,t,s,n){r(this,"success");r(this,"filename");r(this,"hash");r(this,"size");r(this,"url");this.success=e,this.filename=t,this.hash=s,this.size=n}}is(Ao,"Upload_Result");async function dh(i,e){const t=await i.arrayBuffer(),s=ko(t),n=i.name.split(".").pop(),o=s+"."+n,a=i.name.split(".").shift();console.assert(a!==void 0);const l={alias:a,filename:o},h=await(await fetch(e+"/exists",{method:"POST",body:JSON.stringify(l)})).json();if(h.success||console.warn("exists check did fail"),h.exists)return console.log("file already exists",s),new Ao(!0,o,s,i.size);console.log("begin uploading file",a,i.size);const d=new FormData;d.append("file",i);const u={};u.filesize=i.size,a&&(u.alias=a);const b=await(await fetch(e+"/upload/file",{method:"POST",body:d,headers:u})).json();if((b==null?void 0:b.success)===!1)return b.message!==void 0?console.error("Upload failed:",b.message):console.error("Upload failed"),null;console.assert(b.hash_sum===s,"hash sum did not match","received:",b.hash_sum,"expected:",s),b.success&&console.log("successfully uploaded",s,b.id);const x=new Ao(b.success,o,s,i.size);return x.url=e,x}is(dh,"upload_file");function ko(i){return If(new Uint8Array(i))}is(ko,"hash");async function Lo(i,e,t,s,n=!1){try{const o=await fetch(s+"/download/file",{method:"POST",body:i});if(o.status!==200)return console.error("download failed",o),null;const a=await o.blob(),l=await a.arrayBuffer();n||console.assert(a.size===t,"size mismatch","expected:",t,"got:",a.size);const c=ko(l);return n||console.assert(c===e,"hash mismatch, downloaded file is invalid"),a.arrayBuffer()}catch(o){console.error(o)}return null}is(Lo,"download_file");async function uh(i,e){var d;const t=await fetch(i),s=(d=t.body)==null?void 0:d.getReader(),n=t.headers.get("Content-Length"),o=n?parseInt(n):0;if(!s)return null;let a=0,l=[];for(;;){const{done:u,value:_}=await s.read();if(_&&(l.push(_),a+=_.length,e.call(null,new ProgressEvent("progress",{loaded:a,total:o}))),u)break}const c=new Uint8Array(a);let h=0;for(let u of l)c.set(u,h),h+=u.length;return c}is(uh,"download");var lg=Object.defineProperty,To=(i,e)=>lg(i,"name",{value:e,configurable:!0});const ss=v("debugavatar");class On{constructor(e,t,s,n){r(this,"root");r(this,"head");r(this,"leftHand");r(this,"rigthHand");var o;this.root=e,this.head=t,this.leftHand=s,this.rigthHand=n,(o=this.root)==null||o.traverse(a=>a.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}assignRandomColors(){ns.assignRandomPlayerColors(this)}}To(On,"AvatarModel");class ns{constructor(){r(this,"avatarRegistryUrl",null);r(this,"avatarModelCache",new Map)}async getOrCreateNewAvatarInstance(e,t){if(!t)return console.error("Can not create avatar: failed to provide id or root object"),null;let s=null;if(typeof t=="string"){if(s=await this.loadAvatar(e,t),!s){const o=new we;s=p.instantiate(Ft(t,e.scene),o)}}else s=t;if(!s)return null;const n=this.findAvatar(s);return n.assignRandomColors(),n.isValid?(ss&&console.log("[Custom Avatar] valid config",t,ss?n:""),n):(console.warn("[Custom Avatar] config isn't valid",t,ss?n:""),null)}async loadAvatar(e,t){var n;if(console.assert(t!=null&&typeof t=="string","Avatar id must not be null"),t.length<=0||!t)return null;if(ss&&console.log("[Custom Avatar] "+t+", loading..."),t.endsWith(".glb")||(t+=".glb"),this.avatarRegistryUrl===null){const o=await fetch("./"+t);let a=null;if(o.ok){const c=await o.blob();c&&(a=await c.arrayBuffer())}if(!a&&(a=await Lo(t,t,0,"no url here go away",!0),!a))return null;const l=await Is(e,a,null,0);return(n=l==null?void 0:l.scene)!=null?n:null}const s=new $r;return Pn(s,e),new Promise((o,a)=>{const l=this.avatarRegistryUrl+"/"+t;s.load(l,async c=>{await Va(e,l,c),o(c.scene)},c=>{ss&&console.log("[Custom Avatar] "+c.loaded/c.total*100+"% loaded of "+c.total/1024+"kB")},c=>{console.error("[Custom Avatar] Error when loading: "+c),o(null)})})}cacheModel(e,t){}findAvatar(e){const t=e;let s=t;s.children.length==1&&(s=e.children[0]);let n=this.findAvatarPart(s,"head");const o=this.findAvatarPart(s,"left"),a=this.findAvatarPart(s,"right");if(!n){n=t;let c=new y;new ii().setFromObject(n).getSize(c);let h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&n.scale.multiplyScalar(1/h*.3)}return new On(t,n,o,a)}findAvatarPart(e,t){for(let s of e.children)if(s.name.toLowerCase().indexOf(t)>-1)return s;return null}handleCustomAvatarErrors(e){if(!e.ok)throw Error(e.statusText);return e}static assignRandomPlayerColors(e){const t=new Map;function s(n){if(n.type==="Mesh"){const o=n,a=o.material;if(a&&a.name){if(t.has(a.uuid)){const l=t.get(a.uuid);l&&(o.material=l);return}if(a.name.endsWith("_playercolor")||a.name.endsWith("_player_color2")){const l=a.uuid;o.material=a.clone(),o.material.color=new f(Math.random(),Math.random(),Math.random()),t.set(l,o.material)}}}}To(s,"findPlayerColorMeshesAndAssignColors"),e.head&&e.head.traverse(s),e.leftHand&&e.leftHand.traverse(s),e.rigthHand&&e.rigthHand.traverse(s)}}To(ns,"AvatarLoader");var fh=Object.defineProperty,cg=Object.getOwnPropertyDescriptor,hg=(i,e)=>fh(i,"name",{value:e,configurable:!0}),Do=(i,e,t,s)=>{for(var n=s>1?void 0:s?cg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&fh(e,t,n),n};class di extends w{constructor(){super(...arguments);r(this,"length",1);r(this,"depthTest",!0);r(this,"isGizmo",!0);r(this,"_axes",null)}onEnable(){if(this.isGizmo&&!Zi)return;this._axes||(this._axes=new Ni(this.length)),this.gameObject.add(this._axes);const e=this._axes.material;e&&e.depthTest!==void 0&&(e.depthTest=this.depthTest)}onDisable(){!this._axes||this.gameObject.remove(this._axes)}}hg(di,"AxesHelper");Do([g()],di.prototype,"length",2);Do([g()],di.prototype,"depthTest",2);Do([g()],di.prototype,"isGizmo",2);var dg=Object.defineProperty,ug=(i,e)=>dg(i,"name",{value:e,configurable:!0});class Mo extends w{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"hint");r(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;let e=C(this.to).clone(),t=C(this.from).clone(),s=e.distanceTo(t),n=e.clone();n.sub(t);let o=t.clone();o.add(e),o.multiplyScalar(.5);let a=C(this.hint).clone();a.sub(o);let l=new y;l.crossVectors(a,n),l.crossVectors(n,l),l.normalize();let c=s*.5,h=Math.max(this.desiredDistance,c),d=Math.sqrt(h*h-c*c),u=l.clone();u.multiplyScalar(d),u.add(o),D(this.gameObject,u);let _=o.clone();_.sub(l),this.gameObject.lookAt(_)}}ug(Mo,"BasicIKConstraint");var fg=Object.defineProperty,pg=(i,e)=>fg(i,"name",{value:e,configurable:!0});const ji=class extends w{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=C(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const e=new fo;e.drag=this.drag,e.angularDrag=this.angularDrag,e.mass=this.mass,e.kinematic=this.isKinematic,e.physicsEvents=this.detectCollision,e.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,e),this.parent=this.gameObject.parent}wakeUp(){var e;(e=this.body)==null||e.wakeUp()}applyForce(e,t){var s;(s=this.body)==null||s.applyForce(new It(e.x,e.y,e.z),t?new It(t.x,t.y,t.z):void 0)}set kinematic(e){this.isKinematic=e,this.body&&(this.body.type=e?he.KINEMATIC:he.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var e,t,s;return this.body?ji.tempPosition.set((e=this.body)==null?void 0:e.velocity.x,(t=this.body)==null?void 0:t.velocity.y,(s=this.body)==null?void 0:s.velocity.z):ji.tempPosition.set(0,0,0)}setVelocity(e,t,s){!this.body||(this.body.velocity.x=e/this.context.time.deltaTime,this.body.velocity.y=t/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(e,t,s){!this.body||(this.body.angularVelocity.x=e/this.context.time.deltaTime,this.body.angularVelocity.y=t/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(e=null){if(this.body&&this.gameObject&&!this.destroyed){const t=this.worldPosition;this.body.position.set(t.x,t.y,t.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),e){ji.copyVector3.set(e.x,e.y,e.z),this.smoothedVelocity.lerp(ji.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const e=C(this.gameObject);this.currentVelocity.subVectors(e,this.lastWorldPosition),this.lastWorldPosition.copy(e),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let Re=ji;r(Re,"tempPosition",new y),r(Re,"copyVector3",new y);pg(Re,"Rigidbody");var mg=Object.defineProperty,gg=(i,e)=>mg(i,"name",{value:e,configurable:!0});class Io extends w{constructor(){super(...arguments);r(this,"$serializedTypes",{attachedRigidbody:Re,size:y,center:y,isTrigger:null});r(this,"attachedRigidbody");r(this,"size");r(this,"center");r(this,"isTrigger");r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addBoxCollider(this.gameObject,this.isTrigger,this.center,this.size,this.attachedRigidbody))}}gg(Io,"BoxCollider");var _g=Object.defineProperty,bg=(i,e)=>_g(i,"name",{value:e,configurable:!0});const yg=new xl(1,1,1);function jo(i=null){const e=new f(i!=null?i:14540253),t=new jf(yg);return new Ff(t,new Bf({color:e}))}bg(jo,"CreateWireCube");var wg=Object.defineProperty,vg=(i,e)=>wg(i,"name",{value:e,configurable:!0});const xg=v("gizmos");class ui extends w{constructor(){super(...arguments);r(this,"box",null);r(this,"testBox",new ii);r(this,"_lastMatrixUpdateFrame",-1);r(this,"_helper",null);r(this,"_color",null)}isInBox(e){var t;if(!!e){if(this.box||(this.box=new ii),this.updateBox(!1),e.type==="Mesh")this.testBox.setFromObject(e);else{const s=C(e);this.testBox.set(s,s)}return(t=this.box)==null?void 0:t.intersectsBox(this.testBox)}}intersects(e){return e?this.updateBox(!1).intersectsBox(e):!1}updateBox(e=!1){return this.box||(this.box=new ii),(e||this.context.time.frameCount!=this._lastMatrixUpdateFrame)&&(this._lastMatrixUpdateFrame=this.context.time.frameCount,this.box.setFromCenterAndSize(new y(0,0,0),new y(1,1,1)),this.box.applyMatrix4(this.gameObject.matrixWorld)),this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(e=null,t=!1){var s;if(!(!xg&&!t)){if(this._helper){e&&((s=this._color)==null||s.set(e)),this.gameObject.add(this._helper);return}this._helper=jo(e),this.gameObject.add(this._helper)}}}vg(ui,"BoxHelperComponent");var Pg=Object.defineProperty,Og=(i,e)=>Pg(i,"name",{value:e,configurable:!0});class Fo{}Og(Fo,"UnityObject");var Cg=Object.defineProperty,ph=(i,e)=>Cg(i,"name",{value:e,configurable:!0});class fi extends w{constructor(){super(...arguments);r(this,"canGrab",!0)}onPointerClick(e){}}ph(fi,"Interactable");class pi extends w{constructor(){super(...arguments);r(this,"isUsed",!0);r(this,"usedBy",null)}}ph(pi,"UsageMarker");var Sg=Object.defineProperty,mh=(i,e)=>Sg(i,"name",{value:e,configurable:!0});class Cn extends ui{}mh(Cn,"DeleteBox");class Bo extends w{constructor(){super(...arguments);r(this,"deleteBoxes",[])}awake(){this.deleteBoxes=p.findObjectsOfType(Cn,this.context)}update(){for(const e of this.deleteBoxes){const t=this.gameObject;e.isInBox(t)===!0&&(p.getComponentInParent(this.gameObject,pi)||Zs(this.gameObject,this.context.connection))}}}mh(Bo,"Deletable");var gh=Object.defineProperty,Rg=Object.getOwnPropertyDescriptor,_h=(i,e)=>gh(i,"name",{value:e,configurable:!0}),Eg=(i,e,t,s)=>{for(var n=s>1?void 0:s?Rg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&gh(e,t,n),n},bh;(function(i){i[i.Never=0]="Never",i[i.Desktop=1]="Desktop",i[i.Mobile=2]="Mobile"})(bh||(bh={}));class Sn extends w{constructor(){super(...arguments);r(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||p.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:yh()?(this.visibleOn&2)!=0:(this.visibleOn&1)!=0}}_h(Sn,"DeviceFlag");Eg([g()],Sn.prototype,"visibleOn",2);let Rn;function yh(){if(Rn===!0||Rn===!1)return Rn;let i=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(i=!0)}(navigator.userAgent||navigator.vendor||window.opera),Rn=i,i}_h(yh,"isMobile");var Ag=Object.defineProperty,kg=(i,e)=>Ag(i,"name",{value:e,configurable:!0});class ae{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(e,t,s,n){return e.prep(4,12),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}kg(ae,"Vec3");var Lg=Object.defineProperty,Tg=(i,e)=>Lg(i,"name",{value:e,configurable:!0});class Uo{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}position(e){return(e||new ae).__init(this.bb_pos,this.bb)}rotation(e){return(e||new ae).__init(this.bb_pos+12,this.bb)}scale(e){return(e||new ae).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(e,t,s,n,o,a,l,c,h,d){return e.prep(4,36),e.prep(4,12),e.writeFloat32(d),e.writeFloat32(h),e.writeFloat32(c),e.prep(4,12),e.writeFloat32(l),e.writeFloat32(a),e.writeFloat32(o),e.prep(4,12),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}Tg(Uo,"Transform");var Dg=Object.defineProperty,Mg=(i,e)=>Dg(i,"name",{value:e,configurable:!0});class Ue{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsSyncedTransformModel(e,t){return(t||new Ue).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsSyncedTransformModel(e,t){return e.setPosition(e.position()+Wr),(t||new Ue).__init(e.readInt32(e.position())+e.position(),e)}guid(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}fast(){const e=this.bb.__offset(this.bb_pos,6);return e?!!this.bb.readInt8(this.bb_pos+e):!1}transform(e){const t=this.bb.__offset(this.bb_pos,8);return t?(e||new Uo).__init(this.bb_pos+t,this.bb):null}dontSave(){const e=this.bb.__offset(this.bb_pos,10);return e?!!this.bb.readInt8(this.bb_pos+e):!1}static startSyncedTransformModel(e){e.startObject(4)}static addGuid(e,t){e.addFieldOffset(0,t,0)}static addFast(e,t){e.addFieldInt8(1,+t,0)}static addTransform(e,t){e.addFieldStruct(2,t,0)}static addDontSave(e,t){e.addFieldInt8(3,+t,0)}static endSyncedTransformModel(e){return e.endObject()}static finishSyncedTransformModelBuffer(e,t){e.finish(t)}static finishSizePrefixedSyncedTransformModelBuffer(e,t){e.finish(t,void 0,!0)}}Mg(Ue,"SyncedTransformModel");var Ig=Object.defineProperty,wh=(i,e)=>Ig(i,"name",{value:e,configurable:!0});const St=v("debugsync"),rs="STRS";ln(rs,Ue.getRootAsSyncedTransformModel);const Ne=new Hs;function No(i,e,t=!0){Ne.clear();const s=Ne.createString(i);Ue.startSyncedTransformModel(Ne),Ue.addGuid(Ne,s),Ue.addFast(Ne,t);const n=e.worldPosition,o=e.worldEuler,a=e.gameObject.scale;Ue.addTransform(Ne,Uo.createTransform(Ne,n.x,n.y,n.z,o.x,o.y,o.z,a.x,a.y,a.z));const l=Ue.endSyncedTransformModel(Ne);return Ne.finish(l,rs),Ne.asUint8Array()}wh(No,"createTransformModel");class st extends w{constructor(){super(...arguments);r(this,"overridePhysics",!0);r(this,"interpolatePosition",!0);r(this,"interpolateRotation",!0);r(this,"fastMode",!1);r(this,"syncDestroy",!1);r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"rb",null);r(this,"_wasKinematic",!1);r(this,"_receivedDataBefore",!1);r(this,"_targetPosition");r(this,"_targetRotation");r(this,"_receivedFastUpdate",!1);r(this,"_shouldRequestOwnership",!1);r(this,"joinedRoomCallback",null);r(this,"receivedDataCallback",null);r(this,"tempEuler",new Oe);r(this,"receivedUpdate",!1);r(this,"lastWorldPos");r(this,"lastWorldRotation")}requestOwnership(){St&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}hasOwnership(){var e,t;return(t=(e=this._model)==null?void 0:e.hasOwnership)!=null?t:void 0}isOwned(){var e;return(e=this._model)==null?void 0:e.isOwned}awake(){St&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new y,this._targetRotation=new P,this.lastWorldPos=new y,this.lastWorldRotation=new P,this.rb=p.getComponentInChildren(this.gameObject,Re),this.rb&&(this._wasKinematic=this.rb.kinematic),this.receivedUpdate=!0,this._model=new dn(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(H.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinrary(rs,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&cc(this.guid,this.context.connection),this._model=null,this.context.connection.stopListening(H.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(rs,this.receivedDataCallback)}tryGetLastState(){const e=this.context.connection.tryGetState(this.guid);e&&this.onReceivedData(e)}onReceivedData(e){var t;if(!this.destroyed&&typeof e.guid=="function"&&e.guid()===this.guid){St&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,e),this.receivedUpdate=!0,this._receivedFastUpdate=e.fast();const s=e.transform();if(s){re.markDirty(this.gameObject,!0);const n=s.position();n&&(this.interpolatePosition&&((t=this._targetPosition)==null||t.set(n.x(),n.y(),n.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(n.x(),n.y(),n.z()));const o=s.rotation();o&&(this.tempEuler.set(o.x(),o.y(),o.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&lc(this.gameObject,this.tempEuler))}this._receivedDataBefore=!0}}onEnable(){this.lastWorldPos.copy(this.worldPosition),this.lastWorldRotation.copy(this.worldQuaternion),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){var o;if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){St&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());let e=this.worldPosition,t=this.worldQuaternion;if(this._model.isOwned&&!this.receivedUpdate){const a=e.distanceTo(this.lastWorldPos),l=t.angleTo(this.lastWorldRotation),c=this._model.hasOwnership||this.fastMode?1e-4:.001;(a>c||l>c)&&(this._model.hasOwnership?this._needsUpdate=!0:(St&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastWorldPos),this.worldPosition=this.lastWorldPos,e.copy(this.lastWorldPos),this.worldQuaternion=this.lastWorldRotation,t.copy(this.lastWorldRotation),re.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&re.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastWorldPos.copy(e),this.lastWorldRotation.copy(t),!this._model)return;if(!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership){this.rb&&(this.rb.kinematic=(o=this._model.isOwned)!=null?o:!1,this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject());return}this.rb&&(this._wasKinematic!==void 0&&(St&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.kinematic=this._wasKinematic),this.gameObject.position.distanceTo(new y(0,0,0))>1e3&&(St&&console.log("RESET",this.name),this.gameObject.position.set(0,1,0),this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject()));const s=10,n=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%s==0||n)){St&&console.log("send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this.overridePhysics&&this.rb&&this.rb.setBodyFromGameObject(),this._needsUpdate=!1;const a=No(this.guid,this,!!n);this.context.connection.sendBinary(a)}}}wh(st,"SyncedTransform");class jg{static createButton(e,t={}){const s=document.createElement("button");function n(){if(t.domOverlay===void 0){var c=document.createElement("div");c.style.display="none",document.body.appendChild(c);var h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("width",38),h.setAttribute("height",38),h.style.position="absolute",h.style.right="20px",h.style.top="20px",h.addEventListener("click",function(){u.end()}),c.appendChild(h);var d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),d.setAttribute("stroke","#fff"),d.setAttribute("stroke-width",2),h.appendChild(d),t.optionalFeatures===void 0&&(t.optionalFeatures=[]),t.optionalFeatures.push("dom-overlay"),t.domOverlay={root:c}}t.optionalFeatures===void 0&&(t.optionalFeatures=[]),t.optionalFeatures.push("local-floor"),t.optionalFeatures.push("hand-tracking"),t.optionalFeatures.push("layers");let u=null;async function _(x){x.addEventListener("end",b),await e.xr.setSession(x),s.textContent="STOP AR",t.domOverlay.root.style.display="",u=x}function b(){u.removeEventListener("end",b),s.textContent="START AR",t.domOverlay.root.style.display="none",u=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="START AR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){u===null?navigator.xr.requestSession("immersive-ar",t).then(_):u.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="AR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="ARButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-ar").then(function(c){c?n():a()}).catch(a),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}}const kr=class{static createButton(e,t){t&&console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');const s=document.createElement("button");function n(){let c=null;async function h(u){u.addEventListener("end",d),await e.xr.setSession(u),s.textContent="EXIT VR",c=u}function d(){c.removeEventListener("end",d),s.textContent="ENTER VR",c=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="ENTER VR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){if(c===null){const u={optionalFeatures:["local-floor","bounded-floor","hand-tracking","high-fixed-foveation-level","layers"]};navigator.xr.requestSession("immersive-vr",u).then(h)}else c.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="VR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="VRButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-vr").then(function(c){c?n():a(),kr.xrSessionIsGranted&&(console.log("XR session is granted - will enter immersive web now"),s.click())}),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}static registerSessionGrantedListener(){if("xr"in navigator)try{navigator.xr.addEventListener("sessiongranted",()=>{console.log("Received session granted event"),kr.xrSessionIsGranted=!0})}catch(e){console.error(e)}}};let En=kr;r(En,"xrSessionIsGranted",!1);En.registerSessionGrantedListener();var Fg=Object.defineProperty,An=(i,e)=>Fg(i,"name",{value:e,configurable:!0});const kn="noVoip",le=v("debugvoip"),Bg=v("voip");var Ln;(function(i){i.Update_ID="peer-update-id"})(Ln||(Ln={}));class vh{constructor(e){r(this,"id");this.id=e}}An(vh,"PeerModel");var xh;(function(i){i[i.None=0]="None",i[i.Errors=1]="Errors",i[i.ErrorsAndWarnings=2]="ErrorsAndWarnings",i[i.All=3]="All"})(xh||(xh={}));class Ph{constructor(e,t,s,n){r(this,"peer");r(this,"voip");r(this,"userId");r(this,"peerId");r(this,"call",null);r(this,"callErrorListener",null);r(this,"stream",null);this.voip=e,this.peer=t,this.userId=s,this.peerId=n}close(){var e;le&&console.log("close voip call"),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.open&&this.call.close(),(e=this.stream)==null||e.getTracks().forEach(function(t){t.stop()})}updateMute(e){var s;if(!this.stream)return;const t=(s=this.stream)==null?void 0:s.getAudioTracks();for(const n of t)n.enabled=!e}async startVoipCall(){if(!await nt.HasMicrophonePermissions()){console.warn("no permission to use microphone, can not start call");return}le&&console.log("start voip call"),this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),this.updateMute(this.voip.muteOutput),le&&console.log(this.stream),this.call=this.peer.call(this.peerId,this.stream,{metadata:{userId:this.userId}}),this.call.on("error",t=>{console.error(t)}),this.call.on("stream",t=>{le&&console.log("received stream from remote again",t)}),this.peer.on("close",this.onCallClose.bind(this)),this.callErrorListener=t=>{var s;t.message.includes(this.peerId)?(console.log("Could not connect to "+this.peerId),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.close(),(s=this.stream)==null||s.getTracks().forEach(function(n){n.stop()}),this.stream=null):console.error(t)},this.peer.on("error",this.callErrorListener)}onCallClose(e){le&&console.log("call closed",e)}}An(Ph,"PeerConnection");class Oh{constructor(e,t,s){r(this,"voip");r(this,"call");r(this,"audio",null);r(this,"stream",null);r(this,"obj");r(this,"analyzer",null);r(this,"waitingForStart",!1);r(this,"closed",!1);r(this,"audioElement",null);this.voip=e,this.obj=t,this.call=s}get currentStream(){return this.stream}get currentAudio(){return this.audio}get currentAnalyzer(){return this.analyzer}openAudioStream(e){const t=e.getAudioTracks();for(const s of t)if(s.kind==="audio"&&s.readyState==="live"){this.open(s);return}console.warn("failed finding valid audio stream to begin call")}open(e){console.assert(e.kind==="audio","invalid track kind, expected audio but received "+e.kind),!this.waitingForStart&&(this.waitingForStart=!0,te.userInteractionRegistered||le&&console.log("Incoming call, waiting for user interaction before opening audio"),te.registerWaitForAllowAudio(async()=>{if(this.call.open&&!this.closed){le&&console.log("Setup audio and begin listening"),this.stream=new MediaStream([e]);const t=new vl;this.audio=new Pl(t),this.audio.setVolume(this.voip.muteInput?0:1),this.audio.setMediaStreamSource(this.stream);const s=document.createElement("audio");this.audioElement=s,s.style.display="none",document.body.appendChild(s),s.srcObject=this.stream,s.sinkId!==void 0&&navigator.mediaDevices.enumerateDevices().then(n=>{if(!!s){console.log(n);for(const o of n)if(o.label==="Speakerphone"){s.sinkId=o.deviceId;break}}}),le&&console.log("call is setup, you should hear something now"),this.analyzer=new Uf(this.audio,32)}}))}close(){var e,t,s;this.closed=!0,((e=this.call)==null?void 0:e.open)&&this.call.close(),(t=this.audio)==null||t.disconnect(),(s=this.stream)==null||s.getTracks().forEach(n=>{n.stop()}),this.stream=null,this.audioElement&&this.audioElement.remove()}}An(Oh,"AudioConnection");class nt extends w{constructor(){super(...arguments);r(this,"requireParam",!1);r(this,"peer",null);r(this,"model",null);r(this,"connections",{});r(this,"currentIncomingCalls",{});r(this,"_inputMuted",!1);r(this,"_outputMuted",!1)}set muteInput(e){var s;if(e===this._inputMuted||(this._inputMuted=e,!this.currentIncomingCalls))return;const t=this._inputMuted?0:1;for(const n in this.currentIncomingCalls){const o=this.currentIncomingCalls[n];(s=o==null?void 0:o.currentAudio)==null||s.setVolume(t)}}get muteInput(){return this._inputMuted}set muteOutput(e){if(e!==this._outputMuted&&(this._outputMuted=e,!!this.connections))for(const t in this.connections){const s=this.connections[t];s==null||s.updateMute(e)}}get muteOutput(){return this._outputMuted}getFrequency(e){if(e===null){for(const s in this.currentIncomingCalls){const n=this.currentIncomingCalls[s];if(n&&n.currentAnalyzer)return n.currentAnalyzer.getAverageFrequency()}return null}const t=this.currentIncomingCalls[e];return t&&t.currentAnalyzer?t.currentAnalyzer.getAverageFrequency():null}awake(){if(v(kn)){console.log("VOIP is disabled by url parameter: "+kn);return}if(this.requireParam&&!Bg){console.debug("VOIP must be enabled explicitly by url parameter");return}this.peer=new Br,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,this.context.connection.beginListen(H.JoinedRoom,e=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}),this.context.connection.beginListen(Ln.Update_ID,e=>{if(e.id!==this.context.connection.connectionId){const t=this.connections[e.id];if(t&&t.close(),this.peer&&this.context.connection.connectionId){const s=new Ph(this,this.peer,this.context.connection.connectionId,e.peerId);this.connections[e.id]=s,s.startVoipCall()}}}),this.context.connection.beginListen(H.UserLeftRoom,e=>{const{userId:t}=e,s=this.connections[t];this.connections[t]=null,s&&s.close();const n=this.currentIncomingCalls[t];le&&console.log("UserLeftRoom",e,t,n),n&&(n.close(),this.currentIncomingCalls[t]=null)}),this.peer.on("open",this.onOpenPeerConnection.bind(this))}onEnable(){}onDisable(){console.log("TODO: close all");for(const e in this.currentIncomingCalls){const t=this.currentIncomingCalls[e];t==null||t.close();const s=this.connections[e];s==null||s.close()}}async onOpenPeerConnection(e){le&&console.log("Peer connection established and received id"),this.model=new vh(e),this.context.connection.send(Ln.Update_ID,this.model,Yi.OnRoomJoin),this.peer&&(this.peer.on("call",this.onReceiveCall.bind(this)),this.peer.on("connection",function(t){le&&console.log("CONNECTION",t),t.on("data",function(s){le&&console.log("Received",s)})}))}async onReceiveCall(e){const{metadata:t}=e;console.assert(t.userId);const{userId:s}=t,n=this.currentIncomingCalls[s];if(n&&n.close(),le&&console.log("received call"),await nt.HasMicrophonePermissions()){const o=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});e.answer(o)}else e.answer(null);this.currentIncomingCalls[s]=new Oh(this,this.gameObject,e),e.on("stream",o=>{var a;le&&console.log("receive caller stream, will setup audio now"),(a=this.currentIncomingCalls[s])==null||a.openAudioStream(o)}),e.on("error",console.error)}static async HasMicrophonePermissions(){return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}}An(nt,"Voip");var Ug=Object.defineProperty,Ch=(i,e)=>Ug(i,"name",{value:e,configurable:!0});const mi=v("debugflags");var Y;(function(i){i[i.Never=0]="Never",i[i.Browser=1]="Browser",i[i.AR=2]="AR",i[i.VR=4]="VR",i[i.FirstPerson=8]="FirstPerson",i[i.ThirdPerson=16]="ThirdPerson"})(Y||(Y={}));const cl=class{constructor(){r(this,"Mask",1|16)}Has(e){const t=this.Mask&e;return mi&&console.log("HAS",e,this.Mask,"Result="+t),t!==0}Set(e){this.Mask=e,J.Apply()}Enable(e){this.Mask|=e,J.Apply()}Disable(e){this.Mask&=~e,J.Apply()}Toggle(e){this.Mask^=e,J.Apply()}EnableAll(){this.Mask=4294967295|0,J.Apply()}DisableAll(){this.Mask=0,J.Apply()}};let ze=cl;r(ze,"Global",new cl);Ch(ze,"XRState");const Xe=class extends w{constructor(){super(...arguments);r(this,"visibleIn")}static Apply(){for(const e of this.registry)e.UpdateVisible(ze.Global)}awake(){Xe.registry.push(this)}onEnable(){Xe.firstApply||(Xe.firstApply=!0,Xe.Apply())}onDestroy(){const e=Xe.registry.indexOf(this);e>=0&&Xe.registry.splice(e,1)}get isOn(){return this.gameObject.visible}UpdateVisible(e=null){if(!this.enabled)return;let t;const s=e;s&&typeof s=="number"&&(console.assert(typeof s=="number","XRFlag.UpdateVisible: state must be a number",s),mi&&console.log(s),Xe.buffer.Mask=s,e=Xe.buffer);const n=e;if(n?(mi&&console.log("use passed in mask"),t=n.Has(this.visibleIn)):(mi&&console.log("use global mask"),ze.Global.Has(this.visibleIn)),t!==void 0)if(t)mi&&console.trace("is visible",this.name,this.gameObject.uuid),p.setActive(this.gameObject,!0);else{if(mi&&console.trace("is not visible",this.name,this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}};let J=Xe;r(J,"registry",[]),r(J,"firstApply"),r(J,"buffer",new ze);Ch(J,"XRFlag");var Ng=Object.defineProperty,Sh=(i,e)=>Ng(i,"name",{value:e,configurable:!0});const Rt=v("debugavatar"),gt=class extends w{constructor(){super(...arguments);r(this,"connectionId");r(this,"avatar")}static onAvatarMarkerCreated(e){return gt._onNewAvatarMarkerAdded.push(e),e}static onAvatarMarkerDestroyed(e){return gt._onAvatarMarkerDestroyed.push(e),e}awake(){gt.instances.push(this),Rt&&console.log(this);for(const e of gt._onNewAvatarMarkerAdded)e({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){gt.instances.splice(gt.instances.indexOf(this),1);for(const e of gt._onAvatarMarkerDestroyed)e({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}setVisible(e){this.avatar&&("setVisible"in this.avatar?this.avatar.setVisible(e):p.setActive(this.avatar,e))}};let Z=gt;r(Z,"instances",[]),r(Z,"_onNewAvatarMarkerAdded",[]),r(Z,"_onAvatarMarkerDestroyed",[]);Sh(Z,"AvatarMarker");const Bs=class{constructor(e,t,s){r(this,"_isVisible",!0);r(this,"guid");r(this,"root",null);r(this,"head",null);r(this,"handLeft",null);r(this,"handRight",null);r(this,"lastUpdate",-1);r(this,"isLocalAvatar",!1);r(this,"flags",null);r(this,"headScale",new y(1,1,1));r(this,"handLeftScale",new y(1,1,1));r(this,"handRightScale",new y(1,1,1));r(this,"webxr");r(this,"lastAvatarId",null);r(this,"hasAvatarOverride",!1);r(this,"context");r(this,"avatarMarker",null);r(this,"_headTarget",new S);r(this,"_handLeftTarget",new S);r(this,"_handRightTarget",new S);r(this,"_canInterpolate",!1);this.context=e,this.guid=t,this.webxr=s,this.setupCustomAvatar(this.webxr.defaultAvatar)}setVisible(e){this._isVisible=e,this.updateVisibility()}updateFlags(){if(!this.flags)return;let e=this.isLocalAvatar?Y.FirstPerson:Y.ThirdPerson;for(const t of this.flags)t.gameObject.visible=!0,t.UpdateVisible(e)}async setAvatarOverride(e){return this.hasAvatarOverride=e!==null,this.hasAvatarOverride&&this.lastAvatarId!==e&&(this.lastAvatarId=e,e!=null&&e.length>0)?await this.setupCustomAvatar(e):null}tryUpdate(e,t){if(e.guid===this.guid&&(this.lastAvatarId!==e.avatarId&&e.avatarId&&e.avatarId.length>0&&(this.lastAvatarId=e.avatarId,this.setupCustomAvatar(e.avatarId)),this.lastUpdate=e.time,this.head)){this._canInterpolate=!0;const s=this.isLocalAvatar?this.head:this._headTarget;if(s.position.set(e.position.x,e.position.y,e.position.z),s.quaternion.set(e.rotation.x,e.rotation.y,e.rotation.z,e.rotation.w),s.scale.set(e.scale,e.scale,e.scale),s.scale.multiply(this.headScale),this.handLeft){const n=this.isLocalAvatar?this.handLeft:this._handLeftTarget;n.position.set(e.posLeftHand.x,e.posLeftHand.y,e.posLeftHand.z),n.quaternion.set(e.rotLeftHand._x,e.rotLeftHand._y,e.rotLeftHand._z,e.rotLeftHand._w),n.quaternion.multiply(Bs.invertRotation),n.scale.set(e.scale,e.scale,e.scale),n.scale.multiply(this.handLeftScale)}if(this.handRight){const n=this.isLocalAvatar?this.handRight:this._handRightTarget;n.position.set(e.posRightHand.x,e.posRightHand.y,e.posRightHand.z),n.quaternion.set(e.rotRightHand._x,e.rotRightHand._y,e.rotRightHand._z,e.rotRightHand._w),n.quaternion.multiply(Bs.invertRotation),n.scale.set(e.scale,e.scale,e.scale),n.scale.multiply(this.handRightScale)}}}update(){if(this.isLocalAvatar||!this._canInterpolate)return;const e=this.context.time.deltaTime/.1;this.head&&(this.head.position.lerp(this._headTarget.position,e),this.head.quaternion.slerp(this._headTarget.quaternion,e),this.head.scale.lerp(this._headTarget.scale,e)),this.handLeft&&this._handLeftTarget&&(this.handLeft.position.lerp(this._handLeftTarget.position,e),this.handLeft.quaternion.slerp(this._handLeftTarget.quaternion,e),this.handLeft.scale.lerp(this._handLeftTarget.scale,e)),this.handRight&&this._handRightTarget&&(this.handRight.position.lerp(this._handRightTarget.position,e),this.handRight.quaternion.slerp(this._handRightTarget.quaternion,e),this.handRight.scale.lerp(this._handRightTarget.scale,e))}destroy(){var e,t;Rt&&console.log("Destroy avatar",this.guid),(e=this.root)==null||e.removeFromParent(),(t=this.avatarMarker)==null||t.destroy(),this.lastAvatarId=null,this.head&&ie.Remove(this.context,this.head)}updateVisibility(){const e=this.root;e&&p.setActive(e,this._isVisible)}async setupCustomAvatar(e){var n,o,a,l,c;if(Rt&&console.log("LOAD",e,this),!e||typeof e=="string"&&e.length<=0)return!1;this.head&&ie.Remove(this.context,this.head);const t=e;if((t==null?void 0:t.loadAssetAsync)!==void 0){await t.loadAssetAsync();const h=t.asset;p.setActive(h,!1),e=p.instantiate(h),p.setActive(e,!0)}Rt&&console.log(e);const s=await Bs.loader.getOrCreateNewAvatarInstance(this.context,e);if(Rt&&console.log(s,s==null?void 0:s.isValid,this.lastAvatarId,e),s==null?void 0:s.isValid){if(this.root=s.root,this.avatarMarker=p.addNewComponent(this.root,Z),this.avatarMarker.connectionId=this.guid,this.avatarMarker.avatar=this,this.head&&this.head!==s.head&&((n=this.head)==null||n.removeFromParent()),this.head=s.head,this.headScale.copy(this.head.scale),this.head&&!this.isLocalAvatar&&ie.Add(this.context,this.head,this.avatarMarker),s.leftHand&&((o=this.handLeft)==null||o.removeFromParent()),this.handLeft=(a=s.leftHand)!=null?a:this.handLeft,this.handLeft?this.handLeftScale.copy(this.handLeft.scale):this.handLeftScale.set(1,1,1),s.rigthHand&&((l=this.handRight)==null||l.removeFromParent()),this.handRight=(c=s.rigthHand)!=null?c:this.handRight,this.handRight?this.handRightScale.copy(this.handRight.scale):this.handRightScale.set(1,1,1),this.context.scene.add(this.root),this.flags==null&&(this.flags=[]),this.flags.length=0,this.flags.push(...p.getComponentsInChildren(this.root,J)),this.flags.length<=0&&this.head){const h=p.addNewComponent(this.head,J);h.visibleIn=Y.ThirdPerson|Y.VR,this.flags.push(h),Rt&&console.log("Added flag to head: "+h.visibleIn,this.head.name)}return Rt&&console.log("[Avatar], is Local? ",this.isLocalAvatar,this.root),this.updateFlags(),this.updateVisibility(),!0}else return Rt&&console.warn("build avatar failed"),!1}};let rt=Bs;r(rt,"loader",new ns),r(rt,"invertRotation",new P().setFromAxisAngle(new y(0,1,0),Math.PI));Sh(rt,"WebXRAvatar");var zg=Object.defineProperty,zo=(i,e)=>zg(i,"name",{value:e,configurable:!0});class ie{static Add(e,t,s=null){if(!!t){for(const n of this.Pois)if(n.obj===t)return;this.Pois.push({obj:t,avatar:s}),this.LastChangeTime=e.time.time}}static Remove(e,t){var s,n;if(!!t){for(const o of this.Pois)if(o.obj===t){this.Pois.splice(this.Pois.indexOf(o),1),this.LastChangeTime=(n=e==null?void 0:e.time.time)!=null?n:(s=A.Current)==null?void 0:s.time.time;return}}}}r(ie,"Pois",[]),r(ie,"LastChangeTime",0);zo(ie,"Avatar_POI");var Tn;(function(i){i.TargetChanged="avatar-look-target-changed"})(Tn||(Tn={}));class Rh{constructor(){r(this,"guid");r(this,"position",new y)}}zo(Rh,"TargetModel");class os extends w{constructor(){super(...arguments);r(this,"target",null);r(this,"avatar",null);r(this,"_model",null);r(this,"_targetModel",new Rh);r(this,"_currentTargetObject",null);r(this,"_lastUpdateTime",0);r(this,"_lookDuration",0);r(this,"_lastPoiChangedTime",0)}set controlledTarget(e){this.target=e;const t=m.get("MoveRandom");if(t&&this.target){const s=p.getComponent(this.target,t);s&&s.destroy()}}awake(){if(this.avatar=p.getComponentInParent(this.gameObject,Z),this.avatar){const e=p.getComponentInParent(this.gameObject,Z);this._model=new dn(this.context.connection,this.guid),(e==null?void 0:e.isLocalAvatar)&&this._model.requestOwnership()}this.context.connection.beginListen(Tn.TargetChanged,e=>{var t;this.target&&e&&e.guid===((t=this.avatar)==null?void 0:t.guid)&&D(this.target,e.position)})}update(){var t;if((!this.context.connection.isConnected||((t=this._model)==null?void 0:t.hasOwnership))&&(ie.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=ie.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10==0&&this.target)){const s=C(this._currentTargetObject);D(this.target,s),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send(Tn.TargetChanged,this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(s))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const t=ie.Pois;if(t.length>0){const s=t[Math.floor(Math.random()*t.length)];if(s&&s.obj){if(s.avatar&&s.avatar===this.avatar)return;this._currentTargetObject=s.obj}}}}}zo(os,"Avatar_Brain_LookAt");var $g=Object.defineProperty,Dn=(i,e)=>$g(i,"name",{value:e,configurable:!0}),Mn;(function(i){i[i.PhysicalDevice=0]="PhysicalDevice",i[i.Touch=1]="Touch"})(Mn||(Mn={}));var pe;(function(i){i.SelectStart="select-start",i.SelectEnd="select-end",i.Update="update"})(pe||(pe={}));class In extends w{}Dn(In,"TeleportTarget");const V=class extends w{constructor(){super(...arguments);r(this,"webXR");r(this,"index",-1);r(this,"controllerModel");r(this,"controller");r(this,"controllerGrip");r(this,"hand");r(this,"handPointerModel");r(this,"grabbed",null);r(this,"input",null);r(this,"type",0);r(this,"_wristQuaternion",null);r(this,"movementVector",new y);r(this,"worldRot",new P);r(this,"joystick",new z);r(this,"didRotate",!1);r(this,"didTeleport",!1);r(this,"didChangeScale",!1);r(this,"lastHit",null);r(this,"raycastLine",null);r(this,"_raycastHitPoint",null);r(this,"_connnectedCallback",null);r(this,"_disconnectedCallback",null);r(this,"_selectStartEvt",null);r(this,"_selectEndEvt",null);r(this,"_selectionPressed",!1);r(this,"_selectionPressedLastFrame",!1);r(this,"_selectionStartTime",0);r(this,"_selectionEndTime",0);r(this,"_useSmoothing",!0);r(this,"_isConnected",!1);r(this,"rayRotation",new P);r(this,"_pinchStartTime");r(this,"selectStartCallback",null);r(this,"lastSelectStartObject",null);r(this,"_didNotEndSelection",!1)}static CreateRaycastLine(){const e=new Ol(this.geometry),t=e.material;return t.color=this.raycastColor,e.layers.set(1),e.name="line",e.scale.z=1,e}static CreateRaycastHitPoint(){const e=new Cl(.5,22,22),t=new zi({color:this.raycastColor}),s=new ni(e,t);return s.visible=!1,s.layers.set(1),s}static Create(e,t,s,n){const o=s?p.addNewComponent(s,V,!1):new V;o.webXR=e,o.index=t,o.type=n;const a=e.context;return o.controller=a.renderer.xr.getController(t),o.controllerGrip=a.renderer.xr.getControllerGrip(t),o.controllerModel=this.Factory.createControllerModel(o.controller),o.controllerGrip.add(o.controllerModel),o.hand=a.renderer.xr.getHand(t),o.hand.add(new zf(o.hand)),o.hand.traverse(l=>l.layers.set(2)),o.handPointerModel=new $f(o.hand,o.controller),o.controller.addEventListener("connected",l=>{o.setControllerLayers(o.controllerModel,2),o.setControllerLayers(o.controllerGrip,2),setTimeout(()=>{o.setControllerLayers(o.controllerGrip,2)},1e3)}),o.hand.addEventListener("connected",l=>{var h;if(l.data.hand){e.Rig&&e.Rig.add(o.hand),o.type=0,o.handPointerModel.traverse(u=>u.layers.set(2)),(h=o.handPointerModel.pointerObject)==null||h.traverse(u=>u.layers.set(2));const d=o.hand.joints;if(d)for(const u of Object.keys(d)){const _=d[u];_.parent||o.hand.add(_)}}}),o}static addEventListener(e,t){var n;const s=(n=this.eventSubs[e])!=null?n:[];s.push(t),this.eventSubs[e]=s}get isUsingHands(){var t;const e=(t=this.input)==null?void 0:t.hand;return e!=null}get wrist(){if(!this.hand)return null;const e=this.hand.joints;return e?e.wrist:null}getWristQuaternion(){const e=this.wrist;return e?(this._wristQuaternion||(this._wristQuaternion=new P),K(e).multiply(this._wristQuaternion.setFromEuler(new Oe(-Math.PI/4,0,0)))):null}get selectionDown(){return this._selectionPressed&&!this._selectionPressedLastFrame}get selectionUp(){return!this._selectionPressed&&this._selectionPressedLastFrame}get selectionPressed(){return this._selectionPressed}get selectionClick(){return this._selectionEndTime-this._selectionStartTime<.3}get raycastHitPoint(){return this._raycastHitPoint}get useSmoothing(){return this._useSmoothing}awake(){if(!this.controller){console.warn("Missing Controller!!!",this);return}this._connnectedCallback=this.onSourceConnected.bind(this),this._disconnectedCallback=this.onSourceDisconnected.bind(this),this._selectStartEvt=this.onSelectStart.bind(this),this._selectEndEvt=this.onSelectEnd.bind(this),this.type===1&&(this.controllerGrip.addEventListener("connected",this._connnectedCallback),this.controllerGrip.addEventListener("disconnected",this._disconnectedCallback),this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt))}onDestroy(){var e,t,s;this.type===1&&(this.controllerGrip.removeEventListener("connected",this._connnectedCallback),this.controllerGrip.removeEventListener("disconnected",this._disconnectedCallback),this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),(e=this.hand)==null||e.clear(),(t=this.controllerGrip)==null||t.clear(),(s=this.controller)==null||s.clear()}onEnable(){var e,t,s,n,o;this.hand&&(this.hand.name="Hand"),this.controllerGrip&&(this.controllerGrip.name="ControllerGrip"),this.controller&&(this.controller.name="Controller"),this.raycastLine&&(this.raycastLine.name="RaycastLine;"),this.webXR.Controllers.indexOf(this)<0&&this.webXR.Controllers.push(this),this.raycastLine||(this.raycastLine=V.CreateRaycastLine()),this._raycastHitPoint||(this._raycastHitPoint=V.CreateRaycastHitPoint()),(e=this.webXR.Rig)==null||e.add(this.hand),(t=this.webXR.Rig)==null||t.add(this.controllerGrip),(s=this.webXR.Rig)==null||s.add(this.controller),(n=this.webXR.Rig)==null||n.add(this.raycastLine),(o=this.raycastLine)==null||o.add(this._raycastHitPoint),this.hand.add(this.handPointerModel),console.log("ADDED TO RIG",this.webXR.Rig)}onDisable(){var t,s,n,o,a;(t=this.hand)==null||t.removeFromParent(),(s=this.controllerGrip)==null||s.removeFromParent(),(n=this.controller)==null||n.removeFromParent(),(o=this.raycastLine)==null||o.removeFromParent(),(a=this._raycastHitPoint)==null||a.removeFromParent();const e=this.webXR.Controllers.indexOf(this);e>=0&&this.webXR.Controllers.splice(e,1)}onSourceConnected(e){if(this._isConnected){console.warn("Received connected event for controller that is already connected",this.index,e);return}this._isConnected=!0,this.input=e.data,this.type===1&&(this.onSelectStart(),this.createPointerEvent("down"))}onSourceDisconnected(e){if(!this._isConnected){console.warn("Received discnnected event for controller that is not connected",e);return}this._isConnected=!1,this.type===1&&(this.onSelectEnd(),this.createPointerEvent("up")),this.input=null}createPointerEvent(e){switch(e){case"down":this.context.input.createPointerDown({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break;case"move":break;case"up":this.context.input.createPointerUp({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break}}update(){this.context.time.frameCount%60==0&&(this.setControllerLayers(this.controller,2),this.setControllerLayers(this.controllerGrip,2),this.setControllerLayers(this.hand,2));const e=V.eventSubs[pe.Update];if(e&&e.length>0)for(const n of e)n(this);let t=1;this.type===0?t=this.context.time.deltaTime/.1:this.isUsingHands&&this.handPointerModel.pinched&&(t=this.context.time.deltaTime/.3),this.rayRotation.slerp(K(this.controller),this.useSmoothing?t:1);const s=C(this.controller);if(this.raycastLine)if(this.type===1)this.raycastLine.visible=!1;else if(this.isUsingHands){this.raycastLine.visible=!this.grabbed,D(this.raycastLine,s);const n=this.hand.joints;if(n&&n.wrist&&this.grabbed&&this.grabbed.isCloseGrab){const a=this.getWristQuaternion();a&&this.rayRotation.copy(a)}ee(this.raycastLine,this.rayRotation)}else this.raycastLine.visible=!0,ee(this.raycastLine,this.rayRotation),D(this.raycastLine,s);this.lastHit=this.updateLastHit(),this.grabbed&&this.grabbed.update(),this._selectionPressedLastFrame=this._selectionPressed,this.selectStartCallback&&this.selectStartCallback()}onUpdate(e){var n,o;if(this.lastHit=null,!e||e.inputSources.length<=this.index){this.input=null;return}if(this.type===0&&(this.input=e.inputSources[this.index]),!this.input)return;const t=this.webXR.Rig;if(!t)return;this._didNotEndSelection&&!this.handPointerModel.pinched&&(this._didNotEndSelection=!1,this.onSelectEnd()),this.updateStick(this.input);const s=(o=(n=this.input)==null?void 0:n.gamepad)==null?void 0:o.buttons;switch(this.input.handedness){case"left":const a=3*V.MovementSpeedFactor,l=2,c=k.clamp01(this.joystick.length()*2),h=this.joystick.x>0?1:-1;let d=Math.pow(this.joystick.x,l);d*=h,d*=c;const u=this.joystick.y>0?1:-1;let _=Math.pow(this.joystick.y,l);_*=u,d*=c,t.getWorldQuaternion(this.worldRot),this.movementVector.set(d,0,_),this.movementVector.applyQuaternion(this.webXR.TransformOrientation),this.movementVector.y=0,this.movementVector.applyQuaternion(this.worldRot),t.position.add(this.movementVector.multiplyScalar(a*this.context.time.deltaTime)),this.isUsingHands&&this.runTeleport(t,s);break;case"right":const b=this.joystick.x,x=Math.abs(b);if(x<.4)this.didRotate=!1;else if(x>.5&&!this.didRotate){const O=b>0?-1:1;t.rotateY(k.toRadians(30*O)),this.didRotate=!0}this.runTeleport(t,s);break}}runTeleport(e,t){var l,c,h;let s=-this.joystick.y;if(((l=this.hand)==null?void 0:l.visible)&&!this.grabbed){const d=this.handPointerModel.isPinched();d&&this._pinchStartTime===void 0&&(this._pinchStartTime=this.context.time.time),d&&this._pinchStartTime&&this.context.time.time-this._pinchStartTime>.8&&(s=this.handPointerModel.isPinched()?1:0),d||(this._pinchStartTime=void 0)}else this._pinchStartTime=void 0;let n=s>.5,o=this.webXR.Rig?((h=(c=this.webXR.Rig)==null?void 0:c.scale)==null?void 0:h.x)<.999:!1,a=null;if(t&&this.input&&!this.input.hand)for(let d=0;d<t.length;d++){const u=t[d];if(d===4)if(u.pressed&&!this.didChangeScale){this.didChangeScale=!0;const _=this.webXR.Rig;if(_)if(o){o=!1,_.scale.set(1,1,1),a=1,V.MovementSpeedFactor=1;const b=this.context.mainCamera;V.PreviousCameraFarDistance&&(b.far=V.PreviousCameraFarDistance)}else{o=!0,n=!0,a=.1,V.MovementSpeedFactor=a*2;const b=this.context.mainCamera;V.PreviousCameraFarDistance=b.far,b.far/=a}}else u.pressed||(this.didChangeScale=!1)}if(n){if(!this.didTeleport){const d=this.raycast();if(this.didTeleport=!0,d&&d.length>0){const u=d[0];if(o||this.isValidTeleportTarget(u.object)){const _=u.point;D(e,_)}}}}else s<.1&&(this.didTeleport=!1);a!==null&&(e.scale.set(a,a,a),e.updateMatrixWorld())}isValidTeleportTarget(e){return p.getComponentInParent(e,In)!=null}updateStick(e){var t;!e||!e.gamepad||((t=e.gamepad.axes)==null?void 0:t.length)<4||(this.joystick.x=e.gamepad.axes[2],this.joystick.y=e.gamepad.axes[3])}updateLastHit(){var n,o;const e=this.raycast(),t=e?e[0]:null;this.lastHit=t;let s=1;if(this.webXR.Rig&&(s/=this.webXR.Rig.scale.x),this.raycastLine){this.raycastLine.scale.z=s*((o=(n=this.lastHit)==null?void 0:n.distance)!=null?o:9999);const a=this.raycastLine.material;t!=null?a.color=V.raycastColor:a.color=V.raycastNoHitColor}if(this._raycastHitPoint){if(this.lastHit!=null){this._raycastHitPoint.position.z=-1;const a=k.clamp(this.lastHit.distance*.01*s,.015,.1);this._raycastHitPoint.scale.set(a,a,a)}this._raycastHitPoint.visible=this.lastHit!==null}return t}onSelectStart(){!this.context.connection.allowEditing||(this.selectStartCallback=()=>this.onHandleSelectStart())}onHandleSelectStart(){this.selectStartCallback=null,this._selectionPressed=!0,this._selectionStartTime=this.context.time.time,this._selectionEndTime=1e3;let e=null,t=!1;if(this.isUsingHands?(e=this.overlap(),e.length<=0?(e=this.raycast(),t=!1):t=!0):e=this.raycast(),e&&e.length>0)for(const s of e){const n=s.object;if(!this.testIsVisible(n)){console.log("not visible");continue}this.lastSelectStartObject=n;const o={selected:n,grab:n},a=V.eventSubs[pe.SelectStart];if(a&&a.length>0)for(const l of a)l(this,o);o.grab!==n&&console.log("Grabbed object changed","original",n,"new",o.grab),o.grab&&(this.grabbed=Ee.TryTake(this,o.grab,s,t));break}else{const s=V.eventSubs[pe.SelectStart],n={selected:null,grab:null};if(s&&s.length>0)for(const o of s)o(this,n)}}onSelectEnd(){var s,n;if(this.isUsingHands&&this.handPointerModel.pinched){this._didNotEndSelection=!0;return}if(!this._selectionPressed)return;this.selectStartCallback=null,this._selectionPressed=!1,this._selectionEndTime=this.context.time.time;const e={grab:(n=(s=this.grabbed)==null?void 0:s.selected)!=null?n:this.lastSelectStartObject},t=V.eventSubs[pe.SelectEnd];if(t&&t.length>0)for(const o of t)o(this,e);this.grabbed&&(this.grabbed.free(),this.grabbed=null)}testIsVisible(e){return e?p.isActiveInHierarchy(e):!0}setControllerLayers(e,t){var s,n;if(!!e&&(e.layers.set(t),e.children))for(const o of e.children)((s=this.grabbed)==null?void 0:s.selected)===o||((n=this.grabbed)==null?void 0:n.selectedMesh)===o||this.setControllerLayers(o,t)}getRay(){const e=new Sl;return e.origin.copy(C(this.controller)),e.direction.set(0,0,-1).applyQuaternion(this.rayRotation),e}overlap(){const e=this.isUsingHands&&this.handPointerModel?this.handPointerModel.pointerObject:this.controllerGrip;if(!e)return new Array;const t=C(e).clone();return this.context.physics.sphereOverlap(t,.02)}raycast(){const e=new je;return e.layerMask=new Ws,e.layerMask.set(0),e.ray=this.getRay(),this.context.physics.raycast(e)}};let j=V;r(j,"Factory",new Nf),r(j,"raycastColor",new f(.9,.3,.3)),r(j,"raycastNoHitColor",new f(.6,.6,.6)),r(j,"geometry",new Gs().setFromPoints([new y(0,0,0),new y(0,0,-1)])),r(j,"handModels",{}),r(j,"eventSubs",{}),r(j,"PreviousCameraFarDistance"),r(j,"MovementSpeedFactor",1);Dn(j,"WebXRController");var jn;(function(i){i.WillTake="WillTake",i.DidTake="DidTake",i.WillFree="WillFree",i.DidFree="DidFree"})(jn||(jn={}));const se=class{constructor(){r(this,"sync",null);r(this,"selected",null);r(this,"selectedParent",null);r(this,"selectedMesh",null);r(this,"controller",null);r(this,"grabTime",0);r(this,"grabUUID","");r(this,"isCloseGrab",!1);r(this,"originalMaterial",null);r(this,"usageMarker",null);r(this,"rigidbodies",null);r(this,"didReparent",!1);r(this,"grabDistance",0);r(this,"interactable",null);r(this,"positionSource",null);r(this,"grabPoint",new y);r(this,"localPositionOffsetToGrab",null);r(this,"localPositionOffsetToGrab_worldSpace",new y);r(this,"localQuaternionToGrab",new P(0,0,0,1));r(this,"targetDir",null);r(this,"quaternionLerp",null);r(this,"controllerDir",new y);r(this,"controllerWorldPos",new y);r(this,"lastControllerWorldPos",new y);r(this,"controllerPosDelta",new y);r(this,"totalChangeAlongDirection",0);r(this,"rigPositionLastFrame",new y)}static AddEventListener(e,t){return se.Events[e]||(se.Events[e]=[]),se.Events[e].push(t),t}static RemoveEventListener(e,t){if(!t||!se.Events[e])return;const s=se.Events[e].indexOf(t);s>=0&&se.Events[e].splice(s,1)}static Register(e){this.Current.find(t=>t===e)||this.Current.push(e)}static Remove(e){const t=this.Current.indexOf(e);t>=0&&this.Current.splice(t,1)}static TryTake(e,t,s,n){const o=p.getComponentInParent(t,fi);if(!o)return console.warn("Prevented taking object that is not interactable",t),null;let a=t;const l=p.getComponentInParent(t,st);l&&(l.requestOwnership(),a=l.gameObject);for(const h of this.Current)if(h.selected===a)return h.controller===e||(h.free(),h.Take(e,a,t,l,o,s,n)),h;const c=new se;return c.Take(e,a,t,l,o,s,n),c}Take(e,t,s,n,o,a,l){var b,x;if(console.assert(t!==null,"Expected object to be taken but was",t),e.isUsingHands?this.positionSource=l?e.wrist:e.controller:this.positionSource=e.controller,!this.positionSource)return console.warn("No position source"),this;const c={controller:e,take:t,hit:s,sync:n,interactable:o};(b=se.Events.WillTake)==null||b.forEach(O=>O(this,c));const h=s;(h==null?void 0:h.material)&&(this.originalMaterial=h.material,Array.isArray(h.material)||(h.material=h.material.clone(),h.material&&h.material.emissive&&(h.material.emissive.b=.2))),this.selected=t,this.selectedParent||(this.selectedParent=t.parent),this.selectedMesh=h,this.controller=e,this.interactable=o,this.isCloseGrab=l,this.didReparent=!1,this.sync=n,this.grabTime=e.context.time.time,this.grabUUID=Date.now().toString(),this.usageMarker=p.addNewComponent(this.selected,pi),this.rigidbodies=p.getComponentsInChildren(this.selected,Re),C(this.positionSource,this.lastControllerWorldPos);const d=Dn(()=>l?this.lastControllerWorldPos.clone():a.point.clone(),"getGrabPoint");this.grabDistance=d().distanceTo(this.lastControllerWorldPos),this.totalChangeAlongDirection=0,this.localPositionOffsetToGrab=this.selected.worldToLocal(d());const u=e.isUsingHands&&l?this.controller.getWristQuaternion().clone():e.rayRotation.clone();K(this.selected,this.localQuaternionToGrab).premultiply(u.invert());const _=this.controller.webXR.Rig;return _&&this.rigPositionLastFrame.copy(C(_)),ie.Add(e.context,this.selected),se.Register(this),this.sync&&(this.sync.fastMode=!0),(x=se.Events.DidTake)==null||x.forEach(O=>O(this,c)),this}free(){var n,o,a,l;if(!this.selected)return;const e={controller:this.controller,take:this.selected,hit:this.selected,sync:this.sync,interactable:null};(n=se.Events.WillFree)==null||n.forEach(c=>c(this,e)),ie.Remove(this.controller.context,this.selected),se.Remove(this),this.sync&&(this.sync.fastMode=!1);const t=this.selectedMesh;t&&this.originalMaterial&&t.material&&(t.material=this.originalMaterial);const s=this.selected;if(this.didReparent&&s.parent){const c=this.selectedParent;c?c.attach(s):(o=this.controller)==null||o.context.scene.attach(s)}if((a=this.usageMarker)==null||a.destroy(),this.controller&&(this.controller.grabbed=null),this.selected=null,this.selectedParent=null,this.selectedMesh=null,this.sync=null,this.rigidbodies)for(const c of this.rigidbodies)c.wakeUp(),!!c.smoothedVelocity&&c.setVelocity(c.smoothedVelocity.x,c.smoothedVelocity.y,c.smoothedVelocity.z);this.rigidbodies=null,this.localPositionOffsetToGrab=null,this.quaternionLerp=null,(l=se.Events.DidFree)==null||l.forEach(c=>c(this,e))}controllerMovementSinceLastFrame(){if(!this.positionSource||!this.controller)return 0;this.controllerDir.set(0,0,-1),this.controllerDir.applyQuaternion(this.controller.rayRotation),C(this.positionSource,this.controllerWorldPos),this.controllerPosDelta.copy(this.controllerWorldPos),this.controllerPosDelta.sub(this.lastControllerWorldPos),this.lastControllerWorldPos.copy(this.controllerWorldPos);const e=this.controller.webXR.Rig;if(e){const s=C(e),n=this.rigPositionLastFrame.sub(s);this.controllerPosDelta.add(n),this.rigPositionLastFrame.copy(s)}return this.controllerDir.dot(this.controllerPosDelta)}update(){var e,t;if(this.sync&&this.controller&&this.controller.context.connection.isInRoom&&this.controller.context.time.time-this.grabTime>3&&this.sync.hasOwnership()===!1&&(console.log("no ownership, will leave",this.sync.guid),this.free()),!(this.interactable&&!this.interactable.canGrab)){if(!this.didReparent&&this.selected&&this.controller){const s=(t=(e=this.controller.webXR.Rig)==null?void 0:e.scale.x)!=null?t:1;this.totalChangeAlongDirection+=this.controllerMovementSinceLastFrame();let n=1;this.controller.type===0&&(n=Math.max(0,1+this.totalChangeAlongDirection*2/s),n=n*n*n),this.grabDistance/s<.8&&(n=1),this.targetDir||(this.targetDir=new y),this.targetDir.set(0,0,-this.grabDistance*n);const o=this.targetDir.applyQuaternion(this.controller.rayRotation).add(this.controllerWorldPos),a=this.controller.rayRotation.clone().multiplyQuaternions(this.controller.rayRotation,this.localQuaternionToGrab);this.quaternionLerp||(this.quaternionLerp=a.clone()),this.quaternionLerp.slerp(a,this.controller.useSmoothing?this.controller.context.time.deltaTime/.03:1),ee(this.selected,this.quaternionLerp),this.selected.updateWorldMatrix(!1,!1),this.grabPoint.copy(o),this.localPositionOffsetToGrab&&(this.localPositionOffsetToGrab_worldSpace.copy(this.localPositionOffsetToGrab),this.selected.localToWorld(this.localPositionOffsetToGrab_worldSpace).sub(C(this.selected)),o.sub(this.localPositionOffsetToGrab_worldSpace)),D(this.selected,o)}if(this.rigidbodies!=null)for(const s of this.rigidbodies)s.wakeUp(),s.setBodyFromGameObject({x:0,y:0,z:0});re.markDirty(this.selected,!0)}}};let Ee=se;r(Ee,"Events",{}),r(Ee,"Current",[]);Dn(Ee,"AttachedObject");var Eh=Object.defineProperty,Wg=Object.getOwnPropertyDescriptor,Hg=(i,e)=>Eh(i,"name",{value:e,configurable:!0}),Gg=(i,e,t,s)=>{for(var n=s>1?void 0:s?Wg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Eh(e,t,n),n};class as extends w{constructor(){super(...arguments);r(this,"webAR",null);r(this,"invertForward",!1);r(this,"_arScale",5);r(this,"_rig",null);r(this,"_startPose",null);r(this,"_placementPose",null);r(this,"_isTouching",!1)}get arScale(){return this._arScale}set arScale(e){e!==this._arScale&&(this._arScale=e,this.setScale(e))}onBegin(e){this._placementPose=null,this.gameObject.visible=!1,this.gameObject.matrixAutoUpdate=!1,this._startPose=this.gameObject.matrix.clone(),e.addEventListener("selectstart",this.onSelectStart.bind(this)),e.addEventListener("selectend",this.onSelectEnd.bind(this)),setTimeout(()=>this.gameObject.visible=!1,1e3)}onUpdate(e,t,s){if(s&&!this._placementPose&&this._isTouching){if(this.webAR&&this.webAR.setReticleActive(!1),this._placementPose=new Ce().fromArray(s.transform.matrix).invert(),e){if(this.invertForward){const n=new Ce().makeRotationY(Math.PI);this._placementPose.premultiply(n)}this._rig=e,this.setScale(this.arScale)}else this._rig=null;this.gameObject.visible=!0}}onEnd(e,t){this._placementPose=null,this.gameObject.visible=!1,this._startPose&&this.gameObject.matrix.copy(this._startPose),this.gameObject.matrixAutoUpdate=!0,e&&(e.matrixAutoUpdate=!0),re.markDirty(this.gameObject,!0),setTimeout(()=>this.gameObject.visible=!0,100)}onSelectStart(){this._isTouching=!0}onSelectEnd(){this._isTouching=!1}setScale(e){const t=this._rig;!t||!this._placementPose||(t.matrixAutoUpdate=!1,t.matrix.multiplyMatrices(new Ce().makeScale(e,e,e),this._placementPose),t.matrix.decompose(t.position,t.quaternion,t.scale),t.updateMatrixWorld())}}Hg(as,"WebARSessionRoot");Gg([g()],as.prototype,"arScale",1);var Vg=Object.defineProperty,qg=(i,e)=>Vg(i,"name",{value:e,configurable:!0});class Fn extends w{awake(){}}qg(Fn,"XRRig");var Xg=Object.defineProperty,$o=(i,e)=>Xg(i,"name",{value:e,configurable:!0});const gi=v("debugaddressables");class Ah{constructor(e){r(this,"_context");r(this,"_assetReferences",{});this._context=e,this._context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){}findAssetReference(e){return this._assetReferences[e]||null}registerAssetReference(e){!e.uri||(this._assetReferences[e.uri]?console.warn("Asset reference already registered",e):this._assetReferences[e.uri]=e)}}$o(Ah,"Addressables");class $e{constructor(e){r(this,"_loading");r(this,"_asset");r(this,"_glbRoot");r(this,"_uri");r(this,"_progressListeners",[]);r(this,"_isLoadingRawBinary",!1);r(this,"_rawBinary");this._uri=e,mc(this._uri,this.onResolvePrefab.bind(this))}static getOrCreate(e,t){const s=t.addressables,n=s.findAssetReference(e);if(n)return n;const o=new $e(e);return s.registerAssetReference(o),o}get asset(){var e;return(e=this._glbRoot)!=null?e:this._asset}set asset(e){this._asset=e}get uri(){return this._uri}get rawAsset(){return this._asset}async onResolvePrefab(e){return e===this.uri&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(gi&&console.log("Unload",this.asset),this.asset.scene?p.destroy(this.asset.scene):p.destroy(this.asset)),this.asset=null}async preload(){var t;if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,gi&&console.log("Preload",this.uri);const e=await uh(this.uri,s=>{this.raiseProgressEvent(s)});return this._rawBinary=(t=e==null?void 0:e.buffer)!=null?t:null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(e){if(!this.mustLoad)return;if(e&&this._progressListeners.push(e),this._loading!==void 0)return this._loading;const t=A.Current;this._rawBinary?(this._loading=Is(t,this._rawBinary,this.uri,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))):(gi&&console.log("Load async",this.uri),this._loading=Ii(t,this.uri,null,!0,n=>{this.raiseProgressEvent(n)}));const s=await this._loading;if(this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(s),this._loading=void 0,s)return oi(t),s.scene!==void 0&&(this.asset=s),this.asset}async instantiate(e){return this.onInstantiate(e,!1)}async instantiateSynced(e,t=!0){return this.onInstantiate(e,!0,t)}beginListenDownload(e){this._progressListeners.indexOf(e)<0&&this._progressListeners.push(e)}endListenDownload(e){const t=this._progressListeners.indexOf(e);t>=0&&this._progressListeners.splice(t,1)}raiseProgressEvent(e){for(const t of this._progressListeners)t(this,e)}async onInstantiate(e,t=!1,s){const n=A.Current;if(e||(e=n.scene),this.mustLoad&&await this.loadAssetAsync(),gi&&console.log("Instantiate",this.uri,"parent:",e),this.asset){gi&&console.log("Add to scene",this.asset);let o=e instanceof we?e:null;if(o||(o=new we),typeof e=="object"&&(e instanceof S?o.parent=e:Object.assign(o,e)),t){o.context=n;const a=this.asset;a.guid=this.uri;const l=oo(a,o,void 0,s);if(l)return l}else{const a=p.instantiate(this.asset,o);if(a)return a}}else gi&&console.warn("Failed to load asset",this.uri);return null}tryGetActualGameObjectRoot(e){if(e&&e.scene){const t=e.scene;return t.isGroup&&t.children.length===1&&t.children[0].name+"glb"===t.name?t.children[0]:t}return null}}$o($e,"AssetReference");class kh extends ci{constructor(){super([$e])}onSerialize(e,t){if(e&&e.uri!==void 0&&typeof e.uri=="string")return e.uri}onDeserialize(e,t){return typeof e=="string"?t.context?$e.getOrCreate(e,t.context):(console.error("Missing context"),null):null}}$o(kh,"AddressableSerializer");new kh;var Qg=Object.defineProperty,Yg=(i,e)=>Qg(i,"name",{value:e,configurable:!0});class Gt{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}w(){return this.bb.readFloat32(this.bb_pos+12)}static sizeOf(){return 16}static createVec4(e,t,s,n,o){return e.prep(4,16),e.writeFloat32(o),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}Yg(Gt,"Vec4");var Jg=Object.defineProperty,Zg=(i,e)=>Jg(i,"name",{value:e,configurable:!0});class q{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsVrUserStateBuffer(e,t){return(t||new q).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsVrUserStateBuffer(e,t){return e.setPosition(e.position()+Wr),(t||new q).__init(e.readInt32(e.position())+e.position(),e)}guid(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}time(){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt64(this.bb_pos+e):this.bb.createLong(0,0)}avatarId(e){const t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}position(e){const t=this.bb.__offset(this.bb_pos,10);return t?(e||new ae).__init(this.bb_pos+t,this.bb):null}rotation(e){const t=this.bb.__offset(this.bb_pos,12);return t?(e||new Gt).__init(this.bb_pos+t,this.bb):null}scale(){const e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readFloat32(this.bb_pos+e):0}posLeftHand(e){const t=this.bb.__offset(this.bb_pos,16);return t?(e||new ae).__init(this.bb_pos+t,this.bb):null}posRightHand(e){const t=this.bb.__offset(this.bb_pos,18);return t?(e||new ae).__init(this.bb_pos+t,this.bb):null}rotLeftHand(e){const t=this.bb.__offset(this.bb_pos,20);return t?(e||new Gt).__init(this.bb_pos+t,this.bb):null}rotRightHand(e){const t=this.bb.__offset(this.bb_pos,22);return t?(e||new Gt).__init(this.bb_pos+t,this.bb):null}static startVrUserStateBuffer(e){e.startObject(10)}static addGuid(e,t){e.addFieldOffset(0,t,0)}static addTime(e,t){e.addFieldInt64(1,t,e.createLong(0,0))}static addAvatarId(e,t){e.addFieldOffset(2,t,0)}static addPosition(e,t){e.addFieldStruct(3,t,0)}static addRotation(e,t){e.addFieldStruct(4,t,0)}static addScale(e,t){e.addFieldFloat32(5,t,0)}static addPosLeftHand(e,t){e.addFieldStruct(6,t,0)}static addPosRightHand(e,t){e.addFieldStruct(7,t,0)}static addRotLeftHand(e,t){e.addFieldStruct(8,t,0)}static addRotRightHand(e,t){e.addFieldStruct(9,t,0)}static endVrUserStateBuffer(e){return e.endObject()}static finishVrUserStateBufferBuffer(e,t){e.finish(t)}static finishSizePrefixedVrUserStateBufferBuffer(e,t){e.finish(t,void 0,!0)}}Zg(q,"VrUserStateBuffer");var Kg=Object.defineProperty,Bn=(i,e)=>Kg(i,"name",{value:e,configurable:!0});const Lh=v("debugxr"),ls=v("debugavatar");v("debugavatarvoip");var Vt;(function(i){i.WebXR_UserJoined="webxr-user-joined",i.WebXR_UserLeft="webxr-user-left",i.VRSessionStart="vr-session-started",i.VRSessionEnd="vr-session-ended",i.VRSessionUpdate="vr-session-update"})(Vt||(Vt={}));var Un;(function(i){i.VR="vr",i.AR="ar"})(Un||(Un={}));const Wo="VRUS";ln(Wo,q.getRootAsVrUserStateBuffer);function Nn(){return new Date().getTime()}Bn(Nn,"getTimeStampNow");function Th(i){let e=i&4294967295,t=i/Math.pow(2,32)&1048575;return Wf.create(e,t)}Bn(Th,"flatbuffers_long_from_number");const Us=class{constructor(e){r(this,"guid");r(this,"time");r(this,"avatarId");r(this,"position",new y);r(this,"rotation",new I);r(this,"scale",1);r(this,"posLeftHand",new y);r(this,"posRightHand",new y);r(this,"rotLeftHand",new P);r(this,"rotRightHand",new P);this.guid=e}update(e,t,s,n,o){var d,u,_,b,x,O;this.time=Nn(),this.avatarId=o,this.position.set(t.x,t.y,t.z),e&&this.position.applyMatrix4(e.matrixWorld);let a=Us.quat0;const l=Us.quat1;a.set(s.x,s.y,s.z,s.w),a=a.multiplyQuaternions(a,Us.invertRotation),e&&(e.getWorldQuaternion(l),a.multiplyQuaternions(l,a)),this.rotation.set(a.x,a.y,a.z,a.w),this.scale=e.scale.x;const c=(d=n.LeftController)==null?void 0:d.controllerGrip;c&&(c.getWorldPosition(this.posLeftHand),c.getWorldQuaternion(this.rotLeftHand));const h=(u=n.RightController)==null?void 0:u.controllerGrip;if(h&&(h.getWorldPosition(this.posRightHand),h.getWorldQuaternion(this.rotRightHand)),(b=(_=n.LeftController)==null?void 0:_.hand)==null?void 0:b.visible){const R=n.LeftController.wrist;R&&(R.getWorldPosition(this.posLeftHand),R.getWorldQuaternion(this.rotLeftHand))}if((O=(x=n.RightController)==null?void 0:x.hand)==null?void 0:O.visible){const R=n.RightController.wrist;R&&(R.getWorldPosition(this.posRightHand),R.getWorldQuaternion(this.rotRightHand))}}sendAsBuffer(e,t){e.clear();const s=e.createString(this.guid),n=e.createString(this.avatarId);q.startVrUserStateBuffer(e),q.addGuid(e,s),q.addTime(e,Th(this.time)),q.addAvatarId(e,n),q.addPosition(e,ae.createVec3(e,this.position.x,this.position.y,this.position.z)),q.addRotation(e,Gt.createVec4(e,this.rotation.x,this.rotation.y,this.rotation.z,this.rotation.w)),q.addScale(e,this.scale),q.addPosLeftHand(e,ae.createVec3(e,this.posLeftHand.x,this.posLeftHand.y,this.posLeftHand.z)),q.addPosRightHand(e,ae.createVec3(e,this.posRightHand.x,this.posRightHand.y,this.posRightHand.z)),q.addRotLeftHand(e,Gt.createVec4(e,this.rotLeftHand.x,this.rotLeftHand.y,this.rotLeftHand.z,this.rotLeftHand.w)),q.addRotRightHand(e,Gt.createVec4(e,this.rotRightHand.x,this.rotRightHand.y,this.rotRightHand.z,this.rotRightHand.w));const o=q.endVrUserStateBuffer(e);e.finish(o,Wo);const a=e.asUint8Array();t.sendBinary(a)}setFromBuffer(e,t){if(!e)return;this.guid=e,this.time=t.time().toFloat64();const s=t.avatarId();s&&(this.avatarId=s);const n=t.position();n&&this.position.set(n.x(),n.y(),n.z());const o=t.rotation();o&&this.rotation.set(o.x(),o.y(),o.z(),o.w());const a=t.posLeftHand();a&&this.posLeftHand.set(a.x(),a.y(),a.z());const l=t.posRightHand();l&&this.posRightHand.set(l.x(),l.y(),l.z());const c=t.rotLeftHand();c&&this.rotLeftHand.set(c.x(),c.y(),c.z(),c.w());const h=t.rotRightHand();h&&this.rotRightHand.set(h.x(),h.y(),h.z(),h.w()),this.scale=t.scale()}};let We=Us;r(We,"invertRotation",new P().setFromAxisAngle(new y(0,1,0),Math.PI)),r(We,"quat0",new P),r(We,"quat1",new P);Bn(We,"VRUserState");class cs extends w{constructor(){super(...arguments);r(this,"webXR",null);r(this,"debugAvatarUser",null);r(this,"voip",null);r(this,"tempState",new We(""));r(this,"_removeAvatarsList",[]);r(this,"eventSub_ConnectionEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"eventSub_WebXRUpdateEvent",null);r(this,"avatars",{});r(this,"localAvatar",null);r(this,"k_LocalAvatarNoNetworkingGuid","local");r(this,"ownership",null);r(this,"xrState",null);r(this,"builder",new Hs(1024))}async awake(){if(this.webXR||(this.webXR=this.gameObject.getComponent(E)),this.webXR||(this.webXR=p.findObjectOfType(E,this.context)),!this.webXR&&(console.log("Missing webxr component"),this.webXR=p.findObjectOfType(E,this.context),!this.webXR)){console.error("Could not find webxr component");return}if(this.voip||(this.voip=p.findObjectOfType(nt,this.context)),ls){const e="debug-avatar-"+ls,t=new rt(this.context,e,this.webXR);if(this.debugAvatarUser=t,typeof ls=="string"&&ls.length>0)if(await t.setAvatarOverride(ls)){const s=new We(e);s.position.y+=1;const n=.5;s.posLeftHand.y+=n,s.posLeftHand.x+=n,s.posRightHand.y+=n,s.posRightHand.x-=n,t.tryUpdate(s,0)}else t.destroy()}}onEnable(){if(!this.webXR&&(this.webXR=p.getComponent(this.gameObject,E),!this.webXR)){console.warn("Missing webxr component on "+this.gameObject.name);return}this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),E.addEventListener(G.XRStarted,this.eventSub_WebXRStartEvent),this.eventSub_WebXRUpdateEvent=this.onXRSessionUpdate.bind(this),E.addEventListener(G.XRUpdate,this.eventSub_WebXRUpdateEvent),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),E.addEventListener(G.XRStopped,this.eventSub_WebXREndEvent),this.eventSub_ConnectionEvent=this.onConnected.bind(this),this.context.connection.beginListen(H.JoinedRoom,this.eventSub_ConnectionEvent),this.context.connection.beginListen(Vt.WebXR_UserJoined,e=>{console.log("webxr user joined evt")}),this.context.connection.beginListen(Vt.WebXR_UserLeft,e=>{const t=e.id!==null&&e.id!==void 0;if(!!t&&(console.log("webxr user left evt"),t)){const s=this.avatars[e.id];s==null||s.destroy(),this.avatars[e.id]=void 0}}),this.context.connection.beginListenBinrary(Wo,e=>{const t=e.guid();if(!t)return;const s=e.time().toFloat64(),n=this.tempState;n.setFromBuffer(t,e);const o=this.onTryGetAvatar(t,s);o==null||o.tryUpdate(n,s)}),this.context.connection.beginListen(Vt.VRSessionUpdate,e=>{const t=e.guid,s=e.time,n=this.onTryGetAvatar(t,s);n==null||n.tryUpdate(e,s)})}onTryGetAvatar(e,t){if(e===this.context.connection.connectionId)return null;const s=new Date().getTime()-t;if(s>5e3)return Lh&&console.log("old data",s,e),null;let n=this.avatars[e];if(n===void 0)try{console.log("create new avatar");const o=new rt(this.context,e,this.webXR);n=o,this.avatars[e]=o}catch(o){this.avatars[e]=null,console.error(o)}return n}onDisable(){this.eventSub_ConnectionEvent&&this.context.connection.stopListening(H.JoinedRoom,this.eventSub_ConnectionEvent),E.removeEventListener(G.XRStarted,this.eventSub_WebXRStartEvent),E.removeEventListener(G.XRUpdate,this.eventSub_WebXRUpdateEvent),E.removeEventListener(G.XRStopped,this.eventSub_WebXREndEvent)}update(){const e=Nn();this.debugAvatarUser&&(this.debugAvatarUser.lastUpdate=e),this.detectPotentiallyDisconnectedAvatarsAndRemove();for(const t in this.avatars){const s=this.avatars[t];!s||s.update()}}detectPotentiallyDisconnectedAvatarsAndRemove(){const e=Nn();for(const t in this.avatars){const s=this.avatars[t];if(!s){this._removeAvatarsList.push(t);continue}e-s.lastUpdate>1e4&&(console.log("avatar timed out (didnt receive any updates in  a while) - destroying it now"),s.destroy(),this.avatars[t]=void 0)}for(const t of this._removeAvatarsList)delete this.avatars[t];this._removeAvatarsList.length=0}buildLocalAvatar(){var t,s;if(this.localAvatar)return;const e=(s=(t=this.context.connection)==null?void 0:t.connectionId)!=null?s:this.k_LocalAvatarNoNetworkingGuid;this.localAvatar=new rt(this.context,e,this.webXR),this.localAvatar.isLocalAvatar=!0,this.localAvatar.setAvatarOverride(this.getAvatarId()),this.avatars[this.localAvatar.guid]=this.localAvatar}onConnected(){var e,t,s;Lh&&console.log("Hey you are connected as "+this.context.connection.connectionId),((e=this.localAvatar)==null?void 0:e.guid)===this.k_LocalAvatarNoNetworkingGuid&&(this.localAvatar&&((t=this.localAvatar)==null||t.destroy(),this.avatars[this.localAvatar.guid]=void 0),this.localAvatar=null,this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null)}onXRSessionStart(e){var t,s,n;if(console.log("XR session started"),this.context.connection.send(Vt.WebXR_UserJoined,{id:this.context.connection.connectionId,mode:Un.VR}),this.localAvatar&&((t=this.localAvatar)==null||t.destroy(),this.avatars[this.localAvatar.guid]=void 0,this.localAvatar=null),this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null,this.avatars)for(const o in this.avatars)(n=this.avatars[o])==null||n.updateFlags()}onXRSessionEnded(e){console.log("XR session ended"),this.context.connection.send(Vt.WebXR_UserLeft,{id:this.context.connection.connectionId,mode:Un.VR})}onXRSessionUpdate(e){var h,d,u,_,b;(d=this.xrState)!=null||(this.xrState=new We((h=this.context.connection.connectionId)!=null?h:this.k_LocalAvatarNoNetworkingGuid)),(_=this.ownership)!=null||(this.ownership=new dn(this.context.connection,(u=this.context.connection.connectionId)!=null?u:this.k_LocalAvatarNoNetworkingGuid)),this.ownership.guid=(b=this.context.connection.connectionId)!=null?b:this.k_LocalAvatarNoNetworkingGuid,this.buildLocalAvatar();const{frame:t,xr:s,rig:n}=e,o=t.getViewerPose(s.getReferenceSpace());if(!o)return;const a=o==null?void 0:o.transform,l=a.position,c=a.orientation;this.xrState.update(n,l,c,this.webXR,this.getAvatarId()),this.localAvatar&&(this.context.connection.connectionId&&(this.localAvatar.guid=this.context.connection.connectionId),this.localAvatar.tryUpdate(this.xrState,0)),!(this.ownership&&!this.ownership.hasOwnership&&this.context.connection.isConnected&&(this.context.time.frameCount%120==0&&this.ownership.requestOwnership(),!this.ownership.hasOwnership))&&(!this.context.connection.isConnected||!this.context.connection.connectionId||this.xrState.sendAsBuffer(this.builder,this.context.connection))}getAvatarId(){return v("avatar")}}Bn(cs,"WebXRSync");var Dh=Object.defineProperty,e_=Object.getOwnPropertyDescriptor,Mh=(i,e)=>Dh(i,"name",{value:e,configurable:!0}),t_=(i,e,t,s)=>{for(var n=s>1?void 0:s?e_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Dh(e,t,n),n},G;(function(i){i.XRStarted="xrStarted",i.XRStopped="xrStopped",i.XRUpdate="xrUpdate",i.RequestVRSession="requestVRSession"})(G||(G={}));var Lr;const X=(Lr=class extends w{constructor(){super(...arguments);r(this,"enableVR",!0);r(this,"enableAR",!0);r(this,"defaultAvatar");r(this,"createVRButton",!0);r(this,"createARButton",!0);r(this,"controllers",[]);r(this,"rig");r(this,"isInit",!1);r(this,"_requestedAR",!1);r(this,"_requestedVR",!1);r(this,"_isInAR",!1);r(this,"_isInVR",!1);r(this,"_arButton");r(this,"_vrButton");r(this,"webAR",null);r(this,"_transformOrientation",new P);r(this,"_currentHeadPose",null);r(this,"_originalCameraParent",null);r(this,"_originalCameraPosition",new y);r(this,"_originalCameraRotation",new P);r(this,"xrMirrorWindow",null)}static get XRSupported(){return"xr"in navigator}static get IsInWebXR(){return this._isInXr}static addEventListener(i,e){this.events.addEventListener(i,e)}static removeEventListener(i,e){this.events.removeEventListener(i,e)}static createVRButton(i,e){var s;X.XRSupported||console.warn("WebXR is not supported on this device");const t=En.createButton(i.context.renderer);return t.classList.add("webxr-ar-button"),t.classList.add("webxr-button"),this.resetButtonStyles(t),((s=e==null?void 0:e.registerClick)!=null?s:!0)&&t.addEventListener("click",i.onClickedVRButton.bind(i)),t}static createARButton(i,e){var o,a;const t=(o=i.webAR)==null?void 0:o.trySetupOverlay(),s={requiredFeatures:["hit-test"]};t&&(s.domOverlay={root:t},s.optionalFeatures=["dom-overlay"]);const n=jg.createButton(i.context.renderer,s);return n.classList.add("webxr-ar-button"),n.classList.add("webxr-button"),X.resetButtonStyles(n),((a=e==null?void 0:e.registerClick)!=null?a:!0)&&n.addEventListener("click",i.onClickedARButton.bind(i)),n}static resetButtonStyles(i){!i||(i.style.position="",i.style.bottom="",i.style.left="")}endSession(){const i=this.context.renderer.xr.getSession();i&&i.end()}get Rig(){return this.rig}get Controllers(){return this.controllers}get LeftController(){var i,e;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="left"?this.controllers[0]:this.controllers.length>1&&((e=this.controllers[1].input)==null?void 0:e.handedness)==="left"?this.controllers[1]:null}get RightController(){var i,e;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="right"?this.controllers[0]:this.controllers.length>1&&((e=this.controllers[1].input)==null?void 0:e.handedness)==="right"?this.controllers[1]:null}awake(){if(this.defaultAvatar&&typeof this.defaultAvatar=="string"&&(this.defaultAvatar=$e.getOrCreate(this.defaultAvatar,this.context)),!p.findObjectOfType(cs,this.context)){const i=p.addNewComponent(this.gameObject,cs,!1);i.webXR=this}}onEnable(){if(this.isInit||!this.enableAR&&!this.enableVR)return;this.isInit=!0,this.context.renderer.xr.enabled=!0,this.webAR=new zn(this);const i=X.XRSupported;let e,t;const s=document.createElement("div");s.classList.add("webxr-buttons"),this.context.domElement.append(s),this.enableAR&&this.createARButton&&(e=X.createARButton(this),this._arButton=e,s.appendChild(e)),this.createVRButton&&this.enableVR&&(i||!this.enableAR)&&(t=X.createVRButton(this),this._vrButton=t,s.appendChild(t)),setTimeout(()=>{X.resetButtonStyles(t),X.resetButtonStyles(e)},1e3)}get TransformOrientation(){return this._transformOrientation}get HeadPose(){return this._currentHeadPose}onBeforeRender(i){var t;if(!i)return;const e=this.context.renderer.xr.getSession();if(e){const s=i.getViewerPose(this.context.renderer.xr.getReferenceSpace());if(this._currentHeadPose=s,!s)return;const n=s==null?void 0:s.transform;n&&this._transformOrientation.set(n.orientation.x,n.orientation.y,n.orientation.z,n.orientation.w);for(const o of this.controllers)o.onUpdate(e);this._isInAR&&((t=this.webAR)==null||t.onUpdate(e,i))}X._isInXr===!1&&e&&this.onEnterXR(e,i),X.events.dispatchEvent({type:G.XRUpdate,frame:i,xr:this.context.renderer.xr,rig:this.rig})}onClickedARButton(){this._isInAR||(this._requestedAR=!0,this._requestedVR=!1,this.captureCameraState())}onClickedVRButton(){if(!this._isInVR){if(this._requestedVR){this.onExitXR(null);return}this._requestedAR=!1,this._requestedVR=!0,this.captureCameraState(),this.ensureRig();for(let i=0;i<2;i++)j.Create(this,i,this.gameObject,Mn.PhysicalDevice);X.events.dispatchEvent({type:G.RequestVRSession})}}captureCameraState(){this.context.mainCamera&&(this._originalCameraPosition.copy(C(this.context.mainCamera)),this._originalCameraRotation.copy(K(this.context.mainCamera)),this._originalCameraParent=this.context.mainCamera.parent)}ensureRig(){if(!this.rig){const i=p.findObjectOfType(Fn,this.context);i?(this.rig=i.gameObject,this.rig.rotateY(Math.PI)):(this.rig=new Vf,this.rig.name="XRRig",this.context.scene.add(this.rig))}}onEnterXR(i,e){var o;console.log("[XR] session begin",i),X._isInXr=!0,this.ensureRig();const t=this.context.renderer.xr.getReferenceSpace();if(t&&this.rig){const a=e.getViewerPose(t),l=a==null?void 0:a.transform.orientation;if(l){const c=new P(l.x,l.y,l.z,l.w),h=new Oe().setFromQuaternion(c);this.rig.rotateY(h.y)}}const s=this.context.renderer.xr;if(this.context.mainCamera){const a=s.getCamera(this.context.mainCamera);for(const l of a.cameras)l.layers.enableAll();this.rig.add(this.context.mainCamera)}const n=this._requestedAR?Y.AR:Y.VR;switch(ze.Global.Set(n),n){case Y.AR:this._isInAR=!0,(o=this.webAR)==null||o.onBegin(i);break;case Y.VR:this._isInVR=!0,this.onEnterVR(i);break}i.addEventListener("end",()=>{console.log("[XR] session end"),X._isInXr=!1,this.onExitXR(i)}),this.onEnterXR_HandleMirrorWindow(i),X.events.dispatchEvent({type:G.XRStarted,session:i})}onExitXR(i){var e,t;this._isInAR&&i&&((e=this.webAR)==null||e.onEnd(i)),this._isInAR=!1,this._isInVR=!1,this._requestedAR=!1,this._requestedVR=!1,this.xrMirrorWindow&&(this.xrMirrorWindow.close(),this.xrMirrorWindow=null),this.destroyControllers(),this.context.mainCamera&&((t=this._originalCameraParent)==null||t.add(this.context.mainCamera),D(this.context.mainCamera,this._originalCameraPosition),ee(this.context.mainCamera,this._originalCameraRotation),this.context.mainCamera.scale.set(1,1,1)),ze.Global.Set(Y.Browser|Y.ThirdPerson),X.events.dispatchEvent({type:G.XRStopped,session:i})}onEnterVR(i){}destroyControllers(){var i;for(let e=this.controllers.length-1;e>=0;e-=1)(i=this.controllers[e])==null||i.destroy();this.controllers.length=0}onEnterXR_HandleMirrorWindow(i){!v("mirror")||setTimeout(()=>{if(!X.IsInWebXR)return;const e=new URL(window.location.href);Vi(e.searchParams,kn,1),Vi(e.searchParams,"isMirror",1);const t=e.toString();this.xrMirrorWindow=window.open(t,"webxr sync","popup=yes"),this.xrMirrorWindow&&(this.xrMirrorWindow.onload=()=>{this.xrMirrorWindow&&(this.xrMirrorWindow.onbeforeunload=()=>{X.IsInWebXR&&i.end()})})},1e3)}},r(Lr,"_isInXr",!1),r(Lr,"events",new Gf),Lr);let E=X;Mh(E,"WebXR");t_([g($e)],E.prototype,"defaultAvatar",2);class zn{constructor(e){r(this,"webxr");r(this,"reticle",null);r(this,"hitTestSource",null);r(this,"reticleActive",!0);r(this,"previousBackground",null);r(this,"previousEnvironment",null);r(this,"sessionRoot",null);r(this,"_previousParent",null);r(this,"arDomOverlay",null);r(this,"arOverlayElement",null);this.webxr=e}get context(){return this.webxr.context}trySetupOverlay(){return this.arDomOverlay=this.webxr.context.domElement,"getAROverlayContainer"in this.arDomOverlay&&(this.arOverlayElement=this.arDomOverlay.getAROverlayContainer()),this.arOverlayElement}setReticleActive(e){this.reticleActive=e}onBegin(e){var s,n;const t=this.webxr.context;this.reticleActive=!0;for(let o=0;o<4;o++)j.Create(this.webxr,o,this.webxr.gameObject,Mn.Touch);(!this.sessionRoot||this.sessionRoot.destroyed||!this.sessionRoot.activeAndEnabled)&&(this.sessionRoot=p.findObjectOfType(as,t)),this.previousBackground=t.scene.background,this.previousEnvironment=t.scene.environment,t.scene.background=null,e.requestReferenceSpace("viewer").then(o=>{e.requestHitTestSource({space:o}).then(a=>{this.hitTestSource=a})}),this.reticle||(this.reticle=new ni(new Hf(.07,.09,32).rotateX(-Math.PI/2),new zi),this.reticle.name="AR Placement reticle",this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.webxr.scene?(this.webxr.scene.add(this.reticle),this.webxr.scene.visible=!0):console.warn("Could not found WebXR Rig")),this._previousParent=this.webxr.gameObject,this.context.scene.add(this.webxr.gameObject),this.sessionRoot&&(this.sessionRoot.webAR=this,(s=this.sessionRoot)==null||s.onBegin(e)),this.arDomOverlay&&this.arOverlayElement&&this.arDomOverlay.onEnterAR(e,this.arOverlayElement),(n=this.context.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}onEnd(e){var s;this._previousParent&&(this._previousParent!==this.webxr.gameObject&&this._previousParent.add(this.webxr.gameObject),this._previousParent=null),this.hitTestSource=null;const t=this.webxr.context;t.scene.background=this.previousBackground,t.scene.environment=this.previousEnvironment,this.sessionRoot&&this.sessionRoot.onEnd(this.webxr.Rig,e),this.arDomOverlay&&this.arDomOverlay.onExitAR(e),(s=this.context.mainCameraComponent)==null||s.applyClearFlagsIfIsActiveCamera()}onUpdate(e,t){var n,o;if(!this.hitTestSource)return;const s=t.getHitTestResults(this.hitTestSource);if(s.length){const a=s[0],l=this.webxr.context.renderer.xr.getReferenceSpace();if(l){const c=a.getPose(l);if((n=this.sessionRoot)==null||n.onUpdate(this.webxr.Rig,e,c),this.reticle&&(this.reticle.visible=this.reticleActive,this.reticleActive&&c)){const h=c.transform.matrix;this.reticle.matrix.fromArray(h),this.webxr.Rig&&this.reticle.matrix.premultiply(this.webxr.Rig.matrix)}}}else(o=this.sessionRoot)==null||o.onUpdate(this.webxr.Rig,e,null),this.reticle&&(this.reticle.visible=!1)}}Mh(zn,"WebAR");var i_=Object.defineProperty,Ih=(i,e)=>i_(i,"name",{value:e,configurable:!0}),hs;(function(i){i.SelectStart="selectstart",i.SelectEnd="selectend"})(hs||(hs={}));const Fi=class extends fi{constructor(){super();r(this,"transformSelf",!0);r(this,"selectStartEventListener",[]);r(this,"selectEndEventListener",[]);r(this,"_dragHelper",null);r(this,"_draggingRigidbodies",[]);r(this,"_waitingForDragStart",null);r(this,"_isDragging",!1);r(this,"_marker",null);r(this,"_dragDelta");r(this,"_didDrag",!1);this.selectStartEventListener=[],this.selectEndEventListener=[],this._dragDelta=new z}static get HasAnySelected(){return this._active!==null}addEventListener(e,t){switch(e){case hs.SelectStart:this.selectStartEventListener.push(t);break;case hs.SelectEnd:this.selectEndEventListener.push(t);break}}start(){}allowEdit(e=null){return this.context.connection.allowEditing}onPointerEnter(e){if(!this.allowEdit(this.gameObject)||E.IsInWebXR)return;const t=p.getComponentInParent(e.object,Fi);!t||t!==this||(Fi.lastHovered=e.object,this.context.domElement.style.cursor="pointer")}onPointerExit(e){!this.allowEdit(this.gameObject)||E.IsInWebXR||Fi.lastHovered===e.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(e){!this.allowEdit(this.gameObject)||E.IsInWebXR||(this._dragDelta.set(0,0),this._didDrag=!1,this._waitingForDragStart=e,e.StopPropagation())}onPointerUp(e){this._waitingForDragStart=null,!!this.allowEdit(this.gameObject)&&(E.IsInWebXR||(this.onDragEnd(e),e.StopPropagation()))}update(){var e;if(!E.IsInWebXR){if(this._waitingForDragStart){if(!this._didDrag){const s=this.context.input.getPointerPositionDelta(0);if(s&&this._dragDelta.add(s),this._dragDelta.length()>2)this._didDrag=!0;else return}const t=this._waitingForDragStart;this._waitingForDragStart=null,this.onDragStart(t)}this._dragHelper&&this._dragHelper.hasSelected&&this.onUpdateDrag(),this._isDragging&&!((e=this._dragHelper)==null?void 0:e.hasSelected)&&this.onDragEnd(null)}}onDragStart(e){if(!this._dragHelper)if(this.context.mainCamera)this._dragHelper=new $n(this.context.mainCamera);else return;if(!e||!e.object)return;const t=p.getComponentInParent(e.object,Fi);if(!t||t!==this)return;let s=e.object;this.transformSelf&&(s=this.gameObject);const n={selected:s,attached:s};for(const c of this.selectStartEventListener)c(this,n);if(!n.attached)return;n.attached!==s,s=n.attached,this._isDragging=!0,this._dragHelper.setSelected(s,this.context);const o=p.getComponentInChildren(s,st);o&&(o.fastMode=!0,o==null||o.requestOwnership()),this._marker=p.addNewComponent(s,pi),this._draggingRigidbodies.length=0;const a=p.getComponentsInChildren(s,Re);a&&this._draggingRigidbodies.push(...a);const l=Vr();p.invokeOnChildren(this._dragHelper.selected,l("onDragStart"))}onUpdateDrag(){if(!!this._dragHelper){this._dragHelper.onUpdate(this.context);for(const e of this._draggingRigidbodies)e.wakeUp(),e.setBodyFromGameObject()}}onDragEnd(e){if(!this||!this._isDragging||(this._isDragging=!1,!this._dragHelper))return;this._draggingRigidbodies.length=0;const t=this._dragHelper.selected;if(this._dragHelper.setSelected(null,this.context),e==null?void 0:e.object){const n=p.getComponentInChildren(e.object,st);n&&(n.fastMode=!1),this._marker&&this._marker.destroy()}for(const n of this.selectEndEventListener)n(this);const s=Vr();p.invokeOnChildren(t,s("onDragEnd"))}};let ot=Fi;r(ot,"_active",null),r(ot,"lastHovered");Ih(ot,"DragControls");const hl=class{constructor(e){r(this,"_selected",null);r(this,"_context",null);r(this,"_camera");r(this,"_cameraPlane",new Rl);r(this,"_hasGroundPlane",!1);r(this,"_groundPlane",new Rl);r(this,"_groundOffset",new y);r(this,"_groundOffsetFactor",0);r(this,"_groundDistance",0);r(this,"_groundPlanePoint",new y);r(this,"_raycaster",new Fr);r(this,"_cameraPlaneOffset",new y);r(this,"_intersection",new y);r(this,"_worldPosition",new y);r(this,"_inverseMatrix",new Ce);r(this,"_rbs",[]);r(this,"_groundLine");r(this,"_groundMarker");r(this,"_groundOffsetVector",new y(0,1,0));r(this,"_requireUpdateGroundPlane",!0);r(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=e;const t=new Ol(hl.geometry),s=t.material;s.color=new f(.4,.4,.4),t.layers.set(2),t.name="line",t.scale.y=1,this._groundLine=t;const n=new Cl(.5,22,22),o=new zi({color:s.color}),a=new ni(n,o);a.visible=!1,a.layers.set(2),this._groundMarker=a}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(e,t){if(this._selected&&t)for(const s of this._rbs)s.wakeUp(),!!s.smoothedVelocity&&s.setVelocity(s.smoothedVelocity.x,s.smoothedVelocity.y,s.smoothedVelocity.z);if(this._selected&&ie.Remove(t,this._selected),this._selected=e,this._context=t,this._rbs.length=0,e?(t.scene.add(this._groundLine),t.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!t){console.error("DragHelper: no context");return}ie.Add(t,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this._rbs=p.getComponentsInChildren(this._selected,Re),this.onUpdateScreenSpacePlane()}}onUpdate(e){var l,c,h,d,u;if(!this._context)return;const t=Ze.SPACE,s=Ze.KEY_D;Ze.KEY_S;const n=((l=this._context)==null?void 0:l.input.isKeyPressed(t))||((c=this._context)==null?void 0:c.input.isKeyPressed(s)),o=this._context.input.getTouchesPressedCount()>=2||n;if(o){const _=this._context.input.getPointerPositionDelta(0);_&&(this._groundOffsetVector.set(0,1,0),(h=this._selected)==null||h.rotateOnWorldAxis(this._groundOffsetVector,_.x*this._context.time.deltaTime))}const a=this._context.input.getPointerPositionRC(0);if(!!a&&(this._raycaster.setFromCamera(a,this._camera),this._selected)){this._groundOffsetVector.set(0,1,0);const _=C(this._camera).clone().sub(C(this._selected)).normalize(),b=Math.abs(_.dot(this._groundOffsetVector)),x=((d=this._context)==null?void 0:d.input.isKeyPressed(t))||((u=this._context)==null?void 0:u.input.isKeyPressed(s)),O=!o&&b>.2&&!x&&this._context.input.getPointerPressedCount()<=1,R=this._didDragOnGroundPlaneLastFrame!==O;if(this._didDragOnGroundPlaneLastFrame=O,this._hasGroundPlane||(this._requireUpdateGroundPlane=!0),(this._requireUpdateGroundPlane||!O||R)&&this.onUpdateGroundPlane(),this._requireUpdateGroundPlane=!1,this._hasGroundPlane)if(this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection)){const M=this._intersection.y;if(this._groundPlanePoint.copy(this._intersection).sub(this._groundOffset),this._groundPlanePoint.y=M,O){this._groundOffsetVector.set(0,1,0);const ce=this._intersection.sub(this._groundOffset).add(this._groundOffsetVector.multiplyScalar(this._groundOffsetFactor));this.onUpdateWorldPosition(ce,this._groundPlanePoint,!1),this.onDidUpdate();return}}else this._groundPlanePoint.set(0,99999,0);R&&this.onUpdateScreenSpacePlane(),this._requireUpdateGroundPlane=!0,this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&(this.onUpdateWorldPosition(this._intersection.sub(this._cameraPlaneOffset),this._groundPlanePoint,!0),this.onDidUpdate())}}onUpdateWorldPosition(e,t,s){if(!!this._selected){if(s){const n=C(this._selected);n.y=e.y,e=n}if(D(this._selected,e),D(this._groundLine,e),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundMarker.visible=t!==null,t){const n=C(this._camera).distanceTo(t)*.01;this._groundMarker.scale.set(n,n,n),D(this._groundMarker,t)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const e=this._context.input.getPointerPositionRC(0);!e||(this._raycaster.setFromCamera(e,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const e=C(this._selected),t=new Sl(new y(0,.1,0).add(e),new y(0,-1,0)),s=new je;s.ignore=[this._selected];const n=this._context.physics.raycastFromRay(t,s);for(let o=0;o<n.length;o++){const a=n[o];if(!a.face||this.contains(this._selected,a.object))continue;const l=new y(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,a.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(t.direction.multiplyScalar(-1),t.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(e),this._groundOffset.copy(this._intersection).sub(e)}onDidUpdate(){re.markDirty(this._selected);for(const e of this._rbs)e.wakeUp(),e.setBodyFromGameObject({x:0,y:0,z:0}),e.setAngularVelocity(0,0,0)}contains(e,t){if(e===t)return!0;if(e.children){for(const s of e.children)if(this.contains(s,t))return!0}return!1}};let $n=hl;r($n,"geometry",new Gs().setFromPoints([new y(0,0,0),new y(0,-1,0)]));Ih($n,"DragHelper");var jh=Object.defineProperty,s_=Object.getOwnPropertyDescriptor,Fh=(i,e)=>jh(i,"name",{value:e,configurable:!0}),Bh=(i,e,t,s)=>{for(var n=s>1?void 0:s?s_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&jh(e,t,n),n},Ho;(function(i){i.ObjectAdded="object-added"})(Ho||(Ho={}));class Uh extends w{constructor(){super(...arguments);r(this,"_listeners",{})}addEventListener(e,t,s){!t||(this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(t))}dispatchEvent(e){if(!e||!this._listeners[e.type])return!1;for(const t of this._listeners[e.type])"handleEvent"in t?t.handleEvent(e):t(e);return!0}removeEventListener(e,t,s){!t||!this._listeners[e]||(this._listeners[e]=this._listeners[e].filter(n=>n!==t))}}Fh(Uh,"EventTargetBehaviour");class ds extends Uh{constructor(){super(...arguments);r(this,"filesBackendUrl");r(this,"localhost");r(this,"_dragOver");r(this,"_drop")}onEnable(){this.filesBackendUrl=this.filesBackendUrl?wt.GetUrl(this.filesBackendUrl,this.localhost):void 0,this._dragOver=this.onDrag.bind(this),this._drop=this.onDrop.bind(this),this.context.domElement.addEventListener("dragover",this._dragOver),this.context.domElement.addEventListener("drop",this._drop)}onDisable(){this.context.domElement.removeEventListener("dragover",this._dragOver),this.context.domElement.removeEventListener("drop",this._drop)}onDrag(e){e.preventDefault()}async onDrop(e){if(console.log(e),!e.dataTransfer)return;e.preventDefault();const t=e.dataTransfer.items;if(!!t)for(const s in t){const n=t[s];if(n.kind==="file"){const o=n.getAsFile();if(!o)continue;console.log("Register file "+o.name+" to",this.filesBackendUrl);const a=await Ju(o,this.context,this.filesBackendUrl);a&&this.addObject(e,a)}else n.kind==="string"&&n.type=="text/plain"&&n.getAsString(async o=>{console.log("dropped url",o);try{const a=new URL(o);if(!a)return;const l=await Zu(a,this.context);l&&this.addObject(e,l)}catch{console.log("dropped string is not a valid URL!",o)}})}}async addObject(e,t){const s=new je;s.setMask(16777215),s.screenPointFromOffset(e.offsetX,e.offsetY);const n=this.context.physics.raycast(s);if(n&&n.length>0)for(const o of n){t.position.copy(o.point);break}this.gameObject.add(t),this.dispatchEvent(new CustomEvent(Ho.ObjectAdded,{detail:t}))}}Fh(ds,"DropListener");Bh([g()],ds.prototype,"filesBackendUrl",2);Bh([g()],ds.prototype,"localhost",2);var Nh=Object.defineProperty,n_=Object.getOwnPropertyDescriptor,r_=(i,e)=>Nh(i,"name",{value:e,configurable:!0}),Wn=(i,e,t,s)=>{for(var n=s>1?void 0:s?n_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Nh(e,t,n),n};class qt extends fi{constructor(){super(...arguments);r(this,"parent",null);r(this,"object",null);r(this,"limitCount",10);r(this,"limitInterval",60);r(this,"_currentCount",0);r(this,"_startPosition",null);r(this,"_startQuaternion",null)}awake(){var t,s,n,o;if(this.object){if(this.object===this.gameObject){console.error("Can not duplicate self");return}this.object.visible=!1,this._startPosition=(s=(t=this.object.position)==null?void 0:t.clone())!=null?s:new y(0,0,0),this._startQuaternion=(o=(n=this.object.quaternion)==null?void 0:n.clone())!=null?o:new P(0,0,0,1)}const e=p.getComponentInParent(this.gameObject,ot);e?e.addEventListener(hs.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.attached=null;return}const c=this.handleDuplication(l.selected);c&&(console.assert(c!==l.selected,"Duplicated object is original"),l.attached=c)}):console.warn("Could no find drag controls in parent",this.name),j.addEventListener(pe.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.grab=null;return}const c=this.handleDuplication(l.selected);c&&(l.grab=c)}),this.cloneLimitIntervalFn()}cloneLimitIntervalFn(){this.destroyed||(this._currentCount>0&&(this._currentCount-=1),setTimeout(()=>{this.cloneLimitIntervalFn()},this.limitInterval/this.limitCount*1e3))}handleDuplication(e){var t,s;if(this._currentCount>=this.limitCount||!this.object)return null;if(e===this.gameObject||this.handleMultiObject(e)){if(this.object===this.gameObject)return null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const n=new we;this.parent||(this.parent=this.gameObject.parent),this.parent&&(n.parent=(s=this.parent.guid)!=null?s:(t=this.parent.userData)==null?void 0:t.guid,n.keepWorldPosition=!0),n.position=this.worldPosition,n.rotation=this.worldQuaternion,n.context=this.context,this._currentCount+=1;const o=p.instantiateSynced(this.object,n);return console.assert(o!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),o}return null}handleMultiObject(e){return this.gameObject.type==="Group"||this.gameObject.type==="Object3D"?this.isInChildren(this.gameObject,e):!1}isInChildren(e,t){if(!e)return!1;if(e===t)return!0;if(e.children){for(let s of e.children)if(this.isInChildren(s,t))return!0}return!1}}r_(qt,"Duplicatable");Wn([g(S)],qt.prototype,"parent",2);Wn([g(S)],qt.prototype,"object",2);Wn([g()],qt.prototype,"limitCount",2);Wn([g()],qt.prototype,"limitInterval",2);var o_=Object.defineProperty,zh=(i,e)=>o_(i,"name",{value:e,configurable:!0});class _i{constructor(e,t){r(this,"method");r(this,"enabled");this.method=e,this.enabled=t!==void 0?t:!0}invoke(...e){if(this.enabled!==!1){if(!this.method){console.warn("No function. Please check you assigned a method to invoke on export",this);return}this.method(...e)}}}zh(_i,"CallInfo");class He{constructor(e){r(this,"methods",[]);this.methods=e!=null?e:[]}invoke(...e){for(const t of this.methods)t.invoke(...e)}addEventListener(e){return this.methods.push(new _i(e,!0)),e}removeEventListener(e){if(!!e)for(let t=this.methods.length-1;t>=0;t--)this.methods[t].method===e&&(this.methods[t].enabled=!1,this.methods.splice(t,1))}removeAllEventListeners(){this.methods.length=0}}zh(He,"EventList");var a_=Object.defineProperty,l_=(i,e)=>a_(i,"name",{value:e,configurable:!0});class Go extends w{}l_(Go,"EventTrigger");var c_=Object.defineProperty,h_=(i,e)=>c_(i,"name",{value:e,configurable:!0});class Vo extends w{constructor(){super(...arguments);r(this,"_controls",null)}onEnable(){var t;const e=(t=p.getComponent(this.gameObject,F))==null?void 0:t.cam;this._controls=new qf(e,this.context.renderer.domElement),this._controls.rollSpeed=.5,this._controls.movementSpeed=3,this._controls.dragToLook=!0}onDisable(){var e;(e=this._controls)==null||e.dispose(),this._controls=null}update(){this._controls&&this._controls.update(this.context.time.deltaTime)}}h_(Vo,"FlyControls");var $h=Object.defineProperty,d_=Object.getOwnPropertyDescriptor,u_=(i,e)=>$h(i,"name",{value:e,configurable:!0}),Wh=(i,e,t,s)=>{for(var n=s>1?void 0:s?d_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&$h(e,t,n),n};class us extends w{constructor(){super(...arguments);r(this,"objectBounds",!1);r(this,"color");r(this,"_gizmoObject",null);r(this,"_boxHelper",null)}onEnable(){var e,t;!Zi||(this._gizmoObject||(this.objectBounds&&this.gameObject.isMesh===!0?this._gizmoObject=new El(this.gameObject,(e=this.color)!=null?e:16776960):(this.objectBounds=!1,this._gizmoObject=jo((t=this.color)!=null?t:16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),Pe.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var e;for(;this._boxHelper;)(e=this._boxHelper)==null||e.update(),yield}}u_(us,"BoxGizmo");Wh([g()],us.prototype,"objectBounds",2);Wh([g(f)],us.prototype,"color",2);class f_{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(e.constructor.name!=="InstancedMesh")return;const s=this.writer,n=s.extensionsUsed,o={};t.extensions=t.extensions||{},t.extensions[this.name]=o;let a=new Ce;const l=new Array,c=new Array,h=new Array;for(let b=0;b<e.count;b++){e.getMatrixAt(b,a);let x=new y,O=new P,R=new y;a.decompose(x,O,R),l.push(x.x,x.y,x.z),c.push(O.x,O.y,O.z,O.w),h.push(R.x,R.y,R.z)}const d=new Float32Array(l),u=new Float32Array(c),_=new Float32Array(h);o.attributes={TRANSLATION:s.processAccessor(new $i(d,3)),ROTATION:s.processAccessor(new $i(u,4)),SCALE:s.processAccessor(new $i(_,3))},n[this.name]=!0}}var p_=Object.defineProperty,qo=(i,e)=>p_(i,"name",{value:e,configurable:!0});const Et=ve,Hn="$___Export_Components",m_="NEEDLE_components";var mw;class Hh{constructor(){r(this,mw)}}mw=ri;qo(Hh,"ExtensionData");class Gh{constructor(e,t,s){r(this,"node");r(this,"nodeIndex");r(this,"nodeDef");this.node=e,this.nodeIndex=t,this.nodeDef=s}}qo(Gh,"ExportData");class Xo{constructor(){r(this,"parser");r(this,"nodeToObjectMap",{});r(this,"exportContext");r(this,"objectToNodeMap",{});r(this,"context");r(this,"writer")}get name(){return m_}registerExport(e){e.register(t=>{const s=t.serializeUserData.bind(t);return this.writer=t,t.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o),s(n,o)}finally{this.afterSerializeUserData(n,o)}},this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(e,t){var n;const s=(n=e.userData)==null?void 0:n.components;!s||s.length<=0||(delete e.userData.components,e[Hn]=s)}afterSerializeUserData(e,t){if(e.type==="Scene"&&Et&&console.log("DONE",JSON.stringify(t)),e[Hn]===void 0)return;const s=e[Hn];delete e[Hn],s!==null&&(e.userData.components=s)}writeNode(e,t){let s=this.writer.json.nodes.length;console.log(e.name,s,e.uuid);const n=new Gh(e,s,t);this.exportContext[s]=n,this.objectToNodeMap[e.uuid]=s}afterParse(e){var t;Et&&console.log("AFTER",e);for(const s in this.exportContext){const n=this.exportContext[s],o=n.node,a=n.nodeDef,l=n.nodeIndex,c=(t=o.userData)==null?void 0:t.components;if(!c||c.length<=0)continue;const h=new Hh;a.extensions=a.extensions||{},a.extensions[this.name]=h,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const d=[];for(const u of c){this.context.target=u;const _=bu(u,this.context);_!==null&&d.push(_)}d.length>0&&(h[ri]=d,Et&&console.log("DID WRITE",o,"nodeIndex",l,d))}}beforeRoot(){return Et&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(e){const t=e.parser,s=t==null?void 0:t.extensions;if(!s)return;const n=s[this.name];Et&&console.log("After root",e,this.parser,s);const o=[];if(n===!0){const a=t.json.nodes;for(let l=0;l<a.length;l++){const c=await t.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<a.length;l++){const c=a[l],h=l,d=c.extensions;if(!d)continue;const u=d[this.name];if(!u)continue;Et&&console.log("NODE",c);const _=this.nodeToObjectMap[h];if(!_){console.error("Could not find object for node index: "+h,c,t);continue}o.push(this.createComponents(_,u))}}await Promise.all(o)}async createComponents(e,t){if(!t)return;const s=t[ri];if(s){Et&&console.log(e.name,s);for(const n in s){const o=s[n];Et&&console.log("Serialized data",JSON.parse(JSON.stringify(o))),o&&this.parser&&await pn(this.parser,o),e.userData=e.userData||{},e.userData[ri]=e.userData[ri]||[],e.userData[ri].push(o)}}}}qo(Xo,"NEEDLE_components");var g_=Object.defineProperty,Vh=(i,e)=>g_(i,"name",{value:e,configurable:!0});class Qo extends ui{constructor(){super(...arguments);r(this,"sceneRoot")}start(){this.startCoroutine(this.updateGltfBox())}*updateGltfBox(){for(;;)for(let e=0;e<10;e++)yield}}Vh(Qo,"GltfExportBox");class at extends w{constructor(){super(...arguments);r(this,"binary",!0);r(this,"objects",[]);r(this,"exporter");r(this,"ext")}async exportNow(e){console.log("DO EXPORT",this.objects);const t={binary:this.binary,pivot:at.calculateCenter(this.objects)},s=await this.export(this.objects,t);this.binary?e.endsWith(".glb")||(e+=".glb"):e.endsWith(".gltf")||(e+=".gltf"),this.binary?at.saveArrayBuffer(s,e):at.saveJson(s,e)}async export(e,t){var l;if(e===null||e.length<=0){console.log("no objects set to export");return}this.exporter||(this.exporter=new Xf,this.exporter.register(c=>new f_(c)),this.ext=new Xo,this.ext.registerExport(this.exporter)),at.filterTopmostParent(e);const s={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:(l=t==null?void 0:t.binary)!=null?l:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:at.collectAnimations(e)},n=new S;(t==null?void 0:t.pivot)&&n.position.sub(t.pivot),console.log("EXPORT",e),e.forEach(c=>{c&&(n.children.push(c),c.matrixAutoUpdate=!1,c.matrix.copy(c.matrixWorld),p.getComponentsInChildren(c,de).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))});const o=new Co(n);return this.ext.context=o,new Promise((c,h)=>{var d;try{(d=this.exporter)==null||d.parse(n,u=>{a(),c(u)},u=>{a(),h(u)},s)}catch(u){console.error(u),h(u)}finally{console.log("FINALLY")}});function a(){e.forEach(c=>{!c||(c.matrixAutoUpdate=!0,p.getComponentsInChildren(c,de).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(e,t){this.save(new Blob([e],{type:"application/octet-stream"}),t)}static saveJson(e,t){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),t)}static save(e,t){const s=document.createElement("a");s.style.display="none",document.body.appendChild(s),typeof e=="string"?s.href=e:s.href=URL.createObjectURL(e),s.download=t,s.click(),s.remove()}static collectAnimations(e,t){t=t||[];for(const s of e)!s||s.traverseVisible(n=>{n.animations&&n.animations.length>0&&t.push(...n.animations)});return t}static calculateCenter(e,t){const s=t||new y;return s.set(0,0,0),e.forEach(n=>{s.add(C(n))}),console.log(s),s.divideScalar(e.length),s}static filterTopmostParent(e){if(!(e.length<=0))for(let t=0;t<e.length;t++){let s=e[t];if(!s){e.splice(t,1),t--;continue}for(;s.parent;){if(e.includes(s.parent)){e.splice(t,1),t--;break}s=s.parent}}}}Vh(at,"GltfExport");var qh=Object.defineProperty,__=Object.getOwnPropertyDescriptor,b_=(i,e)=>qh(i,"name",{value:e,configurable:!0}),Yo=(i,e,t,s)=>{for(var n=s>1?void 0:s?__(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&qh(e,t,n),n};class bi extends w{constructor(){super(...arguments);r(this,"isGizmo",!1);r(this,"color0");r(this,"color1");r(this,"gridHelper");r(this,"size");r(this,"divisions");r(this,"offset")}onEnable(){var s,n;if(this.isGizmo&&!Zi)return;const e=this.size,t=this.divisions;this.gridHelper||(this.gridHelper=new Qf(e,t,(s=this.color0)!=null?s:new f(.4,.4,.4),(n=this.color1)!=null?n:new f(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset),this.gameObject.add(this.gridHelper))}}b_(bi,"GridHelper");Yo([g()],bi.prototype,"isGizmo",2);Yo([g(f)],bi.prototype,"color0",2);Yo([g(f)],bi.prototype,"color1",2);var Xh=Object.defineProperty,y_=Object.getOwnPropertyDescriptor,Jo=(i,e)=>Xh(i,"name",{value:e,configurable:!0}),fs=(i,e,t,s)=>{for(var n=s>1?void 0:s?y_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Xh(e,t,n),n};const yi=v("debugLODs"),w_=v("noLODs");var Qh;(function(i){i[i.None=0]="None",i[i.CrossFade=1]="CrossFade",i[i.SpeedTree=2]="SpeedTree"})(Qh||(Qh={}));class Xt{constructor(){r(this,"screenRelativeTransitionHeight");r(this,"distance");r(this,"renderers")}}Jo(Xt,"LODModel");fs([g()],Xt.prototype,"screenRelativeTransitionHeight",2);fs([g()],Xt.prototype,"distance",2);fs([g()],Xt.prototype,"renderers",2);class Yh{constructor(e,t){r(this,"model");r(this,"renderers");this.model=t,this.renderers=[];for(const s of t.renderers){const n=this.findRenderer(s,e.gameObject);n&&n.gameObject?this.renderers.push(n):yi&&console.warn("Renderer not found: "+s,e.gameObject)}}findRenderer(e,t){const s=p.foreachComponent(t,n=>{var a;return n.guid===e||((a=Object.getPrototypeOf(n))==null?void 0:a.guid)===e?n:null});if(s)return s;for(const n of t.children){const o=this.findRenderer(e,n);if(o)return o}return null}}Jo(Yh,"LOD");class ps extends w{constructor(){super(...arguments);r(this,"fadeMode",0);r(this,"localReferencePoint");r(this,"lodCount",0);r(this,"size",0);r(this,"animateCrossFading",!1);r(this,"lodModels");r(this,"_lods",[]);r(this,"_settings",[]);r(this,"_lodsHandler");r(this,"_distanceFactor",1)}start(){if(!w_&&!this._lodsHandler&&!!this.gameObject&&(yi&&console.log(this),this.lodModels&&Array.isArray(this.lodModels))){let e=0,t=[];for(const n of this.lodModels){e=Math.max(n.distance,e);const o=new Yh(this,n);this._lods.push(o);for(const a of o.renderers)t.includes(a)||t.push(a)}this._lodsHandler=new Array;for(let n=0;n<t.length;n++){const o=new Yf;this._lodsHandler.push(o),this.gameObject.add(o)}const s=new S;yi&&console.log(t);for(let n=0;n<t.length;n++){const o=t[n],a=this._lodsHandler[n],l=o.gameObject;let c=0,h=0;yi&&console.log(n,l.name);for(const u of this._lods){let _=null;u.renderers.includes(o)?_=l:_=s,yi&&console.log("add",u.model.distance,_.name);const b=u.model.distance;h=b-c,c=Math.max(b,c),this.onAddLodLevel(a,_,b)}const d=c+h;yi&&console.log("cull",d),this.onAddLodLevel(a,s,d)}}}update(){if(!this.gameObject||!this._lodsHandler)return;const e=this.context.mainCamera;if(!!e)for(const t of this._lodsHandler)t.update(e)}onAddLodLevel(e,t,s){e.addLevel(t,s*this._distanceFactor);const n={lod:e,levelIndex:e.levels.length-1,distance:s};this._settings.push(n)}distanceFactor(e){if(e!==this._distanceFactor){this._distanceFactor=e;for(const t of this._settings){const s=t.lod.levels[t.levelIndex];s.distance=t.distance*e}}}}Jo(ps,"LODGroup");fs([g(y)],ps.prototype,"localReferencePoint",2);fs([g(Xt)],ps.prototype,"lodModels",2);var Jh=Object.defineProperty,v_=Object.getOwnPropertyDescriptor,Zo=(i,e)=>Jh(i,"name",{value:e,configurable:!0}),wi=(i,e,t,s)=>{for(var n=s>1?void 0:s?v_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Jh(e,t,n),n};function x_(i){return i*180/Math.PI}Zo(x_,"toDegrees");function Gn(i){return i*Math.PI/180}Zo(Gn,"toRadians");const Zh=300,Kh=v("debuglights");var ed;(function(i){i[i.Realtime=4]="Realtime",i[i.Baked=2]="Baked",i[i.Mixed=1]="Mixed"})(ed||(ed={}));class lt extends w{constructor(){super(...arguments);r(this,"type",0);r(this,"intensity",1);r(this,"range",1);r(this,"spotAngle",1);r(this,"innerSpotAngle",1);r(this,"color",new f(16777215));r(this,"shadowNearPlane",.1);r(this,"shadowBias",0);r(this,"shadowNormalBias",1);r(this,"shadows",Vn.None);r(this,"lightmapBakeType",4);r(this,"light")}get isBaked(){return this.lightmapBakeType===2}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(e){return this.light?this.type===ct.Directional?this.light.getWorldPosition(e).multiplyScalar(1):this.light.getWorldPosition(e):e}onEnable(){this.createLight(),!this.isBaked&&(this.light&&(this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===ct.Directional&&this.startCoroutine(this.updateMainLightRoutine(),Pe.LateUpdate))}createLight(){if(this.light)return;let e=this.selfIsLight;if(e)switch(this.light=this.gameObject,this.type){case ct.Directional:this.setDirectionalLight(this.light);break}else switch(this.type){case ct.Directional:const t=new Kf(this.color,this.intensity*Math.PI);if(t.position.set(0,0,-Zh*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(t.target),qs(t.target,0,0,0),this.light=t,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),Kh){const a=new ep(this.light,.2,this.color);this.context.scene.add(a)}break;case ct.Spot:const s=new Zf(this.color,this.intensity*Math.PI,this.range,Gn(this.spotAngle/2),1-Gn(this.innerSpotAngle/2)/Gn(this.spotAngle/2),2);s.position.set(0,0,0),s.rotation.set(0,0,0),this.light=s;const n=s.target;s.add(n),n.position.set(0,0,this.range),n.rotation.set(0,0,0);break;case ct.Point:const o=new Jf(this.color,this.intensity*Math.PI,this.range);this.light=o;break}if(this.light!==void 0){this.shadows!=Vn.None?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048,this.light.shadow.bias=this.shadowBias*-3e-5,this.light.shadow.normalBias=this.shadowNormalBias*-3e-5;const t=this.light.shadow.camera;t.near=this.shadowNearPlane,t.far=Zh;const s=this.gameObject.scale.x,n=this.gameObject.scale.y;this.gameObject.scale.set(1,1,1),t.left*=s,t.right*=s,t.top*=n,t.bottom*=n,this.light.shadow.needsUpdate=!0,Kh&&this.context.scene.add(new tp(t)),this.isBaked?this.light.removeFromParent():e||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===ct.Directional&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}setDirectionalLight(e){e.add(e.target),e.target.position.set(0,0,-1)}}Zo(lt,"Light");wi([g()],lt.prototype,"type",2);wi([g(f)],lt.prototype,"color",2);wi([g()],lt.prototype,"shadowBias",2);wi([g()],lt.prototype,"shadowNormalBias",2);wi([g()],lt.prototype,"shadows",2);wi([g()],lt.prototype,"lightmapBakeType",2);new y(0,0,0);var ct;(function(i){i[i.Spot=0]="Spot",i[i.Directional=1]="Directional",i[i.Point=2]="Point",i[i.Area=3]="Area",i[i.Rectangle=3]="Rectangle",i[i.Disc=4]="Disc"})(ct||(ct={}));var Vn;(function(i){i[i.None=0]="None",i[i.Hard=1]="Hard",i[i.Soft=2]="Soft"})(Vn||(Vn={}));var P_=Object.defineProperty,O_=(i,e)=>P_(i,"name",{value:e,configurable:!0});class Ko extends w{onEnable(){this.enabled&&this.context.physics.addMeshCollider(this.gameObject)}}O_(Ko,"MeshCollider");var C_=Object.defineProperty,td=(i,e)=>C_(i,"name",{value:e,configurable:!0});class ea extends w{}td(ea,"NavMesh");class ta extends w{}td(ta,"NavMeshAgent");var id=Object.defineProperty,S_=Object.getOwnPropertyDescriptor,R_=(i,e)=>id(i,"name",{value:e,configurable:!0}),E_=(i,e,t,s)=>{for(var n=s>1?void 0:s?S_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&id(e,t,n),n};const ia=v("debugnestedgltf");class qn extends w{constructor(){super(...arguments);r(this,"filePath");r(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(e){var t;(t=this.filePath)==null||t.beginListenDownload(e)}preload(){var e;(e=this.filePath)==null||e.preload()}async start(){var t,s,n,o,a,l;if(this._isLoadingOrDoneLoading)return;ia&&console.log(this,this.guid);const e=this.gameObject.parent;if(e){this._isLoadingOrDoneLoading=!0;const c=new we;c.idProvider=new ye(this.hash(this.guid)),c.parent=e,this.gameObject.updateMatrix();const h=this.gameObject.matrix;ia&&console.log("Load nested:",(s=(t=this.filePath)==null?void 0:t.uri)!=null?s:this.filePath,this.gameObject.position);const d=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));d&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0),this.destroy(),ia&&console.log("Nested loading done:",(l=(a=this.filePath)==null?void 0:a.uri)!=null?l:this.filePath,d)}}hash(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}R_(qn,"NestedGltf");E_([g($e)],qn.prototype,"filePath",2);var A_=Object.defineProperty,k_=(i,e)=>A_(i,"name",{value:e,configurable:!0});class sa extends w{constructor(){super(...arguments);r(this,"from");r(this,"affectPosition");r(this,"affectRotation");r(this,"alignLookDirection");r(this,"levelLookDirection");r(this,"positionOffset");r(this,"rotationOffset")}update(){if(!this.from)return;var e=C(this.from),t=K(this.from);this.affectPosition&&D(this.gameObject,e.add(this.positionOffset));const s=new Oe(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),n=new P().setFromEuler(s);this.affectRotation&&ee(this.gameObject,t.multiply(n));let o=new y;this.from.getWorldDirection(o).multiplyScalar(50),this.levelLookDirection&&(o.y=0),this.alignLookDirection&&this.gameObject.lookAt(o)}}k_(sa,"OffsetConstraint");var L_=Object.defineProperty,na=(i,e)=>L_(i,"name",{value:e,configurable:!0});class ra{constructor(){r(this,"randomizeRotationDirection",0);r(this,"duration",5);r(this,"loop",!0);r(this,"prewarm",!1);r(this,"startDelay");r(this,"startDelayMultiplier",0);r(this,"startLifetime");r(this,"startLifetimeMultiplier",5);r(this,"startSpeed");r(this,"startSpeedMultiplier",5);r(this,"startSize3D",!1);r(this,"startSize");r(this,"startSizeMultiplier",1);r(this,"startSizeX");r(this,"startSizeXMultiplier",1);r(this,"startSizeY");r(this,"startSizeYMultiplier",1);r(this,"startSizeZ");r(this,"startSizeZMultiplier",1);r(this,"startRotation3D",!1);r(this,"startRotation");r(this,"startRotationMultiplier",0);r(this,"startRotationX");r(this,"startRotationXMultiplier",0);r(this,"startRotationY");r(this,"startRotationYMultiplier",0);r(this,"startRotationZ");r(this,"startRotationZMultiplier",0);r(this,"flipRotation",0);r(this,"startColor",new f(1,1,1));r(this,"startColor1",new f(0,0,0));r(this,"gravityModifier");r(this,"gravityModifierMultiplier",0);r(this,"simulationSpace",0);r(this,"customSimulationSpace",null);r(this,"simulationSpeed",1);r(this,"useUnscaledTime",!1);r(this,"scalingMode",1);r(this,"playOnAwake",!0);r(this,"maxParticles",1e3);r(this,"emitterVelocityMode",1);r(this,"stopAction",0);r(this,"ringBufferMode",0);r(this,"ringBufferLoopRange",new z(0,1));r(this,"cullingMode",0)}}na(ra,"MainModule");class oa{constructor(){r(this,"burstCount",0);r(this,"enabled",!0);r(this,"rate",10);r(this,"rateMutliplier",1);r(this,"rateOverDistance",0);r(this,"rateOverDistanceMultiplier",0);r(this,"rateOverTime",0);r(this,"rateOverTimeMultiplier",0)}}na(oa,"EmissionModule");class aa{constructor(){r(this,"shapeType",Ge.Box);r(this,"enabled",!0);r(this,"alignToDirection",!1);r(this,"angle",0);r(this,"arc",360);r(this,"arcmode",0);r(this,"box",new y(1,1,1));r(this,"boxThickness",new y(0,0,0));r(this,"position",new y(0,0,0));r(this,"rotation",new y(0,0,0));r(this,"scale",new y(1,1,1));r(this,"radius",1);r(this,"sphericalDirectionAmount",0)}}na(aa,"ShapeModule");var Ge;(function(i){i[i.Sphere=0]="Sphere",i[i.SphereShell=1]="SphereShell",i[i.Hemisphere=2]="Hemisphere",i[i.HemisphereShell=3]="HemisphereShell",i[i.Cone=4]="Cone",i[i.Box=5]="Box",i[i.Mesh=6]="Mesh",i[i.ConeVolume=7]="ConeVolume",i[i.Circle=10]="Circle",i[i.SingleSidedEdge=11]="SingleSidedEdge",i[i.MeshRenderer=12]="MeshRenderer",i[i.SkinnedMeshRenderer=13]="SkinnedMeshRenderer",i[i.BoxShell=14]="BoxShell",i[i.BoxEdge=15]="BoxEdge",i[i.Donut=16]="Donut",i[i.Rectangle=17]="Rectangle",i[i.Sprite=18]="Sprite",i[i.SpriteRenderer=19]="SpriteRenderer"})(Ge||(Ge={}));var T_=Object.defineProperty,la=(i,e)=>T_(i,"name",{value:e,configurable:!0});const sd=v("debugparticles");class nd{constructor(){r(this,"age",0);r(this,"lifetime",0);r(this,"position");r(this,"velocity");r(this,"color")}}la(nd,"ParticleState");class Xn extends w{constructor(){super(...arguments);r(this,"sharedMaterial");r(this,"mesh")}get mainTexture(){if(this.sharedMaterial){const e=this.context.assets.findTexture(this.sharedMaterial);if(e)return e}return null}getMesh(e){return this.mesh?this.context.assets.findMesh(this.mesh):null}awake(){sd&&console.log(this)}}la(Xn,"ParticleSystemRenderer");class ca extends w{constructor(){super(...arguments);r(this,"main");r(this,"emission");r(this,"shape");r(this,"renderer");r(this,"geometry");r(this,"material");r(this,"particlesMesh");r(this,"positions");r(this,"positionsArray");r(this,"particleStates",[]);r(this,"activeCount",0);r(this,"shapeRotation",new P);r(this,"tempVec3",new y);r(this,"tempQuat",new P)}awake(){this.renderer=p.getComponent(this.gameObject,Xn),sd&&console.log(this)}onEnable(){if(this.geometry)return;this.particleStates=[],this.shapeRotation.setFromEuler(new Oe(this.shape.rotation.x,this.shape.rotation.y,this.shape.rotation.z)),this.geometry=new Gs,this.positionsArray=new Float32Array(this.main.maxParticles*3),this.positions=new Al(this.positionsArray,3),this.geometry.setAttribute("position",this.positions);const e=new Float32Array(this.main.maxParticles*3);for(let s=0;s<e.length;s++)e[s*3]=1,e[s*3+1]=1,e[s*3+2]=1;const t=new Al(e,3);this.geometry.setAttribute("color",t),this.material=new ip({size:this.main.startSize,color:16777215,vertexColors:!0}),this.material.map=this.renderer.mainTexture,this.particlesMesh=new sp(this.geometry,this.material),this.particlesMesh.layers.enable(2),this.gameObject.add(this.particlesMesh),this.activeCount=this.main.prewarm?this.main.maxParticles:0}update(){if(!this.geometry)return;const e=this.context.time.deltaTime;this.emit(e);for(let t=0;t<this.activeCount;t+=1){const s=this.particleStates[t];if(!s)continue;const n=s.velocity.x*e,o=s.velocity.y*e,a=s.velocity.z*e;s.position.x+=n,s.position.y+=o,s.position.z+=a,this.updateOverLifetime(t,s),this.geometry.attributes.position.setXYZ(t,s.position.x,s.position.y,s.position.z),this.geometry.attributes.color.setXYZ(t,s.color.r,s.color.g,s.color.b)}this.geometry&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.setDrawRange(0,this.activeCount))}emit(e){var s;const t=this.activeCount;for(let n=0;n<t;n+=1){if(n>=this.particleStates.length){const a=new nd;a.lifetime=(s=this.main.startLifetime)!=null?s:1,a.position=new y,a.velocity=new y,a.color=new f(1,0,0),this.particleStates.push(a),this.initializeParticle(n,a),a.age=a.lifetime*Math.random()}const o=this.particleStates[n];if(o.age>o.lifetime){this.activeCount-=1,this.activeCount=Math.max(0,this.activeCount),this.initializeParticle(n,o);continue}o.age+=e,this.particleStates[n]=o}this.activeCount+=e*this.emission.rate,this.activeCount=Math.min(this.main.maxParticles,this.activeCount)}initializeParticle(e,t){if(!this.geometry)return;t.age=0,t.color.set(this.main.startColor),this.main.startColor1&&t.color.lerp(this.main.startColor1,Math.random()),this.geometry.attributes.color.needsUpdate=!0,this.assignPosition(t.position),this.assignVelocity(t.position,t.velocity);const s=t.position;s.multiply(this.shape.scale),s.applyQuaternion(this.shapeRotation),s.add(this.shape.position),this.particleStates.splice(e,1),this.particleStates.push(t)}updateOverLifetime(e,t){}assignPosition(e){switch(this.shape.shapeType){case Ge.Sphere:e.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).multiplyScalar(this.shape.radius);break;case Ge.Box:e.set(Math.random()-.5,Math.random()-.5,Math.random()-.5);break;default:e.set(0,0,0);break}}assignVelocity(e,t){switch(this.shape.shapeType){case Ge.Sphere:t.set(e.x,e.y,e.z);break;case Ge.Box:t.set(0,0,1),this.shape.sphericalDirectionAmount>0&&(this.tempVec3.set(e.x,e.y,e.z).multiply(this.shape.scale).normalize(),t.lerp(this.tempVec3,this.shape.sphericalDirectionAmount));break;case Ge.Cone:const s=new y(0,1,0);t.copy(s);break;case Ge.Circle:this.tempQuat.setFromAxisAngle(this.tempVec3.set(0,0,1),Math.random()*k.toRadians(this.shape.arc)),t.copy(this.tempVec3.set(1,0,0).applyQuaternion(this.tempQuat));break;default:t.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1);break}switch(t.normalize(),this.shape.shapeType){case Ge.Circle:e.add(t).multiplyScalar(this.shape.radius);break}t.multiplyScalar(this.main.startSpeedMultiplier)}}la(ca,"ParticleSystem");var D_=Object.defineProperty,rd=(i,e)=>D_(i,"name",{value:e,configurable:!0});function*od(i,e=null){const t=e?e.time:A.Current.time,s=t.time;for(;t.time-s<i;)yield}rd(od,"WaitForSeconds");function*M_(i){for(let e=0;e<i;e++)yield}rd(M_,"WaitForFrames");var I_=Object.defineProperty,j_=(i,e)=>I_(i,"name",{value:e,configurable:!0});class ht extends w{constructor(){super(...arguments);r(this,"_didAssignPlayerColor",!1)}awake(){this.context.connection.beginListen(H.JoinedRoom,this.tryAssignColor.bind(this))}onEnable(){this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}*waitForConnection(){for(;!this.destroyed&&this.enabled&&(yield od(.2),!this.tryAssignColor()););}tryAssignColor(){const e=p.getComponentInParent(this.gameObject,Z);return e&&e.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(e.connectionId),!0):!1}assignUserColor(e){const t=ht.hashCode(e),s=ht.colorFromHashCode(t);if(this.gameObject.type==="Mesh"){const n=this.gameObject;this.assignColor(s,e,n)}else if(this.gameObject.children)for(const n of this.gameObject.children){const o=n;o.material&&o.material.color&&this.assignColor(s,e,o)}}assignColor(e,t,s){let n=s.material;!n||(n._playerMaterial!==t?(n=n.clone(),n._playerMaterial=t,s.material=n):console.log("DONT CLONE",n),n.color=e)}static hashCode(e){var t=0,s,n;if(e.length===0)return t;for(s=0;s<e.length;s++)n=e.charCodeAt(s),t=(t<<5)-t+n,t|=0;return t}static colorFromHashCode(e){const t=(e&16711680)>>16,s=(e&65280)>>8,n=e&255;return new f(t/255,s/255,n/255)}}j_(ht,"PlayerColor");var F_=Object.defineProperty,B_=(i,e)=>F_(i,"name",{value:e,configurable:!0});const Bi=class extends w{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=C(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const e=new fo;e.drag=this.drag,e.angularDrag=this.angularDrag,e.mass=this.mass,e.kinematic=this.isKinematic,e.physicsEvents=this.detectCollision,e.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,e),this.parent=this.gameObject.parent}wakeUp(){var e;(e=this.body)==null||e.wakeUp()}applyForce(e,t){var s;(s=this.body)==null||s.applyForce(new It(e.x,e.y,e.z),t?new It(t.x,t.y,t.z):void 0)}set kinematic(e){this.isKinematic=e,this.body&&(this.body.type=e?he.KINEMATIC:he.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var e,t,s;return this.body?Bi.tempPosition.set((e=this.body)==null?void 0:e.velocity.x,(t=this.body)==null?void 0:t.velocity.y,(s=this.body)==null?void 0:s.velocity.z):Bi.tempPosition.set(0,0,0)}setVelocity(e,t,s){!this.body||(this.body.velocity.x=e/this.context.time.deltaTime,this.body.velocity.y=t/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(e,t,s){!this.body||(this.body.angularVelocity.x=e/this.context.time.deltaTime,this.body.angularVelocity.y=t/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(e=null){if(this.body&&this.gameObject&&!this.destroyed){const t=this.worldPosition;this.body.position.set(t.x,t.y,t.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),e){Bi.copyVector3.set(e.x,e.y,e.z),this.smoothedVelocity.lerp(Bi.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const e=C(this.gameObject);this.currentVelocity.subVectors(e,this.lastWorldPosition),this.lastWorldPosition.copy(e),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let vi=Bi;r(vi,"tempPosition",new y),r(vi,"copyVector3",new y);B_(vi,"Rigidbody");var U_=Object.defineProperty,N_=(i,e)=>U_(i,"name",{value:e,configurable:!0});class ha extends w{async start(){this.gameObject.visible=!1}}N_(ha,"SceneSettings");var z_=Object.defineProperty,da=(i,e)=>z_(i,"name",{value:e,configurable:!0});function ad(){return new Promise((i,e)=>{let s=da(()=>{s!=null&&(document.removeEventListener("pointerdown",s),document.removeEventListener("click",s),document.removeEventListener("dragstart",s),document.removeEventListener("touchstart",s),i())},"callback");document.addEventListener("pointerdown",s),document.addEventListener("click",s),document.addEventListener("dragstart",s),document.addEventListener("touchstart",s)})}da(ad,"awaitInputAsync");async function ld(i){await ad(),i()}da(ld,"awaitInput");var cd=Object.defineProperty,$_=Object.getOwnPropertyDescriptor,W_=(i,e)=>cd(i,"name",{value:e,configurable:!0}),Qt=(i,e,t,s)=>{for(var n=s>1?void 0:s?$_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&cd(e,t,n),n},hd;(function(i){i[i.VideoClip=0]="VideoClip",i[i.Url=1]="Url"})(hd||(hd={}));var dd;(function(i){i[i.None=0]="None",i[i.AudioSource=1]="AudioSource",i[i.Direct=2]="Direct",i[i.APIOnly=3]="APIOnly"})(dd||(dd={}));class Ae extends w{constructor(){super();r(this,"renderer",null);r(this,"playOnAwake",!0);r(this,"playOnEnable");r(this,"targetMaterialProperty");r(this,"time",0);r(this,"_playbackSpeed",1);r(this,"_isLooping",!1);r(this,"audioOutputMode",1);r(this,"source");r(this,"clip",null);r(this,"url",null);r(this,"videoElement",null);r(this,"videoTexture",null);r(this,"videoMaterial",null);r(this,"_isPlaying",!1);r(this,"wasPlaying",!1);r(this,"_receivedInput",!1);ld(()=>{this._receivedInput=!0,this.updateVideoElementSettings()})}get playbackSpeed(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.playbackRate)!=null?t:this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this.videoElement&&(this.videoElement.playbackRate=e)}get isLooping(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.loop)!=null?t:this._isLooping}set isLooping(e){this._isLooping=e,this.videoElement&&(this.videoElement.loop=e)}get currentTime(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.currentTime)!=null?t:this.time}set currentTime(e){this.videoElement?this.videoElement.currentTime=e:this.time=e}get isPlaying(){const e=this.videoElement;return e?e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>e.HAVE_CURRENT_DATA:!1}setClipURL(e){this.url!==e&&(this.url=e,this.source=1,this.videoElement&&(this.videoElement.src=e,this._isPlaying&&this.videoElement.play()))}awake(){this.create(this.playOnAwake),window.addEventListener("visibilitychange",e=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this._isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}})}onEnable(){this.playOnEnable===!0&&this.handleBeginPlaying(!0)}onDisable(){this.pause()}onDestroy(){var e;this.videoElement&&((e=this.videoElement.parentElement)==null||e.removeChild(this.videoElement),this.videoElement=null),this.videoTexture&&(this.videoTexture.dispose(),this.videoTexture=null)}play(){var e,t,s;!this.videoElement||this._isPlaying&&!((e=this.videoElement)==null?void 0:e.ended)&&!((t=this.videoElement)==null?void 0:t.paused)||(this._isPlaying=!0,this._receivedInput||(this.videoElement.muted=!0),this.updateVideoElementSettings(),(s=this.videoElement)==null||s.play().catch(n=>{console.warn(n)}))}stop(){this._isPlaying=!1,!!this.videoElement&&(this.videoElement.currentTime=0,this.videoElement.pause())}pause(){var e;this._isPlaying=!1,(e=this.videoElement)==null||e.pause()}create(e){var s;let t;switch(this.source){case 0:t=this.clip;break;case 1:t=this.url;break}!t||(this.videoElement||(this.videoElement=document.createElement("video"),(s=this.context.domElement)==null||s.prepend(this.videoElement),this.updateVideoElementStyles()),typeof t=="string"?this.videoElement.src=t:this.videoElement.srcObject=t,this.videoTexture||(this.videoTexture=new np(this.videoElement)),this.videoTexture.flipY=!1,this.videoTexture.encoding=si,this.handleBeginPlaying(e))}handleBeginPlaying(e){if(!this.enabled||!this.videoElement)return;const t=this.gameObject.material;if(t)if(t!==this.videoMaterial&&(this.videoMaterial=t.clone(),this.gameObject.material=this.videoMaterial),!this.targetMaterialProperty)this.videoMaterial.map=this.videoTexture;else switch(this.targetMaterialProperty){default:this.videoMaterial.map=this.videoTexture;break}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),e&&this.play()}updateVideoElementSettings(){!this.videoElement||(this.videoElement.loop=this._isLooping,this.videoElement.currentTime=this.currentTime,this.videoElement.playbackRate=this._playbackSpeed,this.videoElement.playsInline=!0,this.videoElement.muted=!this._receivedInput&&this.audioOutputMode!==0,(this.playOnAwake||this.playOnEnable)&&(this.videoElement.autoplay=!0))}updateVideoElementStyles(){!this.videoElement||(this.videoElement.style.userSelect="none",this.videoElement.style.visibility="hidden",this.videoElement.style.display="none")}}W_(Ae,"VideoPlayer");Qt([g(S)],Ae.prototype,"renderer",2);Qt([g()],Ae.prototype,"playOnAwake",2);Qt([g()],Ae.prototype,"playOnEnable",2);Qt([g()],Ae.prototype,"targetMaterialProperty",2);Qt([g()],Ae.prototype,"time",2);Qt([g()],Ae.prototype,"playbackSpeed",1);Qt([g()],Ae.prototype,"isLooping",1);var H_=Object.defineProperty,G_=(i,e)=>H_(i,"name",{value:e,configurable:!0});class ua extends w{constructor(){super(...arguments);r(this,"streamOnAwake",!0);r(this,"requestOpen",!1);r(this,"captureStream",null)}start(){this.streamOnAwake&&this.open()}async open(e=!1){if(!(this.captureStream&&!e)){this.close(),this.requestOpen=!0;try{const t=p.getComponentInChildren(this.gameObject,Ae);if(t){const s={video:!0,audio:!1};this.captureStream=await navigator.mediaDevices.getDisplayMedia(s),this.captureStream&&this.requestOpen&&(t.clip=this.captureStream,t.create(!0))}}catch(t){console.error("Error: "+t)}}}close(){if(this.requestOpen=!1,this.captureStream){for(const e of this.captureStream.getTracks())e.stop();this.captureStream=null}}}G_(ua,"ScreenCapture");var ud=Object.defineProperty,V_=Object.getOwnPropertyDescriptor,q_=(i,e)=>ud(i,"name",{value:e,configurable:!0}),X_=(i,e,t,s)=>{for(var n=s>1?void 0:s?V_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&ud(e,t,n),n},dl;const fd=(dl=class extends w{constructor(){super(...arguments);r(this,"target",null);r(this,"followFactor",.1);r(this,"rotateFactor",.1);r(this,"flipForward",!1);r(this,"_firstUpdate",!0)}onEnable(){const i=p.getComponentInChildren(this.gameObject,F);i&&i.cam&&(i.gameObject.position.set(0,0,0),i.cam.position.set(0,0,0),i.gameObject.quaternion.identity(),i.cam.quaternion.setFromEuler(new Oe(0,Math.PI,0)))}onBeforeRender(){this.followFactor<=0||this.updateNow(!1)}updateNow(i){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const e=C(this.target),t=this._firstUpdate||i?1:k.clamp01(this.context.time.deltaTime*this.followFactor);this.worldPosition=this.worldPosition.lerp(e,t)}if(this.rotateFactor>0){const e=K(this.target);this.flipForward&&e.multiply(fd._invertForward);const t=this._firstUpdate||i?1:k.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(e,t)}this._firstUpdate=!1}}},r(dl,"_invertForward",new P().setFromAxisAngle(new y(0,1,0),Math.PI)),dl);let ms=fd;q_(ms,"SmoothFollow");X_([g(S)],ms.prototype,"target",2);var pd=Object.defineProperty,Q_=Object.getOwnPropertyDescriptor,fa=(i,e)=>pd(i,"name",{value:e,configurable:!0}),Qn=(i,e,t,s)=>{for(var n=s>1?void 0:s?Q_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&pd(e,t,n),n};class xi extends w{constructor(){super(...arguments);r(this,"triggerMask",0);r(this,"onEnter");r(this,"onStay");r(this,"onExit");r(this,"currentIntersected",[]);r(this,"lastIntersected",[])}update(){this.currentIntersected.length=0;for(const e of gs.triggers)e.triggerMask===this.triggerMask&&e.test(this.gameObject)&&this.currentIntersected.push(e);for(let e=this.lastIntersected.length-1;e>=0;e--){const t=this.lastIntersected[e];this.currentIntersected.indexOf(t)<0&&(this.onExitTrigger(t),this.lastIntersected.splice(e,1))}for(const e of this.currentIntersected)this.lastIntersected.indexOf(e)<0&&this.onEnterTrigger(e),this.onTrigger(e);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(e){var t;e.raiseOnEnterEvent(this),(t=this.onEnter)==null||t.invoke(this,e)}onExitTrigger(e){var t;e.raiseOnExitEvent(this),(t=this.onExit)==null||t.invoke(this,e)}onTrigger(e){var t;e.raiseOnStayEvent(this),(t=this.onStay)==null||t.invoke(this,e)}}fa(xi,"SpatialTriggerReceiver");Qn([g(He)],xi.prototype,"onEnter",2);Qn([g(He)],xi.prototype,"onStay",2);Qn([g(He)],xi.prototype,"onExit",2);var ul;const Yn=(ul=class extends w{constructor(){super(...arguments);r(this,"triggerMask");r(this,"boxHelper");r(this,"args",new Jn)}start(){console.log(this)}onEnable(){var i;Yn.triggers.push(this),this.boxHelper||(this.boxHelper=p.addNewComponent(this.gameObject,ui),(i=this.boxHelper)==null||i.showHelper())}onDisable(){Yn.triggers.splice(Yn.triggers.indexOf(this),1)}test(i){var e;return this.boxHelper&&(e=this.boxHelper.isInBox(i))!=null?e:!1}raiseOnEnterEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onEnterTrigger",!1,i,this)}raiseOnStayEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onStayTrigger",!1,i,this)}raiseOnExitEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onExitTrigger",!1,i,this)}},r(ul,"triggers",[]),ul);let gs=Yn;fa(gs,"SpatialTrigger");Qn([g()],gs.prototype,"triggerMask",2);class Jn{constructor(){r(this,"source");r(this,"trigger")}}fa(Jn,"SpatialTriggerEventArgs");var Y_=Object.defineProperty,J_=(i,e)=>Y_(i,"name",{value:e,configurable:!0});class pa extends w{constructor(){super(...arguments);r(this,"cam",null);r(this,"_firstPersonMode",!1);r(this,"orbit",null);r(this,"firstPersonFollow",null);r(this,"spectatorUIDomElement",null);r(this,"_avatar",null);r(this,"eventSub_WebXRRequestStartEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"_sessionHasStarted",!1);r(this,"_isFirstStart",!0);r(this,"_firstPersonIsSetup",!1);r(this,"_orbitStartPos",new y);r(this,"_orbitStartRot",new P);r(this,"_orbitStartPos2",new y);r(this,"_orbitStartRot2",new P)}get firstPersonMode(){return!0}set firstPersonMode(e){}enableFirstPersonMode(){this._firstPersonMode=!0,this.updateUI(),this.cam&&(this.firstPersonFollow&&(this.firstPersonFollow.enabled=!0,this.firstPersonFollow.updateNow(!0)),this.orbit&&(this.orbit.enabled=!1))}enableThirdPersonMode(){this._firstPersonMode=!1,this.updateUI(),this.firstPersonFollow&&(this.firstPersonFollow.enabled=!1),!!this.cam&&(D(this.cam.cam,this._orbitStartPos),ee(this.cam.cam,this._orbitStartRot),D(this.cam.gameObject,this._orbitStartPos2),ee(this.cam.gameObject,this._orbitStartRot2),this.orbit&&(this.orbit.enabled=!0,this.orbit.setFromTargetPosition()))}awake(){var t,s;p.setActive(this.gameObject,!1);const e="#spectator-camera-ui";if(this.spectatorUIDomElement=this.context.domElement.querySelector(e),this.spectatorUIDomElement||console.warn("Could not find spectator camera UI element",e),(t=this.spectatorUIDomElement)==null||t.classList.add("hidden"),!this.isSupportedPlatform()){console.log("Disable spectator cam",window.navigator.userAgent,this);return}if(this.cam=p.getComponent(this.gameObject,F),!this.cam){console.error("Spectator camera needs camera component",this);return}this.cam&&(this.cam.enabled=!0,this._orbitStartPos.copy(C(this.cam.cam)),this._orbitStartRot.copy(K(this.cam.cam)),this._orbitStartPos2.copy(C(this.cam.gameObject)),this._orbitStartRot2.copy(K(this.cam.gameObject))),this.eventSub_WebXRRequestStartEvent=this.onXRSessionRequestStart.bind(this),this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),E.addEventListener(G.RequestVRSession,this.eventSub_WebXRRequestStartEvent),E.addEventListener(G.XRStarted,this.eventSub_WebXRStartEvent),E.addEventListener(G.XRStopped,this.eventSub_WebXREndEvent),(s=this.context.domElement.querySelector("button#toggle-spectator-view"))==null||s.addEventListener("click",this.toggleView.bind(this)),this.updateUI()}onDestroy(){E.removeEventListener(G.RequestVRSession,this.eventSub_WebXRStartEvent),E.removeEventListener(G.XRStarted,this.eventSub_WebXRStartEvent),E.removeEventListener(G.XRStopped,this.eventSub_WebXREndEvent)}toggleView(){this.firstPersonMode=!this.firstPersonMode}updateUI(){var t;const e=this.context.domElement.querySelector("button#toggle-spectator-view");if(!!e&&(e.disabled=!0,e.firstChild&&(this._sessionHasStarted?e.firstChild.textContent=this.firstPersonMode?"\u{1F441}\uFE0F":"\u{1F4F7}":e.firstChild.textContent="Waiting for VR session"),((t=e.children)==null?void 0:t.length)>1)){const s=e.children[1];s.style.display=this._sessionHasStarted?"block":"none",this.firstPersonMode?s.textContent="First-Person View. See what the person in VR sees":s.textContent="Third-Person View. Freely move the camera around"}}isSupportedPlatform(){const e=window.navigator.userAgent,t=/Windows|MacOS/.test(e),s=/Windows NT/.test(e)&&/Edg/.test(e)&&!/Win64/.test(e);return t&&!s}onXRSessionRequestStart(e){var t;this._sessionHasStarted=!1,(t=this.spectatorUIDomElement)==null||t.classList.remove("hidden"),p.setActive(this.gameObject,!0),this.cam&&this.cam.cam&&(D(this.cam.cam,this._orbitStartPos),ee(this.cam.cam,this._orbitStartRot),D(this.cam.gameObject,this._orbitStartPos2),ee(this.cam.gameObject,this._orbitStartRot2)),this.firstPersonMode?this.enableFirstPersonMode():this.enableThirdPersonMode()}onXRSessionStart(e){this._sessionHasStarted=!0,this.updateUI()}onXRSessionEnded(e){var t;this._sessionHasStarted=!1,(t=this.spectatorUIDomElement)==null||t.classList.add("hidden"),p.setActive(this.gameObject,!1)}onAfterRender(){var l,c,h;if(!this.cam)return;if(this.firstPersonMode&&!this._firstPersonIsSetup&&(!this._avatar||((l=this._avatar)==null?void 0:l.destroyed))){for(const d of Z.instances)if(d.avatar&&"isLocalAvatar"in d.avatar&&((c=d.avatar)==null?void 0:c.isLocalAvatar)){this._avatar=d;const u=d.avatar.head;if(!u)continue;this.setupFollowMode(u)}}const e=this.context.renderer,t=e.xr.enabled;if(!e.xr.isPresenting)return;const s=e.getRenderTarget();let n=null;if(!s){if(!e.state.bindFramebuffer||!e.state.bindXRFramebuffer)return;n=e._framebuffer,e.state.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender(),e.setClearColor(new f(1,1,1)),e.setRenderTarget(null),e.xr.enabled=!1;const o=(h=this.cam)==null?void 0:h.cam;this.context.updateAspect(o);const a=e.xr.isPresenting;e.xr.isPresenting=!1,e.setSize(this.context.domWidth,this.context.domHeight),e.render(this.context.scene,o),e.xr.isPresenting=a,e.xr.enabled=t,s?e.setRenderTarget(s):e.state.bindXRFramebuffer(n),this.resetAvatarFlags()}setupFollowMode(e,t=!0){if(!e||!this.cam||this._firstPersonIsSetup)return;this._firstPersonIsSetup=!0;const s=e.add(new S);s.add(new Ni),this.firstPersonFollow=p.addNewComponent(this.cam.gameObject,ms),this.firstPersonFollow.target=s,this.firstPersonFollow.followFactor=12,this.firstPersonFollow.rotateFactor=5,t&&(this.firstPersonFollow.flipForward=!0);const n=this.context.mainCamera;n&&(this.cam.cam.near=n.near,this.cam.cam.far=n.far,this.cam.cam.updateProjectionMatrix()),this.orbit&&(this.orbit.enabled=!1)}setAvatarFlagsBeforeRender(){for(const e of Z.instances)if(e.avatar&&"isLocalAvatar"in e.avatar){const t=this.firstPersonMode&&this._firstPersonIsSetup&&e.avatar.isLocalAvatar?Y.FirstPerson:Y.ThirdPerson,s=e.avatar.flags;if(!s)continue;for(const n of s)n.UpdateVisible(t)}}resetAvatarFlags(){var e;for(const t of Z.instances)if(t.avatar&&"flags"in t.avatar){const s=t.avatar.flags;if(!s)continue;for(const n of s)((e=t.avatar)==null?void 0:e.isLocalAvatar)?n.UpdateVisible(Y.FirstPerson):n.UpdateVisible(Y.ThirdPerson)}}}J_(pa,"SpectatorCamera");var md=Object.defineProperty,Z_=Object.getOwnPropertyDescriptor,K_=(i,e)=>md(i,"name",{value:e,configurable:!0}),gd=(i,e,t,s)=>{for(var n=s>1?void 0:s?Z_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&md(e,t,n),n};class _s extends w{constructor(){super(...arguments);r(this,"attachedRigidbody",null);r(this,"isTrigger",!1);r(this,"radius",.5);r(this,"center",new y(0,0,0));r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addSphereCollider(this.gameObject,this.center,this.radius,this.attachedRigidbody))}}K_(_s,"SphereCollider");gd([g(Re)],_s.prototype,"attachedRigidbody",2);gd([g(y)],_s.prototype,"center",2);var eb=Object.defineProperty,tb=(i,e)=>eb(i,"name",{value:e,configurable:!0});class ma extends w{constructor(){super(...arguments);r(this,"anchor",null);r(this,"connectedBody",null);r(this,"connectedAnchor",null);r(this,"spring",10);r(this,"damper",.2);r(this,"rb",null)}awake(){if(this.rb=p.getComponent(this.gameObject,Re),!this.connectedBody||!this.connectedBody.body||!this.rb||!this.rb.body)return;this.connectedBody.body.mass=Math.min(this.rb.body.mass*.99,this.connectedBody.body.mass);const e=new rp(this.rb.body,this.connectedBody.body,{restLength:.01,stiffness:this.spring*.5,damping:this.damper});this.context.physics.addPostStepListener(t=>{e.applyForce()})}update(){}}tb(ma,"SpringJoint");var _d=Object.defineProperty,ib=Object.getOwnPropertyDescriptor,Zn=(i,e)=>_d(i,"name",{value:e,configurable:!0}),Kn=(i,e,t,s)=>{for(var n=s>1?void 0:s?ib(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&_d(e,t,n),n},bd;(function(i){i[i.Simple=0]="Simple",i[i.Sliced=1]="Sliced",i[i.Tiled=2]="Tiled"})(bd||(bd={}));class sb{constructor(){r(this,"x");r(this,"y")}}Zn(sb,"Vec2");class er{constructor(){r(this,"texture");r(this,"triangles");r(this,"uv");r(this,"vertices");r(this,"_geometry")}}Zn(er,"Sprite");Kn([g(Hr)],er.prototype,"texture",2);class ga{static getOrCreateGeometry(e){if(e._geometry)return e._geometry;const t=new Gs;e._geometry=t;const s=new Float32Array(e.triangles.length*3),n=new Float32Array(e.triangles.length*2);for(let o=0;o<e.triangles.length;o+=1){const a=e.triangles[o];s[o*3]=-e.vertices[a].x,s[o*3+1]=e.vertices[a].y,s[o*3+2]=0;const l=e.uv[a];n[o*2]=l.x,n[o*2+1]=1-l.y}return t.setAttribute("position",new $i(s,3)),t.setAttribute("uv",new $i(n,2)),t}}Zn(ga,"SpriteUtils");class Pi extends w{constructor(){super(...arguments);r(this,"drawMode",0);r(this,"size",{x:1,y:1});r(this,"color");r(this,"sharedMaterial");r(this,"_sprite");r(this,"_currentSprite")}get sprite(){return this._sprite}set sprite(e){e!==this._sprite&&(this._sprite=e,this.updateSprite())}awake(){this._currentSprite=void 0}start(){this.drawMode===2&&console.warn("Tiled draw mode is not supported yet",this),this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(){if(!!this.__didAwake&&!!this.sprite&&!!this.sharedMaterial){if(this._currentSprite)this._currentSprite.geometry=ga.getOrCreateGeometry(this.sprite),this._currentSprite.material.map=this.sprite.texture;else{const e=new zi({color:16777215,side:kl});if(!e)return;if(this.color&&(e.color||(e.color=new f),e.color.copy(this.color),e.opacity=this.color.alpha),e.alphaTest=.5,this.sprite.texture&&!e.wireframe){const t=this.sprite.texture;e.map=t}this._currentSprite=new ni(ga.getOrCreateGeometry(this.sprite),e)}this._currentSprite.parent!==this.gameObject&&(this.drawMode===2&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite))}}}Zn(Pi,"SpriteRenderer");Kn([g()],Pi.prototype,"drawMode",2);Kn([g(Fe)],Pi.prototype,"color",2);Kn([g(op)],Pi.prototype,"sharedMaterial",2);var nb=Object.defineProperty,rb=(i,e)=>nb(i,"name",{value:e,configurable:!0});class ke{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsSyncedCameraModel(e,t){return(t||new ke).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsSyncedCameraModel(e,t){return e.setPosition(e.position()+Wr),(t||new ke).__init(e.readInt32(e.position())+e.position(),e)}userId(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}guid(e){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.__string(this.bb_pos+t,e):null}dontSave(){const e=this.bb.__offset(this.bb_pos,8);return e?!!this.bb.readInt8(this.bb_pos+e):!1}pos(e){const t=this.bb.__offset(this.bb_pos,10);return t?(e||new ae).__init(this.bb_pos+t,this.bb):null}rot(e){const t=this.bb.__offset(this.bb_pos,12);return t?(e||new ae).__init(this.bb_pos+t,this.bb):null}static startSyncedCameraModel(e){e.startObject(5)}static addUserId(e,t){e.addFieldOffset(0,t,0)}static addGuid(e,t){e.addFieldOffset(1,t,0)}static addDontSave(e,t){e.addFieldInt8(2,+t,0)}static addPos(e,t){e.addFieldStruct(3,t,0)}static addRot(e,t){e.addFieldStruct(4,t,0)}static endSyncedCameraModel(e){return e.endObject()}static finishSyncedCameraModelBuffer(e,t){e.finish(t)}static finishSizePrefixedSyncedCameraModelBuffer(e,t){e.finish(t,void 0,!0)}}rb(ke,"SyncedCameraModel");var yd=Object.defineProperty,ob=Object.getOwnPropertyDescriptor,wd=(i,e)=>yd(i,"name",{value:e,configurable:!0}),vd=(i,e,t,s)=>{for(var n=s>1?void 0:s?ob(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&yd(e,t,n),n};const tr="SCAM";ln(tr,ke.getRootAsSyncedCameraModel);const me=new Hs;class xd{constructor(e,t){r(this,"userId");r(this,"guid");this.guid=t,this.userId=e}send(e,t){var n;const s=(n=e.cam)==null?void 0:n.cam;if(s){me.clear();const o=me.createString(this.guid),a=me.createString(this.userId);ke.startSyncedCameraModel(me),ke.addGuid(me,o),ke.addUserId(me,a);const l=C(s),c=no(s);ke.addPos(me,ae.createVec3(me,l.x,l.y,l.z)),ke.addRot(me,ae.createVec3(me,c.x,c.y,c.z));const h=ke.endSyncedCameraModel(me);me.finish(h,tr),t.sendBinary(me.asUint8Array())}}}wd(xd,"CameraModel");class bs extends w{constructor(){super(...arguments);r(this,"cam",null);r(this,"cameraPrefab",null);r(this,"_lastWorldPosition");r(this,"_lastWorldQuaternion");r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"_lastUpdateTime",0);r(this,"remoteCams",{});r(this,"userToCamMap",{});r(this,"_camTimeoutInSeconds",10);r(this,"_receiveCallback",null)}getUserCamera(e){const t=this.userToCamMap[e];return t?this.remoteCams[t].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}start(){var e;this.cam||(console.warn("Missing camera, fallback to main camera",this),this.cam=(e=this.context.mainCameraComponent)!=null?e:null)}onEnable(){this._receiveCallback=this.context.connection.beginListenBinrary(tr,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(tr,this._receiveCallback)}update(){for(const s in this.remoteCams){const n=this.remoteCams[s],o=this.context.time.realtimeSinceStartup-n.lastUpdate;if(!n||o>this._camTimeoutInSeconds){console.log("Remote cam timeout",n,o),(n==null?void 0:n.obj)&&p.destroy(n.obj),delete this.remoteCams[s],n&&delete this.userToCamMap[n.userId];continue}}if(E.IsInWebXR)return;if(this.cam===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new xd(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const e=C(this.cam.cam),t=K(this.cam.cam);(e.distanceTo(this._lastWorldPosition)>.001||t.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(e),this._lastWorldQuaternion.copy(t),!((!this._needsUpdate||this.context.time.frameCount%2!=0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(this,this.context.connection))}onReceivedRemoteCameraInfoBin(e){const t=e.guid();if(!t)return;const s=e.userId();if(!s||!this.context.connection.userIsInRoom(s)||!this.cameraPrefab)return;let n=this.remoteCams[t];if(!n)if("isObject3D"in this.cameraPrefab){const c=new we;c.context=this.context;const h=p.instantiate(this.cameraPrefab,c);n=this.remoteCams[t]={obj:h,lastUpdate:this.context.time.realtimeSinceStartup,userId:s},n.obj.visible=!0,this.gameObject.add(h),this.userToCamMap[s]=t;const d=p.getOrAddComponent(h,Z);d.connectionId=s,d.avatar=h}else return;const o=n.obj;n.lastUpdate=this.context.time.realtimeSinceStartup,re.markDirty(o);const a=e.pos();a&&qs(o,a.x(),a.y(),a.z());const l=e.rot();l&&Qs(o,l.x(),l.y(),l.z())}}wd(bs,"SyncedCamera");vd([g(F)],bs.prototype,"cam",2);vd([g([S,$e])],bs.prototype,"cameraPrefab",2);var Pd=Object.defineProperty,ab=Object.getOwnPropertyDescriptor,lb=(i,e)=>Pd(i,"name",{value:e,configurable:!0}),ys=(i,e,t,s)=>{for(var n=s>1?void 0:s?ab(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Pd(e,t,n),n};const _a="view",Od=v("debugsyncedroom");class At extends w{constructor(){super(...arguments);r(this,"roomName");r(this,"urlParameterName");r(this,"joinRandomRoom",!0);r(this,"requireRoomParameter",!1);r(this,"autoRejoin",!0);r(this,"_roomPrefix");r(this,"_lastPingTime",0);r(this,"_lastRoomTime",-1)}awake(){this._roomPrefix===void 0&&(this._roomPrefix=this.roomName,this.roomName="")}onEnable(){const e=v(_a);if(e&&typeof e=="string"&&e.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(e,!0);return}this.tryJoinRoom()}onDisable(){this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}tryJoinRoom(e=0){let t=!1;if(this.urlParameterName){const s=v(this.urlParameterName);if(s&&typeof s=="string"){t=!0;const n=zl(s);this.roomName=n}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),e<1))return this.tryJoinRoom(e+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(console.log("generate room name"),this.roomName=this.generateRoomName());return this.requireRoomParameter&&!t?(Od&&console.log('No required room parameter "'+this.urlParameterName+'" in url - will not connect to networking backend.'),!1):!this.roomName||this.roomName.length<=0?(Od&&console.error('Missing room name on "'+this.name+'". Make sure this is correctly configured in Unity',this.context.connection.isDebugEnabled?this:""),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.context.connection.joinRoom(this.roomName),!0)}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.send("ping",{time:this.context.time.time})),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you)"))}get currentRoomName(){const e=v(_a);return e||v(this.urlParameterName)}setRandomRoomUrlParameter(){const e=Gi(),t=this.generateRoomName();v(this.urlParameterName)?e.set(this.urlParameterName,t):e.append(this.urlParameterName,t),Qr(t,e)}generateRoomName(){return Nl()+"_"+Fl(100,999)}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const e=window.location.search,t=new URLSearchParams(e);return t.has(this.urlParameterName)&&t.delete(this.urlParameterName),t.set(_a,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+t.toString()}return null}}lb(At,"SyncedRoom");ys([g()],At.prototype,"roomName",2);ys([g()],At.prototype,"urlParameterName",2);ys([g()],At.prototype,"joinRandomRoom",2);ys([g()],At.prototype,"requireRoomParameter",2);ys([g()],At.prototype,"autoRejoin",2);var cb=Object.defineProperty,Cd=(i,e)=>cb(i,"name",{value:e,configurable:!0});function Sd(){const i=v("testwindowcount")||0;i&&i>0&&Rd(i)}Cd(Sd,"detect_run_tests");function Rd(i){if(v("testwindow"))return null;const e=new URL(window.location.href);Vi(e.searchParams,kn,1),Vi(e.searchParams,"testwindow",1);const t=e.toString(),s=[];window.onbeforeunload=()=>{for(const c of s)c.close()};const n=.05,o=128;let a=0,l=0;for(let c=0;c<i;c++){a*o+o*.01>=window.innerWidth&&(l+=1,a=0);const h=a*(o*(1+n))+window.screenLeft,d=l*(o*(1+n))+window.screenTop+90+60*l;a+=1;const u=window.open(t,"test window "+c,`popup=yes width=${o} height=${o} top=${d} left=${h}`);if(!u){console.warn("Failed to open window");continue}s.push(u),u.onload=()=>{u.onbeforeunload=()=>{for(let _=0;_<s.length;_++){const b=s[_];b!==u&&b.close()}s.length=0}}}return s}Cd(Rd,"spawnWindows");var hb=Object.defineProperty,ba=(i,e)=>hb(i,"name",{value:e,configurable:!0});class ya extends w{awake(){Sd()}}ba(ya,"TestRunner");class wa extends w{constructor(){super(...arguments);r(this,"transformsPerFrame",10);r(this,"interval",0);r(this,"useFlatbuffers",!0);r(this,"builder",null);r(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinrary(rs,e=>{});else{this.models=[];for(let e=0;e<this.transformsPerFrame;e++)this.models.push(new va(this.context.connection.connectionId+"_simulatedTransform_"+e,this))}}update(){if(!!this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!=0)return;this.builder===null&&(this.builder=new Hs(1024));const e=this.builder;for(let t=0;t<this.transformsPerFrame;t++){e.clear();const s=No(this.context.connection.connectionId,this);this.context.connection.sendBinary(s)}}else if(this.models)for(let e=0;e<this.models.length;e++){const t=this.models[e];t.dontSave=!0,t.update(this,null),this.context.connection.send("TestSimulateUserData-"+e,t)}}}}ba(wa,"TestSimulateUserData");class va{constructor(e,t){r(this,"guid");r(this,"fast",!1);r(this,"position");r(this,"rotation");r(this,"velocity");r(this,"dontSave");this.guid=e,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(t,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(e,t){const s=e.worldPosition;this.position.x=s.x,this.position.y=s.y,this.position.z=s.z;const n=e.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,t){const o=t.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}r(va,"temp",new y);ba(va,"TransformModel");var Ed=Object.defineProperty,db=Object.getOwnPropertyDescriptor,ub=(i,e)=>Ed(i,"name",{value:e,configurable:!0}),fb=(i,e,t,s)=>{for(var n=s>1?void 0:s?db(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Ed(e,t,n),n};class ir extends w{constructor(){super(...arguments);r(this,"isGizmo",!0);r(this,"control");r(this,"orbit");r(this,"changeEventListener");r(this,"windowKeyDownListener");r(this,"windowKeyUpListener")}awake(){this.isGizmo&&!Zi||!this.context.mainCamera||(this.control=new ap(this.context.mainCamera,this.context.renderer.domElement),this.control.visible=!0,this.control.enabled=!0,this.control.getRaycaster().layers.set(2),this.control.size=.6,this.control.traverse(e=>{const t=e;if(t.layers.set(2),t){const s=t.material;s&&(s.opacity=.3)}}))}start(){var e;if(this.context.mainCamera){const t=(e=p.getComponentInParent(this.context.mainCamera,bl))!=null?e:void 0;this.orbit=t}}onEnable(){var e;this.control&&(this.context.scene.add(this.control),this.control.attach(this.gameObject)),this.changeEventListener=this.onControlChangedEvent.bind(this),(e=this.control)==null||e.addEventListener("dragging-changed",this.changeEventListener),this.attachWindowEvents()}onDisable(){var e,t;(e=this.control)==null||e.removeFromParent(),this.changeEventListener&&((t=this.control)==null||t.removeEventListener("dragging-changed",this.changeEventListener))}onControlChangedEvent(e){const t=this.orbit;if(t&&(t.enabled=!e.value),e.value){const s=p.getComponentInParent(this.gameObject,st);s&&s.requestOwnership()}}attachWindowEvents(){const e=this.control;!e||(this.windowKeyDownListener||(this.windowKeyDownListener=t=>{switch(t.keyCode){case 81:e.setSpace(e.space==="local"?"world":"local");break;case 16:e.setTranslationSnap(100),e.setRotationSnap(lp.degToRad(15)),e.setScaleSnap(.25);break;case 87:e.setMode("translate");break;case 69:e.setMode("rotate");break;case 82:e.setMode("scale");break;case 187:case 107:e.setSize(e.size+.1);break;case 189:case 109:e.setSize(Math.max(e.size-.1,.1));break;case 88:e.showX=!e.showX;break;case 89:e.showY=!e.showY;break;case 90:e.showZ=!e.showZ;break;case 32:e.enabled=!e.enabled;break}}),this.windowKeyUpListener||(this.windowKeyUpListener=t=>{switch(t.keyCode){case 16:e.setTranslationSnap(null),e.setRotationSnap(null),e.setScaleSnap(null);break}}),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener))}}ub(ir,"TransformGizmo");fb([g()],ir.prototype,"isGizmo",2);var pb=Object.defineProperty,Ad=(i,e)=>pb(i,"name",{value:e,configurable:!0}),kt;(function(i){i.StartOrUpdate="xr-grab-visual-start-or-update",i.End="xr-grab-visual-end"})(kt||(kt={}));class sr{constructor(){r(this,"guid");r(this,"dontSave",!0);r(this,"userId");r(this,"point",{x:0,y:0,z:0});r(this,"source",{x:0,y:0,z:0});r(this,"target")}update(e,t,s,n=void 0){this.userId=e.connection.connectionId,this.point.x=t.x,this.point.y=t.y,this.point.z=t.z,this.source.x=s.x,this.source.y=s.y,this.source.z=s.z,this.target=n}}Ad(sr,"XRGrabModel");class xa extends w{constructor(){super(...arguments);r(this,"prefab",null);r(this,"_grabModels",[]);r(this,"_grabModelsUpdateTime",[]);r(this,"_addOrUpdateSub",null);r(this,"_endSub",null);r(this,"_freeSub",null);r(this,"_instances",{});r(this,"temp",new y)}awake(){this.prefab&&(this.prefab.visible=!1)}onEnable(){this._addOrUpdateSub=this.context.connection.beginListen(kt.StartOrUpdate,this.onRemoteGrabStartOrUpdate.bind(this)),this._endSub=this.context.connection.beginListen(kt.End,this.onRemoteGrabEnd.bind(this)),this._freeSub=Ee.AddEventListener(jn.WillFree,this.onAttachedObjectFree.bind(this))}onDisable(){this.context.connection.stopListening(kt.StartOrUpdate,this._addOrUpdateSub),this.context.connection.stopListening(kt.End,this._endSub),Ee.RemoveEventListener(jn.WillFree,this._freeSub)}addOrUpdateGrab(e){this.context.connection.send(kt.StartOrUpdate,e,Yi.Queued)}endGrab(e){this.context.connection.send(kt.End,e,Yi.Queued)}onRemoteGrabStartOrUpdate(e){if(!this.prefab)return;const t=this._instances[e.guid];if(!t){const s=p.instantiate(this.prefab);if(s.visible=!0,this._instances[e.guid]={instance:s,model:e},e.userId){const n=p.getComponentsInChildren(s,ht);if((n==null?void 0:n.length)>0)for(const o of n)o.assignUserColor(e.userId)}return}t.model=e}onRemoteGrabEnd(e){if(!e)return;const t=e.guid;this._instances[t]&&(p.destroy(this._instances[t].instance),delete this._instances[t])}onAttachedObjectFree(e){if(this._grabModels.length<=0)return;const t=this._grabModels[0];this.updateModel(t,e),this.endGrab(t)}onBeforeRender(){if(this.updateRendering(),!!this.prefab&&(this.prefab.visible=!1,this.context.time.frameCount%10==0))for(let e=0;e<Ee.Current.length;e++){const t=Ee.Current[e];if(!t.controller||!t.selected)continue;this._grabModels.length<=e&&(this._grabModels.push(new sr),this._grabModelsUpdateTime.push(0)),this._grabModelsUpdateTime[e]=this.context.time.time;const s=this._grabModels[e];this.updateModel(s,t),this.addOrUpdateGrab(s)}}updateModel(e,t){if(!t.controller||!t.selected)return;e.guid=t.grabUUID;const s=t.selected.guid;e.update(this.context,t.grabPoint,t.controller.worldPosition,s)}updateRendering(){const e=this.context.time.deltaTime/.5;for(const t in this._instances){const{instance:s,model:n}=this._instances[t];if(!s||!n)continue;const{point:o}=n,a=C(s);this.temp.set(o.x,o.y,o.z),a.lerp(this.temp,e),D(s,a)}}}Ad(xa,"XRGrabRendering");var kd=Object.defineProperty,mb=Object.getOwnPropertyDescriptor,gb=(i,e)=>kd(i,"name",{value:e,configurable:!0}),nr=(i,e,t,s)=>{for(var n=s>1?void 0:s?mb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&kd(e,t,n),n};class Yt extends w{constructor(){super(...arguments);r(this,"eyes",[]);r(this,"lastBlinkTime",0);r(this,"blinkLength",0);r(this,"eyesOpen",!0);r(this,"state",null)}awake(){this.state=p.getComponentInParent(this.gameObject,J)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const t of this.eyes)t&&(t.visible=this.eyesOpen)}}}gb(Yt,"AvatarBlink_Simple");nr([g(S)],Yt.prototype,"eyes",2);nr([g()],Yt.prototype,"lastBlinkTime",2);nr([g()],Yt.prototype,"blinkLength",2);nr([g()],Yt.prototype,"eyesOpen",2);var Ld=Object.defineProperty,_b=Object.getOwnPropertyDescriptor,bb=(i,e)=>Ld(i,"name",{value:e,configurable:!0}),Pa=(i,e,t,s)=>{for(var n=s>1?void 0:s?_b(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Ld(e,t,n),n},fl;const Td=(fl=class extends w{constructor(){super(...arguments);r(this,"head",null);r(this,"eyes",null);r(this,"target",null);r(this,"brain",null);r(this,"vec",new y);r(this,"currentTargetPoint",new y)}awake(){this.brain||(this.brain=p.getComponentInParent(this.gameObject,os)),this.brain||(console.log("No look at brain found, adding it now"),this.brain=p.addNewComponent(this.gameObject,os)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const i=this.target;if(i&&this.head){const e=this.eyes;if(e){const t=C(i);this.currentTargetPoint.lerp(t,this.context.time.deltaTime/.1);const s=C(this.head),n=this.vec.copy(this.currentTargetPoint).sub(s).normalize();if(n.length()<.1)return;const o=Td.forward;if(o.set(0,0,1),o.applyQuaternion(K(this.head)),o.dot(n)>.45)for(let l=0;l<e.length;l++)e[l].lookAt(this.currentTargetPoint)}}}},r(fl,"forward",new y(0,0,1)),fl);let Oi=Td;bb(Oi,"AvatarEyeLook_Rotation");Pa([g(S)],Oi.prototype,"head",2);Pa([g(S)],Oi.prototype,"eyes",2);Pa([g(S)],Oi.prototype,"target",2);var Dd=Object.defineProperty,yb=Object.getOwnPropertyDescriptor,wb=(i,e)=>Dd(i,"name",{value:e,configurable:!0}),Md=(i,e,t,s)=>{for(var n=s>1?void 0:s?yb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Dd(e,t,n),n};const vb=v("debugmouth");class ws extends w{constructor(){super(...arguments);r(this,"idle",[]);r(this,"talking",[]);r(this,"marker",null);r(this,"voip",null);r(this,"lastMouthChangeTime",0);r(this,"mouthChangeLength",0)}awake(){this.voip=p.findObjectOfType(nt,this.context),console.log(this)}update(){var s,n;if(!this.voip||this.context.time.frameCount%10!=0)return;let e=(n=(s=this.marker)==null?void 0:s.connectionId)!=null?n:null;e||vb&&(e=null);const t=this.voip.getFrequency(e);t!=null&&this.updateLips(t)}updateLips(e){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&e>50){this.lastMouthChangeTime=this.context.time.time;const t=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,t)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const t=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,t)}}}setMouthShapeActive(e,t){if(!!e){e!=this.idle?this.idle.map(s=>s.visible=!1):this.talking.map(s=>s.visible=!1);for(let s=0;s<e.length;s++){const n=e[s];n&&(n.visible=s===t,n.scale.set(1,1,1))}}}}wb(ws,"Avatar_MouthShapes");Md([g(S)],ws.prototype,"idle",2);Md([g(S)],ws.prototype,"talking",2);var xb=Object.defineProperty,Pb=(i,e)=>xb(i,"name",{value:e,configurable:!0});class Oa extends w{constructor(){super(...arguments);r(this,"voip",null);r(this,"marker",null);r(this,"_startPosition",null)}awake(){this.voip=p.findObjectOfType(nt,this.context),this.marker=p.getComponentInParent(this.gameObject,Z)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!=0)return;const e=this.marker.connectionId,t=this.voip.getFrequency(e);if(t==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());let s=t/100;this.gameObject.position.y=this._startPosition.y+s*.07}}Pb(Oa,"Avatar_MustacheShake");var Ob=Object.defineProperty,Cb=(i,e)=>Ob(i,"name",{value:e,configurable:!0});const Sb=v("logstats");class Ca extends w{onEnable(){console.log(this),Sb&&this.startCoroutine(this.run(),Pe.OnAfterRender)}*run(){for(;this.enabled;){const e=this.context.renderer.info;console.log(e.memory,e.render,e.programs),yield}}}Cb(Ca,"LogStats");var Id=Object.defineProperty,Rb=Object.getOwnPropertyDescriptor,Sa=(i,e)=>Id(i,"name",{value:e,configurable:!0}),Eb=(i,e,t,s)=>{for(var n=s>1?void 0:s?Rb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Id(e,t,n),n};class rr{constructor(){r(this,"guid")}}Sa(rr,"SignalAsset");class or{constructor(){r(this,"signal");r(this,"reaction");r(this,"$serializedTypes",{signal:rr,reaction:He})}}Sa(or,"SignalReceiverEvent");class vs extends w{constructor(){super(...arguments);r(this,"events")}start(){console.log(this)}invoke(e){if(!this.events||!Array.isArray(this.events))return;let t=typeof e=="object"?e.guid:e;for(const s of this.events)if(s.signal.guid===t)try{if(s.reaction){if(!s.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",s,this);continue}}else{console.warn("Missing reaction for signal",s,this);continue}s.reaction.invoke()}catch(n){console.error(n)}}}Sa(vs,"SignalReceiver");Eb([g(or)],vs.prototype,"events",2);var Le;(function(i){i.Activation="ActivationTrack",i.Animation="AnimationTrack",i.Audio="AudioTrack",i.Control="ControlTrack",i.Marker="MarkerTrack",i.Signal="SignalTrack"})(Le||(Le={}));var xs;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(xs||(xs={}));var Ra;(function(i){i.Signal="SignalEmitter"})(Ra||(Ra={}));var Ab=Object.defineProperty,Ci=(i,e)=>Ab(i,"name",{value:e,configurable:!0});const ar=v("debugtimeline");class Ps{constructor(){r(this,"director");r(this,"track")}get muted(){return this.track.muted}set muted(e){var t;e!==this.track.muted&&(this.track.muted=e,(t=this.onMuteChanged)==null||t.call(this))}*forEachClip(e=!1){var t;if(!!((t=this.track)==null?void 0:t.clips))if(e)for(let s=this.track.clips.length-1;s>=0;s--)yield this.track.clips[s];else for(const s of this.track.clips)yield s}getClipTime(e,t){return t.clipIn+(e-t.start)*t.timeScale}getClipTimeNormalized(e,t){return(e-t.start)/t.duration}evaluateWeight(e,t,s,n=!0){if(t<0||t>=s.length)return 0;const o=s[t];if(n||e>=o.start&&e<=o.end){let a=1,l=!1;return o.easeInDuration>0&&(a*=Math.min((e-o.start)/o.easeInDuration,1)),o.easeOutDuration>0&&!l&&(a*=Math.min((o.end-e)/o.easeOutDuration,1)),a}return 0}}Ci(Ps,"TrackHandler");class jd{constructor(e){r(this,"clip");r(this,"rootPositionOffset");r(this,"rootQuaternionOffset");r(this,"rootStartPosition");r(this,"rootEndPosition");r(this,"rootStartQuaternion");r(this,"rootEndQuaternion");const t=e.getClip();this.clip=t;const s=e.getRoot(),n=s.name+".position",o=s.name+".quaternion";ar&&console.log(t.name,t.tracks,n);for(const a of t.tracks)if(!(a.times.length<=0)){if(a.name.endsWith(n))this.rootStartPosition=new y().fromArray(a.values,0),this.rootEndPosition=new y().fromArray(a.values,a.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),ar&&console.log(this.rootPositionOffset);else if(a.name.endsWith(o)&&(this.rootStartQuaternion=new P().fromArray(a.values,0),this.rootEndQuaternion=new P().fromArray(a.values,a.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),ar)){const l=new Oe().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}Ci(jd,"AnimationClipOffsetData");class lr extends Ps{constructor(){super(...arguments);r(this,"models",[]);r(this,"trackOffset");r(this,"target");r(this,"mixer");r(this,"clips",[]);r(this,"actions",[]);r(this,"_actionOffsets",[]);r(this,"_didBind",!1);r(this,"_useclipOffsets",!0);r(this,"_totalOffsetPosition",new y);r(this,"_totalOffsetRotation",new P);r(this,"_totalOffsetPosition2",new y);r(this,"_totalOffsetRotation2",new P);r(this,"_summedPos",new y);r(this,"_tempPos",new y);r(this,"_summedRot",new P);r(this,"_tempRot",new P)}createHooks(e){for(const t of e.tracks)t.name.endsWith(".position")?this.createPositionInterpolant(t):t.name.endsWith(".quaternion")&&this.createRotationInterpolant(t)}bind(){if(!this._didBind){this._didBind=!0,ar&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const e of this.actions){const t=new jd(e);this._actionOffsets.push(t)}for(const e of this.models){const t=e.asset,s=t.position,n=t.rotation;s.x!==void 0&&(s.isVector3||(t.position=new y(s.x,s.y,s.z)),n.isQuaternion||(t.rotation=new P(n.x,n.y,n.z,n.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const e=this.trackOffset.position;e&&(e.isVector3||(this.trackOffset.position=new y(e.x,e.y,e.z)));const t=this.trackOffset.rotation;t&&(t.isQuaternion||(this.trackOffset.rotation=new P(t.x,t.y,t.z,t.w)))}}evaluate(e){if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let t=0,s=0,n=!1;for(let o=0;o<this.clips.length;o++){const a=this.models[o],l=this.actions[o],c=a.asset;l.weight=0;const h=e>=a.start&&e<=a.end,d=a.postExtrapolationMode;let u=h;if(!u&&!n&&a.end<e&&a.postExtrapolationMode!==xs.None){const _=o<this.clips.length-1?this.models[o+1]:null;(!_||_.start>e)&&(u=!0,n=!0)}if(u){let _=1;_*=this.evaluateWeight(e,o,this.models,u);let b=this.getClipTime(e,a),x=0;const O=c.duration;if(h){if(c.loop)for(x+=Math.floor(b/O);b>O;)b-=O}else if(!h)switch(d){case xs.Loop:b%=O;break;case xs.PingPong:const ce=Math.floor(b/O)%2!=0;b%=O,ce&&(b=O-b);break}l.time=b,l.timeScale=0;const R=_*this.director.weight;if(l.weight=R,l.clampWhenFinished=!0,l.isRunning()||l.play(),this._useclipOffsets){const M=t==0?this._totalOffsetPosition:this._totalOffsetPosition2,ce=t==0?this._totalOffsetRotation:this._totalOffsetRotation2;t<1&&(s=1-_),t+=1;const B=this._summedPos.set(0,0,0),L=this._tempPos.set(0,0,0),U=this._summedRot.identity(),zs=this._tempRot.identity(),$s=c.rotation,_t=new P;_t.slerp($s,_);const Ui=this._actionOffsets[o];if(Ui.hasOffsets)for(let ml=0;ml<x;ml++)Ui.rootPositionOffset?L.copy(Ui.rootPositionOffset):L.set(0,0,0),L.applyQuaternion(U).applyQuaternion(_t),Ui.rootQuaternionOffset&&(zs.copy(Ui.rootQuaternionOffset),U.multiply(zs)),B.add(L);ce.multiply(_t),ce.multiply(U),B.add(c.position),M.add(B)}}}this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,s),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,s)),this.mixer.update(e)}createRotationInterpolant(e){var o;const t=e.createInterpolant.bind(e),s=new P;this.ensureTrackOffsets();const n=(o=this.trackOffset)==null?void 0:o.rotation;e.createInterpolant=()=>{const a=t(),l=a.evaluate.bind(a);return a.evaluate=c=>{const h=l(c);return s.set(h[0],h[1],h[2],h[3]),s.premultiply(this._totalOffsetRotation),n&&s.premultiply(n),h[0]=s.x,h[1]=s.y,h[2]=s.z,h[3]=s.w,h},a}}createPositionInterpolant(e){var a,l;const t=e.createInterpolant.bind(e),s=new y;this.ensureTrackOffsets();const n=(a=this.trackOffset)==null?void 0:a.rotation,o=(l=this.trackOffset)==null?void 0:l.position;e.createInterpolant=()=>{const c=t(),h=c.evaluate.bind(c);return c.evaluate=d=>{const u=h(d);return s.set(u[0],u[1],u[2]),s.applyQuaternion(this._totalOffsetRotation),s.add(this._totalOffsetPosition),n&&s.applyQuaternion(n),o&&(s.x-=o.x,s.y+=o.y,s.z+=o.z),u[0]=s.x,u[1]=s.y,u[2]=s.z,u},c}}}Ci(lr,"AnimationTrackHandler");class cr extends Ps{constructor(){super(...arguments);r(this,"models",[]);r(this,"listener");r(this,"audio",[]);r(this,"audioContextTimeOffset",[]);r(this,"lastTime",0)}getAudioFilePath(e){const t=this.director.sourceId;return Wl(t,e)}onAllowAudioChanged(e){for(let t=0;t<this.models.length;t++){const s=this.models[t];this.audio[t].setVolume(e?s.asset.volume:0)}}addModel(e){const t=this.getAudioFilePath(e.asset.clip),s=new Pl(this.listener);s.setVolume(e.asset.volume);const n=new zr;console.log(t,this.director.sourceId),n.load(t,o=>{s.setBuffer(o),s.loop=e.asset.loop,this.audio.push(s),this.models.push(e)})}onDisable(){for(const e of this.audio)e.isPlaying&&e.stop()}onMuteChanged(){if(this.muted)for(let e=0;e<this.audio.length;e++){const t=this.audio[e];(t==null?void 0:t.isPlaying)&&t.stop()}}evaluate(e){if(!this.track.muted){for(let t=0;t<this.models.length;t++){const s=this.models[t],n=this.audio[t];if(e>=s.start&&e<=s.end){if(this.director.isPaused&&(n.isPlaying&&n.stop(),this.lastTime===e))continue;n.isPlaying||(n.offset=s.clipIn+(e-s.start)*s.timeScale,n.play());let o=s.asset.volume;s.easeInDuration>0&&(o*=Math.min((e-s.start)/s.easeInDuration,1)),s.easeOutDuration>0&&(o*=Math.min((s.end-e)/s.easeOutDuration,1)),n.setVolume(o*this.director.weight)}else n.isPlaying&&n.stop()}this.lastTime=e}}}Ci(cr,"AudioTrackHandler");class Os extends Ps{constructor(){super(...arguments);r(this,"models",[]);r(this,"didTrigger",[]);r(this,"receivers",[])}evaluate(e){if(!(this.receivers.length<=0)&&!this.track.muted)for(let t=0;t<this.models.length;t++){const s=this.models[t],n=this.didTrigger[t],o=s.time-e;if(s.retroActive?o<0:o<0&&Math.abs(o)<.1){if(!n){this.didTrigger[t]=!0;for(const l of this.receivers)!l||l.invoke(s.asset)}}else s.emitOnce||(this.didTrigger[t]=!1)}}}Ci(Os,"SignalTrackHandler");const Ns=class extends Ps{constructor(){super(...arguments);r(this,"models",[]);r(this,"timelines",[]);r(this,"_previousActiveModel",null)}resolveSourceObjects(e){for(let t=this.models.length-1;t>=0;t--){const n=this.models[t].asset;if(typeof n.sourceObject=="string"){const o=n.sourceObject;Ns.resolved[o]?n.sourceObject=Ns.resolved[o]:(n.sourceObject=p.findByGuid(o,e.scene),Ns.resolved[o]=n.sourceObject)}if(n.sourceObject){const o=p.getComponent(n.sourceObject,Ri);this.timelines.push(o),o&&n.updateDirector&&(o.playOnAwake=!1)}else{this.models.splice(t,1);continue}}}evaluate(e){var t;this._previousActiveModel=null;for(let s=0;s<this.models.length;s++){const n=this.models[s],o=n.asset;if(e>=n.start&&e<=n.end){this._previousActiveModel=n;const a=this.getClipTime(e,n);if(o.controlActivation){const l=o.sourceObject;l.visible=!0}if(o.updateDirector){const l=this.timelines[s];l&&(l.isPlaying&&l.pause(),l.time=a,l.evaluate())}}else{const a=(t=this._previousActiveModel)==null?void 0:t.asset;if(o.controlActivation){const l=o.sourceObject;(a==null?void 0:a.sourceObject)!==l&&(l.visible=!1)}}}}};let Si=Ns;r(Si,"resolved",{});Ci(Si,"ControlTrackHandler");var kb=Object.defineProperty,Lb=(i,e)=>kb(i,"name",{value:e,configurable:!0});const Fd=v("debugtimeline");var Bd;(function(i){i[i.Hold=0]="Hold",i[i.Loop=1]="Loop",i[i.None=2]="None"})(Bd||(Bd={}));var Ud;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(Ud||(Ud={}));const Tr=class extends w{constructor(){super(...arguments);r(this,"playableAsset");r(this,"playOnAwake");r(this,"extrapolationMode",1);r(this,"_visibilityChangeEvt");r(this,"_clonedPlayableAsset",!1);r(this,"_guidsMap");r(this,"_isPlaying",!1);r(this,"_internalUpdateRoutine");r(this,"_isPaused",!1);r(this,"_time",0);r(this,"_duration",0);r(this,"_weight",1);r(this,"_animationTracks",[]);r(this,"_audioTracks",[]);r(this,"_signalTracks",[]);r(this,"_controlTracks",[]);r(this,"_customTracks",[]);r(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks])}static registerCreateTrack(e,t){this.createTrackFunctions[e]=t}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(e){this._time=e}get duration(){return this._duration}set duration(e){this._duration=e}get weight(){return this._weight}set weight(e){this._weight=e}awake(){var e,t,s;Fd&&console.log(this,(e=this.playableAsset)==null?void 0:e.tracks),this.rebuildGraph(),this.playOnAwake?this.play():this.evaluate(),this.isValid()||console.warn("PlayableDirector is not valid",this.playableAsset,(t=this.playableAsset)==null?void 0:t.tracks,Array.isArray((s=this.playableAsset)==null?void 0:s.tracks),this)}onEnable(){var e,t;for(const s of this._audioTracks)(e=s.onEnable)==null||e.call(s);for(const s of this._customTracks)(t=s.onEnable)==null||t.call(s);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var e,t;this.stop();for(const s of this._audioTracks)(e=s.onDisable)==null||e.call(s);for(const s of this._customTracks)(t=s.onDisable)==null||t.call(s);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var e;for(const t of this._audioTracks)(e=t.onDestroy)==null||e.call(t)}rebuildGraph(){!this.isValid()||(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}play(){!this.isValid()||(this._isPaused=!1,!this._isPlaying&&(this._isPlaying=!0,this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate())))}pause(){this._isPaused=!0}stop(){this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.evaluate()),this._isPlaying=!1,this._isPaused=!1,this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null}evaluate(){if(!this.isValid())return;let e=this._time;switch(this.extrapolationMode){case 0:e=Math.min(e,this._duration);break;case 1:e%=this._duration;break;case 2:if(e>this._duration){this.stop();return}break}this.internalEvaluate(e)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const e of this._allTracks)for(const t of e)yield t}get audioTracks(){return this._audioTracks}resolveGuids(e){this._guidsMap=e}*internalUpdate(){for(;this._isPlaying;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime,this.evaluate()),yield}internalEvaluate(e){for(const t of this.playableAsset.tracks)if(!t.muted)switch(t.type){case Le.Activation:for(let s=0;s<t.outputs.length;s++){const n=t.outputs[s];if(typeof n=="object"){let o=!1;for(const l of t.clips)l.start<=e&&e<=l.end&&(o=!0);const a=n;a.visible!==void 0&&(a.visible=o)}}break}for(const t of this._animationTracks)t.evaluate(e);for(const t of this._audioTracks)t.evaluate(e);for(const t of this._signalTracks)t.evaluate(e);for(const t of this._controlTracks)t.evaluate(e);for(const t of this._customTracks)t.evaluate(e)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=Vs(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const e=this.findRoot(this.gameObject);for(const t of this.playableAsset.tracks)for(let s=t.outputs.length-1;s>=0;s--){let n=t.outputs[s];if(typeof n=="string"){this._guidsMap&&this._guidsMap[n]&&(n=this._guidsMap[n]);const o=p.findByGuid(n,e);o===null||typeof o!="object"?(t.outputs.splice(s,1),console.warn("Failed to resolve binding",n,t.name,t.type)):(Fd&&console.log("Resolved binding",n,"to",o),t.outputs[s]=o)}else if(n===null){if(t.outputs.splice(s,1),Tr.createTrackFunctions[t.type])continue;t.type!==Le.Audio&&t.type!==Le.Control&&t.type!==Le.Marker&&console.warn("Missing binding",n,t.name,t.type,this.name,this.playableAsset.name)}}}findRoot(e){return e.parent?this.findRoot(e.parent):e}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const e of this.playableAsset.tracks)if(e.muted!==!0)for(const t of e.clips)t.end>this._duration&&(this._duration=t.end)}}setupAndCreateTrackHandlers(){var t,s;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;const e=[];for(const n of this.playableAsset.tracks){const o=n.type,a=Tr.createTrackFunctions[o];if(a!=null){const l=a(this,n);if(typeof l.evaluate=="function"){l.director=this,l.track=n,this._customTracks.push(l);continue}}if(n.type===Le.Animation){if(n.clips.length<=0)continue;for(let l=n.outputs.length-1;l>=0;l--){const c=n.outputs[l];typeof c.enabled=="boolean"&&(c.enabled=!1);const h=(t=c==null?void 0:c.gameObject)==null?void 0:t.animations;if(h){const d=new lr;d.trackOffset=n.trackOffset,d.director=this,d.track=n;for(let u=0;u<n.clips.length;u++){const _=n.clips[u],b=_.asset;if(!b){console.error("MISSING anim model?","clip#"+u,_,n,this.playableAsset,this.name);continue}const x=b.clip;let O=x;if((typeof O=="string"||typeof O=="number")&&(O=h.find(M=>M.name===x)),!O){console.warn("Could not find animationClip for model",_,n.name,this.name,(s=this.playableAsset)==null?void 0:s.name);continue}d.mixer||(d.mixer=new Nr(c.gameObject)),d.clips.push(O),d.mixer.uncacheAction(O),d.createHooks(O);const R=d.mixer.clipAction(O);d.actions.push(R),d.models.push(_)}this._animationTracks.push(d)}}}else if(n.type===Le.Audio){if(n.clips.length<=0)continue;e.push(n)}else if(n.type===Le.Marker){const l=new Os;l.director=this,l.track=n;for(const c of n.markers)switch(c.type){case Ra.Signal:l.models.push(c),l.didTrigger.push(!1);break}if(l!==null&&l.models.length>0){const c=p.getComponent(this.gameObject,vs);c&&(l.receivers.push(c),this._signalTracks.push(l))}}else if(n.type===Le.Signal){const l=new Os;l.director=this,l.track=n;for(const c of n.markers)l.models.push(c),l.didTrigger.push(!1);for(const c of n.outputs)l.receivers.push(c);this._signalTracks.push(l)}else if(n.type===Le.Control){const l=new Si;l.director=this,l.track=n;for(const c of n.clips)l.models.push(c);l.resolveSourceObjects(this.context),this._controlTracks.push(l)}}te.registerWaitForAllowAudio(()=>{const n=p.findObjectOfType(hi,this.context);if(!!n)for(const o of e){const a=new cr;a.director=this,a.track=o,a.listener=n.listener;for(let l=0;l<o.clips.length;l++){const c=o.clips[l];a.addModel(c)}this._audioTracks.push(a)}})}setAudioTracksAllowPlaying(e){for(const t of this._audioTracks)t.onAllowAudioChanged(e)}};let Ri=Tr;r(Ri,"createTrackFunctions",{});Lb(Ri,"PlayableDirector");var Tb=Object.defineProperty,Db=(i,e)=>Tb(i,"name",{value:e,configurable:!0});class Jt{constructor(e){r(this,"used",!1);r(this,"inputSource");r(this,"object");r(this,"isDown");r(this,"isUp");r(this,"isPressed");r(this,"isClicked");r(this,"event");this.event=e}Use(){this.used=!0}StopPropagation(){var e;(e=this.event)==null||e.stopImmediatePropagation()}}Db(Jt,"PointerEventData");var Mb=Object.defineProperty,Nd=(i,e)=>Mb(i,"name",{value:e,configurable:!0});const Ib=v("debugeventsystem"),Qe=class extends w{constructor(){super();r(this,"orbitControl",null);r(this,"orbitControlWasEnabled",!1);r(this,"raycaster",[]);r(this,"lastPointerEvent",null);r(this,"objectsHoveredThisFrame",[]);r(this,"objectsHoveredLastFrame",[]);r(this,"raisedPointerDownEvents",[]);r(this,"_didMove",!1);r(this,"_tempComponentsArray",[]);r(this,"_sortedHits",[]);r(this,"_sortingBuffer",[]);r(this,"_noDepthTestingResults",[]);r(this,"handleEventsArray",[]);r(this,"currentActiveMeshUIComponents",[]);Qe.systems.push(this)}static createIfNoneExists(e){this.didSearchEventSystem||(this.didSearchEventSystem=!0,Qe.systems.length<=0&&Qe.systems.push(...p.findObjectsOfType(Qe,e)));for(const s of Qe.systems)if(s.context===e)return;const t=new S;p.addNewComponent(t,Qe),e.scene.add(t)}static ensureUpdateMeshUI(e,t){Ve.update(e,t)}static markUIDirty(e){Ve.markDirty()}static get instance(){return this.systems[0]}onDestroy(){Qe.systems.splice(Qe.systems.indexOf(this),1)}start(){}register(e){var t;e&&this.raycaster&&!this.raycaster.includes(e)&&((t=this.raycaster)==null||t.push(e))}unregister(e){var s,n;const t=(s=this.raycaster)==null?void 0:s.indexOf(e);t!==void 0&&t!==-1&&((n=this.raycaster)==null||n.splice(t,1))}onEnable(){j.addEventListener(pe.SelectStart,(t,s)=>{if(!s.grab)return;Ve.resetLastSelected();const n=new Jt;n.inputSource=t,n.isDown=t.selectionDown,n.isUp=t.selectionUp,n.isPressed=t.selectionPressed,n.isClicked=!1,s.grab&&!this.handleEvents(s.grab,n)&&(s.grab=null)});const e=new je;j.addEventListener(pe.SelectEnd,(t,s)=>{if(!s.grab)return;const n=new Jt;n.inputSource=t,n.isDown=t.selectionDown,n.isUp=t.selectionUp,n.isPressed=t.selectionPressed,n.isClicked=t.selectionClick,this.handleEvents(s.grab,n)}),j.addEventListener(pe.Update,t=>{e.ray=t.getRay();const s=this.performRaycast(e);if(!s)return;const n=new Jt;n.inputSource=t,this.handleIntersections(s,n)}),this.context.pre_update_callbacks.push(this.onBeforeUpdate.bind(this)),this.context.input.addEventListener(tn.PointerDown,this.onPointerDown.bind(this))}onDisable(){}onPointerDown(){this.onBeforeUpdate()}onBeforeUpdate(){var s;if(this.objectsHoveredThisFrame.length=0,this.resetMeshUIStates(),E.IsInWebXR||this.context.input.isKeyPressed(Ze.ALT))return;if(!this._didMove){const n=this.context.input.getPointerPositionRC(0);if(n&&n.x===0&&n.y===0)return;this._didMove=!0}const e=this.performRaycast(null),t=new Jt(this.context.input.getPointerEvent(0));t.inputSource=this.context.input,t.isClicked=this.context.input.mouseClick,t.isDown=this.context.input.mouseDown,t.isUp=this.context.input.mouseUp,t.isPressed=this.context.input.mousePressed,this.lastPointerEvent=t,!!e&&(this.handleIntersections(e,t),this.context.input.mouseDown&&this.currentActiveMeshUIComponents.length>0&&this.context.mainCameraComponent?(this.orbitControl=p.getComponent(this.context.mainCameraComponent.gameObject,zt),((s=this.orbitControl)==null?void 0:s.enabled)&&(this.orbitControlWasEnabled=this.orbitControl.enabled,this.orbitControl.enabled=!1)):this.orbitControl&&!this.context.input.mousePressed&&(this.orbitControl.enabled=this.orbitControlWasEnabled,this.orbitControl=null))}onBeforeRender(){if(this.lastPointerEvent)this.lastPointerEvent.used=!1;else return;if(this.lastPointerEvent.isUp){for(const t of this.raisedPointerDownEvents)t.onPointerUp&&t.onPointerUp(this.lastPointerEvent);this.raisedPointerDownEvents.length=0}for(const t of this.objectsHoveredLastFrame)if(this.objectsHoveredThisFrame.indexOf(t)<0){this._tempComponentsArray.length=0;const s=p.getComponentsInParent(t,w,this._tempComponentsArray);this.lastPointerEvent.object=t;for(let n=0;n<s.length;n++){const o=s[n];if(!o.gameObject||o.destroyed)continue;const a=o;a.onPointerExit&&a.onPointerExit(this.lastPointerEvent)}}const e=this.objectsHoveredLastFrame;this.objectsHoveredLastFrame=this.objectsHoveredThisFrame,this.objectsHoveredThisFrame=e}performRaycast(e){if(!this.raycaster)return null;this._sortedHits.length=0;for(const t of this.raycaster){if(!t.activeAndEnabled)continue;const s=t.performRaycast(e);s&&s.length>0&&this._sortedHits.push(...s)}return this._sortedHits.sort((t,s)=>t.distance-s.distance),this._sortedHits}handleIntersections(e,t){if(!e||e.length<=0)return!1;e=this.sortCandidates(e);for(const s of e){const{object:n}=s;if(this.handleEvents(n,t))return!0}return!1}sortCandidates(e){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let t=0;t<e.length;t++){const s=e[t],n=s.object;if(n.material&&n.material.depthTest===!1){this._noDepthTestingResults.push(s);continue}this._sortingBuffer.push(s)}for(const t of this._sortingBuffer)this._noDepthTestingResults.push(t);return this._noDepthTestingResults}handleEvents(e,t){var a,l;if(!this.testIsVisible(e))return t.isClicked&&Ib&&console.log("not allowed",e),!1;t.object=e,this.lastPointerEvent=t;const s=e.parent;let n=!1;(a=t.isClicked)!=null;let o=null;if(s&&s.isUI){const c=(l=t.isPressed||t.isClicked)!=null?l:!1;if(s.shadowComponentOwner){const h=s.shadowComponentOwner.gameObject;if(h){if(o=this.tryFindCanvasGroup(h),(o==null?void 0:o.blocksRaycasts)===!1)return!1;if((o==null?void 0:o.interactable)===!1)return!0;this.handleMeshUIIntersection(e,c),e=h,n=!0}}if(!n&&this.handleMeshUiObjectWithoutShadowDom(s,c))return!0}if(this.objectsHoveredThisFrame.push(e),o===null||o.interactable){const c=this.objectsHoveredLastFrame.indexOf(e)>=0;this.handleEventsArray.length=0;const h=p.getComponentsInParent(e,w,this.handleEventsArray);for(let d=0;d<h.length;d++){if(t.used)return!0;if(h[d].destroyed)continue;const u=h[d];u.interactable!==!1&&(u.onPointerEnter&&(c||u.onPointerEnter(t)),t.isDown&&u.onPointerDown&&!this.raisedPointerDownEvents.includes(u)&&(u.onPointerDown(t),this.raisedPointerDownEvents.push(u)),t.isUp&&u.onPointerUp&&u.onPointerUp(t),t.isClicked&&u.onPointerClick&&u.onPointerClick(t))}}return!0}handleMeshUiObjectWithoutShadowDom(e,t){return!e||!e.isUI?!0:this.handleMeshUIIntersection(e,t)}handleMeshUIIntersection(e,t){const s=Ve.updateState(e,t);return s&&this.currentActiveMeshUIComponents.push(s),s!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&Ve.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let e=0;e<this.currentActiveMeshUIComponents.length;e++){const t=this.currentActiveMeshUIComponents[e];Ve.resetState(t)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(e){return e?p.isActiveSelf(e)?this.testIsVisible(e.parent):!1:!0}tryFindCanvasGroup(e){if(!e)return null;const t=p.foreachComponent(e,s=>{const n=s;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n},!1);return t!==void 0?t:this.tryFindCanvasGroup(e.parent)}};let Te=Qe;r(Te,"didSearchEventSystem",!1),r(Te,"systems",[]);Nd(Te,"EventSystem");class Ve{static markDirty(){this.needsUpdate=!0}static update(e,t){for(const s of this.lastUpdateFrame)if(s.context===t){if(t.time.frameCount===s.frame)return;s.frame=t.time.frameCount,(this.needsUpdate||t.time.frameCount<30)&&(this.needsUpdate=!1,e.update());return}this.lastUpdateFrame=[{context:t,frame:t.time.frameCount}],e.update()}static updateState(e,t){let s=null;if(e&&(s=this.findBlockInParent(e),s&&s!==this.lastSelected)){if(s.interactable===!1)return null;t?(this.lastSelected=s,s.states.pressed&&s.setState("pressed")):s.states.hovered&&s.setState("hovered"),this.needsUpdate=!0}return s}static resetLastSelected(){const e=this.lastSelected;!e||(this.lastSelected=null,this.resetState(e))}static resetState(e){if(!e)return;e.interactable===!1?e.states.disabled&&e.setState("disabled"):e===this.lastSelected&&e.states.selected?e.setState("selected"):e.setState("normal"),this.needsUpdate=!0}static findBlockInParent(e){return e?e.isBlock&&Object.keys(e.states).length>0?e:this.findBlockInParent(e.parent):null}}r(Ve,"lastSelected",null),r(Ve,"lastUpdateFrame",[]),r(Ve,"needsUpdate",!1);Nd(Ve,"MeshUIHelper");var zd=Object.defineProperty,jb=Object.getOwnPropertyDescriptor,Ea=(i,e)=>zd(i,"name",{value:e,configurable:!0}),hr=(i,e,t,s)=>{for(var n=s>1?void 0:s?jb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&zd(e,t,n),n};class Aa{constructor(){r(this,"width");r(this,"height")}}Ea(Aa,"Size");class dr{constructor(){r(this,"x");r(this,"y");r(this,"width");r(this,"height")}}Ea(dr,"Rect");class Lt extends w{constructor(){super(...arguments);r(this,"rect");r(this,"sizeDelta");r(this,"anchoredPosition3D");r(this,"pivot")}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get m_AnchoredPosition(){return this.gameObject.position}applyAnchoring(e){if(this.pivot&&this.sizeDelta){const t=this.pivot.x*2-1,s=this.pivot.y*2-1,n=this.sizeDelta.x*t,o=this.sizeDelta.y*s;e.x+=n*.5,e.y-=o*.5}}getBasicOptions(){const e={width:this.rect.width,height:this.rect.height,offset:.001,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0};return this.ensureValidSize(e),e}ensureValidSize(e,t=100){return e.width<=0&&(e.width=t),e.height<=0&&(e.height=1e-7),e}createBlock(e){return e=bt(bt({},this.getBasicOptions()),e),new Ll(e)}}Ea(Lt,"RectTransform");hr([g(dr)],Lt.prototype,"rect",2);hr([g(z)],Lt.prototype,"sizeDelta",2);hr([g(y)],Lt.prototype,"anchoredPosition3D",2);hr([g(z)],Lt.prototype,"pivot",2);var Fb=Object.defineProperty,Bb=(i,e)=>Fb(i,"name",{value:e,configurable:!0});function ur(i,e,t=!0){var s;if(!!i&&(((s=i.material)==null?void 0:s.isMaterial)===!0&&(i.material.depthTest=!e),t))for(const n of i.children)ur(n,e,t)}Bb(ur,"setRenderOnTop");var Ub=Object.defineProperty,$d=(i,e)=>Ub(i,"name",{value:e,configurable:!0});const Zt="./include",Nb=v("debugui");Ll.prototype.interactable={get(){return this.interactive},set(i){this.interactable=i}};class dt extends w{constructor(){super(...arguments);r(this,"shadowComponent",null);r(this,"_controlsChildLayout",!0);r(this,"_rect",null);r(this,"_root");r(this,"_renderOnTop",!1);r(this,"_parentComponent");r(this,"_lastMatrixWorld")}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(e){this._controlsChildLayout=e,this.shadowComponent&&(this.shadowComponent.autoLayout=e)}get rect(){return this._rect||(this._rect=p.getComponent(this.gameObject,Lt)),this._rect}get Root(){return this._root===void 0&&(this._root=p.getComponentInParent(this.gameObject,Cs)),this._root}set renderOnTop(e){e!==this._renderOnTop&&(this._renderOnTop=e,this.startCoroutine(this.updateRenderOnTop(),Pe.OnBeforeRender))}get renderOnTop(){return this._renderOnTop}get isNested(){return this.Root!==null&&this.Root.gameObject!==this.gameObject.parent}markDirty(){Te.markUIDirty(this.context)}addToShadowComponent(e){if(this.removeShadowComponent(),this._parentComponent=p.getComponentInParent(this.gameObject.parent,dt),!this._parentComponent||!this._parentComponent.shadowComponent){console.warn("Component doesn't have a MeshUIBaseComponent parent anywhere. Do you have a UI element outside a Canvas?",this);return}e.name=this.gameObject.name+" (UI)",e.autoLayout=this._parentComponent.controlsChildLayout,e.shadowComponentOwner=this;const t=this.raycastTarget;e.traverse(s=>{s.shadowComponentOwner||(s.shadowComponentOwner=this),t===!1&&s.layers.set(2)}),this._parentComponent.shadowComponent.add(e),this.shadowComponent=e,this.applyTransform(),Zi&&e.add(new Ni(.5)),this.onAfterAddedToScene(),this.startCoroutine(this.updateRenderOnTop(),Pe.OnBeforeRender)}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}*updateRenderOnTop(){yield,this.shadowComponent&&(this.onUpdateRenderOnTop(),ur(this.shadowComponent,this._renderOnTop))}onUpdateRenderOnTop(){}applyTransform(){var n,o;const e=this.shadowComponent;if(!e)return;const t=(this==null?void 0:this.isRoot())===!0,s=((n=this._parentComponent)==null?void 0:n.isRoot())===!0;if(t){const a=s?1/(((o=this.Root)==null?void 0:o.gameObject.scale.x)||1):1,l=C(this.gameObject);l.multiplyScalar(a),e.position.set(l.x,l.y,l.z);const c=sc(this.gameObject);e.scale.copy(c).multiplyScalar(a)}else{const a=this.gameObject.position;e.position.set(-a.x,a.y,-a.z),e.scale.copy(this.gameObject.scale)}e.quaternion.copy(this.gameObject.quaternion),s&&e.rotateY(Math.PI),this.rect.applyAnchoring(e.position),this._lastMatrixWorld.copy(this.gameObject.matrixWorld)}awake(){this._lastMatrixWorld=new Ce}setInteractable(e){this.shadowComponent&&(this.shadowComponent.interactable=e)}onBeforeRender(){this._lastMatrixWorld.equals(this.gameObject.matrixWorld)===!1&&(Nb&&console.log("updating",this.name),this.applyTransform()),Te.ensureUpdateMeshUI(cp,this.context)}isRoot(){return!1}}$d(dt,"BaseUIComponent");class Cs extends dt{isRoot(){return!0}}$d(Cs,"UIRootComponent");var Wd=Object.defineProperty,zb=Object.getOwnPropertyDescriptor,Hd=(i,e)=>Wd(i,"name",{value:e,configurable:!0}),Gd=(i,e,t,s)=>{for(var n=s>1?void 0:s?zb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Wd(e,t,n),n};class Tt extends dt{constructor(){super(...arguments);r(this,"raycastTarget",!0);r(this,"_container",null);r(this,"_color",null);r(this,"_currentlyCreatingPanel",!1)}get color(){return this._color}set color(e){const t=!0;this._color=e,this._container&&t&&this.onColorChanged(this._color)}onColorChanged(e){this.setOptions({backgroundColor:e,backgroundOpacity:e.alpha,borderOpacity:e.alpha})}get m_Color(){return this.color}onBeforeRender(){super.onBeforeRender(),this.color=this.m_Color}setState(e){this.makePanel(),this._container&&this._container.setState(e)}setupState(e){this.makePanel(),this._container&&this._container.setupState(e)}setOptions(e){var t;this.makePanel(),this._container&&(this._container.set(e),(e.backgroundColor!==void 0||e.backgroundOpacity!==void 0)&&((t=this._container.updateBackgroundMaterial)==null||t.call(this._container)))}awake(){super.awake(),this.makePanel()}onEnable(){this._container&&this.addToShadowComponent(this._container)}onDisable(){this._container&&this.removeShadowComponent()}makePanel(){if(this._container||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const e={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:1};this.onBeforeCreate(e),this.onCreate(e),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated()}onBeforeCreate(e){}onCreate(e){this._container=this.rect.createBlock(e)}onAfterCreated(){}async setTexture(e){!e||(this.setOptions({backgroundOpacity:0}),e&&this.setOptions({backgroundTexture:e,borderRadius:0,backgroundOpacity:this.color.alpha}))}onAfterAddedToScene(){this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}}Hd(Tt,"Graphic");Gd([g(Fe)],Tt.prototype,"color",1);Gd([g()],Tt.prototype,"raycastTarget",2);class Ss extends Tt{}Hd(Ss,"MaskableGraphic");var Vd=Object.defineProperty,$b=Object.getOwnPropertyDescriptor,ka=(i,e)=>Vd(i,"name",{value:e,configurable:!0}),La=(i,e,t,s)=>{for(var n=s>1?void 0:s?$b(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Vd(e,t,n),n};class Ta{constructor(){r(this,"texture")}}ka(Ta,"Sprite");La([g(Hr)],Ta.prototype,"texture",2);class Rs extends Ss{constructor(){super(...arguments);r(this,"sprite")}onBeforeCreate(e){var t,s;((s=(t=this.sprite)==null?void 0:t.texture)==null?void 0:s.name)=="UISprite"&&(e.borderRadius=5,e.borderColor=new f(.4,.4,.4),e.borderOpacity=this.color.alpha,e.borderWidth=.3)}onAfterCreated(){var e,t,s;((t=(e=this.sprite)==null?void 0:e.texture)==null?void 0:t.name)!="UISprite"&&this.setTexture((s=this.sprite)==null?void 0:s.texture)}}ka(Rs,"Image");La([g(Ta)],Rs.prototype,"sprite",2);class fr extends Ss{constructor(){super(...arguments);r(this,"mainTexture")}async onAfterCreated(){this.setTexture(this.mainTexture)}}ka(fr,"RawImage");La([g(Hr)],fr.prototype,"mainTexture",2);var qd=Object.defineProperty,Wb=Object.getOwnPropertyDescriptor,Hb=(i,e)=>qd(i,"name",{value:e,configurable:!0}),Ei=(i,e,t,s)=>{for(var n=s>1?void 0:s?Wb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&qd(e,t,n),n};const Ai=v("debugbutton");var Xd;(function(i){i[i.None=0]="None",i[i.ColorTint=1]="ColorTint",i[i.SpriteSwap=2]="SpriteSwap",i[i.Animation=3]="Animation"})(Xd||(Xd={}));class ut extends w{constructor(){super(...arguments);r(this,"onClick");r(this,"_isHovered",!1);r(this,"colors");r(this,"transition");r(this,"animationTriggers");r(this,"animator");r(this,"_interactable",!0);r(this,"_isInit",!1);r(this,"_image")}onPointerEnter(e){var t;Ai&&console.log("Button Enter",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this._isHovered=!0,this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.highlightedTrigger)}onPointerExit(){var e;Ai&&console.log("Button Exit",(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this._isHovered=!1,this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.normalTrigger)}onPointerDown(e){var t;Ai&&console.log("Button Down",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.pressedTrigger)}onPointerUp(e){var t;Ai&&console.log("Button Down",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger)}onPointerClick(e){var t;Ai&&console.trace("Button Click",this.onClick),(t=this.onClick)==null||t.invoke()}set interactable(e){this._interactable=e,this._image&&(this._image.setInteractable(e),e?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(e){this.interactable=e}awake(){Ai&&console.log(this),this.init()}start(){var e;(e=this._image)==null||e.setInteractable(this.interactable)}init(){this._isInit||(this._isInit=!0,this._image=p.getComponent(this.gameObject,Rs),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(e){var _,b,x,O,R;e.setInteractable(this.interactable);const t=this.getFinalColor(e.color,(_=this.colors)==null?void 0:_.m_NormalColor),s={state:"normal",attributes:{backgroundColor:t,backgroundOpacity:t.alpha}};e.setupState(s);const n=this.getFinalColor(e.color,(b=this.colors)==null?void 0:b.m_HighlightedColor),o={state:"hovered",attributes:{backgroundColor:n,backgroundOpacity:n.alpha}};e.setupState(o);const a=this.getFinalColor(e.color,(x=this.colors)==null?void 0:x.m_PressedColor),l={state:"pressed",attributes:{backgroundColor:a,backgroundOpacity:a.alpha}};e.setupState(l);const c=this.getFinalColor(e.color,(O=this.colors)==null?void 0:O.m_SelectedColor),h={state:"selected",attributes:{backgroundColor:c,backgroundOpacity:c.alpha}};e.setupState(h);const d=this.getFinalColor(e.color,(R=this.colors)==null?void 0:R.m_DisabledColor),u={state:"disabled",attributes:{backgroundColor:d,backgroundOpacity:d.alpha}};e.setupState(u)}getFinalColor(e,t){return t?e.clone().multiply(t):e.clone()}}Hb(ut,"Button");Ei([g(He)],ut.prototype,"onClick",2);Ei([g()],ut.prototype,"colors",2);Ei([g()],ut.prototype,"transition",2);Ei([g()],ut.prototype,"animationTriggers",2);Ei([g(tt)],ut.prototype,"animator",2);Ei([g()],ut.prototype,"interactable",1);var Gb=Object.defineProperty,Vb=(i,e)=>Gb(i,"name",{value:e,configurable:!0});class Da extends Cs{awake(){super.awake(),this.shadowComponent=this.gameObject}onUpdateRenderOnTop(){for(const e of this.gameObject.getComponentsInChildren(dt))e.renderOnTop=this.renderOnTop}}Vb(Da,"Canvas");var qb=Object.defineProperty,Xb=(i,e)=>qb(i,"name",{value:e,configurable:!0});class Ma extends w{constructor(){super(...arguments);r(this,"_alpha",1);r(this,"interactable",!0);r(this,"blocksRaycasts",!0);r(this,"_isDirty",!1);r(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(e){e!==this._alpha&&(this._alpha=e,this.markDirty())}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),Pe.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){for(const e of p.getComponentsInChildren(this.gameObject,Tt,this._buffer)){const t=e.color;t.alpha=this._alpha,e.color=t}}}Xb(Ma,"CanvasGroup");var Qb=Object.defineProperty,Yb=(i,e)=>Qb(i,"name",{value:e,configurable:!0}),Ia;(function(i){i[i.fr=0]="fr",i[i.ru=1]="ru",i[i.de=2]="de",i[i.es=3]="es",i[i.el=4]="el",i[i.nord=5]="nord",i[i.eng=6]="eng"})(Ia||(Ia={}));class ja extends dt{constructor(){super(...arguments);r(this,"font");r(this,"text");r(this,"keymap");r(this,"padding");r(this,"margin");r(this,"fontSize");r(this,"borderRadius");r(this,"colors",{keyboardBack:8750469,panelBack:2500134,button:3552822,hovered:1842204,selected:1088605});r(this,"keyboard",null);r(this,"_lastKeyPressed");r(this,"_lastKeyPressedStartTime",0);r(this,"_lastKeyPressedTime",0)}awake(){super.awake();const e=Ia[this.keymap||6];this.makeKeyboard(e)}onEnable(){this.addToShadowComponent(this.keyboard)}onDisable(){this.removeShadowComponent()}makeKeyboard(e){!e&&!navigator.language&&(e="en");const t=this.font?this.font:"arial",s=this.rect,n=jr(bt({},s.getBasicOptions()),{margin:this.margin||0,padding:this.padding||0,language:e,fontFamily:Zt+"/"+t+"-msdf.json",fontTexture:Zt+"/"+t+".png",fontSize:this.fontSize||6,backgroundColor:new f(this.colors.keyboardBack),backspaceTexture:Zt+"/backspace.png",shiftTexture:Zt+"/shift.png",enterTexture:Zt+"/enter.png",borderRadius:this.borderRadius||0,autoLayout:!1}),o=this.gameObject.scale;n.width*=this.gameObject.scale.x,n.height*=this.gameObject.scale.y,n.fontSize*=Math.max(o.x,o.y),this.keyboard=new hp(n),this.gameObject.scale.set(1,1,1),this.keyboard.keys.forEach(a=>{a.setupState({state:"normal",attributes:{offset:.003,backgroundColor:new f(this.colors.button),backgroundOpacity:1}}),a.setState("normal"),a.setupState({state:"hovered",attributes:{offset:.3,backgroundColor:new f(this.colors.hovered),backgroundOpacity:1}}),a.setupState({state:"pressed",attributes:{offset:.1,backgroundColor:new f(this.colors.selected),backgroundOpacity:1},onSet:()=>{var h,d,u;const l=a.info.input,c=a.info.command;if(this._lastKeyPressed!==l)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedTime>.05)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedStartTime<.5||c=="switch"||c=="shift"||c=="switch-set"){this._lastKeyPressedTime=this.context.time.time;return}if(this._lastKeyPressedTime=this.context.time.time,this._lastKeyPressed=l,c)switch(c){case"switch":this.keyboard.setNextPanel();break;case"switch-set":this.keyboard.setNextCharset();break;case"enter":this.tryAppend(`
`);break;case"space":this.tryAppend(" ");break;case"backspace":if(!((d=(h=this.text)==null?void 0:h.text)==null?void 0:d.length))break;((u=this.text)==null?void 0:u.text)&&(this.text.text=this.text.text.substring(0,this.text.text.length-1)||"");break;case"shift":this.keyboard.toggleCase();break}else a.info.input!==void 0&&this.tryAppend(a.info.input)}})})}tryAppend(e){this.text&&(this.text.text+=e,this.markDirty())}}Yb(ja,"Keyboard");var Jb=Object.defineProperty,pr=(i,e)=>Jb(i,"name",{value:e,configurable:!0});class ki extends w{constructor(){super(...arguments);r(this,"reverseArrangement",!1)}}pr(ki,"LayoutGroup");class Fa extends ki{}pr(Fa,"VerticalLayoutGroup");class Ba extends ki{}pr(Ba,"HorizontalLayoutGroup");class Ua extends ki{}pr(Ua,"GridLayoutGroup");var Zb=Object.defineProperty,Na=(i,e)=>Zb(i,"name",{value:e,configurable:!0});class mr extends w{awake(){Te.createIfNoneExists(this.context)}onEnable(){var e;(e=Te.instance)==null||e.register(this)}onDisable(){var e;(e=Te.instance)==null||e.unregister(this)}performRaycast(e=null){return null}}Na(mr,"Raycaster");class Li extends mr{constructor(){super(...arguments);r(this,"targets",null);r(this,"raycastHits",[])}start(){this.targets=[this.gameObject]}performRaycast(e=null){return this.targets?(e!=null||(e=new je),e.targets=this.targets,e.results=this.raycastHits,this.context.physics.raycast(e)):null}}Na(Li,"ObjectRaycaster");class za extends Li{constructor(){super(...arguments);r(this,"eventCamera",null);r(this,"ignoreReversedGraphics",!1);r(this,"rootRaycaster",null)}}Na(za,"GraphicRaycaster");var Kb=Object.defineProperty,ey=(i,e)=>Kb(i,"name",{value:e,configurable:!0});class $a extends w{constructor(){super(...arguments);r(this,"id",null);r(this,"keepAspect",!1)}start(){if(!this.id||!this.context.mainCamera)return;const e=document.getElementById(this.id);if(!e){console.warn('Could not find element with id "'+this.id+'"');return}e.style.display="block",e.style.visibility="hidden";const t=new dp(this.context.renderer,this.context.mainCamera);this.gameObject.add(t);const s=new up(e);t.add(s),s.visible=!1,console.log(s);const n=s.material;n.transparent=!0,setTimeout(()=>{s.visible=!0;const o=no(this.gameObject).clone();Qs(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const a=new ii;a.setFromObject(t),this.setWorldRotation(o.x,o.y,o.z);const l=a.max.x-a.min.x,c=a.max.y-a.min.y;if(this.keepAspect){const d=l/c;l>c?s.scale.set(1/l,1/c/d,1):s.scale.set(1/l*d,1/c,1)}else s.scale.set(1/l,1/c,1);const h=this.gameObject.scale;s.scale.multiply(h)},1)}}ey($a,"SpatialHtml");var Qd=Object.defineProperty,ty=Object.getOwnPropertyDescriptor,Wa=(i,e)=>Qd(i,"name",{value:e,configurable:!0}),qe=(i,e,t,s)=>{for(var n=s>1?void 0:s?ty(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Qd(e,t,n),n},Yd;(function(i){i[i.UpperLeft=0]="UpperLeft",i[i.UpperCenter=1]="UpperCenter",i[i.UpperRight=2]="UpperRight",i[i.MiddleLeft=3]="MiddleLeft",i[i.MiddleCenter=4]="MiddleCenter",i[i.MiddleRight=5]="MiddleRight",i[i.LowerLeft=6]="LowerLeft",i[i.LowerCenter=7]="LowerCenter",i[i.LowerRight=8]="LowerRight"})(Yd||(Yd={}));var Jd;(function(i){i[i.Truncate=0]="Truncate",i[i.Overflow=1]="Overflow"})(Jd||(Jd={}));var Zd;(function(i){i[i.Wrap=0]="Wrap",i[i.Overflow=1]="Overflow"})(Zd||(Zd={}));var Kd;(function(i){i[i.Normal=0]="Normal",i[i.Bold=1]="Bold",i[i.Italic=2]="Italic",i[i.BoldAndItalic=3]="BoldAndItalic"})(Kd||(Kd={}));class ge extends Tt{constructor(){super(...arguments);r(this,"canvas");r(this,"alignment",0);r(this,"verticalOverflow",0);r(this,"horizontalOverflow",0);r(this,"lineSpacing",1);r(this,"supportRichText",!1);r(this,"font");r(this,"fontStyle",0);r(this,"_isWaitingForRebuild",!1);r(this,"_text","");r(this,"_fontSize",12);r(this,"_textMeshUi",null);r(this,"_textContainer",null);r(this,"_didHandleTextRenderOnTop",!1)}get text(){return this._text}set text(e){if(this._text=e,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:e}),this.markDirty()}}set_text(e){this.text=e}get fontSize(){return this._fontSize}set fontSize(e){if(this._fontSize=e,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:e}),this.markDirty()}}onColorChanged(e){if(this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({fontColor:e,fontOpacity:e.alpha}),this.markDirty()}}requestRebuild(){this._isWaitingForRebuild||(this._isWaitingForRebuild=!0,this.startCoroutine(this.rebuildDelayedRoutine(),Pe.EarlyUpdate))}*rebuildDelayedRoutine(){if(this._isWaitingForRebuild=!1,this._textMeshUi){for(const e of this._textMeshUi)e.removeFromParent();this._textMeshUi.length=0}this.createText(this.text,this.getTextOpts(),this.supportRichText),this.markDirty()}onCreate(e){const t=this.verticalOverflow==0&&this.horizontalOverflow==0;t&&(this.context.renderer.localClippingEnabled=!0);const s=this.rect;this._textContainer=this._container=this.createBlock(s,t,null,!0),this.createText(this.text,this.getTextOpts(),this.supportRichText),this._container,this._container=this.createBlock(s,t,this._container,!1)}onUpdateRenderOnTop(){super.onUpdateRenderOnTop(),this.handleTextRenderOnTop()}getTextOpts(){var t;const e={content:this.text,fontColor:this.color,fontOpacity:this.color.alpha,fontSize:this.fontSize,fontKerning:"normal"};return this.font=(t=this.font)==null?void 0:t.toLocaleLowerCase(),this.setFont(e,this.fontStyle),e}onEnable(){super.onEnable(),this._didHandleTextRenderOnTop=!1,this._container&&(this._container.onAfterUpdate=this.updateWidth.bind(this))}createBlock(e,t,s,n=!1){const o={};o.hiddenOverflow=t,o.interLine=(this.lineSpacing-1)*this.fontSize*1.333,this.getAlignment(o,n);const a=e.createBlock(o);return s&&(Array.isArray(s)?a.add(...s):a.add(s)),a}getAlignment(e,t=!1){switch(t||(e.contentDirection="row"),this.alignment){default:case 0:case 1:case 2:e.justifyContent="start";break;case 3:case 4:case 5:e.justifyContent="center";break;case 6:case 7:case 8:e.justifyContent="end";break}switch(this.alignment){case 0:case 3:case 6:e.alignContent=t?"left":"top";break;case 1:case 4:case 7:e.alignContent="center";break;case 2:case 5:case 8:e.alignContent=t?"right":"bottom";break}return e}updateWidth(){this.horizontalOverflow===1&&setTimeout(()=>{if(!this._textMeshUi)return;const e=this._textMeshUi[0].parent;if(!!e&&e.lines){let t=e.lines.reduce((s,n)=>s+n.width,0);t+=e.getFontSize()*3,t+=e.padding*2||0,e.set({width:t})}},1)}createText(e,t,s){if(!(!e||e.length<=0))if(this._textMeshUi||(this._textMeshUi=[]),s){let n=this.getNextTag(e);if(n)n.startIndex>0&&this.createText(e.substring(0,n.startIndex),t,!1);else return this.createText(e,t,!1);const o=[];for(;n;){const a=this.getNextTag(e,n.endIndex);if(a){const l=this.getText(e,n,a);this.handleTag(n,t,o),this.createText(l,t,!1)}else{const l=e.substring(n.endIndex);this.handleTag(n,t,o),this.createText(l,t,!1)}n=a}}else{const n=bt({},t);n.content=e;const o=new fp(n);this._textMeshUi.push(o),this._textContainer&&this._textContainer.add(o)}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){const e=[];for(;;){let t=!1;if(this._textMeshUi)for(let s=0;s<this._textMeshUi.length;s++){if(e[s]===!0)continue;t=!0;const n=this._textMeshUi[s];!n.textContent||(ur(n,this.renderOnTop,!0),e[s]=!0)}if(!t)break;yield}}handleTag(e,t,s){if(e.isEndTag){if(s.length>0){const n=s.pop();if(n)for(const o in n.previousValues){const a=n.previousValues[o];t[o]=a}}}else if(e.type.includes("color")){const n=new gr(e,{fontColor:t.fontColor});if(s.push(n),e.type.length>6){const o=e.type.substring(6);t.fontColor=eu(o)}else t.fontColor=new f(1,1,1)}else if(e.type=="b"){const n=new gr(e,{fontFamily:t.fontFamily,fontTexture:t.fontTexture});s.push(n),this.setFont(t,1)}else if(e.type=="i"){const n=new gr(e,{fontFamily:t.fontFamily,fontTexture:t.fontTexture});s.push(n),this.setFont(t,2)}}getText(e,t,s){return e.substring(t.endIndex,s.startIndex)}getNextTag(e,t=0){const s=e.indexOf("<",t),n=e.indexOf(">",s);if(s>=0&&n>=0){const o=e.substring(s+1,n);return{type:o,startIndex:s,endIndex:n+1,isEndTag:o.startsWith("/")}}return null}setFont(e,t){e.fontFamily=Zt+"/"+this.getFontName(t)+"-msdf.json",e.fontTexture=Zt+"/"+this.getFontName(t)+".png"}getFontName(e){if(!this.font)return null;switch(e){case 0:return this.font;case 1:return this.font+"-bold";case 2:return this.font+"-italic";case 3:return this.font+"-bold-italic"}return null}}Wa(ge,"Text");qe([g()],ge.prototype,"canvas",2);qe([g()],ge.prototype,"alignment",2);qe([g()],ge.prototype,"verticalOverflow",2);qe([g()],ge.prototype,"horizontalOverflow",2);qe([g()],ge.prototype,"lineSpacing",2);qe([g()],ge.prototype,"supportRichText",2);qe([g()],ge.prototype,"font",2);qe([g()],ge.prototype,"fontStyle",2);qe([g()],ge.prototype,"text",1);qe([g()],ge.prototype,"fontSize",1);class gr{constructor(e,t){r(this,"tag");r(this,"previousValues");this.tag=e,this.previousValues=t}}Wa(gr,"TagStackEntry");function eu(i){if(i.startsWith("#")){const t=i.substring(1);var e=parseInt(t,16);const s=e>>16&255,n=e>>8&255,o=e&255;return new f(s/255,n/255,o/255)}switch(i){case"black":return new f(0,0,0);case"white":return new f(1,1,1);case"red":return new f(1,0,0);case"lime":return new f(0,1,0);case"blue":return new f(0,0,1);case"yellow":return new f(1,1,0);case"cyan":return new f(0,1,1);case"magenta":return new f(1,0,1);case"silver":return new f(.75,.75,.75);case"gray":return new f(.5,.5,.5);case"maroon":return new f(.5,0,0);case"olive":return new f(.5,.5,0);case"green":return new f(0,.5,0);case"purple":return new f(.5,0,.5);case"teal":return new f(0,.5,.5);case"navy":return new f(0,0,.5);case"darkred":return new f(.54,0,0);case"brown":return new f(.55,.27,0);case"firebrick":return new f(.69,.13,.13);case"crimson":return new f(.86,.08,.24);case"tomato":return new f(1,.39,.28);case"coral":return new f(1,.49,.31);case"indianred":return new f(.6,.31,.51);case"lightcoral":return new f(.94,.5,.5);case"darkorange":return new f(1,.55,0);case"orange":return new f(1,.65,0);case"gold":return new f(1,.84,0);case"darkgoldenrod":return new f(.72,.53,.04);case"goldenrod":return new f(.85,.65,.13);case"palegoldenrod":return new f(.93,.87,.67);case"darkkhaki":return new f(.74,.7,.42);case"khaki":return new f(.94,.9,.55);case"yellowgreen":return new f(.6,.8,.19);case"darkolivegreen":return new f(.33,.42,.18);case"olivedrab":return new f(.42,.56,.14);case"lawngreen":return new f(.49,.99,0);case"chartreuse":return new f(.5,1,0);case"greenyellow":return new f(.68,1,.18);case"darkgreen":return new f(0,.39,0);case"forestgreen":return new f(.13,.55,.13);case"limegreen":return new f(.19,.8,.19);case"lightgreen":return new f(.56,.93,.56);case"palegreen":return new f(.59,.98,.59);case"darkseagreen":return new f(.56,.74,.56);case"mediumspringgreen":return new f(0,.98,.6);case"springgreen":return new f(0,1,.5);case"seagreen":return new f(.18,.31,.31);case"mediumaquamarine":return new f(.4,.8,.66);case"mediumseagreen":return new f(.24,.7,.44);case"lightseagreen":return new f(.13,.7,.67);case"darkslategray":return new f(.18,.31,.31);case"darkcyan":return new f(0,.55,.55);case"aqua":return new f(0,1,1);case"lightcyan":return new f(.8,1,1);case"darkturquoise":return new f(0,.81,.82);case"turquoise":return new f(0,.82,.82);case"mediumturquoise":return new f(.28,.82,.8);case"paleturquoise":return new f(.68,1,.93);case"aquamarine":return new f(.5,1,.83);case"powderblue":return new f(.69,.88,.9);case"cadetblue":return new f(.37,.62,.63);case"steelblue":return new f(.27,.51,.71);case"cornflowerblue":return new f(.39,.58,.93);case"deepskyblue":return new f(0,.7,1);case"dodgerblue":return new f(.12,.56,1);case"lightblue":return new f(.68,.85,.9);case"skyblue":return new f(.53,.81,.92);case"lightskyblue":return new f(.53,.81,.98);case"midnightblue":return new f(.18,.18,.31);case"darkblue":return new f(0,0,.55);case"mediumblue":return new f(0,0,.82);case"royalblue":return new f(.25,.41,.88);case"blueviolet":return new f(.54,.17,.89);case"indigo":return new f(.29,0,.51);case"darkslateblue":return new f(.28,.24,.55);case"slateblue":return new f(.42,.35,.8);case"mediumslateblue":return new f(.48,.41,.9);case"mediumpurple":return new f(.58,.44,.86);case"darkmagenta":return new f(.55,0,.55);case"darkviolet":return new f(.58,0,.83);case"darkorchid":return new f(.6,.2,.8);case"mediumorchid":return new f(.73,.33,.83);case"thistle":return new f(.84,.75,.85);case"plum":return new f(.87,.63,.87);case"violet":return new f(.93,.51,.93);case"fuchsia":return new f(1,0,1);case"orchid":return new f(.85,.44,.84);case"mediumvioletred":return new f(.78,.08,.52);case"palevioletred":return new f(.86,.44,.58);case"hotpink":return new f(1,.4,.71);case"deeppink":return new f(1,.08,.58);case"lightpink":return new f(1,.71,.76);case"pink":return new f(1,.75,.78);case"antiquewhite":return new f(.98,.92,.84);case"beige":return new f(.96,.96,.86);case"bisque":return new f(1,.89,.77);case"blanchedalmond":return new f(1,.92,.82);case"wheat":return new f(.96,.87,.87);case"cornsilk":return new f(1,.97,.86);case"lemonchiffon":return new f(1,.98,.8);case"lightgoldenrodyellow":return new f(.98,.98,.82);case"lightyellow":return new f(1,1,.8);case"saddlebrown":return new f(.55,.27,.07);case"sienna":return new f(.63,.32,.18);case"chocolate":return new f(.82,.41,.12);case"peru":return new f(.82,.52,.25);case"sandybrown":return new f(.96,.64,.38);case"burlywood":return new f(.87,.72,.53);case"tan":return new f(.82,.71,.55);case"rosybrown":return new f(.74,.56,.56);case"moccasin":return new f(1,.89,.71);case"navajowhite":return new f(1,.87,.68);case"peachpuff":return new f(1,.85,.73);case"mistyrose":return new f(1,.89,.88);case"lavenderblush":return new f(1,.94,.93);case"linen":return new f(.98,.94,.9);case"oldlace":return new f(.99,.96,.9);case"papayawhip":return new f(1,.94,.84);case"seashell":return new f(1,.96,.93);case"mintcream":return new f(.98,1,.98);case"slategray":return new f(.44,.5,.56);case"lightslategray":return new f(.47,.53,.6);case"lightsteelblue":return new f(.69,.77,.87);case"lavender":return new f(.9,.9,.98);case"floralwhite":return new f(1,.98,.98);case"aliceblue":return new f(.94,.97,1);case"ghostwhite":return new f(.97,.97,1);case"honeydew":return new f(.94,1,.94);case"ivory":return new f(1,1,.94);case"azure":return new f(.94,1,1);case"snow":return new f(1,.98,.98);case"dimgray":return new f(.4,.4,.4);case"darkgray":return new f(.66,.66,.66);case"lightgray":return new f(.83,.83,.83);case"gainsboro":return new f(.86,.86,.86);case"whitesmoke":return new f(.96,.96,.96)}return new f(1,1,1)}Wa(eu,"getColorFromString");var iy=Object.defineProperty,sy=(i,e)=>iy(i,"name",{value:e,configurable:!0});class Ha extends w{constructor(){super(...arguments);r(this,"toggleKey",Ze.KEY_P)}update(){this.context.input.isKeyDown(Ze.KEY_P)&&this.context.domElement.classList.toggle("presentation-mode")}}sy(Ha,"PresentationMode");var ny=Object.defineProperty,tu=(i,e)=>ny(i,"name",{value:e,configurable:!0});const pl=class{constructor(e,t){r(this,"id",0);r(this,"points",[]);r(this,"line",new Gr.exports.MeshLine);r(this,"material");r(this,"mesh");r(this,"defaultLineMaterial",new Gr.exports.MeshLineMaterial({color:10066329,lineWidth:.01}));if(t&&(this.material=t.material),this.material||(this.material=this.defaultLineMaterial),t){const s=t.options;s&&Object.assign(this.material,s)}this.mesh=new ni(this.line,this.material),e.add(this.mesh)}appendPoint(e){var n;let t=pl.wp;t.set(e.x,e.y,e.z);const s=(n=this.mesh)==null?void 0:n.parent;return s&&(t=s.worldToLocal(t),e.x=t.x,e.y=t.y,e.z=t.z),this.points.push(e.x,e.y,e.z),this.line.setPoints(this.points),e}};let Ti=pl;r(Ti,"wp",new y);tu(Ti,"LineInstanceHandler");class Es extends w{constructor(){super(...arguments);r(this,"finished",[]);r(this,"inFlight",[]);r(this,"buffer",{});r(this,"freeBuffer",new Array)}startLine(e,t){const s=Math.random()*Number.MAX_SAFE_INTEGER;return this.internalStartLine(e,s,!0,t)}updateLine(e,t){const s=this.inFlight[e.id];if(!s)return;t.point&&(t.point=s.appendPoint(t.point));const n=this.buffer[e.id];n&&(t.point&&n.push(t.point.x,t.point.y,t.point.z),n.length>5&&(this.sendLineUpdate(s,!1,void 0,n),n.length=0))}endLine(e,t=!0){const s=this.inFlight[e.id];if(!s)return;this.finished.push(s),delete this.inFlight[e.id],t&&this.sendLineUpdate(s,!0,0);const n=this.buffer[e.id];if(n){delete this.buffer[e.id];const o=n;o.length=0,this.freeBuffer.push(o)}return s}getLine(e){return this.inFlight[e.id]}awake(){this.context.connection.beginListen("line-start",e=>{this.onEnsureLine(e.id,e.parentGuid)}),this.context.connection.beginListen("line-update",e=>{let t=this.onEnsureLine(e.guid,e.parentGuid);t&&e.points&&(e.startIndex<=0?t.points=e.points:e.startIndex>=t.points.length&&t.points.push(...e.points),t.line.setPoints(t.points),t.material.lineWidth=e.width,t.material.color.fromArray(e.color),e.finished===!0&&this.endLine({id:t.id},!1))})}onEnsureLine(e,t){if(this.inFlight[e])return this.inFlight[e];let s=p.findByGuid(t,this.context.scene);if(!!s)return this.internalStartLine(s,e,!1),this.inFlight[e]}internalStartLine(e,t,s=!0,n){const o=new Ti(e!=null?e:this.context.scene,n);o.id=t,this.inFlight[t]=o,s&&this.sendLineStart(o);let a;return this.freeBuffer.length<=0?a=new Array:a=this.freeBuffer.pop(),this.buffer[t]=a,{id:t}}sendLineStart(e){const t=e.mesh.parent;this.context.connection.send("line-start",{id:e.id,parentGuid:t?t.guid:void 0})}sendLineUpdate(e,t,s,n){if(e){const o={parentGuid:e.mesh.parent.guid,guid:e.id,points:n?[...n]:e.points,width:e.material.lineWidth,color:e.material.color.toArray(),startIndex:s!==void 0?s:e.points.length,finished:t};this.context.connection.send("line-update",o)}}}tu(Es,"LinesManager");var ry=Object.defineProperty,iu=(i,e)=>ry(i,"name",{value:e,configurable:!0});class Ga{constructor(){r(this,"isDrawing");r(this,"lastHit");r(this,"currentHandle");r(this,"maxDistance");r(this,"prevDistance");r(this,"lastParent");this.isDrawing=!1,this.lastHit=new y,this.currentHandle=null,this.maxDistance=0,this.prevDistance=0,this.lastParent=null}}iu(Ga,"LineState");const Dr=class extends w{constructor(){super(...arguments);r(this,"lines");r(this,"colliders");r(this,"alignToSurface",!0);r(this,"addToPaintedObject",!0);r(this,"orbit");r(this,"_states",{});r(this,"_raycastOptions",new je)}start(){var t;this.lines||(this.lines=p.getComponent(this.gameObject,Es),this.lines||(this.lines=p.addNewComponent(this.gameObject,Es))),this.orbit=(t=p.findObjectOfType(zt,this.context))!=null?t:void 0,this._states.mouse=new Ga;const e={};j.addEventListener(pe.SelectStart,(s,n)=>{e[s.controller.uuid]=!0}),j.addEventListener(pe.Update,(s,n)=>{if(e[s.controller.uuid]===!0){const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!1,!1)}}),j.addEventListener(pe.SelectEnd,(s,n)=>{e[s.controller.uuid]=!1;const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!0,!1)})}update(){this.orbit&&this._states.mouse&&this.orbit&&(this.orbit.enabled=!this._states.mouse.isDrawing);const e=this.context.input.getPointerPressedCount()>1,t=this.context.input.getPointerPositionRC(0);Dr._raycaster.setFromCamera(t,this.context.mainCamera);const s=Dr._raycaster.ray;this.updateLine("mouse",s,this.context.input.getPointerPressed(0),this.context.input.getPointerUp(0),e||this.context.input.isKeyPressed(Ze.ALT))}updateLine(e,t,s,n,o=!1){var l;let a=this._states[e];if(a||(this._states[e]=new Ga,a=this._states[e]),n)a.isDrawing=!1,a.currentHandle&&(this.lines.endLine(a.currentHandle),a.currentHandle=null);else if(s){if(o)return a;const c=this.getHit(t);let h=null,d=a.prevDistance;if(c)a.currentHandle||(a.maxDistance=c.distance),h=c.point,h.add(c.face.normal.multiplyScalar(.01)),a.prevDistance=c.distance;else if(a.maxDistance>0){if(a.maxDistance,!a.currentHandle&&a.lastHit){const u=C(this.context.mainCamera);a.lastHit.distanceTo(u)}h=t.origin.add(t.direction.multiplyScalar(a.maxDistance)),a.prevDistance=a.maxDistance}if(h){if(!a.currentHandle){let u=(l=a.lastParent)!=null?l:this.gameObject;this.addToPaintedObject&&c&&(u=c.object),a.lastParent=u,a.currentHandle=this.lines.startLine(u,{material:this.createRandomMaterial()})}if(this.alignToSurface&&(a.prevDistance>a.maxDistance||Math.abs(d-a.prevDistance)>.2)){const u=a.maxDistance;h=t.origin.add(t.direction.multiplyScalar(u)),a.prevDistance=u}if(a.lastHit&&a.lastHit.distanceTo(h)<a.prevDistance*.01)return a;this.lines.updateLine(a.currentHandle,{point:h}),a.lastHit.copy(h)}a.isDrawing=a.currentHandle!==null}return a}getHit(e){(!this.colliders||this.colliders.length===0)&&(this.colliders=[this.gameObject]),this._raycastOptions.targets=this.colliders,this._raycastOptions.ray=e;const t=this.context.physics.raycast(this._raycastOptions);if(t.length>0){for(const s of t)if(!!p.isActiveInHierarchy(s.object))return s}return null}createRandomMaterial(){let e;return this.context.connection.connectionId?e=ht.colorFromHashCode(ht.hashCode(this.context.connection.connectionId)):e=new f("hsl("+(Math.random()*100).toFixed(0)+", 80%, 30%)"),new Gr.exports.MeshLineMaterial({color:e,lineWidth:k.lerp(.005,.01,Math.random())})}};let As=Dr;r(As,"_raycaster",new Fr);iu(As,"LinesDrawer");var oy=Object.defineProperty,ks=(i,e)=>oy(i,"name",{value:e,configurable:!0});const su=v("debugautosync");class nu{constructor(){r(this,"_syncers",{})}getOrCreateSyncer(e){if(!e.guid)return null;if(this._syncers[e.guid])return this._syncers[e.guid];const t=new ou(e);return this._syncers[e.guid]=t,t}}ks(nu,"ComponentsSyncerManager");const ru=new nu;class ou{constructor(e){r(this,"comp");r(this,"hasChanges",!1);r(this,"changedProperties",{});r(this,"data",{});r(this,"_boundEvent");r(this,"_isReceiving",!1);r(this,"_isInit",!1);this.comp=e}get networkingKey(){return this.comp.constructor.name}init(e){if(this._isInit)return;this._isInit=!0,this.comp=e,this._boundEvent=this.onHandleSending.bind(this),this.comp.context.post_render_callbacks.push(this._boundEvent),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving.bind(this));const t=this.comp.context.connection.tryGetState(this.comp.guid);t&&this.onHandleReceiving(t)}notifyChanged(e,t){this._isReceiving||(this.hasChanges=!0,this.changedProperties[e]=t)}onHandleSending(){if(!this.hasChanges)return;this.hasChanges=!1;const e=this.comp.context.connection;if(!e||!e.isConnected){for(const t in this.changedProperties)delete this.changedProperties[t];return}for(const t in this.data)delete this.data[t];this.data.guid=this.comp.guid;for(const t in this.changedProperties){const s=this.changedProperties[t];delete this.changedProperties[t],this.data[t]=s}e.send(this.networkingKey,this.data)}onHandleReceiving(e){if(!this._isInit||!this.comp)return;const t=e.guid;if(!(t&&t!==this.comp.guid)){su&&console.log("RECEIVED",this.comp.name,this.comp.guid,e);try{this._isReceiving=!0;for(const s in e){if(s==="guid")continue;const n=e[s];this.comp[s]=n}}catch(s){console.error(s)}finally{this._isReceiving=!1}}}}ks(ou,"ComponentPropertiesSyncer");function au(i,e){let t=e!==i;if(!t&&i&&e){if(Array.isArray(i)&&Array.isArray(e))t=!0;else if(typeof i=="object"&&typeof e=="object"){for(const s of Object.keys(i))if(i[s]!==e[s]){t=!0;break}}}return t}ks(au,"testValueChanged");function lu(i){if(i.__autoPropertySyncHandler)return i.__autoPropertySyncHandler;const e=ru.getOrCreateSyncer(i);return e==null||e.init(i),i.__autoPropertySyncHandler=e,e}ks(lu,"getSyncer");const ay=ks(function(i){return function(e,t){let s=null;const n=i?e[i]:void 0,o=e,a=o.__internalAwake;su&&console.log(t);const l=t+"k__BackingField";o.__internalAwake=function(){if(this[l]!==void 0)return;this[l]=this[t],a.call(this),s=ru.getOrCreateSyncer(this);const c=Object.getOwnPropertyDescriptor(this,t);(c==null?void 0:c.set)===void 0&&Object.defineProperty(this,t,{set:function(h){var u;const d=this[l];this[l]=h,au(h,d)&&(n==null?void 0:n.call(this,h,d))!==!1&&((u=lu(this))==null||u.notifyChanged(t,h))},get:function(){return this[l]},configurable:!0,enumerable:!0}),s==null||s.init(this)}}},"syncField");var cu=Object.defineProperty,ly=Object.getOwnPropertyDescriptor,hu=(i,e)=>cu(i,"name",{value:e,configurable:!0}),du=(i,e,t,s)=>{for(var n=s>1?void 0:s?ly(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&cu(e,t,n),n};class _r extends w{constructor(){super(...arguments);r(this,"asset");r(this,"joinedRoomFunction")}awake(){this.watchTabVisible(),this.joinedRoomFunction=this.onUserJoined.bind(this)}onEnable(){this.context.connection.beginListen(H.JoinedRoom,this.joinedRoomFunction)}onDisable(){this.context.connection.stopListening(H.JoinedRoom,this.joinedRoomFunction)}async onUserJoined(e){var s;const t=await((s=this.asset)==null?void 0:s.instantiateSynced({parent:this.gameObject},!0));if(t){let n=p.getComponent(t,Kt);n&&(n.owner=this.context.connection.connectionId)}}watchTabVisible(){window.addEventListener("visibilitychange",e=>{if(document.visibilityState==="visible")for(let t=Kt.all.length-1;t>=0;t--){const s=Kt.all[t];(!s.owner||!this.context.connection.userIsInRoom(s.owner))&&s.doDestroy()}})}}hu(_r,"PlayerSync");du([g($e)],_r.prototype,"asset",2);var Mr;const De=(Mr=class extends w{constructor(){super(...arguments);r(this,"owner")}static get all(){return De._all}static get local(){return De._local}static isLocalPlayer(i){var e,t,s,n;return i instanceof S?(t=(e=p.getComponentInParent(i,De))==null?void 0:e.isLocalPlayer)!=null?t:!1:i instanceof Se&&(n=(s=p.getComponentInParent(i.gameObject,De))==null?void 0:s.isLocalPlayer)!=null?n:!1}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}awake(){this.isLocalPlayer&&De.local.push(this),De.all.push(this),this.context.connection.beginListen(H.UserLeftRoom,i=>{if(i.userId===this.owner){this.doDestroy();return}})}start(){if(!this.owner||!this.context.connection.userIsInRoom(this.owner)){this.doDestroy();return}}doDestroy(){Zs(this.gameObject,this.context.connection)}onDestroy(){if(De.all.splice(De.all.indexOf(this),1),this.isLocalPlayer){const i=De._local.indexOf(this);i>=0&&De._local.splice(i,1)}}},r(Mr,"_all",[]),r(Mr,"_local",[]),Mr);let Kt=De;hu(Kt,"PlayerState");du([ay(),g()],Kt.prototype,"owner",2);m.add("AlignmentConstraint",Eo);m.add("Animation",Pt);m.add("AnimationCurve",xn);m.add("Animator",tt);m.add("AnimatorController",Ht);m.add("AudioListener",hi);m.add("AudioSource",te);m.add("AvatarModel",On);m.add("AvatarLoader",ns);m.add("AxesHelper",di);m.add("BasicIKConstraint",Mo);m.add("BoxCollider",Io);m.add("BoxHelperComponent",ui);m.add("Camera",F);m.add("InstantiateOptions",we);m.add("UnityObject",Fo);m.add("DeleteBox",Cn);m.add("Deletable",Bo);m.add("DeviceFlag",Sn);m.add("DragControls",ot);m.add("DropListener",ds);m.add("Duplicatable",qt);m.add("CallInfo",_i);m.add("EventList",He);m.add("EventTrigger",Go);m.add("FlyControls",Vo);m.add("BoxGizmo",us);m.add("GltfExportBox",Qo);m.add("GltfExport",at);m.add("GridHelper",bi);m.add("Interactable",fi);m.add("UsageMarker",pi);m.add("LODModel",Xt);m.add("LODGroup",ps);m.add("Light",lt);m.add("LookAtConstraint",Ji);m.add("MeshCollider",Ko);m.add("NavMesh",ea);m.add("NavMeshAgent",ta);m.add("NestedGltf",qn);m.add("Networking",wt);m.add("OffsetConstraint",sa);m.add("OrbitControls",zt);m.add("ParticleSystemRenderer",Xn);m.add("ParticleSystem",ca);m.add("MainModule",ra);m.add("EmissionModule",oa);m.add("ShapeModule",aa);m.add("PlayerColor",ht);m.add("FieldWithDefault",co);m.add("Renderer",de);m.add("MeshRenderer",nn);m.add("SkinnedMeshRenderer",ho);m.add("InstancingUtil",re);m.add("RendererLightmap",Xi);m.add("Rigidbody",vi);m.add("SceneSettings",ha);m.add("ScreenCapture",ua);m.add("SmoothFollow",ms);m.add("SpatialTriggerReceiver",xi);m.add("SpatialTrigger",gs);m.add("SpatialTriggerEventArgs",Jn);m.add("SpectatorCamera",pa);m.add("SphereCollider",_s);m.add("SpringJoint",ma);m.add("Sprite",er);m.add("SpriteRenderer",Pi);m.add("SyncedCamera",bs);m.add("SyncedRoom",At);m.add("SyncedTransform",st);m.add("TestRunner",ya);m.add("TestSimulateUserData",wa);m.add("TransformGizmo",ir);m.add("VideoPlayer",Ae);m.add("Voip",nt);m.add("WebARSessionRoot",as);m.add("WebXR",E);m.add("WebAR",zn);m.add("AvatarMarker",Z);m.add("WebXRAvatar",rt);m.add("TeleportTarget",In);m.add("WebXRController",j);m.add("AttachedObject",Ee);m.add("XRGrabModel",sr);m.add("XRGrabRendering",xa);m.add("XRRig",Fn);m.add("VRUserState",We);m.add("WebXRSync",cs);m.add("XRState",ze);m.add("XRFlag",J);m.add("AvatarBlink_Simple",Yt);m.add("AvatarEyeLook_Rotation",Oi);m.add("Avatar_POI",ie);m.add("Avatar_Brain_LookAt",os);m.add("Avatar_MouthShapes",ws);m.add("Avatar_MustacheShake",Oa);m.add("LogStats",Ca);m.add("RGBAColor",Fe);m.add("PlayableDirector",Ri);m.add("SignalAsset",rr);m.add("SignalReceiverEvent",or);m.add("SignalReceiver",vs);m.add("AnimationTrackHandler",lr);m.add("AudioTrackHandler",cr);m.add("SignalTrackHandler",Os);m.add("ControlTrackHandler",Si);m.add("BaseUIComponent",dt);m.add("UIRootComponent",Cs);m.add("Button",ut);m.add("Canvas",Da);m.add("CanvasGroup",Ma);m.add("EventSystem",Te);m.add("Graphic",Tt);m.add("MaskableGraphic",Ss);m.add("Image",Rs);m.add("RawImage",fr);m.add("Keyboard",ja);m.add("LayoutGroup",ki);m.add("VerticalLayoutGroup",Fa);m.add("HorizontalLayoutGroup",Ba);m.add("GridLayoutGroup",Ua);m.add("PointerEventData",Jt);m.add("Raycaster",mr);m.add("ObjectRaycaster",Li);m.add("GraphicRaycaster",za);m.add("Size",Aa);m.add("Rect",dr);m.add("RectTransform",Lt);m.add("SpatialHtml",$a);m.add("Text",ge);m.add("PresentationMode",Ha);m.add("LinesDrawer",As);m.add("LineInstanceHandler",Ti);m.add("LinesManager",Es);m.add("PlayerSync",_r);m.add("PlayerState",Kt);var cy=Object.defineProperty,br=(i,e)=>cy(i,"name",{value:e,configurable:!0});class uu extends ci{constructor(){super([f,Fe])}onDeserialize(e){if(e!=null)return e.a!==void 0?new Fe(e.r,e.g,e.b,e.a):e.alpha!==void 0?new Fe(e.r,e.g,e.b,e.alpha):new f(e.r,e.g,e.b)}onSerialize(e){if(e!=null)return e.a!==void 0?{r:e.r,g:e.g,b:e.b,a:e.a}:{r:e.r,g:e.g,b:e.b}}}br(uu,"ColorSerializer");new uu;class fu extends ci{constructor(){super(S)}onSerialize(e,t){if(t.objectToNode!==void 0&&e.uuid){const s=t.objectToNode[e.uuid];return ve&&console.log(s,e.name,e.uuid),{node:s}}}onDeserialize(e,t){var s;if(e){if(e.node!==void 0&&t.nodeToObject){const n=t.nodeToObject[e.node];return ve&&console.log("Deserialized object reference?",e,n,t==null?void 0:t.nodeToObject),n||console.warn("Did not find node: "+e.node,t.nodeToObject,t.object),n}else if(e.guid){if(!t.context){console.error("Missing context");return}let n,o=(s=t.gltf)==null?void 0:s.scene;return o&&(n=p.findByGuid(e.guid,o)),n||(n=p.findByGuid(e.guid,t.context.scene)),n?ve&&console.log("Deserialized object reference?",e,n,t==null?void 0:t.nodeToObject):console.warn("could not resolve reference",e,t.target,t.path,t.context.scene),n}}}}br(fu,"ObjectSerializer");const hy=new fu;class pu extends ci{constructor(){super([Se,w])}onSerialize(e,t){if(e==null?void 0:e.guid)return{guid:e.guid}}onDeserialize(e,t){var s;if(e==null?void 0:e.guid){ve&&console.log(e.guid,t.root,t.object,t.target);const n=this.findObjectForGuid(e.guid,t.root);if(n)return n;if(t.context)return this.findObjectForGuid(e.guid,(s=t.context)==null?void 0:s.scene)}}findObjectForGuid(e,t){return p.foreachComponent(t,s=>{if(e===s.gameObject.guid)return s.gameObject;if(s.guid===e)return s})}}br(pu,"ComponentSerializer");const mu=new pu;class gu extends ci{constructor(){super([He])}onSerialize(e,t){console.log("TODO: SERIALIZE EVENT")}onDeserialize(e,t){var s,n;if(e&&e.type==="EventList"){ve&&console.log("DESERIALIZE EVENT",e);const o=new Array;for(const l of e.calls){ve&&console.log(l);const c=mu.findObjectForGuid(l.target,t.root),h=((s=l.method)==null?void 0:s.length)>0;let d;if(l.argument!==void 0){let u=l.argument;typeof u=="object"&&(u=hy.onDeserialize(l.argument,t),u||(u=mu.onDeserialize(l.argument,t))),d=new _i(h?()=>c[l.method](u):void 0,l.enabled)}else d=new _i(h?()=>c[l.method]():void 0,l.enabled);if(d.method||(d.__debuginfo=(n=t.object)==null?void 0:n.name),!c||!d.method){const u=t.object?"Current object: "+t.object.name+", "+t.object.guid:null;c?console.warn('EventList method not found: "'+l.method+'" on',c):console.warn("EventList is missing target - will be ignored",l.target,u,e)}else o.push(d)}const a=new He(o);return ve&&console.log(a),a}}}br(gu,"EventListSerializer");new gu;var dy=Object.defineProperty,Ls=(i,e)=>dy(i,"name",{value:e,configurable:!0});const _u=ve;function bu(i,e){const s=Jc(i,e);return s!==void 0?s:null}Ls(bu,"writeBuiltinComponentData");async function Va(i,e,t,s=null,n){if(!t)return;let o=s;typeof o=="number"&&(o=new ye(s));const a=new Co(t.scene);a.gltfId=e,a.context=i,a.gltf=t,a.nodeToObject=n==null?void 0:n.nodeToObjectMap;const l=[];if(t.scenes)for(const c of t.scenes)await wr(a,c,l);if(t.children)for(const c of t.children)await wr(a,c,l);i.new_scripts_pre_setup_callbacks.push(()=>{for(const c of l)yu(c,a);if(o){yr(t,o);for(const c of t.scenes)yr(c,o)}})}Ls(Va,"createBuiltinComponents");function yr(i,e){if(e!==null&&!!i){if(i.guid=e.generateUUID(),i&&i.userData&&i.userData.components)for(const t of i.userData.components)t!==null&&(t.guid=e.generateUUID());if(i.children)for(const t of i.children)yr(t,e)}}Ls(yr,"recursiveCreateGuids");const Ts=[];async function wr(i,e,t,s){if(!e)return;const n=e.userData;if(n){const o=n.builtin_components;if(o&&o.length>0)for(const a of o)try{if(a===null)continue;const l=m.get(a.name);if(l!=null){const c=new l;c.sourceId=i.gltfId,Ro(c,a),Yl(c,e,!1),t.push({instance:c,compData:a,obj:e})}else _u&&console.debug("unknown component: "+a.name),Ts.includes(a.name)||Ts.push(a.name)}catch(l){console.error(a.name+" - "+l.message,l)}if(Ts.length>0){const a=Ts.join(", ");console.warn("unknown components: "+a),Ts.length=0}}if(e.children)for(const o of e.children)await wr(i,o,t)}Ls(wr,"onCreateBuiltinComponents");function yu(i,e){const{instance:t,compData:s,obj:n}=i;e.object=n,e.target=t,yn(t,s,e),_u&&console.debug("add "+s.name,s,t)}Ls(yu,"handleDeserialization");const uy=new Tl;async function wu(i){return new Promise((e,t)=>{uy.load(i,e,void 0,t)})}var fy=Object.defineProperty,ft=(i,e)=>fy(i,"name",{value:e,configurable:!0});const Ds=new Uint8Array(4);Ds[0]=255;Ds[1]=255;Ds[2]=255;Ds[3]=255;const py=new Dl(Ds,1,1,Ml);function vu(i){const e="alpha"in i,t=e?4:3,s=new Uint8Array(t);return s[0]=i.r,s[1]=i.g,s[2]=i.b,e&&(s[3]=i.alpha),new Dl(s,1,1,Ml)}ft(vu,"createFlatTexture");var xu;(function(i){i[i.Vertex=0]="Vertex",i[i.Fragment=1]="Fragment"})(xu||(xu={}));class Pu{constructor(e,t){r(this,"stage");r(this,"code");this.stage=e,this.code=t}}ft(Pu,"UnityShaderStage");class my{constructor(){r(this,"loaded",new Map)}async loadShader(e){const t=await wu(e);return JSON.parse(t)}async load(e,t){if(this.loaded.has(t))return new Promise((o,a)=>{const l=this.loaded.get(t);l?o(l):a("Shader not found")});const s=await wu(t),n=new Pu(e,s);return this.loaded.set(t,n),n}}ft(my,"ShaderLib");function Ms(i,e){const t=i.elements;e||(e=[]),e.length=0;for(let s=0;s<16;s+=4){const n=t[s],o=t[s+1],a=t[s+2],l=t[s+3],c=new I(n,o,a,l);e.push(c)}return e}ft(Ms,"ToUnityMatrixArray");const qa=[],Ou=[];function Xa(i,e){if(qa.length===0)for(let t=0;t<27;t++)qa.push(0);e||(e=qa);for(let t=0;t<27;t++)Ou[t]=e[t];e=Ou,i.unity_SHAr={value:new I(e[9],e[3],e[6],e[0])},i.unity_SHBr={value:new I(e[12],e[15],e[18],e[21])},i.unity_SHAg={value:new I(e[10],e[4],e[7],e[1])},i.unity_SHBg={value:new I(e[13],e[16],e[19],e[22])},i.unity_SHAb={value:new I(e[11],e[5],e[8],e[2])},i.unity_SHBb={value:new I(e[14],e[17],e[20],e[23])},i.unity_SHC={value:new I(e[24],e[25],e[26],1)}}ft(Xa,"SetUnitySphericalHarmonics");class Cu{constructor(e,t,s){r(this,"vertexShader");r(this,"fragmentShader");r(this,"technique");this.vertexShader=e,this.fragmentShader=t,this.technique=s}}ft(Cu,"ShaderBundle");async function Su(i,e){if(!i)return console.error("Can not find technique: no shader data"),null;const t=i.programs[e],s=t.vertexShader,n=t.fragmentShader;if(s!==void 0&&n!==void 0){const o=i.shaders[s],a=i.shaders[n];if(o.uri&&a.uri||o.code&&a.code){if(!o.code&&o.uri&&await Qa(o),!a.code&&a.uri&&await Qa(a),!o.code||!a.code)return null;const l=i.techniques[e];return new Cu(o.code,a.code,l)}}return console.error("Shader technique not found",e),null}ft(Su,"FindShaderTechniques");async function Qa(i){const e=i.uri;if(!!e)if(e.endsWith(".glsl")){const s=await new Tl().loadAsync(e);i.code=s.toString()}else i.code=Ru(i.uri)}ft(Qa,"loadShaderCode");function Ru(i){return decodeURIComponent(Array.prototype.map.call(atob(i),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}ft(Ru,"b64DecodeUnicode");var gy=Object.defineProperty,Di=(i,e)=>gy(i,"name",{value:e,configurable:!0});class _y{constructor(){r(this,"programs",[]);r(this,"shaders",[]);r(this,"techniques",[])}}Di(_y,"ShaderData");class by{constructor(){r(this,"vertexShader");r(this,"fragmentShader")}}Di(by,"ShaderProgram");var Eu;(function(i){i[i.Fragment=35632]="Fragment",i[i.Vertex=35633]="Vertex"})(Eu||(Eu={}));class yy{constructor(){r(this,"name");r(this,"type");r(this,"uri");r(this,"code")}}Di(yy,"Shader");class wy{constructor(){r(this,"program");r(this,"attributes",new Map);r(this,"uniforms",new Map)}}Di(wy,"Technique");class vy{constructor(){r(this,"semantic")}}Di(vy,"ShaderAttribute");class xy{constructor(){r(this,"name","");r(this,"type");r(this,"semantic");r(this,"count",0);r(this,"node",0)}}Di(xy,"ShaderUniform");var Ya;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(Ya||(Ya={}));var Py=Object.defineProperty,Ja=(i,e)=>Py(i,"name",{value:e,configurable:!0});const pt=v("debugshaders"),Mi="NEEDLE_techniques_webgl";var Au;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(Au||(Au={}));class ku{constructor(){r(this,"objectToWorldMatrix",new Ce);r(this,"worldToObjectMatrix",new Ce);r(this,"objectToWorld",new Array);r(this,"worldToObject",new Array)}updateFrom(e){this.objectToWorldMatrix.copy(e.matrixWorld),Ms(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(e.matrixWorld.invert()),Ms(this.worldToObjectMatrix,this.worldToObject)}}Ja(ku,"ObjectRendererData");var Lu;(function(i){i[i.Off=0]="Off",i[i.Front=1]="Front",i[i.Back=2]="Back"})(Lu||(Lu={}));const N=class extends pp{constructor(e,...t){super(...t);r(this,"identifier");r(this,"_sphericalHarmonicsName","unity_SpecCube0");r(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");r(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");r(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");r(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");r(this,"_rendererData",new ku);r(this,"_lastFrame",-1);this.identifier=e,pt&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName]&&this.waitForLighting()}async waitForLighting(){const e=A.Current;if(!e){console.error("Missing context");return}const t=await e.rendererData.getSceneLightingData(this.identifier);if(!t||!t.array){console.warn("Missing lighting data for custom shader, getSceneLightingData did not return anything");return}pt&&console.log(t);const s=t.array,n=t.texture;this.uniforms.unity_SpecCube0={value:n},Xa(this.uniforms,s);const o=Math.sqrt(Math.PI*.5);this.uniforms.unity_SpecCube0_HDR={value:new I(o,o,o,o)},pt&&console.log("Set environment lighting",this.uniforms)}onBeforeRender(e,t,s,n,o,a){n.attributes.tangent||n.computeTangents(),this.internalUpdateUniforms(s,o)}internalUpdateUniforms(e,t){const s=A.Current;if(s.time.frame==this._lastFrame)return;this._lastFrame=s.time.frame,this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=s.rendererData.timeVec4);const n=s==null?void 0:s.mainLight;if(n){const o=n.getWorldPosition(N._mainLightPosition);this.uniforms._MainLightPosition={value:o.normalize()},N._mainLightColor.set(n.color.r,n.color.g,n.color.b,0),this.uniforms._MainLightColor={value:N._mainLightColor};const a=n.intensity;N._lightData.z=a,this.uniforms.unity_LightData={value:N._lightData}}if(e&&(N.viewProjection&&this.uniforms[this._viewProjectionName]&&(N.viewProjection.copy(e.projectionMatrix).multiply(e.matrixWorldInverse),this.uniforms[this._viewProjectionName].value=Ms(N.viewProjection,N._viewProjectionValues)),N.viewMatrix&&this.uniforms[this._viewMatrixName]&&(N.viewMatrix.copy(e.matrixWorldInverse),this.uniforms[this._viewMatrixName].value=Ms(N.viewMatrix,N._viewMatrixValues)),this.uniforms[N._worldSpaceCameraPosName]&&(N._worldSpaceCameraPos.setFromMatrixPosition(e.matrixWorld),this.uniforms[N._worldSpaceCameraPosName]={value:N._worldSpaceCameraPos})),t){const o=this._rendererData;o.updateFrom(t),this.uniforms[this._worldToObjectName].value=o.worldToObject,this.uniforms[this._objToWorldName].value=o.objectToWorld}this.uniformsNeedUpdate=!0}};let xe=N;r(xe,"viewProjection",new Ce),r(xe,"_viewProjectionValues",[]),r(xe,"viewMatrix",new Ce),r(xe,"_viewMatrixValues",[]),r(xe,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),r(xe,"_worldSpaceCameraPos",new y),r(xe,"_mainLightColor",new I),r(xe,"_mainLightPosition",new y),r(xe,"_lightData",new I);Ja(xe,"CustomShader");class Tu{constructor(e,t){r(this,"parser");r(this,"identifier");this.parser=e,this.identifier=t}get name(){return Mi}loadMaterial(e){const t=this.parser.json.materials[e];if(!t)return pt&&console.log(e,this.parser.json.materials),null;if(!t.extensions||!t.extensions[Mi])return pt&&console.log("material "+e+" does not use NEEDLE_techniques_webgl"),null;const s=t.extensions[Mi].technique;if(s<0)return null;const n=this.parser.json.extensions[Mi];if(!n)return null;pt&&console.log(n);const o=n.techniques[s];return o?new Promise(async(a,l)=>{var R,M,ce;const c=await Su(n,o.program),h=c==null?void 0:c.fragmentShader,d=c==null?void 0:c.vertexShader;if(!h||!d)return l();pt&&console.log("loadMaterial",t,c);const u={},_=o.uniforms;for(const B in _){const L=B;switch(L){case"_TimeParameters":const U=new I;u[L]={value:U};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":u[L]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":u[L]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":u[L]={value:null};break}}let b=!1;if(t.extensions&&t.extensions[Mi]){const B=t.extensions[Mi];if(B.technique===s){pt&&console.log(t.name,"Material Properties",B);for(const L in B.values){const U=B.values[L];if(typeof U=="string"){if(U.startsWith("textures/")){const zs=U.substring(9),$s=Number.parseInt(zs);if($s>=0){const _t=await this.parser.getDependency("texture",$s);_t&&(_t.encoding=mp,_t.needsUpdate=!0),u[L]={value:_t};continue}}switch(L){case"alphaMode":U==="BLEND"&&(b=!0);continue}}if(Array.isArray(U)&&U.length===4){u[L]={value:new I(U[0],U[1],U[2],U[3])};continue}u[L]={value:U}}}}const x=new xe(this.identifier,{name:(R=t.name)!=null?R:"",uniforms:u,vertexShader:d,fragmentShader:h,lights:!1});switch((M=u._Cull)==null?void 0:M.value){case 0:x.side=kl;break;case 1:x.side=gp;break;case 2:x.side=Il;break;default:x.side=Il;break}x.transparent=b,b&&(x.depthWrite=!1),Xa(u),x.internalUpdateUniforms();for(const B in _){const L=B,U=_[B].type;if(((ce=u[L])==null?void 0:ce.value)===void 0)switch(U){case Ya.SAMPLER_2D:u[L]={value:py},console.warn("Missing/unassigned texture, fallback to white: "+L);break;default:console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+L,_[B]);break}}pt&&console.log(x.uuid,u),a(x)}):null}}Ja(Tu,"NEEDLE_techniques_webgl");var Oy=Object.defineProperty,Cy=(i,e)=>Oy(i,"name",{value:e,configurable:!0});const Du="NEEDLE_gameobject_data";class Mu{constructor(e){r(this,"parser");this.parser=e}get name(){return Du}afterRoot(e){const t=[];for(let s=0;s<this.parser.json.nodes.length;s++){const n=this.parser.json.nodes[s];if(n&&n.extensions){const o=n.extensions[Du];if(o){const a=this.findAndApplyExtensionData(s,o);t.push(a)}}}return Promise.all(t).then(()=>{})}async findAndApplyExtensionData(e,t){const s=await this.parser.getDependency("node",e);s&&this.applyExtensionData(s,t)}applyExtensionData(e,t){e.userData.layer=t.layers,e.userData.tag=t.tag,e.userData.hideFlags=t.hideFlags,e.userData.static=t.static,e.visible=t.activeSelf,e.guid=t.guid}}Cy(Mu,"NEEDLE_gameobject_data");var Sy=Object.defineProperty,Ry=(i,e)=>Sy(i,"name",{value:e,configurable:!0});const Iu="NEEDLE_lightmaps",Ey=v("debuglightmapsextension");var mt;(function(i){i[i.Lightmap=0]="Lightmap",i[i.Skybox=1]="Skybox",i[i.Reflection=2]="Reflection"})(mt||(mt={}));class ju{constructor(e,t,s){r(this,"parser");r(this,"registry");r(this,"source");this.parser=e,this.registry=t,this.source=s}get name(){return Iu}afterRoot(e){const t=this.parser.json.extensions;if(t){const s=t[Iu];if(s){const n=s.textures;return n.length?(Ey&&console.log(s),new Promise(async(o,a)=>{const l=[];for(const c of n)if(c.pointer){const h=pn(this.parser,c.pointer).then(d=>{const u=d;(u==null?void 0:u.isTexture)&&(this.registry?(c.type!==0&&(u.encoding=si),this.registry.registerTexture(this.source,c.type,u,c.index)):console.log(mt[c.type],c.pointer,u))});l.push(h)}await Promise.all(l),o()})):null}}return null}}Ry(ju,"NEEDLE_lightmaps");var Ay=Object.defineProperty,Fu=(i,e)=>Ay(i,"name",{value:e,configurable:!0}),vr;(function(i){i[i.Skybox=0]="Skybox",i[i.Trilight=1]="Trilight",i[i.Flat=3]="Flat",i[i.Custom=4]="Custom"})(vr||(vr={}));var xr;(function(i){i[i.Skybox=0]="Skybox",i[i.Custom=1]="Custom"})(xr||(xr={}));class Bu{constructor(e){r(this,"context");r(this,"sceneLightSettings");r(this,"_timevec4",new I);r(this,"_waitPromise");r(this,"_lighting",{});this.context=e,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const e=this.context.time;this._timevec4.x=e.time,this._timevec4.y=Math.sin(e.time),this._timevec4.z=Math.cos(e.time),this._timevec4.w=e.deltaTime}get timeVec4(){return this._timevec4}registerSceneLightSettings(e){this.sceneLightSettings=e}registerReflection(e,t){const s=new Uu(this.context,t,1);this._lighting[e]=s}getReflection(e){return this._lighting[e]}enableReflection(e){var s;switch((s=this.sceneLightSettings)==null?void 0:s.ambientMode){case 0:case 4:break;case 3:if(this.sceneLightSettings.ambientLight){const n=vu(this.sceneLightSettings.ambientLight);this.context.scene.environment=n}return;default:return}const t=this.getReflection(e);if(t&&t.Source){const n=this.context.scene,o=t.Source;o.encoding=si,o.mapping=Ur,n.environment=o}}async getSceneLightingData(e){return this._waitPromise?this._waitPromise:(this._waitPromise=new Promise((t,s)=>{let n=setInterval(async()=>{var a,l;const o=this.getReflection(e);o&&(clearInterval(n),t(o.getSphericalHarmonicsArray((l=(a=this.sceneLightSettings)==null?void 0:a.ambientIntensity)!=null?l:1)))},10)}),this._waitPromise)}}Fu(Bu,"RendererData");class Uu{constructor(e,t,s=1){r(this,"_context");r(this,"_source");r(this,"_sphericalHarmonics",null);r(this,"_sphericalHarmonicsArray");r(this,"_ambientScale",1);r(this,"_lightProbe");this._context=e,this._source=t,this._ambientScale=s,t.mapping=Ur,t.encoding=si}get Source(){return this._source}get Array(){return this._sphericalHarmonicsArray}getSphericalHarmonicsArray(e=1){var t;if(((t=this._sphericalHarmonicsArray)==null?void 0:t.length)&&this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:this._lightProbe};try{const s=this._source;let n=null;if(s){const o=Math.min(s.image.width,512);n=new _p(o).fromEquirectangularTexture(this._context.renderer,s),this._source=n.texture}if(this._sphericalHarmonicsArray=[],n){const o=bp.fromCubeRenderTarget(this._context.renderer,n);this._lightProbe=o;const a=this._ambientScale*(e*e*Math.PI*.5)-1;this._sphericalHarmonics=o.sh,this._sphericalHarmonicsArray=this._sphericalHarmonics.toArray();const l=e/(Math.PI*.5);for(let c=0;c<this._sphericalHarmonicsArray.length;c++)this._sphericalHarmonicsArray[c]*=l;if(o.sh.scale(a),this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:o}}}catch(s){console.error(s)}return null}}Fu(Uu,"LightData");var ky=Object.defineProperty,Nu=(i,e)=>ky(i,"name",{value:e,configurable:!0});const zu="NEEDLE_lighting_settings",Ly=v("debuglightingextensions");class $u{constructor(e,t,s){r(this,"parser");r(this,"sourceId");r(this,"context");this.parser=e,this.sourceId=t,this.context=s}get name(){return zu}afterRoot(e){const t=this.parser.json.extensions;if(t){const s=t[zu];if(s){Ly&&console.log(s);const n=p.addNewComponent(e.scene,Wu,!1);n.sourceId=this.sourceId,n.ambientIntensity=s.ambientIntensity,n.ambientLight=new f().fromArray(s.ambientLight),n.ambientMode=s.ambientMode,n.defaultReflectionMode=s.defaultReflectionMode,this.context&&this.context.rendererData.registerSceneLightSettings(n)}}return null}}Nu($u,"NEEDLE_lighting_settings");class Wu extends w{constructor(){super(...arguments);r(this,"ambientMode",vr.Skybox);r(this,"ambientLight");r(this,"ambientIntensity",1);r(this,"defaultReflectionMode",xr.Skybox);r(this,"_hasReflection",!1);r(this,"_ambientLightObj");r(this,"_lightProbeObj")}awake(){if(this.sourceId){const e=this.defaultReflectionMode===xr.Skybox?mt.Skybox:mt.Reflection,t=this.context.lightmaps.tryGet(this.sourceId,e,0);this._hasReflection=t!=null,t&&this.context.rendererData.registerReflection(this.sourceId,t)}}onEnable(){this.ambientMode==vr.Flat?(this.ambientLight&&(this._ambientLightObj=new yp(this.ambientLight,Math.PI*this.ambientIntensity)),this._ambientLightObj&&this.gameObject.add(this._ambientLightObj),this._lightProbeObj&&this._lightProbeObj.removeFromParent()):(this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._lightProbeObj?this.enabled&&this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj):this.sourceId&&this.context.rendererData.getSceneLightingData(this.sourceId).then(e=>{!e||(this._lightProbeObj=e.lightProbe,this.enabled&&!this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj))})),this.sourceId&&this._hasReflection&&this.context.rendererData.enableReflection(this.sourceId)}}Nu(Wu,"SceneLightSettings");var Ty=Object.defineProperty,Za=(i,e)=>Ty(i,"name",{value:e,configurable:!0});function Ka(i){const e=new Xo;return i.register(t=>(e.parser=t,e)),e}Za(Ka,"registerComponentExtension");class Hu{resolvePath(e){return e.includes("/extensions/builtin_components/")&&(e=e.replace("/extensions/builtin_components/","/userData/components/")),e}}Za(Hu,"PointerResolver");function el(i,e,t){i.register(n=>new Mu(n)),i.register(n=>new Qc(n)),i.register(n=>new ju(n,e.lightmaps,t)),i.register(n=>new $u(n,t,e)),i.register(n=>new Tu(n,t));const s=i.setAnimationPointerResolver;typeof s=="function"&&s.bind(i)(new Hu)}Za(el,"registerExtensions");var Dy=Object.defineProperty,_e=(i,e)=>Dy(i,"name",{value:e,configurable:!0});const My=v("printGltf");var tl;(function(i){i[i.BeforeLoad=0]="BeforeLoad",i[i.AfterLoaded=1]="AfterLoaded",i[i.FinishedSetup=10]="FinishedSetup"})(tl||(tl={}));class Dt{constructor(e,t,s,n){r(this,"context");r(this,"loader");r(this,"path");r(this,"gltf");this.context=e,this.path=t,this.loader=s,this.gltf=n}}_e(Dt,"GltfLoadEvent");const Mt={};function Gu(i,e){Mt[i]=Mt[i]||[],Mt[i].push(e)}_e(Gu,"addGltfLoadEventListener");function Vu(i,e){if(Mt[i]){const t=Mt[i].indexOf(e);t>=0&&Mt[i].splice(t,1)}}_e(Vu,"removeGltfLoadEventListener");function ei(i,e){if(Mt[i])for(const t of Mt[i])t(e)}_e(ei,"invokeEvents");async function il(i,e,t,s,n){My&&console.log(t),await i.assets.registerGltf(t),await Va(i,e,t,s,n)}_e(il,"handleLoadedGltf");function Is(i,e,t,s){typeof t!="string"&&console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",t,typeof t);const n=new $r;el(n,i,t);const a=Ka(n);return new Promise((l,c)=>{try{Pn(n,i),ei(0,new Dt(i,t,n)),n.parse(e,t,async h=>{ei(1,new Dt(i,t,n,h)),await il(i,t,h,s,a),ei(10,new Dt(i,t,n,h)),l(h)},h=>{console.error("failed loading "+t,h),l(void 0)})}catch(h){console.error(h),c(h)}})}_e(Is,"parseSync");function Ii(i,e,t,s=!1,n){const o=new $r;el(o,i,e);const l=Ka(o);return new Promise((c,h)=>{try{Pn(o,i),ei(0,new Dt(i,e,o)),o.load(e,async d=>{ei(1,new Dt(i,e,o,d)),await il(i,e,d,t,l),ei(10,new Dt(i,e,o,d)),c(d)},d=>{n==null||n.call(o,d)},d=>{console.error("failed loading "+e,d),c(void 0)})}catch(d){console.error(d),h(d)}})}_e(Ii,"loadSync");function qu(i,e,t,s=!1){e&&e.animations&&e.animations.length>0&&t.push(()=>{sl(e,s)})}_e(qu,"findAnimationsLate");function sl(i,e=!1){var s;if(!i||!i.animations||!i.scene||!e&&!p.getComponentInChildren(i.scene,Pt))return;for(let n=0;n<i.animations.length;n++){const o=i.animations[n];if(!(!o.tracks||o.tracks.length<=0))for(const a in o.tracks){const l=o.tracks[a],c=(s=l.__objectName)!=null?s:l.name.substring(0,l.name.indexOf(".")),h=i.scene.getObjectByName(c);if(!h)continue;let d=t(h);if(!d)if(e)d=p.addNewComponent(i.scene,Pt);else{console.warn("Failed finding animator for",l.name,c);continue}const u=d.animations=d.animations||[];o.name_animator=d.name,u.indexOf(o)<0&&u.push(o)}}function t(n){var a;if(!n)return;const o=(a=n.userData)==null?void 0:a.components;if(o&&o.length>0)for(let l=0;l<o.length;l++){const c=o[l];if(c instanceof tt||c instanceof Pt)return n}return t(n.parent)}_e(t,"findAnimationGameObjectInParent")}_e(sl,"findAnimations");function nl(i,e,t=!0){if(e.userData&&e.userData.name===i)return e;if(e.children&&e.children.length>0)for(let s=0;s<e.children.length;s++){const n=e.children[s],o=nl(i,n,t);if(o)return o}}_e(nl,"tryFindObjectByName");function Xu(i,e,t=!0){return Ft(i,e,t)}_e(Xu,"tryFindObject");function Qu(i,e=null){const t=e!=null?e:A.Current.scripts;for(const s in t){const n=t[s];if(n&&n.guid===i)return n}return null}_e(Qu,"tryFindScript");var Iy=Object.freeze(Object.defineProperty({__proto__:null,get GltfLoadEventType(){return tl},GltfLoadEvent:Dt,addGltfLoadEventListener:Gu,removeGltfLoadEventListener:Vu,parseSync:Is,loadSync:Ii,findAnimationsLate:qu,findAnimations:sl,tryFindObjectByName:nl,tryFindObject:Xu,tryFindScript:Qu},Symbol.toStringTag,{value:"Module"})),jy=Object.defineProperty,Fy=(i,e)=>jy(i,"name",{value:e,configurable:!0});function Pr(i,e){let t=p.getComponentInChildren(i,ot);if(t||(t=p.addNewComponent(i,ot,!1),t.guid=e.generateUUID()),t&&!p.getComponent(t.gameObject,st)){const s=p.addNewComponent(t.gameObject,st,!1);s.guid=e.generateUUID()}if(t&&!p.getComponentInParent(t.gameObject,Li)){const s=p.addNewComponent(t.gameObject,Li,!1);s.guid=e.generateUUID()}}Fy(Pr,"onDynamicObjectAdded");var By=Object.defineProperty,ti=(i,e)=>By(i,"name",{value:e,configurable:!0}),Or;(function(i){i.File_Spawned="file-spawned"})(Or||(Or={}));class Yu{constructor(e,t,s,n,o,a,l,c){r(this,"guid");r(this,"file_name");r(this,"file_hash");r(this,"file_size");r(this,"position");r(this,"seed");r(this,"sender");r(this,"serverUrl");r(this,"parentGuid");r(this,"boundsSize");this.seed=t,this.guid=s,this.file_name=n,this.file_hash=o,this.file_size=a,this.position=l,this.sender=e,this.serverUrl=c}}ti(Yu,"FileSpawnModel");async function Ju(i,e,t){const s=i.name;return s.endsWith(".gltf")||s.endsWith(".glb")?new Promise((n,o)=>{const a=new FileReader;a.readAsDataURL(i),a.onloadend=async l=>{const c=a.result,h=Ks(),d=new ye(h),u=await Ii(e,c,d,!0);if(u&&u.scene){const _=u.scene;if(!_.guid){const b=new ye(h);_.guid=b.generateUUID()}t&&ef(e.connection,i,h,_,t),Pr(_,d),n(_)}}}):(console.warn("Unsupported file type: "+s),console.log(i),null)}ti(Ju,"addFile");async function Zu(i,e){return new Promise(async(t,s)=>{const n=Ks(),o=new ye(n),a=await Ii(e,i.toString(),o,!0);if(a&&a.scene){const l=a.scene;Pr(l,o),t(l)}else console.warn("Unsupported file type: "+i.toString())})}ti(Zu,"addFileFromUrl");function Ku(i){i.connection.beginListen(Or.File_Spawned,async e=>{if(e.sender!==i.connection.connectionId){console.log("received file event",e),tf(e,i);let t=null;try{t=await Lo(e.file_name,e.file_hash,e.file_size,e.serverUrl)}finally{sf(e)}if(t){const s=new ye(e.seed),n=await Is(i,t,null,s);if(n&&n.scene){const o=n.scene;if(Pr(o,s),e.parentGuid){const a=p.findByGuid(e.parentGuid,i.scene);"add"in a&&a.add(o)}o.parent||i.scene.add(o),e.position!==null&&o.position.copy(e.position)}}else console.error("download didnt return file")}})}ti(Ku,"beginListenFileSpawn");async function ef(i,e,t,s,n){var l;if(!i.connectionId){console.error("Can not upload file - no connection id");return}if(!s.guid){console.error("Can not upload file - no guid",s,s.guid);return}const o=await dh(e,n);if(!o)return;if(!o.filename){console.error("Can not send upload event - no filename",e.name);return}if(!o.hash){console.error("Can not send upload event - no hash",e.name);return}const a=new Yu(i.connectionId,t,s.guid,o.filename,o.hash,e.size,s.position,(l=o.url)!=null?l:n);s.parent&&(a.parentGuid=s.parent.guid),i.send(Or.File_Spawned,a)}ti(ef,"handleUpload");const rl={};function tf(i,e){const t=new xl,s=new ni(t,new zi({color:65280})),n=new El(s,5592405);if(rl[i.guid]=n,e.scene.add(n),i.parentGuid){const o=p.findByGuid(i.parentGuid,e.scene);o&&o.add(n)}i.position&&n.position.copy(i.position)}ti(tf,"addPreview");function sf(i,e){const t=i.guid,s=rl[t];s&&(delete rl[t],s.removeFromParent())}ti(sf,"removePreview");var Uy=Object.defineProperty,Cr=(i,e)=>Uy(i,"name",{value:e,configurable:!0});v("debugassets");class Ny{constructor(){r(this,"name");r(this,"sampler");r(this,"source");r(this,"extras")}}Cr(Ny,"TextureInfo");class zy{constructor(){r(this,"bufferView");r(this,"mimeType");r(this,"extras")}}Cr(zy,"ImageInfo");class $y{constructor(){r(this,"textures");r(this,"bufferViews")}}Cr($y,"GltfJson");class nf{constructor(){r(this,"texturesLoader",new wp);r(this,"textures",{});r(this,"texturesLoading",{});r(this,"_materials",new Map);r(this,"_meshes",new Map);r(this,"_textures",new Map);window.addEventListener("unhandledrejection",e=>{var s;if(e.defaultPrevented)return;const t=(s=e==null?void 0:e.reason)==null?void 0:s.path;if(t){const n=t[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),e.preventDefault())}})}async loadTexture(e){if(this.textures[e])return this.textures[e];if(this.texturesLoading[e])return await this.texturesLoading[e];const t=this.texturesLoader.loadAsync(e);this.texturesLoading[e]=t;const s=await t;return delete this.texturesLoading[e],this.textures[e]=s,s}getTexture(e){return this._textures.get(e)||null}findTexture(e){for(const t of this._textures.values())if(t.name===e)return t;return null}findMesh(e){for(const t of this._meshes.values())if(t.name===e)return t;return null}findMaterial(e){for(const t of this._materials.values())if(t.name===e)return t;return null}async registerGltf(e){}registerAsset(e){}}Cr(nf,"AssetDatabase");var Wy=Object.defineProperty,Hy=(i,e)=>Wy(i,"name",{value:e,configurable:!0}),Sr;(function(i){i.Visible="application-visible",i.Hidden="application-hidden"})(Sr||(Sr={}));class rf extends EventTarget{constructor(e){super();r(this,"context");r(this,"_isVisible",!0);this.context=e,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(e){switch(e.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event(Sr.Hidden));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event(Sr.Visible));break}}}Hy(rf,"Application");var Gy=Object.defineProperty,Vy=(i,e)=>Gy(i,"name",{value:e,configurable:!0});const of=!!v("debuglightmaps");class af{constructor(e){r(this,"_context");r(this,"_lightmaps",new Map);this._context=e}registerTexture(e,t,s,n){var l;of&&console.log("Registering lightmap",e,mt[t],s),this._lightmaps.has(e)||this._lightmaps.set(e,new Map);const o=this._lightmaps.get(e),a=(l=o==null?void 0:o.get(t))!=null?l:[];a.length<n&&(a.length=n+1),a[n]=s,o==null||o.set(t,a)}tryGetLightmap(e,t=0){return this.tryGet(e,mt.Lightmap,t)}tryGetSkybox(e){return this.tryGet(e,mt.Skybox,0)}tryGetReflection(e){return this.tryGet(e,mt.Reflection,0)}tryGet(e,t,s){var o,a;if(!e)return of&&console.warn("Missing source id"),null;const n=(a=(o=this._lightmaps.get(e))==null?void 0:o.get(t))!=null?a:null;return!(n==null?void 0:n.length)||n.length<=s?null:n[s]}}Vy(af,"LightDataRegistry");Wi.lights_fragment_maps=Wi.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vUv2 );",`

    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);Wi.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;Wi.lights_fragment_begin=Wi.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);vp.lightmap.lightmapScaleOffset={value:new I(1,1,0,0)};var qy=Object.defineProperty,ol=(i,e)=>qy(i,"name",{value:e,configurable:!0});const Xy=v("debugSetup"),Qy=v("stats"),Rr={};class lf{constructor(e){r(this,"name");r(this,"alias");r(this,"domElement");r(this,"renderer");this.domElement=e!=null?e:document.body}}ol(lf,"ContextArgs");var Pe;(function(i){i[i.EarlyUpdate=0]="EarlyUpdate",i[i.Update=1]="Update",i[i.LateUpdate=2]="LateUpdate",i[i.OnBeforeRender=3]="OnBeforeRender",i[i.OnAfterRender=4]="OnAfterRender",i[i.PhysicsStep=10]="PhysicsStep"})(Pe||(Pe={}));const be=class{constructor(e){r(this,"name");r(this,"alias");r(this,"isManagedExternally",!1);r(this,"domElement");r(this,"scene");r(this,"renderer");r(this,"composer",null);r(this,"scripts",[]);r(this,"scripts_earlyUpdate",[]);r(this,"scripts_update",[]);r(this,"scripts_lateUpdate",[]);r(this,"scripts_onBeforeRender",[]);r(this,"scripts_onAfterRender",[]);r(this,"scripts_WithCorroutines",[]);r(this,"coroutines",{});r(this,"mainCameraComponent");r(this,"post_setup_callbacks",[]);r(this,"pre_update_callbacks",[]);r(this,"pre_render_callbacks",[]);r(this,"post_render_callbacks",[]);r(this,"new_scripts",[]);r(this,"new_script_start",[]);r(this,"new_scripts_pre_setup_callbacks",[]);r(this,"new_scripts_post_setup_callbacks",[]);r(this,"application");r(this,"time");r(this,"input");r(this,"physics");r(this,"connection");r(this,"assets");r(this,"mainLight",null);r(this,"rendererData");r(this,"addressables");r(this,"lightmaps");r(this,"_sizeChanged",!1);r(this,"_isCreated",!1);r(this,"_stats",Qy?xp():null);r(this,"_cameraStack",[]);if(this.name=(e==null?void 0:e.name)||"",this.alias=e==null?void 0:e.alias,this.domElement=(e==null?void 0:e.domElement)||document.body,e==null?void 0:e.renderer)this.renderer=e.renderer,this.isManagedExternally=!0;else{const s=v("postfx");this.renderer=new Pp({antialias:!0}),this.renderer.setClearColor(new f("lightgrey"),0),this.renderer.antialias=!0,this.renderer.alpha=!1,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Op,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputEncoding=si,this.renderer.physicallyCorrectLights=!0,this.composer=s?new Cp(this.renderer):null}this.scene=new Sp,this.application=new rf(this),this.time=new kc,this.input=new bc(this),this.physics=new Ac(this),this.connection=new jc(this),this.assets=new nf,this.rendererData=new Bu(this),this.addressables=new Ah(this),this.lightmaps=new af(this),window.addEventListener("resize",this.updateSize.bind(this)),new ResizeObserver(s=>this._sizeChanged=!0).observe(this.domElement)}static get Current(){return this._current}static set Current(e){this._current=e}get domWidth(){return this.domElement.clientWidth}get domHeight(){return this.domElement.clientHeight}get domX(){return this.domElement.offsetLeft}get domY(){return this.domElement.offsetTop}get isInXR(){return this.renderer.xr.isPresenting}get mainCamera(){if(this.mainCameraComponent){const e=this.mainCameraComponent;return e.cam||e.buildCamera(),e.cam}return null}updateSize(){if(!this.isManagedExternally&&!this.renderer.xr.isPresenting){this._sizeChanged=!1;const e=this.domWidth,t=this.domHeight,s=this.mainCamera;this.updateAspect(s),this.renderer.setSize(e,t),this.renderer.setPixelRatio(window.devicePixelRatio),this.composer&&(this.composer.setSize(e,t),this.composer.setPixelRatio(window.devicePixelRatio))}}updateAspect(e){if(!e)return;const t=this.domWidth,s=this.domHeight,n=e.aspect;e.aspect=t/s,n!==e.aspect&&e.updateProjectionMatrix()}onCreate(e,t){return this._isCreated?(console.warn("Context already created"),null):(this._isCreated=!0,this.internalOnCreate(e,t))}onDestroy(){var e,t;!this._isCreated||(this._isCreated=!1,p.destroy(this.scene,!0),(e=this.renderer)==null||e.setAnimationLoop(null),this.isManagedExternally||(t=this.renderer)==null||t.dispose())}registerCoroutineUpdate(e,t,s){return this.coroutines[s]||(this.coroutines[s]=[]),this.coroutines[s].push({comp:e,main:t}),t}unregisterCoroutineUpdate(e,t){if(!this.coroutines[t])return;const s=this.coroutines[t].findIndex(n=>n.main===e);s>=0&&this.coroutines[t].splice(s,1)}stopAllCoroutinesFrom(e){for(const t in this.coroutines){const s=this.coroutines[t];for(let n=s.length-1;n>=0;n--)s[n].comp===e&&s.splice(n,1)}}setCurrentCamera(e){var n;if(!e)return;if(e.cam||e.buildCamera(),!e.cam){console.warn("Camera component is missing camera",e);return}const t=this._cameraStack.indexOf(e);t>=0&&this._cameraStack.splice(t,1),this._cameraStack.push(e),this.mainCameraComponent=e;const s=e.cam;s.isPerspectiveCamera&&this.updateAspect(s),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}async internalOnCreate(e,t){var o;let s=!0;try{be.Current=this,e&&await e(this,t)}catch(a){console.error(a),s=!1}if(!s)return;this.isManagedExternally||this.domElement.prepend(this.renderer.domElement),uc(this),hc(this),Ku(this),be._current=this;for(let a=0;a<this.new_scripts.length;a++){const l=this.new_scripts[a];if(l.gameObject!==void 0&&l.gameObject!==null){l.gameObject.userData===void 0&&(l.gameObject.userData={}),l.gameObject.userData.components===void 0&&(l.gameObject.userData.components=[]);const c=l.gameObject.userData.components;c.includes(l)||c.push(l)}}if(this.post_setup_callbacks)for(let a=0;a<this.post_setup_callbacks.length;a++)be._current=this,await this.post_setup_callbacks[a](this);if(!this.mainCamera){be._current=this;const a=p.findObjectsOfType(F,this),l=(o=a.find(c=>c.tag=="MainCamera"))!=null?o:a.find(c=>!0);if(l)l.tag!=="MainCamera"&&console.warn('No mainCamera configured. Some components rely on a mainCamera object being present. When exporting your scene, make sure to set the mainCamera tag on your camera. Using "'+l.name+'" as mainCamera now.'),this.setCurrentCamera(l);else{console.error("No camera found");const c=Wc(this.scene);this.setCurrentCamera(c)}}be._current=this,oi(this),wo!==void 0&&jt(wo,this);const n=this.mainCameraComponent;if(n&&n.applyClearFlagsIfIsActiveCamera(),!this.isManagedExternally&&this.composer&&this.mainCamera){const a=new Rp(this.scene,this.mainCamera);this.renderer.setSize(this.domWidth,this.domHeight),this.composer.addPass(a),this.composer.setSize(this.domWidth,this.domHeight)}this._sizeChanged=!0,this._stats&&(this._stats.showPanel(1),this.domElement.appendChild(this._stats.dom)),this.renderer.setAnimationLoop(this.render.bind(this)),Xy&&Ys(this.scene,!0)}render(e,t){var s,n;for((s=this._stats)==null||s.begin(),be._current=this,this.time.update(),oi(this),ql(),Gl(this);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();for(let o=0;o<this.scripts_earlyUpdate.length;o++){const a=this.scripts_earlyUpdate[o];!a.activeAndEnabled||a.earlyUpdate!==void 0&&(be._current=this,a.earlyUpdate())}this.executeCoroutines(0);for(let o=0;o<this.scripts_update.length;o++){const a=this.scripts_update[o];!a.activeAndEnabled||a.update!==void 0&&(be._current=this,a.update())}this.executeCoroutines(1);for(let o=0;o<this.scripts_lateUpdate.length;o++){const a=this.scripts_lateUpdate[o];!a.activeAndEnabled||a.lateUpdate!==void 0&&(be._current=this,a.lateUpdate())}this.mainLight=null,this.executeCoroutines(2);try{const o=2,a=this.time.deltaTime/o;for(let l=0;l<o;l++)this.physics.step(a),this.executeCoroutines(10)}catch(o){console.error(o)}this.physics.postStep();for(let o=0;o<this.scripts_onBeforeRender.length;o++){const a=this.scripts_onBeforeRender[o];!a.activeAndEnabled||a.onBeforeRender!==void 0&&(be._current=this,a.onBeforeRender(t))}if(this.executeCoroutines(3),this._sizeChanged&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o]();this.isManagedExternally||(this.composer?this.composer.render():this.mainCamera&&this.renderer&&this.renderer.render(this.scene,this.mainCamera));for(let o=0;o<this.scripts_onAfterRender.length;o++){const a=this.scripts_onAfterRender[o];!a.activeAndEnabled||a.onAfterRender!==void 0&&(be._current=this,a.onAfterRender())}if(this.executeCoroutines(4),this.post_render_callbacks)for(const o in this.post_render_callbacks)this.post_render_callbacks[o]();this.connection.sendBufferedMessagesNow(),(n=this._stats)==null||n.end()}executeCoroutines(e){if(this.coroutines[e]){const s=this.coroutines[e];for(let n=0;n<s.length;n++){const o=s[n];if(!o.comp||o.comp.destroyed||!o.main){s.splice(n,1),--n;continue}const a=o.chained;if(a&&a.length>0){const d=a[a.length-1].next();if(d.done&&a.pop(),t(d)&&(o.chained||(o.chained=[]),o.chained.push(d.value)),!d.done)continue}const l=o.main.next();if(l.done===!0){s.splice(n,1),--n;continue}const c=l.value;if(t(c)){if(c.next().done)continue;o.chained||(o.chained=[]),o.chained.push(c)}}}function t(s){return!!(s&&s.next&&s.return)}ol(t,"isGenerator")}};let A=be;r(A,"_current");ol(A,"Context");var Yy=Object.freeze(Object.defineProperty({__proto__:null,build_scene_functions:Rr,ContextArgs:lf,get FrameEvent(){return Pe},Context:A},Symbol.toStringTag,{value:"Module"}));const Er=jr(bt(bt({},Yy),Iy),{RGBAColor:Fe}),Jy={AlignmentConstraint:Eo,Animation:Pt,AnimationCurve:xn,Animator:tt,AnimatorController:Ht,AudioListener:hi,AudioSource:te,AvatarModel:On,AvatarLoader:ns,AxesHelper:di,BasicIKConstraint:Mo,BoxCollider:Io,BoxHelperComponent:ui,Camera:F,InstantiateOptions:we,UnityObject:Fo,DeleteBox:Cn,Deletable:Bo,DeviceFlag:Sn,DragControls:ot,DropListener:ds,Duplicatable:qt,CallInfo:_i,EventList:He,EventTrigger:Go,FlyControls:Vo,BoxGizmo:us,GltfExportBox:Qo,GltfExport:at,GridHelper:bi,Interactable:fi,UsageMarker:pi,LODModel:Xt,LODGroup:ps,Light:lt,LookAtConstraint:Ji,MeshCollider:Ko,NavMesh:ea,NavMeshAgent:ta,NestedGltf:qn,Networking:wt,OffsetConstraint:sa,OrbitControls:zt,ParticleSystemRenderer:Xn,ParticleSystem:ca,MainModule:ra,EmissionModule:oa,ShapeModule:aa,PlayerColor:ht,FieldWithDefault:co,Renderer:de,MeshRenderer:nn,SkinnedMeshRenderer:ho,InstancingUtil:re,RendererLightmap:Xi,Rigidbody:vi,SceneSettings:ha,ScreenCapture:ua,SmoothFollow:ms,SpatialTriggerReceiver:xi,SpatialTrigger:gs,SpatialTriggerEventArgs:Jn,SpectatorCamera:pa,SphereCollider:_s,SpringJoint:ma,Sprite:er,SpriteRenderer:Pi,SyncedCamera:bs,SyncedRoom:At,SyncedTransform:st,TestRunner:ya,TestSimulateUserData:wa,TransformGizmo:ir,VideoPlayer:Ae,Voip:nt,WebARSessionRoot:as,WebXR:E,WebAR:zn,AvatarMarker:Z,WebXRAvatar:rt,TeleportTarget:In,WebXRController:j,AttachedObject:Ee,XRGrabModel:sr,XRGrabRendering:xa,XRRig:Fn,VRUserState:We,WebXRSync:cs,XRState:ze,XRFlag:J,AvatarBlink_Simple:Yt,AvatarEyeLook_Rotation:Oi,Avatar_POI:ie,Avatar_Brain_LookAt:os,Avatar_MouthShapes:ws,Avatar_MustacheShake:Oa,LogStats:Ca,RGBAColor:Fe,PlayableDirector:Ri,SignalAsset:rr,SignalReceiverEvent:or,SignalReceiver:vs,AnimationTrackHandler:lr,AudioTrackHandler:cr,SignalTrackHandler:Os,ControlTrackHandler:Si,BaseUIComponent:dt,UIRootComponent:Cs,Button:ut,Canvas:Da,CanvasGroup:Ma,EventSystem:Te,Graphic:Tt,MaskableGraphic:Ss,Image:Rs,RawImage:fr,Keyboard:ja,LayoutGroup:ki,VerticalLayoutGroup:Fa,HorizontalLayoutGroup:Ba,GridLayoutGroup:Ua,PointerEventData:Jt,Raycaster:mr,ObjectRaycaster:Li,GraphicRaycaster:za,Size:Aa,Rect:dr,RectTransform:Lt,SpatialHtml:$a,Text:ge,PresentationMode:Ha,LinesDrawer:As,LineInstanceHandler:Ti,LinesManager:Es,PlayerSync:_r,PlayerState:Kt},Zy=async function(i,e){const t=i.scene;let s=i.new_scripts;const n=await Er.loadSync(i,"assets/sceneRoot.glb",null,!1,c=>{var h;return(h=e==null?void 0:e.progress)==null?void 0:h.call(e,{name:"sceneRoot.glb",progress:c,index:0,count:1})});n&&t.add(n.scene);const o=new Jy.Light;o.guid="382561724",s.push(o);const a=new S;a.name="Directional Light",a.guid="382561725",a.position.set(-2.538464,.5726625,1.209862),a.setRotationFromQuaternion(new P(.2072421,.2050301,-.1579557,.9434317)),a.scale.set(1,1,1),t.add(a),o.enabled=!0,o.type=1,o.shape=0,o.spotAngle=30,o.innerSpotAngle=21.80208,o.color=new Er.RGBAColor(1,1,1,1),o.colorTemperature=6570,o.useColorTemperature=!1,o.intensity=1,o.bounceIntensity=1,o.useBoundingSphereOverride=!1,o.boundingSphereOverride=new I(0,0,0,0),o.useViewFrustumForShadowCasterCull=!0,o.shadowCustomResolution=-1,o.shadowBias=.05,o.shadowNormalBias=.4,o.shadowNearPlane=.2,o.useShadowMatrixOverride=!1,o.range=10,o.flare=null,o.cullingMask=-1,o.renderingLayerMask=1,o.lightShadowCasterMode=0,o.shadowRadius=0,o.shadowAngle=0,o.shadows=0,o.shadowStrength=1,o.shadowResolution=-1,o.layerShadowCullDistances=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o.cookieSize=10,o.cookie=null,o.renderMode=0,o.areaSize=new z(1,1),o.lightmapBakeType=4,o.commandBufferCount=0,o.enabled=!0;const l=Er.tryFindObject("382561725",t,!0);l&&(l.layers.set(0),l.visible=!0,l.userData.layer=0,l.userData.name="Directional Light",l.userData.tag="Untagged",l.userData.hideFlags=0,l.userData.activeSelf=!0,l.userData.static=!1,l.guid="382561725"),o.gameObject=l,s=i.scripts};Er.build_scene_functions.loadScene=Zy;console.log("Made with \u2665 by \u{1F335} needle - https://needle.tools");var Ky=Object.defineProperty,ew=(i,e)=>Ky(i,"name",{value:e,configurable:!0});const Ar="ar",tw="quit-ar";class cf{constructor(){r(this,"arContainer",null);r(this,"closeARCallback");r(this,"currentSession",null);r(this,"registeredCloseEventElements",[]);r(this,"_createdAROnlyElements",[]);this.closeARCallback=this.onRequestedEndAR.bind(this)}requestEndAR(){this.onRequestedEndAR()}onBegin(e,t){if(this.currentSession=t,this.arContainer=e,!this.arContainer)return;const s=e.getElementsByClassName(tw);if(!s||s.length<=0)console.warn("Missing quit AR elements"),this.createFallbackCloseARButton(this.arContainer);else for(let n=0;n<s.length;n++){const o=s[n];!o||(o.addEventListener("click",this.closeARCallback),this.registeredCloseEventElements.push(o))}}onEnd(){for(const e of this._createdAROnlyElements)e.remove&&e.remove()}findArContainer(e){if(e.classList.contains(Ar))return e;if(e.children){for(const t of e.children)if(!(!t||!t.classList)&&t.classList.contains(Ar))return t}return null}onRequestedEndAR(){if(!!this.currentSession){this.currentSession.end(),this.currentSession=null;for(const e of this.registeredCloseEventElements)e.removeEventListener("click",this.closeARCallback);this.registeredCloseEventElements.length=0}}createFallbackCloseARButton(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","38px"),t.setAttribute("height","38px"),t.style.position="absolute",t.style.right="20px",t.style.top="40px",t.style.zIndex="9999",t.style.pointerEvents="auto",t.addEventListener("click",this.closeARCallback),e.appendChild(t),this._createdAROnlyElements.push(t);var s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),s.setAttribute("stroke","#eee"),s.setAttribute("stroke-width","2px"),t.appendChild(s),this._createdAROnlyElements.push(s)}}ew(cf,"AROverlayHandler");var iw=Object.defineProperty,al=(i,e)=>iw(i,"name",{value:e,configurable:!0});const sw=v("debugloadingbar");class nw{constructor(){r(this,"className");r(this,"additionalClasses")}}al(nw,"LoadingElementOptions");class hf{constructor(e,t){r(this,"loadingProgress",0);r(this,"container");r(this,"_progress",0);r(this,"_allowCustomLoadingElement",!1);r(this,"_loadingElement");r(this,"_loadingTextContainer",null);r(this,"_loadingBar",null);r(this,"_messageContainer",null);r(this,"_loadingElementOptions");r(this,"_progressLoop");this.container=e,this._loadingElementOptions=t}onLoadingBegin(e){if(!this._loadingElement){for(let t=0;t<this.container.children.length;t++){const s=this.container.children[t];if(s.classList.contains("loading")){if(!this._allowCustomLoadingElement){this.container.removeChild(s);continue}this._loadingElement=this.createLoadingElement();return}}this._loadingElement=this.createLoadingElement()}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="",this.container.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(e!=null?e:"")}onLoadingUpdate(e,t){var n;((n=this._loadingElement)==null?void 0:n.parentElement)||this.onLoadingBegin(t);let s=0;typeof e=="number"?s=e:("index"in e&&(s=e.index/e.count+e.progress.loaded/e.progress.total/e.count),!t&&"name"in e&&this.setMessage(e.name)),this.loadingProgress=s,t&&this.setMessage(t),this.updateDisplay()}onLoadingFinished(e){this.loadingProgress=1,this.setMessage(e!=null?e:"")}setMessage(e){this._messageContainer&&(this._messageContainer.innerText=e)}smoothProgressLoop(){if(this._progressLoop)return;let e=1/12;sw&&(e=.001);const t=1-.05;this._progressLoop=setInterval(()=>{if(this.loadingProgress>=1&&this._progress>=t){this._loadingElement&&(this._loadingElement.style.display="none",this._loadingElement.remove()),clearInterval(this._progressLoop),this._progressLoop=null;return}this._progress=k.lerp(this._progress,this.loadingProgress,e*this.loadingProgress),this.updateDisplay()},e)}updateDisplay(){const e=this._progress,t=(e*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=e*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=t)}createLoadingElement(e){var l,c,h;this._loadingElement=e||document.createElement("div");const t=(c=(l=this._loadingElementOptions)==null?void 0:l.className)!=null?c:"loading";if(this._loadingElement.classList.add(t),(h=this._loadingElementOptions)==null?void 0:h.additionalClasses)for(const d of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(d);e||(this._loadingElement.style.color="white",this._loadingElement.style.display="flex");const s=document.createElement("div"),n=20;s.style.display="flex",s.style.width=n+"%",s.style.height="2px",s.style.background="rgba(255,255,255,.1)",this._loadingElement.appendChild(s),this._loadingBar=document.createElement("div"),s.appendChild(this._loadingBar);const o=al(function(d){return k.lerp(n*.5,100-n*.5,d)+"%"},"getGradientPos");this._loadingBar.style.background=`linear-gradient(90deg, #02022B ${o(0)}, #0BA398 ${o(.4)}, #99CC33 ${o(.5)}, #D7DB0A ${o(1)})`,this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",this._loadingTextContainer=document.createElement("div"),this._loadingTextContainer.style.display="flex",this._loadingTextContainer.style.justifyContent="center",this._loadingTextContainer.style.marginTop=".9em",this._loadingElement.appendChild(this._loadingTextContainer);const a=document.createElement("div");return this._messageContainer=a,a.style.display="flex",a.style.fontSize=".8em",a.style.paddingTop=".5em",a.style.color="rgba(255,255,255,.5)",this._loadingElement.appendChild(a),this._loadingElement}}al(hf,"EngineLoadingView");var rw=Object.defineProperty,js=(i,e)=>rw(i,"name",{value:e,configurable:!0});class df{constructor(e,t){r(this,"id");r(this,"context");r(this,"previouslyAdded");r(this,"previousSource");r(this,"networkEvent");this.id=e,this.context=t,this.networkEvent="needle-engine-source-changed",this.id&&(this.networkEvent+="-"+this.id),this.context.connection.beginListen(this.networkEvent,s=>{this.onSourceChanged(s,!0)})}async onSourceChanged(e,t=!1,s=!1){this.previouslyAdded&&(t&&e===this.previousSource||p.destroySynced(this.previouslyAdded)),this.previouslyAdded=null,t||this.context.connection.send(this.networkEvent,e),this.previousSource=e,A.Current=this.context;const n=await Ii(this.context,e,this.getHashFromString(e));s||oi(this.context);const o=n==null?void 0:n.scene;o&&(this.previouslyAdded=o,this.context.scene.add(o))}getHashFromString(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}js(df,"EngineElementSourceFileWatcher");const ow="needle-engine",aw="vr",lw="desktop",cw=[Ar,aw,lw];class uf extends HTMLElement{constructor(){super();r(this,"gameObject",p);r(this,"GameObject",p);r(this,"context",null);r(this,"overlay_ar");r(this,"_watcher");r(this,"_loadingView");this.overlay_ar=new cf}get loadingProgress01(){var e,t;return(t=(e=this._loadingView)==null?void 0:e.loadingProgress)!=null?t:0}get loadingFinished(){return this.loadingProgress01>.999}getContext(){return new Promise((e,t)=>{if(this.context&&this.loadingFinished)e(this.context);else{const s=js(()=>{this.removeEventListener("loading-finished",s),this.context&&this.loadingFinished&&e(this.context)},"cb");this.addEventListener("loading-finished",s)}})}async connectedCallback(){var a,l,c;this.onSetupDesktop();var e=new MutationObserver(this.onElementsChanged.bind(this));e.observe(this,{childList:!0});const t=js(()=>{const h=this.getAttribute("src");return(h==null?void 0:h.endsWith(".glb"))||(h==null?void 0:h.endsWith(".gltf"))?h:null},"srcFile");let s="loadScene";const n=t();n&&(s=n);const o=this.getAttribute("alias");if(this.context=new A({name:s,domElement:this,alias:o}),this._watcher=new df((l=(a=this.getAttribute("id"))!=null?a:o)!=null?l:"",this.context),this._loadingView=new hf(this),s&&s.length>0){if(!n)for(;Object.keys(Rr).length<=0;){if(!this.isConnected)return;await $l(10)}let h=(c=Rr[s])!=null?c:window[s],d=null;if((!h||n)&&(n&&(s=n),h=js(async u=>{const _=t();_&&this._watcher&&(d=_,await this._watcher.onSourceChanged(_,!0,!0))},"fn")),h){this.classList.add("loading"),console.log("Begin loading scene",s!=null?s:o),this._loadingView.onLoadingBegin("begin load"),await this.context.onCreate(h,{progress:this._loadingView.onLoadingUpdate.bind(this._loadingView)});const u=t();u&&u!==d&&await this._watcher.onSourceChanged(u,!0,!0),this._loadingView.onLoadingFinished("create scene"),this.classList.remove("loading"),this.classList.add("loading-finished"),console.log("Finished loading scene",o!=null?o:s),this.dispatchEvent(new Event("loading-finished")),this.onSetupDesktop()}else console.error('Could not find scene function named "'+s+'", it must be either in global scope or added to build_scene_functions',Rr)}else console.error("Missing src attribute - please provide a function name",this)}disconnectedCallback(){this.context&&this.context.onDestroy()}static get observedAttributes(){return["src"]}attributeChangedCallback(e,t,s){var n;(n=this._watcher)==null||n.onSourceChanged(s)}getAROverlayContainer(){var t;return(t=this.overlay_ar)==null?void 0:t.findArContainer(this)}getVROverlayContainer(){for(let e=0;e<this.children.length;e++){const t=this.children[e];if(t.classList.contains("vr"))return t}return null}onEnterAR(e,t){this.onSetupAR(),this.overlay_ar.onBegin(t,e)}onExitAR(e){this.overlay_ar.onEnd(),this.onSetupDesktop()}onEnterVR(e){this.onSetupVR()}onExitVR(){this.onSetupDesktop()}onElementsChanged(){}onSetupAR(){this.classList.add("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,Ar))}onSetupVR(){this.classList.remove("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,"vr"))}onSetupDesktop(){this.classList.remove("ar-session-active"),this.classList.add("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,"desktop"))}setupElementsForMode(e,t,s=null){var o;if(e===((o=this.context)==null?void 0:o.renderer.domElement)||e.id==="VRButton"||e.id==="ARButton")return;if(e.style.position="absolute",e.classList.contains(t))e.style.visibility="visible",e.style.display="block";else for(const a of cw)e.classList.contains(a)&&(e.style.visibility="hidden",e.style.display="none")}foreachHtmlElement(e){for(let t=0;t<this.children.length;t++){const s=this.children[t];s.style&&e(s)}}}js(uf,"EngineElement");window.customElements.define(ow,uf);
