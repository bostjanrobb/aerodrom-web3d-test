var ff=Object.defineProperty,pf=Object.defineProperties;var mf=Object.getOwnPropertyDescriptors;var La=Object.getOwnPropertySymbols;var gf=Object.prototype.hasOwnProperty,_f=Object.prototype.propertyIsEnumerable;var ur=(i,t,e)=>t in i?ff(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,le=(i,t)=>{for(var e in t||(t={}))gf.call(t,e)&&ur(i,e,t[e]);if(La)for(var e of La(t))_f.call(t,e)&&ur(i,e,t[e]);return i},fr=(i,t)=>pf(i,mf(t));var r=(i,t,e)=>(ur(i,typeof t!="symbol"?t+"":t,e),e);import{Q as P,V as y,E as Pt,v as bf,O as S,a as V,b as I,S as yf,M as Ot,I as vf,R as pr,L as xs,c as wf,B as Qe,W as xf,d as Pf,e as ct,f as ke,g as Of,h as Cf,i as Da,C as Sf,P as mr,l as Rf,j as Ef,k as Ma,m as f,n as Ia,o as Af,s as Ye,p as gr,A as _r,q as ja,r as Oi,t as kf,u as Tf,w as br,x as Lf,y as Fa,D as Df,K as Mf,z as If,G as yr,F as Ba,H as jf,J as Ff,N as Bf,T as vr,U as Ps,X as Ua,Y as Uf,Z as Nf,_ as Os,$ as Na,a0 as za,a1 as Ci,a2 as Je,a3 as zf,a4 as $f,a5 as $a,a6 as Wf,a7 as Hf,a8 as Gf,a9 as Vf,aa as Wa,ab as qf,ac as Ha,ad as Si,ae as Xf,af as Qf,ag as Yf,ah as Jf,ai as Zf,aj as Kf,ak as tp,al as ep,am as Ga,an as ip,ao as sp,ap as np,aq as rp,ar as wr,as as op,at as Va,au as ap,av as lp,aw as qa,ax as cp,ay as hp,az as dp,aA as up,aB as fp,aC as xr,aD as Xa,aE as Qa,aF as Ya,aG as pp,aH as mp,aI as Ja,aJ as gp,aK as _p,aL as bp,aM as yp,aN as vp,aO as Ri,aP as wp,aQ as xp,aR as Pp,aS as Op,aT as Cp,aU as Sp,aV as Rp}from"./vendor.79264100.js";const Ep=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}};Ep();const Ei="__isActiveInHierarchy",Ze="builtin_components";function Te(i,t){try{t?i(t):i()}catch(e){return console.error(e),!1}return!0}var Ap=Object.defineProperty,z=(i,t)=>Ap(i,"name",{value:t,configurable:!0});const Pr=z(()=>i=>i,"nameofFactory");function kp(i){return Pr()(i)}z(kp,"nameof");function Tp(){return!!w("debug")}z(Tp,"isDebugMode");let Or=!1;const Cr=[];setTimeout(()=>{Or&&console.log(Cr)},100);function Ai(){return new URLSearchParams(window.location.search)}z(Ai,"getUrlParams");function w(i){Or&&!Cr.includes(i)&&Cr.push(i);const t=Ai();if(t.has(i)){const e=t.get(i);return e||!0}return!1}z(w,"getParam");Or=w("help")===!0;function Lp(i,t){const e=Ai();e.has(i)?e.set(i,t):e.append(i,t),document.location.search=e.toString()}z(Lp,"setParam");function Dp(i,t,e=!0){const s=Ai();s.has(i)?s.set(i,t):s.append(i,t),e?Za(i,s):Sr(i,s)}z(Dp,"setParamWithoutReload");function ki(i,t,e){i.has(t)?i.set(t,e.toString()):i.append(t,e.toString())}z(ki,"setOrAddParamsToUrl");function Za(i,t){window.history.pushState(null,i,"?"+t.toString())}z(Za,"pushState");function Sr(i,t){window.history.replaceState(null,i,"?"+t.toString())}z(Sr,"setState");function Mp(i){for(var t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=e.length,n=0;n<i;n++)t+=e.charAt(Math.floor(Math.random()*s));return t}z(Mp,"makeId");function Ka(i,t){return Math.floor(Math.random()*(t-i+1))+i}z(Ka,"randomNumber");const tl=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],el=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function il(){const i=tl[Math.floor(Math.random()*tl.length)],t=el[Math.floor(Math.random()*el.length)];return i+"_"+t}z(il,"makeIdFromRandomWords");function sl(i){return i=i.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,""),i.trim()}z(sl,"sanitizeString");function Le(i,t,e=!0,s=!1){var n;if(t==null)return null;if(t.userData&&t.userData.guid===i)return t;if(t.guid==i)return t;if(s&&((n=t.userData)==null?void 0:n.components)){for(const o of t.userData.components)if(o.guid===i)return o}if(e){if(t.scenes)for(const o in t.scenes){const a=t.scenes[o],l=Le(i,a,e,s);if(l)return l}if(t.children)for(const o in t.children){const a=t.children[o],l=Le(i,a,e,s);if(l)return l}}}z(Le,"tryFindObject");function Cs(i,t){if(i!=null&&typeof i=="object"){let e;Array.isArray(i)?e=[]:(e=Object.create(i),Object.assign(e,i));for(const s of Object.keys(i)){const n=i[s];t&&!t(i,s,n)?e[s]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?e[s]=n.clone():e[s]=Cs(n,t)}return e}return i}z(Cs,"deepClone");function nl(i){return new Promise((t,e)=>{setTimeout(t,i)})}z(nl,"delay");function rl(i,t){if(t&&i&&!t.includes("/")){const e=i.lastIndexOf("/");if(e>=0)return i.substring(0,e+1)+t}return t}z(rl,"getPath");var Ip=Object.defineProperty,Lt=(i,t)=>Ip(i,"name",{value:t,configurable:!0});const jp=w("debugnewscripts"),L=[];function Ke(i){if(!(i.new_scripts.length<=0)){if(jp&&console.log("Register new components",i.new_scripts.length,i.alias?"element: "+i.alias:""),i.new_scripts_pre_setup_callbacks.length>0){for(const t of i.new_scripts_pre_setup_callbacks)!t||t();i.new_scripts_pre_setup_callbacks.length=0}L.length=0,i.new_scripts.length>0&&L.push(...i.new_scripts),i.new_scripts.length=0;for(let t=0;t<L.length;t++)try{const e=L[t];if(e.destroyed)continue;if(!e.gameObject){console.error("MISSING GAMEOBJECT - will ignore",e),L.splice(t,1),t--;continue}e.context=i,ti(e.gameObject),Rr(e,i)}catch(e){console.error(e),Vt(L[t],i),L.splice(t,1),t--}for(let t=0;t<L.length;t++)try{const e=L[t];if(e.destroyed){Vt(L[t],i),L.splice(t,1),t--;continue}e.__internalAwake!==void 0&&(e.gameObject||console.error("MISSING GAMEOBJECT",e,e.gameObject),ti(e.gameObject),e.activeAndEnabled&&Te(e.__internalAwake.bind(e)))}catch(e){console.error(e),Vt(L[t],i),L.splice(t,1),t--}for(let t=0;t<L.length;t++)try{const e=L[t];if(e.destroyed||e.enabled===!1||(ti(e.gameObject),e.activeAndEnabled===!1))continue;e.__internalEnable!==void 0&&(e.enabled=!0,Te(e.__internalEnable.bind(e)))}catch(e){console.error(e),Vt(L[t],i),L.splice(t,1),t--}for(let t=0;t<L.length;t++)try{const e=L[t];if(e.destroyed||!e.gameObject)continue;i.new_script_start.push(e)}catch(e){console.error(e),Vt(L[t],i),L.splice(t,1),t--}L.length=0;for(const t of i.new_scripts_post_setup_callbacks)t&&t();i.new_scripts_post_setup_callbacks.length=0}}Lt(Ke,"processNewScripts");function ol(i){!i||(i.__internalDisable(),Vt(i,i.context))}Lt(ol,"processRemoveFromScene");function al(i){for(let t=0;t<i.new_script_start.length;t++)try{const e=i.new_script_start[t];if(e.destroyed||e.activeAndEnabled===!1)continue;Te(e.__internalAwake.bind(e)),Te(e.__internalEnable.bind(e)),Te(e.__internalStart.bind(e)),i.new_script_start.splice(t,1),t--}catch(e){console.error(e),Vt(i.new_script_start[t],i),i.new_script_start.splice(t,1),t--}}Lt(al,"processStart");function Rr(i,t){t.scripts.indexOf(i)===-1&&(t.scripts.push(i),i.earlyUpdate&&t.scripts_earlyUpdate.push(i),i.update&&t.scripts_update.push(i),i.lateUpdate&&t.scripts_lateUpdate.push(i),i.onBeforeRender&&t.scripts_onBeforeRender.push(i),i.onAfterRender&&t.scripts_onAfterRender.push(i))}Lt(Rr,"addScriptToArrays");function Vt(i,t){qt(i,t.new_scripts),qt(i,t.new_script_start),qt(i,t.scripts),qt(i,t.scripts_earlyUpdate),qt(i,t.scripts_update),qt(i,t.scripts_lateUpdate),qt(i,t.scripts_onBeforeRender),qt(i,t.scripts_onAfterRender),t.stopAllCoroutinesFrom(i)}Lt(Vt,"removeScriptFromContext");function qt(i,t){const e=t.indexOf(i);e>=0&&t.splice(e,1)}Lt(qt,"removeFromArray");const Fp={},ll={};function cl(){if(!A.Current){console.trace("Invalid call - no current context.");return}Er(A.Current.scene,A.Current.scene.visible,!0)}Lt(cl,"updateIsActive");function Er(i,t,e){const s=p.isActiveSelf(i);Fp[i.uuid]=s,t&&(t=p.isActiveSelf(i)),i[Ei]=t;{const n=ll[i.uuid];n!==void 0&&n!==t&&e&&hl(i,o=>{t?(Te(o.__internalAwake.bind(o)),o.onEnable()):o.onDisable()})}if(ll[i.uuid]=t,i.children)for(const n of i.children)Er(n,t,e)}Lt(Er,"updateIsActiveInHierarchyRecursiveRuntime");function ti(i){let t=!0,e=i,s=!1;for(;e&&e;){if(e.type==="Scene"&&(s=!0),!p.isActiveSelf(e)){t=!1;break}e=e.parent}if(!i){console.error("GO is null");return}i[Ei]=t&&s}Lt(ti,"updateActiveInHierarchyWithoutEventCall");function hl(i,t){var e;if((e=i.userData)==null?void 0:e.components)for(const s of i.userData.components)t(s)}Lt(hl,"perComponent");function dl(i,t){var s;if(!i)return;const e=(s=t==null?void 0:t.new_scripts)!=null?s:A.Current.new_scripts;e.includes(i)||e.push(i)}const Bp=function(i,t){if(!i||!i.userData.components)return;const e=i.userData.components.indexOf(t);e<0||(t.gameObject=null,i.userData.components.splice(e,1))},ul=function(i,t,e=!0){t.userData||(t.userData={}),t.userData.components||(t.userData.components=[]),t.userData.components.push(i),i.gameObject=t,dl(i);try{i.__internalAwake&&e&&(ti(t),i.__internalAwake())}catch(s){console.error(s)}},Up=function(i,t){if(i.gameObject!==t){if(i.gameObject&&i.gameObject.userData.components){const e=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(e,1)}t.userData.components.includes(i)||(t.userData.components.push(i),i.gameObject=t)}},Np=function(i){var t;if(i.gameObject&&i.gameObject.userData.components){const e=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(e,1)}i.__internalDisable&&i.__internalDisable(),i.onDestroy&&i.onDestroy(),Vt(i,(t=i.context)!=null?t:A.Current),i.__destroyed=!0,i.gameObject=null},fl=function(i,t,e){var s;if(!((s=t==null?void 0:t.userData)==null?void 0:s.components))return null;for(let n=0;n<t.userData.components.length;n++){const o=t.userData.components[n];if(i===null||o.constructor.name===i.name||o.constructor.name===i)if(e)e.push(o);else return o}for(let n=0;n<t.userData.components.length;n++){const o=t.userData.components[n];let a=Object.getPrototypeOf(o.constructor);do{if(a===i)if(e)e.push(o);else return o;a=Object.getPrototypeOf(a)}while(a)}return e},Ar=function(i,t){return fl(i,t,null)},kr=function(i,t,e){return e||(e=[]),fl(i,t,e)},Tr=function(i,t,e){var n;const s=Ar(i,t);if(e===!1&&s.enabled===!1)return null;if(s)return s;for(let o=0;o<((n=t==null?void 0:t.children)==null?void 0:n.length);o++){const a=Tr(i,t.children[o]);if(a)return a}return null},Lr=function(i,t,e){var s;e||(e=[]),kr(i,t,e);for(let n=0;n<((s=t==null?void 0:t.children)==null?void 0:s.length);n++)Lr(i,t.children[n],e);return e},pl=function(i,t){if(!t)return null;const e=Ar(i,t);return e||pl(i,t.parent)},ml=function(i,t,e){return e||(e=[]),t?(kr(i,t,e),ml(i,t.parent,e)):e},zp=function(i,t,e){if(!i)return null;if(!t&&(t=A.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),null;const s=t.isScene===!0||t.isObject3D===!0?t:t==null?void 0:t.scene;for(const n in s.children){const o=s.children[n];if(e===!1&&o[Ei]===!1)continue;if(o.constructor==i)return o;const a=Tr(i,o);if(a)return a}return null},$p=function(i,t,e){if(!i)return t;if(!e&&(e=A.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),t;const s=e.isScene===!0||e.isObject3D===!0?e:e==null?void 0:e.scene;if(!s)return t;for(const n in s.children){const o=s.children[n];if(o.constructor==i)return o;Lr(i,o,t)}return t};var Wp=Object.defineProperty,Hp=(i,t)=>Wp(i,"name",{value:t,configurable:!0});class gl{random(){return Math.random()}clamp(t,e,s){return t<e?e:t>s?s:t}clamp01(t){return this.clamp(t,0,1)}lerp(t,e,s){return s=s<0?0:s,s=s>1?1:s,t+(e-t)*s}moveTowards(t,e,s){return t+=s,(s<0&&t<e||s>0&&t>e)&&(t=e),t}toDegrees(t){return t*180/Math.PI}toRadians(t){return t*Math.PI/180}}Hp(gl,"MathHelper");const k=new gl;var Gp=Object.defineProperty,$=(i,t)=>Gp(i,"name",{value:t,configurable:!0});class _l{constructor(t,e){r(this,"_factory");r(this,"_cache",[]);r(this,"_maxSize");r(this,"_index",0);this._factory=t,this._maxSize=e}get(){let t=this._index++;return t>=this._cache.length&&(t>=this._maxSize?t=this._index=0:this._cache.push(this._factory())),this._cache[t]}}$(_l,"CircularBuffer");const Vp=new P().setFromAxisAngle(new y(0,1,0),Math.PI);function qp(i,t){i.lookAt(t),i.quaternion.multiply(Vp)}$(qp,"lookAtInverse");const Dr=new _l(()=>new y,30);function C(i,t=null,e=!0){const s=Dr.get();return i?i.parent?(e&&i.updateWorldMatrix(!0,!1),i.matrixWorldNeedsUpdate&&i.updateMatrixWorld(),s.setFromMatrixPosition(i.matrixWorld),t&&t.copy(s),t!=null?t:s):s.copy(i.position):s.set(0,0,0)}$(C,"getWorldPosition");function D(i,t){var n;if(!i)return;const e=Dr.get();t!==e&&e.copy(t),((n=i==null?void 0:i.parent)!=null?n:i).worldToLocal(e),i.position.set(e.x,e.y,e.z)}$(D,"setWorldPosition");function Ss(i,t,e,s){const n=Dr.get();n.set(t,e,s),D(i,n)}$(Ss,"setWorldPositionXYZ");const De=new P,Ti=new P,Mr=new P;function J(i,t=null){if(!i)return Ti.set(0,0,0,1);const e=t!=null?t:Ti;return i.parent?(i.getWorldQuaternion(e),e):e.copy(i.quaternion)}$(J,"getWorldQuaternion");function Z(i,t){if(!i)return;t!==De&&De.copy(t);const e=De,s=i==null?void 0:i.parent;s==null||s.getWorldQuaternion(Mr),Mr.invert();const n=Mr.multiply(e);i.quaternion.set(n.x,n.y,n.z,n.w)}$(Z,"setWorldQuaternion");function bl(i,t,e,s,n){De.set(t,e,s,n),Z(i,De)}$(bl,"setWorldQuaternionXYZW");const Rs=new y,Xp=new y;function yl(i,t=null){return i?i.parent?(i.getWorldScale(t!=null?t:Rs),t!=null?t:Rs):Rs.copy(i.position):Rs.set(0,0,0)}$(yl,"getWorldScale");function Qp(i,t){if(!i)return;if(!i.parent){i.scale.copy(t);return}const e=Xp;i.parent.getWorldScale(e),e.divide(t),i.scale.copy(e)}$(Qp,"setWorldScale");const Yp=new y,vl=new P;function Jp(i){return J(i,vl),Yp.set(0,0,1).applyQuaternion(vl)}$(Jp,"forward");const wl=new Pt,xl=new Pt,Zp=new y;function Pl(i){return i.getWorldQuaternion(Ti),xl.setFromQuaternion(Ti),xl}$(Pl,"getWorldEuler");function Ol(i,t){Z(i,Ti.setFromEuler(t))}$(Ol,"setWorldEuler");function Ir(i){const t=Pl(i),e=Zp;return e.set(t.x,t.y,t.z),e.x=k.toDegrees(e.x),e.y=k.toDegrees(e.y),e.z=k.toDegrees(e.z),e}$(Ir,"getWorldRotation");function Kp(i,t){Es(i,t.x,t.y,t.z,!0)}$(Kp,"setWorldRotation");function Es(i,t,e,s,n=!0){n&&(t=k.toRadians(t),e=k.toRadians(e),s=k.toRadians(s)),wl.set(t,e,s),De.setFromEuler(wl),Z(i,De)}$(Es,"setWorldRotationXYZ");function As(i,t=!0){!i||(t?$(function e(s){console.groupCollapsed((s.name?s.name:"(no name : "+s.type+")")+" %o",s),s.children.forEach(e),console.groupEnd()},"printGraph")(i):i.traverse(function(e){for(var s="|___",n=e;n.parent!==null;)s="	"+s,n=n.parent;console.log(s+e.name+" <"+e.type+">")}))}$(As,"logHierarchy");var tm=Object.defineProperty,it=(i,t)=>tm(i,"name",{value:t,configurable:!0});const ks=w("debugcomponents"),em="eff8ba80-635d-11ec-90d6-0242ac120003";class _t{constructor(t){r(this,"_originalSeed");r(this,"_seed");this._originalSeed=t,this._seed=t}get seed(){return this._seed}generateUUID(){const t=this._seed;return this._seed-=1,bf(t.toString(),em)}static createFromString(t){return new _t(this.hash(t))}static hash(t){let e=0;for(let s=0;s<t.length;s++)e=t.charCodeAt(s)+((e<<5)-e);return e}}it(_t,"InstantiateIdProvider");var Me;(function(i){i.NewInstanceCreated="new-instance-created",i.InstanceDestroyed="instance-destroyed"})(Me||(Me={}));class jr{constructor(t){r(this,"guid");this.guid=t}}it(jr,"DestroyInstanceModel");function Ts(i,t,e=!0){if(!i)return;const s=i;if(p.destroy(i,e),!t){console.warn("Can not send destroy: No networking connection provided",i.guid);return}if(!t.isConnected){console.warn("Can not send destroy: not connected",i.guid);return}let n=i.guid;if(!n&&s.uuid&&(n=s.uuid),!n){console.warn("Can not send destroy: failed to find guid",i);return}const o=new jr(n);t.send(Me.InstanceDestroyed,o)}it(Ts,"syncDestroy");function Cl(i,t){const e=new jr(i);t.send(Me.InstanceDestroyed,e)}it(Cl,"sendDestroyed");function Sl(i){i.connection.beginListen(Me.InstanceDestroyed,t=>{ks&&console.log("[Remote] Destroyed",i.scene,t);const e=p.findByGuid(t.guid,i.scene);e&&p.destroy(e)})}it(Sl,"beginListenDestroy");class im{constructor(t,e,s){r(this,"filename");r(this,"hash");r(this,"size");this.filename=t,this.hash=e,this.size=s}}it(im,"HostData");class Rl{constructor(t,e){r(this,"guid");r(this,"originalGuid");r(this,"seed");r(this,"visible");r(this,"hostData");r(this,"dontSave");r(this,"parent");r(this,"position");r(this,"rotation");r(this,"scale");this.originalGuid=t,this.guid=e}}it(Rl,"NewInstanceModel");function Fr(i,t,e,s){var c;const n=i;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(t.context||(t.context=A.Current),!t.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=t?le({},t):null,{instance:a,seed:l}=Al(n,t);if(a){const h=a;if(h.guid){ks&&console.log("[Local] new instance","gameobject:",a==null?void 0:a.guid);const d=new Rl(n.guid,h.guid);d.seed=l,o&&(o.position&&(d.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(d.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(d.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),d.position||(d.position={x:h.position.x,y:h.position.y,z:h.position.z}),d.rotation||(d.rotation={x:h.quaternion.x,y:h.quaternion.y,z:h.quaternion.z,w:h.quaternion.w}),d.scale||(d.scale={x:h.scale.x,y:h.scale.y,z:h.scale.z}),d.visible=n.visible,(o==null?void 0:o.parent)&&(typeof o.parent=="string"?d.parent=o.parent:d.parent=o.parent.guid),d.hostData=e,s===!1&&(d.dontSave=!0),(c=t==null?void 0:t.context)==null||c.connection.send(Me.NewInstanceCreated,d)}else console.warn("Missing guid, can not send new instance event",h)}return a}it(Fr,"syncInstantiate");function Ls(){return Math.random()*9999999}it(Ls,"generateSeed");function El(i){i.connection.beginListen(Me.NewInstanceCreated,async t=>{const e=await Ll(t.originalGuid,i.scene);if(!e){console.warn("could not find object that was instantiated: "+t.guid);return}const s=new Ct;t.position&&(s.position=new y(t.position.x,t.position.y,t.position.z)),t.rotation&&(s.rotation=new P(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w)),t.scale&&(s.scale=new y(t.scale.x,t.scale.y,t.scale.z)),s.parent=t.parent,t.seed&&(s.idProvider=new _t(t.seed)),s.visible=t.visible,s.context=i,ks&&i.alias&&console.log("[Remote] instantiate in: "+i.alias);const n=p.instantiate(e,s);n&&(t.parent==="scene"&&i.scene.add(n),ks&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,e))})}it(El,"beginListenInstantiate");function Al(i,t){const e=Ls(),s=t!=null?t:new Ct;s.idProvider=new _t(e);const n=p.instantiate(i,s);return{seed:e,instance:n}}it(Al,"instantiateSeeded");const kl={};function Tl(i,t){kl[i]=t}it(Tl,"registerPrefabProvider");async function Ll(i,t){const e=kl[i];if(e!=null){const s=await e(i);if(s)return s}return Br(i,t)}it(Ll,"tryResolvePrefab");function Br(i,t){if(t===null||!i)return null;if(t.guid===i)return t;if(t.children)for(const e of t.children){const s=Br(i,e);if(s)return s}return null}it(Br,"tryFindObjectByGuid");var sm=Object.defineProperty,Ds=(i,t)=>sm(i,"name",{value:t,configurable:!0});const ce=w("debugcomponents");var Dl;(function(i){i[i.None=0]="None",i[i.HideInHierarchy=1]="HideInHierarchy",i[i.HideInInspector=2]="HideInInspector",i[i.DontSaveInEditor=4]="DontSaveInEditor",i[i.NotEditable=8]="NotEditable",i[i.DontSaveInBuild=16]="DontSaveInBuild",i[i.DontUnloadUnusedAsset=32]="DontUnloadUnusedAsset",i[i.DontSave=52]="DontSave",i[i.HideAndDontSave=61]="HideAndDontSave"})(Dl||(Dl={}));class Ct{constructor(){r(this,"idProvider");r(this,"parent");r(this,"keepWorldPosition");r(this,"position");r(this,"rotation");r(this,"scale");r(this,"visible");r(this,"context")}}Ds(Ct,"InstantiateOptions");S.prototype.SetActive=function(i){console.log(i,this),this.visible=i};class p extends S{constructor(){super(...arguments);r(this,"guid")}static setActive(t,e){!t||(t.visible=e)}static isActiveSelf(t){return t.visible||p.isUsingInstancing(t)}static isActiveInHierarchy(t){return t[Ei]||p.isUsingInstancing(t)}static markAsInstancedRendered(t,e){t.__isUsingInstancing=e}static isUsingInstancing(t){return t.__isUsingInstancing===!0}static foreachComponent(t,e,s=!0){if(!!t){if(t.userData.components)for(let n=0;n<t.userData.components.length;n++){const o=t.userData.components[n];if(o instanceof v){const a=e(o);if(a!==void 0)return a}}if(s&&t.children)for(let n=0;n<t.children.length;n++){const o=t.children[n];if(!o)continue;const a=p.foreachComponent(o,e,s);if(a!==void 0)return a}}}static instantiateSynced(t,e){return t?Fr(t,e):null}static instantiate(t,e=null){if(t===null)return null;let s=null;e!==null&&(e.x!==void 0?(s=new Ct,s.position=e):s=e);let n=A.Current;(s==null?void 0:s.context)&&(n=s.context),ce&&n.alias&&console.log("context",n.alias),s&&!s.idProvider&&(s.idProvider=new _t(Date.now()));const o=[],a={},l={},c=this.internalInstantiate(n,t,s,o,a,l);c&&(this.resolveReferences(a),this.resolveAndBindSkinnedMeshBones(l,a)),ce&&(As(t,!0),As(c,!0));const h={};for(const d in o){const u=o[d],_=u.guid;s&&s.idProvider&&(u.guid=s.idProvider.generateUUID(),h[_]=u.guid,ce&&console.log(u.name,u.guid)),dl(u,n),u.__internalNewInstanceCreated&&u.__internalNewInstanceCreated()}for(const d in o){const u=o[d];u.resolveGuids&&u.resolveGuids(h),u.enabled!==!1&&(u.enabled=!0)}return Ke(n),c}static internalInstantiate(t,e,s,n,o,a){var u;if(!e)return null;const l=e.userData;e.userData={};const c=e.children;e.children=[];let h;if(h=e.clone(!1),e.userData=l,e.children=c,o[e.uuid]={original:e,clone:h},e.type==="SkinnedMesh"&&(a[e.uuid]={original:e,clone:h}),(s==null?void 0:s.visible)!==void 0&&(h.visible=s.visible),s==null?void 0:s.idProvider){h.uuid=s.idProvider.generateUUID();const _=h;_&&(_.guid=h.uuid)}e.animations&&e.animations.length>0&&(h.animations=[...e.animations]);const d=e.parent;if(d&&d.add(h),(s==null?void 0:s.position)?D(h,s.position):h.position.copy(e.position),(s==null?void 0:s.rotation)?Z(h,s.rotation):h.quaternion.copy(e.quaternion),(s==null?void 0:s.scale)?h.scale.copy(s.scale):h.scale.copy(e.scale),(s==null?void 0:s.parent)&&s.parent!=="scene"){let _=null;if(typeof s.parent=="string"?_=Le(s.parent,t.scene,!0):_=s.parent,_){const b=s.keepWorldPosition===!0?_.attach:_.add;b?b.call(_,h):console.error("Invalid parent object",_,"received when instantiating:",e)}else console.warn("could not find parent:",s.parent)}for(const[_,b]of Object.entries(e.userData))_!=="components"&&(h.userData[_]=b);if((u=e.userData)==null?void 0:u.components){const _=e.userData.components,b=[];h.userData.components=b;for(let x=0;x<_.length;x++){const O=_[x],R=Object.create(O);Object.assign(R,O),b.push(R),R.gameObject=h,n.push(R)}}s&&(s.position=void 0,s.rotation=void 0,s.scale=void 0,s.parent=void 0);for(const _ in e.children){const b=e.children[_],x=p.internalInstantiate(t,b,s,n,o,a);x&&h.add(x)}return h}static resolveAndBindSkinnedMeshBones(t,e){for(const s in t){const n=t[s],o=n.original,a=o.skeleton,l=n.clone;if(!a){console.warn("Skinned mesh has no skeleton?",n);continue}const c=a.bones,h=l.skeleton.clone();l.skeleton=h,l.bindMatrix.clone().copy(o.bindMatrix),l.bindMatrixInverse.copy(o.bindMatrixInverse);const d=[];h.bones=d;for(let u=0;u<c.length;u++){const _=c[u],x=e[_.uuid].clone;d.push(x)}}for(const s in t){const n=t[s].clone;n.skeleton.update(),n.bind(n.skeleton,n.bindMatrix),n.updateMatrixWorld(!0)}}static resolveReferences(t){var e;for(const s in t){const o=t[s].clone;if((e=o.userData)==null?void 0:e.components)for(let a=0;a<o.userData.components.length;a++){const l=o.userData.components[a],c=Object.entries(l);for(const[h,d]of c)if(Array.isArray(d)){const u=[];l[h]=u;for(let _=0;_<d.length;_++){const b=d[_];if(typeof b!="object"){u.push(b);continue}const x=this.postProcessNewInstance(l,h,b,t);x!==void 0?u.push(x):u.push(b)}}else if(typeof d=="object"){const u=this.postProcessNewInstance(l,h,d,t);u!==void 0&&(l[h]=u)}}}}static postProcessNewInstance(t,e,s,n){var o,a;if(s instanceof St||s instanceof v){const l=s.gameObject;if(l){const c=l.uuid,h=(o=n[c])==null?void 0:o.clone;if(!h){ce&&console.log("reference did not change",e,t,s);return}const d=l.userData.components.indexOf(s);if(d>=0)return ce&&console.log(e,c),h.userData.components[d];console.warn("could not find component",e,s)}}else if(s instanceof S){if(e==="gameObject")return;const l=s;if(l){const c=l.uuid,h=(a=n[c])==null?void 0:a.clone;if(h)return ce&&console.log(e,"old",s,"new",h),h}}}static destroySynced(t,e,s=!0){if(!t)return;const n=t;e=e!=null?e:A.Current,Ts(n,e.connection,s)}static destroy(t,e=!0,s=!0){const n=t;if(n.isComponent){n.destroy();return}const o=t;if(ce&&console.log(o),e&&o.children)for(const l of o.children)p.destroy(l,e,!1);const a=o.userData.components;if(a){let l=a.length;for(let c=0;c<a.length;c++){const h=a[c];h.destroy&&(ce&&console.log("destroying",h),h.destroy()),a.length<l&&(l=a.length,c--)}}s&&o.removeFromParent()}static add(t,e,s){if(!(!t||!e)){if(t===e){console.warn("Can not add object to self",t);return}s||(s=A.Current),e.add(t),ti(t),s?p.foreachComponent(t,n=>{Rr(n,s),s.new_script_start.includes(n)===!1&&s.new_script_start.push(n)},!0):console.warn("Missing context")}}static remove(t){var e;!t||((e=t.parent)==null||e.remove(t),p.foreachComponent(t,s=>{ol(s)},!0))}static invokeOnChildren(t,e,...s){this.invoke(t,e,!0,s)}static invoke(t,e,s=!1,...n){!t||this.foreachComponent(t,o=>{const a=o[e];a&&typeof a=="function"&&a.bind(o)(...n)},s)}static addNewComponent(t,e,s=!0){const n=new e;return ul(n,t,s),n}static addComponent(t,e){if(e.gameObject==null)throw new Error("Did you mean to create a new component? Use addNewComponent");Up(e,t)}static removeComponent(t){return Bp(t.gameObject,t),t}static getOrAddComponent(t,e){const s=this.getComponent(t,e);return s||this.addNewComponent(t,e)}static getComponent(t,e){return t===null?null:Ar(e,t)}static getComponents(t,e,s=null){return t===null?s!=null?s:[]:kr(e,t,s)}static findByGuid(t,e){return Le(t,e,!0,!0)}static findObjectOfType(t,e,s=!0){return zp(t,e,s)}static findObjectsOfType(t,e){const s=[];return $p(t,s,e),s}static getComponentInChildren(t,e){return Tr(e,t)}static getComponentsInChildren(t,e,s=null){return Lr(e,t,s)}static getComponentInParent(t,e){return pl(e,t)}static getComponentsInParent(t,e,s=null){return ml(e,t,s)}static getAllComponents(t){var n;return[...(n=t.userData)==null?void 0:n.components]}static*iterateComponents(t){var s;const e=(s=t==null?void 0:t.userData)==null?void 0:s.components;if(e&&Array.isArray(e))for(let n=0;n<e.length;n++)yield e[n]}}Ds(p,"GameObject");S.prototype.addNewComponent=function(i){return p.addNewComponent(this,i)};S.prototype.removeComponent=function(i){return p.removeComponent(i)};S.prototype.getOrAddComponent=function(i){return p.getOrAddComponent(this,i)};S.prototype.getComponent=function(i){return p.getComponent(this,i)};S.prototype.getComponents=function(i,t){return p.getComponents(this,i,t)};S.prototype.getComponentInChildren=function(i){return p.getComponentInChildren(this,i)};S.prototype.getComponentsInChildren=function(i,t){return p.getComponentsInChildren(this,i,t)};S.prototype.getComponentInParent=function(i){return p.getComponentInParent(this,i)};S.prototype.getComponentInParent=function(i,t){return p.getComponentsInParent(this,i,t)};const Tt=class{constructor(){r(this,"__context");r(this,"__name");r(this,"gameObject");r(this,"guid","invalid");r(this,"sourceId");r(this,"__didAwake",!1);r(this,"__didStart",!1);r(this,"__didEnable",!1);r(this,"__isEnabled");r(this,"__destroyed",!1);r(this,"_worldPosition");r(this,"_worldQuaternion");r(this,"_worldEuler");r(this,"_worldRotation");this.__internalNewInstanceCreated()}get isComponent(){return!0}get context(){var t;return(t=this.__context)!=null?t:A.Current}set context(t){this.__context=t}get scene(){return this.context.scene}get layer(){var t;return(t=this.gameObject)==null?void 0:t.userData.layer}get name(){var t;return(t=this.gameObject)==null?void 0:t.userData.name}set name(t){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=t,this.__name=t):this.__name=t}get tag(){var t;return(t=this.gameObject)==null?void 0:t.userData.tag}set tag(t){this.gameObject&&(this.gameObject.userData.tag=t)}get static(){var t;return(t=this.gameObject)==null?void 0:t.userData.static}get hideFlags(){var t;return(t=this.gameObject)==null?void 0:t.userData.hideFlags}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const t=this.gameObject[Ei];return t===void 0?!0:t}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(t,e=xt.Update){return this.context.registerCoroutineUpdate(this,t,e)}stopCoroutine(t,e=xt.Update){this.context.unregisterCoroutineUpdate(t,e)}get destroyed(){return this.__destroyed}destroy(){this.destroyed||Np(this)}__internalNewInstanceCreated(){this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(){this.__didEnable||(this.__didEnable=!0,this.onEnable())}__internalDisable(){!this.__didEnable||(this.__didEnable=!1,this.onDisable())}get worldPosition(){return this._worldPosition||(this._worldPosition=new y),C(this.gameObject,this._worldPosition),this._worldPosition}set worldPosition(t){D(this.gameObject,t)}setWorldPosition(t,e,s){Tt._worldPositionBuffer.set(t,e,s),this.worldPosition=Tt._worldPositionBuffer}get worldQuaternion(){return this._worldQuaternion||(this._worldQuaternion=new P),J(this.gameObject,this._worldQuaternion)}set worldQuaternion(t){Z(this.gameObject,t)}setWorldQuaternion(t,e,s,n){Tt._worldQuaternionBuffer.set(t,e,s,n),this.worldQuaternion=Tt._worldQuaternionBuffer}get worldEuler(){return this._worldEuler||(this._worldEuler=new Pt),this._worldEuler.setFromQuaternion(this.worldQuaternion),this._worldEuler}set worldEuler(t){var e;this._worldQuaternion||(this._worldQuaternion=new P),(e=this._worldQuaternion)==null||e.setFromEuler(t),this.worldQuaternion=this._worldQuaternion}get worldRotation(){const t=this.worldEuler;this._worldRotation||(this._worldRotation=new y);const e=this._worldRotation;return e.set(t.x,t.y,t.z),e.x=k.toDegrees(e.x),e.y=k.toDegrees(e.y),e.z=k.toDegrees(e.z),e}set worldRotation(t){this.setWorldRotation(t.x,t.y,t.z,!0)}setWorldRotation(t,e,s,n=!0){n&&(t=k.toRadians(t),e=k.toRadians(e),s=k.toRadians(s)),Tt._worldEulerBuffer.set(t,e,s),Tt._worldQuaternionBuffer.setFromEuler(Tt._worldEulerBuffer),this.worldQuaternion=Tt._worldQuaternionBuffer}get forward(){return Tt._forward.set(0,0,1).applyQuaternion(this.worldQuaternion)}};let St=Tt;r(St,"_worldPositionBuffer",new y),r(St,"_worldQuaternionBuffer",new P),r(St,"_worldEulerBuffer",new Pt),r(St,"_tempQuaternionBuffer2",new P),r(St,"_forward",new y(0,0,1));Ds(St,"Component");class v extends St{get enabled(){var t;return(t=this.__isEnabled)!=null?t:!0}set enabled(t){t!==this.__isEnabled&&(this.__isEnabled=t,!!this.__didAwake&&(t?this.__internalEnable():this.__internalDisable()))}}Ds(v,"Behaviour");var nm=Object.defineProperty,rm=(i,t)=>nm(i,"name",{value:t,configurable:!0}),Ms;(function(i){i.PointerDown="pointerDown"})(Ms||(Ms={}));class Ml extends EventTarget{constructor(t){super();r(this,"_doubleClickTimeThreshold",.5);r(this,"_longPressTimeThreshold",1);r(this,"_specialCursorTrigger",0);r(this,"context");r(this,"_pointerDown",[!1]);r(this,"_pointerUp",[!1]);r(this,"_pointerClick",[!1]);r(this,"_pointerDoubleClick",[!1]);r(this,"_pointerPressed",[!1]);r(this,"_pointerPositions",[new V]);r(this,"_pointerPositionsLastFrame",[new V]);r(this,"_pointerPositionsDelta",[new V]);r(this,"_pointerPositionsRC",[new V]);r(this,"_pointerPositionDown",[new V]);r(this,"_pointerDownTime",[]);r(this,"_pointerUpTime",[]);r(this,"_pointerIds",[]);r(this,"_pointerTypes",[""]);r(this,"_mouseWheelChanged",[!1]);r(this,"_pointerEvent",[]);r(this,"keysPressed",{});this.context=t,this.context.post_render_callbacks.push(this.onEndOfFrame.bind(this));const e=this.context.renderer.domElement;e.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!0}),e.addEventListener("touchend",this.onTouchUp.bind(this),!1),e.addEventListener("pointerdown",this.onPointerDown.bind(this),!1),e.addEventListener("pointermove",this.onPointerMove.bind(this),!1),e.addEventListener("pointerup",this.onPointerUp.bind(this),!1),e.addEventListener("wheel",this.onMouseWheel.bind(this),{passive:!0}),window.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("keypress",this.onKeyPressed.bind(this),!1),window.addEventListener("keyup",this.onKeyUp.bind(this),!1),window.addEventListener("blur",this.onLostFocus.bind(this))}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}setCursorPointer(){this._specialCursorTrigger+=1,this.context.domElement.style.cursor="pointer"}setCursorNormal(){this._specialCursorTrigger-=1,this._specialCursorTrigger=Math.max(0,this._specialCursorTrigger),this._specialCursorTrigger===0&&(this.context.domElement.style.cursor="default")}getPointerPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&t++;return t}getPointerPosition(t){return t>=this._pointerPositions.length?null:this._pointerPositions[t]}getPointerPositionLastFrame(t){return t>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[t]}getPointerPositionDelta(t){return t>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[t]}getPointerPositionRC(t){return t>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[t]}getPointerDown(t){return t>=this._pointerDown.length?!1:this._pointerDown[t]}getPointerUp(t){return t>=this._pointerUp.length?!1:this._pointerUp[t]}getPointerPressed(t){return t>=this._pointerPressed.length?!1:this._pointerPressed[t]}getPointerClicked(t){return t>=this._pointerClick.length?!1:this._pointerClick[t]}getPointerDoubleClicked(t){return t>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[t]}getPointerDownTime(t){return t>=this._pointerDownTime.length?-1:this._pointerDownTime[t]}getPointerUpTime(t){return t>=this._pointerUpTime.length?-1:this._pointerUpTime[t]}getPointerLongPress(t){return t>=this._pointerDownTime.length?!1:this.getPointerPressed(t)&&this.context.time.time-this._pointerDownTime[t]>this._longPressTimeThreshold}getIsMouse(t){return t>=this._pointerTypes.length?!1:this._pointerTypes[t]==="mouse"}getIsTouch(t){return t>=this._pointerTypes.length?!1:this._pointerTypes[t]==="touch"}getTouchesPressedCount(){let t=0;for(let e=0;e<this._pointerPressed.length;e++)this._pointerPressed[e]&&this.getIsTouch(e)&&t++;return t}getMouseWheelChanged(t=0){return t>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[t]}getPointerEvent(t){var e;if(!(t>=this._pointerEvent.length))return(e=this._pointerEvent[t])!=null?e:void 0}getKeyDown(){for(const t in this.keysPressed){const e=this.keysPressed[t];if(e.startFrame===this.context.time.frameCount)return e.key}return null}getKeyPressed(){for(const t in this.keysPressed){const e=this.keysPressed[t];if(e.pressed)return e.key}return null}isKeyDown(t){var e;return this.context.application.isVisible&&this.context.application.hasFocus&&((e=this.keysPressed[t])==null?void 0:e.startFrame)===this.context.time.frameCount&&this.keysPressed[t].pressed}isKeyUp(t){var e;return this.context.application.isVisible&&this.context.application.hasFocus&&((e=this.keysPressed[t])==null?void 0:e.frame)===this.context.time.frameCount&&!this.keysPressed[t].pressed}isKeyPressed(t){var e;return this.context.application.isVisible&&this.context.application.hasFocus&&((e=this.keysPressed[t])==null?void 0:e.pressed)}createPointerDown(t){this.onDown(t)}createPointerMove(t){this.onMove(t)}createPointerUp(t){this.onUp(t)}onLostFocus(){for(const t in this.keysPressed)this.keysPressed[t].pressed=!1}onEndOfFrame(){for(let t=0;t<this._pointerUp.length;t++)this._pointerUp[t]=!1;for(let t=0;t<this._pointerDown.length;t++)this._pointerDown[t]=!1;for(let t=0;t<this._pointerClick.length;t++)this._pointerClick[t]=!1;for(let t=0;t<this._pointerDoubleClick.length;t++)this._pointerDoubleClick[t]=!1;for(const t of this._pointerPositionsDelta)t.set(0,0);for(let t=0;t<this._mouseWheelChanged.length;t++)this._mouseWheelChanged[t]=!1}onKeyDown(t){if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.keyCode];e&&e.pressed||(this.keysPressed[t.keyCode]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:t.key})}onKeyPressed(t){if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.keyCode];!e||(e.pressed=!0,e.frame=this.context.time.frameCount+1)}onKeyUp(t){if(!this.context.application.hasFocus)return;const e=this.keysPressed[t.keyCode];!e||(e.pressed=!1,e.frame=this.context.time.frameCount+1)}onMouseWheel(t){this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0}onTouchMove(t){}onTouchUp(t){}onPointerDown(t){if(t.defaultPrevented||t.pointerType===void 0&&t.pointerId===void 0)return;t.preventDefault&&t.preventDefault();let e=t.pointerType==="mouse"?t.button:this.getPointerIndex(t.pointerId);t.pointerId===void 0&&t.button!==void 0&&(e=t.button),this.onDown({button:e,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,source:t})}onPointerMove(t,e=void 0){if(t.defaultPrevented||t.pointerType===void 0&&t.pointerId===void 0)return;e!==!0&&t.preventDefault();let s=t.pointerType==="mouse"?t.button:this.getPointerIndex(t.pointerId);t.pointerId===void 0&&t.button!==void 0&&(s=t.button),s<0&&(s=0);const n={button:s,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,source:t};this.onMove(n)}onPointerUp(t,e=void 0){if(t.defaultPrevented||t.pointerType===void 0&&t.pointerId===void 0)return;e!==!0&&t.preventDefault();let s=t.pointerType==="mouse"?t.button:this.getPointerIndex(t.pointerId);t.pointerId===void 0&&t.button!==void 0&&(s=t.button),this._pointerIds[s]=-1,this.onUp({button:s,clientX:t.clientX,clientY:t.clientY,pointerType:t.pointerType,source:t})}isInRect(t){return!0}onDown(t){if(!!this.isInRect(t)){for(this.setPointerState(t.button,this._pointerPressed,!0),this.setPointerState(t.button,this._pointerDown,!0),this.setPointerStateT(t.button,this._pointerEvent,t.source);t.button>=this._pointerTypes.length;)this._pointerTypes.push(t.pointerType);for(this._pointerTypes[t.button]=t.pointerType===void 0?"mouse":t.pointerType;t.button>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new V);this._pointerPositionDown[t.button].set(t.clientX,t.clientY),t.button>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[t.button]=this.context.time.time,this.updatePointerPosition(t),A.Current=this.context,this.dispatchEvent(new Event(Ms.PointerDown))}}onMove(t){!this.isInRect(t)||(this.updatePointerPosition(t),this.setPointerStateT(t.button,this._pointerEvent,t.source))}onUp(t){if(this.setPointerState(t.button,this._pointerPressed,!1),this.setPointerStateT(t.button,this._pointerEvent,t.source),!this.isInRect(t))return;if(this.setPointerState(t.button,this._pointerUp,!0),this.updatePointerPosition(t),!this._pointerPositionDown[t.button]){console.warn("Received pointer up event without matching down event for button: "+t.button);return}const e=t.clientX-this._pointerPositionDown[t.button].x,s=t.clientY-this._pointerPositionDown[t.button].y;if(t.button>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),Math.abs(e)<5&&Math.abs(s)<5){this.setPointerState(t.button,this._pointerClick,!0);const n=this._pointerUpTime[t.button],o=this.context.time.time-n;o<this._doubleClickTimeThreshold&&o>0&&this.setPointerState(t.button,this._pointerDoubleClick,!0)}this._pointerUpTime[t.button]=this.context.time.time}updatePointerPosition(t){for(;t.button>=this._pointerPositions.length;)this._pointerPositions.push(new V);for(;t.button>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new V);for(;t.button>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new V);const e=this._pointerPositionsLastFrame[t.button];e.copy(this._pointerPositions[t.button]),this._pointerPositionsDelta[t.button].set(t.clientX-e.x,t.clientY-e.y),this._pointerPositions[t.button].x=t.clientX,this._pointerPositions[t.button].y=t.clientY;const s=t.clientX+window.scrollX,n=t.clientY+window.scrollY;for(;t.button>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new V);this._pointerPositionsRC[t.button].x=(s-this.context.domX)/this.context.domWidth*2-1,this._pointerPositionsRC[t.button].y=-((n-this.context.domY)/this.context.domHeight)*2+1}getPointerIndex(t){for(let e=0;e<this._pointerIds.length;e++)if(this._pointerIds[e]===t)return e;for(let e=0;e<this._pointerIds.length;e++)if(this._pointerIds[e]===-1&&(this._pointerIds[e]=t),this._pointerIds[e]===t)return e;return this._pointerIds.push(t),this._pointerIds.length-1}setPointerState(t,e,s){for(;e.length<=t;)e.push(!1);e[t]=s}setPointerStateT(t,e,s){for(;e.length<=t;)e.push(null);e[t]=s}}rm(Ml,"Input");var Xt;(function(i){i[i.BACKSPACE=8]="BACKSPACE",i[i.TAB=9]="TAB",i[i.ENTER=13]="ENTER",i[i.SHIFT=16]="SHIFT",i[i.CTRL=17]="CTRL",i[i.ALT=18]="ALT",i[i.PAUSE=19]="PAUSE",i[i.CAPS_LOCK=20]="CAPS_LOCK",i[i.ESCAPE=27]="ESCAPE",i[i.SPACE=32]="SPACE",i[i.PAGE_UP=33]="PAGE_UP",i[i.PAGE_DOWN=34]="PAGE_DOWN",i[i.END=35]="END",i[i.HOME=36]="HOME",i[i.LEFT_ARROW=37]="LEFT_ARROW",i[i.UP_ARROW=38]="UP_ARROW",i[i.RIGHT_ARROW=39]="RIGHT_ARROW",i[i.DOWN_ARROW=40]="DOWN_ARROW",i[i.INSERT=45]="INSERT",i[i.DELETE=46]="DELETE",i[i.KEY_0=48]="KEY_0",i[i.KEY_1=49]="KEY_1",i[i.KEY_2=50]="KEY_2",i[i.KEY_3=51]="KEY_3",i[i.KEY_4=52]="KEY_4",i[i.KEY_5=53]="KEY_5",i[i.KEY_6=54]="KEY_6",i[i.KEY_7=55]="KEY_7",i[i.KEY_8=56]="KEY_8",i[i.KEY_9=57]="KEY_9",i[i.KEY_A=65]="KEY_A",i[i.KEY_B=66]="KEY_B",i[i.KEY_C=67]="KEY_C",i[i.KEY_D=68]="KEY_D",i[i.KEY_E=69]="KEY_E",i[i.KEY_F=70]="KEY_F",i[i.KEY_G=71]="KEY_G",i[i.KEY_H=72]="KEY_H",i[i.KEY_I=73]="KEY_I",i[i.KEY_J=74]="KEY_J",i[i.KEY_K=75]="KEY_K",i[i.KEY_L=76]="KEY_L",i[i.KEY_M=77]="KEY_M",i[i.KEY_N=78]="KEY_N",i[i.KEY_O=79]="KEY_O",i[i.KEY_P=80]="KEY_P",i[i.KEY_Q=81]="KEY_Q",i[i.KEY_R=82]="KEY_R",i[i.KEY_S=83]="KEY_S",i[i.KEY_T=84]="KEY_T",i[i.KEY_U=85]="KEY_U",i[i.KEY_V=86]="KEY_V",i[i.KEY_W=87]="KEY_W",i[i.KEY_X=88]="KEY_X",i[i.KEY_Y=89]="KEY_Y",i[i.KEY_Z=90]="KEY_Z",i[i.LEFT_META=91]="LEFT_META",i[i.RIGHT_META=92]="RIGHT_META",i[i.SELECT=93]="SELECT",i[i.NUMPAD_0=96]="NUMPAD_0",i[i.NUMPAD_1=97]="NUMPAD_1",i[i.NUMPAD_2=98]="NUMPAD_2",i[i.NUMPAD_3=99]="NUMPAD_3",i[i.NUMPAD_4=100]="NUMPAD_4",i[i.NUMPAD_5=101]="NUMPAD_5",i[i.NUMPAD_6=102]="NUMPAD_6",i[i.NUMPAD_7=103]="NUMPAD_7",i[i.NUMPAD_8=104]="NUMPAD_8",i[i.NUMPAD_9=105]="NUMPAD_9",i[i.MULTIPLY=106]="MULTIPLY",i[i.ADD=107]="ADD",i[i.SUBTRACT=109]="SUBTRACT",i[i.DECIMAL=110]="DECIMAL",i[i.DIVIDE=111]="DIVIDE",i[i.F1=112]="F1",i[i.F2=113]="F2",i[i.F3=114]="F3",i[i.F4=115]="F4",i[i.F5=116]="F5",i[i.F6=117]="F6",i[i.F7=118]="F7",i[i.F8=119]="F8",i[i.F9=120]="F9",i[i.F10=121]="F10",i[i.F11=122]="F11",i[i.F12=123]="F12",i[i.NUM_LOCK=144]="NUM_LOCK",i[i.SCROLL_LOCK=145]="SCROLL_LOCK",i[i.SEMICOLON=186]="SEMICOLON",i[i.EQUALS=187]="EQUALS",i[i.COMMA=188]="COMMA",i[i.DASH=189]="DASH",i[i.PERIOD=190]="PERIOD",i[i.FORWARD_SLASH=191]="FORWARD_SLASH",i[i.GRAVE_ACCENT=192]="GRAVE_ACCENT",i[i.OPEN_BRACKET=219]="OPEN_BRACKET",i[i.BACK_SLASH=220]="BACK_SLASH",i[i.CLOSE_BRACKET=221]="CLOSE_BRACKET",i[i.SINGLE_QUOTE=222]="SINGLE_QUOTE"})(Xt||(Xt={}));var om=Object.defineProperty,am=(i,t)=>om(i,"name",{value:t,configurable:!0});class Is{constructor(t){r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new I(1,1,0,0));r(this,"gameObject");r(this,"lightmapTexture",null);r(this,"lightmapScaleOffsetUniform",{value:new I(1,1,0,0)});r(this,"lightmapUniform",{value:null});this.gameObject=t}get lightmap(){return this.lightmapTexture}set lightmap(t){t!==this.lightmapTexture&&(this.lightmapTexture=t,this.setupLightmap())}init(t,e,s,n=!1){if(console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=t,this.lightmapIndex<0)return;this.lightmapScaleOffset=e,this.lightmapTexture=s,n&&this.setLightmapDebugMaterial(),this.setupLightmap()}bindOnBeforeRender(){this.gameObject.onBeforeRender=this.onBeforeRenderThreeComplete.bind(this)}onBeforeRenderThreeComplete(t,e,s,n,o,a){this.onBeforeRenderThree(o)}setupLightmap(){if(this.gameObject.type==="Object3D")return;if(this.gameObject.type==="Group"){console.warn("Lightmap on multimaterial object is not supported yet... please ask kindly for implementation.");return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const t=this.gameObject;t.geometry.getAttribute("uv2")||t.geometry.setAttribute("uv2",t.geometry.getAttribute("uv"));const e=this.gameObject.material.clone();if(this.gameObject.material=e,this.gameObject.material.onBeforeCompile=(s,n)=>{s.uniforms.lightmap=this.lightmapUniform,s.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform},this.lightmapIndex>=0){const s=this.lightmapTexture,n=this.gameObject.material;n&&s&&(n.uniforms||(n.uniforms={}),n.lightMap=s,n.uniforms.lightmap={value:s})}}onBeforeRenderThree(t){const e=t.uniforms;e&&e.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,e.lightmap=this.lightmapUniform,e.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}setLightmapDebugMaterial(){this.gameObject.material=new yf({vertexShader:`
                attribute vec2 uv2;
                varying vec2 vUv2;
                void main()
                {
                    vUv2 = uv2;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightmap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv2;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightmap, lUv);
                    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
                    //lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
                    //lightMapTexel.a = 1.;
                    //lightMapTexel = conv_sRGBToLinear(lightMapTexel);
                    // lightMapTexel.rgb = vec3(1.);

                    // gl_FragColor = vec4(vUv2.xy, 0, 1);
                    gl_FragColor = lightMapTexel;
                }
                `,defines:{USE_LIGHTMAP:""}})}}am(Is,"RendererLightmap");var lm=Object.defineProperty,js=(i,t)=>lm(i,"name",{value:t,configurable:!0});const g=js(function(i){if(i===void 0&&(i=null),!Array.isArray(i))i=Ur(i);else for(let t=0;t<i.length;t++){const e=i[t];i[t]=Ur(e)}return function(t,e){Object.getOwnPropertyDescriptor(t,"$serializedTypes")||(t.$serializedTypes={});const s=t.$serializedTypes=t.$serializedTypes||{};s[e]=i}},"serializeable");function Ur(i){switch(i==null?void 0:i.prototype.constructor.name){case"Number":case"String":case"Boolean":return null}return i}js(Ur,"setNullForPrimitiveTypes");const cm="__NEEDLE__ALL_PROPERTIES";function hm(i){i[cm]=!0}js(hm,"allProperties");const dm="__NEEDLE__STRICT";function um(i){i[dm]=!0}js(um,"strict");var Il=Object.defineProperty,fm=Object.getOwnPropertyDescriptor,Qt=(i,t)=>Il(i,"name",{value:t,configurable:!0}),Ie=(i,t,e,s)=>{for(var n=s>1?void 0:s?fm(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Il(t,e,n),n};const jl=w("noInstancing"),Fl=!!w("debuglightmaps");class Bl{constructor(){r(this,"path",null);r(this,"asset",null);r(this,"default")}}Qt(Bl,"FieldWithDefault");var Ul;(function(i){i[i.Both=0]="Both",i[i.Back=1]="Back",i[i.Front=2]="Front"})(Ul||(Ul={}));class Nl{constructor(t){r(this,"_renderer");r(this,"_targets",[]);this._renderer=t;const e=this.setMaterial.bind(this),s=this.getMaterial.bind(this),n=t.gameObject;if(this._targets=[],n)switch(n.type){case"Group":this._targets=[...n.children];break;case"Mesh":this._targets.push(n);break}return new Proxy(this,{get(o,a){if(typeof a=="string"){const l=parseInt(a);if(!isNaN(l))return s(l)}return o[a]},set(o,a,l){return typeof a=="string"&&e(l,Number.parseInt(a)),Reflect.set(o,a,l)}})}is(t){return this._renderer===t}get length(){return this._targets.length}setMaterial(t,e){if(e<0||e>=this._targets.length)return;const s=this._renderer.gameObject;if(!s)return;const n=s.children[e];!n||(n.material=t)}getMaterial(t){if(t<0)return null;const e=this._targets;if(t>=e.length)return null;const s=e[t];return s?s.material:null}}Qt(Nl,"SharedMaterialArray");const zl=class extends v{constructor(){super(...arguments);r(this,"receiveShadows",!1);r(this,"shadowCastingMode",Fs.Off);r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new I(1,1,0,0));r(this,"enableInstancing");r(this,"renderOrder");r(this,"allowOcclusionWhenDynamic",!0);r(this,"_lightmaps");r(this,"_sharedMaterials");r(this,"_lightmapTextureOverride");r(this,"_isInstancingEnabled",!1);r(this,"handles");r(this,"prevLayers")}get material(){return this.gameObject.material}set material(i){this.gameObject.material=i}get sharedMaterials(){return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._sharedMaterials=new Nl(this)),this._sharedMaterials}static get shouldSuppressInstancing(){return jl}get lightmap(){var i;return((i=this._lightmaps)==null?void 0:i.length)?this._lightmaps[0].lightmap:null}set lightmap(i){var t;if(this._lightmapTextureOverride=i,i===void 0&&(i=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(t=this._lightmaps)==null?void 0:t.length)for(const e of this._lightmaps)e.lightmap=i}awake(){var t,e;const i=this.gameObject.type;if(i==="Group"){for(const s of this.gameObject.children)s.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let s=0;for(let n=0;n<this.gameObject.children.length;n++){const o=this.gameObject.children[n];if(!(o.type!=="Mesh"||p.getComponent(o,zl))){if(this.renderOrder.length<=s){console.error("Incorrect element count",this);break}o.renderOrder=this.renderOrder[s],s+=1}}}}if(this.lightmapIndex>=0){const s=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(s){if(this._lightmaps=[],i==="Mesh"){if(!((t=this.gameObject.material)==null?void 0:t.isMeshBasicMaterial)){const n=new Is(this.gameObject);this._lightmaps.push(n),n.init(this.lightmapIndex,this.lightmapScaleOffset,s,Fl)}}else if(i==="Group"){for(const n of this.gameObject.children)if(!((e=n.material)==null?void 0:e.isMeshBasicMaterial)){const o=new Is(n);this._lightmaps.push(o),o.init(this.lightmapIndex,this.lightmapScaleOffset,s,Fl),o.bindOnBeforeRender()}}}}(i==="Mesh"||i==="SkinnedMesh")&&(this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0]),this.gameObject.onBeforeRender=this.onBeforeRenderThree.bind(this))}setInstancingEnabled(i){if(this._isInstancingEnabled===i)return i&&(this.handles===void 0||this.handles!=null&&this.handles.length>0);if(this._isInstancingEnabled=i,i){if(this.handles===void 0){if(this.handles=pm.setup(this.gameObject,this.context,null,{rend:this,foundMeshes:0}),this.handles)return p.markAsInstancedRendered(this.gameObject,!0),!0}else if(this.handles!==null){for(const t of this.handles)t.updateInstanceMatrix(!0),t.add();return p.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this.handles)for(const t of this.handles)t.remove();return!0}return!1}start(){if(this.enableInstancing&&!jl&&this.setInstancingEnabled(!0),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.gameObject.type==="Group")for(let i=0;i<this.gameObject.children.length;i++){const t=this.gameObject.children[i];t.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this._isInstancingEnabled?this.setInstancingEnabled(!0):this.enabled&&(this.gameObject.visible=!0)}onDisable(){this.handles&&this.handles.length>0?this.setInstancingEnabled(!1):this.enabled||(this.gameObject.visible=!1)}onDestroy(){this.handles=null}onBeforeRenderThree(i,t,e,s,n,o){var a;if(!e&&this.context.isInXR){const l=this.context.renderer.xr.getCamera();((a=l.cameras)==null?void 0:a.length)>0&&(e=l)}if(this._lightmaps)for(const l of this._lightmaps)l.onBeforeRenderThree(n)}onBeforeRender(){var t;if(!this.gameObject)return;const i=this.gameObject[zr]===!0||this.gameObject.matrixWorldNeedsUpdate;if(this.gameObject.type==="Group"&&((t=this.gameObject.children)==null?void 0:t.length)>0)for(const e of this.gameObject.children)this.applySettings(e);else this.applySettings(this.gameObject);if(i&&(delete this.gameObject[zr],this.handles)){for(let e=this.handles.length-1;e>=0;e--)this.handles[e].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this.handles&&this.handles.length<=0&&p.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this.handles)for(let e=0;e<this.handles.length;e++){const s=this.handles[e];this.prevLayers||(this.prevLayers=[]);const n=s.object.layers.mask;e>=this.prevLayers.length?this.prevLayers.push(n):this.prevLayers[e]=n,s.object.layers.disableAll()}}onAfterRender(){if(this._isInstancingEnabled&&this.handles&&this.prevLayers&&this.prevLayers.length>=this.handles.length)for(let i=0;i<this.handles.length;i++){const t=this.handles[i];t.object.layers.mask=this.prevLayers[i]}}applySettings(i){i.receiveShadow=this.receiveShadows,this.shadowCastingMode==Fs.On?i.castShadow=!0:i.castShadow=!1}};let bt=zl;Qt(bt,"Renderer");Ie([g()],bt.prototype,"receiveShadows",2);Ie([g()],bt.prototype,"shadowCastingMode",2);Ie([g()],bt.prototype,"lightmapIndex",2);Ie([g(I)],bt.prototype,"lightmapScaleOffset",2);Ie([g()],bt.prototype,"enableInstancing",2);Ie([g()],bt.prototype,"renderOrder",2);Ie([g()],bt.prototype,"allowOcclusionWhenDynamic",2);class Nr extends bt{}Qt(Nr,"MeshRenderer");class $l extends Nr{awake(){super.awake(),this.allowOcclusionWhenDynamic=!1}}Qt($l,"SkinnedMeshRenderer");var Fs;(function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.TwoSided=2]="TwoSided",i[i.ShadowsOnly=3]="ShadowsOnly"})(Fs||(Fs={}));const zr="NEEDLE_NEED_UPDATE_INSTANCE";class ht{static markDirty(t,e=!0){if(!!t&&(p.isUsingInstancing(t)&&(t[zr]=!0,t.matrixWorldNeedsUpdate=!0),e))for(const s of t.children)ht.markDirty(s,!0)}}Qt(ht,"InstancingUtil");class Wl{constructor(){r(this,"objs",[])}setup(t,e,s,n,o=0){const a=this.tryCreateOrAddInstance(t,e,n);if(a)return s===null&&(s=[]),s.push(a),s;if(o<=0&&t.type!=="Mesh"){const l=o+1;for(const c of t.children)s=this.setup(c,e,s,n,l)}return s}tryCreateOrAddInstance(t,e,s){if(t.type==="Mesh"){const n=s.foundMeshes;if(s.foundMeshes+=1,!s.rend.enableInstancing||n>=s.rend.enableInstancing.length||!s.rend.enableInstancing[n])return null;const o=t,a=o.geometry,l=o.material;for(const h of this.objs)if(!h.isFull()&&h.geo===a&&h.material===l)return h.addInstance(o);const c=new Bs(t.name,a,l,200,e);return this.objs.push(c),c.addInstance(o)}return null}}Qt(Wl,"InstancingHandler");const pm=new Wl;class Hl{constructor(t,e,s){r(this,"instanceIndex",-1);r(this,"object");r(this,"instancer");this.instanceIndex=t,this.object=e,this.instancer=s,p.markAsInstancedRendered(e,!0)}get name(){return this.object.name}updateInstanceMatrix(t=!1){this.instanceIndex<0||(this.object.updateWorldMatrix(!0,t),this.instancer.updateInstance(this.object.matrixWorld,this.instanceIndex))}add(){this.instanceIndex>=0||this.instancer.add(this)}remove(){this.instanceIndex<0||this.instancer.remove(this)}}Qt(Hl,"InstanceHandle");const Oa=class{constructor(t,e,s,n,o){r(this,"name","");r(this,"geo");r(this,"material");r(this,"context");r(this,"inst");r(this,"handles",[]);r(this,"maxCount");this.name=t,this.geo=e,this.material=s,this.context=o,this.maxCount=n,this.inst=new vf(e,s,n),this.inst.count=0,this.inst.layers.set(2),this.inst.visible=!0,this.context.scene.add(this.inst)}get currentCount(){return this.inst.count}isFull(){return this.currentCount>=this.maxCount}addInstance(t){if(this.currentCount>=this.maxCount)return console.error("TOO MANY INSTANCES - resize is not yet implemented!",this.inst.count),null;const e=new Hl(-1,t,this);return this.add(e),e}add(t){t.instanceIndex<0&&(t.instanceIndex=this.currentCount,t.instanceIndex>=this.handles.length?this.handles.push(t):this.handles[t.instanceIndex]=t),t.object.updateWorldMatrix(!0,!0),this.inst.setMatrixAt(t.instanceIndex,t.object.matrixWorld),this.inst.instanceMatrix.needsUpdate=!0,this.inst.count+=1,this.inst.count>0&&(this.inst.visible=!0)}remove(t){if(!t||t.instanceIndex<0||t.instanceIndex>=this.handles.length||this.inst.count<=0)return;if(this.handles[t.instanceIndex]!==t){console.error("instance handle is not part of renderer, was it removed before?",t.instanceIndex,this.name);const s=this.handles.indexOf(t);if(s<0)return;t.instanceIndex=s}if(this.handles[t.instanceIndex]=null,this.inst.setMatrixAt(t.instanceIndex,Oa.nullMatrix),!(t.instanceIndex>=this.currentCount-1)&&this.currentCount>0){const s=this.handles[this.currentCount-1];s&&(s.instanceIndex=t.instanceIndex,s.updateInstanceMatrix(),this.handles[t.instanceIndex]=s,this.handles[this.currentCount-1]=null)}this.inst.count>0&&(this.inst.count-=1),t.instanceIndex=-1,this.inst.count<=0&&(this.inst.visible=!1),this.inst.instanceMatrix.needsUpdate=!0}updateInstance(t,e){this.inst.setMatrixAt(e,t),this.inst.instanceMatrix.needsUpdate=!0}};let Bs=Oa;r(Bs,"nullMatrix",new Ot);Qt(Bs,"InstancedMeshRenderer");var mm=Object.defineProperty,Yt=(i,t)=>mm(i,"name",{value:t,configurable:!0});const Li=w("debugphysics");class $r{constructor(){r(this,"mass",1);r(this,"kinematic",!1);r(this,"physicsEvents",!1);r(this,"drag",0);r(this,"angularDrag",.05);r(this,"sleepThreshold",.01)}}Yt($r,"BodyOptions");class Us{constructor(t,e){r(this,"obj");r(this,"parent");r(this,"body");r(this,"shapes",[]);r(this,"collisonCallback",null);r(this,"_hasRigidbody",!1);r(this,"_didSleepLastStep",!1);this.obj=t,this.parent=t.parent,this.body=e}}Yt(Us,"PhysicsObject");class Gl{constructor(t,e){r(this,"obj");r(this,"contact");r(this,"target");r(this,"type");this.contact=t,this.type=e,this.obj=null,this.target=null}}Yt(Gl,"CollisionData");class gm{constructor(t,e,s,n){r(this,"body");r(this,"contact");r(this,"target");r(this,"type");this.body=t,this.contact=e,this.target=s,this.type=n}}Yt(gm,"CannonCollision");class Dt{constructor(){r(this,"ray");r(this,"screenPoint");r(this,"raycaster");r(this,"results");r(this,"targets");r(this,"recursive",!0);r(this,"minDistance");r(this,"maxDistance");r(this,"lineThreshold");r(this,"layerMask");r(this,"ignore")}screenPointFromOffset(t,e){this.screenPoint===void 0&&(this.screenPoint=new V),this.screenPoint.x=t/window.innerWidth*2-1,this.screenPoint.y=-(e/window.innerHeight)*2+1}setMask(t){this.layerMask||(this.layerMask=new xs);const e=this.layerMask;e?e.mask=t:this.layerMask=t}}r(Dt,"AllLayers",4294967295);Yt(Dt,"RaycastOptions");class Vl{constructor(t,e,s){r(this,"distance");r(this,"point");r(this,"object");this.object=t,this.distance=e,this.point=s}}Yt(Vl,"SphereIntersection");class ql{constructor(t){r(this,"raycaster",new pr);r(this,"defaultRaycastOptions",new Dt);r(this,"targetBuffer",new Array(1));r(this,"defaultThresholds",{Mesh:{},Line:{threshold:0},LOD:{},Points:{threshold:0},Sprite:{}});r(this,"sphereResults",new Array);r(this,"sphereMask",new xs);r(this,"tempBoundingBox",new Qe);r(this,"context");r(this,"world",new xf);r(this,"objects",[]);r(this,"tempPosition",new y);r(this,"tempQuaternion",new P);if(this.context=t,this.world.gravity.set(0,-9.82,0),Li){const e={};e.onInit=(s,n,o)=>{n.layers.set(-1)},Pf(t.scene,this.world.bodies,e)}}sphereOverlap(t,e){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const s=new wf(t,e),n=this.sphereMask;n.enableAll(),n.disable(2);for(const o of this.context.scene.children){const a=this.onSphereOverlap(o,s,n);a&&this.sphereResults.push(a)}return this.sphereResults.sort((o,a)=>o.distance-a.distance)}onSphereOverlap(t,e,s){if(t.type==="Mesh"){if(!t.layers.test(s))return null;const n=t,o=n.geometry;if(o.boundingBox||o.computeBoundingBox(),!o.boundingBox)return null;n.matrixWorldNeedsUpdate&&n.updateMatrixWorld();const a=this.tempBoundingBox.copy(o.boundingBox).applyMatrix4(n.matrixWorld);if(e.intersectsBox(a)){const c=C(t).distanceTo(e.center);return new Vl(t,c,e.center.clone())}}else if(t.children)for(const n of t.children){const o=this.onSphereOverlap(n,e,s);if(o)return o}return null}raycastFromRay(t,e=null){const s=e!=null?e:this.defaultRaycastOptions;return s.ray=t,this.raycast(s)}raycast(t=null){var l,c,h,d,u;t||(t=this.defaultRaycastOptions);const e=(l=t.screenPoint)!=null?l:this.context.input.mousePositionRC,s=(c=t.raycaster)!=null?c:this.raycaster;if(s.near=(h=t.minDistance)!=null?h:0,s.far=(d=t.maxDistance)!=null?d:1/0,s.params=this.defaultThresholds,t.lineThreshold?s.params.Line={threshold:t.lineThreshold}:s.params.Line={threshold:0},t.ray)s.ray.copy(t.ray);else{const _=this.context.mainCamera;if(!_)return console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),(u=this.defaultRaycastOptions.results)!=null?u:[];s.setFromCamera(e,_)}let n=t.targets;n||(n=this.targetBuffer,n[0]=this.context.scene);let o=t.results;o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),t.layerMask!==void 0?t.layerMask instanceof xs?s.layers.mask=t.layerMask.mask:s.layers.mask=t.layerMask:(s.layers.enableAll(),s.layers.disable(2)),o.length=0,s.intersectObjects(n,t.recursive,o);const a=t.ignore;return a!==void 0&&a.length>0&&(o=o.filter(_=>!a.includes(_.object))),o}addPreStepListener(t){this.world.addEventListener("preStep",t)}addPostStepListener(t){this.world.addEventListener("postStep",t)}addConstraint(t){this.world.addConstraint(t)}setGravity(t){this.world.gravity.set(t.x,t.y,t.z)}multiplyGravity(t){this.world.gravity.x*=t.x,this.world.gravity.y*=t.y,this.world.gravity.z*=t.z}addBody(t,e){for(let s=0;s<this.objects.length;s++){const n=this.objects[s];if(n.obj===t){n._hasRigidbody=!0;break}}this.world.addBody(e)}removeBody(t,e,s=!0){this.world.removeBody(e);for(let n=0;n<this.objects.length;n++){const o=this.objects[n];if(o.obj===t){o._hasRigidbody=!1,s&&this.objects.splice(n,1);break}}}removeShape(t,e){for(const s of this.objects)if(s.obj===t){s.body&&(s.body.removeShape(e),s.body.updateMassProperties());return}}createBody(t,e){const s=this.internalCreateBody(t,null);e.mass&&(s.mass=e.mass),e.kinematic?s.type=ct.KINEMATIC:s.type=ct.DYNAMIC,e.drag&&(s.linearDamping=e.drag),e.angularDrag&&(s.angularDamping=e.angularDrag),e.sleepThreshold&&(s.sleepSpeedLimit=e.sleepThreshold),s.name=t.name,this.world.addBody(s);const n=new Us(t,s);return n._hasRigidbody=!0,this.objects.push(n),Li&&console.log("created new body",s),e.physicsEvents&&this.registerCollisionEvents(n),s}addBoxCollider(t,e,s,n,o){const a=this.tempPosition;t.getWorldScale(a);const l=new ke(.5*a.x*n.x,.5*a.y*n.y,.5*a.z*n.z),c=new Of(l);c.collisionResponse=!e,s=s.clone(),s.multiply(a);const h=this.addShape(t,c,s,o);if(h!==null){if(this.isAlreadyRegistered(h))return c;const d=new Us(t,h);this.objects.push(d)}return c}addSphereCollider(t,e,s,n){const o=this.tempPosition;t.getWorldScale(o);const a=Math.max(o.x,o.y,o.z),l=new Cf(s*a);e=e.clone(),e.multiply(o);const c=this.addShape(t,l,e,n);if(c!==null){if(this.isAlreadyRegistered(c))return l;const h=new Us(t,c);this.objects.push(h)}return l}addMeshCollider(t){Li&&console.warn("TODO mesh collider not yet supported")}isAlreadyRegistered(t){for(const e of this.objects)if(e.body===t)return!0;return!1}addShape(t,e,s,n){let o=null;if(n?(n.initialize(),console.assert(!!n.body,"rigidbody didn't initialize / produce a physics body",n),o=n.body):(o=this.internalCreateBody(t,null),o.type=ct.KINEMATIC,this.world.addBody(o)),o){s.x*=-1;const a=J(t),l=C(t);l.add(s);const c=new P(o.quaternion.x,o.quaternion.y,o.quaternion.z,o.quaternion.w);a.multiply(c.invert());const h=o.position,d=new ke(l.x-h.x,l.y-h.y,l.z-h.z),u=new Da(a.x,a.y,a.z,a.w);o.addShape(e,d,u),o.updateMassProperties()}return o}step(t){t=Math.min(t,1/30),this.world.step(t)}postStep(){for(let t=0;t<this.objects.length;t++){const e=this.objects[t],s=e.body;if(!s||!s.world)continue;s.sleepTick(this.context.time.time),Li&&(!e._didSleepLastStep&&s.sleepState===ct.SLEEPING?console.log("BODY SLEEPING",s):e._didSleepLastStep&&s.sleepState!==ct.SLEEPING&&console.log("BODY WOKE UP",s)),e._didSleepLastStep=s.sleepState===ct.SLEEPING;const n=e.obj;if(s.type===ct.KINEMATIC){const o=C(n,null);s.position.set(o.x,o.y,o.z);const a=J(n);s.quaternion.set(a.x,a.y,a.z,a.w);continue}if(e.parent&&n.parent===e.parent){bl(n,s.quaternion.x,s.quaternion.y,s.quaternion.z,s.quaternion.w);const o=s.position;Ss(n,o.x,o.y,o.z),s.velocity.length()>s.sleepSpeedLimit&&ht.markDirty(n)}}}internalCreateBody(t,e){const s=new ct;t.getWorldPosition(this.tempPosition);const n=this.tempPosition;s.position=new ke(n.x,n.y,n.z);const o=this.tempQuaternion;return t.getWorldQuaternion(o),s.quaternion=new Da(o.x,o.y,o.z,o.w),s.type=ct.KINEMATIC,e&&(s.addShape(e),s.updateMassProperties()),s}registerCollisionEvents(t){if(t.collisonCallback&&this.unregisterCollisionEvents(t),!t.body)return;const e=Yt(s=>this.raiseCollisionEvents(t.obj,s),"evt");t.collisonCallback=e.bind(this),t.body.addEventListener("collide",t.collisonCallback)}unregisterCollisionEvents(t){!t.collisonCallback||!t.body||t.body.removeEventListener("collide",t.collisonCallback)}raiseCollisionEvents(t,e){var l,c;const s=new Gl(e.contact,e.type);let n=0;const o=this.objects;function a(){if(!(n>0))for(let h=0;h<o.length;h++){if(n==2)return;const d=o[h];d.body==e.body?(s.obj=d.obj,++n):d.body==e.target&&(s.target=d.obj,++n)}}Yt(a,"requestData"),Li&&console.log("collision between",e.contact.bi,e.contact.bj,t,e);for(let h=0;h<((c=(l=t.userData)==null?void 0:l.components)==null?void 0:c.length);h++){const d=t.userData.components[h];d.onCollision&&(a(),d.onCollision(s))}}}Yt(ql,"Physics");var _m=Object.defineProperty,bm=(i,t)=>_m(i,"name",{value:t,configurable:!0});class Xl{constructor(){r(this,"deltaTime",0);r(this,"time",0);r(this,"frame",0);r(this,"clock",new Sf);r(this,"_smoothedFps",0);r(this,"_fpsSamples",[]);r(this,"_fpsSampleIndex",0)}get realtimeSinceStartup(){return this.clock.elapsedTime}get frameCount(){return this.frame}get smoothedFps(){return this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<30?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%30]=this.deltaTime;let t=0;for(let e=0;e<this._fpsSamples.length;e++)t+=this._fpsSamples[e];this._smoothedFps=1/(t/this._fpsSamples.length)}}bm(Xl,"Time");var ym=Object.defineProperty,vm=(i,t)=>ym(i,"name",{value:t,configurable:!0});class je extends v{constructor(){super(...arguments);r(this,"url",null);r(this,"urlParameterName",null);r(this,"localhost",null)}getWebsocketUrl(){let t=this.url?je.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const o=w(this.urlParameterName);o&&typeof o=="string"&&(t=o)}if(!t)return null;const s=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(t);return(s==null?void 0:s.groups)?(s==null?void 0:s.groups.socket_prefix)?t:"wss://"+(s==null?void 0:s.groups.url):null}static GetUrl(t,e){let s=t;const n=je.IsLocalNetwork()&&e;return n&&(s=e),(t==null?void 0:t.startsWith("/"))&&(s=(n?s:window.location.origin)+t),s}static IsLocalNetwork(t=window.location.hostname){return new RegExp(".{3}..{2,3}..{2,3}..{2,3}|localhost","gm").test(t)===!0?!0:["localhost","127.0.0.1","","::1","marcel-pfc-domain.de"].includes(t)||t.startsWith("192.168.")||t.startsWith("10.0.")||t.endsWith(".local")}}vm(je,"Networking");var wm=Object.defineProperty,Wr=(i,t)=>wm(i,"name",{value:t,configurable:!0});const Ql={};function Ns(i,t){Ql[i]=t}Wr(Ns,"registerType");function Yl(i){const t=i.getBufferIdentifier();return Ql[t](i)}Wr(Yl,"tryCast");function Jl(i){return typeof i.guid=="function"?i.guid():null}Wr(Jl,"tryGetGuid");var xm=Object.defineProperty,zs=(i,t)=>xm(i,"name",{value:t,configurable:!0}),Hr;(function(i){i.ConnectionList="connection-list"})(Hr||(Hr={}));class Zl{constructor(){r(this,"_host");r(this,"_client");r(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const t="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(t)}trySetupHost(t){let e=new mr(t);e.on("error",s=>{console.error(s),this._host=void 0,this.trySetupClient(t)}),e.on("open",s=>{this._host=new Kl(e)})}trySetupClient(t){this._client=new mr,this._client.on("error",e=>{console.error("Client error",e)}),this._client.on("open",e=>{console.log("client connected",e),this._clientData=this._client.connect(t,{metadata:{id:e}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",s=>{console.log("<<",s)})})}}zs(Zl,"PeerNetworking");class Gr{constructor(t){r(this,"_peer");this._peer=t}}zs(Gr,"AbstractPeerHandler");class Pm extends Gr{get isHost(){return!1}onConnection(t){}}zs(Pm,"PeerClient");class Kl extends Gr{constructor(t){super(t);r(this,"_connections",[]);var e;console.log("I AM THE HOST"),(e=this._peer)==null||e.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(t){console.log("host connection",t),t.on("open",()=>{this._connections.push(t),this.broadcastConnection(t)})}broadcastConnection(t){const e=this._connections.map(s=>{var n;return(n=s.metadata)==null?void 0:n.id}).filter(s=>s!==void 0);this.broadcast({type:Hr.ConnectionList,connections:e})}broadcast(t){if(t!=null){console.log(">>",t);for(const e in this._peer.connections){const s=this._peer.connections[e];if(!!s)if(Array.isArray(s))for(const n of s)!n||n.send(t);else console.warn(s)}}}}zs(Kl,"PeerHost");var Om=Object.defineProperty,ei=(i,t)=>Om(i,"name",{value:t,configurable:!0});let Vr="wss://needle-tiny-starter.glitch.me/socket";const dt=!!w("debugnet"),$s=!!(dt||w("debugowner"));var qr;(function(i){i.ConnectionInfo="connection-start-info"})(qr||(qr={}));var W;(function(i){i.Join="join-room",i.Leave="leave-room",i.JoinedRoom="joined-room",i.LeftRoom="left-room",i.UserJoinedRoom="user-joined-room",i.UserLeftRoom="user-left-room"})(W||(W={}));class Cm{constructor(){r(this,"room");r(this,"viewId");r(this,"allowEditing");r(this,"inRoom")}}ei(Cm,"JoinedRoomResponse");class Sm{constructor(){r(this,"room")}}ei(Sm,"LeftRoomResponse");class Rm{constructor(){r(this,"userId")}}ei(Rm,"UserJoinedOrLeftRoomModel");var Q;(function(i){i.RequestHasOwner="request-has-owner",i.ResponseHasOwner="response-has-owner",i.RequestIsOwner="request-is-owner",i.ResponseIsOwner="response-is-owner",i.RequestOwnership="request-ownership",i.GainedOwnership="gained-ownership",i.RemoveOwnership="remove-ownership",i.LostOwnership="lost-ownership",i.GainedOwnershipBroadcast="gained-ownership-broadcast",i.LostOwnershipBroadcast="lost-ownership-broadcast"})(Q||(Q={}));class Ws{constructor(t,e){r(this,"guid");r(this,"connection");r(this,"_hasOwnership",!1);r(this,"_isOwned");r(this,"_gainSubscription");r(this,"_lostSubscription");r(this,"_hasOwnerResponse");r(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=t,this.guid=e,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),t.beginListen(Q.LostOwnership,this._lostSubscription),t.beginListen(Q.GainedOwnershipBroadcast,this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),t.beginListen(Q.ResponseHasOwner,this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send(Q.RequestHasOwner,{guid:this.guid})}onHasOwnerResponse(t){t.guid===this.guid&&(this._isOwned=t.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this.connection.send(Q.RequestHasOwner,{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(t){t.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=t.value,t.value||($s&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((t,e)=>{this.requestOwnership();let s=0;const n=ei(()=>{if(s++>10)return e("Timeout");setTimeout(()=>{this.hasOwnership?t(this):n()},100)},"waitForOwnership");n()})}requestOwnership(){return $s&&console.log("Request ownership",this.guid),this.connection.send(Q.RequestOwnership,{guid:this.guid}),this}freeOwnership(){return this.connection.send(Q.RemoveOwnership,{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListening(Q.GainedOwnership,this._gainSubscription),this.connection.stopListening(Q.LostOwnership,this._lostSubscription),this.connection.stopListening(Q.ResponseHasOwner,this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Q.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(t){t.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===t.owner?($s&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(t){t===this.guid&&($s&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}ei(Ws,"OwnershipModel");var Di;(function(i){i[i.OnConnection=0]="OnConnection",i[i.OnRoomJoin=1]="OnRoomJoin",i[i.Queued=2]="Queued",i[i.Immediate=3]="Immediate"})(Di||(Di={}));class tc{constructor(t){r(this,"context");r(this,"_peer",null);r(this,"_usersInRoomCopy",[]);r(this,"_defaultMessagesBuffer",[]);r(this,"_defaultMessagesBufferArray",[]);r(this,"_listeners",{});r(this,"_listenersBinary",{});r(this,"connected",!1);r(this,"channelId");r(this,"_connectionId",null);r(this,"_isConnectingToWebsocket",!1);r(this,"_ws");r(this,"_waitingForSocket",{});r(this,"_isInRoom",!1);r(this,"_currentRoomName",null);r(this,"_currentRoomViewId",null);r(this,"_currentRoomAllowEditing",!0);r(this,"_currentInRoom",[]);r(this,"_state",{});r(this,"_currentDelay",-1);this.context=t}get peer(){return this._peer||(this._peer=new Zl),this._peer}tryGetState(t){return t==="invalid"?null:this._state[t]}get connectionId(){return this._connectionId}get isDebugEnabled(){return dt}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}userIsInRoom(t){return this._currentInRoom.indexOf(t)!==-1}usersInRoom(t=null){t||(t=this._usersInRoomCopy),t.length=0;for(const e of this._currentInRoom)t.push(e);return t}joinRoom(t,e=!1){this.connect(),dt&&console.log("join: "+t),this.send(W.Join,{room:t,viewOnly:e},0)}leaveRoom(t=null){if(t||(t=this.currentRoomName),!t){console.error("Can not leave unknown room");return}this.send(W.Leave,{room:t})}send(t,e=null,s=2){if(e===null&&(e={}),s===2){this._defaultMessagesBuffer.push({key:t,value:e});return}return this.sendWithWebsocket(t,e,s)}sendDeleteRemoteState(t){this.send("delete-state",{guid:t,dontSave:!0}),delete this._state[t]}sendBinary(t){var e;dt&&console.log("<< bin",t.length),(e=this._ws)==null||e.send(t)}sendBufferedMessagesNow(){var s;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const t=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(t<=1){this.sendWithWebsocket(o.key,o.value,3);break}const a=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(a)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&dt&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const e=JSON.stringify(this._defaultMessagesBufferArray);(s=this._ws)==null||s.send(e)}beginListen(t,e){return this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),e}stopListening(t,e){if(!e||!this._listeners[t])return;const s=this._listeners[t].indexOf(e);s>=0&&this._listeners[t].splice(s,1)}beginListenBinrary(t,e){return this._listenersBinary[t]||(this._listenersBinary[t]=[]),this._listenersBinary[t].push(e),e}stopListenBinary(t,e){if(!this._listenersBinary[t])return;const s=this._listenersBinary[t].indexOf(e);s>=0&&this._listenersBinary[t].splice(s,1)}connect(){if(this.connected)return;dt&&console.log("connecting");const t=p.findObjectOfType(je,this.context,!1),e=t==null?void 0:t.getWebsocketUrl();e&&(Vr=e),this.connectWebsocket()}connectWebsocket(){if(this._isConnectingToWebsocket)return;this._isConnectingToWebsocket=!0,console.log("Connecting to "+Vr);const t=new Rf.WebsocketBuilder(Vr).onOpen(()=>{this._ws=t,this._isConnectingToWebsocket=!1,this.connected=!0,console.log("Connected to websocket"),this.onSendQueued(0)}).onClose(e=>{this.connected=!1,this._isInRoom=!1}).onError((e,s)=>{console.error(e,s)}).onMessage(this.onMessage.bind(this)).onRetry(()=>{console.log("websocket connection retry")}).build()}onMessage(t,e){const s=e.data;try{if(typeof s!="string"){s.size&&this.handleIncomingBinaryMessage(s);return}const n=JSON.parse(s);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch{dt&&s==="pong"&&console.log("<<",s)}}async handleIncomingBinaryMessage(t){const e=await t.arrayBuffer();var s=new Uint8Array(e);const n=new Ef(s),o=n.getBufferIdentifier(),a=this._listenersBinary[o],l=Yl(n),c=Jl(l);if(c&&typeof c=="string"&&(this._state[c]=l),!a)return;const h=l!=null?l:n;for(const d of a)d(h)}handleIncomingStringMessage(t){var n,o,a,l,c,h,d;if(dt&&console.log("<<",(n=t.key)!=null?n:t),t.key)switch(t.key){case qr.ConnectionInfo:if(t.data){const b=t.data;b&&(console.assert(b.id!==void 0&&b.id!==null&&b.id.length>0,"server did not send connection id",b.id),console.log("Your id is: "+b.id,(o=this.context.alias)!=null?o:""),this._connectionId=b.id)}else console.warn("Expected connection id in "+t.key);break;case W.JoinedRoom:if(dt&&console.log(t),t){this._isInRoom=!0;const b=t;this._currentRoomName=b.room,this._currentRoomViewId=b.viewId,this._currentRoomAllowEditing=(a=b.allowEditing)!=null?a:!0,console.log("Room view id",this._currentRoomViewId),this._currentInRoom.length=0,this._currentInRoom.push(...b.inRoom),dt&&console.log("joined room with",this._currentInRoom,(l=this.context.alias)!=null?l:"")}this.onSendQueued(1);break;case W.LeftRoom:t.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentInRoom.length=0);break;case W.UserJoinedRoom:if(t.data){const b=t.data;this._currentInRoom.push(b.userId),dt&&console.log(b.userId+" joined","now in room:",this._currentInRoom)}break;case W.UserLeftRoom:if(t.data){const b=t.data,x=this._currentInRoom.indexOf(b.userId);x>=0&&(console.log(b.userId+" left",(c=this.context.alias)!=null?c:""),this._currentInRoom.splice(x,1)),b.userId===this.connectionId&&console.log("you left the room")}break;case"ping":case"pong":const _=(h=t.data)==null?void 0:h.time;_&&(this._currentDelay=this.context.time.time-_),dt&&console.log("Current latency: "+this._currentDelay.toFixed(1)+" sec","Clients in room: "+((d=this._currentInRoom)==null?void 0:d.length));break}const e=this._listeners[t.key];if(e)for(const u of e)u(t.data);const s=t.data;s&&(this._state[s.guid]=s)}toMessage(t,e){return{key:t,data:e}}sendWithWebsocket(t,e,s=1){if(!this._ws){const o=this._waitingForSocket[s]||[];o.push(()=>this.sendWithWebsocket(t,e,s)),this._waitingForSocket[s]=o;return}const n=JSON.stringify(this.toMessage(t,e));dt&&console.log(">>",t),this._ws.send(n)}onSendQueued(t){const e=this._waitingForSocket[t];if(e){for(const s of e)s();e.length=0}}}ei(tc,"NetworkConnection");var ec=Object.defineProperty,Em=Object.getOwnPropertyDescriptor,Am=(i,t)=>ec(i,"name",{value:t,configurable:!0}),km=(i,t,e,s)=>{for(var n=s>1?void 0:s?Em(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&ec(t,e,n),n};class Hs extends v{constructor(){super(...arguments);r(this,"constraintActive",!0);r(this,"locked",!1);r(this,"sources",[])}}Am(Hs,"LookAtConstraint");km([g(S)],Hs.prototype,"sources",2);var ic=Object.defineProperty,Tm=Object.getOwnPropertyDescriptor,Lm=(i,t)=>ic(i,"name",{value:t,configurable:!0}),Dm=(i,t,e,s)=>{for(var n=s>1?void 0:s?Tm(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&ic(t,e,n),n};class ii extends v{constructor(){super(...arguments);r(this,"autoRotate",!1);r(this,"autoRotateSpeed",1);r(this,"enableKeys",!0);r(this,"enableDamping",!0);r(this,"dampingFactor",.1);r(this,"enableZoom",!0);r(this,"minZoom",0);r(this,"maxZoom",1/0);r(this,"enablePan",!0);r(this,"lookAtConstraint",null);r(this,"lookAtConstraint01",1);r(this,"middleClickToFocus",!0);r(this,"doubleClickToFocus",!0);r(this,"debugLog",!1);r(this,"targetLerpSpeed",5);r(this,"targetPosition");r(this,"_controls",null);r(this,"_targetObject",null);r(this,"_lerpToTargetPosition",!1);r(this,"_lerpCameraToTarget",!1);r(this,"_cameraTargetPosition",null);r(this,"_inputs",0);r(this,"_enableTime",0)}get controls(){return this._controls}get controllerObject(){return this._targetObject}onStartInteraction(t){var e;(e=this.controls)==null||e.addEventListener("start",t)}awake(){this.targetPosition=new y}onEnable(){this._enableTime=this.context.time.time;const t=p.getComponent(this.gameObject,U),e=t==null?void 0:t.cam;this._controls||(console.assert(e!=null,"Missing camera",this),e&&(this._targetObject=e),this._controls=new Ma(e,this.context.renderer.domElement)),this._controls&&(this._controls.enableDamping=this.enableDamping,this._controls.enableKeys=this.enableKeys,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,(e==null?void 0:e.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom):(this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom),this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan)}onDisable(){this._controls&&(this._controls.enabled=!1,this._controls.autoRotate=!1)}start(){if(this._controls){const t=p.getComponent(this.gameObject,U);if(t&&!this.setFromTargetPosition()){console.log("NO TARGET");const e=new y(0,0,-1).applyMatrix4(t.cam.matrixWorld);this.setTarget(e)}}this.startCoroutine(this.startRaycastDelayed())}*startRaycastDelayed(){if(yield,!this.setFromTargetPosition()){const t=new Dt;t.screenPoint=new V(0,0),t.lineThreshold=.1;const e=this.context.physics.raycast(t);e.length>0&&this.setTarget(e[0].point)}}onBeforeRender(){var e,s;if(!this._controls)return;(this.context.input.getPointerDown(0)||this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2))&&(this._inputs+=1),this._inputs>0&&(this._controls.autoRotate=!1,this._lerpCameraToTarget=!1,this._lerpToTargetPosition=!1),this._inputs=0;let t=this.middleClickToFocus&&this.context.input.getPointerClicked(1);if(t||(t=this.doubleClickToFocus&&this.context.input.getPointerDoubleClicked(0)&&this.context.time.time-this._enableTime>.3),t?this.setTargetFromRaycast():(this.context.input.getPointerDown(0)||this.context.input.mouseWheelChanged)&&(this._lerpToTargetPosition=!1,this._lerpCameraToTarget=!1),this._lerpToTargetPosition||this._lerpCameraToTarget){const n=this.context.time.deltaTime*this.targetLerpSpeed;this._lerpCameraToTarget&&this._cameraTargetPosition&&this._targetObject&&((e=this._targetObject)==null||e.position.lerp(this._cameraTargetPosition,n),this._targetObject.position.distanceTo(this._cameraTargetPosition)<.01&&(this._lerpCameraToTarget=!1)),this._lerpToTargetPosition&&(this.lerpTarget(this.targetPosition,n),this.targetPosition.distanceTo(this._controls.target)<.005&&(this._lerpToTargetPosition=!1))}((s=this.lookAtConstraint)==null?void 0:s.locked)&&this.setFromTargetPosition(0,this.lookAtConstraint01),this._controls&&(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!0,this._controls.update())}setCameraTarget(t){this._lerpCameraToTarget=!0,this._cameraTargetPosition=t==null?void 0:t.clone()}setFromTargetPosition(t=0,e=1){var n;if(!this._controls)return!1;const s=(n=this.lookAtConstraint)==null?void 0:n.sources;if(s&&s.length>0){const o=s[t];if(o)return o.getWorldPosition(this.targetPosition),this.lerpTarget(this.targetPosition,e),!0}return!1}setTarget(t=null){!this._controls||(t!==null&&this.targetPosition.copy(t),this._controls.target.copy(this.targetPosition))}lerpTarget(t,e){!this._controls||this._controls.target.lerp(t,e)}distanceToTarget(t){return this._controls?this._controls.target.distanceTo(t):-1}setTargetFromRaycast(){if(!this.controls)return;const t=this.context.physics.raycast();for(const e of t)if(e.distance>0&&p.isActiveInHierarchy(e.object)){if(this.targetPosition.copy(e.point),this._lerpToTargetPosition=!0,this._cameraTargetPosition=null,this.context.mainCamera){this._lerpCameraToTarget=!0;const s=C(this.context.mainCamera);this._cameraTargetPosition=s.clone().sub(this.controls.target).add(this.targetPosition)}break}}}Lm(ii,"OrbitControls");Dm([g(Hs)],ii.prototype,"lookAtConstraint",2);var Mm=Object.defineProperty,Im=(i,t)=>Mm(i,"name",{value:t,configurable:!0});class Jt extends f{constructor(t,e,s,n){super(t,e,s);r(this,"alpha",1);this.alpha=n}clone(){const t=super.clone();return t.alpha=this.alpha,t}lerp(t,e){const s=t;return s.alpha&&(this.alpha=k.lerp(this.alpha,s.alpha,e)),super.lerp(t,e)}multiply(t){const e=t;return e.alpha&&(this.alpha=this.alpha*e.alpha),super.multiply(t)}}Im(Jt,"RGBAColor");var sc=Object.defineProperty,jm=Object.getOwnPropertyDescriptor,Xr=(i,t)=>sc(i,"name",{value:t,configurable:!0}),he=(i,t,e,s)=>{for(var n=s>1?void 0:s?jm(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&sc(t,e,n),n},nc;(function(i){i[i.Skybox=1]="Skybox",i[i.SolidColor=2]="SolidColor",i[i.Uninitialized=4]="Uninitialized"})(nc||(nc={}));const rc=w("debugcam");class U extends v{constructor(){super(...arguments);r(this,"orthographic",!1);r(this,"orthographicSize",5);r(this,"ARBackgroundAlpha",0);r(this,"_nearClipPlane",.1);r(this,"_farClipPlane",1e3);r(this,"_backgroundColor");r(this,"_fov",60);r(this,"_cam",null);r(this,"_clearFlags",2);r(this,"_skybox")}get fieldOfView(){return this._fov}set fieldOfView(t){const e=this._fov!=t;this._fov=t,e&&this._cam&&this._cam instanceof Ia&&(this._cam.fov=this._fov,this._cam.updateProjectionMatrix())}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(t){const e=this._nearClipPlane!=t;this._nearClipPlane=t,this._cam&&e&&(this._cam.near=t,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(t){const e=this._farClipPlane!=t;this._farClipPlane=t,this._cam&&e&&(this._cam.far=t,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(t){this._clearFlags=t,this.applyClearFlagsIfIsActiveCamera()}get backgroundColor(){var t;return(t=this._backgroundColor)!=null?t:null}set backgroundColor(t){if(!!t){if(this._backgroundColor)this._backgroundColor.copy(t);else{if(!t.clone)return;this._backgroundColor=t.clone()}this.applyClearFlagsIfIsActiveCamera()}}get cam(){return this.activeAndEnabled&&this.buildCamera(),this._cam}awake(){this.sourceId||console.warn("Camera has no source - the camera should be exported inside a gltf",this.name)}onEnable(){rc&&console.log(this),this.buildCamera(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this),this.applyClearFlagsIfIsActiveCamera()}buildCamera(){if(this._cam)return;const t=this.gameObject.isCamera;let e=null;if(t?e=this.gameObject:e=this.gameObject.children[0],e&&e.isCamera)e.type==="PerspectiveCamera"&&(e.fov=this._fov,e.near=this._nearClipPlane,e.far=this._farClipPlane,e.updateProjectionMatrix());else if(!this.orthographic)e=new Ia(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),e.fov=this.fieldOfView;else{const s=this.orthographicSize*100;e=new Af(window.innerWidth/-s,window.innerWidth/s,window.innerHeight/s,window.innerHeight/-s,this._nearClipPlane,this._farClipPlane)}this._cam=e,this.layer===0&&this._cam.layers.enableAll(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(){var t;if(this._cam&&this.context.mainCameraComponent===this)switch(this._clearFlags){case 1:if(this.context.isInXR&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}this.enableSkybox();break;case 2:if(this.backgroundColor){let e=this.backgroundColor.alpha;this.context.isInXR&&(e=(t=this.ARBackgroundAlpha)!=null?t:0),this.context.scene.background=null,this.context.renderer.setClearColor(this.backgroundColor,e)}break;case 4:this.context.scene.background=null,this.context.renderer.setClearColor(0,0);break}}enableSkybox(){this._skybox||(this._skybox=new oc(this)),this._skybox.enable()}}Xr(U,"Camera");he([g()],U.prototype,"fieldOfView",1);he([g()],U.prototype,"nearClipPlane",1);he([g()],U.prototype,"farClipPlane",1);he([g()],U.prototype,"clearFlags",1);he([g()],U.prototype,"orthographic",2);he([g()],U.prototype,"orthographicSize",2);he([g()],U.prototype,"ARBackgroundAlpha",2);he([g(Jt)],U.prototype,"backgroundColor",1);class oc{constructor(t){r(this,"_camera");r(this,"_skybox");this._camera=t}get context(){var t;return(t=this._camera)==null?void 0:t.context}enable(){this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),this._skybox?(rc&&console.log("Set skybox",this._camera),this._skybox.encoding=Ye,this._skybox.mapping=gr,this.context.scene.background=this._skybox):console.warn("Failed to load/find skybox texture",this)}}Xr(oc,"CameraSkybox");function ac(i){const t="created/implictly",e=new S;i.add(e);const s=p.addNewComponent(e,U,!1);s.sourceId=t;const n=p.addNewComponent(e,ii,!1);return n.sourceId=t,s}Xr(ac,"createCameraWithOrbitControl");var Fm=Object.defineProperty,Bm=(i,t)=>Fm(i,"name",{value:t,configurable:!0});async function Qr(i){}Bm(Qr,"post_awake");var Um=Object.defineProperty,lc=(i,t)=>Um(i,"name",{value:t,configurable:!0});class Nm{get isStateMachineBehaviour(){return!0}}lc(Nm,"StateMachineBehaviour");class Gs{constructor(t,e,s,n){r(this,"_name");r(this,"_nameHash");r(this,"_normalizedTime");r(this,"_length");r(this,"_speed");this._name=t.name,this._nameHash=t.hash,this._normalizedTime=e,this._length=s,this._speed=n}get name(){return this._name}get nameHash(){return this._nameHash}get normalizedTime(){return this._normalizedTime}get length(){return this._length}get speed(){return this._speed}}lc(Gs,"AnimatorStateInfo");var de;(function(i){i[i.If=1]="If",i[i.IfNot=2]="IfNot",i[i.Greater=3]="Greater",i[i.Less=4]="Less",i[i.Equals=6]="Equals",i[i.NotEqual=7]="NotEqual"})(de||(de={}));var Yr;(function(i){i[i.Float=1]="Float",i[i.Int=3]="Int",i[i.Bool=4]="Bool",i[i.Trigger=9]="Trigger"})(Yr||(Yr={}));var zm=Object.defineProperty,$m=(i,t)=>zm(i,"name",{value:t,configurable:!0});class cc{constructor(){r(this,"_types",{})}add(t,e){const s=this._types[t];s===void 0?this._types[t]=e:s!==e&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",t)}get(t){return this._types[t]}}$m(cc,"_TypeStore");const m=new cc,Mi=w("gizmos"),yt=w("debugextension");var Wm=Object.defineProperty,Ii=(i,t)=>Wm(i,"name",{value:t,configurable:!0});const Vs=w("debugresolvedependencies"),Hm=[{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function qs(i,t){Vs&&console.log(i,t);const e=[];Xs(Hm,i,t,e);const s=await Promise.all(e);return typeof t=="string"&&s.length===1?s[0]:s}Ii(qs,"resolveReferences");function Xs(i,t,e,s){if(typeof e=="object"&&e!==void 0&&e!==null)for(const n of Object.keys(e)){const o=e[n];if(typeof o=="string"){const a=Zr(t,o);if(a!==null)typeof a.then=="function"?s.push(a.then(l=>e[n]=l)):e[n]=a;else for(const l of i){const c=Qs(l.prefix,o);if(c>=0){Vs&&console.log(l,c,l.dependencyName),s.push(t==null?void 0:t.getDependency(l.dependencyName,c).then(h=>(e[n]=h,h)));break}}}else if(Array.isArray(o))for(let a=0;a<o.length;a++){const l=o[a],c=Zr(t,l);if(c!==null){typeof c.then=="function"?s.push(c.then(h=>o[a]=h)):o[a]=c;continue}for(const h of i){const d=Qs(h.prefix,l);if(d>=0){Vs&&console.log(h,d,h.dependencyName),s.push(t==null?void 0:t.getDependency(h.dependencyName,d).then(u=>o[a]=u));break}}typeof l=="object"&&Xs(i,t,l,s)}else typeof o=="object"&&Xs(i,t,o,s)}else typeof e=="string"&&hc(i,t,e,s)}Ii(Xs,"internalResolve");const Jr="extensions/";function Zr(i,t){if(i&&i.plugins&&typeof t=="string"&&t.startsWith(Jr)){let e=t.substring(Jr.length);const s=e.indexOf("/");s>=0&&(e=e.substring(0,s));const n=i.plugins[e];if(yt&&console.log(e,n),typeof(n==null?void 0:n.resolve)=="function"){const o=t.substring(Jr.length+e.length+1);return n.resolve(i,o)}}return null}Ii(Zr,"resolveExtension");function hc(i,t,e,s){for(const n of i){const o=Qs(n.prefix,e);if(o>=0)return Vs&&console.log(n,o,n.dependencyName),s.push(t==null?void 0:t.getDependency(n.dependencyName,o).then(a=>a)),!0}return!1}Ii(hc,"tryResolveDependency");function Qs(i,t){if(typeof t=="string"&&t.startsWith(i)){const e=t.substring(i.length),s=Number.parseInt(e);if(s>=0)return s}return-1}Ii(Qs,"tryGetIndex");var Gm=Object.defineProperty,dc=(i,t)=>Gm(i,"name",{value:t,configurable:!0});const Kr="NEEDLE_persistent_assets";function uc(i){return(i==null?void 0:i.___persistentAsset)===!0}dc(uc,"isPersistentAsset");class fc{constructor(t){r(this,"parser");this.parser=t}get name(){return Kr}async afterRoot(t){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)==null?void 0:o.extensions))return;const e=this.parser.json.extensions[Kr];if(!e)return;yt&&console.log(e);const s=new Array;for(const a of e==null?void 0:e.assets){const l=qs(this.parser,a);l&&s.push(l)}await Promise.all(s)}resolve(t,e){const s=Number.parseInt(e);if(s>=0){yt&&console.log(e);const n=t.json.extensions[Kr];if(n){const o=n==null?void 0:n.assets[s];return typeof o=="object"&&o&&(o.___persistentAsset=!0),o}}return null}}dc(fc,"NEEDLE_persistent_assets");var Vm=Object.defineProperty,ut=(i,t)=>Vm(i,"name",{value:t,configurable:!0});const Fe=w("debugserializer");class pc{constructor(){r(this,"typeMap",{})}register(t,e){if(this.typeMap[t]!==void 0){if(this.typeMap[t]===e)return;console.warn("Type "+t+" is already registered",e,this.typeMap[t])}Fe&&console.log("Register type serializer for "+t,e),this.typeMap[t]=e}getSerializer(t){if(!!t)return this.typeMap[t]}getSerializerForConstructor(t,e=0){var c,h,d,u;if(e>20)return;if(!t||!t.constructor){Fe&&console.log("invalid type");return}const s=(h=t.name)!=null?h:(c=t.constructor)==null?void 0:c.name;if(!s){Fe&&console.log("invalid name",s);return}const n=this.getSerializer(s);if(n!==void 0)return Fe&&console.log("FOUND "+s,t.name,t.constructor.name,n,this.typeMap),n;let o=Object.getPrototypeOf(t);if(!(o.prototype||o.constructor)){Fe&&console.warn("No prototype for "+s,t,t.name,t.prototype,t.constructor.name);return}const l=(d=o.prototype)!=null?d:o.constructor;if(l!==t){const _=this.getSerializerForConstructor(l,++e);if(_){Fe&&console.log("FOUND "+l.constructor.name,l.name,l,_);const b=(u=l.name)!=null?u:l.constructor.name;b==="Function"?console.error("Registering Function is not allowed, something went wrong",t,l,_):this.register(b,_)}return _}}}ut(pc,"SerializationHelper");const Ys=new pc;class si{constructor(t){if(Array.isArray(t))for(const e of t)Ys.register(e.name,this);else Ys.register(t.name,this)}}ut(si,"TypeSerializer");class to{constructor(t){r(this,"root");r(this,"gltf");r(this,"gltfId");r(this,"object");r(this,"target");r(this,"nodeId");r(this,"nodeToObject");r(this,"objectToNode");r(this,"context");r(this,"path");this.root=t}}ut(to,"SerializationContext");function mc(i,t){const e=i.$serializedTypes;if(e===void 0)return null;const s={};for(const n in e){let o=i[n];if(o!=null&&typeof o=="object"){const a=Ys.getSerializerForConstructor(o);if(a){s[n]=a.onSerialize(o,t);continue}}s[n]=o}return s.name=i.constructor.name,typeof i.guid=="string"&&(s.guid=i.guid),s}ut(mc,"serializeObject");const Js=[];function eo(i,t){if(!i)return t;typeof i.$serializedTypes=="object"&&(t||(t={}),Object.assign(t,i.$serializedTypes));const e=Object.getPrototypeOf(i);return eo(e,t)}ut(eo,"collectSerializedTypesInBaseTypes");function Zs(i,t,e){if(!i)return!1;if(e.target=i,i.onBeforeDeserialize!==void 0){const n=i.onBeforeDeserialize(t,e);if(typeof n=="boolean")return n}const s=eo(i);if(t){if(typeof t.guid=="string"&&(i.guid=t.guid),s)for(const n in s){const o=s[n],a=t[n];if(e.path=n,o===null)i[n]=a;else{let l=function(c){const d=c.type;return d?Ks(a,d,e,void 0,i[n]):Ks(a,c,e,void 0,i[n])};if(ut(l,"tryResolve"),i.onBeforeDeserializeMember!==void 0&&i.onBeforeDeserializeMember(n,a,e)===!0)continue;if(Array.isArray(o))for(let c=0;c<o.length;c++){const h=o[c],d=l(h);if(d!==void 0||c===o.length-1){i[n]=d;break}}else i[n]=l(o);Js.length=0,i.onAfterDeserializeMember!==void 0&&i.onAfterDeserializeMember(n,a,e)}}gc(i,t)}return i.onAfterDeserialize!==void 0&&i.onAfterDeserialize(t,e),e.path=void 0,!0}ut(Zs,"deserializeObject");function gc(i,t){for(const s of Object.keys(t)){const n=t[s];if(typeof n=="object"&&n!==null&&n!==void 0){const o=i[s];if(!o){Fe&&console.log(s,"is undefined on",i);continue}for(const a of Object.keys(n))o[a]===void 0&&e(n[a])&&!e(o)&&(o[a]=n[a])}}function e(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}ut(e,"isPrimitiveType")}ut(gc,"implictlyAssignPrimitiveTypes");function Ks(i,t,e,s,n){if(n instanceof t)return n;if(n&&typeof n=="object"&&uc(n)){const c=n;return!c.$serializedTypes&&t.prototype.$serializedTypes&&(c.$serializedTypes=t.prototype.$serializedTypes),c.$serializedTypes&&Zs(c,i,e),n}if(s||(s={serializer:Ys.getSerializerForConstructor(t)}),Array.isArray(i)){const c=[];for(let h=0;h<i.length;h++){const d=Ks(i[h],t,e,s,i[h]);c.push(d)}return c}const o=s.serializer;if(o)return o.onDeserialize(i,e);const a=new t(..._c(i)),l=a;return l.$serializedTypes&&Zs(l,i,e),a}ut(Ks,"deserializeObjectWithType");function _c(i){if(Js.length=0,typeof i=="object"&&i!==null&&i!==void 0)for(const t of Object.keys(i))Js.push(i[t]);return Js}ut(_c,"setBuffer");function io(i,t){if(t!=null&&i!=null)for(const e of Object.keys(t)){const s=bc(i,e);(!s||s.writable===!0||(s==null?void 0:s.set)!==void 0)&&(i[e]=t[e])}}ut(io,"assign");function bc(i,t){let e;do e=Object.getOwnPropertyDescriptor(i,t);while(!e&&(i=Object.getPrototypeOf(i)));return e}ut(bc,"getPropertyDescriptor");var qm=Object.defineProperty,Xm=(i,t)=>qm(i,"name",{value:t,configurable:!0});const Be=w("debuganimatorcontroller");class ni{constructor(t){r(this,"normalizedStartOffset",0);r(this,"_speed",1);r(this,"animator");r(this,"model");r(this,"_mixer");r(this,"_activeState");r(this,"_activeStates",[]);r(this,"animationRoot",null);r(this,"lastPosition");r(this,"lastRotation");r(this,"startPosition",null);r(this,"startRotation",null);r(this,"lastTime",0);r(this,"tempRot",new P);r(this,"tempRot2",new P);r(this,"tempPos",new y);r(this,"tempPos2",new y);r(this,"rootMotionBone",new S);this.model=t,Be&&console.log(this)}Play(t,e=-1,s=Number.NEGATIVE_INFINITY,n=0){if(e<0)e=0;else if(e>=this.model.layers.length){console.warn("invalid layer");return}const a=this.model.layers[e].stateMachine;for(const l of a.states)if(l.name===t||l.hash===t){Be&&console.log("transition to ",l),this.transitionTo(l,n,s);return}console.warn("Could not find "+t+" to play")}Reset(){this.setStartTransition()}SetBool(t,e){var n;const s=typeof t=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===t).forEach(o=>o.value=e)}GetBool(t){var s,n,o;const e=typeof t=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[e]===t))==null?void 0:n.value)!=null?o:!1}SetFloat(t,e){var n;const s=typeof t=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===t).forEach(o=>o.value=e)}GetFloat(t){var s,n,o;const e=typeof t=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[e]===t))==null?void 0:n.value)!=null?o:0}SetInteger(t,e){var n;const s=typeof t=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===t).forEach(o=>o.value=e)}GetInteger(t){var s,n,o;const e=typeof t=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[e]===t))==null?void 0:n.value)!=null?o:0}SetTrigger(t){var s;Be&&console.log("SET TRIGGER",t);const e=typeof t=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[e]===t).forEach(n=>n.value=!0)}ResetTrigger(t){var s;const e=typeof t=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[e]===t).forEach(n=>n.value=!1)}IsInTransition(){return this._activeStates.length>1}SetSpeed(t){this._speed=t}FindState(t){if(!t)return null;for(const e of this.model.layers)for(const s of e.stateMachine.states)if(s.name===t)return s;return null}get context(){var t;return(t=this.animator)==null?void 0:t.context}applyRootMotion(t){this.internalApplyRootMotion(t)}bind(t){this.animator=t,this._mixer=new _r(this.animator.gameObject),this.createActions()}clone(){const t=Cs(this.model,(s,n,o)=>{var a;return o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||((a=o==null?void 0:o.constructor)==null?void 0:a.name)==="AnimationAction"||o.tracks!==void 0)});return console.assert(t!==this.model),new ni(t)}update(){if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates();const t=this.animator.context.time.deltaTime;this._mixer.update(t)}updateActiveStates(){for(let t=0;t<this._activeStates.length;t++){const e=this._activeStates[t],s=e.motion;if(!s.action)this._activeStates.splice(t,1),t--;else{const n=s.action;n.getEffectiveWeight()<=0&&!n.isRunning()&&(Be&&console.debug("REMOVE",e.name,n.getEffectiveWeight(),n.isRunning(),n.isScheduled()),this._activeStates.splice(t,1),t--)}}}setStartTransition(){for(const t of this.model.layers){const e=t.stateMachine,s=e.states[e.defaultState];this.transitionTo(s,0,this.normalizedStartOffset)}}evaluateTransitions(){var o;let t=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;t=!0}const e=this._activeState,s=e.motion.action;for(const a of e.transitions){if(!a.hasExitTime&&a.conditions.length<=0)continue;let l=!0;for(const c of a.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(!!l){Be&&l&&console.log("All conditions are met",a.conditions);for(const c of a.conditions){const h=this.model.parameters.find(d=>d.name===c.parameter);(h==null?void 0:h.type)===Yr.Trigger&&(h.value=!1)}if(s){const c=e.motion.clip.duration,h=c<=0?1:s.time/c;if(!a.hasExitTime||h>=a.exitTime&&s.time>=s.getClip().duration){s.clampWhenFinished=!0,Be&&(console.log("transition to "+a.destinationState,a),console.log(s.time,a.exitTime)),this.transitionTo(a.destinationState,a.duration,a.offset);return}}}}let n=!1;if(e.motion.isLooping&&s&&s.time>=s.getClip().duration&&(n=!0,s.reset(),s.time=0,s.play()),!n&&e&&!t&&s&&this.animator&&e.behaviours){const a=s==null?void 0:s.getClip().duration,l=s.time/a,c=new Gs(this._activeState,l,a,this._speed);for(const h of e.behaviours)h.instance&&((o=h.instance.onStateUpdate)==null||o.call(h,this.animator,c,0))}}transitionTo(t,e,s){var h,d,u,_,b,x,O,R;if(!this.animator)return;const n=0;if(typeof t=="number"&&(t==-1&&(t=this.model.layers[n].stateMachine.defaultState),t=this.model.layers[n].stateMachine.states[t]),!(t==null?void 0:t.motion)||!t.motion.clip)return;const o=this._activeState===t;if(o){const M=t.motion;!M.action_loopback&&M.clip&&(this._mixer.uncacheAction(M.clip,this.animator.gameObject),M.action_loopback=this._mixer.clipAction(M.clip))}if(((h=this._activeState)==null?void 0:h.behaviours)&&this._activeState.motion.action){const M=(d=this._activeState)==null?void 0:d.motion.clip.duration,lt=this._activeState.motion.action.time/M,F=new Gs(this._activeState,lt,M,this._speed);for(const T of this._activeState.behaviours)(_=(u=T.instance)==null?void 0:u.onStateExit)==null||_.call(T,this.animator,F,n)}const a=(b=this._activeState)==null?void 0:b.motion.action;a&&a.fadeOut(e),o&&(t.motion.action=t.motion.action_loopback,t.motion.action_loopback=a);const l=this._activeState;this._activeState=t;const c=(x=t.motion)==null?void 0:x.action;if(c){s=Math.max(0,Math.min(1,s)),c.isRunning()&&c.stop(),c.reset(),c.timeScale=this._speed,c.enabled=!0;const M=t.motion.clip.duration;if(c.time=s*M,c.clampWhenFinished=!0,c.setLoop(ja,0),e>0?c.fadeIn(e):c.setEffectiveWeight(1),c.play(),this._activeStates.includes(t)||this._activeStates.push(t),this._activeState.behaviours){const lt=new Gs(t,s,M,this._speed);for(const F of this._activeState.behaviours)(R=(O=F.instance)==null?void 0:O.onStateEnter)==null||R.call(F,this.animator,lt,n)}}else console.warn("No action",t.motion,this);Be&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+t.name,a,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}evaluateCondition(t){const e=this.model.parameters.find(s=>s.name===t.parameter);if(!e)return!1;switch(t.mode){case de.If:return e.value===!0;case de.IfNot:return e.value===!1;case de.Greater:return e.value>t.threshold;case de.Less:return e.value<t.threshold;case de.Equals:return e.value===t.threshold;case de.NotEqual:return e.value!==t.threshold}return!1}createActions(){var t,e;for(const s of this.model.layers){const n=s.stateMachine;for(let o=0;o<n.states.length;o++){const a=n.states[o];if(!!a.motion){if(this.animator&&a.motion.clips){const l=(t=a.motion.clips)==null?void 0:t.find(c=>{var h,d;return c.node.name===((d=(h=this.animator)==null?void 0:h.gameObject)==null?void 0:d.name)});a.motion.clip=l==null?void 0:l.clip}if((e=a.motion)==null?void 0:e.clip){const l=this._mixer.clipAction(a.motion.clip);a.motion.action=l}if(a.behaviours&&Array.isArray(a.behaviours))for(const l of a.behaviours){if(!(l==null?void 0:l.typeName))continue;const c=m.get(l.typeName),h=new c;h.isStateMachineBehaviour&&(io(h,l.properties),l.instance=h)}}}}}*enumerateActions(){for(const t of this.model.layers){const e=t.stateMachine;for(let s=0;s<e.states.length;s++){const n=e.states[s];(n==null?void 0:n.motion)&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}internalApplyRootMotion(t){if(!this.animationRoot)if(this.animationRoot=this.findRootBone(t),!this.animationRoot&&t.children.length>0&&(this.animationRoot=t.children[0]),this.animationRoot){console.log(this.animationRoot),this.startPosition=this.animationRoot.position.clone(),this.lastPosition=this.startPosition.clone(),this.startRotation=this.animationRoot.quaternion.clone(),this.lastRotation=this.startRotation.clone(),this.animationRoot.add(new Oi);const n=this.animationRoot.parent;this.rootMotionBone.position.copy(this.animationRoot.position),this.rootMotionBone.add(this.animationRoot),n==null||n.add(this.rootMotionBone),this.rootMotionBone.add(new Oi)}else return;const e=this.animationRoot.quaternion,s=this.tempPos.copy(this.animationRoot.position);t=this.rootMotionBone;for(const n of this._activeStates){const o=n.motion.action;if(!o)continue;if(o.time<this.lastTime){this.lastTime=o.time,this.lastPosition.copy(this.animationRoot.position),this.lastRotation.copy(this.animationRoot.quaternion);break}this.lastTime=o.time;const a=this.tempRot2.multiplyQuaternions(this.tempRot.copy(e),this.lastRotation.invert()),l=this.tempPos2.copy(s).sub(this.lastPosition);l.applyQuaternion(t.quaternion),l.multiplyScalar(o.getEffectiveWeight()),t.position.add(l),t.quaternion.multiplyQuaternions(t.quaternion,a);break}this.lastPosition.copy(s),this.lastRotation.copy(e),this.animationRoot.position.set(0,0,0),this.animationRoot.quaternion.identity()}findRootBone(t){if(this.animationRoot)return this.animationRoot;if(t.type==="Bone")return this.animationRoot=t,this.animationRoot;if(t.children)for(const e of t.children){const s=this.findRootBone(e);if(s)return s}return null}}Xm(ni,"AnimatorController");var yc=Object.defineProperty,Qm=Object.getOwnPropertyDescriptor,Ym=(i,t)=>yc(i,"name",{value:t,configurable:!0}),tn=(i,t,e,s)=>{for(var n=s>1?void 0:s?Qm(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&yc(t,e,n),n};const Jm=w("debuganimator");class ue extends v{constructor(){super(...arguments);r(this,"applyRootMotion",!1);r(this,"hasRootMotion",!1);r(this,"keepAnimatorControllerStateOnDisable",!1);r(this,"speed",1);r(this,"normalizedStartOffset",0);r(this,"_animatorController",null)}set runtimeAnimatorController(t){this._animatorController&&this._animatorController.model===t||(t?t instanceof ni?this._animatorController=t:this._animatorController=new ni(t):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}Play(t,e=-1,s=Number.NEGATIVE_INFINITY,n=0){var o;(o=this.runtimeAnimatorController)==null||o.Play(t,e,s,n)}Reset(){var t;(t=this._animatorController)==null||t.Reset()}SetBool(t,e){var s;(s=this.runtimeAnimatorController)==null||s.SetBool(t,e)}GetBool(t){var e,s;return(s=(e=this.runtimeAnimatorController)==null?void 0:e.GetBool(t))!=null?s:!1}SetFloat(t,e){var s;(s=this.runtimeAnimatorController)==null||s.SetFloat(t,e)}GetFloat(t){var e,s;return(s=(e=this.runtimeAnimatorController)==null?void 0:e.GetFloat(t))!=null?s:-1}SetInteger(t,e){var s;(s=this.runtimeAnimatorController)==null||s.SetInteger(t,e)}GetInteger(t){var e,s;return(s=(e=this.runtimeAnimatorController)==null?void 0:e.GetInteger(t))!=null?s:-1}SetTrigger(t){var e;(e=this.runtimeAnimatorController)==null||e.SetTrigger(t)}ResetTrigger(t){var e;(e=this.runtimeAnimatorController)==null||e.ResetTrigger(t)}IsInTransition(){var t,e;return(e=(t=this.runtimeAnimatorController)==null?void 0:t.IsInTransition())!=null?e:!1}SetSpeed(t){var e;t!==this.speed&&(this.speed=t,(e=this._animatorController)==null||e.SetSpeed(t))}set minMaxSpeed(t){this.speed=k.lerp(t.x,t.y,Math.random())}set minMaxOffsetNormalized(t){this.normalizedStartOffset=k.lerp(t.x,t.y,Math.random()),this.runtimeAnimatorController&&(this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset)}awake(){if(!!this.gameObject){if(this.runtimeAnimatorController){const t=this.runtimeAnimatorController.clone();console.assert(this.runtimeAnimatorController!==t),this.runtimeAnimatorController=t,console.assert(this.runtimeAnimatorController===t),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.SetSpeed(this.speed),this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset}Jm&&console.log(this.name,this)}}onDisable(){var t;this.keepAnimatorControllerStateOnDisable||(t=this._animatorController)==null||t.Reset()}onBeforeRender(){var t;this._animatorController&&(this._animatorController.update(),this.applyRootMotion&&((t=this._animatorController)==null||t.applyRootMotion(this.gameObject)))}}Ym(ue,"Animator");tn([g()],ue.prototype,"applyRootMotion",2);tn([g()],ue.prototype,"hasRootMotion",2);tn([g()],ue.prototype,"keepAnimatorControllerStateOnDisable",2);tn([g()],ue.prototype,"runtimeAnimatorController",1);var vc=Object.defineProperty,Zm=Object.getOwnPropertyDescriptor,wc=(i,t)=>vc(i,"name",{value:t,configurable:!0}),xc=(i,t,e,s)=>{for(var n=s>1?void 0:s?Zm(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&vc(t,e,n),n};class Ue extends v{constructor(){super(...arguments);r(this,"playAutomatically",!0);r(this,"randomStartTime",!0);r(this,"_tempAnimationClipBeforeGameObjectExisted",null);r(this,"mixer");r(this,"_actions",[]);r(this,"_currentActions",[]);r(this,"_handles",[]);r(this,"_didInit",!1)}get clip(){var t;return((t=this.animations)==null?void 0:t.length)?this.animations[0]:null}set clip(t){if(!this.gameObject){this._tempAnimationClipBeforeGameObjectExisted=t;return}!t||(this.gameObject.animations||(this.gameObject.animations=[]),this.gameObject.animations.push(t))}set animations(t){this.gameObject.animations=t}get animations(){return this.gameObject.animations}get currentAction(){return this._currentActions[0]}get currentActions(){return this._currentActions}get actions(){return this._actions}set actions(t){this._actions=t}awake(){this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.playAutomatically&&this.init()}onEnable(){if(this.playAutomatically&&this.actions.length>0&&this.currentActions.length<=0){const t=Math.floor(Math.random()*this.actions.length);this.play(t)}}start(){this.randomStartTime&&this.currentAction&&(this.currentAction.time=Math.random()*this.currentAction.getClip().duration)}update(){var t;if(!!this.mixer){this.mixer.update(this.context.time.deltaTime);for(const e of this._handles)e._update();((t=this._handles)==null?void 0:t.length)>0&&ht.markDirty(this.gameObject)}}getAction(t){var e;return(e=this.actions)==null?void 0:e.find(s=>s.getClip().name===t)}play(t,e){if(this.init(),!this.mixer)return;let s=t;if(typeof t=="number"){if(t>=this.animations.length)return;s=this.animations[t]}else typeof t=="string"&&(s=this.animations.find(o=>o.name===t));if(!s){console.error("Could not find clip",t);return}for(const o of this.actions)if(o.getClip()===s)return this.internalOnPlay(o,e);const n=this.mixer.clipAction(s);return this.actions.push(n),this.internalOnPlay(n,e)}internalOnPlay(t,e){var a;var s=this.currentAction;if(s===t&&s.isRunning()&&s.time<s.getClip().duration){const l=this.tryFindHandle(t);if(l)return l.getPromise()}const n=(a=e==null?void 0:e.exclusive)!=null?a:!0;(e==null?void 0:e.fadeDuration)?(n&&(s==null||s.fadeOut(e.fadeDuration)),t.fadeIn(e.fadeDuration)):n&&(s==null||s.stop()),t.reset(),t.enabled=!0,t.time=0,t.timeScale=1,(e==null?void 0:e.clampWhenFinished)&&(t.clampWhenFinished=!0),(e==null?void 0:e.startTime)!==void 0&&(t.time=e.startTime),(e==null?void 0:e.loop)!==void 0&&(t.loop=e.loop?kf:ja),t.play();const o=new Pc(t,this.mixer,e,l=>{this._handles.splice(this._handles.indexOf(o),1)});return this._handles.push(o),o.getPromise()}tryFindHandle(t){for(const e of this._handles)if(e.action===t)return e}init(){if(!this._didInit&&(this._didInit=!0,!!this.gameObject)){this.actions=[],this.mixer=new _r(this.gameObject);for(let t=0;t<this.animations.length;t++){const e=this.mixer.clipAction(this.animations[t]);this.actions.push(e)}}}}wc(Ue,"Animation");xc([g()],Ue.prototype,"playAutomatically",2);xc([g()],Ue.prototype,"randomStartTime",2);class Pc{constructor(t,e,s,n){r(this,"mixer");r(this,"action");r(this,"promise",null);r(this,"resolve",null);r(this,"reject",null);r(this,"_options");r(this,"_resolveCallback",null);r(this,"_rejectCallback",null);r(this,"_loopCallback");r(this,"_finishedCallback");r(this,"_resolvedOrRejectedCallback");this.action=t,this.mixer=e,this._resolvedOrRejectedCallback=n,this._options=s}getPromise(){return this.promise?this.promise:(this.promise=new Promise((t,e)=>{this._resolveCallback=t,this._rejectCallback=e,this.resolve=this.onResolve.bind(this),this.reject=this.onReject.bind(this)}),this._loopCallback=this.onLoop.bind(this),this._finishedCallback=this.onFinished.bind(this),this.mixer.addEventListener("loop",this._loopCallback),this.mixer.addEventListener("finished",this._finishedCallback),this.promise)}_update(){var t;!this._options||this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=(t=this._options.startTime)!=null?t:0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var t,e;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(e=this._resolveCallback)==null||e.call(this,this.action)}onReject(t){var e,s;this.dispose(),(e=this._resolvedOrRejectedCallback)==null||e.call(this,this),(s=this._rejectCallback)==null||s.call(this,t)}onLoop(t){}onFinished(t){t.action===this.action&&this.onResolve()}dispose(){this._loopCallback&&this.mixer.removeEventListener("loop",this._loopCallback),this._finishedCallback&&this.mixer.removeEventListener("finished",this._finishedCallback),this._loopCallback=void 0,this._finishedCallback=void 0}}wc(Pc,"AnimationHandle");var Km=Object.defineProperty,tg=(i,t)=>Km(i,"name",{value:t,configurable:!0});class Oc extends v{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"width",0);r(this,"centered",!0);r(this,"_centerPos")}awake(){this._centerPos=new y}update(){if(!this.from||!this.to)return;const t=C(this.from).clone(),e=C(this.to).clone(),s=t.distanceTo(e);this._centerPos.copy(t),this._centerPos.add(e),this._centerPos.multiplyScalar(.5),D(this.gameObject,this.centered?this._centerPos:t),this.gameObject.lookAt(C(this.to).clone()),this.gameObject.scale.set(this.width,this.width,s)}}tg(Oc,"AlignmentConstraint");var Cc=Object.defineProperty,eg=Object.getOwnPropertyDescriptor,Sc=(i,t)=>Cc(i,"name",{value:t,configurable:!0}),fe=(i,t,e,s)=>{for(var n=s>1?void 0:s?eg(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Cc(t,e,n),n};class Zt{constructor(){r(this,"time");r(this,"value");r(this,"inTangent");r(this,"inWeight");r(this,"outTangent");r(this,"outWeight");r(this,"weightedMode")}}Sc(Zt,"Keyframe");fe([g()],Zt.prototype,"time",2);fe([g()],Zt.prototype,"value",2);fe([g()],Zt.prototype,"inTangent",2);fe([g()],Zt.prototype,"inWeight",2);fe([g()],Zt.prototype,"outTangent",2);fe([g()],Zt.prototype,"outWeight",2);fe([g()],Zt.prototype,"weightedMode",2);class so{constructor(){r(this,"keys")}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(t){if(!this.keys||this.keys.length==0)return 0;let e=null;for(const s of this.keys){if(e&&s.time>t&&t>e.time)return k.lerp(e.value,s.value,(t-e.time)/(s.time-e.time));e=s}return this.keys[this.keys.length-1].value}}Sc(so,"AnimationCurve");fe([g(Zt)],so.prototype,"keys",2);var Rc=Object.defineProperty,ig=Object.getOwnPropertyDescriptor,Ec=(i,t)=>Rc(i,"name",{value:t,configurable:!0}),pe=(i,t,e,s)=>{for(var n=s>1?void 0:s?ig(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Rc(t,e,n),n};const Mt=w("debugaudio");var Ac;(function(i){i[i.Logarithmic=0]="Logarithmic",i[i.Linear=1]="Linear",i[i.Custom=2]="Custom"})(Ac||(Ac={}));var gs;const st=(gs=class extends v{constructor(){super(...arguments);r(this,"clip","");r(this,"playOnAwake",!1);r(this,"spatialBlend",0);r(this,"minDistance",1);r(this,"maxDistance",100);r(this,"volume",1);r(this,"rollOffMode",0);r(this,"_loop",!1);r(this,"sound",null);r(this,"helper",null);r(this,"wasPlaying",!1);r(this,"audioLoader",null);r(this,"shouldPlay",!1);r(this,"_lastClipStartedLoading",null);r(this,"lerp",(i,t,e)=>i*(1-e)+t*e);r(this,"_lastContextTime",0);r(this,"_hasEnded",!0)}static get userInteractionRegistered(){return st._didCallBeginWaitForUserInteraction||(st._didCallBeginWaitForUserInteraction=!0,st._beginWaitForUserInteraction()),st._userInteractionRegistered}static registerWaitForAllowAudio(i){if(i!==null){if(this._userInteractionRegistered){i();return}this.callbacks.indexOf(i)===-1&&this.callbacks.push(i),st._didCallBeginWaitForUserInteraction||(st._didCallBeginWaitForUserInteraction=!0,st._beginWaitForUserInteraction())}}static _beginWaitForUserInteraction(i=null){i!==null&&this.registerWaitForAllowAudio(i);let e=Ec(()=>{if(e!=null&&!st._userInteractionRegistered){st._userInteractionRegistered=!0,console.log("registered interaction, can play audio now"),document.removeEventListener("pointerdown",e),document.removeEventListener("click",e),document.removeEventListener("dragstart",e),document.removeEventListener("touchstart",e);for(const s of this.callbacks)s();this.callbacks.length=0}},"callback").bind(this);document.addEventListener("pointerdown",e),document.addEventListener("click",e),document.addEventListener("dragstart",e),document.addEventListener("touchstart",e)}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(i){this._loop=i,this.sound&&this.sound.setLoop(i)}get Sound(){var i;if(!this.sound&&st._userInteractionRegistered){const t=(i=p.getComponent(this.context.mainCamera,ji))!=null?i:p.findObjectOfType(ji,this.context);(t==null?void 0:t.listener)&&(this.sound=new Tf(t.listener),this.gameObject.add(this.sound))}return this.sound}get ShouldPlay(){return this.shouldPlay}awake(){this.audioLoader=new br,this.playOnAwake&&(this.shouldPlay=!0),window.addEventListener("visibilitychange",i=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this.isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}})}onEnable(){st._beginWaitForUserInteraction(()=>{this.enabled&&!this.destroyed&&this.loadAndPlay(this.clip)})}onLoaded(i){Mt&&console.log("audio buffer loaded"),st.registerWaitForAllowAudio(()=>{Mt&&console.log("finished loading",i);const t=this.Sound;if(!t){console.warn("Failed getting sound",this.name);return}t.isPlaying&&t.stop(),t.setBuffer(i),t.loop=this.loop,t.setVolume(this.volume),t.autoplay=this.shouldPlay;const e=this.lerp(1e3,this.minDistance,this.spatialBlend);switch(Mt&&console.log("Ref distance= "+e),t.setRefDistance(e),t.setMaxDistance(this.maxDistance),this.rollOffMode){case 0:t.setDistanceModel("linear");break;case 1:t.setDistanceModel("exponential");break}t.isPlaying&&t.stop(),this.spatialBlend>0&&Mt&&!this.helper&&(console.log(this),this.helper=new Lf(t,t.getRefDistance()),t.add(this.helper)),this.shouldPlay&&st._userInteractionRegistered&&this.play()})}loadAndPlay(i){if(this.clip=i,this.clip&&(Mt&&console.log(this.clip),this.clip.endsWith(".mp3")||this.clip.endsWith(".wav"))){if(this.audioLoader||(this.audioLoader=new br),this.shouldPlay=!0,this._lastClipStartedLoading===this.clip)return;this._lastClipStartedLoading=this.clip,Mt&&console.log("load audio",this.clip),this.audioLoader.load(this.clip,this.onLoaded.bind(this),()=>{},console.error)}}play(i=void 0){if(i&&i!==this.clip){this.loadAndPlay(i);return}this.shouldPlay=!0,this._hasEnded=!1,Mt&&console.log("play",this),this.sound&&!this.sound.isPlaying&&(Mt&&console.log("start playing",this.sound.getVolume(),this.sound),this.sound.play())}pause(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,this.sound.pause())}stop(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,Mt&&console.log(this._lastContextTime),this.sound.stop())}get isPlaying(){var i,t;return(t=(i=this.sound)==null?void 0:i.isPlaying)!=null?t:!1}set isPlaying(i){}get time(){var i,t;return((i=this.sound)==null?void 0:i.source)?((t=this.sound.source)==null?void 0:t.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(i){if(this.sound){if(i===this.sound.offset)return;const t=this.isPlaying;this.stop(),this.sound.offset=i,t&&this.play()}}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,Mt&&console.log("Audio clip ended",this.clip),this.sound.dispatchEvent({type:"ended",target:this}))}},r(gs,"_didCallBeginWaitForUserInteraction",!1),r(gs,"callbacks",[]),r(gs,"_userInteractionRegistered",!1),gs);let nt=st;Ec(nt,"AudioSource");pe([g()],nt.prototype,"clip",2);pe([g()],nt.prototype,"playOnAwake",2);pe([g()],nt.prototype,"loop",1);pe([g()],nt.prototype,"spatialBlend",2);pe([g()],nt.prototype,"minDistance",2);pe([g()],nt.prototype,"maxDistance",2);pe([g()],nt.prototype,"volume",2);pe([g()],nt.prototype,"rollOffMode",2);var sg=Object.defineProperty,ng=(i,t)=>sg(i,"name",{value:t,configurable:!0});class ji extends v{constructor(){super(...arguments);r(this,"_listener",null)}get listener(){return this._listener==null&&(this._listener=new Fa),this._listener}awake(){nt.registerWaitForAllowAudio(()=>{const t=this.listener;if(t==null||t.parent)return;const e=p.getComponentInParent(this.gameObject,U);e?e.cam.add(t):this.gameObject.add(t)})}}ng(ji,"AudioListener");var rg=Object.defineProperty,og=(i,t)=>rg(i,"name",{value:t,configurable:!0});let Fi,Bi;function en(i,t){Fi||(Fi=new Df,Fi.setDecoderPath("./include/draco/"),Fi.setDecoderConfig({type:"js"})),Bi||(Bi=new Mf,Bi.setTranscoderPath("./include/ktx2/"),t.renderer&&Bi.detectSupport(t.renderer)),i.setDRACOLoader(Fi),i.setKTX2Loader(Bi)}og(en,"addDracoAndKTX2Loaders");var ag=Object.defineProperty,Ui=(i,t)=>ag(i,"name",{value:t,configurable:!0});class no{constructor(t,e,s,n){r(this,"success");r(this,"filename");r(this,"hash");r(this,"size");r(this,"url");this.success=t,this.filename=e,this.hash=s,this.size=n}}Ui(no,"Upload_Result");async function kc(i,t){const e=await i.arrayBuffer(),s=ro(e),n=i.name.split(".").pop(),o=s+"."+n,a=i.name.split(".").shift();console.assert(a!==void 0);const l={alias:a,filename:o},h=await(await fetch(t+"/exists",{method:"POST",body:JSON.stringify(l)})).json();if(h.success||console.warn("exists check did fail"),h.exists)return console.log("file already exists",s),new no(!0,o,s,i.size);console.log("begin uploading file",a,i.size);const d=new FormData;d.append("file",i);const u={};u.filesize=i.size,a&&(u.alias=a);const b=await(await fetch(t+"/upload/file",{method:"POST",body:d,headers:u})).json();if((b==null?void 0:b.success)===!1)return b.message!==void 0?console.error("Upload failed:",b.message):console.error("Upload failed"),null;console.assert(b.hash_sum===s,"hash sum did not match","received:",b.hash_sum,"expected:",s),b.success&&console.log("successfully uploaded",s,b.id);const x=new no(b.success,o,s,i.size);return x.url=t,x}Ui(kc,"upload_file");function ro(i){return If(new Uint8Array(i))}Ui(ro,"hash");async function oo(i,t,e,s,n=!1){try{const o=await fetch(s+"/download/file",{method:"POST",body:i});if(o.status!==200)return console.error("download failed",o),null;const a=await o.blob(),l=await a.arrayBuffer();n||console.assert(a.size===e,"size mismatch","expected:",e,"got:",a.size);const c=ro(l);return n||console.assert(c===t,"hash mismatch, downloaded file is invalid"),a.arrayBuffer()}catch(o){console.error(o)}return null}Ui(oo,"download_file");async function Tc(i,t){var d;const e=await fetch(i),s=(d=e.body)==null?void 0:d.getReader(),n=e.headers.get("Content-Length"),o=n?parseInt(n):0;if(!s)return null;let a=0,l=[];for(;;){const{done:u,value:_}=await s.read();if(_&&(l.push(_),a+=_.length,t.call(null,new ProgressEvent("progress",{loaded:a,total:o}))),u)break}const c=new Uint8Array(a);let h=0;for(let u of l)c.set(u,h),h+=u.length;return c}Ui(Tc,"download");var lg=Object.defineProperty,ao=(i,t)=>lg(i,"name",{value:t,configurable:!0});const Ni=w("debugavatar");class lo{constructor(t,e,s,n){r(this,"root");r(this,"head");r(this,"leftHand");r(this,"rigthHand");var o;this.root=t,this.head=e,this.leftHand=s,this.rigthHand=n,(o=this.root)==null||o.traverse(a=>a.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}assignRandomColors(){sn.assignRandomPlayerColors(this)}}ao(lo,"AvatarModel");class sn{constructor(){r(this,"avatarRegistryUrl",null);r(this,"avatarModelCache",new Map)}async getOrCreateNewAvatarInstance(t,e){if(!e)return console.error("Can not create avatar: failed to provide id or root object"),null;let s=null;if(typeof e=="string"){if(s=await this.loadAvatar(t,e),!s){const o=new Ct;s=p.instantiate(Le(e,t.scene),o)}}else s=e;if(!s)return null;const n=this.findAvatar(s);return n.assignRandomColors(),n.isValid?(Ni&&console.log("[Custom Avatar] valid config",e,Ni?n:""),n):(console.warn("[Custom Avatar] config isn't valid",e,Ni?n:""),null)}async loadAvatar(t,e){var n;if(console.assert(e!=null&&typeof e=="string","Avatar id must not be null"),e.length<=0||!e)return null;if(Ni&&console.log("[Custom Avatar] "+e+", loading..."),e.endsWith(".glb")||(e+=".glb"),this.avatarRegistryUrl===null){const o=await fetch("./"+e);let a=null;if(o.ok){const c=await o.blob();c&&(a=await c.arrayBuffer())}if(!a&&(a=await oo(e,e,0,"no url here go away",!0),!a))return null;const l=await ps(t,a,null,0);return(n=l==null?void 0:l.scene)!=null?n:null}const s=new yr;return en(s,t),new Promise((o,a)=>{const l=this.avatarRegistryUrl+"/"+e;s.load(l,async c=>{await la(t,l,c),o(c.scene)},c=>{Ni&&console.log("[Custom Avatar] "+c.loaded/c.total*100+"% loaded of "+c.total/1024+"kB")},c=>{console.error("[Custom Avatar] Error when loading: "+c),o(null)})})}cacheModel(t,e){}findAvatar(t){const e=t;let s=e;s.children.length==1&&(s=t.children[0]);let n=this.findAvatarPart(s,"head");const o=this.findAvatarPart(s,"left"),a=this.findAvatarPart(s,"right");if(!n){n=e;let c=new y;new Qe().setFromObject(n).getSize(c);let h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&n.scale.multiplyScalar(1/h*.3)}return new lo(e,n,o,a)}findAvatarPart(t,e){for(let s of t.children)if(s.name.toLowerCase().indexOf(e)>-1)return s;return null}handleCustomAvatarErrors(t){if(!t.ok)throw Error(t.statusText);return t}static assignRandomPlayerColors(t){const e=new Map;function s(n){if(n.type==="Mesh"){const o=n,a=o.material;if(a&&a.name){if(e.has(a.uuid)){const l=e.get(a.uuid);l&&(o.material=l);return}if(a.name.endsWith("_playercolor")||a.name.endsWith("_player_color2")){const l=a.uuid;o.material=a.clone(),o.material.color=new f(Math.random(),Math.random(),Math.random()),e.set(l,o.material)}}}}ao(s,"findPlayerColorMeshesAndAssignColors"),t.head&&t.head.traverse(s),t.leftHand&&t.leftHand.traverse(s),t.rigthHand&&t.rigthHand.traverse(s)}}ao(sn,"AvatarLoader");var Lc=Object.defineProperty,cg=Object.getOwnPropertyDescriptor,hg=(i,t)=>Lc(i,"name",{value:t,configurable:!0}),co=(i,t,e,s)=>{for(var n=s>1?void 0:s?cg(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Lc(t,e,n),n};class zi extends v{constructor(){super(...arguments);r(this,"length",1);r(this,"depthTest",!0);r(this,"isGizmo",!0);r(this,"_axes",null)}onEnable(){if(this.isGizmo&&!Mi)return;this._axes||(this._axes=new Oi(this.length)),this.gameObject.add(this._axes);const t=this._axes.material;t&&t.depthTest!==void 0&&(t.depthTest=this.depthTest)}onDisable(){!this._axes||this.gameObject.remove(this._axes)}}hg(zi,"AxesHelper");co([g()],zi.prototype,"length",2);co([g()],zi.prototype,"depthTest",2);co([g()],zi.prototype,"isGizmo",2);var dg=Object.defineProperty,ug=(i,t)=>dg(i,"name",{value:t,configurable:!0});class Dc extends v{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"hint");r(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;let t=C(this.to).clone(),e=C(this.from).clone(),s=t.distanceTo(e),n=t.clone();n.sub(e);let o=e.clone();o.add(t),o.multiplyScalar(.5);let a=C(this.hint).clone();a.sub(o);let l=new y;l.crossVectors(a,n),l.crossVectors(n,l),l.normalize();let c=s*.5,h=Math.max(this.desiredDistance,c),d=Math.sqrt(h*h-c*c),u=l.clone();u.multiplyScalar(d),u.add(o),D(this.gameObject,u);let _=o.clone();_.sub(l),this.gameObject.lookAt(_)}}ug(Dc,"BasicIKConstraint");var fg=Object.defineProperty,pg=(i,t)=>fg(i,"name",{value:t,configurable:!0});const vi=class extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=C(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const t=new $r;t.drag=this.drag,t.angularDrag=this.angularDrag,t.mass=this.mass,t.kinematic=this.isKinematic,t.physicsEvents=this.detectCollision,t.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,t),this.parent=this.gameObject.parent}wakeUp(){var t;(t=this.body)==null||t.wakeUp()}applyForce(t,e){var s;(s=this.body)==null||s.applyForce(new ke(t.x,t.y,t.z),e?new ke(e.x,e.y,e.z):void 0)}set kinematic(t){this.isKinematic=t,this.body&&(this.body.type=t?ct.KINEMATIC:ct.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var t,e,s;return this.body?vi.tempPosition.set((t=this.body)==null?void 0:t.velocity.x,(e=this.body)==null?void 0:e.velocity.y,(s=this.body)==null?void 0:s.velocity.z):vi.tempPosition.set(0,0,0)}setVelocity(t,e,s){!this.body||(this.body.velocity.x=t/this.context.time.deltaTime,this.body.velocity.y=e/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(t,e,s){!this.body||(this.body.angularVelocity.x=t/this.context.time.deltaTime,this.body.angularVelocity.y=e/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(t=null){if(this.body&&this.gameObject&&!this.destroyed){const e=this.worldPosition;this.body.position.set(e.x,e.y,e.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),t){vi.copyVector3.set(t.x,t.y,t.z),this.smoothedVelocity.lerp(vi.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const t=C(this.gameObject);this.currentVelocity.subVectors(t,this.lastWorldPosition),this.lastWorldPosition.copy(t),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let Rt=vi;r(Rt,"tempPosition",new y),r(Rt,"copyVector3",new y);pg(Rt,"Rigidbody");var mg=Object.defineProperty,gg=(i,t)=>mg(i,"name",{value:t,configurable:!0});class Mc extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{attachedRigidbody:Rt,size:y,center:y,isTrigger:null});r(this,"attachedRigidbody");r(this,"size");r(this,"center");r(this,"isTrigger");r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addBoxCollider(this.gameObject,this.isTrigger,this.center,this.size,this.attachedRigidbody))}}gg(Mc,"BoxCollider");var _g=Object.defineProperty,bg=(i,t)=>_g(i,"name",{value:t,configurable:!0});const yg=new Ba(1,1,1);function ho(i=null){const t=new f(i!=null?i:14540253),e=new jf(yg);return new Ff(e,new Bf({color:t}))}bg(ho,"CreateWireCube");var vg=Object.defineProperty,wg=(i,t)=>vg(i,"name",{value:t,configurable:!0});const xg=w("gizmos");class $i extends v{constructor(){super(...arguments);r(this,"box",null);r(this,"testBox",new Qe);r(this,"_lastMatrixUpdateFrame",-1);r(this,"_helper",null);r(this,"_color",null)}isInBox(t){var e;if(!!t){if(this.box||(this.box=new Qe),this.updateBox(!1),t.type==="Mesh")this.testBox.setFromObject(t);else{const s=C(t);this.testBox.set(s,s)}return(e=this.box)==null?void 0:e.intersectsBox(this.testBox)}}intersects(t){return t?this.updateBox(!1).intersectsBox(t):!1}updateBox(t=!1){return this.box||(this.box=new Qe),(t||this.context.time.frameCount!=this._lastMatrixUpdateFrame)&&(this._lastMatrixUpdateFrame=this.context.time.frameCount,this.box.setFromCenterAndSize(new y(0,0,0),new y(1,1,1)),this.box.applyMatrix4(this.gameObject.matrixWorld)),this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(t=null,e=!1){var s;if(!(!xg&&!e)){if(this._helper){t&&((s=this._color)==null||s.set(t)),this.gameObject.add(this._helper);return}this._helper=ho(t),this.gameObject.add(this._helper)}}}wg($i,"BoxHelperComponent");var Pg=Object.defineProperty,Og=(i,t)=>Pg(i,"name",{value:t,configurable:!0});class Ic{}Og(Ic,"UnityObject");var Cg=Object.defineProperty,jc=(i,t)=>Cg(i,"name",{value:t,configurable:!0});class Wi extends v{constructor(){super(...arguments);r(this,"canGrab",!0)}onPointerClick(t){}}jc(Wi,"Interactable");class Hi extends v{constructor(){super(...arguments);r(this,"isUsed",!0);r(this,"usedBy",null)}}jc(Hi,"UsageMarker");var Sg=Object.defineProperty,Fc=(i,t)=>Sg(i,"name",{value:t,configurable:!0});class uo extends $i{}Fc(uo,"DeleteBox");class Bc extends v{constructor(){super(...arguments);r(this,"deleteBoxes",[])}awake(){this.deleteBoxes=p.findObjectsOfType(uo,this.context)}update(){for(const t of this.deleteBoxes){const e=this.gameObject;t.isInBox(e)===!0&&(p.getComponentInParent(this.gameObject,Hi)||Ts(this.gameObject,this.context.connection))}}}Fc(Bc,"Deletable");var Uc=Object.defineProperty,Rg=Object.getOwnPropertyDescriptor,Nc=(i,t)=>Uc(i,"name",{value:t,configurable:!0}),Eg=(i,t,e,s)=>{for(var n=s>1?void 0:s?Rg(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Uc(t,e,n),n},zc;(function(i){i[i.Never=0]="Never",i[i.Desktop=1]="Desktop",i[i.Mobile=2]="Mobile"})(zc||(zc={}));class fo extends v{constructor(){super(...arguments);r(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||p.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:$c()?(this.visibleOn&2)!=0:(this.visibleOn&1)!=0}}Nc(fo,"DeviceFlag");Eg([g()],fo.prototype,"visibleOn",2);let nn;function $c(){if(nn===!0||nn===!1)return nn;let i=!1;return function(t){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(i=!0)}(navigator.userAgent||navigator.vendor||window.opera),nn=i,i}Nc($c,"isMobile");var Ag=Object.defineProperty,kg=(i,t)=>Ag(i,"name",{value:t,configurable:!0});class rt{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(t,e,s,n){return t.prep(4,12),t.writeFloat32(n),t.writeFloat32(s),t.writeFloat32(e),t.offset()}}kg(rt,"Vec3");var Tg=Object.defineProperty,Lg=(i,t)=>Tg(i,"name",{value:t,configurable:!0});class po{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}position(t){return(t||new rt).__init(this.bb_pos,this.bb)}rotation(t){return(t||new rt).__init(this.bb_pos+12,this.bb)}scale(t){return(t||new rt).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(t,e,s,n,o,a,l,c,h,d){return t.prep(4,36),t.prep(4,12),t.writeFloat32(d),t.writeFloat32(h),t.writeFloat32(c),t.prep(4,12),t.writeFloat32(l),t.writeFloat32(a),t.writeFloat32(o),t.prep(4,12),t.writeFloat32(n),t.writeFloat32(s),t.writeFloat32(e),t.offset()}}Lg(po,"Transform");var Dg=Object.defineProperty,Mg=(i,t)=>Dg(i,"name",{value:t,configurable:!0});class It{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedTransformModel(t,e){return(e||new It).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedTransformModel(t,e){return t.setPosition(t.position()+vr),(e||new It).__init(t.readInt32(t.position())+t.position(),t)}guid(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}fast(){const t=this.bb.__offset(this.bb_pos,6);return t?!!this.bb.readInt8(this.bb_pos+t):!1}transform(t){const e=this.bb.__offset(this.bb_pos,8);return e?(t||new po).__init(this.bb_pos+e,this.bb):null}dontSave(){const t=this.bb.__offset(this.bb_pos,10);return t?!!this.bb.readInt8(this.bb_pos+t):!1}static startSyncedTransformModel(t){t.startObject(4)}static addGuid(t,e){t.addFieldOffset(0,e,0)}static addFast(t,e){t.addFieldInt8(1,+e,0)}static addTransform(t,e){t.addFieldStruct(2,e,0)}static addDontSave(t,e){t.addFieldInt8(3,+e,0)}static endSyncedTransformModel(t){return t.endObject()}static finishSyncedTransformModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedTransformModelBuffer(t,e){t.finish(e,void 0,!0)}}Mg(It,"SyncedTransformModel");var Ig=Object.defineProperty,Wc=(i,t)=>Ig(i,"name",{value:t,configurable:!0});const me=w("debugsync"),Gi="STRS";Ns(Gi,It.getRootAsSyncedTransformModel);const jt=new Ps;function mo(i,t,e=!0){jt.clear();const s=jt.createString(i);It.startSyncedTransformModel(jt),It.addGuid(jt,s),It.addFast(jt,e);const n=t.worldPosition,o=t.worldEuler,a=t.gameObject.scale;It.addTransform(jt,po.createTransform(jt,n.x,n.y,n.z,o.x,o.y,o.z,a.x,a.y,a.z));const l=It.endSyncedTransformModel(jt);return jt.finish(l,Gi),jt.asUint8Array()}Wc(mo,"createTransformModel");class ge extends v{constructor(){super(...arguments);r(this,"overridePhysics",!0);r(this,"interpolatePosition",!0);r(this,"interpolateRotation",!0);r(this,"fastMode",!1);r(this,"syncDestroy",!1);r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"rb",null);r(this,"_wasKinematic",!1);r(this,"_receivedDataBefore",!1);r(this,"_targetPosition");r(this,"_targetRotation");r(this,"_receivedFastUpdate",!1);r(this,"_shouldRequestOwnership",!1);r(this,"joinedRoomCallback",null);r(this,"receivedDataCallback",null);r(this,"tempEuler",new Pt);r(this,"receivedUpdate",!1);r(this,"lastWorldPos");r(this,"lastWorldRotation")}requestOwnership(){me&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}hasOwnership(){var t,e;return(e=(t=this._model)==null?void 0:t.hasOwnership)!=null?e:void 0}isOwned(){var t;return(t=this._model)==null?void 0:t.isOwned}awake(){me&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new y,this._targetRotation=new P,this.lastWorldPos=new y,this.lastWorldRotation=new P,this.rb=p.getComponentInChildren(this.gameObject,Rt),this.rb&&(this._wasKinematic=this.rb.kinematic),this.receivedUpdate=!0,this._model=new Ws(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(W.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinrary(Gi,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&Cl(this.guid,this.context.connection),this._model=null,this.context.connection.stopListening(W.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(Gi,this.receivedDataCallback)}tryGetLastState(){const t=this.context.connection.tryGetState(this.guid);t&&this.onReceivedData(t)}onReceivedData(t){var e;if(!this.destroyed&&typeof t.guid=="function"&&t.guid()===this.guid){me&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,t),this.receivedUpdate=!0,this._receivedFastUpdate=t.fast();const s=t.transform();if(s){ht.markDirty(this.gameObject,!0);const n=s.position();n&&(this.interpolatePosition&&((e=this._targetPosition)==null||e.set(n.x(),n.y(),n.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(n.x(),n.y(),n.z()));const o=s.rotation();o&&(this.tempEuler.set(o.x(),o.y(),o.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&Ol(this.gameObject,this.tempEuler))}this._receivedDataBefore=!0}}onEnable(){this.lastWorldPos.copy(this.worldPosition),this.lastWorldRotation.copy(this.worldQuaternion),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){var o;if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){me&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());let t=this.worldPosition,e=this.worldQuaternion;if(this._model.isOwned&&!this.receivedUpdate){const a=t.distanceTo(this.lastWorldPos),l=e.angleTo(this.lastWorldRotation),c=this._model.hasOwnership||this.fastMode?1e-4:.001;(a>c||l>c)&&(this._model.hasOwnership?this._needsUpdate=!0:(me&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastWorldPos),this.worldPosition=this.lastWorldPos,t.copy(this.lastWorldPos),this.worldQuaternion=this.lastWorldRotation,e.copy(this.lastWorldRotation),ht.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&ht.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastWorldPos.copy(t),this.lastWorldRotation.copy(e),!this._model)return;if(!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership){this.rb&&(this.rb.kinematic=(o=this._model.isOwned)!=null?o:!1,this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject());return}this.rb&&(this._wasKinematic!==void 0&&(me&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.kinematic=this._wasKinematic),this.gameObject.position.distanceTo(new y(0,0,0))>1e3&&(me&&console.log("RESET",this.name),this.gameObject.position.set(0,1,0),this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject()));const s=10,n=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%s==0||n)){me&&console.log("send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this.overridePhysics&&this.rb&&this.rb.setBodyFromGameObject(),this._needsUpdate=!1;const a=mo(this.guid,this,!!n);this.context.connection.sendBinary(a)}}}Wc(ge,"SyncedTransform");class jg{static createButton(t,e={}){const s=document.createElement("button");function n(){if(e.domOverlay===void 0){var c=document.createElement("div");c.style.display="none",document.body.appendChild(c);var h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("width",38),h.setAttribute("height",38),h.style.position="absolute",h.style.right="20px",h.style.top="20px",h.addEventListener("click",function(){u.end()}),c.appendChild(h);var d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),d.setAttribute("stroke","#fff"),d.setAttribute("stroke-width",2),h.appendChild(d),e.optionalFeatures===void 0&&(e.optionalFeatures=[]),e.optionalFeatures.push("dom-overlay"),e.domOverlay={root:c}}e.optionalFeatures===void 0&&(e.optionalFeatures=[]),e.optionalFeatures.push("local-floor"),e.optionalFeatures.push("hand-tracking"),e.optionalFeatures.push("layers");let u=null;async function _(x){x.addEventListener("end",b),await t.xr.setSession(x),s.textContent="STOP AR",e.domOverlay.root.style.display="",u=x}function b(){u.removeEventListener("end",b),s.textContent="START AR",e.domOverlay.root.style.display="none",u=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="START AR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){u===null?navigator.xr.requestSession("immersive-ar",e).then(_):u.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="AR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="ARButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-ar").then(function(c){c?n():a()}).catch(a),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}}const ar=class{static createButton(t,e){e&&console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');const s=document.createElement("button");function n(){let c=null;async function h(u){u.addEventListener("end",d),await t.xr.setSession(u),s.textContent="EXIT VR",c=u}function d(){c.removeEventListener("end",d),s.textContent="ENTER VR",c=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="ENTER VR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){if(c===null){const u={optionalFeatures:["local-floor","bounded-floor","hand-tracking","high-fixed-foveation-level","layers"]};navigator.xr.requestSession("immersive-vr",u).then(h)}else c.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="VR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="VRButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-vr").then(function(c){c?n():a(),ar.xrSessionIsGranted&&(console.log("XR session is granted - will enter immersive web now"),s.click())}),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}static registerSessionGrantedListener(){if("xr"in navigator)try{navigator.xr.addEventListener("sessiongranted",()=>{console.log("Received session granted event"),ar.xrSessionIsGranted=!0})}catch(t){console.error(t)}}};let rn=ar;r(rn,"xrSessionIsGranted",!1);rn.registerSessionGrantedListener();var Fg=Object.defineProperty,on=(i,t)=>Fg(i,"name",{value:t,configurable:!0});const an="noVoip",ot=w("debugvoip"),Bg=w("voip");var ln;(function(i){i.Update_ID="peer-update-id"})(ln||(ln={}));class Hc{constructor(t){r(this,"id");this.id=t}}on(Hc,"PeerModel");var Gc;(function(i){i[i.None=0]="None",i[i.Errors=1]="Errors",i[i.ErrorsAndWarnings=2]="ErrorsAndWarnings",i[i.All=3]="All"})(Gc||(Gc={}));class Vc{constructor(t,e,s,n){r(this,"peer");r(this,"voip");r(this,"userId");r(this,"peerId");r(this,"call",null);r(this,"callErrorListener",null);r(this,"stream",null);this.voip=t,this.peer=e,this.userId=s,this.peerId=n}close(){var t;ot&&console.log("close voip call"),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.open&&this.call.close(),(t=this.stream)==null||t.getTracks().forEach(function(e){e.stop()})}updateMute(t){var s;if(!this.stream)return;const e=(s=this.stream)==null?void 0:s.getAudioTracks();for(const n of e)n.enabled=!t}async startVoipCall(){if(!await _e.HasMicrophonePermissions()){console.warn("no permission to use microphone, can not start call");return}ot&&console.log("start voip call"),this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),this.updateMute(this.voip.muteOutput),ot&&console.log(this.stream),this.call=this.peer.call(this.peerId,this.stream,{metadata:{userId:this.userId}}),this.call.on("error",e=>{console.error(e)}),this.call.on("stream",e=>{ot&&console.log("received stream from remote again",e)}),this.peer.on("close",this.onCallClose.bind(this)),this.callErrorListener=e=>{var s;e.message.includes(this.peerId)?(console.log("Could not connect to "+this.peerId),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.close(),(s=this.stream)==null||s.getTracks().forEach(function(n){n.stop()}),this.stream=null):console.error(e)},this.peer.on("error",this.callErrorListener)}onCallClose(t){ot&&console.log("call closed",t)}}on(Vc,"PeerConnection");class qc{constructor(t,e,s){r(this,"voip");r(this,"call");r(this,"audio",null);r(this,"stream",null);r(this,"obj");r(this,"analyzer",null);r(this,"waitingForStart",!1);r(this,"closed",!1);r(this,"audioElement",null);this.voip=t,this.obj=e,this.call=s}get currentStream(){return this.stream}get currentAudio(){return this.audio}get currentAnalyzer(){return this.analyzer}openAudioStream(t){const e=t.getAudioTracks();for(const s of e)if(s.kind==="audio"&&s.readyState==="live"){this.open(s);return}console.warn("failed finding valid audio stream to begin call")}open(t){console.assert(t.kind==="audio","invalid track kind, expected audio but received "+t.kind),!this.waitingForStart&&(this.waitingForStart=!0,nt.userInteractionRegistered||ot&&console.log("Incoming call, waiting for user interaction before opening audio"),nt.registerWaitForAllowAudio(async()=>{if(this.call.open&&!this.closed){ot&&console.log("Setup audio and begin listening"),this.stream=new MediaStream([t]);const e=new Fa;this.audio=new Ua(e),this.audio.setVolume(this.voip.muteInput?0:1),this.audio.setMediaStreamSource(this.stream);const s=document.createElement("audio");this.audioElement=s,s.style.display="none",document.body.appendChild(s),s.srcObject=this.stream,s.sinkId!==void 0&&navigator.mediaDevices.enumerateDevices().then(n=>{if(!!s){console.log(n);for(const o of n)if(o.label==="Speakerphone"){s.sinkId=o.deviceId;break}}}),ot&&console.log("call is setup, you should hear something now"),this.analyzer=new Uf(this.audio,32)}}))}close(){var t,e,s;this.closed=!0,((t=this.call)==null?void 0:t.open)&&this.call.close(),(e=this.audio)==null||e.disconnect(),(s=this.stream)==null||s.getTracks().forEach(n=>{n.stop()}),this.stream=null,this.audioElement&&this.audioElement.remove()}}on(qc,"AudioConnection");class _e extends v{constructor(){super(...arguments);r(this,"requireParam",!1);r(this,"peer",null);r(this,"model",null);r(this,"connections",{});r(this,"currentIncomingCalls",{});r(this,"_inputMuted",!1);r(this,"_outputMuted",!1)}set muteInput(t){var s;if(t===this._inputMuted||(this._inputMuted=t,!this.currentIncomingCalls))return;const e=this._inputMuted?0:1;for(const n in this.currentIncomingCalls){const o=this.currentIncomingCalls[n];(s=o==null?void 0:o.currentAudio)==null||s.setVolume(e)}}get muteInput(){return this._inputMuted}set muteOutput(t){if(t!==this._outputMuted&&(this._outputMuted=t,!!this.connections))for(const e in this.connections){const s=this.connections[e];s==null||s.updateMute(t)}}get muteOutput(){return this._outputMuted}getFrequency(t){if(t===null){for(const s in this.currentIncomingCalls){const n=this.currentIncomingCalls[s];if(n&&n.currentAnalyzer)return n.currentAnalyzer.getAverageFrequency()}return null}const e=this.currentIncomingCalls[t];return e&&e.currentAnalyzer?e.currentAnalyzer.getAverageFrequency():null}awake(){if(w(an)){console.log("VOIP is disabled by url parameter: "+an);return}if(this.requireParam&&!Bg){console.debug("VOIP must be enabled explicitly by url parameter");return}this.peer=new mr,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,this.context.connection.beginListen(W.JoinedRoom,t=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}),this.context.connection.beginListen(ln.Update_ID,t=>{if(t.id!==this.context.connection.connectionId){const e=this.connections[t.id];if(e&&e.close(),this.peer&&this.context.connection.connectionId){const s=new Vc(this,this.peer,this.context.connection.connectionId,t.peerId);this.connections[t.id]=s,s.startVoipCall()}}}),this.context.connection.beginListen(W.UserLeftRoom,t=>{const{userId:e}=t,s=this.connections[e];this.connections[e]=null,s&&s.close();const n=this.currentIncomingCalls[e];ot&&console.log("UserLeftRoom",t,e,n),n&&(n.close(),this.currentIncomingCalls[e]=null)}),this.peer.on("open",this.onOpenPeerConnection.bind(this))}onEnable(){}onDisable(){console.log("TODO: close all");for(const t in this.currentIncomingCalls){const e=this.currentIncomingCalls[t];e==null||e.close();const s=this.connections[t];s==null||s.close()}}async onOpenPeerConnection(t){ot&&console.log("Peer connection established and received id"),this.model=new Hc(t),this.context.connection.send(ln.Update_ID,this.model,Di.OnRoomJoin),this.peer&&(this.peer.on("call",this.onReceiveCall.bind(this)),this.peer.on("connection",function(e){ot&&console.log("CONNECTION",e),e.on("data",function(s){ot&&console.log("Received",s)})}))}async onReceiveCall(t){const{metadata:e}=t;console.assert(e.userId);const{userId:s}=e,n=this.currentIncomingCalls[s];if(n&&n.close(),ot&&console.log("received call"),await _e.HasMicrophonePermissions()){const o=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});t.answer(o)}else t.answer(null);this.currentIncomingCalls[s]=new qc(this,this.gameObject,t),t.on("stream",o=>{var a;ot&&console.log("receive caller stream, will setup audio now"),(a=this.currentIncomingCalls[s])==null||a.openAudioStream(o)}),t.on("error",console.error)}static async HasMicrophonePermissions(){return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}}on(_e,"Voip");var Ug=Object.defineProperty,Xc=(i,t)=>Ug(i,"name",{value:t,configurable:!0});const ri=w("debugflags");var Y;(function(i){i[i.Never=0]="Never",i[i.Browser=1]="Browser",i[i.AR=2]="AR",i[i.VR=4]="VR",i[i.FirstPerson=8]="FirstPerson",i[i.ThirdPerson=16]="ThirdPerson"})(Y||(Y={}));const Ca=class{constructor(){r(this,"Mask",1|16)}Has(t){const e=this.Mask&t;return ri&&console.log("HAS",t,this.Mask,"Result="+e),e!==0}Set(t){this.Mask=t,K.Apply()}Enable(t){this.Mask|=t,K.Apply()}Disable(t){this.Mask&=~t,K.Apply()}Toggle(t){this.Mask^=t,K.Apply()}EnableAll(){this.Mask=4294967295|0,K.Apply()}DisableAll(){this.Mask=0,K.Apply()}};let Kt=Ca;r(Kt,"Global",new Ca);Xc(Kt,"XRState");const Ht=class extends v{constructor(){super(...arguments);r(this,"visibleIn")}static Apply(){for(const t of this.registry)t.UpdateVisible(Kt.Global)}awake(){Ht.registry.push(this)}onEnable(){Ht.firstApply||(Ht.firstApply=!0,Ht.Apply())}onDestroy(){const t=Ht.registry.indexOf(this);t>=0&&Ht.registry.splice(t,1)}get isOn(){return this.gameObject.visible}UpdateVisible(t=null){if(!this.enabled)return;let e;const s=t;s&&typeof s=="number"&&(console.assert(typeof s=="number","XRFlag.UpdateVisible: state must be a number",s),ri&&console.log(s),Ht.buffer.Mask=s,t=Ht.buffer);const n=t;if(n?(ri&&console.log("use passed in mask"),e=n.Has(this.visibleIn)):(ri&&console.log("use global mask"),Kt.Global.Has(this.visibleIn)),e!==void 0)if(e)ri&&console.trace("is visible",this.name,this.gameObject.uuid),p.setActive(this.gameObject,!0);else{if(ri&&console.trace("is not visible",this.name,this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}};let K=Ht;r(K,"registry",[]),r(K,"firstApply"),r(K,"buffer",new Kt);Xc(K,"XRFlag");var Ng=Object.defineProperty,Qc=(i,t)=>Ng(i,"name",{value:t,configurable:!0});const be=w("debugavatar"),oe=class extends v{constructor(){super(...arguments);r(this,"connectionId");r(this,"avatar")}static onAvatarMarkerCreated(t){return oe._onNewAvatarMarkerAdded.push(t),t}static onAvatarMarkerDestroyed(t){return oe._onAvatarMarkerDestroyed.push(t),t}awake(){oe.instances.push(this),be&&console.log(this);for(const t of oe._onNewAvatarMarkerAdded)t({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){oe.instances.splice(oe.instances.indexOf(this),1);for(const t of oe._onAvatarMarkerDestroyed)t({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}setVisible(t){this.avatar&&("setVisible"in this.avatar?this.avatar.setVisible(t):p.setActive(this.avatar,t))}};let tt=oe;r(tt,"instances",[]),r(tt,"_onNewAvatarMarkerAdded",[]),r(tt,"_onAvatarMarkerDestroyed",[]);Qc(tt,"AvatarMarker");const _s=class{constructor(t,e,s){r(this,"_isVisible",!0);r(this,"guid");r(this,"root",null);r(this,"head",null);r(this,"handLeft",null);r(this,"handRight",null);r(this,"lastUpdate",-1);r(this,"isLocalAvatar",!1);r(this,"flags",null);r(this,"headScale",new y(1,1,1));r(this,"handLeftScale",new y(1,1,1));r(this,"handRightScale",new y(1,1,1));r(this,"webxr");r(this,"lastAvatarId",null);r(this,"hasAvatarOverride",!1);r(this,"context");r(this,"avatarMarker",null);r(this,"_headTarget",new S);r(this,"_handLeftTarget",new S);r(this,"_handRightTarget",new S);r(this,"_canInterpolate",!1);this.context=t,this.guid=e,this.webxr=s,this.setupCustomAvatar(this.webxr.defaultAvatar)}setVisible(t){this._isVisible=t,this.updateVisibility()}updateFlags(){if(!this.flags)return;let t=this.isLocalAvatar?Y.FirstPerson:Y.ThirdPerson;for(const e of this.flags)e.gameObject.visible=!0,e.UpdateVisible(t)}async setAvatarOverride(t){return this.hasAvatarOverride=t!==null,this.hasAvatarOverride&&this.lastAvatarId!==t&&(this.lastAvatarId=t,t!=null&&t.length>0)?await this.setupCustomAvatar(t):null}tryUpdate(t,e){if(t.guid===this.guid&&(this.lastAvatarId!==t.avatarId&&t.avatarId&&t.avatarId.length>0&&(this.lastAvatarId=t.avatarId,this.setupCustomAvatar(t.avatarId)),this.lastUpdate=t.time,this.head)){this._canInterpolate=!0;const s=this.isLocalAvatar?this.head:this._headTarget;if(s.position.set(t.position.x,t.position.y,t.position.z),s.quaternion.set(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w),s.scale.set(t.scale,t.scale,t.scale),s.scale.multiply(this.headScale),this.handLeft){const n=this.isLocalAvatar?this.handLeft:this._handLeftTarget;n.position.set(t.posLeftHand.x,t.posLeftHand.y,t.posLeftHand.z),n.quaternion.set(t.rotLeftHand._x,t.rotLeftHand._y,t.rotLeftHand._z,t.rotLeftHand._w),n.quaternion.multiply(_s.invertRotation),n.scale.set(t.scale,t.scale,t.scale),n.scale.multiply(this.handLeftScale)}if(this.handRight){const n=this.isLocalAvatar?this.handRight:this._handRightTarget;n.position.set(t.posRightHand.x,t.posRightHand.y,t.posRightHand.z),n.quaternion.set(t.rotRightHand._x,t.rotRightHand._y,t.rotRightHand._z,t.rotRightHand._w),n.quaternion.multiply(_s.invertRotation),n.scale.set(t.scale,t.scale,t.scale),n.scale.multiply(this.handRightScale)}}}update(){if(this.isLocalAvatar||!this._canInterpolate)return;const t=this.context.time.deltaTime/.1;this.head&&(this.head.position.lerp(this._headTarget.position,t),this.head.quaternion.slerp(this._headTarget.quaternion,t),this.head.scale.lerp(this._headTarget.scale,t)),this.handLeft&&this._handLeftTarget&&(this.handLeft.position.lerp(this._handLeftTarget.position,t),this.handLeft.quaternion.slerp(this._handLeftTarget.quaternion,t),this.handLeft.scale.lerp(this._handLeftTarget.scale,t)),this.handRight&&this._handRightTarget&&(this.handRight.position.lerp(this._handRightTarget.position,t),this.handRight.quaternion.slerp(this._handRightTarget.quaternion,t),this.handRight.scale.lerp(this._handRightTarget.scale,t))}destroy(){var t,e;be&&console.log("Destroy avatar",this.guid),(t=this.root)==null||t.removeFromParent(),(e=this.avatarMarker)==null||e.destroy(),this.lastAvatarId=null,this.head&&at.Remove(this.context,this.head)}updateVisibility(){const t=this.root;t&&p.setActive(t,this._isVisible)}async setupCustomAvatar(t){var n,o,a,l,c;if(be&&console.log("LOAD",t,this),!t||typeof t=="string"&&t.length<=0)return!1;this.head&&at.Remove(this.context,this.head);const e=t;if((e==null?void 0:e.loadAssetAsync)!==void 0){await e.loadAssetAsync();const h=e.asset;p.setActive(h,!1),t=p.instantiate(h),p.setActive(t,!0)}be&&console.log(t);const s=await _s.loader.getOrCreateNewAvatarInstance(this.context,t);if(be&&console.log(s,s==null?void 0:s.isValid,this.lastAvatarId,t),s==null?void 0:s.isValid){if(this.root=s.root,this.avatarMarker=p.addNewComponent(this.root,tt),this.avatarMarker.connectionId=this.guid,this.avatarMarker.avatar=this,this.head&&this.head!==s.head&&((n=this.head)==null||n.removeFromParent()),this.head=s.head,this.headScale.copy(this.head.scale),this.head&&!this.isLocalAvatar&&at.Add(this.context,this.head,this.avatarMarker),s.leftHand&&((o=this.handLeft)==null||o.removeFromParent()),this.handLeft=(a=s.leftHand)!=null?a:this.handLeft,this.handLeft?this.handLeftScale.copy(this.handLeft.scale):this.handLeftScale.set(1,1,1),s.rigthHand&&((l=this.handRight)==null||l.removeFromParent()),this.handRight=(c=s.rigthHand)!=null?c:this.handRight,this.handRight?this.handRightScale.copy(this.handRight.scale):this.handRightScale.set(1,1,1),this.context.scene.add(this.root),this.flags==null&&(this.flags=[]),this.flags.length=0,this.flags.push(...p.getComponentsInChildren(this.root,K)),this.flags.length<=0&&this.head){const h=p.addNewComponent(this.head,K);h.visibleIn=Y.ThirdPerson|Y.VR,this.flags.push(h),be&&console.log("Added flag to head: "+h.visibleIn,this.head.name)}return be&&console.log("[Avatar], is Local? ",this.isLocalAvatar,this.root),this.updateFlags(),this.updateVisibility(),!0}else return be&&console.warn("build avatar failed"),!1}};let ye=_s;r(ye,"loader",new sn),r(ye,"invertRotation",new P().setFromAxisAngle(new y(0,1,0),Math.PI));Qc(ye,"WebXRAvatar");var zg=Object.defineProperty,go=(i,t)=>zg(i,"name",{value:t,configurable:!0});class at{static Add(t,e,s=null){if(!!e){for(const n of this.Pois)if(n.obj===e)return;this.Pois.push({obj:e,avatar:s}),this.LastChangeTime=t.time.time}}static Remove(t,e){var s,n;if(!!e){for(const o of this.Pois)if(o.obj===e){this.Pois.splice(this.Pois.indexOf(o),1),this.LastChangeTime=(n=t==null?void 0:t.time.time)!=null?n:(s=A.Current)==null?void 0:s.time.time;return}}}}r(at,"Pois",[]),r(at,"LastChangeTime",0);go(at,"Avatar_POI");var cn;(function(i){i.TargetChanged="avatar-look-target-changed"})(cn||(cn={}));class Yc{constructor(){r(this,"guid");r(this,"position",new y)}}go(Yc,"TargetModel");class hn extends v{constructor(){super(...arguments);r(this,"target",null);r(this,"avatar",null);r(this,"_model",null);r(this,"_targetModel",new Yc);r(this,"_currentTargetObject",null);r(this,"_lastUpdateTime",0);r(this,"_lookDuration",0);r(this,"_lastPoiChangedTime",0)}set controlledTarget(t){this.target=t;const e=m.get("MoveRandom");if(e&&this.target){const s=p.getComponent(this.target,e);s&&s.destroy()}}awake(){if(this.avatar=p.getComponentInParent(this.gameObject,tt),this.avatar){const t=p.getComponentInParent(this.gameObject,tt);this._model=new Ws(this.context.connection,this.guid),(t==null?void 0:t.isLocalAvatar)&&this._model.requestOwnership()}this.context.connection.beginListen(cn.TargetChanged,t=>{var e;this.target&&t&&t.guid===((e=this.avatar)==null?void 0:e.guid)&&D(this.target,t.position)})}update(){var e;if((!this.context.connection.isConnected||((e=this._model)==null?void 0:e.hasOwnership))&&(at.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=at.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10==0&&this.target)){const s=C(this._currentTargetObject);D(this.target,s),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send(cn.TargetChanged,this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(s))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const e=at.Pois;if(e.length>0){const s=e[Math.floor(Math.random()*e.length)];if(s&&s.obj){if(s.avatar&&s.avatar===this.avatar)return;this._currentTargetObject=s.obj}}}}}go(hn,"Avatar_Brain_LookAt");var $g=Object.defineProperty,dn=(i,t)=>$g(i,"name",{value:t,configurable:!0}),un;(function(i){i[i.PhysicalDevice=0]="PhysicalDevice",i[i.Touch=1]="Touch"})(un||(un={}));var ft;(function(i){i.SelectStart="select-start",i.SelectEnd="select-end",i.Update="update"})(ft||(ft={}));class _o extends v{}dn(_o,"TeleportTarget");const G=class extends v{constructor(){super(...arguments);r(this,"webXR");r(this,"index",-1);r(this,"controllerModel");r(this,"controller");r(this,"controllerGrip");r(this,"hand");r(this,"handPointerModel");r(this,"grabbed",null);r(this,"input",null);r(this,"type",0);r(this,"_wristQuaternion",null);r(this,"movementVector",new y);r(this,"worldRot",new P);r(this,"joystick",new V);r(this,"didRotate",!1);r(this,"didTeleport",!1);r(this,"didChangeScale",!1);r(this,"lastHit",null);r(this,"raycastLine",null);r(this,"_raycastHitPoint",null);r(this,"_connnectedCallback",null);r(this,"_disconnectedCallback",null);r(this,"_selectStartEvt",null);r(this,"_selectEndEvt",null);r(this,"_selectionPressed",!1);r(this,"_selectionPressedLastFrame",!1);r(this,"_selectionStartTime",0);r(this,"_selectionEndTime",0);r(this,"_useSmoothing",!0);r(this,"_isConnected",!1);r(this,"rayRotation",new P);r(this,"_pinchStartTime");r(this,"selectStartCallback",null);r(this,"lastSelectStartObject",null);r(this,"_didNotEndSelection",!1)}static CreateRaycastLine(){const t=new Na(this.geometry),e=t.material;return e.color=this.raycastColor,t.layers.set(1),t.name="line",t.scale.z=1,t}static CreateRaycastHitPoint(){const t=new za(.5,22,22),e=new Ci({color:this.raycastColor}),s=new Je(t,e);return s.visible=!1,s.layers.set(1),s}static Create(t,e,s,n){const o=s?p.addNewComponent(s,G,!1):new G;o.webXR=t,o.index=e,o.type=n;const a=t.context;return o.controller=a.renderer.xr.getController(e),o.controllerGrip=a.renderer.xr.getControllerGrip(e),o.controllerModel=this.Factory.createControllerModel(o.controller),o.controllerGrip.add(o.controllerModel),o.hand=a.renderer.xr.getHand(e),o.hand.add(new zf(o.hand)),o.hand.traverse(l=>l.layers.set(2)),o.handPointerModel=new $f(o.hand,o.controller),o.controller.addEventListener("connected",l=>{o.setControllerLayers(o.controllerModel,2),o.setControllerLayers(o.controllerGrip,2),setTimeout(()=>{o.setControllerLayers(o.controllerGrip,2)},1e3)}),o.hand.addEventListener("connected",l=>{var h;if(l.data.hand){t.Rig&&t.Rig.add(o.hand),o.type=0,o.handPointerModel.traverse(u=>u.layers.set(2)),(h=o.handPointerModel.pointerObject)==null||h.traverse(u=>u.layers.set(2));const d=o.hand.joints;if(d)for(const u of Object.keys(d)){const _=d[u];_.parent||o.hand.add(_)}}}),o}static addEventListener(t,e){var n;const s=(n=this.eventSubs[t])!=null?n:[];s.push(e),this.eventSubs[t]=s}get isUsingHands(){var e;const t=(e=this.input)==null?void 0:e.hand;return t!=null}get wrist(){if(!this.hand)return null;const t=this.hand.joints;return t?t.wrist:null}getWristQuaternion(){const t=this.wrist;return t?(this._wristQuaternion||(this._wristQuaternion=new P),J(t).multiply(this._wristQuaternion.setFromEuler(new Pt(-Math.PI/4,0,0)))):null}get selectionDown(){return this._selectionPressed&&!this._selectionPressedLastFrame}get selectionUp(){return!this._selectionPressed&&this._selectionPressedLastFrame}get selectionPressed(){return this._selectionPressed}get selectionClick(){return this._selectionEndTime-this._selectionStartTime<.3}get raycastHitPoint(){return this._raycastHitPoint}get useSmoothing(){return this._useSmoothing}awake(){if(!this.controller){console.warn("Missing Controller!!!",this);return}this._connnectedCallback=this.onSourceConnected.bind(this),this._disconnectedCallback=this.onSourceDisconnected.bind(this),this._selectStartEvt=this.onSelectStart.bind(this),this._selectEndEvt=this.onSelectEnd.bind(this),this.type===1&&(this.controllerGrip.addEventListener("connected",this._connnectedCallback),this.controllerGrip.addEventListener("disconnected",this._disconnectedCallback),this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt))}onDestroy(){var t,e,s;this.type===1&&(this.controllerGrip.removeEventListener("connected",this._connnectedCallback),this.controllerGrip.removeEventListener("disconnected",this._disconnectedCallback),this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),(t=this.hand)==null||t.clear(),(e=this.controllerGrip)==null||e.clear(),(s=this.controller)==null||s.clear()}onEnable(){var t,e,s,n,o;this.hand&&(this.hand.name="Hand"),this.controllerGrip&&(this.controllerGrip.name="ControllerGrip"),this.controller&&(this.controller.name="Controller"),this.raycastLine&&(this.raycastLine.name="RaycastLine;"),this.webXR.Controllers.indexOf(this)<0&&this.webXR.Controllers.push(this),this.raycastLine||(this.raycastLine=G.CreateRaycastLine()),this._raycastHitPoint||(this._raycastHitPoint=G.CreateRaycastHitPoint()),(t=this.webXR.Rig)==null||t.add(this.hand),(e=this.webXR.Rig)==null||e.add(this.controllerGrip),(s=this.webXR.Rig)==null||s.add(this.controller),(n=this.webXR.Rig)==null||n.add(this.raycastLine),(o=this.raycastLine)==null||o.add(this._raycastHitPoint),this.hand.add(this.handPointerModel),console.log("ADDED TO RIG",this.webXR.Rig)}onDisable(){var e,s,n,o,a;(e=this.hand)==null||e.removeFromParent(),(s=this.controllerGrip)==null||s.removeFromParent(),(n=this.controller)==null||n.removeFromParent(),(o=this.raycastLine)==null||o.removeFromParent(),(a=this._raycastHitPoint)==null||a.removeFromParent();const t=this.webXR.Controllers.indexOf(this);t>=0&&this.webXR.Controllers.splice(t,1)}onSourceConnected(t){if(this._isConnected){console.warn("Received connected event for controller that is already connected",this.index,t);return}this._isConnected=!0,this.input=t.data,this.type===1&&(this.onSelectStart(),this.createPointerEvent("down"))}onSourceDisconnected(t){if(!this._isConnected){console.warn("Received discnnected event for controller that is not connected",t);return}this._isConnected=!1,this.type===1&&(this.onSelectEnd(),this.createPointerEvent("up")),this.input=null}createPointerEvent(t){switch(t){case"down":this.context.input.createPointerDown({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break;case"move":break;case"up":this.context.input.createPointerUp({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break}}update(){this.context.time.frameCount%60==0&&(this.setControllerLayers(this.controller,2),this.setControllerLayers(this.controllerGrip,2),this.setControllerLayers(this.hand,2));const t=G.eventSubs[ft.Update];if(t&&t.length>0)for(const n of t)n(this);let e=1;this.type===0?e=this.context.time.deltaTime/.1:this.isUsingHands&&this.handPointerModel.pinched&&(e=this.context.time.deltaTime/.3),this.rayRotation.slerp(J(this.controller),this.useSmoothing?e:1);const s=C(this.controller);if(this.raycastLine)if(this.type===1)this.raycastLine.visible=!1;else if(this.isUsingHands){this.raycastLine.visible=!this.grabbed,D(this.raycastLine,s);const n=this.hand.joints;if(n&&n.wrist&&this.grabbed&&this.grabbed.isCloseGrab){const a=this.getWristQuaternion();a&&this.rayRotation.copy(a)}Z(this.raycastLine,this.rayRotation)}else this.raycastLine.visible=!0,Z(this.raycastLine,this.rayRotation),D(this.raycastLine,s);this.lastHit=this.updateLastHit(),this.grabbed&&this.grabbed.update(),this._selectionPressedLastFrame=this._selectionPressed,this.selectStartCallback&&this.selectStartCallback()}onUpdate(t){var n,o;if(this.lastHit=null,!t||t.inputSources.length<=this.index){this.input=null;return}if(this.type===0&&(this.input=t.inputSources[this.index]),!this.input)return;const e=this.webXR.Rig;if(!e)return;this._didNotEndSelection&&!this.handPointerModel.pinched&&(this._didNotEndSelection=!1,this.onSelectEnd()),this.updateStick(this.input);const s=(o=(n=this.input)==null?void 0:n.gamepad)==null?void 0:o.buttons;switch(this.input.handedness){case"left":const a=3*G.MovementSpeedFactor,l=2,c=k.clamp01(this.joystick.length()*2),h=this.joystick.x>0?1:-1;let d=Math.pow(this.joystick.x,l);d*=h,d*=c;const u=this.joystick.y>0?1:-1;let _=Math.pow(this.joystick.y,l);_*=u,d*=c,e.getWorldQuaternion(this.worldRot),this.movementVector.set(d,0,_),this.movementVector.applyQuaternion(this.webXR.TransformOrientation),this.movementVector.y=0,this.movementVector.applyQuaternion(this.worldRot),e.position.add(this.movementVector.multiplyScalar(a*this.context.time.deltaTime)),this.isUsingHands&&this.runTeleport(e,s);break;case"right":const b=this.joystick.x,x=Math.abs(b);if(x<.4)this.didRotate=!1;else if(x>.5&&!this.didRotate){const O=b>0?-1:1;e.rotateY(k.toRadians(30*O)),this.didRotate=!0}this.runTeleport(e,s);break}}runTeleport(t,e){var l,c,h;let s=-this.joystick.y;if(((l=this.hand)==null?void 0:l.visible)&&!this.grabbed){const d=this.handPointerModel.isPinched();d&&this._pinchStartTime===void 0&&(this._pinchStartTime=this.context.time.time),d&&this._pinchStartTime&&this.context.time.time-this._pinchStartTime>.8&&(s=this.handPointerModel.isPinched()?1:0),d||(this._pinchStartTime=void 0)}else this._pinchStartTime=void 0;let n=s>.5,o=this.webXR.Rig?((h=(c=this.webXR.Rig)==null?void 0:c.scale)==null?void 0:h.x)<.999:!1,a=null;if(e&&this.input&&!this.input.hand)for(let d=0;d<e.length;d++){const u=e[d];if(d===4)if(u.pressed&&!this.didChangeScale){this.didChangeScale=!0;const _=this.webXR.Rig;if(_)if(o){o=!1,_.scale.set(1,1,1),a=1,G.MovementSpeedFactor=1;const b=this.context.mainCamera;G.PreviousCameraFarDistance&&(b.far=G.PreviousCameraFarDistance)}else{o=!0,n=!0,a=.1,G.MovementSpeedFactor=a*2;const b=this.context.mainCamera;G.PreviousCameraFarDistance=b.far,b.far/=a}}else u.pressed||(this.didChangeScale=!1)}if(n){if(!this.didTeleport){const d=this.raycast();if(this.didTeleport=!0,d&&d.length>0){const u=d[0];if(o||this.isValidTeleportTarget(u.object)){const _=u.point;D(t,_)}}}}else s<.1&&(this.didTeleport=!1);a!==null&&(t.scale.set(a,a,a),t.updateMatrixWorld())}isValidTeleportTarget(t){return p.getComponentInParent(t,_o)!=null}updateStick(t){var e;!t||!t.gamepad||((e=t.gamepad.axes)==null?void 0:e.length)<4||(this.joystick.x=t.gamepad.axes[2],this.joystick.y=t.gamepad.axes[3])}updateLastHit(){var n,o;const t=this.raycast(),e=t?t[0]:null;this.lastHit=e;let s=1;if(this.webXR.Rig&&(s/=this.webXR.Rig.scale.x),this.raycastLine){this.raycastLine.scale.z=s*((o=(n=this.lastHit)==null?void 0:n.distance)!=null?o:9999);const a=this.raycastLine.material;e!=null?a.color=G.raycastColor:a.color=G.raycastNoHitColor}if(this._raycastHitPoint){if(this.lastHit!=null){this._raycastHitPoint.position.z=-1;const a=k.clamp(this.lastHit.distance*.01*s,.015,.1);this._raycastHitPoint.scale.set(a,a,a)}this._raycastHitPoint.visible=this.lastHit!==null}return e}onSelectStart(){!this.context.connection.allowEditing||(this.selectStartCallback=()=>this.onHandleSelectStart())}onHandleSelectStart(){this.selectStartCallback=null,this._selectionPressed=!0,this._selectionStartTime=this.context.time.time,this._selectionEndTime=1e3;let t=null,e=!1;if(this.isUsingHands?(t=this.overlap(),t.length<=0?(t=this.raycast(),e=!1):e=!0):t=this.raycast(),t&&t.length>0)for(const s of t){const n=s.object;if(!this.testIsVisible(n)){console.log("not visible");continue}this.lastSelectStartObject=n;const o={selected:n,grab:n},a=G.eventSubs[ft.SelectStart];if(a&&a.length>0)for(const l of a)l(this,o);o.grab!==n&&console.log("Grabbed object changed","original",n,"new",o.grab),o.grab&&(this.grabbed=Ft.TryTake(this,o.grab,s,e));break}else{const s=G.eventSubs[ft.SelectStart],n={selected:null,grab:null};if(s&&s.length>0)for(const o of s)o(this,n)}}onSelectEnd(){var s,n;if(this.isUsingHands&&this.handPointerModel.pinched){this._didNotEndSelection=!0;return}if(!this._selectionPressed)return;this.selectStartCallback=null,this._selectionPressed=!1,this._selectionEndTime=this.context.time.time;const t={grab:(n=(s=this.grabbed)==null?void 0:s.selected)!=null?n:this.lastSelectStartObject},e=G.eventSubs[ft.SelectEnd];if(e&&e.length>0)for(const o of e)o(this,t);this.grabbed&&(this.grabbed.free(),this.grabbed=null)}testIsVisible(t){return t?p.isActiveInHierarchy(t):!0}setControllerLayers(t,e){var s,n;if(!!t&&(t.layers.set(e),t.children))for(const o of t.children)((s=this.grabbed)==null?void 0:s.selected)===o||((n=this.grabbed)==null?void 0:n.selectedMesh)===o||this.setControllerLayers(o,e)}getRay(){const t=new $a;return t.origin.copy(C(this.controller)),t.direction.set(0,0,-1).applyQuaternion(this.rayRotation),t}overlap(){const t=this.isUsingHands&&this.handPointerModel?this.handPointerModel.pointerObject:this.controllerGrip;if(!t)return new Array;const e=C(t).clone();return this.context.physics.sphereOverlap(e,.02)}raycast(){const t=new Dt;return t.layerMask=new xs,t.layerMask.set(0),t.ray=this.getRay(),this.context.physics.raycast(t)}};let j=G;r(j,"Factory",new Nf),r(j,"raycastColor",new f(.9,.3,.3)),r(j,"raycastNoHitColor",new f(.6,.6,.6)),r(j,"geometry",new Os().setFromPoints([new y(0,0,0),new y(0,0,-1)])),r(j,"handModels",{}),r(j,"eventSubs",{}),r(j,"PreviousCameraFarDistance"),r(j,"MovementSpeedFactor",1);dn(j,"WebXRController");var fn;(function(i){i.WillTake="WillTake",i.DidTake="DidTake",i.WillFree="WillFree",i.DidFree="DidFree"})(fn||(fn={}));const et=class{constructor(){r(this,"sync",null);r(this,"selected",null);r(this,"selectedParent",null);r(this,"selectedMesh",null);r(this,"controller",null);r(this,"grabTime",0);r(this,"grabUUID","");r(this,"isCloseGrab",!1);r(this,"originalMaterial",null);r(this,"usageMarker",null);r(this,"rigidbodies",null);r(this,"didReparent",!1);r(this,"grabDistance",0);r(this,"interactable",null);r(this,"positionSource",null);r(this,"grabPoint",new y);r(this,"localPositionOffsetToGrab",null);r(this,"localPositionOffsetToGrab_worldSpace",new y);r(this,"localQuaternionToGrab",new P(0,0,0,1));r(this,"targetDir",null);r(this,"quaternionLerp",null);r(this,"controllerDir",new y);r(this,"controllerWorldPos",new y);r(this,"lastControllerWorldPos",new y);r(this,"controllerPosDelta",new y);r(this,"totalChangeAlongDirection",0);r(this,"rigPositionLastFrame",new y)}static AddEventListener(t,e){return et.Events[t]||(et.Events[t]=[]),et.Events[t].push(e),e}static RemoveEventListener(t,e){if(!e||!et.Events[t])return;const s=et.Events[t].indexOf(e);s>=0&&et.Events[t].splice(s,1)}static Register(t){this.Current.find(e=>e===t)||this.Current.push(t)}static Remove(t){const e=this.Current.indexOf(t);e>=0&&this.Current.splice(e,1)}static TryTake(t,e,s,n){const o=p.getComponentInParent(e,Wi);if(!o)return console.warn("Prevented taking object that is not interactable",e),null;let a=e;const l=p.getComponentInParent(e,ge);l&&(l.requestOwnership(),a=l.gameObject);for(const h of this.Current)if(h.selected===a)return h.controller===t||(h.free(),h.Take(t,a,e,l,o,s,n)),h;const c=new et;return c.Take(t,a,e,l,o,s,n),c}Take(t,e,s,n,o,a,l){var b,x;if(console.assert(e!==null,"Expected object to be taken but was",e),t.isUsingHands?this.positionSource=l?t.wrist:t.controller:this.positionSource=t.controller,!this.positionSource)return console.warn("No position source"),this;const c={controller:t,take:e,hit:s,sync:n,interactable:o};(b=et.Events.WillTake)==null||b.forEach(O=>O(this,c));const h=s;(h==null?void 0:h.material)&&(this.originalMaterial=h.material,Array.isArray(h.material)||(h.material=h.material.clone(),h.material&&h.material.emissive&&(h.material.emissive.b=.2))),this.selected=e,this.selectedParent||(this.selectedParent=e.parent),this.selectedMesh=h,this.controller=t,this.interactable=o,this.isCloseGrab=l,this.didReparent=!1,this.sync=n,this.grabTime=t.context.time.time,this.grabUUID=Date.now().toString(),this.usageMarker=p.addNewComponent(this.selected,Hi),this.rigidbodies=p.getComponentsInChildren(this.selected,Rt),C(this.positionSource,this.lastControllerWorldPos);const d=dn(()=>l?this.lastControllerWorldPos.clone():a.point.clone(),"getGrabPoint");this.grabDistance=d().distanceTo(this.lastControllerWorldPos),this.totalChangeAlongDirection=0,this.localPositionOffsetToGrab=this.selected.worldToLocal(d());const u=t.isUsingHands&&l?this.controller.getWristQuaternion().clone():t.rayRotation.clone();J(this.selected,this.localQuaternionToGrab).premultiply(u.invert());const _=this.controller.webXR.Rig;return _&&this.rigPositionLastFrame.copy(C(_)),at.Add(t.context,this.selected),et.Register(this),this.sync&&(this.sync.fastMode=!0),(x=et.Events.DidTake)==null||x.forEach(O=>O(this,c)),this}free(){var n,o,a,l;if(!this.selected)return;const t={controller:this.controller,take:this.selected,hit:this.selected,sync:this.sync,interactable:null};(n=et.Events.WillFree)==null||n.forEach(c=>c(this,t)),at.Remove(this.controller.context,this.selected),et.Remove(this),this.sync&&(this.sync.fastMode=!1);const e=this.selectedMesh;e&&this.originalMaterial&&e.material&&(e.material=this.originalMaterial);const s=this.selected;if(this.didReparent&&s.parent){const c=this.selectedParent;c?c.attach(s):(o=this.controller)==null||o.context.scene.attach(s)}if((a=this.usageMarker)==null||a.destroy(),this.controller&&(this.controller.grabbed=null),this.selected=null,this.selectedParent=null,this.selectedMesh=null,this.sync=null,this.rigidbodies)for(const c of this.rigidbodies)c.wakeUp(),!!c.smoothedVelocity&&c.setVelocity(c.smoothedVelocity.x,c.smoothedVelocity.y,c.smoothedVelocity.z);this.rigidbodies=null,this.localPositionOffsetToGrab=null,this.quaternionLerp=null,(l=et.Events.DidFree)==null||l.forEach(c=>c(this,t))}controllerMovementSinceLastFrame(){if(!this.positionSource||!this.controller)return 0;this.controllerDir.set(0,0,-1),this.controllerDir.applyQuaternion(this.controller.rayRotation),C(this.positionSource,this.controllerWorldPos),this.controllerPosDelta.copy(this.controllerWorldPos),this.controllerPosDelta.sub(this.lastControllerWorldPos),this.lastControllerWorldPos.copy(this.controllerWorldPos);const t=this.controller.webXR.Rig;if(t){const s=C(t),n=this.rigPositionLastFrame.sub(s);this.controllerPosDelta.add(n),this.rigPositionLastFrame.copy(s)}return this.controllerDir.dot(this.controllerPosDelta)}update(){var t,e;if(this.sync&&this.controller&&this.controller.context.connection.isInRoom&&this.controller.context.time.time-this.grabTime>3&&this.sync.hasOwnership()===!1&&(console.log("no ownership, will leave",this.sync.guid),this.free()),!(this.interactable&&!this.interactable.canGrab)){if(!this.didReparent&&this.selected&&this.controller){const s=(e=(t=this.controller.webXR.Rig)==null?void 0:t.scale.x)!=null?e:1;this.totalChangeAlongDirection+=this.controllerMovementSinceLastFrame();let n=1;this.controller.type===0&&(n=Math.max(0,1+this.totalChangeAlongDirection*2/s),n=n*n*n),this.grabDistance/s<.8&&(n=1),this.targetDir||(this.targetDir=new y),this.targetDir.set(0,0,-this.grabDistance*n);const o=this.targetDir.applyQuaternion(this.controller.rayRotation).add(this.controllerWorldPos),a=this.controller.rayRotation.clone().multiplyQuaternions(this.controller.rayRotation,this.localQuaternionToGrab);this.quaternionLerp||(this.quaternionLerp=a.clone()),this.quaternionLerp.slerp(a,this.controller.useSmoothing?this.controller.context.time.deltaTime/.03:1),Z(this.selected,this.quaternionLerp),this.selected.updateWorldMatrix(!1,!1),this.grabPoint.copy(o),this.localPositionOffsetToGrab&&(this.localPositionOffsetToGrab_worldSpace.copy(this.localPositionOffsetToGrab),this.selected.localToWorld(this.localPositionOffsetToGrab_worldSpace).sub(C(this.selected)),o.sub(this.localPositionOffsetToGrab_worldSpace)),D(this.selected,o)}if(this.rigidbodies!=null)for(const s of this.rigidbodies)s.wakeUp(),s.setBodyFromGameObject({x:0,y:0,z:0});ht.markDirty(this.selected,!0)}}};let Ft=et;r(Ft,"Events",{}),r(Ft,"Current",[]);dn(Ft,"AttachedObject");var Jc=Object.defineProperty,Wg=Object.getOwnPropertyDescriptor,Hg=(i,t)=>Jc(i,"name",{value:t,configurable:!0}),Gg=(i,t,e,s)=>{for(var n=s>1?void 0:s?Wg(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Jc(t,e,n),n};class pn extends v{constructor(){super(...arguments);r(this,"webAR",null);r(this,"invertForward",!1);r(this,"_arScale",5);r(this,"_rig",null);r(this,"_startPose",null);r(this,"_placementPose",null);r(this,"_isTouching",!1)}get arScale(){return this._arScale}set arScale(t){t!==this._arScale&&(this._arScale=t,this.setScale(t))}onBegin(t){this._placementPose=null,this.gameObject.visible=!1,this.gameObject.matrixAutoUpdate=!1,this._startPose=this.gameObject.matrix.clone(),t.addEventListener("selectstart",this.onSelectStart.bind(this)),t.addEventListener("selectend",this.onSelectEnd.bind(this)),setTimeout(()=>this.gameObject.visible=!1,1e3)}onUpdate(t,e,s){if(s&&!this._placementPose&&this._isTouching){if(this.webAR&&this.webAR.setReticleActive(!1),this._placementPose=new Ot().fromArray(s.transform.matrix).invert(),t){if(this.invertForward){const n=new Ot().makeRotationY(Math.PI);this._placementPose.premultiply(n)}this._rig=t,this.setScale(this.arScale)}else this._rig=null;this.gameObject.visible=!0}}onEnd(t,e){this._placementPose=null,this.gameObject.visible=!1,this._startPose&&this.gameObject.matrix.copy(this._startPose),this.gameObject.matrixAutoUpdate=!0,t&&(t.matrixAutoUpdate=!0),ht.markDirty(this.gameObject,!0),setTimeout(()=>this.gameObject.visible=!0,100)}onSelectStart(){this._isTouching=!0}onSelectEnd(){this._isTouching=!1}setScale(t){const e=this._rig;!e||!this._placementPose||(e.matrixAutoUpdate=!1,e.matrix.multiplyMatrices(new Ot().makeScale(t,t,t),this._placementPose),e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld())}}Hg(pn,"WebARSessionRoot");Gg([g()],pn.prototype,"arScale",1);var Vg=Object.defineProperty,qg=(i,t)=>Vg(i,"name",{value:t,configurable:!0});class bo extends v{awake(){}}qg(bo,"XRRig");var Xg=Object.defineProperty,yo=(i,t)=>Xg(i,"name",{value:t,configurable:!0});const oi=w("debugaddressables");class Zc{constructor(t){r(this,"_context");r(this,"_assetReferences",{});this._context=t,this._context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){}findAssetReference(t){return this._assetReferences[t]||null}registerAssetReference(t){!t.uri||(this._assetReferences[t.uri]?console.warn("Asset reference already registered",t):this._assetReferences[t.uri]=t)}}yo(Zc,"Addressables");class Bt{constructor(t){r(this,"_loading");r(this,"_asset");r(this,"_glbRoot");r(this,"_uri");r(this,"_progressListeners",[]);r(this,"_isLoadingRawBinary",!1);r(this,"_rawBinary");this._uri=t,Tl(this._uri,this.onResolvePrefab.bind(this))}static getOrCreate(t,e){const s=e.addressables,n=s.findAssetReference(t);if(n)return n;const o=new Bt(t);return s.registerAssetReference(o),o}get asset(){var t;return(t=this._glbRoot)!=null?t:this._asset}set asset(t){this._asset=t}get uri(){return this._uri}get rawAsset(){return this._asset}async onResolvePrefab(t){return t===this.uri&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(oi&&console.log("Unload",this.asset),this.asset.scene?p.destroy(this.asset.scene):p.destroy(this.asset)),this.asset=null}async preload(){var e;if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,oi&&console.log("Preload",this.uri);const t=await Tc(this.uri,s=>{this.raiseProgressEvent(s)});return this._rawBinary=(e=t==null?void 0:t.buffer)!=null?e:null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(t){if(!this.mustLoad)return;if(t&&this._progressListeners.push(t),this._loading!==void 0)return this._loading;const e=A.Current;this._rawBinary?(this._loading=ps(e,this._rawBinary,this.uri,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))):(oi&&console.log("Load async",this.uri),this._loading=yi(e,this.uri,null,!0,n=>{this.raiseProgressEvent(n)}));const s=await this._loading;if(this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(s),this._loading=void 0,s)return Ke(e),s.scene!==void 0&&(this.asset=s),this.asset}async instantiate(t){return this.onInstantiate(t,!1)}async instantiateSynced(t,e=!0){return this.onInstantiate(t,!0,e)}beginListenDownload(t){this._progressListeners.indexOf(t)<0&&this._progressListeners.push(t)}endListenDownload(t){const e=this._progressListeners.indexOf(t);e>=0&&this._progressListeners.splice(e,1)}raiseProgressEvent(t){for(const e of this._progressListeners)e(this,t)}async onInstantiate(t,e=!1,s){const n=A.Current;if(t||(t=n.scene),this.mustLoad&&await this.loadAssetAsync(),oi&&console.log("Instantiate",this.uri,"parent:",t),this.asset){oi&&console.log("Add to scene",this.asset);let o=t instanceof Ct?t:null;if(o||(o=new Ct),typeof t=="object"&&(t instanceof S?o.parent=t:Object.assign(o,t)),e){o.context=n;const a=this.asset;a.guid=this.uri;const l=Fr(a,o,void 0,s);if(l)return l}else{const a=p.instantiate(this.asset,o);if(a)return a}}else oi&&console.warn("Failed to load asset",this.uri);return null}tryGetActualGameObjectRoot(t){if(t&&t.scene){const e=t.scene;return e.isGroup&&e.children.length===1&&e.children[0].name+"glb"===e.name?e.children[0]:e}return null}}yo(Bt,"AssetReference");class Kc extends si{constructor(){super([Bt])}onSerialize(t,e){if(t&&t.uri!==void 0&&typeof t.uri=="string")return t.uri}onDeserialize(t,e){return typeof t=="string"?e.context?Bt.getOrCreate(t,e.context):(console.error("Missing context"),null):null}}yo(Kc,"AddressableSerializer");new Kc;var Qg=Object.defineProperty,Yg=(i,t)=>Qg(i,"name",{value:t,configurable:!0});class Ne{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}w(){return this.bb.readFloat32(this.bb_pos+12)}static sizeOf(){return 16}static createVec4(t,e,s,n,o){return t.prep(4,16),t.writeFloat32(o),t.writeFloat32(n),t.writeFloat32(s),t.writeFloat32(e),t.offset()}}Yg(Ne,"Vec4");var Jg=Object.defineProperty,Zg=(i,t)=>Jg(i,"name",{value:t,configurable:!0});class q{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsVrUserStateBuffer(t,e){return(e||new q).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsVrUserStateBuffer(t,e){return t.setPosition(t.position()+vr),(e||new q).__init(t.readInt32(t.position())+t.position(),t)}guid(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}time(){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readInt64(this.bb_pos+t):this.bb.createLong(0,0)}avatarId(t){const e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__string(this.bb_pos+e,t):null}position(t){const e=this.bb.__offset(this.bb_pos,10);return e?(t||new rt).__init(this.bb_pos+e,this.bb):null}rotation(t){const e=this.bb.__offset(this.bb_pos,12);return e?(t||new Ne).__init(this.bb_pos+e,this.bb):null}scale(){const t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readFloat32(this.bb_pos+t):0}posLeftHand(t){const e=this.bb.__offset(this.bb_pos,16);return e?(t||new rt).__init(this.bb_pos+e,this.bb):null}posRightHand(t){const e=this.bb.__offset(this.bb_pos,18);return e?(t||new rt).__init(this.bb_pos+e,this.bb):null}rotLeftHand(t){const e=this.bb.__offset(this.bb_pos,20);return e?(t||new Ne).__init(this.bb_pos+e,this.bb):null}rotRightHand(t){const e=this.bb.__offset(this.bb_pos,22);return e?(t||new Ne).__init(this.bb_pos+e,this.bb):null}static startVrUserStateBuffer(t){t.startObject(10)}static addGuid(t,e){t.addFieldOffset(0,e,0)}static addTime(t,e){t.addFieldInt64(1,e,t.createLong(0,0))}static addAvatarId(t,e){t.addFieldOffset(2,e,0)}static addPosition(t,e){t.addFieldStruct(3,e,0)}static addRotation(t,e){t.addFieldStruct(4,e,0)}static addScale(t,e){t.addFieldFloat32(5,e,0)}static addPosLeftHand(t,e){t.addFieldStruct(6,e,0)}static addPosRightHand(t,e){t.addFieldStruct(7,e,0)}static addRotLeftHand(t,e){t.addFieldStruct(8,e,0)}static addRotRightHand(t,e){t.addFieldStruct(9,e,0)}static endVrUserStateBuffer(t){return t.endObject()}static finishVrUserStateBufferBuffer(t,e){t.finish(e)}static finishSizePrefixedVrUserStateBufferBuffer(t,e){t.finish(e,void 0,!0)}}Zg(q,"VrUserStateBuffer");var Kg=Object.defineProperty,mn=(i,t)=>Kg(i,"name",{value:t,configurable:!0});const th=w("debugxr"),Vi=w("debugavatar");w("debugavatarvoip");var ze;(function(i){i.WebXR_UserJoined="webxr-user-joined",i.WebXR_UserLeft="webxr-user-left",i.VRSessionStart="vr-session-started",i.VRSessionEnd="vr-session-ended",i.VRSessionUpdate="vr-session-update"})(ze||(ze={}));var gn;(function(i){i.VR="vr",i.AR="ar"})(gn||(gn={}));const vo="VRUS";Ns(vo,q.getRootAsVrUserStateBuffer);function _n(){return new Date().getTime()}mn(_n,"getTimeStampNow");function eh(i){let t=i&4294967295,e=i/Math.pow(2,32)&1048575;return Wf.create(t,e)}mn(eh,"flatbuffers_long_from_number");const bs=class{constructor(t){r(this,"guid");r(this,"time");r(this,"avatarId");r(this,"position",new y);r(this,"rotation",new I);r(this,"scale",1);r(this,"posLeftHand",new y);r(this,"posRightHand",new y);r(this,"rotLeftHand",new P);r(this,"rotRightHand",new P);this.guid=t}update(t,e,s,n,o){var d,u,_,b,x,O;this.time=_n(),this.avatarId=o,this.position.set(e.x,e.y,e.z),t&&this.position.applyMatrix4(t.matrixWorld);let a=bs.quat0;const l=bs.quat1;a.set(s.x,s.y,s.z,s.w),a=a.multiplyQuaternions(a,bs.invertRotation),t&&(t.getWorldQuaternion(l),a.multiplyQuaternions(l,a)),this.rotation.set(a.x,a.y,a.z,a.w),this.scale=t.scale.x;const c=(d=n.LeftController)==null?void 0:d.controllerGrip;c&&(c.getWorldPosition(this.posLeftHand),c.getWorldQuaternion(this.rotLeftHand));const h=(u=n.RightController)==null?void 0:u.controllerGrip;if(h&&(h.getWorldPosition(this.posRightHand),h.getWorldQuaternion(this.rotRightHand)),(b=(_=n.LeftController)==null?void 0:_.hand)==null?void 0:b.visible){const R=n.LeftController.wrist;R&&(R.getWorldPosition(this.posLeftHand),R.getWorldQuaternion(this.rotLeftHand))}if((O=(x=n.RightController)==null?void 0:x.hand)==null?void 0:O.visible){const R=n.RightController.wrist;R&&(R.getWorldPosition(this.posRightHand),R.getWorldQuaternion(this.rotRightHand))}}sendAsBuffer(t,e){t.clear();const s=t.createString(this.guid),n=t.createString(this.avatarId);q.startVrUserStateBuffer(t),q.addGuid(t,s),q.addTime(t,eh(this.time)),q.addAvatarId(t,n),q.addPosition(t,rt.createVec3(t,this.position.x,this.position.y,this.position.z)),q.addRotation(t,Ne.createVec4(t,this.rotation.x,this.rotation.y,this.rotation.z,this.rotation.w)),q.addScale(t,this.scale),q.addPosLeftHand(t,rt.createVec3(t,this.posLeftHand.x,this.posLeftHand.y,this.posLeftHand.z)),q.addPosRightHand(t,rt.createVec3(t,this.posRightHand.x,this.posRightHand.y,this.posRightHand.z)),q.addRotLeftHand(t,Ne.createVec4(t,this.rotLeftHand.x,this.rotLeftHand.y,this.rotLeftHand.z,this.rotLeftHand.w)),q.addRotRightHand(t,Ne.createVec4(t,this.rotRightHand.x,this.rotRightHand.y,this.rotRightHand.z,this.rotRightHand.w));const o=q.endVrUserStateBuffer(t);t.finish(o,vo);const a=t.asUint8Array();e.sendBinary(a)}setFromBuffer(t,e){if(!t)return;this.guid=t,this.time=e.time().toFloat64();const s=e.avatarId();s&&(this.avatarId=s);const n=e.position();n&&this.position.set(n.x(),n.y(),n.z());const o=e.rotation();o&&this.rotation.set(o.x(),o.y(),o.z(),o.w());const a=e.posLeftHand();a&&this.posLeftHand.set(a.x(),a.y(),a.z());const l=e.posRightHand();l&&this.posRightHand.set(l.x(),l.y(),l.z());const c=e.rotLeftHand();c&&this.rotLeftHand.set(c.x(),c.y(),c.z(),c.w());const h=e.rotRightHand();h&&this.rotRightHand.set(h.x(),h.y(),h.z(),h.w()),this.scale=e.scale()}};let te=bs;r(te,"invertRotation",new P().setFromAxisAngle(new y(0,1,0),Math.PI)),r(te,"quat0",new P),r(te,"quat1",new P);mn(te,"VRUserState");class bn extends v{constructor(){super(...arguments);r(this,"webXR",null);r(this,"debugAvatarUser",null);r(this,"voip",null);r(this,"tempState",new te(""));r(this,"_removeAvatarsList",[]);r(this,"eventSub_ConnectionEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"eventSub_WebXRUpdateEvent",null);r(this,"avatars",{});r(this,"localAvatar",null);r(this,"k_LocalAvatarNoNetworkingGuid","local");r(this,"ownership",null);r(this,"xrState",null);r(this,"builder",new Ps(1024))}async awake(){if(this.webXR||(this.webXR=this.gameObject.getComponent(E)),this.webXR||(this.webXR=p.findObjectOfType(E,this.context)),!this.webXR&&(console.log("Missing webxr component"),this.webXR=p.findObjectOfType(E,this.context),!this.webXR)){console.error("Could not find webxr component");return}if(this.voip||(this.voip=p.findObjectOfType(_e,this.context)),Vi){const t="debug-avatar-"+Vi,e=new ye(this.context,t,this.webXR);if(this.debugAvatarUser=e,typeof Vi=="string"&&Vi.length>0)if(await e.setAvatarOverride(Vi)){const s=new te(t);s.position.y+=1;const n=.5;s.posLeftHand.y+=n,s.posLeftHand.x+=n,s.posRightHand.y+=n,s.posRightHand.x-=n,e.tryUpdate(s,0)}else e.destroy()}}onEnable(){if(!this.webXR&&(this.webXR=p.getComponent(this.gameObject,E),!this.webXR)){console.warn("Missing webxr component on "+this.gameObject.name);return}this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),E.addEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),this.eventSub_WebXRUpdateEvent=this.onXRSessionUpdate.bind(this),E.addEventListener(H.XRUpdate,this.eventSub_WebXRUpdateEvent),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),E.addEventListener(H.XRStopped,this.eventSub_WebXREndEvent),this.eventSub_ConnectionEvent=this.onConnected.bind(this),this.context.connection.beginListen(W.JoinedRoom,this.eventSub_ConnectionEvent),this.context.connection.beginListen(ze.WebXR_UserJoined,t=>{console.log("webxr user joined evt")}),this.context.connection.beginListen(ze.WebXR_UserLeft,t=>{const e=t.id!==null&&t.id!==void 0;if(!!e&&(console.log("webxr user left evt"),e)){const s=this.avatars[t.id];s==null||s.destroy(),this.avatars[t.id]=void 0}}),this.context.connection.beginListenBinrary(vo,t=>{const e=t.guid();if(!e)return;const s=t.time().toFloat64(),n=this.tempState;n.setFromBuffer(e,t);const o=this.onTryGetAvatar(e,s);o==null||o.tryUpdate(n,s)}),this.context.connection.beginListen(ze.VRSessionUpdate,t=>{const e=t.guid,s=t.time,n=this.onTryGetAvatar(e,s);n==null||n.tryUpdate(t,s)})}onTryGetAvatar(t,e){if(t===this.context.connection.connectionId)return null;const s=new Date().getTime()-e;if(s>5e3)return th&&console.log("old data",s,t),null;let n=this.avatars[t];if(n===void 0)try{console.log("create new avatar");const o=new ye(this.context,t,this.webXR);n=o,this.avatars[t]=o}catch(o){this.avatars[t]=null,console.error(o)}return n}onDisable(){this.eventSub_ConnectionEvent&&this.context.connection.stopListening(W.JoinedRoom,this.eventSub_ConnectionEvent),E.removeEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),E.removeEventListener(H.XRUpdate,this.eventSub_WebXRUpdateEvent),E.removeEventListener(H.XRStopped,this.eventSub_WebXREndEvent)}update(){const t=_n();this.debugAvatarUser&&(this.debugAvatarUser.lastUpdate=t),this.detectPotentiallyDisconnectedAvatarsAndRemove();for(const e in this.avatars){const s=this.avatars[e];!s||s.update()}}detectPotentiallyDisconnectedAvatarsAndRemove(){const t=_n();for(const e in this.avatars){const s=this.avatars[e];if(!s){this._removeAvatarsList.push(e);continue}t-s.lastUpdate>1e4&&(console.log("avatar timed out (didnt receive any updates in  a while) - destroying it now"),s.destroy(),this.avatars[e]=void 0)}for(const e of this._removeAvatarsList)delete this.avatars[e];this._removeAvatarsList.length=0}buildLocalAvatar(){var e,s;if(this.localAvatar)return;const t=(s=(e=this.context.connection)==null?void 0:e.connectionId)!=null?s:this.k_LocalAvatarNoNetworkingGuid;this.localAvatar=new ye(this.context,t,this.webXR),this.localAvatar.isLocalAvatar=!0,this.localAvatar.setAvatarOverride(this.getAvatarId()),this.avatars[this.localAvatar.guid]=this.localAvatar}onConnected(){var t,e,s;th&&console.log("Hey you are connected as "+this.context.connection.connectionId),((t=this.localAvatar)==null?void 0:t.guid)===this.k_LocalAvatarNoNetworkingGuid&&(this.localAvatar&&((e=this.localAvatar)==null||e.destroy(),this.avatars[this.localAvatar.guid]=void 0),this.localAvatar=null,this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null)}onXRSessionStart(t){var e,s,n;if(console.log("XR session started"),this.context.connection.send(ze.WebXR_UserJoined,{id:this.context.connection.connectionId,mode:gn.VR}),this.localAvatar&&((e=this.localAvatar)==null||e.destroy(),this.avatars[this.localAvatar.guid]=void 0,this.localAvatar=null),this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null,this.avatars)for(const o in this.avatars)(n=this.avatars[o])==null||n.updateFlags()}onXRSessionEnded(t){console.log("XR session ended"),this.context.connection.send(ze.WebXR_UserLeft,{id:this.context.connection.connectionId,mode:gn.VR})}onXRSessionUpdate(t){var h,d,u,_,b;(d=this.xrState)!=null||(this.xrState=new te((h=this.context.connection.connectionId)!=null?h:this.k_LocalAvatarNoNetworkingGuid)),(_=this.ownership)!=null||(this.ownership=new Ws(this.context.connection,(u=this.context.connection.connectionId)!=null?u:this.k_LocalAvatarNoNetworkingGuid)),this.ownership.guid=(b=this.context.connection.connectionId)!=null?b:this.k_LocalAvatarNoNetworkingGuid,this.buildLocalAvatar();const{frame:e,xr:s,rig:n}=t,o=e.getViewerPose(s.getReferenceSpace());if(!o)return;const a=o==null?void 0:o.transform,l=a.position,c=a.orientation;this.xrState.update(n,l,c,this.webXR,this.getAvatarId()),this.localAvatar&&(this.context.connection.connectionId&&(this.localAvatar.guid=this.context.connection.connectionId),this.localAvatar.tryUpdate(this.xrState,0)),!(this.ownership&&!this.ownership.hasOwnership&&this.context.connection.isConnected&&(this.context.time.frameCount%120==0&&this.ownership.requestOwnership(),!this.ownership.hasOwnership))&&(!this.context.connection.isConnected||!this.context.connection.connectionId||this.xrState.sendAsBuffer(this.builder,this.context.connection))}getAvatarId(){return w("avatar")}}mn(bn,"WebXRSync");var ih=Object.defineProperty,t_=Object.getOwnPropertyDescriptor,sh=(i,t)=>ih(i,"name",{value:t,configurable:!0}),e_=(i,t,e,s)=>{for(var n=s>1?void 0:s?t_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&ih(t,e,n),n},H;(function(i){i.XRStarted="xrStarted",i.XRStopped="xrStopped",i.XRUpdate="xrUpdate",i.RequestVRSession="requestVRSession"})(H||(H={}));var lr;const X=(lr=class extends v{constructor(){super(...arguments);r(this,"enableVR",!0);r(this,"enableAR",!0);r(this,"defaultAvatar");r(this,"createVRButton",!0);r(this,"createARButton",!0);r(this,"controllers",[]);r(this,"rig");r(this,"isInit",!1);r(this,"_requestedAR",!1);r(this,"_requestedVR",!1);r(this,"_isInAR",!1);r(this,"_isInVR",!1);r(this,"_arButton");r(this,"_vrButton");r(this,"webAR",null);r(this,"_transformOrientation",new P);r(this,"_currentHeadPose",null);r(this,"_originalCameraParent",null);r(this,"_originalCameraPosition",new y);r(this,"_originalCameraRotation",new P);r(this,"xrMirrorWindow",null)}static get XRSupported(){return"xr"in navigator}static get IsInWebXR(){return this._isInXr}static addEventListener(i,t){this.events.addEventListener(i,t)}static removeEventListener(i,t){this.events.removeEventListener(i,t)}static createVRButton(i,t){var s;X.XRSupported||console.warn("WebXR is not supported on this device");const e=rn.createButton(i.context.renderer);return e.classList.add("webxr-ar-button"),e.classList.add("webxr-button"),this.resetButtonStyles(e),((s=t==null?void 0:t.registerClick)!=null?s:!0)&&e.addEventListener("click",i.onClickedVRButton.bind(i)),e}static createARButton(i,t){var o,a;const e=(o=i.webAR)==null?void 0:o.trySetupOverlay(),s={requiredFeatures:["hit-test"]};e&&(s.domOverlay={root:e},s.optionalFeatures=["dom-overlay"]);const n=jg.createButton(i.context.renderer,s);return n.classList.add("webxr-ar-button"),n.classList.add("webxr-button"),X.resetButtonStyles(n),((a=t==null?void 0:t.registerClick)!=null?a:!0)&&n.addEventListener("click",i.onClickedARButton.bind(i)),n}static resetButtonStyles(i){!i||(i.style.position="",i.style.bottom="",i.style.left="")}endSession(){const i=this.context.renderer.xr.getSession();i&&i.end()}get Rig(){return this.rig}get Controllers(){return this.controllers}get LeftController(){var i,t;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="left"?this.controllers[0]:this.controllers.length>1&&((t=this.controllers[1].input)==null?void 0:t.handedness)==="left"?this.controllers[1]:null}get RightController(){var i,t;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="right"?this.controllers[0]:this.controllers.length>1&&((t=this.controllers[1].input)==null?void 0:t.handedness)==="right"?this.controllers[1]:null}awake(){if(this.defaultAvatar&&typeof this.defaultAvatar=="string"&&(this.defaultAvatar=Bt.getOrCreate(this.defaultAvatar,this.context)),!p.findObjectOfType(bn,this.context)){const i=p.addNewComponent(this.gameObject,bn,!1);i.webXR=this}}onEnable(){if(this.isInit||!this.enableAR&&!this.enableVR)return;this.isInit=!0,this.context.renderer.xr.enabled=!0,this.webAR=new wo(this);const i=X.XRSupported;let t,e;const s=document.createElement("div");s.classList.add("webxr-buttons"),this.context.domElement.append(s),this.enableAR&&this.createARButton&&(t=X.createARButton(this),this._arButton=t,s.appendChild(t)),this.createVRButton&&this.enableVR&&(i||!this.enableAR)&&(e=X.createVRButton(this),this._vrButton=e,s.appendChild(e)),setTimeout(()=>{X.resetButtonStyles(e),X.resetButtonStyles(t)},1e3)}get TransformOrientation(){return this._transformOrientation}get HeadPose(){return this._currentHeadPose}onBeforeRender(i){var e;if(!i)return;const t=this.context.renderer.xr.getSession();if(t){const s=i.getViewerPose(this.context.renderer.xr.getReferenceSpace());if(this._currentHeadPose=s,!s)return;const n=s==null?void 0:s.transform;n&&this._transformOrientation.set(n.orientation.x,n.orientation.y,n.orientation.z,n.orientation.w);for(const o of this.controllers)o.onUpdate(t);this._isInAR&&((e=this.webAR)==null||e.onUpdate(t,i))}X._isInXr===!1&&t&&this.onEnterXR(t,i),X.events.dispatchEvent({type:H.XRUpdate,frame:i,xr:this.context.renderer.xr,rig:this.rig})}onClickedARButton(){this._isInAR||(this._requestedAR=!0,this._requestedVR=!1,this.captureCameraState())}onClickedVRButton(){if(!this._isInVR){if(this._requestedVR){this.onExitXR(null);return}this._requestedAR=!1,this._requestedVR=!0,this.captureCameraState(),this.ensureRig();for(let i=0;i<2;i++)j.Create(this,i,this.gameObject,un.PhysicalDevice);X.events.dispatchEvent({type:H.RequestVRSession})}}captureCameraState(){this.context.mainCamera&&(this._originalCameraPosition.copy(C(this.context.mainCamera)),this._originalCameraRotation.copy(J(this.context.mainCamera)),this._originalCameraParent=this.context.mainCamera.parent)}ensureRig(){if(!this.rig){const i=p.findObjectOfType(bo,this.context);i?(this.rig=i.gameObject,this.rig.rotateY(Math.PI)):(this.rig=new Vf,this.rig.name="XRRig",this.context.scene.add(this.rig))}}onEnterXR(i,t){var o;console.log("[XR] session begin",i),X._isInXr=!0,this.ensureRig();const e=this.context.renderer.xr.getReferenceSpace();if(e&&this.rig){const a=t.getViewerPose(e),l=a==null?void 0:a.transform.orientation;if(l){const c=new P(l.x,l.y,l.z,l.w),h=new Pt().setFromQuaternion(c);this.rig.rotateY(h.y)}}const s=this.context.renderer.xr;if(this.context.mainCamera){const a=s.getCamera(this.context.mainCamera);for(const l of a.cameras)l.layers.enableAll();this.rig.add(this.context.mainCamera)}const n=this._requestedAR?Y.AR:Y.VR;switch(Kt.Global.Set(n),n){case Y.AR:this._isInAR=!0,(o=this.webAR)==null||o.onBegin(i);break;case Y.VR:this._isInVR=!0,this.onEnterVR(i);break}i.addEventListener("end",()=>{console.log("[XR] session end"),X._isInXr=!1,this.onExitXR(i)}),this.onEnterXR_HandleMirrorWindow(i),X.events.dispatchEvent({type:H.XRStarted,session:i})}onExitXR(i){var t,e;this._isInAR&&i&&((t=this.webAR)==null||t.onEnd(i)),this._isInAR=!1,this._isInVR=!1,this._requestedAR=!1,this._requestedVR=!1,this.xrMirrorWindow&&(this.xrMirrorWindow.close(),this.xrMirrorWindow=null),this.destroyControllers(),this.context.mainCamera&&((e=this._originalCameraParent)==null||e.add(this.context.mainCamera),D(this.context.mainCamera,this._originalCameraPosition),Z(this.context.mainCamera,this._originalCameraRotation),this.context.mainCamera.scale.set(1,1,1)),Kt.Global.Set(Y.Browser|Y.ThirdPerson),X.events.dispatchEvent({type:H.XRStopped,session:i})}onEnterVR(i){}destroyControllers(){var i;for(let t=this.controllers.length-1;t>=0;t-=1)(i=this.controllers[t])==null||i.destroy();this.controllers.length=0}onEnterXR_HandleMirrorWindow(i){!w("mirror")||setTimeout(()=>{if(!X.IsInWebXR)return;const t=new URL(window.location.href);ki(t.searchParams,an,1),ki(t.searchParams,"isMirror",1);const e=t.toString();this.xrMirrorWindow=window.open(e,"webxr sync","popup=yes"),this.xrMirrorWindow&&(this.xrMirrorWindow.onload=()=>{this.xrMirrorWindow&&(this.xrMirrorWindow.onbeforeunload=()=>{X.IsInWebXR&&i.end()})})},1e3)}},r(lr,"_isInXr",!1),r(lr,"events",new Gf),lr);let E=X;sh(E,"WebXR");e_([g(Bt)],E.prototype,"defaultAvatar",2);class wo{constructor(t){r(this,"webxr");r(this,"reticle",null);r(this,"hitTestSource",null);r(this,"reticleActive",!0);r(this,"previousBackground",null);r(this,"previousEnvironment",null);r(this,"sessionRoot",null);r(this,"_previousParent",null);r(this,"arDomOverlay",null);r(this,"arOverlayElement",null);this.webxr=t}get context(){return this.webxr.context}trySetupOverlay(){return this.arDomOverlay=this.webxr.context.domElement,"getAROverlayContainer"in this.arDomOverlay&&(this.arOverlayElement=this.arDomOverlay.getAROverlayContainer()),this.arOverlayElement}setReticleActive(t){this.reticleActive=t}onBegin(t){var s,n;const e=this.webxr.context;this.reticleActive=!0;for(let o=0;o<4;o++)j.Create(this.webxr,o,this.webxr.gameObject,un.Touch);(!this.sessionRoot||this.sessionRoot.destroyed||!this.sessionRoot.activeAndEnabled)&&(this.sessionRoot=p.findObjectOfType(pn,e)),this.previousBackground=e.scene.background,this.previousEnvironment=e.scene.environment,e.scene.background=null,t.requestReferenceSpace("viewer").then(o=>{t.requestHitTestSource({space:o}).then(a=>{this.hitTestSource=a})}),this.reticle||(this.reticle=new Je(new Hf(.07,.09,32).rotateX(-Math.PI/2),new Ci),this.reticle.name="AR Placement reticle",this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.webxr.scene?(this.webxr.scene.add(this.reticle),this.webxr.scene.visible=!0):console.warn("Could not found WebXR Rig")),this._previousParent=this.webxr.gameObject,this.context.scene.add(this.webxr.gameObject),this.sessionRoot&&(this.sessionRoot.webAR=this,(s=this.sessionRoot)==null||s.onBegin(t)),this.arDomOverlay&&this.arOverlayElement&&this.arDomOverlay.onEnterAR(t,this.arOverlayElement),(n=this.context.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}onEnd(t){var s;this._previousParent&&(this._previousParent!==this.webxr.gameObject&&this._previousParent.add(this.webxr.gameObject),this._previousParent=null),this.hitTestSource=null;const e=this.webxr.context;e.scene.background=this.previousBackground,e.scene.environment=this.previousEnvironment,this.sessionRoot&&this.sessionRoot.onEnd(this.webxr.Rig,t),this.arDomOverlay&&this.arDomOverlay.onExitAR(t),(s=this.context.mainCameraComponent)==null||s.applyClearFlagsIfIsActiveCamera()}onUpdate(t,e){var n,o;if(!this.hitTestSource)return;const s=e.getHitTestResults(this.hitTestSource);if(s.length){const a=s[0],l=this.webxr.context.renderer.xr.getReferenceSpace();if(l){const c=a.getPose(l);if((n=this.sessionRoot)==null||n.onUpdate(this.webxr.Rig,t,c),this.reticle&&(this.reticle.visible=this.reticleActive,this.reticleActive&&c)){const h=c.transform.matrix;this.reticle.matrix.fromArray(h),this.webxr.Rig&&this.reticle.matrix.premultiply(this.webxr.Rig.matrix)}}}else(o=this.sessionRoot)==null||o.onUpdate(this.webxr.Rig,t,null),this.reticle&&(this.reticle.visible=!1)}}sh(wo,"WebAR");var i_=Object.defineProperty,nh=(i,t)=>i_(i,"name",{value:t,configurable:!0}),qi;(function(i){i.SelectStart="selectstart",i.SelectEnd="selectend"})(qi||(qi={}));const wi=class extends Wi{constructor(){super();r(this,"transformSelf",!0);r(this,"selectStartEventListener",[]);r(this,"selectEndEventListener",[]);r(this,"_dragHelper",null);r(this,"_draggingRigidbodies",[]);r(this,"_waitingForDragStart",null);r(this,"_isDragging",!1);r(this,"_marker",null);r(this,"_dragDelta");r(this,"_didDrag",!1);this.selectStartEventListener=[],this.selectEndEventListener=[],this._dragDelta=new V}static get HasAnySelected(){return this._active!==null}addEventListener(t,e){switch(t){case qi.SelectStart:this.selectStartEventListener.push(e);break;case qi.SelectEnd:this.selectEndEventListener.push(e);break}}start(){}allowEdit(t=null){return this.context.connection.allowEditing}onPointerEnter(t){if(!this.allowEdit(this.gameObject)||E.IsInWebXR)return;const e=p.getComponentInParent(t.object,wi);!e||e!==this||(wi.lastHovered=t.object,this.context.domElement.style.cursor="pointer")}onPointerExit(t){!this.allowEdit(this.gameObject)||E.IsInWebXR||wi.lastHovered===t.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(t){!this.allowEdit(this.gameObject)||E.IsInWebXR||(this._dragDelta.set(0,0),this._didDrag=!1,this._waitingForDragStart=t,t.StopPropagation())}onPointerUp(t){this._waitingForDragStart=null,!!this.allowEdit(this.gameObject)&&(E.IsInWebXR||(this.onDragEnd(t),t.StopPropagation()))}update(){var t;if(!E.IsInWebXR){if(this._waitingForDragStart){if(!this._didDrag){const s=this.context.input.getPointerPositionDelta(0);if(s&&this._dragDelta.add(s),this._dragDelta.length()>2)this._didDrag=!0;else return}const e=this._waitingForDragStart;this._waitingForDragStart=null,this.onDragStart(e)}this._dragHelper&&this._dragHelper.hasSelected&&this.onUpdateDrag(),this._isDragging&&!((t=this._dragHelper)==null?void 0:t.hasSelected)&&this.onDragEnd(null)}}onDragStart(t){if(!this._dragHelper)if(this.context.mainCamera)this._dragHelper=new yn(this.context.mainCamera);else return;if(!t||!t.object)return;const e=p.getComponentInParent(t.object,wi);if(!e||e!==this)return;let s=t.object;this.transformSelf&&(s=this.gameObject);const n={selected:s,attached:s};for(const c of this.selectStartEventListener)c(this,n);if(!n.attached)return;n.attached!==s,s=n.attached,this._isDragging=!0,this._dragHelper.setSelected(s,this.context);const o=p.getComponentInChildren(s,ge);o&&(o.fastMode=!0,o==null||o.requestOwnership()),this._marker=p.addNewComponent(s,Hi),this._draggingRigidbodies.length=0;const a=p.getComponentsInChildren(s,Rt);a&&this._draggingRigidbodies.push(...a);const l=Pr();p.invokeOnChildren(this._dragHelper.selected,l("onDragStart"))}onUpdateDrag(){if(!!this._dragHelper){this._dragHelper.onUpdate(this.context);for(const t of this._draggingRigidbodies)t.wakeUp(),t.setBodyFromGameObject()}}onDragEnd(t){if(!this||!this._isDragging||(this._isDragging=!1,!this._dragHelper))return;this._draggingRigidbodies.length=0;const e=this._dragHelper.selected;if(this._dragHelper.setSelected(null,this.context),t==null?void 0:t.object){const n=p.getComponentInChildren(t.object,ge);n&&(n.fastMode=!1),this._marker&&this._marker.destroy()}for(const n of this.selectEndEventListener)n(this);const s=Pr();p.invokeOnChildren(e,s("onDragEnd"))}};let ve=wi;r(ve,"_active",null),r(ve,"lastHovered");nh(ve,"DragControls");const Sa=class{constructor(t){r(this,"_selected",null);r(this,"_context",null);r(this,"_camera");r(this,"_cameraPlane",new Wa);r(this,"_hasGroundPlane",!1);r(this,"_groundPlane",new Wa);r(this,"_groundOffset",new y);r(this,"_groundOffsetFactor",0);r(this,"_groundDistance",0);r(this,"_groundPlanePoint",new y);r(this,"_raycaster",new pr);r(this,"_cameraPlaneOffset",new y);r(this,"_intersection",new y);r(this,"_worldPosition",new y);r(this,"_inverseMatrix",new Ot);r(this,"_rbs",[]);r(this,"_groundLine");r(this,"_groundMarker");r(this,"_groundOffsetVector",new y(0,1,0));r(this,"_requireUpdateGroundPlane",!0);r(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=t;const e=new Na(Sa.geometry),s=e.material;s.color=new f(.4,.4,.4),e.layers.set(2),e.name="line",e.scale.y=1,this._groundLine=e;const n=new za(.5,22,22),o=new Ci({color:s.color}),a=new Je(n,o);a.visible=!1,a.layers.set(2),this._groundMarker=a}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(t,e){if(this._selected&&e)for(const s of this._rbs)s.wakeUp(),!!s.smoothedVelocity&&s.setVelocity(s.smoothedVelocity.x,s.smoothedVelocity.y,s.smoothedVelocity.z);if(this._selected&&at.Remove(e,this._selected),this._selected=t,this._context=e,this._rbs.length=0,t?(e.scene.add(this._groundLine),e.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!e){console.error("DragHelper: no context");return}at.Add(e,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this._rbs=p.getComponentsInChildren(this._selected,Rt),this.onUpdateScreenSpacePlane()}}onUpdate(t){var l,c,h,d,u;if(!this._context)return;const e=Xt.SPACE,s=Xt.KEY_D;Xt.KEY_S;const n=((l=this._context)==null?void 0:l.input.isKeyPressed(e))||((c=this._context)==null?void 0:c.input.isKeyPressed(s)),o=this._context.input.getTouchesPressedCount()>=2||n;if(o){const _=this._context.input.getPointerPositionDelta(0);_&&(this._groundOffsetVector.set(0,1,0),(h=this._selected)==null||h.rotateOnWorldAxis(this._groundOffsetVector,_.x*this._context.time.deltaTime))}const a=this._context.input.getPointerPositionRC(0);if(!!a&&(this._raycaster.setFromCamera(a,this._camera),this._selected)){this._groundOffsetVector.set(0,1,0);const _=C(this._camera).clone().sub(C(this._selected)).normalize(),b=Math.abs(_.dot(this._groundOffsetVector)),x=((d=this._context)==null?void 0:d.input.isKeyPressed(e))||((u=this._context)==null?void 0:u.input.isKeyPressed(s)),O=!o&&b>.2&&!x&&this._context.input.getPointerPressedCount()<=1,R=this._didDragOnGroundPlaneLastFrame!==O;if(this._didDragOnGroundPlaneLastFrame=O,this._hasGroundPlane||(this._requireUpdateGroundPlane=!0),(this._requireUpdateGroundPlane||!O||R)&&this.onUpdateGroundPlane(),this._requireUpdateGroundPlane=!1,this._hasGroundPlane)if(this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection)){const M=this._intersection.y;if(this._groundPlanePoint.copy(this._intersection).sub(this._groundOffset),this._groundPlanePoint.y=M,O){this._groundOffsetVector.set(0,1,0);const lt=this._intersection.sub(this._groundOffset).add(this._groundOffsetVector.multiplyScalar(this._groundOffsetFactor));this.onUpdateWorldPosition(lt,this._groundPlanePoint,!1),this.onDidUpdate();return}}else this._groundPlanePoint.set(0,99999,0);R&&this.onUpdateScreenSpacePlane(),this._requireUpdateGroundPlane=!0,this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&(this.onUpdateWorldPosition(this._intersection.sub(this._cameraPlaneOffset),this._groundPlanePoint,!0),this.onDidUpdate())}}onUpdateWorldPosition(t,e,s){if(!!this._selected){if(s){const n=C(this._selected);n.y=t.y,t=n}if(D(this._selected,t),D(this._groundLine,t),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundMarker.visible=e!==null,e){const n=C(this._camera).distanceTo(e)*.01;this._groundMarker.scale.set(n,n,n),D(this._groundMarker,e)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const t=this._context.input.getPointerPositionRC(0);!t||(this._raycaster.setFromCamera(t,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const t=C(this._selected),e=new $a(new y(0,.1,0).add(t),new y(0,-1,0)),s=new Dt;s.ignore=[this._selected];const n=this._context.physics.raycastFromRay(e,s);for(let o=0;o<n.length;o++){const a=n[o];if(!a.face||this.contains(this._selected,a.object))continue;const l=new y(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,a.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(e.direction.multiplyScalar(-1),e.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(t),this._groundOffset.copy(this._intersection).sub(t)}onDidUpdate(){ht.markDirty(this._selected);for(const t of this._rbs)t.wakeUp(),t.setBodyFromGameObject({x:0,y:0,z:0}),t.setAngularVelocity(0,0,0)}contains(t,e){if(t===e)return!0;if(t.children){for(const s of t.children)if(this.contains(s,e))return!0}return!1}};let yn=Sa;r(yn,"geometry",new Os().setFromPoints([new y(0,0,0),new y(0,-1,0)]));nh(yn,"DragHelper");var rh=Object.defineProperty,s_=Object.getOwnPropertyDescriptor,oh=(i,t)=>rh(i,"name",{value:t,configurable:!0}),ah=(i,t,e,s)=>{for(var n=s>1?void 0:s?s_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&rh(t,e,n),n},xo;(function(i){i.ObjectAdded="object-added"})(xo||(xo={}));class lh extends v{constructor(){super(...arguments);r(this,"_listeners",{})}addEventListener(t,e,s){!e||(this._listeners[t]=this._listeners[t]||[],this._listeners[t].push(e))}dispatchEvent(t){if(!t||!this._listeners[t.type])return!1;for(const e of this._listeners[t.type])"handleEvent"in e?e.handleEvent(t):e(t);return!0}removeEventListener(t,e,s){!e||!this._listeners[t]||(this._listeners[t]=this._listeners[t].filter(n=>n!==e))}}oh(lh,"EventTargetBehaviour");class vn extends lh{constructor(){super(...arguments);r(this,"filesBackendUrl");r(this,"localhost");r(this,"_dragOver");r(this,"_drop")}onEnable(){this.filesBackendUrl=this.filesBackendUrl?je.GetUrl(this.filesBackendUrl,this.localhost):void 0,this._dragOver=this.onDrag.bind(this),this._drop=this.onDrop.bind(this),this.context.domElement.addEventListener("dragover",this._dragOver),this.context.domElement.addEventListener("drop",this._drop)}onDisable(){this.context.domElement.removeEventListener("dragover",this._dragOver),this.context.domElement.removeEventListener("drop",this._drop)}onDrag(t){t.preventDefault()}async onDrop(t){if(console.log(t),!t.dataTransfer)return;t.preventDefault();const e=t.dataTransfer.items;if(!!e)for(const s in e){const n=e[s];if(n.kind==="file"){const o=n.getAsFile();if(!o)continue;console.log("Register file "+o.name+" to",this.filesBackendUrl);const a=await Yu(o,this.context,this.filesBackendUrl);a&&this.addObject(t,a)}else n.kind==="string"&&n.type=="text/plain"&&n.getAsString(async o=>{console.log("dropped url",o);try{const a=new URL(o);if(!a)return;const l=await Ju(a,this.context);l&&this.addObject(t,l)}catch{console.log("dropped string is not a valid URL!",o)}})}}async addObject(t,e){const s=new Dt;s.setMask(16777215),s.screenPointFromOffset(t.offsetX,t.offsetY);const n=this.context.physics.raycast(s);if(n&&n.length>0)for(const o of n){e.position.copy(o.point);break}this.gameObject.add(e),this.dispatchEvent(new CustomEvent(xo.ObjectAdded,{detail:e}))}}oh(vn,"DropListener");ah([g()],vn.prototype,"filesBackendUrl",2);ah([g()],vn.prototype,"localhost",2);var ch=Object.defineProperty,n_=Object.getOwnPropertyDescriptor,r_=(i,t)=>ch(i,"name",{value:t,configurable:!0}),wn=(i,t,e,s)=>{for(var n=s>1?void 0:s?n_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&ch(t,e,n),n};class ai extends Wi{constructor(){super(...arguments);r(this,"parent",null);r(this,"object",null);r(this,"limitCount",10);r(this,"limitInterval",60);r(this,"_currentCount",0);r(this,"_startPosition",null);r(this,"_startQuaternion",null)}awake(){var e,s,n,o;if(this.object){if(this.object===this.gameObject){console.error("Can not duplicate self");return}this.object.visible=!1,this._startPosition=(s=(e=this.object.position)==null?void 0:e.clone())!=null?s:new y(0,0,0),this._startQuaternion=(o=(n=this.object.quaternion)==null?void 0:n.clone())!=null?o:new P(0,0,0,1)}const t=p.getComponentInParent(this.gameObject,ve);t?t.addEventListener(qi.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.attached=null;return}const c=this.handleDuplication(l.selected);c&&(console.assert(c!==l.selected,"Duplicated object is original"),l.attached=c)}):console.warn("Could no find drag controls in parent",this.name),j.addEventListener(ft.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.grab=null;return}const c=this.handleDuplication(l.selected);c&&(l.grab=c)}),this.cloneLimitIntervalFn()}cloneLimitIntervalFn(){this.destroyed||(this._currentCount>0&&(this._currentCount-=1),setTimeout(()=>{this.cloneLimitIntervalFn()},this.limitInterval/this.limitCount*1e3))}handleDuplication(t){var e,s;if(this._currentCount>=this.limitCount||!this.object)return null;if(t===this.gameObject||this.handleMultiObject(t)){if(this.object===this.gameObject)return null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const n=new Ct;this.parent||(this.parent=this.gameObject.parent),this.parent&&(n.parent=(s=this.parent.guid)!=null?s:(e=this.parent.userData)==null?void 0:e.guid,n.keepWorldPosition=!0),n.position=this.worldPosition,n.rotation=this.worldQuaternion,n.context=this.context,this._currentCount+=1;const o=p.instantiateSynced(this.object,n);return console.assert(o!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),o}return null}handleMultiObject(t){return this.gameObject.type==="Group"||this.gameObject.type==="Object3D"?this.isInChildren(this.gameObject,t):!1}isInChildren(t,e){if(!t)return!1;if(t===e)return!0;if(t.children){for(let s of t.children)if(this.isInChildren(s,e))return!0}return!1}}r_(ai,"Duplicatable");wn([g(S)],ai.prototype,"parent",2);wn([g(S)],ai.prototype,"object",2);wn([g()],ai.prototype,"limitCount",2);wn([g()],ai.prototype,"limitInterval",2);var o_=Object.defineProperty,hh=(i,t)=>o_(i,"name",{value:t,configurable:!0});class Xi{constructor(t,e){r(this,"method");r(this,"enabled");this.method=t,this.enabled=e!==void 0?e:!0}invoke(...t){if(this.enabled!==!1){if(!this.method){console.warn("No function. Please check you assigned a method to invoke on export",this);return}this.method(...t)}}}hh(Xi,"CallInfo");class ee{constructor(t){r(this,"methods",[]);this.methods=t!=null?t:[]}invoke(...t){for(const e of this.methods)e.invoke(...t)}addEventListener(t){return this.methods.push(new Xi(t,!0)),t}removeEventListener(t){if(!!t)for(let e=this.methods.length-1;e>=0;e--)this.methods[e].method===t&&(this.methods[e].enabled=!1,this.methods.splice(e,1))}removeAllEventListeners(){this.methods.length=0}}hh(ee,"EventList");var a_=Object.defineProperty,l_=(i,t)=>a_(i,"name",{value:t,configurable:!0});class dh extends v{}l_(dh,"EventTrigger");var c_=Object.defineProperty,h_=(i,t)=>c_(i,"name",{value:t,configurable:!0});class uh extends v{constructor(){super(...arguments);r(this,"_controls",null)}onEnable(){var e;const t=(e=p.getComponent(this.gameObject,U))==null?void 0:e.cam;this._controls=new qf(t,this.context.renderer.domElement),this._controls.rollSpeed=.5,this._controls.movementSpeed=3,this._controls.dragToLook=!0}onDisable(){var t;(t=this._controls)==null||t.dispose(),this._controls=null}update(){this._controls&&this._controls.update(this.context.time.deltaTime)}}h_(uh,"FlyControls");var fh=Object.defineProperty,d_=Object.getOwnPropertyDescriptor,u_=(i,t)=>fh(i,"name",{value:t,configurable:!0}),ph=(i,t,e,s)=>{for(var n=s>1?void 0:s?d_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&fh(t,e,n),n};class xn extends v{constructor(){super(...arguments);r(this,"objectBounds",!1);r(this,"color");r(this,"_gizmoObject",null);r(this,"_boxHelper",null)}onEnable(){var t,e;!Mi||(this._gizmoObject||(this.objectBounds&&this.gameObject.isMesh===!0?this._gizmoObject=new Ha(this.gameObject,(t=this.color)!=null?t:16776960):(this.objectBounds=!1,this._gizmoObject=ho((e=this.color)!=null?e:16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),xt.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var t;for(;this._boxHelper;)(t=this._boxHelper)==null||t.update(),yield}}u_(xn,"BoxGizmo");ph([g()],xn.prototype,"objectBounds",2);ph([g(f)],xn.prototype,"color",2);class f_{constructor(t){this.writer=t,this.name="EXT_mesh_gpu_instancing"}writeNode(t,e){if(t.constructor.name!=="InstancedMesh")return;const s=this.writer,n=s.extensionsUsed,o={};e.extensions=e.extensions||{},e.extensions[this.name]=o;let a=new Ot;const l=new Array,c=new Array,h=new Array;for(let b=0;b<t.count;b++){t.getMatrixAt(b,a);let x=new y,O=new P,R=new y;a.decompose(x,O,R),l.push(x.x,x.y,x.z),c.push(O.x,O.y,O.z,O.w),h.push(R.x,R.y,R.z)}const d=new Float32Array(l),u=new Float32Array(c),_=new Float32Array(h);o.attributes={TRANSLATION:s.processAccessor(new Si(d,3)),ROTATION:s.processAccessor(new Si(u,4)),SCALE:s.processAccessor(new Si(_,3))},n[this.name]=!0}}var p_=Object.defineProperty,Po=(i,t)=>p_(i,"name",{value:t,configurable:!0});const we=yt,Pn="$___Export_Components",m_="NEEDLE_components";var pv;class mh{constructor(){r(this,pv)}}pv=Ze;Po(mh,"ExtensionData");class gh{constructor(t,e,s){r(this,"node");r(this,"nodeIndex");r(this,"nodeDef");this.node=t,this.nodeIndex=e,this.nodeDef=s}}Po(gh,"ExportData");class Oo{constructor(){r(this,"parser");r(this,"nodeToObjectMap",{});r(this,"exportContext");r(this,"objectToNodeMap",{});r(this,"context");r(this,"writer")}get name(){return m_}registerExport(t){t.register(e=>{const s=e.serializeUserData.bind(e);return this.writer=e,e.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o),s(n,o)}finally{this.afterSerializeUserData(n,o)}},this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(t,e){var n;const s=(n=t.userData)==null?void 0:n.components;!s||s.length<=0||(delete t.userData.components,t[Pn]=s)}afterSerializeUserData(t,e){if(t.type==="Scene"&&we&&console.log("DONE",JSON.stringify(e)),t[Pn]===void 0)return;const s=t[Pn];delete t[Pn],s!==null&&(t.userData.components=s)}writeNode(t,e){let s=this.writer.json.nodes.length;console.log(t.name,s,t.uuid);const n=new gh(t,s,e);this.exportContext[s]=n,this.objectToNodeMap[t.uuid]=s}afterParse(t){var e;we&&console.log("AFTER",t);for(const s in this.exportContext){const n=this.exportContext[s],o=n.node,a=n.nodeDef,l=n.nodeIndex,c=(e=o.userData)==null?void 0:e.components;if(!c||c.length<=0)continue;const h=new mh;a.extensions=a.extensions||{},a.extensions[this.name]=h,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const d=[];for(const u of c){this.context.target=u;const _=_u(u,this.context);_!==null&&d.push(_)}d.length>0&&(h[Ze]=d,we&&console.log("DID WRITE",o,"nodeIndex",l,d))}}beforeRoot(){return we&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(t){const e=t.parser,s=e==null?void 0:e.extensions;if(!s)return;const n=s[this.name];we&&console.log("After root",t,this.parser,s);const o=[];if(n===!0){const a=e.json.nodes;for(let l=0;l<a.length;l++){const c=await e.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<a.length;l++){const c=a[l],h=l,d=c.extensions;if(!d)continue;const u=d[this.name];if(!u)continue;we&&console.log("NODE",c);const _=this.nodeToObjectMap[h];if(!_){console.error("Could not find object for node index: "+h,c,e);continue}o.push(this.createComponents(_,u))}}await Promise.all(o)}async createComponents(t,e){if(!e)return;const s=e[Ze];if(s){we&&console.log(t.name,s);for(const n in s){const o=s[n];we&&console.log("Serialized data",JSON.parse(JSON.stringify(o))),o&&this.parser&&await qs(this.parser,o),t.userData=t.userData||{},t.userData[Ze]=t.userData[Ze]||[],t.userData[Ze].push(o)}}}}Po(Oo,"NEEDLE_components");var g_=Object.defineProperty,_h=(i,t)=>g_(i,"name",{value:t,configurable:!0});class bh extends $i{constructor(){super(...arguments);r(this,"sceneRoot")}start(){this.startCoroutine(this.updateGltfBox())}*updateGltfBox(){for(;;)for(let t=0;t<10;t++)yield}}_h(bh,"GltfExportBox");class xe extends v{constructor(){super(...arguments);r(this,"binary",!0);r(this,"objects",[]);r(this,"exporter");r(this,"ext")}async exportNow(t){console.log("DO EXPORT",this.objects);const e={binary:this.binary,pivot:xe.calculateCenter(this.objects)},s=await this.export(this.objects,e);this.binary?t.endsWith(".glb")||(t+=".glb"):t.endsWith(".gltf")||(t+=".gltf"),this.binary?xe.saveArrayBuffer(s,t):xe.saveJson(s,t)}async export(t,e){var l;if(t===null||t.length<=0){console.log("no objects set to export");return}this.exporter||(this.exporter=new Xf,this.exporter.register(c=>new f_(c)),this.ext=new Oo,this.ext.registerExport(this.exporter)),xe.filterTopmostParent(t);const s={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:(l=e==null?void 0:e.binary)!=null?l:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:xe.collectAnimations(t)},n=new S;(e==null?void 0:e.pivot)&&n.position.sub(e.pivot),console.log("EXPORT",t),t.forEach(c=>{c&&(n.children.push(c),c.matrixAutoUpdate=!1,c.matrix.copy(c.matrixWorld),p.getComponentsInChildren(c,bt).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))});const o=new to(n);return this.ext.context=o,new Promise((c,h)=>{var d;try{(d=this.exporter)==null||d.parse(n,u=>{a(),c(u)},u=>{a(),h(u)},s)}catch(u){console.error(u),h(u)}finally{console.log("FINALLY")}});function a(){t.forEach(c=>{!c||(c.matrixAutoUpdate=!0,p.getComponentsInChildren(c,bt).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(t,e){this.save(new Blob([t],{type:"application/octet-stream"}),e)}static saveJson(t,e){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t)),e)}static save(t,e){const s=document.createElement("a");s.style.display="none",document.body.appendChild(s),typeof t=="string"?s.href=t:s.href=URL.createObjectURL(t),s.download=e,s.click(),s.remove()}static collectAnimations(t,e){e=e||[];for(const s of t)!s||s.traverseVisible(n=>{n.animations&&n.animations.length>0&&e.push(...n.animations)});return e}static calculateCenter(t,e){const s=e||new y;return s.set(0,0,0),t.forEach(n=>{s.add(C(n))}),console.log(s),s.divideScalar(t.length),s}static filterTopmostParent(t){if(!(t.length<=0))for(let e=0;e<t.length;e++){let s=t[e];if(!s){t.splice(e,1),e--;continue}for(;s.parent;){if(t.includes(s.parent)){t.splice(e,1),e--;break}s=s.parent}}}}_h(xe,"GltfExport");var yh=Object.defineProperty,__=Object.getOwnPropertyDescriptor,b_=(i,t)=>yh(i,"name",{value:t,configurable:!0}),Co=(i,t,e,s)=>{for(var n=s>1?void 0:s?__(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&yh(t,e,n),n};class Qi extends v{constructor(){super(...arguments);r(this,"isGizmo",!1);r(this,"color0");r(this,"color1");r(this,"gridHelper");r(this,"size");r(this,"divisions");r(this,"offset")}onEnable(){var s,n;if(this.isGizmo&&!Mi)return;const t=this.size,e=this.divisions;this.gridHelper||(this.gridHelper=new Qf(t,e,(s=this.color0)!=null?s:new f(.4,.4,.4),(n=this.color1)!=null?n:new f(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset),this.gameObject.add(this.gridHelper))}}b_(Qi,"GridHelper");Co([g()],Qi.prototype,"isGizmo",2);Co([g(f)],Qi.prototype,"color0",2);Co([g(f)],Qi.prototype,"color1",2);var vh=Object.defineProperty,y_=Object.getOwnPropertyDescriptor,So=(i,t)=>vh(i,"name",{value:t,configurable:!0}),Yi=(i,t,e,s)=>{for(var n=s>1?void 0:s?y_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&vh(t,e,n),n};const li=w("debugLODs"),v_=w("noLODs");var wh;(function(i){i[i.None=0]="None",i[i.CrossFade=1]="CrossFade",i[i.SpeedTree=2]="SpeedTree"})(wh||(wh={}));class ci{constructor(){r(this,"screenRelativeTransitionHeight");r(this,"distance");r(this,"renderers")}}So(ci,"LODModel");Yi([g()],ci.prototype,"screenRelativeTransitionHeight",2);Yi([g()],ci.prototype,"distance",2);Yi([g()],ci.prototype,"renderers",2);class xh{constructor(t,e){r(this,"model");r(this,"renderers");this.model=e,this.renderers=[];for(const s of e.renderers){const n=this.findRenderer(s,t.gameObject);n&&n.gameObject?this.renderers.push(n):li&&console.warn("Renderer not found: "+s,t.gameObject)}}findRenderer(t,e){const s=p.foreachComponent(e,n=>{var a;return n.guid===t||((a=Object.getPrototypeOf(n))==null?void 0:a.guid)===t?n:null});if(s)return s;for(const n of e.children){const o=this.findRenderer(t,n);if(o)return o}return null}}So(xh,"LOD");class On extends v{constructor(){super(...arguments);r(this,"fadeMode",0);r(this,"localReferencePoint");r(this,"lodCount",0);r(this,"size",0);r(this,"animateCrossFading",!1);r(this,"lodModels");r(this,"_lods",[]);r(this,"_settings",[]);r(this,"_lodsHandler");r(this,"_distanceFactor",1)}start(){if(!v_&&!this._lodsHandler&&!!this.gameObject&&(li&&console.log(this),this.lodModels&&Array.isArray(this.lodModels))){let t=0,e=[];for(const n of this.lodModels){t=Math.max(n.distance,t);const o=new xh(this,n);this._lods.push(o);for(const a of o.renderers)e.includes(a)||e.push(a)}this._lodsHandler=new Array;for(let n=0;n<e.length;n++){const o=new Yf;this._lodsHandler.push(o),this.gameObject.add(o)}const s=new S;li&&console.log(e);for(let n=0;n<e.length;n++){const o=e[n],a=this._lodsHandler[n],l=o.gameObject;let c=0,h=0;li&&console.log(n,l.name);for(const u of this._lods){let _=null;u.renderers.includes(o)?_=l:_=s,li&&console.log("add",u.model.distance,_.name);const b=u.model.distance;h=b-c,c=Math.max(b,c),this.onAddLodLevel(a,_,b)}const d=c+h;li&&console.log("cull",d),this.onAddLodLevel(a,s,d)}}}update(){if(!this.gameObject||!this._lodsHandler)return;const t=this.context.mainCamera;if(!!t)for(const e of this._lodsHandler)e.update(t)}onAddLodLevel(t,e,s){t.addLevel(e,s*this._distanceFactor);const n={lod:t,levelIndex:t.levels.length-1,distance:s};this._settings.push(n)}distanceFactor(t){if(t!==this._distanceFactor){this._distanceFactor=t;for(const e of this._settings){const s=e.lod.levels[e.levelIndex];s.distance=e.distance*t}}}}So(On,"LODGroup");Yi([g(y)],On.prototype,"localReferencePoint",2);Yi([g(ci)],On.prototype,"lodModels",2);var Ph=Object.defineProperty,w_=Object.getOwnPropertyDescriptor,Ro=(i,t)=>Ph(i,"name",{value:t,configurable:!0}),hi=(i,t,e,s)=>{for(var n=s>1?void 0:s?w_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Ph(t,e,n),n};function x_(i){return i*180/Math.PI}Ro(x_,"toDegrees");function Cn(i){return i*Math.PI/180}Ro(Cn,"toRadians");const Oh=300,Ch=w("debuglights");var Sh;(function(i){i[i.Realtime=4]="Realtime",i[i.Baked=2]="Baked",i[i.Mixed=1]="Mixed"})(Sh||(Sh={}));class Pe extends v{constructor(){super(...arguments);r(this,"type",0);r(this,"intensity",1);r(this,"range",1);r(this,"spotAngle",1);r(this,"innerSpotAngle",1);r(this,"color",new f(16777215));r(this,"shadowNearPlane",.1);r(this,"shadowBias",0);r(this,"shadowNormalBias",1);r(this,"shadows",Sn.None);r(this,"lightmapBakeType",4);r(this,"light")}get isBaked(){return this.lightmapBakeType===2}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(t){return this.light?this.type===ie.Directional?this.light.getWorldPosition(t).multiplyScalar(1):this.light.getWorldPosition(t):t}onEnable(){this.createLight(),!this.isBaked&&(this.light&&(this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===ie.Directional&&this.startCoroutine(this.updateMainLightRoutine(),xt.LateUpdate))}createLight(){if(this.light)return;let t=this.selfIsLight;if(t)switch(this.light=this.gameObject,this.type){case ie.Directional:this.setDirectionalLight(this.light);break}else switch(this.type){case ie.Directional:const e=new Kf(this.color,this.intensity*Math.PI);if(e.position.set(0,0,-Oh*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(e.target),Ss(e.target,0,0,0),this.light=e,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),Ch){const a=new tp(this.light,.2,this.color);this.context.scene.add(a)}break;case ie.Spot:const s=new Zf(this.color,this.intensity*Math.PI,this.range,Cn(this.spotAngle/2),1-Cn(this.innerSpotAngle/2)/Cn(this.spotAngle/2),2);s.position.set(0,0,0),s.rotation.set(0,0,0),this.light=s;const n=s.target;s.add(n),n.position.set(0,0,this.range),n.rotation.set(0,0,0);break;case ie.Point:const o=new Jf(this.color,this.intensity*Math.PI,this.range);this.light=o;break}if(this.light!==void 0){this.shadows!=Sn.None?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048,this.light.shadow.bias=this.shadowBias*-3e-5,this.light.shadow.normalBias=this.shadowNormalBias*-3e-5;const e=this.light.shadow.camera;e.near=this.shadowNearPlane,e.far=Oh;const s=this.gameObject.scale.x,n=this.gameObject.scale.y;this.gameObject.scale.set(1,1,1),e.left*=s,e.right*=s,e.top*=n,e.bottom*=n,this.light.shadow.needsUpdate=!0,Ch&&this.context.scene.add(new ep(e)),this.isBaked?this.light.removeFromParent():t||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===ie.Directional&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}setDirectionalLight(t){t.add(t.target),t.target.position.set(0,0,-1)}}Ro(Pe,"Light");hi([g()],Pe.prototype,"type",2);hi([g(f)],Pe.prototype,"color",2);hi([g()],Pe.prototype,"shadowBias",2);hi([g()],Pe.prototype,"shadowNormalBias",2);hi([g()],Pe.prototype,"shadows",2);hi([g()],Pe.prototype,"lightmapBakeType",2);new y(0,0,0);var ie;(function(i){i[i.Spot=0]="Spot",i[i.Directional=1]="Directional",i[i.Point=2]="Point",i[i.Area=3]="Area",i[i.Rectangle=3]="Rectangle",i[i.Disc=4]="Disc"})(ie||(ie={}));var Sn;(function(i){i[i.None=0]="None",i[i.Hard=1]="Hard",i[i.Soft=2]="Soft"})(Sn||(Sn={}));var P_=Object.defineProperty,O_=(i,t)=>P_(i,"name",{value:t,configurable:!0});class Rh extends v{onEnable(){this.enabled&&this.context.physics.addMeshCollider(this.gameObject)}}O_(Rh,"MeshCollider");var C_=Object.defineProperty,Eh=(i,t)=>C_(i,"name",{value:t,configurable:!0});class Ah extends v{}Eh(Ah,"NavMesh");class kh extends v{}Eh(kh,"NavMeshAgent");var Th=Object.defineProperty,S_=Object.getOwnPropertyDescriptor,R_=(i,t)=>Th(i,"name",{value:t,configurable:!0}),E_=(i,t,e,s)=>{for(var n=s>1?void 0:s?S_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Th(t,e,n),n};const Eo=w("debugnestedgltf");class Ao extends v{constructor(){super(...arguments);r(this,"filePath");r(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(t){var e;(e=this.filePath)==null||e.beginListenDownload(t)}preload(){var t;(t=this.filePath)==null||t.preload()}async start(){var e,s,n,o,a,l;if(this._isLoadingOrDoneLoading)return;Eo&&console.log(this,this.guid);const t=this.gameObject.parent;if(t){this._isLoadingOrDoneLoading=!0;const c=new Ct;c.idProvider=new _t(this.hash(this.guid)),c.parent=t,this.gameObject.updateMatrix();const h=this.gameObject.matrix;Eo&&console.log("Load nested:",(s=(e=this.filePath)==null?void 0:e.uri)!=null?s:this.filePath,this.gameObject.position);const d=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));d&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0),this.destroy(),Eo&&console.log("Nested loading done:",(l=(a=this.filePath)==null?void 0:a.uri)!=null?l:this.filePath,d)}}hash(t){let e=0;for(let s=0;s<t.length;s++)e=t.charCodeAt(s)+((e<<5)-e);return e}}R_(Ao,"NestedGltf");E_([g(Bt)],Ao.prototype,"filePath",2);var A_=Object.defineProperty,k_=(i,t)=>A_(i,"name",{value:t,configurable:!0});class Lh extends v{constructor(){super(...arguments);r(this,"from");r(this,"affectPosition");r(this,"affectRotation");r(this,"alignLookDirection");r(this,"levelLookDirection");r(this,"positionOffset");r(this,"rotationOffset")}update(){if(!this.from)return;var t=C(this.from),e=J(this.from);this.affectPosition&&D(this.gameObject,t.add(this.positionOffset));const s=new Pt(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),n=new P().setFromEuler(s);this.affectRotation&&Z(this.gameObject,e.multiply(n));let o=new y;this.from.getWorldDirection(o).multiplyScalar(50),this.levelLookDirection&&(o.y=0),this.alignLookDirection&&this.gameObject.lookAt(o)}}k_(Lh,"OffsetConstraint");var T_=Object.defineProperty,ko=(i,t)=>T_(i,"name",{value:t,configurable:!0});class Dh{constructor(){r(this,"randomizeRotationDirection",0);r(this,"duration",5);r(this,"loop",!0);r(this,"prewarm",!1);r(this,"startDelay");r(this,"startDelayMultiplier",0);r(this,"startLifetime");r(this,"startLifetimeMultiplier",5);r(this,"startSpeed");r(this,"startSpeedMultiplier",5);r(this,"startSize3D",!1);r(this,"startSize");r(this,"startSizeMultiplier",1);r(this,"startSizeX");r(this,"startSizeXMultiplier",1);r(this,"startSizeY");r(this,"startSizeYMultiplier",1);r(this,"startSizeZ");r(this,"startSizeZMultiplier",1);r(this,"startRotation3D",!1);r(this,"startRotation");r(this,"startRotationMultiplier",0);r(this,"startRotationX");r(this,"startRotationXMultiplier",0);r(this,"startRotationY");r(this,"startRotationYMultiplier",0);r(this,"startRotationZ");r(this,"startRotationZMultiplier",0);r(this,"flipRotation",0);r(this,"startColor",new f(1,1,1));r(this,"startColor1",new f(0,0,0));r(this,"gravityModifier");r(this,"gravityModifierMultiplier",0);r(this,"simulationSpace",0);r(this,"customSimulationSpace",null);r(this,"simulationSpeed",1);r(this,"useUnscaledTime",!1);r(this,"scalingMode",1);r(this,"playOnAwake",!0);r(this,"maxParticles",1e3);r(this,"emitterVelocityMode",1);r(this,"stopAction",0);r(this,"ringBufferMode",0);r(this,"ringBufferLoopRange",new V(0,1));r(this,"cullingMode",0)}}ko(Dh,"MainModule");class Mh{constructor(){r(this,"burstCount",0);r(this,"enabled",!0);r(this,"rate",10);r(this,"rateMutliplier",1);r(this,"rateOverDistance",0);r(this,"rateOverDistanceMultiplier",0);r(this,"rateOverTime",0);r(this,"rateOverTimeMultiplier",0)}}ko(Mh,"EmissionModule");class Ih{constructor(){r(this,"shapeType",Ut.Box);r(this,"enabled",!0);r(this,"alignToDirection",!1);r(this,"angle",0);r(this,"arc",360);r(this,"arcmode",0);r(this,"box",new y(1,1,1));r(this,"boxThickness",new y(0,0,0));r(this,"position",new y(0,0,0));r(this,"rotation",new y(0,0,0));r(this,"scale",new y(1,1,1));r(this,"radius",1);r(this,"sphericalDirectionAmount",0)}}ko(Ih,"ShapeModule");var Ut;(function(i){i[i.Sphere=0]="Sphere",i[i.SphereShell=1]="SphereShell",i[i.Hemisphere=2]="Hemisphere",i[i.HemisphereShell=3]="HemisphereShell",i[i.Cone=4]="Cone",i[i.Box=5]="Box",i[i.Mesh=6]="Mesh",i[i.ConeVolume=7]="ConeVolume",i[i.Circle=10]="Circle",i[i.SingleSidedEdge=11]="SingleSidedEdge",i[i.MeshRenderer=12]="MeshRenderer",i[i.SkinnedMeshRenderer=13]="SkinnedMeshRenderer",i[i.BoxShell=14]="BoxShell",i[i.BoxEdge=15]="BoxEdge",i[i.Donut=16]="Donut",i[i.Rectangle=17]="Rectangle",i[i.Sprite=18]="Sprite",i[i.SpriteRenderer=19]="SpriteRenderer"})(Ut||(Ut={}));var L_=Object.defineProperty,To=(i,t)=>L_(i,"name",{value:t,configurable:!0});const jh=w("debugparticles");class Fh{constructor(){r(this,"age",0);r(this,"lifetime",0);r(this,"position");r(this,"velocity");r(this,"color")}}To(Fh,"ParticleState");class Lo extends v{constructor(){super(...arguments);r(this,"sharedMaterial");r(this,"mesh")}get mainTexture(){if(this.sharedMaterial){const t=this.context.assets.findTexture(this.sharedMaterial);if(t)return t}return null}getMesh(t){return this.mesh?this.context.assets.findMesh(this.mesh):null}awake(){jh&&console.log(this)}}To(Lo,"ParticleSystemRenderer");class Bh extends v{constructor(){super(...arguments);r(this,"main");r(this,"emission");r(this,"shape");r(this,"renderer");r(this,"geometry");r(this,"material");r(this,"particlesMesh");r(this,"positions");r(this,"positionsArray");r(this,"particleStates",[]);r(this,"activeCount",0);r(this,"shapeRotation",new P);r(this,"tempVec3",new y);r(this,"tempQuat",new P)}awake(){this.renderer=p.getComponent(this.gameObject,Lo),jh&&console.log(this)}onEnable(){if(this.geometry)return;this.particleStates=[],this.shapeRotation.setFromEuler(new Pt(this.shape.rotation.x,this.shape.rotation.y,this.shape.rotation.z)),this.geometry=new Os,this.positionsArray=new Float32Array(this.main.maxParticles*3),this.positions=new Ga(this.positionsArray,3),this.geometry.setAttribute("position",this.positions);const t=new Float32Array(this.main.maxParticles*3);for(let s=0;s<t.length;s++)t[s*3]=1,t[s*3+1]=1,t[s*3+2]=1;const e=new Ga(t,3);this.geometry.setAttribute("color",e),this.material=new ip({size:this.main.startSize,color:16777215,vertexColors:!0}),this.material.map=this.renderer.mainTexture,this.particlesMesh=new sp(this.geometry,this.material),this.particlesMesh.layers.enable(2),this.gameObject.add(this.particlesMesh),this.activeCount=this.main.prewarm?this.main.maxParticles:0}update(){if(!this.geometry)return;const t=this.context.time.deltaTime;this.emit(t);for(let e=0;e<this.activeCount;e+=1){const s=this.particleStates[e];if(!s)continue;const n=s.velocity.x*t,o=s.velocity.y*t,a=s.velocity.z*t;s.position.x+=n,s.position.y+=o,s.position.z+=a,this.updateOverLifetime(e,s),this.geometry.attributes.position.setXYZ(e,s.position.x,s.position.y,s.position.z),this.geometry.attributes.color.setXYZ(e,s.color.r,s.color.g,s.color.b)}this.geometry&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.setDrawRange(0,this.activeCount))}emit(t){var s;const e=this.activeCount;for(let n=0;n<e;n+=1){if(n>=this.particleStates.length){const a=new Fh;a.lifetime=(s=this.main.startLifetime)!=null?s:1,a.position=new y,a.velocity=new y,a.color=new f(1,0,0),this.particleStates.push(a),this.initializeParticle(n,a),a.age=a.lifetime*Math.random()}const o=this.particleStates[n];if(o.age>o.lifetime){this.activeCount-=1,this.activeCount=Math.max(0,this.activeCount),this.initializeParticle(n,o);continue}o.age+=t,this.particleStates[n]=o}this.activeCount+=t*this.emission.rate,this.activeCount=Math.min(this.main.maxParticles,this.activeCount)}initializeParticle(t,e){if(!this.geometry)return;e.age=0,e.color.set(this.main.startColor),this.main.startColor1&&e.color.lerp(this.main.startColor1,Math.random()),this.geometry.attributes.color.needsUpdate=!0,this.assignPosition(e.position),this.assignVelocity(e.position,e.velocity);const s=e.position;s.multiply(this.shape.scale),s.applyQuaternion(this.shapeRotation),s.add(this.shape.position),this.particleStates.splice(t,1),this.particleStates.push(e)}updateOverLifetime(t,e){}assignPosition(t){switch(this.shape.shapeType){case Ut.Sphere:t.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).multiplyScalar(this.shape.radius);break;case Ut.Box:t.set(Math.random()-.5,Math.random()-.5,Math.random()-.5);break;default:t.set(0,0,0);break}}assignVelocity(t,e){switch(this.shape.shapeType){case Ut.Sphere:e.set(t.x,t.y,t.z);break;case Ut.Box:e.set(0,0,1),this.shape.sphericalDirectionAmount>0&&(this.tempVec3.set(t.x,t.y,t.z).multiply(this.shape.scale).normalize(),e.lerp(this.tempVec3,this.shape.sphericalDirectionAmount));break;case Ut.Cone:const s=new y(0,1,0);e.copy(s);break;case Ut.Circle:this.tempQuat.setFromAxisAngle(this.tempVec3.set(0,0,1),Math.random()*k.toRadians(this.shape.arc)),e.copy(this.tempVec3.set(1,0,0).applyQuaternion(this.tempQuat));break;default:e.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1);break}switch(e.normalize(),this.shape.shapeType){case Ut.Circle:t.add(e).multiplyScalar(this.shape.radius);break}e.multiplyScalar(this.main.startSpeedMultiplier)}}To(Bh,"ParticleSystem");var D_=Object.defineProperty,Uh=(i,t)=>D_(i,"name",{value:t,configurable:!0});function*Nh(i,t=null){const e=t?t.time:A.Current.time,s=e.time;for(;e.time-s<i;)yield}Uh(Nh,"WaitForSeconds");function*M_(i){for(let t=0;t<i;t++)yield}Uh(M_,"WaitForFrames");var I_=Object.defineProperty,j_=(i,t)=>I_(i,"name",{value:t,configurable:!0});class Oe extends v{constructor(){super(...arguments);r(this,"_didAssignPlayerColor",!1)}awake(){this.context.connection.beginListen(W.JoinedRoom,this.tryAssignColor.bind(this))}onEnable(){this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}*waitForConnection(){for(;!this.destroyed&&this.enabled&&(yield Nh(.2),!this.tryAssignColor()););}tryAssignColor(){const t=p.getComponentInParent(this.gameObject,tt);return t&&t.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(t.connectionId),!0):!1}assignUserColor(t){const e=Oe.hashCode(t),s=Oe.colorFromHashCode(e);if(this.gameObject.type==="Mesh"){const n=this.gameObject;this.assignColor(s,t,n)}else if(this.gameObject.children)for(const n of this.gameObject.children){const o=n;o.material&&o.material.color&&this.assignColor(s,t,o)}}assignColor(t,e,s){let n=s.material;!n||(n._playerMaterial!==e?(n=n.clone(),n._playerMaterial=e,s.material=n):console.log("DONT CLONE",n),n.color=t)}static hashCode(t){var e=0,s,n;if(t.length===0)return e;for(s=0;s<t.length;s++)n=t.charCodeAt(s),e=(e<<5)-e+n,e|=0;return e}static colorFromHashCode(t){const e=(t&16711680)>>16,s=(t&65280)>>8,n=t&255;return new f(e/255,s/255,n/255)}}j_(Oe,"PlayerColor");var F_=Object.defineProperty,B_=(i,t)=>F_(i,"name",{value:t,configurable:!0});const xi=class extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=C(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const t=new $r;t.drag=this.drag,t.angularDrag=this.angularDrag,t.mass=this.mass,t.kinematic=this.isKinematic,t.physicsEvents=this.detectCollision,t.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,t),this.parent=this.gameObject.parent}wakeUp(){var t;(t=this.body)==null||t.wakeUp()}applyForce(t,e){var s;(s=this.body)==null||s.applyForce(new ke(t.x,t.y,t.z),e?new ke(e.x,e.y,e.z):void 0)}set kinematic(t){this.isKinematic=t,this.body&&(this.body.type=t?ct.KINEMATIC:ct.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var t,e,s;return this.body?xi.tempPosition.set((t=this.body)==null?void 0:t.velocity.x,(e=this.body)==null?void 0:e.velocity.y,(s=this.body)==null?void 0:s.velocity.z):xi.tempPosition.set(0,0,0)}setVelocity(t,e,s){!this.body||(this.body.velocity.x=t/this.context.time.deltaTime,this.body.velocity.y=e/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(t,e,s){!this.body||(this.body.angularVelocity.x=t/this.context.time.deltaTime,this.body.angularVelocity.y=e/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(t=null){if(this.body&&this.gameObject&&!this.destroyed){const e=this.worldPosition;this.body.position.set(e.x,e.y,e.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),t){xi.copyVector3.set(t.x,t.y,t.z),this.smoothedVelocity.lerp(xi.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const t=C(this.gameObject);this.currentVelocity.subVectors(t,this.lastWorldPosition),this.lastWorldPosition.copy(t),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let Ji=xi;r(Ji,"tempPosition",new y),r(Ji,"copyVector3",new y);B_(Ji,"Rigidbody");var U_=Object.defineProperty,N_=(i,t)=>U_(i,"name",{value:t,configurable:!0});class zh extends v{async start(){this.gameObject.visible=!1}}N_(zh,"SceneSettings");var z_=Object.defineProperty,Do=(i,t)=>z_(i,"name",{value:t,configurable:!0});function $h(){return new Promise((i,t)=>{let s=Do(()=>{s!=null&&(document.removeEventListener("pointerdown",s),document.removeEventListener("click",s),document.removeEventListener("dragstart",s),document.removeEventListener("touchstart",s),i())},"callback");document.addEventListener("pointerdown",s),document.addEventListener("click",s),document.addEventListener("dragstart",s),document.addEventListener("touchstart",s)})}Do($h,"awaitInputAsync");async function Wh(i){await $h(),i()}Do(Wh,"awaitInput");var Hh=Object.defineProperty,$_=Object.getOwnPropertyDescriptor,W_=(i,t)=>Hh(i,"name",{value:t,configurable:!0}),$e=(i,t,e,s)=>{for(var n=s>1?void 0:s?$_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Hh(t,e,n),n},Gh;(function(i){i[i.VideoClip=0]="VideoClip",i[i.Url=1]="Url"})(Gh||(Gh={}));var Vh;(function(i){i[i.None=0]="None",i[i.AudioSource=1]="AudioSource",i[i.Direct=2]="Direct",i[i.APIOnly=3]="APIOnly"})(Vh||(Vh={}));class Nt extends v{constructor(){super();r(this,"renderer",null);r(this,"playOnAwake",!0);r(this,"playOnEnable");r(this,"targetMaterialProperty");r(this,"time",0);r(this,"_playbackSpeed",1);r(this,"_isLooping",!1);r(this,"audioOutputMode",1);r(this,"source");r(this,"clip",null);r(this,"url",null);r(this,"videoElement",null);r(this,"videoTexture",null);r(this,"videoMaterial",null);r(this,"_isPlaying",!1);r(this,"wasPlaying",!1);r(this,"_receivedInput",!1);Wh(()=>{this._receivedInput=!0,this.updateVideoElementSettings()})}get playbackSpeed(){var t,e;return(e=(t=this.videoElement)==null?void 0:t.playbackRate)!=null?e:this._playbackSpeed}set playbackSpeed(t){this._playbackSpeed=t,this.videoElement&&(this.videoElement.playbackRate=t)}get isLooping(){var t,e;return(e=(t=this.videoElement)==null?void 0:t.loop)!=null?e:this._isLooping}set isLooping(t){this._isLooping=t,this.videoElement&&(this.videoElement.loop=t)}get currentTime(){var t,e;return(e=(t=this.videoElement)==null?void 0:t.currentTime)!=null?e:this.time}set currentTime(t){this.videoElement?this.videoElement.currentTime=t:this.time=t}get isPlaying(){const t=this.videoElement;return t?t.currentTime>0&&!t.paused&&!t.ended&&t.readyState>t.HAVE_CURRENT_DATA:!1}setClipURL(t){this.url!==t&&(this.url=t,this.source=1,this.videoElement&&(this.videoElement.src=t,this._isPlaying&&this.videoElement.play()))}awake(){this.create(this.playOnAwake),window.addEventListener("visibilitychange",t=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this._isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}})}onEnable(){this.playOnEnable===!0&&this.handleBeginPlaying(!0)}onDisable(){this.pause()}onDestroy(){var t;this.videoElement&&((t=this.videoElement.parentElement)==null||t.removeChild(this.videoElement),this.videoElement=null),this.videoTexture&&(this.videoTexture.dispose(),this.videoTexture=null)}play(){var t,e,s;!this.videoElement||this._isPlaying&&!((t=this.videoElement)==null?void 0:t.ended)&&!((e=this.videoElement)==null?void 0:e.paused)||(this._isPlaying=!0,this._receivedInput||(this.videoElement.muted=!0),this.updateVideoElementSettings(),(s=this.videoElement)==null||s.play().catch(n=>{console.warn(n)}))}stop(){this._isPlaying=!1,!!this.videoElement&&(this.videoElement.currentTime=0,this.videoElement.pause())}pause(){var t;this._isPlaying=!1,(t=this.videoElement)==null||t.pause()}create(t){var s;let e;switch(this.source){case 0:e=this.clip;break;case 1:e=this.url;break}!e||(this.videoElement||(this.videoElement=document.createElement("video"),(s=this.context.domElement)==null||s.prepend(this.videoElement),this.updateVideoElementStyles()),typeof e=="string"?this.videoElement.src=e:this.videoElement.srcObject=e,this.videoTexture||(this.videoTexture=new np(this.videoElement)),this.videoTexture.flipY=!1,this.videoTexture.encoding=Ye,this.handleBeginPlaying(t))}handleBeginPlaying(t){if(!this.enabled||!this.videoElement)return;const e=this.gameObject.material;if(e)if(e!==this.videoMaterial&&(this.videoMaterial=e.clone(),this.gameObject.material=this.videoMaterial),!this.targetMaterialProperty)this.videoMaterial.map=this.videoTexture;else switch(this.targetMaterialProperty){default:this.videoMaterial.map=this.videoTexture;break}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),t&&this.play()}updateVideoElementSettings(){!this.videoElement||(this.videoElement.loop=this._isLooping,this.videoElement.currentTime=this.currentTime,this.videoElement.playbackRate=this._playbackSpeed,this.videoElement.playsInline=!0,this.videoElement.muted=!this._receivedInput&&this.audioOutputMode!==0,(this.playOnAwake||this.playOnEnable)&&(this.videoElement.autoplay=!0))}updateVideoElementStyles(){!this.videoElement||(this.videoElement.style.userSelect="none",this.videoElement.style.visibility="hidden",this.videoElement.style.display="none")}}W_(Nt,"VideoPlayer");$e([g(S)],Nt.prototype,"renderer",2);$e([g()],Nt.prototype,"playOnAwake",2);$e([g()],Nt.prototype,"playOnEnable",2);$e([g()],Nt.prototype,"targetMaterialProperty",2);$e([g()],Nt.prototype,"time",2);$e([g()],Nt.prototype,"playbackSpeed",1);$e([g()],Nt.prototype,"isLooping",1);var H_=Object.defineProperty,G_=(i,t)=>H_(i,"name",{value:t,configurable:!0});class qh extends v{constructor(){super(...arguments);r(this,"streamOnAwake",!0);r(this,"requestOpen",!1);r(this,"captureStream",null)}start(){this.streamOnAwake&&this.open()}async open(t=!1){if(!(this.captureStream&&!t)){this.close(),this.requestOpen=!0;try{const e=p.getComponentInChildren(this.gameObject,Nt);if(e){const s={video:!0,audio:!1};this.captureStream=await navigator.mediaDevices.getDisplayMedia(s),this.captureStream&&this.requestOpen&&(e.clip=this.captureStream,e.create(!0))}}catch(e){console.error("Error: "+e)}}}close(){if(this.requestOpen=!1,this.captureStream){for(const t of this.captureStream.getTracks())t.stop();this.captureStream=null}}}G_(qh,"ScreenCapture");var Xh=Object.defineProperty,V_=Object.getOwnPropertyDescriptor,q_=(i,t)=>Xh(i,"name",{value:t,configurable:!0}),X_=(i,t,e,s)=>{for(var n=s>1?void 0:s?V_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Xh(t,e,n),n},Ra;const Qh=(Ra=class extends v{constructor(){super(...arguments);r(this,"target",null);r(this,"followFactor",.1);r(this,"rotateFactor",.1);r(this,"flipForward",!1);r(this,"_firstUpdate",!0)}onEnable(){const i=p.getComponentInChildren(this.gameObject,U);i&&i.cam&&(i.gameObject.position.set(0,0,0),i.cam.position.set(0,0,0),i.gameObject.quaternion.identity(),i.cam.quaternion.setFromEuler(new Pt(0,Math.PI,0)))}onBeforeRender(){this.followFactor<=0||this.updateNow(!1)}updateNow(i){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const t=C(this.target),e=this._firstUpdate||i?1:k.clamp01(this.context.time.deltaTime*this.followFactor);this.worldPosition=this.worldPosition.lerp(t,e)}if(this.rotateFactor>0){const t=J(this.target);this.flipForward&&t.multiply(Qh._invertForward);const e=this._firstUpdate||i?1:k.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(t,e)}this._firstUpdate=!1}}},r(Ra,"_invertForward",new P().setFromAxisAngle(new y(0,1,0),Math.PI)),Ra);let Rn=Qh;q_(Rn,"SmoothFollow");X_([g(S)],Rn.prototype,"target",2);var Yh=Object.defineProperty,Q_=Object.getOwnPropertyDescriptor,Mo=(i,t)=>Yh(i,"name",{value:t,configurable:!0}),En=(i,t,e,s)=>{for(var n=s>1?void 0:s?Q_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Yh(t,e,n),n};class Zi extends v{constructor(){super(...arguments);r(this,"triggerMask",0);r(this,"onEnter");r(this,"onStay");r(this,"onExit");r(this,"currentIntersected",[]);r(this,"lastIntersected",[])}update(){this.currentIntersected.length=0;for(const t of kn.triggers)t.triggerMask===this.triggerMask&&t.test(this.gameObject)&&this.currentIntersected.push(t);for(let t=this.lastIntersected.length-1;t>=0;t--){const e=this.lastIntersected[t];this.currentIntersected.indexOf(e)<0&&(this.onExitTrigger(e),this.lastIntersected.splice(t,1))}for(const t of this.currentIntersected)this.lastIntersected.indexOf(t)<0&&this.onEnterTrigger(t),this.onTrigger(t);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(t){var e;t.raiseOnEnterEvent(this),(e=this.onEnter)==null||e.invoke(this,t)}onExitTrigger(t){var e;t.raiseOnExitEvent(this),(e=this.onExit)==null||e.invoke(this,t)}onTrigger(t){var e;t.raiseOnStayEvent(this),(e=this.onStay)==null||e.invoke(this,t)}}Mo(Zi,"SpatialTriggerReceiver");En([g(ee)],Zi.prototype,"onEnter",2);En([g(ee)],Zi.prototype,"onStay",2);En([g(ee)],Zi.prototype,"onExit",2);var Ea;const An=(Ea=class extends v{constructor(){super(...arguments);r(this,"triggerMask");r(this,"boxHelper");r(this,"args",new Io)}start(){console.log(this)}onEnable(){var i;An.triggers.push(this),this.boxHelper||(this.boxHelper=p.addNewComponent(this.gameObject,$i),(i=this.boxHelper)==null||i.showHelper())}onDisable(){An.triggers.splice(An.triggers.indexOf(this),1)}test(i){var t;return this.boxHelper&&(t=this.boxHelper.isInBox(i))!=null?t:!1}raiseOnEnterEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onEnterTrigger",!1,i,this)}raiseOnStayEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onStayTrigger",!1,i,this)}raiseOnExitEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onExitTrigger",!1,i,this)}},r(Ea,"triggers",[]),Ea);let kn=An;Mo(kn,"SpatialTrigger");En([g()],kn.prototype,"triggerMask",2);class Io{constructor(){r(this,"source");r(this,"trigger")}}Mo(Io,"SpatialTriggerEventArgs");var Y_=Object.defineProperty,J_=(i,t)=>Y_(i,"name",{value:t,configurable:!0});class Jh extends v{constructor(){super(...arguments);r(this,"cam",null);r(this,"_firstPersonMode",!1);r(this,"orbit",null);r(this,"firstPersonFollow",null);r(this,"spectatorUIDomElement",null);r(this,"_avatar",null);r(this,"eventSub_WebXRRequestStartEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"_sessionHasStarted",!1);r(this,"_isFirstStart",!0);r(this,"_firstPersonIsSetup",!1);r(this,"_orbitStartPos",new y);r(this,"_orbitStartRot",new P);r(this,"_orbitStartPos2",new y);r(this,"_orbitStartRot2",new P)}get firstPersonMode(){return!0}set firstPersonMode(t){}enableFirstPersonMode(){this._firstPersonMode=!0,this.updateUI(),this.cam&&(this.firstPersonFollow&&(this.firstPersonFollow.enabled=!0,this.firstPersonFollow.updateNow(!0)),this.orbit&&(this.orbit.enabled=!1))}enableThirdPersonMode(){this._firstPersonMode=!1,this.updateUI(),this.firstPersonFollow&&(this.firstPersonFollow.enabled=!1),!!this.cam&&(D(this.cam.cam,this._orbitStartPos),Z(this.cam.cam,this._orbitStartRot),D(this.cam.gameObject,this._orbitStartPos2),Z(this.cam.gameObject,this._orbitStartRot2),this.orbit&&(this.orbit.enabled=!0,this.orbit.setFromTargetPosition()))}awake(){var e,s;p.setActive(this.gameObject,!1);const t="#spectator-camera-ui";if(this.spectatorUIDomElement=this.context.domElement.querySelector(t),this.spectatorUIDomElement||console.warn("Could not find spectator camera UI element",t),(e=this.spectatorUIDomElement)==null||e.classList.add("hidden"),!this.isSupportedPlatform()){console.log("Disable spectator cam",window.navigator.userAgent,this);return}if(this.cam=p.getComponent(this.gameObject,U),!this.cam){console.error("Spectator camera needs camera component",this);return}this.cam&&(this.cam.enabled=!0,this._orbitStartPos.copy(C(this.cam.cam)),this._orbitStartRot.copy(J(this.cam.cam)),this._orbitStartPos2.copy(C(this.cam.gameObject)),this._orbitStartRot2.copy(J(this.cam.gameObject))),this.eventSub_WebXRRequestStartEvent=this.onXRSessionRequestStart.bind(this),this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),E.addEventListener(H.RequestVRSession,this.eventSub_WebXRRequestStartEvent),E.addEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),E.addEventListener(H.XRStopped,this.eventSub_WebXREndEvent),(s=this.context.domElement.querySelector("button#toggle-spectator-view"))==null||s.addEventListener("click",this.toggleView.bind(this)),this.updateUI()}onDestroy(){E.removeEventListener(H.RequestVRSession,this.eventSub_WebXRStartEvent),E.removeEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),E.removeEventListener(H.XRStopped,this.eventSub_WebXREndEvent)}toggleView(){this.firstPersonMode=!this.firstPersonMode}updateUI(){var e;const t=this.context.domElement.querySelector("button#toggle-spectator-view");if(!!t&&(t.disabled=!0,t.firstChild&&(this._sessionHasStarted?t.firstChild.textContent=this.firstPersonMode?"\u{1F441}\uFE0F":"\u{1F4F7}":t.firstChild.textContent="Waiting for VR session"),((e=t.children)==null?void 0:e.length)>1)){const s=t.children[1];s.style.display=this._sessionHasStarted?"block":"none",this.firstPersonMode?s.textContent="First-Person View. See what the person in VR sees":s.textContent="Third-Person View. Freely move the camera around"}}isSupportedPlatform(){const t=window.navigator.userAgent,e=/Windows|MacOS/.test(t),s=/Windows NT/.test(t)&&/Edg/.test(t)&&!/Win64/.test(t);return e&&!s}onXRSessionRequestStart(t){var e;this._sessionHasStarted=!1,(e=this.spectatorUIDomElement)==null||e.classList.remove("hidden"),p.setActive(this.gameObject,!0),this.cam&&this.cam.cam&&(D(this.cam.cam,this._orbitStartPos),Z(this.cam.cam,this._orbitStartRot),D(this.cam.gameObject,this._orbitStartPos2),Z(this.cam.gameObject,this._orbitStartRot2)),this.firstPersonMode?this.enableFirstPersonMode():this.enableThirdPersonMode()}onXRSessionStart(t){this._sessionHasStarted=!0,this.updateUI()}onXRSessionEnded(t){var e;this._sessionHasStarted=!1,(e=this.spectatorUIDomElement)==null||e.classList.add("hidden"),p.setActive(this.gameObject,!1)}onAfterRender(){var l,c,h;if(!this.cam)return;if(this.firstPersonMode&&!this._firstPersonIsSetup&&(!this._avatar||((l=this._avatar)==null?void 0:l.destroyed))){for(const d of tt.instances)if(d.avatar&&"isLocalAvatar"in d.avatar&&((c=d.avatar)==null?void 0:c.isLocalAvatar)){this._avatar=d;const u=d.avatar.head;if(!u)continue;this.setupFollowMode(u)}}const t=this.context.renderer,e=t.xr.enabled;if(!t.xr.isPresenting)return;const s=t.getRenderTarget();let n=null;if(!s){if(!t.state.bindFramebuffer||!t.state.bindXRFramebuffer)return;n=t._framebuffer,t.state.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender(),t.setClearColor(new f(1,1,1)),t.setRenderTarget(null),t.xr.enabled=!1;const o=(h=this.cam)==null?void 0:h.cam;this.context.updateAspect(o);const a=t.xr.isPresenting;t.xr.isPresenting=!1,t.setSize(this.context.domWidth,this.context.domHeight),t.render(this.context.scene,o),t.xr.isPresenting=a,t.xr.enabled=e,s?t.setRenderTarget(s):t.state.bindXRFramebuffer(n),this.resetAvatarFlags()}setupFollowMode(t,e=!0){if(!t||!this.cam||this._firstPersonIsSetup)return;this._firstPersonIsSetup=!0;const s=t.add(new S);s.add(new Oi),this.firstPersonFollow=p.addNewComponent(this.cam.gameObject,Rn),this.firstPersonFollow.target=s,this.firstPersonFollow.followFactor=12,this.firstPersonFollow.rotateFactor=5,e&&(this.firstPersonFollow.flipForward=!0);const n=this.context.mainCamera;n&&(this.cam.cam.near=n.near,this.cam.cam.far=n.far,this.cam.cam.updateProjectionMatrix()),this.orbit&&(this.orbit.enabled=!1)}setAvatarFlagsBeforeRender(){for(const t of tt.instances)if(t.avatar&&"isLocalAvatar"in t.avatar){const e=this.firstPersonMode&&this._firstPersonIsSetup&&t.avatar.isLocalAvatar?Y.FirstPerson:Y.ThirdPerson,s=t.avatar.flags;if(!s)continue;for(const n of s)n.UpdateVisible(e)}}resetAvatarFlags(){var t;for(const e of tt.instances)if(e.avatar&&"flags"in e.avatar){const s=e.avatar.flags;if(!s)continue;for(const n of s)((t=e.avatar)==null?void 0:t.isLocalAvatar)?n.UpdateVisible(Y.FirstPerson):n.UpdateVisible(Y.ThirdPerson)}}}J_(Jh,"SpectatorCamera");var Zh=Object.defineProperty,Z_=Object.getOwnPropertyDescriptor,K_=(i,t)=>Zh(i,"name",{value:t,configurable:!0}),Kh=(i,t,e,s)=>{for(var n=s>1?void 0:s?Z_(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Zh(t,e,n),n};class Tn extends v{constructor(){super(...arguments);r(this,"attachedRigidbody",null);r(this,"isTrigger",!1);r(this,"radius",.5);r(this,"center",new y(0,0,0));r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addSphereCollider(this.gameObject,this.center,this.radius,this.attachedRigidbody))}}K_(Tn,"SphereCollider");Kh([g(Rt)],Tn.prototype,"attachedRigidbody",2);Kh([g(y)],Tn.prototype,"center",2);var tb=Object.defineProperty,eb=(i,t)=>tb(i,"name",{value:t,configurable:!0});class td extends v{constructor(){super(...arguments);r(this,"anchor",null);r(this,"connectedBody",null);r(this,"connectedAnchor",null);r(this,"spring",10);r(this,"damper",.2);r(this,"rb",null)}awake(){if(this.rb=p.getComponent(this.gameObject,Rt),!this.connectedBody||!this.connectedBody.body||!this.rb||!this.rb.body)return;this.connectedBody.body.mass=Math.min(this.rb.body.mass*.99,this.connectedBody.body.mass);const t=new rp(this.rb.body,this.connectedBody.body,{restLength:.01,stiffness:this.spring*.5,damping:this.damper});this.context.physics.addPostStepListener(e=>{t.applyForce()})}update(){}}eb(td,"SpringJoint");var ed=Object.defineProperty,ib=Object.getOwnPropertyDescriptor,Ln=(i,t)=>ed(i,"name",{value:t,configurable:!0}),Dn=(i,t,e,s)=>{for(var n=s>1?void 0:s?ib(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&ed(t,e,n),n},id;(function(i){i[i.Simple=0]="Simple",i[i.Sliced=1]="Sliced",i[i.Tiled=2]="Tiled"})(id||(id={}));class sb{constructor(){r(this,"x");r(this,"y")}}Ln(sb,"Vec2");class jo{constructor(){r(this,"texture");r(this,"triangles");r(this,"uv");r(this,"vertices");r(this,"_geometry")}}Ln(jo,"Sprite");Dn([g(wr)],jo.prototype,"texture",2);class Fo{static getOrCreateGeometry(t){if(t._geometry)return t._geometry;const e=new Os;t._geometry=e;const s=new Float32Array(t.triangles.length*3),n=new Float32Array(t.triangles.length*2);for(let o=0;o<t.triangles.length;o+=1){const a=t.triangles[o];s[o*3]=-t.vertices[a].x,s[o*3+1]=t.vertices[a].y,s[o*3+2]=0;const l=t.uv[a];n[o*2]=l.x,n[o*2+1]=1-l.y}return e.setAttribute("position",new Si(s,3)),e.setAttribute("uv",new Si(n,2)),e}}Ln(Fo,"SpriteUtils");class Ki extends v{constructor(){super(...arguments);r(this,"drawMode",0);r(this,"size",{x:1,y:1});r(this,"color");r(this,"sharedMaterial");r(this,"_sprite");r(this,"_currentSprite")}get sprite(){return this._sprite}set sprite(t){t!==this._sprite&&(this._sprite=t,this.updateSprite())}awake(){this._currentSprite=void 0}start(){this.drawMode===2&&console.warn("Tiled draw mode is not supported yet",this),this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(){if(!!this.__didAwake&&!!this.sprite&&!!this.sharedMaterial){if(this._currentSprite)this._currentSprite.geometry=Fo.getOrCreateGeometry(this.sprite),this._currentSprite.material.map=this.sprite.texture;else{const t=new Ci({color:16777215,side:Va});if(!t)return;if(this.color&&(t.color||(t.color=new f),t.color.copy(this.color),t.opacity=this.color.alpha),t.alphaTest=.5,this.sprite.texture&&!t.wireframe){const e=this.sprite.texture;t.map=e}this._currentSprite=new Je(Fo.getOrCreateGeometry(this.sprite),t)}this._currentSprite.parent!==this.gameObject&&(this.drawMode===2&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite))}}}Ln(Ki,"SpriteRenderer");Dn([g()],Ki.prototype,"drawMode",2);Dn([g(Jt)],Ki.prototype,"color",2);Dn([g(op)],Ki.prototype,"sharedMaterial",2);var nb=Object.defineProperty,rb=(i,t)=>nb(i,"name",{value:t,configurable:!0});class Et{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(t,e){return this.bb_pos=t,this.bb=e,this}static getRootAsSyncedCameraModel(t,e){return(e||new Et).__init(t.readInt32(t.position())+t.position(),t)}static getSizePrefixedRootAsSyncedCameraModel(t,e){return t.setPosition(t.position()+vr),(e||new Et).__init(t.readInt32(t.position())+t.position(),t)}userId(t){const e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__string(this.bb_pos+e,t):null}guid(t){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__string(this.bb_pos+e,t):null}dontSave(){const t=this.bb.__offset(this.bb_pos,8);return t?!!this.bb.readInt8(this.bb_pos+t):!1}pos(t){const e=this.bb.__offset(this.bb_pos,10);return e?(t||new rt).__init(this.bb_pos+e,this.bb):null}rot(t){const e=this.bb.__offset(this.bb_pos,12);return e?(t||new rt).__init(this.bb_pos+e,this.bb):null}static startSyncedCameraModel(t){t.startObject(5)}static addUserId(t,e){t.addFieldOffset(0,e,0)}static addGuid(t,e){t.addFieldOffset(1,e,0)}static addDontSave(t,e){t.addFieldInt8(2,+e,0)}static addPos(t,e){t.addFieldStruct(3,e,0)}static addRot(t,e){t.addFieldStruct(4,e,0)}static endSyncedCameraModel(t){return t.endObject()}static finishSyncedCameraModelBuffer(t,e){t.finish(e)}static finishSizePrefixedSyncedCameraModelBuffer(t,e){t.finish(e,void 0,!0)}}rb(Et,"SyncedCameraModel");var sd=Object.defineProperty,ob=Object.getOwnPropertyDescriptor,nd=(i,t)=>sd(i,"name",{value:t,configurable:!0}),rd=(i,t,e,s)=>{for(var n=s>1?void 0:s?ob(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&sd(t,e,n),n};const Mn="SCAM";Ns(Mn,Et.getRootAsSyncedCameraModel);const pt=new Ps;class od{constructor(t,e){r(this,"userId");r(this,"guid");this.guid=e,this.userId=t}send(t,e){var n;const s=(n=t.cam)==null?void 0:n.cam;if(s){pt.clear();const o=pt.createString(this.guid),a=pt.createString(this.userId);Et.startSyncedCameraModel(pt),Et.addGuid(pt,o),Et.addUserId(pt,a);const l=C(s),c=Ir(s);Et.addPos(pt,rt.createVec3(pt,l.x,l.y,l.z)),Et.addRot(pt,rt.createVec3(pt,c.x,c.y,c.z));const h=Et.endSyncedCameraModel(pt);pt.finish(h,Mn),e.sendBinary(pt.asUint8Array())}}}nd(od,"CameraModel");class In extends v{constructor(){super(...arguments);r(this,"cam",null);r(this,"cameraPrefab",null);r(this,"_lastWorldPosition");r(this,"_lastWorldQuaternion");r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"_lastUpdateTime",0);r(this,"remoteCams",{});r(this,"userToCamMap",{});r(this,"_camTimeoutInSeconds",10);r(this,"_receiveCallback",null)}getUserCamera(t){const e=this.userToCamMap[t];return e?this.remoteCams[e].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}start(){var t;this.cam||(console.warn("Missing camera, fallback to main camera",this),this.cam=(t=this.context.mainCameraComponent)!=null?t:null)}onEnable(){this._receiveCallback=this.context.connection.beginListenBinrary(Mn,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary(Mn,this._receiveCallback)}update(){for(const s in this.remoteCams){const n=this.remoteCams[s],o=this.context.time.realtimeSinceStartup-n.lastUpdate;if(!n||o>this._camTimeoutInSeconds){console.log("Remote cam timeout",n,o),(n==null?void 0:n.obj)&&p.destroy(n.obj),delete this.remoteCams[s],n&&delete this.userToCamMap[n.userId];continue}}if(E.IsInWebXR)return;if(this.cam===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new od(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const t=C(this.cam.cam),e=J(this.cam.cam);(t.distanceTo(this._lastWorldPosition)>.001||e.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(t),this._lastWorldQuaternion.copy(e),!((!this._needsUpdate||this.context.time.frameCount%2!=0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(this,this.context.connection))}onReceivedRemoteCameraInfoBin(t){const e=t.guid();if(!e)return;const s=t.userId();if(!s||!this.context.connection.userIsInRoom(s)||!this.cameraPrefab)return;let n=this.remoteCams[e];if(!n)if("isObject3D"in this.cameraPrefab){const c=new Ct;c.context=this.context;const h=p.instantiate(this.cameraPrefab,c);n=this.remoteCams[e]={obj:h,lastUpdate:this.context.time.realtimeSinceStartup,userId:s},n.obj.visible=!0,this.gameObject.add(h),this.userToCamMap[s]=e;const d=p.getOrAddComponent(h,tt);d.connectionId=s,d.avatar=h}else return;const o=n.obj;n.lastUpdate=this.context.time.realtimeSinceStartup,ht.markDirty(o);const a=t.pos();a&&Ss(o,a.x(),a.y(),a.z());const l=t.rot();l&&Es(o,l.x(),l.y(),l.z())}}nd(In,"SyncedCamera");rd([g(U)],In.prototype,"cam",2);rd([g([S,Bt])],In.prototype,"cameraPrefab",2);var ad=Object.defineProperty,ab=Object.getOwnPropertyDescriptor,lb=(i,t)=>ad(i,"name",{value:t,configurable:!0}),ts=(i,t,e,s)=>{for(var n=s>1?void 0:s?ab(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&ad(t,e,n),n};const Bo="view",ld=w("debugsyncedroom");class We extends v{constructor(){super(...arguments);r(this,"roomName");r(this,"urlParameterName");r(this,"joinRandomRoom",!0);r(this,"requireRoomParameter",!1);r(this,"autoRejoin",!0);r(this,"_roomPrefix");r(this,"_lastPingTime",0);r(this,"_lastRoomTime",-1)}awake(){this._roomPrefix===void 0&&(this._roomPrefix=this.roomName,this.roomName="")}onEnable(){const t=w(Bo);if(t&&typeof t=="string"&&t.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(t,!0);return}this.tryJoinRoom()}onDisable(){this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}tryJoinRoom(t=0){let e=!1;if(this.urlParameterName){const s=w(this.urlParameterName);if(s&&typeof s=="string"){e=!0;const n=sl(s);this.roomName=n}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),t<1))return this.tryJoinRoom(t+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(console.log("generate room name"),this.roomName=this.generateRoomName());return this.requireRoomParameter&&!e?(ld&&console.log('No required room parameter "'+this.urlParameterName+'" in url - will not connect to networking backend.'),!1):!this.roomName||this.roomName.length<=0?(ld&&console.error('Missing room name on "'+this.name+'". Make sure this is correctly configured in Unity',this.context.connection.isDebugEnabled?this:""),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.context.connection.joinRoom(this.roomName),!0)}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.send("ping",{time:this.context.time.time})),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you)"))}get currentRoomName(){const t=w(Bo);return t||w(this.urlParameterName)}setRandomRoomUrlParameter(){const t=Ai(),e=this.generateRoomName();w(this.urlParameterName)?t.set(this.urlParameterName,e):t.append(this.urlParameterName,e),Sr(e,t)}generateRoomName(){return il()+"_"+Ka(100,999)}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const t=window.location.search,e=new URLSearchParams(t);return e.has(this.urlParameterName)&&e.delete(this.urlParameterName),e.set(Bo,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+e.toString()}return null}}lb(We,"SyncedRoom");ts([g()],We.prototype,"roomName",2);ts([g()],We.prototype,"urlParameterName",2);ts([g()],We.prototype,"joinRandomRoom",2);ts([g()],We.prototype,"requireRoomParameter",2);ts([g()],We.prototype,"autoRejoin",2);var cb=Object.defineProperty,cd=(i,t)=>cb(i,"name",{value:t,configurable:!0});function hd(){const i=w("testwindowcount")||0;i&&i>0&&dd(i)}cd(hd,"detect_run_tests");function dd(i){if(w("testwindow"))return null;const t=new URL(window.location.href);ki(t.searchParams,an,1),ki(t.searchParams,"testwindow",1);const e=t.toString(),s=[];window.onbeforeunload=()=>{for(const c of s)c.close()};const n=.05,o=128;let a=0,l=0;for(let c=0;c<i;c++){a*o+o*.01>=window.innerWidth&&(l+=1,a=0);const h=a*(o*(1+n))+window.screenLeft,d=l*(o*(1+n))+window.screenTop+90+60*l;a+=1;const u=window.open(e,"test window "+c,`popup=yes width=${o} height=${o} top=${d} left=${h}`);if(!u){console.warn("Failed to open window");continue}s.push(u),u.onload=()=>{u.onbeforeunload=()=>{for(let _=0;_<s.length;_++){const b=s[_];b!==u&&b.close()}s.length=0}}}return s}cd(dd,"spawnWindows");var hb=Object.defineProperty,Uo=(i,t)=>hb(i,"name",{value:t,configurable:!0});class ud extends v{awake(){hd()}}Uo(ud,"TestRunner");class fd extends v{constructor(){super(...arguments);r(this,"transformsPerFrame",10);r(this,"interval",0);r(this,"useFlatbuffers",!0);r(this,"builder",null);r(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinrary(Gi,t=>{});else{this.models=[];for(let t=0;t<this.transformsPerFrame;t++)this.models.push(new No(this.context.connection.connectionId+"_simulatedTransform_"+t,this))}}update(){if(!!this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!=0)return;this.builder===null&&(this.builder=new Ps(1024));const t=this.builder;for(let e=0;e<this.transformsPerFrame;e++){t.clear();const s=mo(this.context.connection.connectionId,this);this.context.connection.sendBinary(s)}}else if(this.models)for(let t=0;t<this.models.length;t++){const e=this.models[t];e.dontSave=!0,e.update(this,null),this.context.connection.send("TestSimulateUserData-"+t,e)}}}}Uo(fd,"TestSimulateUserData");class No{constructor(t,e){r(this,"guid");r(this,"fast",!1);r(this,"position");r(this,"rotation");r(this,"velocity");r(this,"dontSave");this.guid=t,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(e,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(t,e){const s=t.worldPosition;this.position.x=s.x,this.position.y=s.y,this.position.z=s.z;const n=t.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,e){const o=e.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}r(No,"temp",new y);Uo(No,"TransformModel");var pd=Object.defineProperty,db=Object.getOwnPropertyDescriptor,ub=(i,t)=>pd(i,"name",{value:t,configurable:!0}),fb=(i,t,e,s)=>{for(var n=s>1?void 0:s?db(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&pd(t,e,n),n};class zo extends v{constructor(){super(...arguments);r(this,"isGizmo",!0);r(this,"control");r(this,"orbit");r(this,"changeEventListener");r(this,"windowKeyDownListener");r(this,"windowKeyUpListener")}awake(){this.isGizmo&&!Mi||!this.context.mainCamera||(this.control=new ap(this.context.mainCamera,this.context.renderer.domElement),this.control.visible=!0,this.control.enabled=!0,this.control.getRaycaster().layers.set(2),this.control.size=.6,this.control.traverse(t=>{const e=t;if(e.layers.set(2),e){const s=e.material;s&&(s.opacity=.3)}}))}start(){var t;if(this.context.mainCamera){const e=(t=p.getComponentInParent(this.context.mainCamera,Ma))!=null?t:void 0;this.orbit=e}}onEnable(){var t;this.control&&(this.context.scene.add(this.control),this.control.attach(this.gameObject)),this.changeEventListener=this.onControlChangedEvent.bind(this),(t=this.control)==null||t.addEventListener("dragging-changed",this.changeEventListener),this.attachWindowEvents()}onDisable(){var t,e;(t=this.control)==null||t.removeFromParent(),this.changeEventListener&&((e=this.control)==null||e.removeEventListener("dragging-changed",this.changeEventListener))}onControlChangedEvent(t){const e=this.orbit;if(e&&(e.enabled=!t.value),t.value){const s=p.getComponentInParent(this.gameObject,ge);s&&s.requestOwnership()}}attachWindowEvents(){const t=this.control;!t||(this.windowKeyDownListener||(this.windowKeyDownListener=e=>{switch(e.keyCode){case 81:t.setSpace(t.space==="local"?"world":"local");break;case 16:t.setTranslationSnap(100),t.setRotationSnap(lp.degToRad(15)),t.setScaleSnap(.25);break;case 87:t.setMode("translate");break;case 69:t.setMode("rotate");break;case 82:t.setMode("scale");break;case 187:case 107:t.setSize(t.size+.1);break;case 189:case 109:t.setSize(Math.max(t.size-.1,.1));break;case 88:t.showX=!t.showX;break;case 89:t.showY=!t.showY;break;case 90:t.showZ=!t.showZ;break;case 32:t.enabled=!t.enabled;break}}),this.windowKeyUpListener||(this.windowKeyUpListener=e=>{switch(e.keyCode){case 16:t.setTranslationSnap(null),t.setRotationSnap(null),t.setScaleSnap(null);break}}),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener))}}ub(zo,"TransformGizmo");fb([g()],zo.prototype,"isGizmo",2);var pb=Object.defineProperty,md=(i,t)=>pb(i,"name",{value:t,configurable:!0}),Ce;(function(i){i.StartOrUpdate="xr-grab-visual-start-or-update",i.End="xr-grab-visual-end"})(Ce||(Ce={}));class $o{constructor(){r(this,"guid");r(this,"dontSave",!0);r(this,"userId");r(this,"point",{x:0,y:0,z:0});r(this,"source",{x:0,y:0,z:0});r(this,"target")}update(t,e,s,n=void 0){this.userId=t.connection.connectionId,this.point.x=e.x,this.point.y=e.y,this.point.z=e.z,this.source.x=s.x,this.source.y=s.y,this.source.z=s.z,this.target=n}}md($o,"XRGrabModel");class gd extends v{constructor(){super(...arguments);r(this,"prefab",null);r(this,"_grabModels",[]);r(this,"_grabModelsUpdateTime",[]);r(this,"_addOrUpdateSub",null);r(this,"_endSub",null);r(this,"_freeSub",null);r(this,"_instances",{});r(this,"temp",new y)}awake(){this.prefab&&(this.prefab.visible=!1)}onEnable(){this._addOrUpdateSub=this.context.connection.beginListen(Ce.StartOrUpdate,this.onRemoteGrabStartOrUpdate.bind(this)),this._endSub=this.context.connection.beginListen(Ce.End,this.onRemoteGrabEnd.bind(this)),this._freeSub=Ft.AddEventListener(fn.WillFree,this.onAttachedObjectFree.bind(this))}onDisable(){this.context.connection.stopListening(Ce.StartOrUpdate,this._addOrUpdateSub),this.context.connection.stopListening(Ce.End,this._endSub),Ft.RemoveEventListener(fn.WillFree,this._freeSub)}addOrUpdateGrab(t){this.context.connection.send(Ce.StartOrUpdate,t,Di.Queued)}endGrab(t){this.context.connection.send(Ce.End,t,Di.Queued)}onRemoteGrabStartOrUpdate(t){if(!this.prefab)return;const e=this._instances[t.guid];if(!e){const s=p.instantiate(this.prefab);if(s.visible=!0,this._instances[t.guid]={instance:s,model:t},t.userId){const n=p.getComponentsInChildren(s,Oe);if((n==null?void 0:n.length)>0)for(const o of n)o.assignUserColor(t.userId)}return}e.model=t}onRemoteGrabEnd(t){if(!t)return;const e=t.guid;this._instances[e]&&(p.destroy(this._instances[e].instance),delete this._instances[e])}onAttachedObjectFree(t){if(this._grabModels.length<=0)return;const e=this._grabModels[0];this.updateModel(e,t),this.endGrab(e)}onBeforeRender(){if(this.updateRendering(),!!this.prefab&&(this.prefab.visible=!1,this.context.time.frameCount%10==0))for(let t=0;t<Ft.Current.length;t++){const e=Ft.Current[t];if(!e.controller||!e.selected)continue;this._grabModels.length<=t&&(this._grabModels.push(new $o),this._grabModelsUpdateTime.push(0)),this._grabModelsUpdateTime[t]=this.context.time.time;const s=this._grabModels[t];this.updateModel(s,e),this.addOrUpdateGrab(s)}}updateModel(t,e){if(!e.controller||!e.selected)return;t.guid=e.grabUUID;const s=e.selected.guid;t.update(this.context,e.grabPoint,e.controller.worldPosition,s)}updateRendering(){const t=this.context.time.deltaTime/.5;for(const e in this._instances){const{instance:s,model:n}=this._instances[e];if(!s||!n)continue;const{point:o}=n,a=C(s);this.temp.set(o.x,o.y,o.z),a.lerp(this.temp,t),D(s,a)}}}md(gd,"XRGrabRendering");var _d=Object.defineProperty,mb=Object.getOwnPropertyDescriptor,gb=(i,t)=>_d(i,"name",{value:t,configurable:!0}),jn=(i,t,e,s)=>{for(var n=s>1?void 0:s?mb(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&_d(t,e,n),n};class di extends v{constructor(){super(...arguments);r(this,"eyes",[]);r(this,"lastBlinkTime",0);r(this,"blinkLength",0);r(this,"eyesOpen",!0);r(this,"state",null)}awake(){this.state=p.getComponentInParent(this.gameObject,K)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const e of this.eyes)e&&(e.visible=this.eyesOpen)}}}gb(di,"AvatarBlink_Simple");jn([g(S)],di.prototype,"eyes",2);jn([g()],di.prototype,"lastBlinkTime",2);jn([g()],di.prototype,"blinkLength",2);jn([g()],di.prototype,"eyesOpen",2);var bd=Object.defineProperty,_b=Object.getOwnPropertyDescriptor,bb=(i,t)=>bd(i,"name",{value:t,configurable:!0}),Wo=(i,t,e,s)=>{for(var n=s>1?void 0:s?_b(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&bd(t,e,n),n},Aa;const yd=(Aa=class extends v{constructor(){super(...arguments);r(this,"head",null);r(this,"eyes",null);r(this,"target",null);r(this,"brain",null);r(this,"vec",new y);r(this,"currentTargetPoint",new y)}awake(){this.brain||(this.brain=p.getComponentInParent(this.gameObject,hn)),this.brain||(console.log("No look at brain found, adding it now"),this.brain=p.addNewComponent(this.gameObject,hn)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const i=this.target;if(i&&this.head){const t=this.eyes;if(t){const e=C(i);this.currentTargetPoint.lerp(e,this.context.time.deltaTime/.1);const s=C(this.head),n=this.vec.copy(this.currentTargetPoint).sub(s).normalize();if(n.length()<.1)return;const o=yd.forward;if(o.set(0,0,1),o.applyQuaternion(J(this.head)),o.dot(n)>.45)for(let l=0;l<t.length;l++)t[l].lookAt(this.currentTargetPoint)}}}},r(Aa,"forward",new y(0,0,1)),Aa);let es=yd;bb(es,"AvatarEyeLook_Rotation");Wo([g(S)],es.prototype,"head",2);Wo([g(S)],es.prototype,"eyes",2);Wo([g(S)],es.prototype,"target",2);var vd=Object.defineProperty,yb=Object.getOwnPropertyDescriptor,vb=(i,t)=>vd(i,"name",{value:t,configurable:!0}),wd=(i,t,e,s)=>{for(var n=s>1?void 0:s?yb(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&vd(t,e,n),n};const wb=w("debugmouth");class Fn extends v{constructor(){super(...arguments);r(this,"idle",[]);r(this,"talking",[]);r(this,"marker",null);r(this,"voip",null);r(this,"lastMouthChangeTime",0);r(this,"mouthChangeLength",0)}awake(){this.voip=p.findObjectOfType(_e,this.context),console.log(this)}update(){var s,n;if(!this.voip||this.context.time.frameCount%10!=0)return;let t=(n=(s=this.marker)==null?void 0:s.connectionId)!=null?n:null;t||wb&&(t=null);const e=this.voip.getFrequency(t);e!=null&&this.updateLips(e)}updateLips(t){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&t>50){this.lastMouthChangeTime=this.context.time.time;const e=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,e)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const e=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,e)}}}setMouthShapeActive(t,e){if(!!t){t!=this.idle?this.idle.map(s=>s.visible=!1):this.talking.map(s=>s.visible=!1);for(let s=0;s<t.length;s++){const n=t[s];n&&(n.visible=s===e,n.scale.set(1,1,1))}}}}vb(Fn,"Avatar_MouthShapes");wd([g(S)],Fn.prototype,"idle",2);wd([g(S)],Fn.prototype,"talking",2);var xb=Object.defineProperty,Pb=(i,t)=>xb(i,"name",{value:t,configurable:!0});class xd extends v{constructor(){super(...arguments);r(this,"voip",null);r(this,"marker",null);r(this,"_startPosition",null)}awake(){this.voip=p.findObjectOfType(_e,this.context),this.marker=p.getComponentInParent(this.gameObject,tt)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!=0)return;const t=this.marker.connectionId,e=this.voip.getFrequency(t);if(e==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());let s=e/100;this.gameObject.position.y=this._startPosition.y+s*.07}}Pb(xd,"Avatar_MustacheShake");var Ob=Object.defineProperty,Cb=(i,t)=>Ob(i,"name",{value:t,configurable:!0});const Sb=w("logstats");class Pd extends v{onEnable(){console.log(this),Sb&&this.startCoroutine(this.run(),xt.OnAfterRender)}*run(){for(;this.enabled;){const t=this.context.renderer.info;console.log(t.memory,t.render,t.programs),yield}}}Cb(Pd,"LogStats");var Od=Object.defineProperty,Rb=Object.getOwnPropertyDescriptor,Ho=(i,t)=>Od(i,"name",{value:t,configurable:!0}),Eb=(i,t,e,s)=>{for(var n=s>1?void 0:s?Rb(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Od(t,e,n),n};class Go{constructor(){r(this,"guid")}}Ho(Go,"SignalAsset");class Vo{constructor(){r(this,"signal");r(this,"reaction");r(this,"$serializedTypes",{signal:Go,reaction:ee})}}Ho(Vo,"SignalReceiverEvent");class Bn extends v{constructor(){super(...arguments);r(this,"events")}start(){console.log(this)}invoke(t){if(!this.events||!Array.isArray(this.events))return;let e=typeof t=="object"?t.guid:t;for(const s of this.events)if(s.signal.guid===e)try{if(s.reaction){if(!s.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",s,this);continue}}else{console.warn("Missing reaction for signal",s,this);continue}s.reaction.invoke()}catch(n){console.error(n)}}}Ho(Bn,"SignalReceiver");Eb([g(Vo)],Bn.prototype,"events",2);var At;(function(i){i.Activation="ActivationTrack",i.Animation="AnimationTrack",i.Audio="AudioTrack",i.Control="ControlTrack",i.Marker="MarkerTrack",i.Signal="SignalTrack"})(At||(At={}));var is;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(is||(is={}));var qo;(function(i){i.Signal="SignalEmitter"})(qo||(qo={}));var Ab=Object.defineProperty,ui=(i,t)=>Ab(i,"name",{value:t,configurable:!0});const Un=w("debugtimeline");class ss{constructor(){r(this,"director");r(this,"track")}get muted(){return this.track.muted}set muted(t){var e;t!==this.track.muted&&(this.track.muted=t,(e=this.onMuteChanged)==null||e.call(this))}*forEachClip(t=!1){var e;if(!!((e=this.track)==null?void 0:e.clips))if(t)for(let s=this.track.clips.length-1;s>=0;s--)yield this.track.clips[s];else for(const s of this.track.clips)yield s}getClipTime(t,e){return e.clipIn+(t-e.start)*e.timeScale}getClipTimeNormalized(t,e){return(t-e.start)/e.duration}evaluateWeight(t,e,s,n=!0){if(e<0||e>=s.length)return 0;const o=s[e];if(n||t>=o.start&&t<=o.end){let a=1,l=!1;return o.easeInDuration>0&&(a*=Math.min((t-o.start)/o.easeInDuration,1)),o.easeOutDuration>0&&!l&&(a*=Math.min((o.end-t)/o.easeOutDuration,1)),a}return 0}}ui(ss,"TrackHandler");class Cd{constructor(t){r(this,"clip");r(this,"rootPositionOffset");r(this,"rootQuaternionOffset");r(this,"rootStartPosition");r(this,"rootEndPosition");r(this,"rootStartQuaternion");r(this,"rootEndQuaternion");const e=t.getClip();this.clip=e;const s=t.getRoot(),n=s.name+".position",o=s.name+".quaternion";Un&&console.log(e.name,e.tracks,n);for(const a of e.tracks)if(!(a.times.length<=0)){if(a.name.endsWith(n))this.rootStartPosition=new y().fromArray(a.values,0),this.rootEndPosition=new y().fromArray(a.values,a.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),Un&&console.log(this.rootPositionOffset);else if(a.name.endsWith(o)&&(this.rootStartQuaternion=new P().fromArray(a.values,0),this.rootEndQuaternion=new P().fromArray(a.values,a.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),Un)){const l=new Pt().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}ui(Cd,"AnimationClipOffsetData");class Xo extends ss{constructor(){super(...arguments);r(this,"models",[]);r(this,"trackOffset");r(this,"target");r(this,"mixer");r(this,"clips",[]);r(this,"actions",[]);r(this,"_actionOffsets",[]);r(this,"_didBind",!1);r(this,"_useclipOffsets",!0);r(this,"_totalOffsetPosition",new y);r(this,"_totalOffsetRotation",new P);r(this,"_totalOffsetPosition2",new y);r(this,"_totalOffsetRotation2",new P);r(this,"_summedPos",new y);r(this,"_tempPos",new y);r(this,"_summedRot",new P);r(this,"_tempRot",new P)}createHooks(t){for(const e of t.tracks)e.name.endsWith(".position")?this.createPositionInterpolant(e):e.name.endsWith(".quaternion")&&this.createRotationInterpolant(e)}bind(){if(!this._didBind){this._didBind=!0,Un&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const t of this.actions){const e=new Cd(t);this._actionOffsets.push(e)}for(const t of this.models){const e=t.asset,s=e.position,n=e.rotation;s.x!==void 0&&(s.isVector3||(e.position=new y(s.x,s.y,s.z)),n.isQuaternion||(e.rotation=new P(n.x,n.y,n.z,n.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const t=this.trackOffset.position;t&&(t.isVector3||(this.trackOffset.position=new y(t.x,t.y,t.z)));const e=this.trackOffset.rotation;e&&(e.isQuaternion||(this.trackOffset.rotation=new P(e.x,e.y,e.z,e.w)))}}evaluate(t){if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let e=0,s=0,n=!1;for(let o=0;o<this.clips.length;o++){const a=this.models[o],l=this.actions[o],c=a.asset;l.weight=0;const h=t>=a.start&&t<=a.end,d=a.postExtrapolationMode;let u=h;if(!u&&!n&&a.end<t&&a.postExtrapolationMode!==is.None){const _=o<this.clips.length-1?this.models[o+1]:null;(!_||_.start>t)&&(u=!0,n=!0)}if(u){let _=1;_*=this.evaluateWeight(t,o,this.models,u);let b=this.getClipTime(t,a),x=0;const O=c.duration;if(h){if(c.loop)for(x+=Math.floor(b/O);b>O;)b-=O}else if(!h)switch(d){case is.Loop:b%=O;break;case is.PingPong:const lt=Math.floor(b/O)%2!=0;b%=O,lt&&(b=O-b);break}l.time=b,l.timeScale=0;const R=_*this.director.weight;if(l.weight=R,l.clampWhenFinished=!0,l.isRunning()||l.play(),this._useclipOffsets){const M=e==0?this._totalOffsetPosition:this._totalOffsetPosition2,lt=e==0?this._totalOffsetRotation:this._totalOffsetRotation2;e<1&&(s=1-_),e+=1;const F=this._summedPos.set(0,0,0),T=this._tempPos.set(0,0,0),B=this._summedRot.identity(),vs=this._tempRot.identity(),ws=c.rotation,ae=new P;ae.slerp(ws,_);const Pi=this._actionOffsets[o];if(Pi.hasOffsets)for(let Ta=0;Ta<x;Ta++)Pi.rootPositionOffset?T.copy(Pi.rootPositionOffset):T.set(0,0,0),T.applyQuaternion(B).applyQuaternion(ae),Pi.rootQuaternionOffset&&(vs.copy(Pi.rootQuaternionOffset),B.multiply(vs)),F.add(T);lt.multiply(ae),lt.multiply(B),F.add(c.position),M.add(F)}}}this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,s),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,s)),this.mixer.update(t)}createRotationInterpolant(t){var o;const e=t.createInterpolant.bind(t),s=new P;this.ensureTrackOffsets();const n=(o=this.trackOffset)==null?void 0:o.rotation;t.createInterpolant=()=>{const a=e(),l=a.evaluate.bind(a);return a.evaluate=c=>{const h=l(c);return s.set(h[0],h[1],h[2],h[3]),s.premultiply(this._totalOffsetRotation),n&&s.premultiply(n),h[0]=s.x,h[1]=s.y,h[2]=s.z,h[3]=s.w,h},a}}createPositionInterpolant(t){var a,l;const e=t.createInterpolant.bind(t),s=new y;this.ensureTrackOffsets();const n=(a=this.trackOffset)==null?void 0:a.rotation,o=(l=this.trackOffset)==null?void 0:l.position;t.createInterpolant=()=>{const c=e(),h=c.evaluate.bind(c);return c.evaluate=d=>{const u=h(d);return s.set(u[0],u[1],u[2]),s.applyQuaternion(this._totalOffsetRotation),s.add(this._totalOffsetPosition),n&&s.applyQuaternion(n),o&&(s.x-=o.x,s.y+=o.y,s.z+=o.z),u[0]=s.x,u[1]=s.y,u[2]=s.z,u},c}}}ui(Xo,"AnimationTrackHandler");class Qo extends ss{constructor(){super(...arguments);r(this,"models",[]);r(this,"listener");r(this,"audio",[]);r(this,"audioContextTimeOffset",[]);r(this,"lastTime",0)}getAudioFilePath(t){const e=this.director.sourceId;return rl(e,t)}onAllowAudioChanged(t){for(let e=0;e<this.models.length;e++){const s=this.models[e];this.audio[e].setVolume(t?s.asset.volume:0)}}addModel(t){const e=this.getAudioFilePath(t.asset.clip),s=new Ua(this.listener);s.setVolume(t.asset.volume);const n=new br;console.log(e,this.director.sourceId),n.load(e,o=>{s.setBuffer(o),s.loop=t.asset.loop,this.audio.push(s),this.models.push(t)})}onDisable(){for(const t of this.audio)t.isPlaying&&t.stop()}onMuteChanged(){if(this.muted)for(let t=0;t<this.audio.length;t++){const e=this.audio[t];(e==null?void 0:e.isPlaying)&&e.stop()}}evaluate(t){if(!this.track.muted){for(let e=0;e<this.models.length;e++){const s=this.models[e],n=this.audio[e];if(t>=s.start&&t<=s.end){if(this.director.isPaused&&(n.isPlaying&&n.stop(),this.lastTime===t))continue;n.isPlaying||(n.offset=s.clipIn+(t-s.start)*s.timeScale,n.play());let o=s.asset.volume;s.easeInDuration>0&&(o*=Math.min((t-s.start)/s.easeInDuration,1)),s.easeOutDuration>0&&(o*=Math.min((s.end-t)/s.easeOutDuration,1)),n.setVolume(o*this.director.weight)}else n.isPlaying&&n.stop()}this.lastTime=t}}}ui(Qo,"AudioTrackHandler");class Nn extends ss{constructor(){super(...arguments);r(this,"models",[]);r(this,"didTrigger",[]);r(this,"receivers",[])}evaluate(t){if(!(this.receivers.length<=0)&&!this.track.muted)for(let e=0;e<this.models.length;e++){const s=this.models[e],n=this.didTrigger[e],o=s.time-t;if(s.retroActive?o<0:o<0&&Math.abs(o)<.1){if(!n){this.didTrigger[e]=!0;for(const l of this.receivers)!l||l.invoke(s.asset)}}else s.emitOnce||(this.didTrigger[e]=!1)}}}ui(Nn,"SignalTrackHandler");const ys=class extends ss{constructor(){super(...arguments);r(this,"models",[]);r(this,"timelines",[]);r(this,"_previousActiveModel",null)}resolveSourceObjects(t){for(let e=this.models.length-1;e>=0;e--){const n=this.models[e].asset;if(typeof n.sourceObject=="string"){const o=n.sourceObject;ys.resolved[o]?n.sourceObject=ys.resolved[o]:(n.sourceObject=p.findByGuid(o,t.scene),ys.resolved[o]=n.sourceObject)}if(n.sourceObject){const o=p.getComponent(n.sourceObject,rs);this.timelines.push(o),o&&n.updateDirector&&(o.playOnAwake=!1)}else{this.models.splice(e,1);continue}}}evaluate(t){var e;this._previousActiveModel=null;for(let s=0;s<this.models.length;s++){const n=this.models[s],o=n.asset;if(t>=n.start&&t<=n.end){this._previousActiveModel=n;const a=this.getClipTime(t,n);if(o.controlActivation){const l=o.sourceObject;l.visible=!0}if(o.updateDirector){const l=this.timelines[s];l&&(l.isPlaying&&l.pause(),l.time=a,l.evaluate())}}else{const a=(e=this._previousActiveModel)==null?void 0:e.asset;if(o.controlActivation){const l=o.sourceObject;(a==null?void 0:a.sourceObject)!==l&&(l.visible=!1)}}}}};let ns=ys;r(ns,"resolved",{});ui(ns,"ControlTrackHandler");var kb=Object.defineProperty,Tb=(i,t)=>kb(i,"name",{value:t,configurable:!0});const Sd=w("debugtimeline");var Rd;(function(i){i[i.Hold=0]="Hold",i[i.Loop=1]="Loop",i[i.None=2]="None"})(Rd||(Rd={}));var Ed;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(Ed||(Ed={}));const cr=class extends v{constructor(){super(...arguments);r(this,"playableAsset");r(this,"playOnAwake");r(this,"extrapolationMode",1);r(this,"_visibilityChangeEvt");r(this,"_clonedPlayableAsset",!1);r(this,"_guidsMap");r(this,"_isPlaying",!1);r(this,"_internalUpdateRoutine");r(this,"_isPaused",!1);r(this,"_time",0);r(this,"_duration",0);r(this,"_weight",1);r(this,"_animationTracks",[]);r(this,"_audioTracks",[]);r(this,"_signalTracks",[]);r(this,"_controlTracks",[]);r(this,"_customTracks",[]);r(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks])}static registerCreateTrack(t,e){this.createTrackFunctions[t]=e}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(t){this._time=t}get duration(){return this._duration}set duration(t){this._duration=t}get weight(){return this._weight}set weight(t){this._weight=t}awake(){var t,e,s;Sd&&console.log(this,(t=this.playableAsset)==null?void 0:t.tracks),this.rebuildGraph(),this.playOnAwake?this.play():this.evaluate(),this.isValid()||console.warn("PlayableDirector is not valid",this.playableAsset,(e=this.playableAsset)==null?void 0:e.tracks,Array.isArray((s=this.playableAsset)==null?void 0:s.tracks),this)}onEnable(){var t,e;for(const s of this._audioTracks)(t=s.onEnable)==null||t.call(s);for(const s of this._customTracks)(e=s.onEnable)==null||e.call(s);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var t,e;this.stop();for(const s of this._audioTracks)(t=s.onDisable)==null||t.call(s);for(const s of this._customTracks)(e=s.onDisable)==null||e.call(s);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var t;for(const e of this._audioTracks)(t=e.onDestroy)==null||t.call(e)}rebuildGraph(){!this.isValid()||(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}play(){!this.isValid()||(this._isPaused=!1,!this._isPlaying&&(this._isPlaying=!0,this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate())))}pause(){this._isPaused=!0}stop(){this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.evaluate()),this._isPlaying=!1,this._isPaused=!1,this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null}evaluate(){if(!this.isValid())return;let t=this._time;switch(this.extrapolationMode){case 0:t=Math.min(t,this._duration);break;case 1:t%=this._duration;break;case 2:if(t>this._duration){this.stop();return}break}this.internalEvaluate(t)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const t of this._allTracks)for(const e of t)yield e}get audioTracks(){return this._audioTracks}resolveGuids(t){this._guidsMap=t}*internalUpdate(){for(;this._isPlaying;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime,this.evaluate()),yield}internalEvaluate(t){for(const e of this.playableAsset.tracks)if(!e.muted)switch(e.type){case At.Activation:for(let s=0;s<e.outputs.length;s++){const n=e.outputs[s];if(typeof n=="object"){let o=!1;for(const l of e.clips)l.start<=t&&t<=l.end&&(o=!0);const a=n;a.visible!==void 0&&(a.visible=o)}}break}for(const e of this._animationTracks)e.evaluate(t);for(const e of this._audioTracks)e.evaluate(t);for(const e of this._signalTracks)e.evaluate(t);for(const e of this._controlTracks)e.evaluate(t);for(const e of this._customTracks)e.evaluate(t)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=Cs(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const t=this.findRoot(this.gameObject);for(const e of this.playableAsset.tracks)for(let s=e.outputs.length-1;s>=0;s--){let n=e.outputs[s];if(typeof n=="string"){this._guidsMap&&this._guidsMap[n]&&(n=this._guidsMap[n]);const o=p.findByGuid(n,t);o===null||typeof o!="object"?(e.outputs.splice(s,1),console.warn("Failed to resolve binding",n,e.name,e.type)):(Sd&&console.log("Resolved binding",n,"to",o),e.outputs[s]=o)}else if(n===null){if(e.outputs.splice(s,1),cr.createTrackFunctions[e.type])continue;e.type!==At.Audio&&e.type!==At.Control&&e.type!==At.Marker&&console.warn("Missing binding",n,e.name,e.type,this.name,this.playableAsset.name)}}}findRoot(t){return t.parent?this.findRoot(t.parent):t}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const t of this.playableAsset.tracks)if(t.muted!==!0)for(const e of t.clips)e.end>this._duration&&(this._duration=e.end)}}setupAndCreateTrackHandlers(){var e,s;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;const t=[];for(const n of this.playableAsset.tracks){const o=n.type,a=cr.createTrackFunctions[o];if(a!=null){const l=a(this,n);if(typeof l.evaluate=="function"){l.director=this,l.track=n,this._customTracks.push(l);continue}}if(n.type===At.Animation){if(n.clips.length<=0)continue;for(let l=n.outputs.length-1;l>=0;l--){const c=n.outputs[l];typeof c.enabled=="boolean"&&(c.enabled=!1);const h=(e=c==null?void 0:c.gameObject)==null?void 0:e.animations;if(h){const d=new Xo;d.trackOffset=n.trackOffset,d.director=this,d.track=n;for(let u=0;u<n.clips.length;u++){const _=n.clips[u],b=_.asset;if(!b){console.error("MISSING anim model?","clip#"+u,_,n,this.playableAsset,this.name);continue}const x=b.clip;let O=x;if((typeof O=="string"||typeof O=="number")&&(O=h.find(M=>M.name===x)),!O){console.warn("Could not find animationClip for model",_,n.name,this.name,(s=this.playableAsset)==null?void 0:s.name);continue}d.mixer||(d.mixer=new _r(c.gameObject)),d.clips.push(O),d.mixer.uncacheAction(O),d.createHooks(O);const R=d.mixer.clipAction(O);d.actions.push(R),d.models.push(_)}this._animationTracks.push(d)}}}else if(n.type===At.Audio){if(n.clips.length<=0)continue;t.push(n)}else if(n.type===At.Marker){const l=new Nn;l.director=this,l.track=n;for(const c of n.markers)switch(c.type){case qo.Signal:l.models.push(c),l.didTrigger.push(!1);break}if(l!==null&&l.models.length>0){const c=p.getComponent(this.gameObject,Bn);c&&(l.receivers.push(c),this._signalTracks.push(l))}}else if(n.type===At.Signal){const l=new Nn;l.director=this,l.track=n;for(const c of n.markers)l.models.push(c),l.didTrigger.push(!1);for(const c of n.outputs)l.receivers.push(c);this._signalTracks.push(l)}else if(n.type===At.Control){const l=new ns;l.director=this,l.track=n;for(const c of n.clips)l.models.push(c);l.resolveSourceObjects(this.context),this._controlTracks.push(l)}}nt.registerWaitForAllowAudio(()=>{const n=p.findObjectOfType(ji,this.context);if(!!n)for(const o of t){const a=new Qo;a.director=this,a.track=o,a.listener=n.listener;for(let l=0;l<o.clips.length;l++){const c=o.clips[l];a.addModel(c)}this._audioTracks.push(a)}})}setAudioTracksAllowPlaying(t){for(const e of this._audioTracks)e.onAllowAudioChanged(t)}};let rs=cr;r(rs,"createTrackFunctions",{});Tb(rs,"PlayableDirector");var Lb=Object.defineProperty,Db=(i,t)=>Lb(i,"name",{value:t,configurable:!0});class fi{constructor(t){r(this,"used",!1);r(this,"inputSource");r(this,"object");r(this,"isDown");r(this,"isUp");r(this,"isPressed");r(this,"isClicked");r(this,"event");this.event=t}Use(){this.used=!0}StopPropagation(){var t;(t=this.event)==null||t.stopImmediatePropagation()}}Db(fi,"PointerEventData");var Mb=Object.defineProperty,Ad=(i,t)=>Mb(i,"name",{value:t,configurable:!0});const Ib=w("debugeventsystem"),Gt=class extends v{constructor(){super();r(this,"orbitControl",null);r(this,"orbitControlWasEnabled",!1);r(this,"raycaster",[]);r(this,"lastPointerEvent",null);r(this,"objectsHoveredThisFrame",[]);r(this,"objectsHoveredLastFrame",[]);r(this,"raisedPointerDownEvents",[]);r(this,"_didMove",!1);r(this,"_tempComponentsArray",[]);r(this,"_sortedHits",[]);r(this,"_sortingBuffer",[]);r(this,"_noDepthTestingResults",[]);r(this,"handleEventsArray",[]);r(this,"currentActiveMeshUIComponents",[]);Gt.systems.push(this)}static createIfNoneExists(t){this.didSearchEventSystem||(this.didSearchEventSystem=!0,Gt.systems.length<=0&&Gt.systems.push(...p.findObjectsOfType(Gt,t)));for(const s of Gt.systems)if(s.context===t)return;const e=new S;p.addNewComponent(e,Gt),t.scene.add(e)}static ensureUpdateMeshUI(t,e){$t.update(t,e)}static markUIDirty(t){$t.markDirty()}static get instance(){return this.systems[0]}onDestroy(){Gt.systems.splice(Gt.systems.indexOf(this),1)}start(){}register(t){var e;t&&this.raycaster&&!this.raycaster.includes(t)&&((e=this.raycaster)==null||e.push(t))}unregister(t){var s,n;const e=(s=this.raycaster)==null?void 0:s.indexOf(t);e!==void 0&&e!==-1&&((n=this.raycaster)==null||n.splice(e,1))}onEnable(){j.addEventListener(ft.SelectStart,(e,s)=>{if(!s.grab)return;$t.resetLastSelected();const n=new fi;n.inputSource=e,n.isDown=e.selectionDown,n.isUp=e.selectionUp,n.isPressed=e.selectionPressed,n.isClicked=!1,s.grab&&!this.handleEvents(s.grab,n)&&(s.grab=null)});const t=new Dt;j.addEventListener(ft.SelectEnd,(e,s)=>{if(!s.grab)return;const n=new fi;n.inputSource=e,n.isDown=e.selectionDown,n.isUp=e.selectionUp,n.isPressed=e.selectionPressed,n.isClicked=e.selectionClick,this.handleEvents(s.grab,n)}),j.addEventListener(ft.Update,e=>{t.ray=e.getRay();const s=this.performRaycast(t);if(!s)return;const n=new fi;n.inputSource=e,this.handleIntersections(s,n)}),this.context.pre_update_callbacks.push(this.onBeforeUpdate.bind(this)),this.context.input.addEventListener(Ms.PointerDown,this.onPointerDown.bind(this))}onDisable(){}onPointerDown(){this.onBeforeUpdate()}onBeforeUpdate(){var s;if(this.objectsHoveredThisFrame.length=0,this.resetMeshUIStates(),E.IsInWebXR||this.context.input.isKeyPressed(Xt.ALT))return;if(!this._didMove){const n=this.context.input.getPointerPositionRC(0);if(n&&n.x===0&&n.y===0)return;this._didMove=!0}const t=this.performRaycast(null),e=new fi(this.context.input.getPointerEvent(0));e.inputSource=this.context.input,e.isClicked=this.context.input.mouseClick,e.isDown=this.context.input.mouseDown,e.isUp=this.context.input.mouseUp,e.isPressed=this.context.input.mousePressed,this.lastPointerEvent=e,!!t&&(this.handleIntersections(t,e),this.context.input.mouseDown&&this.currentActiveMeshUIComponents.length>0&&this.context.mainCameraComponent?(this.orbitControl=p.getComponent(this.context.mainCameraComponent.gameObject,ii),((s=this.orbitControl)==null?void 0:s.enabled)&&(this.orbitControlWasEnabled=this.orbitControl.enabled,this.orbitControl.enabled=!1)):this.orbitControl&&!this.context.input.mousePressed&&(this.orbitControl.enabled=this.orbitControlWasEnabled,this.orbitControl=null))}onBeforeRender(){if(this.lastPointerEvent)this.lastPointerEvent.used=!1;else return;if(this.lastPointerEvent.isUp){for(const e of this.raisedPointerDownEvents)e.onPointerUp&&e.onPointerUp(this.lastPointerEvent);this.raisedPointerDownEvents.length=0}for(const e of this.objectsHoveredLastFrame)if(this.objectsHoveredThisFrame.indexOf(e)<0){this._tempComponentsArray.length=0;const s=p.getComponentsInParent(e,v,this._tempComponentsArray);this.lastPointerEvent.object=e;for(let n=0;n<s.length;n++){const o=s[n];if(!o.gameObject||o.destroyed)continue;const a=o;a.onPointerExit&&a.onPointerExit(this.lastPointerEvent)}}const t=this.objectsHoveredLastFrame;this.objectsHoveredLastFrame=this.objectsHoveredThisFrame,this.objectsHoveredThisFrame=t}performRaycast(t){if(!this.raycaster)return null;this._sortedHits.length=0;for(const e of this.raycaster){if(!e.activeAndEnabled)continue;const s=e.performRaycast(t);s&&s.length>0&&this._sortedHits.push(...s)}return this._sortedHits.sort((e,s)=>e.distance-s.distance),this._sortedHits}handleIntersections(t,e){if(!t||t.length<=0)return!1;t=this.sortCandidates(t);for(const s of t){const{object:n}=s;if(this.handleEvents(n,e))return!0}return!1}sortCandidates(t){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let e=0;e<t.length;e++){const s=t[e],n=s.object;if(n.material&&n.material.depthTest===!1){this._noDepthTestingResults.push(s);continue}this._sortingBuffer.push(s)}for(const e of this._sortingBuffer)this._noDepthTestingResults.push(e);return this._noDepthTestingResults}handleEvents(t,e){var a,l;if(!this.testIsVisible(t))return e.isClicked&&Ib&&console.log("not allowed",t),!1;e.object=t,this.lastPointerEvent=e;const s=t.parent;let n=!1;(a=e.isClicked)!=null;let o=null;if(s&&s.isUI){const c=(l=e.isPressed||e.isClicked)!=null?l:!1;if(s.shadowComponentOwner){const h=s.shadowComponentOwner.gameObject;if(h){if(o=this.tryFindCanvasGroup(h),(o==null?void 0:o.blocksRaycasts)===!1)return!1;if((o==null?void 0:o.interactable)===!1)return!0;this.handleMeshUIIntersection(t,c),t=h,n=!0}}if(!n&&this.handleMeshUiObjectWithoutShadowDom(s,c))return!0}if(this.objectsHoveredThisFrame.push(t),o===null||o.interactable){const c=this.objectsHoveredLastFrame.indexOf(t)>=0;this.handleEventsArray.length=0;const h=p.getComponentsInParent(t,v,this.handleEventsArray);for(let d=0;d<h.length;d++){if(e.used)return!0;if(h[d].destroyed)continue;const u=h[d];u.interactable!==!1&&(u.onPointerEnter&&(c||u.onPointerEnter(e)),e.isDown&&u.onPointerDown&&!this.raisedPointerDownEvents.includes(u)&&(u.onPointerDown(e),this.raisedPointerDownEvents.push(u)),e.isUp&&u.onPointerUp&&u.onPointerUp(e),e.isClicked&&u.onPointerClick&&u.onPointerClick(e))}}return!0}handleMeshUiObjectWithoutShadowDom(t,e){return!t||!t.isUI?!0:this.handleMeshUIIntersection(t,e)}handleMeshUIIntersection(t,e){const s=$t.updateState(t,e);return s&&this.currentActiveMeshUIComponents.push(s),s!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&$t.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let t=0;t<this.currentActiveMeshUIComponents.length;t++){const e=this.currentActiveMeshUIComponents[t];$t.resetState(e)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(t){return t?p.isActiveSelf(t)?this.testIsVisible(t.parent):!1:!0}tryFindCanvasGroup(t){if(!t)return null;const e=p.foreachComponent(t,s=>{const n=s;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n},!1);return e!==void 0?e:this.tryFindCanvasGroup(t.parent)}};let zt=Gt;r(zt,"didSearchEventSystem",!1),r(zt,"systems",[]);Ad(zt,"EventSystem");class $t{static markDirty(){this.needsUpdate=!0}static update(t,e){for(const s of this.lastUpdateFrame)if(s.context===e){if(e.time.frameCount===s.frame)return;s.frame=e.time.frameCount,(this.needsUpdate||e.time.frameCount<30)&&(this.needsUpdate=!1,t.update());return}this.lastUpdateFrame=[{context:e,frame:e.time.frameCount}],t.update()}static updateState(t,e){let s=null;if(t&&(s=this.findBlockInParent(t),s&&s!==this.lastSelected)){if(s.interactable===!1)return null;e?(this.lastSelected=s,s.states.pressed&&s.setState("pressed")):s.states.hovered&&s.setState("hovered"),this.needsUpdate=!0}return s}static resetLastSelected(){const t=this.lastSelected;!t||(this.lastSelected=null,this.resetState(t))}static resetState(t){if(!t)return;t.interactable===!1?t.states.disabled&&t.setState("disabled"):t===this.lastSelected&&t.states.selected?t.setState("selected"):t.setState("normal"),this.needsUpdate=!0}static findBlockInParent(t){return t?t.isBlock&&Object.keys(t.states).length>0?t:this.findBlockInParent(t.parent):null}}r($t,"lastSelected",null),r($t,"lastUpdateFrame",[]),r($t,"needsUpdate",!1);Ad($t,"MeshUIHelper");var kd=Object.defineProperty,jb=Object.getOwnPropertyDescriptor,Yo=(i,t)=>kd(i,"name",{value:t,configurable:!0}),zn=(i,t,e,s)=>{for(var n=s>1?void 0:s?jb(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&kd(t,e,n),n};class Td{constructor(){r(this,"width");r(this,"height")}}Yo(Td,"Size");class Jo{constructor(){r(this,"x");r(this,"y");r(this,"width");r(this,"height")}}Yo(Jo,"Rect");class He extends v{constructor(){super(...arguments);r(this,"rect");r(this,"sizeDelta");r(this,"anchoredPosition3D");r(this,"pivot")}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get m_AnchoredPosition(){return this.gameObject.position}applyAnchoring(t){if(this.pivot&&this.sizeDelta){const e=this.pivot.x*2-1,s=this.pivot.y*2-1,n=this.sizeDelta.x*e,o=this.sizeDelta.y*s;t.x+=n*.5,t.y-=o*.5}}getBasicOptions(){const t={width:this.rect.width,height:this.rect.height,offset:.001,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0};return this.ensureValidSize(t),t}ensureValidSize(t,e=100){return t.width<=0&&(t.width=e),t.height<=0&&(t.height=1e-7),t}createBlock(t){return t=le(le({},this.getBasicOptions()),t),new qa(t)}}Yo(He,"RectTransform");zn([g(Jo)],He.prototype,"rect",2);zn([g(V)],He.prototype,"sizeDelta",2);zn([g(y)],He.prototype,"anchoredPosition3D",2);zn([g(V)],He.prototype,"pivot",2);var Fb=Object.defineProperty,Bb=(i,t)=>Fb(i,"name",{value:t,configurable:!0});function $n(i,t,e=!0){var s;if(!!i&&(((s=i.material)==null?void 0:s.isMaterial)===!0&&(i.material.depthTest=!t),e))for(const n of i.children)$n(n,t,e)}Bb($n,"setRenderOnTop");var Ub=Object.defineProperty,Ld=(i,t)=>Ub(i,"name",{value:t,configurable:!0});const Ge="./include",Nb=w("debugui");qa.prototype.interactable={get(){return this.interactive},set(i){this.interactable=i}};class Se extends v{constructor(){super(...arguments);r(this,"shadowComponent",null);r(this,"_controlsChildLayout",!0);r(this,"_rect",null);r(this,"_root");r(this,"_renderOnTop",!1);r(this,"_parentComponent");r(this,"_lastMatrixWorld")}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(t){this._controlsChildLayout=t,this.shadowComponent&&(this.shadowComponent.autoLayout=t)}get rect(){return this._rect||(this._rect=p.getComponent(this.gameObject,He)),this._rect}get Root(){return this._root===void 0&&(this._root=p.getComponentInParent(this.gameObject,Wn)),this._root}set renderOnTop(t){t!==this._renderOnTop&&(this._renderOnTop=t,this.startCoroutine(this.updateRenderOnTop(),xt.OnBeforeRender))}get renderOnTop(){return this._renderOnTop}get isNested(){return this.Root!==null&&this.Root.gameObject!==this.gameObject.parent}markDirty(){zt.markUIDirty(this.context)}addToShadowComponent(t){if(this.removeShadowComponent(),this._parentComponent=p.getComponentInParent(this.gameObject.parent,Se),!this._parentComponent||!this._parentComponent.shadowComponent){console.warn("Component doesn't have a MeshUIBaseComponent parent anywhere. Do you have a UI element outside a Canvas?",this);return}t.name=this.gameObject.name+" (UI)",t.autoLayout=this._parentComponent.controlsChildLayout,t.shadowComponentOwner=this;const e=this.raycastTarget;t.traverse(s=>{s.shadowComponentOwner||(s.shadowComponentOwner=this),e===!1&&s.layers.set(2)}),this._parentComponent.shadowComponent.add(t),this.shadowComponent=t,this.applyTransform(),Mi&&t.add(new Oi(.5)),this.onAfterAddedToScene(),this.startCoroutine(this.updateRenderOnTop(),xt.OnBeforeRender)}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}*updateRenderOnTop(){yield,this.shadowComponent&&(this.onUpdateRenderOnTop(),$n(this.shadowComponent,this._renderOnTop))}onUpdateRenderOnTop(){}applyTransform(){var n,o;const t=this.shadowComponent;if(!t)return;const e=(this==null?void 0:this.isRoot())===!0,s=((n=this._parentComponent)==null?void 0:n.isRoot())===!0;if(e){const a=s?1/(((o=this.Root)==null?void 0:o.gameObject.scale.x)||1):1,l=C(this.gameObject);l.multiplyScalar(a),t.position.set(l.x,l.y,l.z);const c=yl(this.gameObject);t.scale.copy(c).multiplyScalar(a)}else{const a=this.gameObject.position;t.position.set(-a.x,a.y,-a.z),t.scale.copy(this.gameObject.scale)}t.quaternion.copy(this.gameObject.quaternion),s&&t.rotateY(Math.PI),this.rect.applyAnchoring(t.position),this._lastMatrixWorld.copy(this.gameObject.matrixWorld)}awake(){this._lastMatrixWorld=new Ot}setInteractable(t){this.shadowComponent&&(this.shadowComponent.interactable=t)}onBeforeRender(){this._lastMatrixWorld.equals(this.gameObject.matrixWorld)===!1&&(Nb&&console.log("updating",this.name),this.applyTransform()),zt.ensureUpdateMeshUI(cp,this.context)}isRoot(){return!1}}Ld(Se,"BaseUIComponent");class Wn extends Se{isRoot(){return!0}}Ld(Wn,"UIRootComponent");var Dd=Object.defineProperty,zb=Object.getOwnPropertyDescriptor,Md=(i,t)=>Dd(i,"name",{value:t,configurable:!0}),Id=(i,t,e,s)=>{for(var n=s>1?void 0:s?zb(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Dd(t,e,n),n};class Ve extends Se{constructor(){super(...arguments);r(this,"raycastTarget",!0);r(this,"_container",null);r(this,"_color",null);r(this,"_currentlyCreatingPanel",!1)}get color(){return this._color}set color(t){const e=!0;this._color=t,this._container&&e&&this.onColorChanged(this._color)}onColorChanged(t){this.setOptions({backgroundColor:t,backgroundOpacity:t.alpha,borderOpacity:t.alpha})}get m_Color(){return this.color}onBeforeRender(){super.onBeforeRender(),this.color=this.m_Color}setState(t){this.makePanel(),this._container&&this._container.setState(t)}setupState(t){this.makePanel(),this._container&&this._container.setupState(t)}setOptions(t){var e;this.makePanel(),this._container&&(this._container.set(t),(t.backgroundColor!==void 0||t.backgroundOpacity!==void 0)&&((e=this._container.updateBackgroundMaterial)==null||e.call(this._container)))}awake(){super.awake(),this.makePanel()}onEnable(){this._container&&this.addToShadowComponent(this._container)}onDisable(){this._container&&this.removeShadowComponent()}makePanel(){if(this._container||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const t={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:1};this.onBeforeCreate(t),this.onCreate(t),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated()}onBeforeCreate(t){}onCreate(t){this._container=this.rect.createBlock(t)}onAfterCreated(){}async setTexture(t){!t||(this.setOptions({backgroundOpacity:0}),t&&this.setOptions({backgroundTexture:t,borderRadius:0,backgroundOpacity:this.color.alpha}))}onAfterAddedToScene(){this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}}Md(Ve,"Graphic");Id([g(Jt)],Ve.prototype,"color",1);Id([g()],Ve.prototype,"raycastTarget",2);class Hn extends Ve{}Md(Hn,"MaskableGraphic");var jd=Object.defineProperty,$b=Object.getOwnPropertyDescriptor,Zo=(i,t)=>jd(i,"name",{value:t,configurable:!0}),Ko=(i,t,e,s)=>{for(var n=s>1?void 0:s?$b(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&jd(t,e,n),n};class ta{constructor(){r(this,"texture")}}Zo(ta,"Sprite");Ko([g(wr)],ta.prototype,"texture",2);class Gn extends Hn{constructor(){super(...arguments);r(this,"sprite")}onBeforeCreate(t){var e,s;((s=(e=this.sprite)==null?void 0:e.texture)==null?void 0:s.name)=="UISprite"&&(t.borderRadius=5,t.borderColor=new f(.4,.4,.4),t.borderOpacity=this.color.alpha,t.borderWidth=.3)}onAfterCreated(){var t,e,s;((e=(t=this.sprite)==null?void 0:t.texture)==null?void 0:e.name)!="UISprite"&&this.setTexture((s=this.sprite)==null?void 0:s.texture)}}Zo(Gn,"Image");Ko([g(ta)],Gn.prototype,"sprite",2);class ea extends Hn{constructor(){super(...arguments);r(this,"mainTexture")}async onAfterCreated(){this.setTexture(this.mainTexture)}}Zo(ea,"RawImage");Ko([g(wr)],ea.prototype,"mainTexture",2);var Fd=Object.defineProperty,Wb=Object.getOwnPropertyDescriptor,Hb=(i,t)=>Fd(i,"name",{value:t,configurable:!0}),pi=(i,t,e,s)=>{for(var n=s>1?void 0:s?Wb(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&Fd(t,e,n),n};const mi=w("debugbutton");var Bd;(function(i){i[i.None=0]="None",i[i.ColorTint=1]="ColorTint",i[i.SpriteSwap=2]="SpriteSwap",i[i.Animation=3]="Animation"})(Bd||(Bd={}));class Re extends v{constructor(){super(...arguments);r(this,"onClick");r(this,"_isHovered",!1);r(this,"colors");r(this,"transition");r(this,"animationTriggers");r(this,"animator");r(this,"_interactable",!0);r(this,"_isInit",!1);r(this,"_image")}onPointerEnter(t){var e;mi&&console.log("Button Enter",(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this._isHovered=!0,this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.highlightedTrigger)}onPointerExit(){var t;mi&&console.log("Button Exit",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this._isHovered=!1,this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.normalTrigger)}onPointerDown(t){var e;mi&&console.log("Button Down",(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.pressedTrigger)}onPointerUp(t){var e;mi&&console.log("Button Down",(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger)}onPointerClick(t){var e;mi&&console.trace("Button Click",this.onClick),(e=this.onClick)==null||e.invoke()}set interactable(t){this._interactable=t,this._image&&(this._image.setInteractable(t),t?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(t){this.interactable=t}awake(){mi&&console.log(this),this.init()}start(){var t;(t=this._image)==null||t.setInteractable(this.interactable)}init(){this._isInit||(this._isInit=!0,this._image=p.getComponent(this.gameObject,Gn),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(t){var _,b,x,O,R;t.setInteractable(this.interactable);const e=this.getFinalColor(t.color,(_=this.colors)==null?void 0:_.m_NormalColor),s={state:"normal",attributes:{backgroundColor:e,backgroundOpacity:e.alpha}};t.setupState(s);const n=this.getFinalColor(t.color,(b=this.colors)==null?void 0:b.m_HighlightedColor),o={state:"hovered",attributes:{backgroundColor:n,backgroundOpacity:n.alpha}};t.setupState(o);const a=this.getFinalColor(t.color,(x=this.colors)==null?void 0:x.m_PressedColor),l={state:"pressed",attributes:{backgroundColor:a,backgroundOpacity:a.alpha}};t.setupState(l);const c=this.getFinalColor(t.color,(O=this.colors)==null?void 0:O.m_SelectedColor),h={state:"selected",attributes:{backgroundColor:c,backgroundOpacity:c.alpha}};t.setupState(h);const d=this.getFinalColor(t.color,(R=this.colors)==null?void 0:R.m_DisabledColor),u={state:"disabled",attributes:{backgroundColor:d,backgroundOpacity:d.alpha}};t.setupState(u)}getFinalColor(t,e){return e?t.clone().multiply(e):t.clone()}}Hb(Re,"Button");pi([g(ee)],Re.prototype,"onClick",2);pi([g()],Re.prototype,"colors",2);pi([g()],Re.prototype,"transition",2);pi([g()],Re.prototype,"animationTriggers",2);pi([g(ue)],Re.prototype,"animator",2);pi([g()],Re.prototype,"interactable",1);var Gb=Object.defineProperty,Vb=(i,t)=>Gb(i,"name",{value:t,configurable:!0});class Ud extends Wn{awake(){super.awake(),this.shadowComponent=this.gameObject}onUpdateRenderOnTop(){for(const t of this.gameObject.getComponentsInChildren(Se))t.renderOnTop=this.renderOnTop}}Vb(Ud,"Canvas");var qb=Object.defineProperty,Xb=(i,t)=>qb(i,"name",{value:t,configurable:!0});class Nd extends v{constructor(){super(...arguments);r(this,"_alpha",1);r(this,"interactable",!0);r(this,"blocksRaycasts",!0);r(this,"_isDirty",!1);r(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(t){t!==this._alpha&&(this._alpha=t,this.markDirty())}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),xt.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){for(const t of p.getComponentsInChildren(this.gameObject,Ve,this._buffer)){const e=t.color;e.alpha=this._alpha,t.color=e}}}Xb(Nd,"CanvasGroup");var Qb=Object.defineProperty,Yb=(i,t)=>Qb(i,"name",{value:t,configurable:!0}),ia;(function(i){i[i.fr=0]="fr",i[i.ru=1]="ru",i[i.de=2]="de",i[i.es=3]="es",i[i.el=4]="el",i[i.nord=5]="nord",i[i.eng=6]="eng"})(ia||(ia={}));class zd extends Se{constructor(){super(...arguments);r(this,"font");r(this,"text");r(this,"keymap");r(this,"padding");r(this,"margin");r(this,"fontSize");r(this,"borderRadius");r(this,"colors",{keyboardBack:8750469,panelBack:2500134,button:3552822,hovered:1842204,selected:1088605});r(this,"keyboard",null);r(this,"_lastKeyPressed");r(this,"_lastKeyPressedStartTime",0);r(this,"_lastKeyPressedTime",0)}awake(){super.awake();const t=ia[this.keymap||6];this.makeKeyboard(t)}onEnable(){this.addToShadowComponent(this.keyboard)}onDisable(){this.removeShadowComponent()}makeKeyboard(t){!t&&!navigator.language&&(t="en");const e=this.font?this.font:"arial",s=this.rect,n=fr(le({},s.getBasicOptions()),{margin:this.margin||0,padding:this.padding||0,language:t,fontFamily:Ge+"/"+e+"-msdf.json",fontTexture:Ge+"/"+e+".png",fontSize:this.fontSize||6,backgroundColor:new f(this.colors.keyboardBack),backspaceTexture:Ge+"/backspace.png",shiftTexture:Ge+"/shift.png",enterTexture:Ge+"/enter.png",borderRadius:this.borderRadius||0,autoLayout:!1}),o=this.gameObject.scale;n.width*=this.gameObject.scale.x,n.height*=this.gameObject.scale.y,n.fontSize*=Math.max(o.x,o.y),this.keyboard=new hp(n),this.gameObject.scale.set(1,1,1),this.keyboard.keys.forEach(a=>{a.setupState({state:"normal",attributes:{offset:.003,backgroundColor:new f(this.colors.button),backgroundOpacity:1}}),a.setState("normal"),a.setupState({state:"hovered",attributes:{offset:.3,backgroundColor:new f(this.colors.hovered),backgroundOpacity:1}}),a.setupState({state:"pressed",attributes:{offset:.1,backgroundColor:new f(this.colors.selected),backgroundOpacity:1},onSet:()=>{var h,d,u;const l=a.info.input,c=a.info.command;if(this._lastKeyPressed!==l)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedTime>.05)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedStartTime<.5||c=="switch"||c=="shift"||c=="switch-set"){this._lastKeyPressedTime=this.context.time.time;return}if(this._lastKeyPressedTime=this.context.time.time,this._lastKeyPressed=l,c)switch(c){case"switch":this.keyboard.setNextPanel();break;case"switch-set":this.keyboard.setNextCharset();break;case"enter":this.tryAppend(`
`);break;case"space":this.tryAppend(" ");break;case"backspace":if(!((d=(h=this.text)==null?void 0:h.text)==null?void 0:d.length))break;((u=this.text)==null?void 0:u.text)&&(this.text.text=this.text.text.substring(0,this.text.text.length-1)||"");break;case"shift":this.keyboard.toggleCase();break}else a.info.input!==void 0&&this.tryAppend(a.info.input)}})})}tryAppend(t){this.text&&(this.text.text+=t,this.markDirty())}}Yb(zd,"Keyboard");var Jb=Object.defineProperty,Vn=(i,t)=>Jb(i,"name",{value:t,configurable:!0});class os extends v{constructor(){super(...arguments);r(this,"reverseArrangement",!1)}}Vn(os,"LayoutGroup");class $d extends os{}Vn($d,"VerticalLayoutGroup");class Wd extends os{}Vn(Wd,"HorizontalLayoutGroup");class Hd extends os{}Vn(Hd,"GridLayoutGroup");var Zb=Object.defineProperty,sa=(i,t)=>Zb(i,"name",{value:t,configurable:!0});class na extends v{awake(){zt.createIfNoneExists(this.context)}onEnable(){var t;(t=zt.instance)==null||t.register(this)}onDisable(){var t;(t=zt.instance)==null||t.unregister(this)}performRaycast(t=null){return null}}sa(na,"Raycaster");class as extends na{constructor(){super(...arguments);r(this,"targets",null);r(this,"raycastHits",[])}start(){this.targets=[this.gameObject]}performRaycast(t=null){return this.targets?(t!=null||(t=new Dt),t.targets=this.targets,t.results=this.raycastHits,this.context.physics.raycast(t)):null}}sa(as,"ObjectRaycaster");class Gd extends as{constructor(){super(...arguments);r(this,"eventCamera",null);r(this,"ignoreReversedGraphics",!1);r(this,"rootRaycaster",null)}}sa(Gd,"GraphicRaycaster");var Kb=Object.defineProperty,ty=(i,t)=>Kb(i,"name",{value:t,configurable:!0});class Vd extends v{constructor(){super(...arguments);r(this,"id",null);r(this,"keepAspect",!1)}start(){if(!this.id||!this.context.mainCamera)return;const t=document.getElementById(this.id);if(!t){console.warn('Could not find element with id "'+this.id+'"');return}t.style.display="block",t.style.visibility="hidden";const e=new dp(this.context.renderer,this.context.mainCamera);this.gameObject.add(e);const s=new up(t);e.add(s),s.visible=!1,console.log(s);const n=s.material;n.transparent=!0,setTimeout(()=>{s.visible=!0;const o=Ir(this.gameObject).clone();Es(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const a=new Qe;a.setFromObject(e),this.setWorldRotation(o.x,o.y,o.z);const l=a.max.x-a.min.x,c=a.max.y-a.min.y;if(this.keepAspect){const d=l/c;l>c?s.scale.set(1/l,1/c/d,1):s.scale.set(1/l*d,1/c,1)}else s.scale.set(1/l,1/c,1);const h=this.gameObject.scale;s.scale.multiply(h)},1)}}ty(Vd,"SpatialHtml");var qd=Object.defineProperty,ey=Object.getOwnPropertyDescriptor,ra=(i,t)=>qd(i,"name",{value:t,configurable:!0}),Wt=(i,t,e,s)=>{for(var n=s>1?void 0:s?ey(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&qd(t,e,n),n},Xd;(function(i){i[i.UpperLeft=0]="UpperLeft",i[i.UpperCenter=1]="UpperCenter",i[i.UpperRight=2]="UpperRight",i[i.MiddleLeft=3]="MiddleLeft",i[i.MiddleCenter=4]="MiddleCenter",i[i.MiddleRight=5]="MiddleRight",i[i.LowerLeft=6]="LowerLeft",i[i.LowerCenter=7]="LowerCenter",i[i.LowerRight=8]="LowerRight"})(Xd||(Xd={}));var Qd;(function(i){i[i.Truncate=0]="Truncate",i[i.Overflow=1]="Overflow"})(Qd||(Qd={}));var Yd;(function(i){i[i.Wrap=0]="Wrap",i[i.Overflow=1]="Overflow"})(Yd||(Yd={}));var Jd;(function(i){i[i.Normal=0]="Normal",i[i.Bold=1]="Bold",i[i.Italic=2]="Italic",i[i.BoldAndItalic=3]="BoldAndItalic"})(Jd||(Jd={}));class vt extends Ve{constructor(){super(...arguments);r(this,"canvas");r(this,"alignment",0);r(this,"verticalOverflow",0);r(this,"horizontalOverflow",0);r(this,"lineSpacing",1);r(this,"supportRichText",!1);r(this,"font");r(this,"fontStyle",0);r(this,"_isWaitingForRebuild",!1);r(this,"_text","");r(this,"_fontSize",12);r(this,"_textMeshUi",null);r(this,"_textContainer",null);r(this,"_didHandleTextRenderOnTop",!1)}get text(){return this._text}set text(t){if(this._text=t,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:t}),this.markDirty()}}set_text(t){this.text=t}get fontSize(){return this._fontSize}set fontSize(t){if(this._fontSize=t,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:t}),this.markDirty()}}onColorChanged(t){if(this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({fontColor:t,fontOpacity:t.alpha}),this.markDirty()}}requestRebuild(){this._isWaitingForRebuild||(this._isWaitingForRebuild=!0,this.startCoroutine(this.rebuildDelayedRoutine(),xt.EarlyUpdate))}*rebuildDelayedRoutine(){if(this._isWaitingForRebuild=!1,this._textMeshUi){for(const t of this._textMeshUi)t.removeFromParent();this._textMeshUi.length=0}this.createText(this.text,this.getTextOpts(),this.supportRichText),this.markDirty()}onCreate(t){const e=this.verticalOverflow==0&&this.horizontalOverflow==0;e&&(this.context.renderer.localClippingEnabled=!0);const s=this.rect;this._textContainer=this._container=this.createBlock(s,e,null,!0),this.createText(this.text,this.getTextOpts(),this.supportRichText),this._container,this._container=this.createBlock(s,e,this._container,!1)}onUpdateRenderOnTop(){super.onUpdateRenderOnTop(),this.handleTextRenderOnTop()}getTextOpts(){var e;const t={content:this.text,fontColor:this.color,fontOpacity:this.color.alpha,fontSize:this.fontSize,fontKerning:"normal"};return this.font=(e=this.font)==null?void 0:e.toLocaleLowerCase(),this.setFont(t,this.fontStyle),t}onEnable(){super.onEnable(),this._didHandleTextRenderOnTop=!1,this._container&&(this._container.onAfterUpdate=this.updateWidth.bind(this))}createBlock(t,e,s,n=!1){const o={};o.hiddenOverflow=e,o.interLine=(this.lineSpacing-1)*this.fontSize*1.333,this.getAlignment(o,n);const a=t.createBlock(o);return s&&(Array.isArray(s)?a.add(...s):a.add(s)),a}getAlignment(t,e=!1){switch(e||(t.contentDirection="row"),this.alignment){default:case 0:case 1:case 2:t.justifyContent="start";break;case 3:case 4:case 5:t.justifyContent="center";break;case 6:case 7:case 8:t.justifyContent="end";break}switch(this.alignment){case 0:case 3:case 6:t.alignContent=e?"left":"top";break;case 1:case 4:case 7:t.alignContent="center";break;case 2:case 5:case 8:t.alignContent=e?"right":"bottom";break}return t}updateWidth(){this.horizontalOverflow===1&&setTimeout(()=>{if(!this._textMeshUi)return;const t=this._textMeshUi[0].parent;if(!!t&&t.lines){let e=t.lines.reduce((s,n)=>s+n.width,0);e+=t.getFontSize()*3,e+=t.padding*2||0,t.set({width:e})}},1)}createText(t,e,s){if(!(!t||t.length<=0))if(this._textMeshUi||(this._textMeshUi=[]),s){let n=this.getNextTag(t);if(n)n.startIndex>0&&this.createText(t.substring(0,n.startIndex),e,!1);else return this.createText(t,e,!1);const o=[];for(;n;){const a=this.getNextTag(t,n.endIndex);if(a){const l=this.getText(t,n,a);this.handleTag(n,e,o),this.createText(l,e,!1)}else{const l=t.substring(n.endIndex);this.handleTag(n,e,o),this.createText(l,e,!1)}n=a}}else{const n=le({},e);n.content=t;const o=new fp(n);this._textMeshUi.push(o),this._textContainer&&this._textContainer.add(o)}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){const t=[];for(;;){let e=!1;if(this._textMeshUi)for(let s=0;s<this._textMeshUi.length;s++){if(t[s]===!0)continue;e=!0;const n=this._textMeshUi[s];!n.textContent||($n(n,this.renderOnTop,!0),t[s]=!0)}if(!e)break;yield}}handleTag(t,e,s){if(t.isEndTag){if(s.length>0){const n=s.pop();if(n)for(const o in n.previousValues){const a=n.previousValues[o];e[o]=a}}}else if(t.type.includes("color")){const n=new qn(t,{fontColor:e.fontColor});if(s.push(n),t.type.length>6){const o=t.type.substring(6);e.fontColor=Zd(o)}else e.fontColor=new f(1,1,1)}else if(t.type=="b"){const n=new qn(t,{fontFamily:e.fontFamily,fontTexture:e.fontTexture});s.push(n),this.setFont(e,1)}else if(t.type=="i"){const n=new qn(t,{fontFamily:e.fontFamily,fontTexture:e.fontTexture});s.push(n),this.setFont(e,2)}}getText(t,e,s){return t.substring(e.endIndex,s.startIndex)}getNextTag(t,e=0){const s=t.indexOf("<",e),n=t.indexOf(">",s);if(s>=0&&n>=0){const o=t.substring(s+1,n);return{type:o,startIndex:s,endIndex:n+1,isEndTag:o.startsWith("/")}}return null}setFont(t,e){t.fontFamily=Ge+"/"+this.getFontName(e)+"-msdf.json",t.fontTexture=Ge+"/"+this.getFontName(e)+".png"}getFontName(t){if(!this.font)return null;switch(t){case 0:return this.font;case 1:return this.font+"-bold";case 2:return this.font+"-italic";case 3:return this.font+"-bold-italic"}return null}}ra(vt,"Text");Wt([g()],vt.prototype,"canvas",2);Wt([g()],vt.prototype,"alignment",2);Wt([g()],vt.prototype,"verticalOverflow",2);Wt([g()],vt.prototype,"horizontalOverflow",2);Wt([g()],vt.prototype,"lineSpacing",2);Wt([g()],vt.prototype,"supportRichText",2);Wt([g()],vt.prototype,"font",2);Wt([g()],vt.prototype,"fontStyle",2);Wt([g()],vt.prototype,"text",1);Wt([g()],vt.prototype,"fontSize",1);class qn{constructor(t,e){r(this,"tag");r(this,"previousValues");this.tag=t,this.previousValues=e}}ra(qn,"TagStackEntry");function Zd(i){if(i.startsWith("#")){const e=i.substring(1);var t=parseInt(e,16);const s=t>>16&255,n=t>>8&255,o=t&255;return new f(s/255,n/255,o/255)}switch(i){case"black":return new f(0,0,0);case"white":return new f(1,1,1);case"red":return new f(1,0,0);case"lime":return new f(0,1,0);case"blue":return new f(0,0,1);case"yellow":return new f(1,1,0);case"cyan":return new f(0,1,1);case"magenta":return new f(1,0,1);case"silver":return new f(.75,.75,.75);case"gray":return new f(.5,.5,.5);case"maroon":return new f(.5,0,0);case"olive":return new f(.5,.5,0);case"green":return new f(0,.5,0);case"purple":return new f(.5,0,.5);case"teal":return new f(0,.5,.5);case"navy":return new f(0,0,.5);case"darkred":return new f(.54,0,0);case"brown":return new f(.55,.27,0);case"firebrick":return new f(.69,.13,.13);case"crimson":return new f(.86,.08,.24);case"tomato":return new f(1,.39,.28);case"coral":return new f(1,.49,.31);case"indianred":return new f(.6,.31,.51);case"lightcoral":return new f(.94,.5,.5);case"darkorange":return new f(1,.55,0);case"orange":return new f(1,.65,0);case"gold":return new f(1,.84,0);case"darkgoldenrod":return new f(.72,.53,.04);case"goldenrod":return new f(.85,.65,.13);case"palegoldenrod":return new f(.93,.87,.67);case"darkkhaki":return new f(.74,.7,.42);case"khaki":return new f(.94,.9,.55);case"yellowgreen":return new f(.6,.8,.19);case"darkolivegreen":return new f(.33,.42,.18);case"olivedrab":return new f(.42,.56,.14);case"lawngreen":return new f(.49,.99,0);case"chartreuse":return new f(.5,1,0);case"greenyellow":return new f(.68,1,.18);case"darkgreen":return new f(0,.39,0);case"forestgreen":return new f(.13,.55,.13);case"limegreen":return new f(.19,.8,.19);case"lightgreen":return new f(.56,.93,.56);case"palegreen":return new f(.59,.98,.59);case"darkseagreen":return new f(.56,.74,.56);case"mediumspringgreen":return new f(0,.98,.6);case"springgreen":return new f(0,1,.5);case"seagreen":return new f(.18,.31,.31);case"mediumaquamarine":return new f(.4,.8,.66);case"mediumseagreen":return new f(.24,.7,.44);case"lightseagreen":return new f(.13,.7,.67);case"darkslategray":return new f(.18,.31,.31);case"darkcyan":return new f(0,.55,.55);case"aqua":return new f(0,1,1);case"lightcyan":return new f(.8,1,1);case"darkturquoise":return new f(0,.81,.82);case"turquoise":return new f(0,.82,.82);case"mediumturquoise":return new f(.28,.82,.8);case"paleturquoise":return new f(.68,1,.93);case"aquamarine":return new f(.5,1,.83);case"powderblue":return new f(.69,.88,.9);case"cadetblue":return new f(.37,.62,.63);case"steelblue":return new f(.27,.51,.71);case"cornflowerblue":return new f(.39,.58,.93);case"deepskyblue":return new f(0,.7,1);case"dodgerblue":return new f(.12,.56,1);case"lightblue":return new f(.68,.85,.9);case"skyblue":return new f(.53,.81,.92);case"lightskyblue":return new f(.53,.81,.98);case"midnightblue":return new f(.18,.18,.31);case"darkblue":return new f(0,0,.55);case"mediumblue":return new f(0,0,.82);case"royalblue":return new f(.25,.41,.88);case"blueviolet":return new f(.54,.17,.89);case"indigo":return new f(.29,0,.51);case"darkslateblue":return new f(.28,.24,.55);case"slateblue":return new f(.42,.35,.8);case"mediumslateblue":return new f(.48,.41,.9);case"mediumpurple":return new f(.58,.44,.86);case"darkmagenta":return new f(.55,0,.55);case"darkviolet":return new f(.58,0,.83);case"darkorchid":return new f(.6,.2,.8);case"mediumorchid":return new f(.73,.33,.83);case"thistle":return new f(.84,.75,.85);case"plum":return new f(.87,.63,.87);case"violet":return new f(.93,.51,.93);case"fuchsia":return new f(1,0,1);case"orchid":return new f(.85,.44,.84);case"mediumvioletred":return new f(.78,.08,.52);case"palevioletred":return new f(.86,.44,.58);case"hotpink":return new f(1,.4,.71);case"deeppink":return new f(1,.08,.58);case"lightpink":return new f(1,.71,.76);case"pink":return new f(1,.75,.78);case"antiquewhite":return new f(.98,.92,.84);case"beige":return new f(.96,.96,.86);case"bisque":return new f(1,.89,.77);case"blanchedalmond":return new f(1,.92,.82);case"wheat":return new f(.96,.87,.87);case"cornsilk":return new f(1,.97,.86);case"lemonchiffon":return new f(1,.98,.8);case"lightgoldenrodyellow":return new f(.98,.98,.82);case"lightyellow":return new f(1,1,.8);case"saddlebrown":return new f(.55,.27,.07);case"sienna":return new f(.63,.32,.18);case"chocolate":return new f(.82,.41,.12);case"peru":return new f(.82,.52,.25);case"sandybrown":return new f(.96,.64,.38);case"burlywood":return new f(.87,.72,.53);case"tan":return new f(.82,.71,.55);case"rosybrown":return new f(.74,.56,.56);case"moccasin":return new f(1,.89,.71);case"navajowhite":return new f(1,.87,.68);case"peachpuff":return new f(1,.85,.73);case"mistyrose":return new f(1,.89,.88);case"lavenderblush":return new f(1,.94,.93);case"linen":return new f(.98,.94,.9);case"oldlace":return new f(.99,.96,.9);case"papayawhip":return new f(1,.94,.84);case"seashell":return new f(1,.96,.93);case"mintcream":return new f(.98,1,.98);case"slategray":return new f(.44,.5,.56);case"lightslategray":return new f(.47,.53,.6);case"lightsteelblue":return new f(.69,.77,.87);case"lavender":return new f(.9,.9,.98);case"floralwhite":return new f(1,.98,.98);case"aliceblue":return new f(.94,.97,1);case"ghostwhite":return new f(.97,.97,1);case"honeydew":return new f(.94,1,.94);case"ivory":return new f(1,1,.94);case"azure":return new f(.94,1,1);case"snow":return new f(1,.98,.98);case"dimgray":return new f(.4,.4,.4);case"darkgray":return new f(.66,.66,.66);case"lightgray":return new f(.83,.83,.83);case"gainsboro":return new f(.86,.86,.86);case"whitesmoke":return new f(.96,.96,.96)}return new f(1,1,1)}ra(Zd,"getColorFromString");var iy=Object.defineProperty,sy=(i,t)=>iy(i,"name",{value:t,configurable:!0});class Kd extends v{constructor(){super(...arguments);r(this,"toggleKey",Xt.KEY_P)}update(){this.context.input.isKeyDown(Xt.KEY_P)&&this.context.domElement.classList.toggle("presentation-mode")}}sy(Kd,"PresentationMode");var ny=Object.defineProperty,tu=(i,t)=>ny(i,"name",{value:t,configurable:!0});const ka=class{constructor(t,e){r(this,"id",0);r(this,"points",[]);r(this,"line",new xr.exports.MeshLine);r(this,"material");r(this,"mesh");r(this,"defaultLineMaterial",new xr.exports.MeshLineMaterial({color:10066329,lineWidth:.01}));if(e&&(this.material=e.material),this.material||(this.material=this.defaultLineMaterial),e){const s=e.options;s&&Object.assign(this.material,s)}this.mesh=new Je(this.line,this.material),t.add(this.mesh)}appendPoint(t){var n;let e=ka.wp;e.set(t.x,t.y,t.z);const s=(n=this.mesh)==null?void 0:n.parent;return s&&(e=s.worldToLocal(e),t.x=e.x,t.y=e.y,t.z=e.z),this.points.push(t.x,t.y,t.z),this.line.setPoints(this.points),t}};let ls=ka;r(ls,"wp",new y);tu(ls,"LineInstanceHandler");class Xn extends v{constructor(){super(...arguments);r(this,"finished",[]);r(this,"inFlight",[]);r(this,"buffer",{});r(this,"freeBuffer",new Array)}startLine(t,e){const s=Math.random()*Number.MAX_SAFE_INTEGER;return this.internalStartLine(t,s,!0,e)}updateLine(t,e){const s=this.inFlight[t.id];if(!s)return;e.point&&(e.point=s.appendPoint(e.point));const n=this.buffer[t.id];n&&(e.point&&n.push(e.point.x,e.point.y,e.point.z),n.length>5&&(this.sendLineUpdate(s,!1,void 0,n),n.length=0))}endLine(t,e=!0){const s=this.inFlight[t.id];if(!s)return;this.finished.push(s),delete this.inFlight[t.id],e&&this.sendLineUpdate(s,!0,0);const n=this.buffer[t.id];if(n){delete this.buffer[t.id];const o=n;o.length=0,this.freeBuffer.push(o)}return s}getLine(t){return this.inFlight[t.id]}awake(){this.context.connection.beginListen("line-start",t=>{this.onEnsureLine(t.id,t.parentGuid)}),this.context.connection.beginListen("line-update",t=>{let e=this.onEnsureLine(t.guid,t.parentGuid);e&&t.points&&(t.startIndex<=0?e.points=t.points:t.startIndex>=e.points.length&&e.points.push(...t.points),e.line.setPoints(e.points),e.material.lineWidth=t.width,e.material.color.fromArray(t.color),t.finished===!0&&this.endLine({id:e.id},!1))})}onEnsureLine(t,e){if(this.inFlight[t])return this.inFlight[t];let s=p.findByGuid(e,this.context.scene);if(!!s)return this.internalStartLine(s,t,!1),this.inFlight[t]}internalStartLine(t,e,s=!0,n){const o=new ls(t!=null?t:this.context.scene,n);o.id=e,this.inFlight[e]=o,s&&this.sendLineStart(o);let a;return this.freeBuffer.length<=0?a=new Array:a=this.freeBuffer.pop(),this.buffer[e]=a,{id:e}}sendLineStart(t){const e=t.mesh.parent;this.context.connection.send("line-start",{id:t.id,parentGuid:e?e.guid:void 0})}sendLineUpdate(t,e,s,n){if(t){const o={parentGuid:t.mesh.parent.guid,guid:t.id,points:n?[...n]:t.points,width:t.material.lineWidth,color:t.material.color.toArray(),startIndex:s!==void 0?s:t.points.length,finished:e};this.context.connection.send("line-update",o)}}}tu(Xn,"LinesManager");var ry=Object.defineProperty,eu=(i,t)=>ry(i,"name",{value:t,configurable:!0});class oa{constructor(){r(this,"isDrawing");r(this,"lastHit");r(this,"currentHandle");r(this,"maxDistance");r(this,"prevDistance");r(this,"lastParent");this.isDrawing=!1,this.lastHit=new y,this.currentHandle=null,this.maxDistance=0,this.prevDistance=0,this.lastParent=null}}eu(oa,"LineState");const hr=class extends v{constructor(){super(...arguments);r(this,"lines");r(this,"colliders");r(this,"alignToSurface",!0);r(this,"addToPaintedObject",!0);r(this,"orbit");r(this,"_states",{});r(this,"_raycastOptions",new Dt)}start(){var e;this.lines||(this.lines=p.getComponent(this.gameObject,Xn),this.lines||(this.lines=p.addNewComponent(this.gameObject,Xn))),this.orbit=(e=p.findObjectOfType(ii,this.context))!=null?e:void 0,this._states.mouse=new oa;const t={};j.addEventListener(ft.SelectStart,(s,n)=>{t[s.controller.uuid]=!0}),j.addEventListener(ft.Update,(s,n)=>{if(t[s.controller.uuid]===!0){const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!1,!1)}}),j.addEventListener(ft.SelectEnd,(s,n)=>{t[s.controller.uuid]=!1;const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!0,!1)})}update(){this.orbit&&this._states.mouse&&this.orbit&&(this.orbit.enabled=!this._states.mouse.isDrawing);const t=this.context.input.getPointerPressedCount()>1,e=this.context.input.getPointerPositionRC(0);hr._raycaster.setFromCamera(e,this.context.mainCamera);const s=hr._raycaster.ray;this.updateLine("mouse",s,this.context.input.getPointerPressed(0),this.context.input.getPointerUp(0),t||this.context.input.isKeyPressed(Xt.ALT))}updateLine(t,e,s,n,o=!1){var l;let a=this._states[t];if(a||(this._states[t]=new oa,a=this._states[t]),n)a.isDrawing=!1,a.currentHandle&&(this.lines.endLine(a.currentHandle),a.currentHandle=null);else if(s){if(o)return a;const c=this.getHit(e);let h=null,d=a.prevDistance;if(c)a.currentHandle||(a.maxDistance=c.distance),h=c.point,h.add(c.face.normal.multiplyScalar(.01)),a.prevDistance=c.distance;else if(a.maxDistance>0){if(a.maxDistance,!a.currentHandle&&a.lastHit){const u=C(this.context.mainCamera);a.lastHit.distanceTo(u)}h=e.origin.add(e.direction.multiplyScalar(a.maxDistance)),a.prevDistance=a.maxDistance}if(h){if(!a.currentHandle){let u=(l=a.lastParent)!=null?l:this.gameObject;this.addToPaintedObject&&c&&(u=c.object),a.lastParent=u,a.currentHandle=this.lines.startLine(u,{material:this.createRandomMaterial()})}if(this.alignToSurface&&(a.prevDistance>a.maxDistance||Math.abs(d-a.prevDistance)>.2)){const u=a.maxDistance;h=e.origin.add(e.direction.multiplyScalar(u)),a.prevDistance=u}if(a.lastHit&&a.lastHit.distanceTo(h)<a.prevDistance*.01)return a;this.lines.updateLine(a.currentHandle,{point:h}),a.lastHit.copy(h)}a.isDrawing=a.currentHandle!==null}return a}getHit(t){(!this.colliders||this.colliders.length===0)&&(this.colliders=[this.gameObject]),this._raycastOptions.targets=this.colliders,this._raycastOptions.ray=t;const e=this.context.physics.raycast(this._raycastOptions);if(e.length>0){for(const s of e)if(!!p.isActiveInHierarchy(s.object))return s}return null}createRandomMaterial(){let t;return this.context.connection.connectionId?t=Oe.colorFromHashCode(Oe.hashCode(this.context.connection.connectionId)):t=new f("hsl("+(Math.random()*100).toFixed(0)+", 80%, 30%)"),new xr.exports.MeshLineMaterial({color:t,lineWidth:k.lerp(.005,.01,Math.random())})}};let Qn=hr;r(Qn,"_raycaster",new pr);eu(Qn,"LinesDrawer");var oy=Object.defineProperty,cs=(i,t)=>oy(i,"name",{value:t,configurable:!0});const iu=w("debugautosync");class su{constructor(){r(this,"_syncers",{})}getOrCreateSyncer(t){if(!t.guid)return null;if(this._syncers[t.guid])return this._syncers[t.guid];const e=new ru(t);return this._syncers[t.guid]=e,e}}cs(su,"ComponentsSyncerManager");const nu=new su;class ru{constructor(t){r(this,"comp");r(this,"hasChanges",!1);r(this,"changedProperties",{});r(this,"data",{});r(this,"_boundEvent");r(this,"_isReceiving",!1);r(this,"_isInit",!1);this.comp=t}get networkingKey(){return this.comp.constructor.name}init(t){if(this._isInit)return;this._isInit=!0,this.comp=t,this._boundEvent=this.onHandleSending.bind(this),this.comp.context.post_render_callbacks.push(this._boundEvent),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving.bind(this));const e=this.comp.context.connection.tryGetState(this.comp.guid);e&&this.onHandleReceiving(e)}notifyChanged(t,e){this._isReceiving||(this.hasChanges=!0,this.changedProperties[t]=e)}onHandleSending(){if(!this.hasChanges)return;this.hasChanges=!1;const t=this.comp.context.connection;if(!t||!t.isConnected){for(const e in this.changedProperties)delete this.changedProperties[e];return}for(const e in this.data)delete this.data[e];this.data.guid=this.comp.guid;for(const e in this.changedProperties){const s=this.changedProperties[e];delete this.changedProperties[e],this.data[e]=s}t.send(this.networkingKey,this.data)}onHandleReceiving(t){if(!this._isInit||!this.comp)return;const e=t.guid;if(!(e&&e!==this.comp.guid)){iu&&console.log("RECEIVED",this.comp.name,this.comp.guid,t);try{this._isReceiving=!0;for(const s in t){if(s==="guid")continue;const n=t[s];this.comp[s]=n}}catch(s){console.error(s)}finally{this._isReceiving=!1}}}}cs(ru,"ComponentPropertiesSyncer");function ou(i,t){let e=t!==i;if(!e&&i&&t){if(Array.isArray(i)&&Array.isArray(t))e=!0;else if(typeof i=="object"&&typeof t=="object"){for(const s of Object.keys(i))if(i[s]!==t[s]){e=!0;break}}}return e}cs(ou,"testValueChanged");function au(i){if(i.__autoPropertySyncHandler)return i.__autoPropertySyncHandler;const t=nu.getOrCreateSyncer(i);return t==null||t.init(i),i.__autoPropertySyncHandler=t,t}cs(au,"getSyncer");const ay=cs(function(i){return function(t,e){let s=null;const n=i?t[i]:void 0,o=t,a=o.__internalAwake;iu&&console.log(e);const l=e+"k__BackingField";o.__internalAwake=function(){if(this[l]!==void 0)return;this[l]=this[e],a.call(this),s=nu.getOrCreateSyncer(this);const c=Object.getOwnPropertyDescriptor(this,e);(c==null?void 0:c.set)===void 0&&Object.defineProperty(this,e,{set:function(h){var u;const d=this[l];this[l]=h,ou(h,d)&&(n==null?void 0:n.call(this,h,d))!==!1&&((u=au(this))==null||u.notifyChanged(e,h))},get:function(){return this[l]},configurable:!0,enumerable:!0}),s==null||s.init(this)}}},"syncField");var lu=Object.defineProperty,ly=Object.getOwnPropertyDescriptor,cu=(i,t)=>lu(i,"name",{value:t,configurable:!0}),hu=(i,t,e,s)=>{for(var n=s>1?void 0:s?ly(t,e):t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(t,e,n):a(n))||n);return s&&n&&lu(t,e,n),n};class aa extends v{constructor(){super(...arguments);r(this,"asset");r(this,"joinedRoomFunction")}awake(){this.watchTabVisible(),this.joinedRoomFunction=this.onUserJoined.bind(this)}onEnable(){this.context.connection.beginListen(W.JoinedRoom,this.joinedRoomFunction)}onDisable(){this.context.connection.stopListening(W.JoinedRoom,this.joinedRoomFunction)}async onUserJoined(t){var s;const e=await((s=this.asset)==null?void 0:s.instantiateSynced({parent:this.gameObject},!0));if(e){let n=p.getComponent(e,gi);n&&(n.owner=this.context.connection.connectionId)}}watchTabVisible(){window.addEventListener("visibilitychange",t=>{if(document.visibilityState==="visible")for(let e=gi.all.length-1;e>=0;e--){const s=gi.all[e];(!s.owner||!this.context.connection.userIsInRoom(s.owner))&&s.doDestroy()}})}}cu(aa,"PlayerSync");hu([g(Bt)],aa.prototype,"asset",2);var dr;const kt=(dr=class extends v{constructor(){super(...arguments);r(this,"owner")}static get all(){return kt._all}static get local(){return kt._local}static isLocalPlayer(i){var t,e,s,n;return i instanceof S?(e=(t=p.getComponentInParent(i,kt))==null?void 0:t.isLocalPlayer)!=null?e:!1:i instanceof St&&(n=(s=p.getComponentInParent(i.gameObject,kt))==null?void 0:s.isLocalPlayer)!=null?n:!1}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}awake(){this.isLocalPlayer&&kt.local.push(this),kt.all.push(this),this.context.connection.beginListen(W.UserLeftRoom,i=>{if(i.userId===this.owner){this.doDestroy();return}})}start(){if(!this.owner||!this.context.connection.userIsInRoom(this.owner)){this.doDestroy();return}}doDestroy(){Ts(this.gameObject,this.context.connection)}onDestroy(){if(kt.all.splice(kt.all.indexOf(this),1),this.isLocalPlayer){const i=kt._local.indexOf(this);i>=0&&kt._local.splice(i,1)}}},r(dr,"_all",[]),r(dr,"_local",[]),dr);let gi=kt;cu(gi,"PlayerState");hu([ay(),g()],gi.prototype,"owner",2);m.add("AlignmentConstraint",Oc);m.add("Animation",Ue);m.add("AnimationCurve",so);m.add("Animator",ue);m.add("AnimatorController",ni);m.add("AudioListener",ji);m.add("AudioSource",nt);m.add("AvatarModel",lo);m.add("AvatarLoader",sn);m.add("AxesHelper",zi);m.add("BasicIKConstraint",Dc);m.add("BoxCollider",Mc);m.add("BoxHelperComponent",$i);m.add("Camera",U);m.add("InstantiateOptions",Ct);m.add("UnityObject",Ic);m.add("DeleteBox",uo);m.add("Deletable",Bc);m.add("DeviceFlag",fo);m.add("DragControls",ve);m.add("DropListener",vn);m.add("Duplicatable",ai);m.add("CallInfo",Xi);m.add("EventList",ee);m.add("EventTrigger",dh);m.add("FlyControls",uh);m.add("BoxGizmo",xn);m.add("GltfExportBox",bh);m.add("GltfExport",xe);m.add("GridHelper",Qi);m.add("Interactable",Wi);m.add("UsageMarker",Hi);m.add("LODModel",ci);m.add("LODGroup",On);m.add("Light",Pe);m.add("LookAtConstraint",Hs);m.add("MeshCollider",Rh);m.add("NavMesh",Ah);m.add("NavMeshAgent",kh);m.add("NestedGltf",Ao);m.add("Networking",je);m.add("OffsetConstraint",Lh);m.add("OrbitControls",ii);m.add("ParticleSystemRenderer",Lo);m.add("ParticleSystem",Bh);m.add("MainModule",Dh);m.add("EmissionModule",Mh);m.add("ShapeModule",Ih);m.add("PlayerColor",Oe);m.add("FieldWithDefault",Bl);m.add("Renderer",bt);m.add("MeshRenderer",Nr);m.add("SkinnedMeshRenderer",$l);m.add("InstancingUtil",ht);m.add("RendererLightmap",Is);m.add("Rigidbody",Ji);m.add("SceneSettings",zh);m.add("ScreenCapture",qh);m.add("SmoothFollow",Rn);m.add("SpatialTriggerReceiver",Zi);m.add("SpatialTrigger",kn);m.add("SpatialTriggerEventArgs",Io);m.add("SpectatorCamera",Jh);m.add("SphereCollider",Tn);m.add("SpringJoint",td);m.add("Sprite",jo);m.add("SpriteRenderer",Ki);m.add("SyncedCamera",In);m.add("SyncedRoom",We);m.add("SyncedTransform",ge);m.add("TestRunner",ud);m.add("TestSimulateUserData",fd);m.add("TransformGizmo",zo);m.add("VideoPlayer",Nt);m.add("Voip",_e);m.add("WebARSessionRoot",pn);m.add("WebXR",E);m.add("WebAR",wo);m.add("AvatarMarker",tt);m.add("WebXRAvatar",ye);m.add("TeleportTarget",_o);m.add("WebXRController",j);m.add("AttachedObject",Ft);m.add("XRGrabModel",$o);m.add("XRGrabRendering",gd);m.add("XRRig",bo);m.add("VRUserState",te);m.add("WebXRSync",bn);m.add("XRState",Kt);m.add("XRFlag",K);m.add("AvatarBlink_Simple",di);m.add("AvatarEyeLook_Rotation",es);m.add("Avatar_POI",at);m.add("Avatar_Brain_LookAt",hn);m.add("Avatar_MouthShapes",Fn);m.add("Avatar_MustacheShake",xd);m.add("LogStats",Pd);m.add("RGBAColor",Jt);m.add("PlayableDirector",rs);m.add("SignalAsset",Go);m.add("SignalReceiverEvent",Vo);m.add("SignalReceiver",Bn);m.add("AnimationTrackHandler",Xo);m.add("AudioTrackHandler",Qo);m.add("SignalTrackHandler",Nn);m.add("ControlTrackHandler",ns);m.add("BaseUIComponent",Se);m.add("UIRootComponent",Wn);m.add("Button",Re);m.add("Canvas",Ud);m.add("CanvasGroup",Nd);m.add("EventSystem",zt);m.add("Graphic",Ve);m.add("MaskableGraphic",Hn);m.add("Image",Gn);m.add("RawImage",ea);m.add("Keyboard",zd);m.add("LayoutGroup",os);m.add("VerticalLayoutGroup",$d);m.add("HorizontalLayoutGroup",Wd);m.add("GridLayoutGroup",Hd);m.add("PointerEventData",fi);m.add("Raycaster",na);m.add("ObjectRaycaster",as);m.add("GraphicRaycaster",Gd);m.add("Size",Td);m.add("Rect",Jo);m.add("RectTransform",He);m.add("SpatialHtml",Vd);m.add("Text",vt);m.add("PresentationMode",Kd);m.add("LinesDrawer",Qn);m.add("LineInstanceHandler",ls);m.add("LinesManager",Xn);m.add("PlayerSync",aa);m.add("PlayerState",gi);var cy=Object.defineProperty,Yn=(i,t)=>cy(i,"name",{value:t,configurable:!0});class du extends si{constructor(){super([f,Jt])}onDeserialize(t){if(t!=null)return t.a!==void 0?new Jt(t.r,t.g,t.b,t.a):t.alpha!==void 0?new Jt(t.r,t.g,t.b,t.alpha):new f(t.r,t.g,t.b)}onSerialize(t){if(t!=null)return t.a!==void 0?{r:t.r,g:t.g,b:t.b,a:t.a}:{r:t.r,g:t.g,b:t.b}}}Yn(du,"ColorSerializer");new du;class uu extends si{constructor(){super(S)}onSerialize(t,e){if(e.objectToNode!==void 0&&t.uuid){const s=e.objectToNode[t.uuid];return yt&&console.log(s,t.name,t.uuid),{node:s}}}onDeserialize(t,e){var s;if(t){if(t.node!==void 0&&e.nodeToObject){const n=e.nodeToObject[t.node];return yt&&console.log("Deserialized object reference?",t,n,e==null?void 0:e.nodeToObject),n||console.warn("Did not find node: "+t.node,e.nodeToObject,e.object),n}else if(t.guid){if(!e.context){console.error("Missing context");return}let n,o=(s=e.gltf)==null?void 0:s.scene;return o&&(n=p.findByGuid(t.guid,o)),n||(n=p.findByGuid(t.guid,e.context.scene)),n?yt&&console.log("Deserialized object reference?",t,n,e==null?void 0:e.nodeToObject):console.warn("could not resolve reference",t,e.target,e.path,e.context.scene),n}}}}Yn(uu,"ObjectSerializer");const hy=new uu;class fu extends si{constructor(){super([St,v])}onSerialize(t,e){if(t==null?void 0:t.guid)return{guid:t.guid}}onDeserialize(t,e){var s;if(t==null?void 0:t.guid){yt&&console.log(t.guid,e.root,e.object,e.target);const n=this.findObjectForGuid(t.guid,e.root);if(n)return n;if(e.context)return this.findObjectForGuid(t.guid,(s=e.context)==null?void 0:s.scene)}}findObjectForGuid(t,e){return p.foreachComponent(e,s=>{if(t===s.gameObject.guid)return s.gameObject;if(s.guid===t)return s})}}Yn(fu,"ComponentSerializer");const pu=new fu;class mu extends si{constructor(){super([ee])}onSerialize(t,e){console.log("TODO: SERIALIZE EVENT")}onDeserialize(t,e){var s,n;if(t&&t.type==="EventList"){yt&&console.log("DESERIALIZE EVENT",t);const o=new Array;for(const l of t.calls){yt&&console.log(l);const c=pu.findObjectForGuid(l.target,e.root),h=((s=l.method)==null?void 0:s.length)>0;let d;if(l.argument!==void 0){let u=l.argument;typeof u=="object"&&(u=hy.onDeserialize(l.argument,e),u||(u=pu.onDeserialize(l.argument,e))),d=new Xi(h?()=>c[l.method](u):void 0,l.enabled)}else d=new Xi(h?()=>c[l.method]():void 0,l.enabled);if(d.method||(d.__debuginfo=(n=e.object)==null?void 0:n.name),!c||!d.method){const u=e.object?"Current object: "+e.object.name+", "+e.object.guid:null;c?console.warn('EventList method not found: "'+l.method+'" on',c):console.warn("EventList is missing target - will be ignored",l.target,u,t)}else o.push(d)}const a=new ee(o);return yt&&console.log(a),a}}}Yn(mu,"EventListSerializer");new mu;var dy=Object.defineProperty,hs=(i,t)=>dy(i,"name",{value:t,configurable:!0});const gu=yt;function _u(i,t){const s=mc(i,t);return s!==void 0?s:null}hs(_u,"writeBuiltinComponentData");async function la(i,t,e,s=null,n){if(!e)return;let o=s;typeof o=="number"&&(o=new _t(s));const a=new to(e.scene);a.gltfId=t,a.context=i,a.gltf=e,a.nodeToObject=n==null?void 0:n.nodeToObjectMap;const l=[];if(e.scenes)for(const c of e.scenes)await Zn(a,c,l);if(e.children)for(const c of e.children)await Zn(a,c,l);i.new_scripts_pre_setup_callbacks.push(()=>{for(const c of l)bu(c,a);if(o){Jn(e,o);for(const c of e.scenes)Jn(c,o)}})}hs(la,"createBuiltinComponents");function Jn(i,t){if(t!==null&&!!i){if(i.guid=t.generateUUID(),i&&i.userData&&i.userData.components)for(const e of i.userData.components)e!==null&&(e.guid=t.generateUUID());if(i.children)for(const e of i.children)Jn(e,t)}}hs(Jn,"recursiveCreateGuids");const ds=[];async function Zn(i,t,e,s){if(!t)return;const n=t.userData;if(n){const o=n.builtin_components;if(o&&o.length>0)for(const a of o)try{if(a===null)continue;const l=m.get(a.name);if(l!=null){const c=new l;c.sourceId=i.gltfId,io(c,a),ul(c,t,!1),e.push({instance:c,compData:a,obj:t})}else gu&&console.debug("unknown component: "+a.name),ds.includes(a.name)||ds.push(a.name)}catch(l){console.error(a.name+" - "+l.message,l)}if(ds.length>0){const a=ds.join(", ");console.warn("unknown components: "+a),ds.length=0}}if(t.children)for(const o of t.children)await Zn(i,o,e)}hs(Zn,"onCreateBuiltinComponents");function bu(i,t){const{instance:e,compData:s,obj:n}=i;t.object=n,t.target=e,Zs(e,s,t),gu&&console.debug("add "+s.name,s,e)}hs(bu,"handleDeserialization");const uy=new Xa;async function yu(i){return new Promise((t,e)=>{uy.load(i,t,void 0,e)})}var fy=Object.defineProperty,se=(i,t)=>fy(i,"name",{value:t,configurable:!0});const us=new Uint8Array(4);us[0]=255;us[1]=255;us[2]=255;us[3]=255;const py=new Qa(us,1,1,Ya);function vu(i){const t="alpha"in i,e=t?4:3,s=new Uint8Array(e);return s[0]=i.r,s[1]=i.g,s[2]=i.b,t&&(s[3]=i.alpha),new Qa(s,1,1,Ya)}se(vu,"createFlatTexture");var wu;(function(i){i[i.Vertex=0]="Vertex",i[i.Fragment=1]="Fragment"})(wu||(wu={}));class xu{constructor(t,e){r(this,"stage");r(this,"code");this.stage=t,this.code=e}}se(xu,"UnityShaderStage");class my{constructor(){r(this,"loaded",new Map)}async loadShader(t){const e=await yu(t);return JSON.parse(e)}async load(t,e){if(this.loaded.has(e))return new Promise((o,a)=>{const l=this.loaded.get(e);l?o(l):a("Shader not found")});const s=await yu(e),n=new xu(t,s);return this.loaded.set(e,n),n}}se(my,"ShaderLib");function fs(i,t){const e=i.elements;t||(t=[]),t.length=0;for(let s=0;s<16;s+=4){const n=e[s],o=e[s+1],a=e[s+2],l=e[s+3],c=new I(n,o,a,l);t.push(c)}return t}se(fs,"ToUnityMatrixArray");const ca=[],Pu=[];function ha(i,t){if(ca.length===0)for(let e=0;e<27;e++)ca.push(0);t||(t=ca);for(let e=0;e<27;e++)Pu[e]=t[e];t=Pu,i.unity_SHAr={value:new I(t[9],t[3],t[6],t[0])},i.unity_SHBr={value:new I(t[12],t[15],t[18],t[21])},i.unity_SHAg={value:new I(t[10],t[4],t[7],t[1])},i.unity_SHBg={value:new I(t[13],t[16],t[19],t[22])},i.unity_SHAb={value:new I(t[11],t[5],t[8],t[2])},i.unity_SHBb={value:new I(t[14],t[17],t[20],t[23])},i.unity_SHC={value:new I(t[24],t[25],t[26],1)}}se(ha,"SetUnitySphericalHarmonics");class Ou{constructor(t,e,s){r(this,"vertexShader");r(this,"fragmentShader");r(this,"technique");this.vertexShader=t,this.fragmentShader=e,this.technique=s}}se(Ou,"ShaderBundle");async function Cu(i,t){if(!i)return console.error("Can not find technique: no shader data"),null;const e=i.programs[t],s=e.vertexShader,n=e.fragmentShader;if(s!==void 0&&n!==void 0){const o=i.shaders[s],a=i.shaders[n];if(o.uri&&a.uri||o.code&&a.code){if(!o.code&&o.uri&&await da(o),!a.code&&a.uri&&await da(a),!o.code||!a.code)return null;const l=i.techniques[t];return new Ou(o.code,a.code,l)}}return console.error("Shader technique not found",t),null}se(Cu,"FindShaderTechniques");async function da(i){const t=i.uri;if(!!t)if(t.endsWith(".glsl")){const s=await new Xa().loadAsync(t);i.code=s.toString()}else i.code=Su(i.uri)}se(da,"loadShaderCode");function Su(i){return decodeURIComponent(Array.prototype.map.call(atob(i),function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)}).join(""))}se(Su,"b64DecodeUnicode");var gy=Object.defineProperty,_i=(i,t)=>gy(i,"name",{value:t,configurable:!0});class _y{constructor(){r(this,"programs",[]);r(this,"shaders",[]);r(this,"techniques",[])}}_i(_y,"ShaderData");class by{constructor(){r(this,"vertexShader");r(this,"fragmentShader")}}_i(by,"ShaderProgram");var Ru;(function(i){i[i.Fragment=35632]="Fragment",i[i.Vertex=35633]="Vertex"})(Ru||(Ru={}));class yy{constructor(){r(this,"name");r(this,"type");r(this,"uri");r(this,"code")}}_i(yy,"Shader");class vy{constructor(){r(this,"program");r(this,"attributes",new Map);r(this,"uniforms",new Map)}}_i(vy,"Technique");class wy{constructor(){r(this,"semantic")}}_i(wy,"ShaderAttribute");class xy{constructor(){r(this,"name","");r(this,"type");r(this,"semantic");r(this,"count",0);r(this,"node",0)}}_i(xy,"ShaderUniform");var ua;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(ua||(ua={}));var Py=Object.defineProperty,fa=(i,t)=>Py(i,"name",{value:t,configurable:!0});const ne=w("debugshaders"),bi="NEEDLE_techniques_webgl";var Eu;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(Eu||(Eu={}));class Au{constructor(){r(this,"objectToWorldMatrix",new Ot);r(this,"worldToObjectMatrix",new Ot);r(this,"objectToWorld",new Array);r(this,"worldToObject",new Array)}updateFrom(t){this.objectToWorldMatrix.copy(t.matrixWorld),fs(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(t.matrixWorld.invert()),fs(this.worldToObjectMatrix,this.worldToObject)}}fa(Au,"ObjectRendererData");var ku;(function(i){i[i.Off=0]="Off",i[i.Front=1]="Front",i[i.Back=2]="Back"})(ku||(ku={}));const N=class extends pp{constructor(t,...e){super(...e);r(this,"identifier");r(this,"_sphericalHarmonicsName","unity_SpecCube0");r(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");r(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");r(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");r(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");r(this,"_rendererData",new Au);r(this,"_lastFrame",-1);this.identifier=t,ne&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName]&&this.waitForLighting()}async waitForLighting(){const t=A.Current;if(!t){console.error("Missing context");return}const e=await t.rendererData.getSceneLightingData(this.identifier);if(!e||!e.array){console.warn("Missing lighting data for custom shader, getSceneLightingData did not return anything");return}ne&&console.log(e);const s=e.array,n=e.texture;this.uniforms.unity_SpecCube0={value:n},ha(this.uniforms,s);const o=Math.sqrt(Math.PI*.5);this.uniforms.unity_SpecCube0_HDR={value:new I(o,o,o,o)},ne&&console.log("Set environment lighting",this.uniforms)}onBeforeRender(t,e,s,n,o,a){n.attributes.tangent||n.computeTangents(),this.internalUpdateUniforms(s,o)}internalUpdateUniforms(t,e){const s=A.Current;if(s.time.frame==this._lastFrame)return;this._lastFrame=s.time.frame,this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=s.rendererData.timeVec4);const n=s==null?void 0:s.mainLight;if(n){const o=n.getWorldPosition(N._mainLightPosition);this.uniforms._MainLightPosition={value:o.normalize()},N._mainLightColor.set(n.color.r,n.color.g,n.color.b,0),this.uniforms._MainLightColor={value:N._mainLightColor};const a=n.intensity;N._lightData.z=a,this.uniforms.unity_LightData={value:N._lightData}}if(t&&(N.viewProjection&&this.uniforms[this._viewProjectionName]&&(N.viewProjection.copy(t.projectionMatrix).multiply(t.matrixWorldInverse),this.uniforms[this._viewProjectionName].value=fs(N.viewProjection,N._viewProjectionValues)),N.viewMatrix&&this.uniforms[this._viewMatrixName]&&(N.viewMatrix.copy(t.matrixWorldInverse),this.uniforms[this._viewMatrixName].value=fs(N.viewMatrix,N._viewMatrixValues)),this.uniforms[N._worldSpaceCameraPosName]&&(N._worldSpaceCameraPos.setFromMatrixPosition(t.matrixWorld),this.uniforms[N._worldSpaceCameraPosName]={value:N._worldSpaceCameraPos})),e){const o=this._rendererData;o.updateFrom(e),this.uniforms[this._worldToObjectName].value=o.worldToObject,this.uniforms[this._objToWorldName].value=o.objectToWorld}this.uniformsNeedUpdate=!0}};let wt=N;r(wt,"viewProjection",new Ot),r(wt,"_viewProjectionValues",[]),r(wt,"viewMatrix",new Ot),r(wt,"_viewMatrixValues",[]),r(wt,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),r(wt,"_worldSpaceCameraPos",new y),r(wt,"_mainLightColor",new I),r(wt,"_mainLightPosition",new y),r(wt,"_lightData",new I);fa(wt,"CustomShader");class Tu{constructor(t,e){r(this,"parser");r(this,"identifier");this.parser=t,this.identifier=e}get name(){return bi}loadMaterial(t){const e=this.parser.json.materials[t];if(!e)return ne&&console.log(t,this.parser.json.materials),null;if(!e.extensions||!e.extensions[bi])return ne&&console.log("material "+t+" does not use NEEDLE_techniques_webgl"),null;const s=e.extensions[bi].technique;if(s<0)return null;const n=this.parser.json.extensions[bi];if(!n)return null;ne&&console.log(n);const o=n.techniques[s];return o?new Promise(async(a,l)=>{var R,M,lt;const c=await Cu(n,o.program),h=c==null?void 0:c.fragmentShader,d=c==null?void 0:c.vertexShader;if(!h||!d)return l();ne&&console.log("loadMaterial",e,c);const u={},_=o.uniforms;for(const F in _){const T=F;switch(T){case"_TimeParameters":const B=new I;u[T]={value:B};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":u[T]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":u[T]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":u[T]={value:null};break}}let b=!1;if(e.extensions&&e.extensions[bi]){const F=e.extensions[bi];if(F.technique===s){ne&&console.log(e.name,"Material Properties",F);for(const T in F.values){const B=F.values[T];if(typeof B=="string"){if(B.startsWith("textures/")){const vs=B.substring(9),ws=Number.parseInt(vs);if(ws>=0){const ae=await this.parser.getDependency("texture",ws);ae&&(ae.encoding=mp,ae.needsUpdate=!0),u[T]={value:ae};continue}}switch(T){case"alphaMode":B==="BLEND"&&(b=!0);continue}}if(Array.isArray(B)&&B.length===4){u[T]={value:new I(B[0],B[1],B[2],B[3])};continue}u[T]={value:B}}}}const x=new wt(this.identifier,{name:(R=e.name)!=null?R:"",uniforms:u,vertexShader:d,fragmentShader:h,lights:!1});switch((M=u._Cull)==null?void 0:M.value){case 0:x.side=Va;break;case 1:x.side=gp;break;case 2:x.side=Ja;break;default:x.side=Ja;break}x.transparent=b,b&&(x.depthWrite=!1),ha(u),x.internalUpdateUniforms();for(const F in _){const T=F,B=_[F].type;if(((lt=u[T])==null?void 0:lt.value)===void 0)switch(B){case ua.SAMPLER_2D:u[T]={value:py},console.warn("Missing/unassigned texture, fallback to white: "+T);break;default:console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+T,_[F]);break}}ne&&console.log(x.uuid,u),a(x)}):null}}fa(Tu,"NEEDLE_techniques_webgl");var Oy=Object.defineProperty,Cy=(i,t)=>Oy(i,"name",{value:t,configurable:!0});const Lu="NEEDLE_gameobject_data";class Du{constructor(t){r(this,"parser");this.parser=t}get name(){return Lu}afterRoot(t){const e=[];for(let s=0;s<this.parser.json.nodes.length;s++){const n=this.parser.json.nodes[s];if(n&&n.extensions){const o=n.extensions[Lu];if(o){const a=this.findAndApplyExtensionData(s,o);e.push(a)}}}return Promise.all(e).then(()=>{})}async findAndApplyExtensionData(t,e){const s=await this.parser.getDependency("node",t);s&&this.applyExtensionData(s,e)}applyExtensionData(t,e){t.userData.layer=e.layers,t.userData.tag=e.tag,t.userData.hideFlags=e.hideFlags,t.userData.static=e.static,t.visible=e.activeSelf,t.guid=e.guid}}Cy(Du,"NEEDLE_gameobject_data");var Sy=Object.defineProperty,Ry=(i,t)=>Sy(i,"name",{value:t,configurable:!0});const Mu="NEEDLE_lightmaps",Ey=w("debuglightmapsextension");var re;(function(i){i[i.Lightmap=0]="Lightmap",i[i.Skybox=1]="Skybox",i[i.Reflection=2]="Reflection"})(re||(re={}));class Iu{constructor(t,e,s){r(this,"parser");r(this,"registry");r(this,"source");this.parser=t,this.registry=e,this.source=s}get name(){return Mu}afterRoot(t){const e=this.parser.json.extensions;if(e){const s=e[Mu];if(s){const n=s.textures;return n.length?(Ey&&console.log(s),new Promise(async(o,a)=>{const l=[];for(const c of n)if(c.pointer){const h=qs(this.parser,c.pointer).then(d=>{const u=d;(u==null?void 0:u.isTexture)&&(this.registry?(c.type!==0&&(u.encoding=Ye),this.registry.registerTexture(this.source,c.type,u,c.index)):console.log(re[c.type],c.pointer,u))});l.push(h)}await Promise.all(l),o()})):null}}return null}}Ry(Iu,"NEEDLE_lightmaps");var Ay=Object.defineProperty,ju=(i,t)=>Ay(i,"name",{value:t,configurable:!0}),Kn;(function(i){i[i.Skybox=0]="Skybox",i[i.Trilight=1]="Trilight",i[i.Flat=3]="Flat",i[i.Custom=4]="Custom"})(Kn||(Kn={}));var tr;(function(i){i[i.Skybox=0]="Skybox",i[i.Custom=1]="Custom"})(tr||(tr={}));class Fu{constructor(t){r(this,"context");r(this,"sceneLightSettings");r(this,"_timevec4",new I);r(this,"_waitPromise");r(this,"_lighting",{});this.context=t,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const t=this.context.time;this._timevec4.x=t.time,this._timevec4.y=Math.sin(t.time),this._timevec4.z=Math.cos(t.time),this._timevec4.w=t.deltaTime}get timeVec4(){return this._timevec4}registerSceneLightSettings(t){this.sceneLightSettings=t}registerReflection(t,e){const s=new Bu(this.context,e,1);this._lighting[t]=s}getReflection(t){return this._lighting[t]}enableReflection(t){var s;switch((s=this.sceneLightSettings)==null?void 0:s.ambientMode){case 0:case 4:break;case 3:if(this.sceneLightSettings.ambientLight){const n=vu(this.sceneLightSettings.ambientLight);this.context.scene.environment=n}return;default:return}const e=this.getReflection(t);if(e&&e.Source){const n=this.context.scene,o=e.Source;o.encoding=Ye,o.mapping=gr,n.environment=o}}async getSceneLightingData(t){return this._waitPromise?this._waitPromise:(this._waitPromise=new Promise((e,s)=>{let n=setInterval(async()=>{var a,l;const o=this.getReflection(t);o&&(clearInterval(n),e(o.getSphericalHarmonicsArray((l=(a=this.sceneLightSettings)==null?void 0:a.ambientIntensity)!=null?l:1)))},10)}),this._waitPromise)}}ju(Fu,"RendererData");class Bu{constructor(t,e,s=1){r(this,"_context");r(this,"_source");r(this,"_sphericalHarmonics",null);r(this,"_sphericalHarmonicsArray");r(this,"_ambientScale",1);r(this,"_lightProbe");this._context=t,this._source=e,this._ambientScale=s,e.mapping=gr,e.encoding=Ye}get Source(){return this._source}get Array(){return this._sphericalHarmonicsArray}getSphericalHarmonicsArray(t=1){var e;if(((e=this._sphericalHarmonicsArray)==null?void 0:e.length)&&this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:this._lightProbe};try{const s=this._source;let n=null;if(s){const o=Math.min(s.image.width,512);n=new _p(o).fromEquirectangularTexture(this._context.renderer,s),this._source=n.texture}if(this._sphericalHarmonicsArray=[],n){const o=bp.fromCubeRenderTarget(this._context.renderer,n);this._lightProbe=o;const a=this._ambientScale*(t*t*Math.PI*.5)-1;this._sphericalHarmonics=o.sh,this._sphericalHarmonicsArray=this._sphericalHarmonics.toArray();const l=t/(Math.PI*.5);for(let c=0;c<this._sphericalHarmonicsArray.length;c++)this._sphericalHarmonicsArray[c]*=l;if(o.sh.scale(a),this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:o}}}catch(s){console.error(s)}return null}}ju(Bu,"LightData");var ky=Object.defineProperty,Uu=(i,t)=>ky(i,"name",{value:t,configurable:!0});const Nu="NEEDLE_lighting_settings",Ty=w("debuglightingextensions");class zu{constructor(t,e,s){r(this,"parser");r(this,"sourceId");r(this,"context");this.parser=t,this.sourceId=e,this.context=s}get name(){return Nu}afterRoot(t){const e=this.parser.json.extensions;if(e){const s=e[Nu];if(s){Ty&&console.log(s);const n=p.addNewComponent(t.scene,$u,!1);n.sourceId=this.sourceId,n.ambientIntensity=s.ambientIntensity,n.ambientLight=new f().fromArray(s.ambientLight),n.ambientMode=s.ambientMode,n.defaultReflectionMode=s.defaultReflectionMode,this.context&&this.context.rendererData.registerSceneLightSettings(n)}}return null}}Uu(zu,"NEEDLE_lighting_settings");class $u extends v{constructor(){super(...arguments);r(this,"ambientMode",Kn.Skybox);r(this,"ambientLight");r(this,"ambientIntensity",1);r(this,"defaultReflectionMode",tr.Skybox);r(this,"_hasReflection",!1);r(this,"_ambientLightObj");r(this,"_lightProbeObj")}awake(){if(this.sourceId){const t=this.defaultReflectionMode===tr.Skybox?re.Skybox:re.Reflection,e=this.context.lightmaps.tryGet(this.sourceId,t,0);this._hasReflection=e!=null,e&&this.context.rendererData.registerReflection(this.sourceId,e)}}onEnable(){this.ambientMode==Kn.Flat?(this.ambientLight&&(this._ambientLightObj=new yp(this.ambientLight,Math.PI*this.ambientIntensity)),this._ambientLightObj&&this.gameObject.add(this._ambientLightObj),this._lightProbeObj&&this._lightProbeObj.removeFromParent()):(this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._lightProbeObj?this.enabled&&this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj):this.sourceId&&this.context.rendererData.getSceneLightingData(this.sourceId).then(t=>{!t||(this._lightProbeObj=t.lightProbe,this.enabled&&!this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj))})),this.sourceId&&this._hasReflection&&this.context.rendererData.enableReflection(this.sourceId)}}Uu($u,"SceneLightSettings");var Ly=Object.defineProperty,pa=(i,t)=>Ly(i,"name",{value:t,configurable:!0});function ma(i){const t=new Oo;return i.register(e=>(t.parser=e,t)),t}pa(ma,"registerComponentExtension");class Wu{resolvePath(t){return t.includes("/extensions/builtin_components/")&&(t=t.replace("/extensions/builtin_components/","/userData/components/")),t}}pa(Wu,"PointerResolver");function ga(i,t,e){i.register(n=>new Du(n)),i.register(n=>new fc(n)),i.register(n=>new Iu(n,t.lightmaps,e)),i.register(n=>new zu(n,e,t)),i.register(n=>new Tu(n,e));const s=i.setAnimationPointerResolver;typeof s=="function"&&s.bind(i)(new Wu)}pa(ga,"registerExtensions");var Dy=Object.defineProperty,mt=(i,t)=>Dy(i,"name",{value:t,configurable:!0});const My=w("printGltf");var _a;(function(i){i[i.BeforeLoad=0]="BeforeLoad",i[i.AfterLoaded=1]="AfterLoaded",i[i.FinishedSetup=10]="FinishedSetup"})(_a||(_a={}));class Ee{constructor(t,e,s,n){r(this,"context");r(this,"loader");r(this,"path");r(this,"gltf");this.context=t,this.path=e,this.loader=s,this.gltf=n}}mt(Ee,"GltfLoadEvent");const Ae={};function Hu(i,t){Ae[i]=Ae[i]||[],Ae[i].push(t)}mt(Hu,"addGltfLoadEventListener");function Gu(i,t){if(Ae[i]){const e=Ae[i].indexOf(t);e>=0&&Ae[i].splice(e,1)}}mt(Gu,"removeGltfLoadEventListener");function qe(i,t){if(Ae[i])for(const e of Ae[i])e(t)}mt(qe,"invokeEvents");async function ba(i,t,e,s,n){My&&console.log(e),await i.assets.registerGltf(e),await la(i,t,e,s,n)}mt(ba,"handleLoadedGltf");function ps(i,t,e,s){typeof e!="string"&&console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",e,typeof e);const n=new yr;ga(n,i,e);const a=ma(n);return new Promise((l,c)=>{try{en(n,i),qe(0,new Ee(i,e,n)),n.parse(t,e,async h=>{qe(1,new Ee(i,e,n,h)),await ba(i,e,h,s,a),qe(10,new Ee(i,e,n,h)),l(h)},h=>{console.error("failed loading "+e,h),l(void 0)})}catch(h){console.error(h),c(h)}})}mt(ps,"parseSync");function yi(i,t,e,s=!1,n){const o=new yr;ga(o,i,t);const l=ma(o);return new Promise((c,h)=>{try{en(o,i),qe(0,new Ee(i,t,o)),o.load(t,async d=>{qe(1,new Ee(i,t,o,d)),await ba(i,t,d,e,l),qe(10,new Ee(i,t,o,d)),c(d)},d=>{n==null||n.call(o,d)},d=>{console.error("failed loading "+t,d),c(void 0)})}catch(d){console.error(d),h(d)}})}mt(yi,"loadSync");function Vu(i,t,e,s=!1){t&&t.animations&&t.animations.length>0&&e.push(()=>{ya(t,s)})}mt(Vu,"findAnimationsLate");function ya(i,t=!1){var s;if(!i||!i.animations||!i.scene||!t&&!p.getComponentInChildren(i.scene,Ue))return;for(let n=0;n<i.animations.length;n++){const o=i.animations[n];if(!(!o.tracks||o.tracks.length<=0))for(const a in o.tracks){const l=o.tracks[a],c=(s=l.__objectName)!=null?s:l.name.substring(0,l.name.indexOf(".")),h=i.scene.getObjectByName(c);if(!h)continue;let d=e(h);if(!d)if(t)d=p.addNewComponent(i.scene,Ue);else{console.warn("Failed finding animator for",l.name,c);continue}const u=d.animations=d.animations||[];o.name_animator=d.name,u.indexOf(o)<0&&u.push(o)}}function e(n){var a;if(!n)return;const o=(a=n.userData)==null?void 0:a.components;if(o&&o.length>0)for(let l=0;l<o.length;l++){const c=o[l];if(c instanceof ue||c instanceof Ue)return n}return e(n.parent)}mt(e,"findAnimationGameObjectInParent")}mt(ya,"findAnimations");function va(i,t,e=!0){if(t.userData&&t.userData.name===i)return t;if(t.children&&t.children.length>0)for(let s=0;s<t.children.length;s++){const n=t.children[s],o=va(i,n,e);if(o)return o}}mt(va,"tryFindObjectByName");function qu(i,t,e=!0){return Le(i,t,e)}mt(qu,"tryFindObject");function Xu(i,t=null){const e=t!=null?t:A.Current.scripts;for(const s in e){const n=e[s];if(n&&n.guid===i)return n}return null}mt(Xu,"tryFindScript");var Iy=Object.freeze(Object.defineProperty({__proto__:null,get GltfLoadEventType(){return _a},GltfLoadEvent:Ee,addGltfLoadEventListener:Hu,removeGltfLoadEventListener:Gu,parseSync:ps,loadSync:yi,findAnimationsLate:Vu,findAnimations:ya,tryFindObjectByName:va,tryFindObject:qu,tryFindScript:Xu},Symbol.toStringTag,{value:"Module"})),jy=Object.defineProperty,Fy=(i,t)=>jy(i,"name",{value:t,configurable:!0});function er(i,t){let e=p.getComponentInChildren(i,ve);if(e||(e=p.addNewComponent(i,ve,!1),e.guid=t.generateUUID()),e&&!p.getComponent(e.gameObject,ge)){const s=p.addNewComponent(e.gameObject,ge,!1);s.guid=t.generateUUID()}if(e&&!p.getComponentInParent(e.gameObject,as)){const s=p.addNewComponent(e.gameObject,as,!1);s.guid=t.generateUUID()}}Fy(er,"onDynamicObjectAdded");var By=Object.defineProperty,Xe=(i,t)=>By(i,"name",{value:t,configurable:!0}),ir;(function(i){i.File_Spawned="file-spawned"})(ir||(ir={}));class Qu{constructor(t,e,s,n,o,a,l,c){r(this,"guid");r(this,"file_name");r(this,"file_hash");r(this,"file_size");r(this,"position");r(this,"seed");r(this,"sender");r(this,"serverUrl");r(this,"parentGuid");r(this,"boundsSize");this.seed=e,this.guid=s,this.file_name=n,this.file_hash=o,this.file_size=a,this.position=l,this.sender=t,this.serverUrl=c}}Xe(Qu,"FileSpawnModel");async function Yu(i,t,e){const s=i.name;return s.endsWith(".gltf")||s.endsWith(".glb")?new Promise((n,o)=>{const a=new FileReader;a.readAsDataURL(i),a.onloadend=async l=>{const c=a.result,h=Ls(),d=new _t(h),u=await yi(t,c,d,!0);if(u&&u.scene){const _=u.scene;if(!_.guid){const b=new _t(h);_.guid=b.generateUUID()}e&&Ku(t.connection,i,h,_,e),er(_,d),n(_)}}}):(console.warn("Unsupported file type: "+s),console.log(i),null)}Xe(Yu,"addFile");async function Ju(i,t){return new Promise(async(e,s)=>{const n=Ls(),o=new _t(n),a=await yi(t,i.toString(),o,!0);if(a&&a.scene){const l=a.scene;er(l,o),e(l)}else console.warn("Unsupported file type: "+i.toString())})}Xe(Ju,"addFileFromUrl");function Zu(i){i.connection.beginListen(ir.File_Spawned,async t=>{if(t.sender!==i.connection.connectionId){console.log("received file event",t),tf(t,i);let e=null;try{e=await oo(t.file_name,t.file_hash,t.file_size,t.serverUrl)}finally{ef(t)}if(e){const s=new _t(t.seed),n=await ps(i,e,null,s);if(n&&n.scene){const o=n.scene;if(er(o,s),t.parentGuid){const a=p.findByGuid(t.parentGuid,i.scene);"add"in a&&a.add(o)}o.parent||i.scene.add(o),t.position!==null&&o.position.copy(t.position)}}else console.error("download didnt return file")}})}Xe(Zu,"beginListenFileSpawn");async function Ku(i,t,e,s,n){var l;if(!i.connectionId){console.error("Can not upload file - no connection id");return}if(!s.guid){console.error("Can not upload file - no guid",s,s.guid);return}const o=await kc(t,n);if(!o)return;if(!o.filename){console.error("Can not send upload event - no filename",t.name);return}if(!o.hash){console.error("Can not send upload event - no hash",t.name);return}const a=new Qu(i.connectionId,e,s.guid,o.filename,o.hash,t.size,s.position,(l=o.url)!=null?l:n);s.parent&&(a.parentGuid=s.parent.guid),i.send(ir.File_Spawned,a)}Xe(Ku,"handleUpload");const wa={};function tf(i,t){const e=new Ba,s=new Je(e,new Ci({color:65280})),n=new Ha(s,5592405);if(wa[i.guid]=n,t.scene.add(n),i.parentGuid){const o=p.findByGuid(i.parentGuid,t.scene);o&&o.add(n)}i.position&&n.position.copy(i.position)}Xe(tf,"addPreview");function ef(i,t){const e=i.guid,s=wa[e];s&&(delete wa[e],s.removeFromParent())}Xe(ef,"removePreview");var Uy=Object.defineProperty,sr=(i,t)=>Uy(i,"name",{value:t,configurable:!0});w("debugassets");class Ny{constructor(){r(this,"name");r(this,"sampler");r(this,"source");r(this,"extras")}}sr(Ny,"TextureInfo");class zy{constructor(){r(this,"bufferView");r(this,"mimeType");r(this,"extras")}}sr(zy,"ImageInfo");class $y{constructor(){r(this,"textures");r(this,"bufferViews")}}sr($y,"GltfJson");class sf{constructor(){r(this,"texturesLoader",new vp);r(this,"textures",{});r(this,"texturesLoading",{});r(this,"_materials",new Map);r(this,"_meshes",new Map);r(this,"_textures",new Map);window.addEventListener("unhandledrejection",t=>{var s;if(t.defaultPrevented)return;const e=(s=t==null?void 0:t.reason)==null?void 0:s.path;if(e){const n=e[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),t.preventDefault())}})}async loadTexture(t){if(this.textures[t])return this.textures[t];if(this.texturesLoading[t])return await this.texturesLoading[t];const e=this.texturesLoader.loadAsync(t);this.texturesLoading[t]=e;const s=await e;return delete this.texturesLoading[t],this.textures[t]=s,s}getTexture(t){return this._textures.get(t)||null}findTexture(t){for(const e of this._textures.values())if(e.name===t)return e;return null}findMesh(t){for(const e of this._meshes.values())if(e.name===t)return e;return null}findMaterial(t){for(const e of this._materials.values())if(e.name===t)return e;return null}async registerGltf(t){}registerAsset(t){}}sr(sf,"AssetDatabase");var Wy=Object.defineProperty,Hy=(i,t)=>Wy(i,"name",{value:t,configurable:!0}),nr;(function(i){i.Visible="application-visible",i.Hidden="application-hidden"})(nr||(nr={}));class nf extends EventTarget{constructor(t){super();r(this,"context");r(this,"_isVisible",!0);this.context=t,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(t){switch(t.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event(nr.Hidden));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event(nr.Visible));break}}}Hy(nf,"Application");var Gy=Object.defineProperty,Vy=(i,t)=>Gy(i,"name",{value:t,configurable:!0});const rf=!!w("debuglightmaps");class of{constructor(t){r(this,"_context");r(this,"_lightmaps",new Map);this._context=t}registerTexture(t,e,s,n){var l;rf&&console.log("Registering lightmap",t,re[e],s),this._lightmaps.has(t)||this._lightmaps.set(t,new Map);const o=this._lightmaps.get(t),a=(l=o==null?void 0:o.get(e))!=null?l:[];a.length<n&&(a.length=n+1),a[n]=s,o==null||o.set(e,a)}tryGetLightmap(t,e=0){return this.tryGet(t,re.Lightmap,e)}tryGetSkybox(t){return this.tryGet(t,re.Skybox,0)}tryGetReflection(t){return this.tryGet(t,re.Reflection,0)}tryGet(t,e,s){var o,a;if(!t)return rf&&console.warn("Missing source id"),null;const n=(a=(o=this._lightmaps.get(t))==null?void 0:o.get(e))!=null?a:null;return!(n==null?void 0:n.length)||n.length<=s?null:n[s]}}Vy(of,"LightDataRegistry");Ri.lights_fragment_maps=Ri.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vUv2 );",`

    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);Ri.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;Ri.lights_fragment_begin=Ri.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);wp.lightmap.lightmapScaleOffset={value:new I(1,1,0,0)};var qy=Object.defineProperty,xa=(i,t)=>qy(i,"name",{value:t,configurable:!0});const Xy=w("debugSetup"),Qy=w("stats"),rr={};class af{constructor(t){r(this,"name");r(this,"alias");r(this,"domElement");r(this,"renderer");this.domElement=t!=null?t:document.body}}xa(af,"ContextArgs");var xt;(function(i){i[i.EarlyUpdate=0]="EarlyUpdate",i[i.Update=1]="Update",i[i.LateUpdate=2]="LateUpdate",i[i.OnBeforeRender=3]="OnBeforeRender",i[i.OnAfterRender=4]="OnAfterRender",i[i.PhysicsStep=10]="PhysicsStep"})(xt||(xt={}));const gt=class{constructor(t){r(this,"name");r(this,"alias");r(this,"isManagedExternally",!1);r(this,"domElement");r(this,"scene");r(this,"renderer");r(this,"composer",null);r(this,"scripts",[]);r(this,"scripts_earlyUpdate",[]);r(this,"scripts_update",[]);r(this,"scripts_lateUpdate",[]);r(this,"scripts_onBeforeRender",[]);r(this,"scripts_onAfterRender",[]);r(this,"scripts_WithCorroutines",[]);r(this,"coroutines",{});r(this,"mainCameraComponent");r(this,"post_setup_callbacks",[]);r(this,"pre_update_callbacks",[]);r(this,"pre_render_callbacks",[]);r(this,"post_render_callbacks",[]);r(this,"new_scripts",[]);r(this,"new_script_start",[]);r(this,"new_scripts_pre_setup_callbacks",[]);r(this,"new_scripts_post_setup_callbacks",[]);r(this,"application");r(this,"time");r(this,"input");r(this,"physics");r(this,"connection");r(this,"assets");r(this,"mainLight",null);r(this,"rendererData");r(this,"addressables");r(this,"lightmaps");r(this,"_sizeChanged",!1);r(this,"_isCreated",!1);r(this,"_stats",Qy?xp():null);r(this,"_cameraStack",[]);if(this.name=(t==null?void 0:t.name)||"",this.alias=t==null?void 0:t.alias,this.domElement=(t==null?void 0:t.domElement)||document.body,t==null?void 0:t.renderer)this.renderer=t.renderer,this.isManagedExternally=!0;else{const s=w("postfx");this.renderer=new Pp({antialias:!0}),this.renderer.setClearColor(new f("lightgrey"),0),this.renderer.antialias=!0,this.renderer.alpha=!1,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Op,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputEncoding=Ye,this.renderer.physicallyCorrectLights=!0,this.composer=s?new Cp(this.renderer):null}this.scene=new Sp,this.application=new nf(this),this.time=new Xl,this.input=new Ml(this),this.physics=new ql(this),this.connection=new tc(this),this.assets=new sf,this.rendererData=new Fu(this),this.addressables=new Zc(this),this.lightmaps=new of(this),window.addEventListener("resize",this.updateSize.bind(this)),new ResizeObserver(s=>this._sizeChanged=!0).observe(this.domElement)}static get Current(){return this._current}static set Current(t){this._current=t}get domWidth(){return this.domElement.clientWidth}get domHeight(){return this.domElement.clientHeight}get domX(){return this.domElement.offsetLeft}get domY(){return this.domElement.offsetTop}get isInXR(){return this.renderer.xr.isPresenting}get mainCamera(){if(this.mainCameraComponent){const t=this.mainCameraComponent;return t.cam||t.buildCamera(),t.cam}return null}updateSize(){if(!this.isManagedExternally&&!this.renderer.xr.isPresenting){this._sizeChanged=!1;const t=this.domWidth,e=this.domHeight,s=this.mainCamera;this.updateAspect(s),this.renderer.setSize(t,e),this.renderer.setPixelRatio(window.devicePixelRatio),this.composer&&(this.composer.setSize(t,e),this.composer.setPixelRatio(window.devicePixelRatio))}}updateAspect(t){if(!t)return;const e=this.domWidth,s=this.domHeight,n=t.aspect;t.aspect=e/s,n!==t.aspect&&t.updateProjectionMatrix()}onCreate(t,e){return this._isCreated?(console.warn("Context already created"),null):(this._isCreated=!0,this.internalOnCreate(t,e))}onDestroy(){var t,e;!this._isCreated||(this._isCreated=!1,p.destroy(this.scene,!0),(t=this.renderer)==null||t.setAnimationLoop(null),this.isManagedExternally||(e=this.renderer)==null||e.dispose())}registerCoroutineUpdate(t,e,s){return this.coroutines[s]||(this.coroutines[s]=[]),this.coroutines[s].push({comp:t,main:e}),e}unregisterCoroutineUpdate(t,e){if(!this.coroutines[e])return;const s=this.coroutines[e].findIndex(n=>n.main===t);s>=0&&this.coroutines[e].splice(s,1)}stopAllCoroutinesFrom(t){for(const e in this.coroutines){const s=this.coroutines[e];for(let n=s.length-1;n>=0;n--)s[n].comp===t&&s.splice(n,1)}}setCurrentCamera(t){var n;if(!t)return;if(t.cam||t.buildCamera(),!t.cam){console.warn("Camera component is missing camera",t);return}const e=this._cameraStack.indexOf(t);e>=0&&this._cameraStack.splice(e,1),this._cameraStack.push(t),this.mainCameraComponent=t;const s=t.cam;s.isPerspectiveCamera&&this.updateAspect(s),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}async internalOnCreate(t,e){var o;let s=!0;try{gt.Current=this,t&&await t(this,e)}catch(a){console.error(a),s=!1}if(!s)return;this.isManagedExternally||this.domElement.prepend(this.renderer.domElement),El(this),Sl(this),Zu(this),gt._current=this;for(let a=0;a<this.new_scripts.length;a++){const l=this.new_scripts[a];if(l.gameObject!==void 0&&l.gameObject!==null){l.gameObject.userData===void 0&&(l.gameObject.userData={}),l.gameObject.userData.components===void 0&&(l.gameObject.userData.components=[]);const c=l.gameObject.userData.components;c.includes(l)||c.push(l)}}if(this.post_setup_callbacks)for(let a=0;a<this.post_setup_callbacks.length;a++)gt._current=this,await this.post_setup_callbacks[a](this);if(!this.mainCamera){gt._current=this;const a=p.findObjectsOfType(U,this),l=(o=a.find(c=>c.tag=="MainCamera"))!=null?o:a.find(c=>!0);if(l)l.tag!=="MainCamera"&&console.warn('No mainCamera configured. Some components rely on a mainCamera object being present. When exporting your scene, make sure to set the mainCamera tag on your camera. Using "'+l.name+'" as mainCamera now.'),this.setCurrentCamera(l);else{console.error("No camera found");const c=ac(this.scene);this.setCurrentCamera(c)}}gt._current=this,Ke(this),Qr!==void 0&&Te(Qr,this);const n=this.mainCameraComponent;if(n&&n.applyClearFlagsIfIsActiveCamera(),!this.isManagedExternally&&this.composer&&this.mainCamera){const a=new Rp(this.scene,this.mainCamera);this.renderer.setSize(this.domWidth,this.domHeight),this.composer.addPass(a),this.composer.setSize(this.domWidth,this.domHeight)}this._sizeChanged=!0,this._stats&&(this._stats.showPanel(1),this.domElement.appendChild(this._stats.dom)),this.renderer.setAnimationLoop(this.render.bind(this)),Xy&&As(this.scene,!0)}render(t,e){var s,n;for((s=this._stats)==null||s.begin(),gt._current=this,this.time.update(),Ke(this),cl(),al(this);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();for(let o=0;o<this.scripts_earlyUpdate.length;o++){const a=this.scripts_earlyUpdate[o];!a.activeAndEnabled||a.earlyUpdate!==void 0&&(gt._current=this,a.earlyUpdate())}this.executeCoroutines(0);for(let o=0;o<this.scripts_update.length;o++){const a=this.scripts_update[o];!a.activeAndEnabled||a.update!==void 0&&(gt._current=this,a.update())}this.executeCoroutines(1);for(let o=0;o<this.scripts_lateUpdate.length;o++){const a=this.scripts_lateUpdate[o];!a.activeAndEnabled||a.lateUpdate!==void 0&&(gt._current=this,a.lateUpdate())}this.mainLight=null,this.executeCoroutines(2);try{const o=2,a=this.time.deltaTime/o;for(let l=0;l<o;l++)this.physics.step(a),this.executeCoroutines(10)}catch(o){console.error(o)}this.physics.postStep();for(let o=0;o<this.scripts_onBeforeRender.length;o++){const a=this.scripts_onBeforeRender[o];!a.activeAndEnabled||a.onBeforeRender!==void 0&&(gt._current=this,a.onBeforeRender(e))}if(this.executeCoroutines(3),this._sizeChanged&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o]();this.isManagedExternally||(this.composer?this.composer.render():this.mainCamera&&this.renderer&&this.renderer.render(this.scene,this.mainCamera));for(let o=0;o<this.scripts_onAfterRender.length;o++){const a=this.scripts_onAfterRender[o];!a.activeAndEnabled||a.onAfterRender!==void 0&&(gt._current=this,a.onAfterRender())}if(this.executeCoroutines(4),this.post_render_callbacks)for(const o in this.post_render_callbacks)this.post_render_callbacks[o]();this.connection.sendBufferedMessagesNow(),(n=this._stats)==null||n.end()}executeCoroutines(t){if(this.coroutines[t]){const s=this.coroutines[t];for(let n=0;n<s.length;n++){const o=s[n];if(!o.comp||o.comp.destroyed||!o.main){s.splice(n,1),--n;continue}const a=o.chained;if(a&&a.length>0){const d=a[a.length-1].next();if(d.done&&a.pop(),e(d)&&(o.chained||(o.chained=[]),o.chained.push(d.value)),!d.done)continue}const l=o.main.next();if(l.done===!0){s.splice(n,1),--n;continue}const c=l.value;if(e(c)){if(c.next().done)continue;o.chained||(o.chained=[]),o.chained.push(c)}}}function e(s){return!!(s&&s.next&&s.return)}xa(e,"isGenerator")}};let A=gt;r(A,"_current");xa(A,"Context");var Yy=Object.freeze(Object.defineProperty({__proto__:null,build_scene_functions:rr,ContextArgs:af,get FrameEvent(){return xt},Context:A},Symbol.toStringTag,{value:"Module"}));const lf=fr(le(le({},Yy),Iy),{RGBAColor:Jt}),Jy=async function(i,t){const e=i.scene;i.new_scripts;const s=await lf.loadSync(i,"assets/sceneRoot.glb",null,!1,n=>{var o;return(o=t==null?void 0:t.progress)==null?void 0:o.call(t,{name:"sceneRoot.glb",progress:n,index:0,count:1})});s&&e.add(s.scene),i.scripts};lf.build_scene_functions.loadScene=Jy;console.log("Made with \u2665 by \u{1F335} needle - https://needle.tools");var Zy=Object.defineProperty,Ky=(i,t)=>Zy(i,"name",{value:t,configurable:!0});const or="ar",tv="quit-ar";class cf{constructor(){r(this,"arContainer",null);r(this,"closeARCallback");r(this,"currentSession",null);r(this,"registeredCloseEventElements",[]);r(this,"_createdAROnlyElements",[]);this.closeARCallback=this.onRequestedEndAR.bind(this)}requestEndAR(){this.onRequestedEndAR()}onBegin(t,e){if(this.currentSession=e,this.arContainer=t,!this.arContainer)return;const s=t.getElementsByClassName(tv);if(!s||s.length<=0)console.warn("Missing quit AR elements"),this.createFallbackCloseARButton(this.arContainer);else for(let n=0;n<s.length;n++){const o=s[n];!o||(o.addEventListener("click",this.closeARCallback),this.registeredCloseEventElements.push(o))}}onEnd(){for(const t of this._createdAROnlyElements)t.remove&&t.remove()}findArContainer(t){if(t.classList.contains(or))return t;if(t.children){for(const e of t.children)if(!(!e||!e.classList)&&e.classList.contains(or))return e}return null}onRequestedEndAR(){if(!!this.currentSession){this.currentSession.end(),this.currentSession=null;for(const t of this.registeredCloseEventElements)t.removeEventListener("click",this.closeARCallback);this.registeredCloseEventElements.length=0}}createFallbackCloseARButton(t){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width","38px"),e.setAttribute("height","38px"),e.style.position="absolute",e.style.right="20px",e.style.top="40px",e.style.zIndex="9999",e.style.pointerEvents="auto",e.addEventListener("click",this.closeARCallback),t.appendChild(e),this._createdAROnlyElements.push(e);var s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),s.setAttribute("stroke","#eee"),s.setAttribute("stroke-width","2px"),e.appendChild(s),this._createdAROnlyElements.push(s)}}Ky(cf,"AROverlayHandler");var ev=Object.defineProperty,Pa=(i,t)=>ev(i,"name",{value:t,configurable:!0});const iv=w("debugloadingbar");class sv{constructor(){r(this,"className");r(this,"additionalClasses")}}Pa(sv,"LoadingElementOptions");class hf{constructor(t,e){r(this,"loadingProgress",0);r(this,"container");r(this,"_progress",0);r(this,"_allowCustomLoadingElement",!1);r(this,"_loadingElement");r(this,"_loadingTextContainer",null);r(this,"_loadingBar",null);r(this,"_messageContainer",null);r(this,"_loadingElementOptions");r(this,"_progressLoop");this.container=t,this._loadingElementOptions=e}onLoadingBegin(t){if(!this._loadingElement){for(let e=0;e<this.container.children.length;e++){const s=this.container.children[e];if(s.classList.contains("loading")){if(!this._allowCustomLoadingElement){this.container.removeChild(s);continue}this._loadingElement=this.createLoadingElement();return}}this._loadingElement=this.createLoadingElement()}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="",this.container.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(t!=null?t:"")}onLoadingUpdate(t,e){var n;((n=this._loadingElement)==null?void 0:n.parentElement)||this.onLoadingBegin(e);let s=0;typeof t=="number"?s=t:("index"in t&&(s=t.index/t.count+t.progress.loaded/t.progress.total/t.count),!e&&"name"in t&&this.setMessage(t.name)),this.loadingProgress=s,e&&this.setMessage(e),this.updateDisplay()}onLoadingFinished(t){this.loadingProgress=1,this.setMessage(t!=null?t:"")}setMessage(t){this._messageContainer&&(this._messageContainer.innerText=t)}smoothProgressLoop(){if(this._progressLoop)return;let t=1/12;iv&&(t=.001);const e=1-.05;this._progressLoop=setInterval(()=>{if(this.loadingProgress>=1&&this._progress>=e){this._loadingElement&&(this._loadingElement.style.display="none",this._loadingElement.remove()),clearInterval(this._progressLoop),this._progressLoop=null;return}this._progress=k.lerp(this._progress,this.loadingProgress,t*this.loadingProgress),this.updateDisplay()},t)}updateDisplay(){const t=this._progress,e=(t*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=t*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=e)}createLoadingElement(t){var l,c,h;this._loadingElement=t||document.createElement("div");const e=(c=(l=this._loadingElementOptions)==null?void 0:l.className)!=null?c:"loading";if(this._loadingElement.classList.add(e),(h=this._loadingElementOptions)==null?void 0:h.additionalClasses)for(const d of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(d);t||(this._loadingElement.style.color="white",this._loadingElement.style.display="flex");const s=document.createElement("div"),n=20;s.style.display="flex",s.style.width=n+"%",s.style.height="2px",s.style.background="rgba(255,255,255,.1)",this._loadingElement.appendChild(s),this._loadingBar=document.createElement("div"),s.appendChild(this._loadingBar);const o=Pa(function(d){return k.lerp(n*.5,100-n*.5,d)+"%"},"getGradientPos");this._loadingBar.style.background=`linear-gradient(90deg, #02022B ${o(0)}, #0BA398 ${o(.4)}, #99CC33 ${o(.5)}, #D7DB0A ${o(1)})`,this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",this._loadingTextContainer=document.createElement("div"),this._loadingTextContainer.style.display="flex",this._loadingTextContainer.style.justifyContent="center",this._loadingTextContainer.style.marginTop=".9em",this._loadingElement.appendChild(this._loadingTextContainer);const a=document.createElement("div");return this._messageContainer=a,a.style.display="flex",a.style.fontSize=".8em",a.style.paddingTop=".5em",a.style.color="rgba(255,255,255,.5)",this._loadingElement.appendChild(a),this._loadingElement}}Pa(hf,"EngineLoadingView");var nv=Object.defineProperty,ms=(i,t)=>nv(i,"name",{value:t,configurable:!0});class df{constructor(t,e){r(this,"id");r(this,"context");r(this,"previouslyAdded");r(this,"previousSource");r(this,"networkEvent");this.id=t,this.context=e,this.networkEvent="needle-engine-source-changed",this.id&&(this.networkEvent+="-"+this.id),this.context.connection.beginListen(this.networkEvent,s=>{this.onSourceChanged(s,!0)})}async onSourceChanged(t,e=!1,s=!1){this.previouslyAdded&&(e&&t===this.previousSource||p.destroySynced(this.previouslyAdded)),this.previouslyAdded=null,e||this.context.connection.send(this.networkEvent,t),this.previousSource=t,A.Current=this.context;const n=await yi(this.context,t,this.getHashFromString(t));s||Ke(this.context);const o=n==null?void 0:n.scene;o&&(this.previouslyAdded=o,this.context.scene.add(o))}getHashFromString(t){let e=0;for(let s=0;s<t.length;s++)e=t.charCodeAt(s)+((e<<5)-e);return e}}ms(df,"EngineElementSourceFileWatcher");const rv="needle-engine",ov="vr",av="desktop",lv=[or,ov,av];class uf extends HTMLElement{constructor(){super();r(this,"gameObject",p);r(this,"GameObject",p);r(this,"context",null);r(this,"overlay_ar");r(this,"_watcher");r(this,"_loadingView");this.overlay_ar=new cf}get loadingProgress01(){var t,e;return(e=(t=this._loadingView)==null?void 0:t.loadingProgress)!=null?e:0}get loadingFinished(){return this.loadingProgress01>.999}getContext(){return new Promise((t,e)=>{if(this.context&&this.loadingFinished)t(this.context);else{const s=ms(()=>{this.removeEventListener("loading-finished",s),this.context&&this.loadingFinished&&t(this.context)},"cb");this.addEventListener("loading-finished",s)}})}async connectedCallback(){var a,l,c;this.onSetupDesktop();var t=new MutationObserver(this.onElementsChanged.bind(this));t.observe(this,{childList:!0});const e=ms(()=>{const h=this.getAttribute("src");return(h==null?void 0:h.endsWith(".glb"))||(h==null?void 0:h.endsWith(".gltf"))?h:null},"srcFile");let s="loadScene";const n=e();n&&(s=n);const o=this.getAttribute("alias");if(this.context=new A({name:s,domElement:this,alias:o}),this._watcher=new df((l=(a=this.getAttribute("id"))!=null?a:o)!=null?l:"",this.context),this._loadingView=new hf(this),s&&s.length>0){if(!n)for(;Object.keys(rr).length<=0;){if(!this.isConnected)return;await nl(10)}let h=(c=rr[s])!=null?c:window[s],d=null;if((!h||n)&&(n&&(s=n),h=ms(async u=>{const _=e();_&&this._watcher&&(d=_,await this._watcher.onSourceChanged(_,!0,!0))},"fn")),h){this.classList.add("loading"),console.log("Begin loading scene",s!=null?s:o),this._loadingView.onLoadingBegin("begin load"),await this.context.onCreate(h,{progress:this._loadingView.onLoadingUpdate.bind(this._loadingView)});const u=e();u&&u!==d&&await this._watcher.onSourceChanged(u,!0,!0),this._loadingView.onLoadingFinished("create scene"),this.classList.remove("loading"),this.classList.add("loading-finished"),console.log("Finished loading scene",o!=null?o:s),this.dispatchEvent(new Event("loading-finished")),this.onSetupDesktop()}else console.error('Could not find scene function named "'+s+'", it must be either in global scope or added to build_scene_functions',rr)}else console.error("Missing src attribute - please provide a function name",this)}disconnectedCallback(){this.context&&this.context.onDestroy()}static get observedAttributes(){return["src"]}attributeChangedCallback(t,e,s){var n;(n=this._watcher)==null||n.onSourceChanged(s)}getAROverlayContainer(){var e;return(e=this.overlay_ar)==null?void 0:e.findArContainer(this)}getVROverlayContainer(){for(let t=0;t<this.children.length;t++){const e=this.children[t];if(e.classList.contains("vr"))return e}return null}onEnterAR(t,e){this.onSetupAR(),this.overlay_ar.onBegin(e,t)}onExitAR(t){this.overlay_ar.onEnd(),this.onSetupDesktop()}onEnterVR(t){this.onSetupVR()}onExitVR(){this.onSetupDesktop()}onElementsChanged(){}onSetupAR(){this.classList.add("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(t=>this.setupElementsForMode(t,or))}onSetupVR(){this.classList.remove("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(t=>this.setupElementsForMode(t,"vr"))}onSetupDesktop(){this.classList.remove("ar-session-active"),this.classList.add("desktop-session-active"),this.foreachHtmlElement(t=>this.setupElementsForMode(t,"desktop"))}setupElementsForMode(t,e,s=null){var o;if(t===((o=this.context)==null?void 0:o.renderer.domElement)||t.id==="VRButton"||t.id==="ARButton")return;if(t.style.position="absolute",t.classList.contains(e))t.style.visibility="visible",t.style.display="block";else for(const a of lv)t.classList.contains(a)&&(t.style.visibility="hidden",t.style.display="none")}foreachHtmlElement(t){for(let e=0;e<this.children.length;e++){const s=this.children[e];s.style&&t(s)}}}ms(uf,"EngineElement");window.customElements.define(rv,uf);
